@using banhang24.Hellper
<style>
    .lbl-note-i {
        font-size: 12px !important;
    }

    #vmHoaHongKhachGioiThieu thead tr th {
        text-align: center
    }
</style>
<div class="modal fade" id="vmHoaHongKhachGioiThieu">
    <div class="modal-dialog draggable modal-lg">
        <div class="modal-content  ">
            <div class="modal-header ">
                <h4 class="modal-title">
                    {{typeUpdate==1?'Thêm mới ':'Cập nhật '}} phiếu trích hoa hồng
                </h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><i class="material-icons">close</i></button>
            </div>
            <div class="modal-body modal-body-scroll">
                <div class="flex flex-row" style="padding-bottom: 10px">
                    <div class="col-sm-12 col-md-12 col-lg-12 col-xs-12 ">
                        <div class="col-sm-12 col-md-12 col-lg-12 col-xs-12 nopadding-left">
                            <label>
                                Người giới thiệu là
                            </label>
                        </div>

                        <div class="col-lg-4 col-lg-offset-2 col-xs-10 col-xs-offset-3 col-sm-4 col-sm-offset-2 col-md-4 col-md-offset-2 flex flex-between">
                            <label>
                                <input type="radio" class="form-check-input" name="rdoLoaiDoiTuong"
                                       value="1" v-model="newHoaDon.TongChietKhau"
                                       v-on:change="ChangeLoaiDoiTuong" />Khách hàng
                            </label>
                            <label>
                                <input type="radio" class="form-check-input" name="rdoLoaiDoiTuong"
                                       value="2" v-model="newHoaDon.TongChietKhau"
                                       v-on:change="ChangeLoaiDoiTuong" />Nhà cung cấp
                            </label>
                        </div>
                        <div class="col-lg-4 col-lg-offset-2 col-xs-10 col-xs-offset-3 col-sm-4 col-sm-offset-2 col-md-4 col-md-offset-2 flex flex-between">
                            <label>
                                <input type="radio" class="form-check-input" name="rdoLoaiDoiTuong"
                                       v-on:change="ChangeLoaiDoiTuong"
                                       value="4" v-model="newHoaDon.TongChietKhau" />Nhân viên
                            </label>
                            <label>
                                <input type="radio" class="form-check-input" name="rdoLoaiDoiTuong"
                                       v-on:change="ChangeLoaiDoiTuong"
                                       value="0" v-model="newHoaDon.TongChietKhau" />Khác
                            </label>
                        </div>
                    </div>
                </div>
                <div class="flex flex-wrap">
                    <div class="col-lg-6 col-xs-12 ">
                        <div class="form-group nopadding">
                            <label>
                                Mã phiếu
                            </label>
                            <div class="form-news">
                                <input type="text" class="form-control" readonly
                                       placeholder="Mã tự động" v-model="newHoaDon.MaHoaDon" />
                            </div>
                        </div>
                        <div class="form-group gara-addcar-brand nopadding">
                            <label>Người giới thiệu</label>
                            <div class="form-news">
                                <div v-show="['1','2','3'].includes(newHoaDon.TongChietKhau)">
                                    <customers :text-search="txtNguoiGioiThieu"
                                               :loai-doi-tuong="newHoaDon.TongChietKhau"
                                               :showbutton="false"
                                               :disable-search="false"
                                               :id-chi-nhanh="inforLogin.ID_DonVi"
                                               v-on:reset-customer-parent="ResetNguoiGioiThieu"
                                               v-on:change-customer-parent="ChangeNguoiGioiThieu">
                                    </customers>
                                </div>

                                <div v-if="newHoaDon.TongChietKhau == '4'">
                                    <nhanviens :text-search="txtNguoiGioiThieu"
                                               :staffs="listData.NhanViens"
                                               :search-list="listData.NhanViens"
                                               v-on:reset-item-chose="ResetNguoiGioiThieu"
                                               v-on:change-staff-parent="ChangeNguoiGioiThieu">
                                    </nhanviens>
                                </div>
                                <div v-if="newHoaDon.TongChietKhau == '0'">
                                    <contacts :text-search="txtLienHe"
                                              :list-all="listData.LienHes"
                                              :list-search="listData.LienHes"
                                              :show-btn-add="true"
                                              v-on:show-modal="showModalContact"
                                              v-on:reset-item-chose="ResetNguoiGioiThieu"
                                              v-on:chose-item="ChangeNguoiGioiThieu">
                                    </contacts>
                                </div>
                            </div>
                        </div>
                        <div class="form-group nopadding">
                            <label></label>
                            <div class="form-news">
                                <input type="text" class="form-control" style="text-align:left"
                                       v-if="newHoaDon.SDTNguoiGioiThieu"
                                       v-bind:value="newHoaDon.TenNguoiGioiThieu.concat(' (', newHoaDon.SDTNguoiGioiThieu, ')')" />
                                <input type="text" class="form-control" style="text-align:left"
                                       v-else
                                       v-bind:value="newHoaDon.TenNguoiGioiThieu" />
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 col-xs-12 ">
                        <div class="form-group nopadding">
                            <label>Ngày lập</label>
                            <div class="form-news">
                                <my-date-time :date-chose="newHoaDon.NgayLapHoaDon"
                                              :role-change-date="true"
                                              v-on:change-date="ChangeNgayLapHoaDon">
                                </my-date-time>
                            </div>
                        </div>
                        <div class="form-group nopadding">
                            <label>Ghi chú</label>
                            <div class="form-news">
                                <textarea rows="2" type="text"
                                          v-model="newHoaDon.DienGiai">
                                </textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex flex-wrap gara-detail-sections" style="border-bottom:1px solid">
                    <div class="col-sm-12 col-md-12 col-lg-12 col-xs-12">
                        <div class="col-lg-6 col-xs-12  col-sm-6 col-md-6 nopadding-left">
                            <label>Nội dung chi tiết</label>
                        </div>
                        <div class="col-lg-6 col-xs-12 col-sm-6 col-md-6 nopadding-right">
                            <div class="col-lg-4 col-xs-6 col-sm-6 col-md-6 nopadding-left">
                                <label>
                                    Tổng thanh toán
                                </label>
                                <p style="font-size:10px"><i>({{newHoaDon.LoaiTien}})</i></p>
                            </div>
                            <div class="col-lg-4 col-xs-6 col-sm-6 col-md-6 nopadding-right floatRight ">
                                <label style="float:right!important">
                                    {{formatNumber3Digit(newHoaDon.DaThanhToan)}}
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="container-fluid row" style="margin-bottom:5px; margin-top:10px"
                     v-if="ThongTinChiTiet.length == 0">
                    <div class="flex flex-wrap">
                        <div class="col-lg-6 col-xs-12 ">
                            <div class="form-group gara-addcar-brand nopadding">
                                <label>Khách hàng</label>
                                <div class="form-news">
                                    <customers :text-search="txtKhachHang"
                                               :loai-doi-tuong="1"
                                               :showbutton="false"
                                               :disable-search="false"
                                               :id-chi-nhanh="inforLogin.ID_DonVi"
                                               v-on:change-customer-parent="ChoseCustomer">
                                    </customers>
                                </div>
                            </div>
                            <div class="form-group nopadding">
                                <label></label>
                                <div class="form-news">
                                    <input type="text" class="form-control" style="text-align:left" readonly />
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 col-xs-12 ">
                            <div class="form-group gara-addcar-brand nopadding">
                                <label>Hóa đơn bổ sung</label>
                                <div class="form-news">
                                    <div class="gara-bill-infor-button shortlabel">
                                        <input class="gara-search-HH " placeholder="Tìm kiếm" style="padding-right: 27px!important"
                                               onclick="this.select()" />
                                        
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="container-fluid row" style="margin-bottom:5px; margin-top:10px"
                     v-if="ThongTinChiTiet.length > 0"
                     v-for="(item, index) in ThongTinChiTiet">
                    <div class="flex flex-wrap">
                        <div class="col-lg-6 col-xs-12 ">
                            <div class="form-group gara-addcar-brand nopadding">
                                <label>Khách hàng</label>
                                <div class="form-news"
                                     v-on:change="ChangeCustomer(item,index)">
                                    <customers :text-search="txtKhachHang"
                                               :loai-doi-tuong="1"
                                               :showbutton="false"
                                               :disable-search="false"
                                               :id-chi-nhanh="inforLogin.ID_DonVi"
                                               v-on:change-customer-parent="ChoseCustomer">
                                    </customers>
                                </div>
                            </div>
                            <div class="form-group nopadding">
                                <label></label>
                                <div class="form-news">
                                    <input type="text" class="form-control" style="text-align:left" readonly
                                           v-if="item.DienThoai"
                                           v-bind:value="item.TenDoiTuong.concat(' (', item.DienThoai, ')')" />
                                    <input type="text" class="form-control" style="text-align:left" readonly
                                           v-else="item.DienThoai"
                                           v-bind:value="item.TenDoiTuong" />
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 col-xs-12 ">
                            <div class="form-group gara-addcar-brand nopadding">
                                <label>Hóa đơn bổ sung</label>
                                <div class="form-news">
                                    <div class="gara-bill-infor-button shortlabel">
                                        <input class="gara-search-HH " placeholder="Tìm kiếm" style="padding-right: 27px!important"
                                               v-on:click="showlistHDBoSung" />
                                        <div class="gara-search-dropbox drop-search ">
                                            <ul>
                                                <li v-for="(item, index) in HoaDon_ofCus.ListBoSung"
                                                    v-on:click="Add_HoaDonBoSung(item)">
                                                    <a href="javascript:void(0)" class="gara-component-item-nv">
                                                        <div class="flex flex-between">
                                                            <span>{{item.MaHoaDon}}</span>
                                                            <span v-if="hdBoSung_Chosing.ID == item.ID_HoaDon_DuocCK" class="span-check">
                                                                <i class="fa fa-check">  </i>
                                                            </span>
                                                        </div>
                                                        <span class="seach-hh" style="color:black">
                                                            {{formatNumber3Digit(item.TongThanhToan)}}
                                                        </span>
                                                    </a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="table-res table-frame" style="margin-top:10px">
                        <table class='table'>
                            <thead>
                                <tr>
                                    <th> Mã hóa đơn </th>
                                    <th class="text-center"> Ngày lập</th>
                                    <th class="text-right"> Giá trị</th>
                                    <th class="text-right"> Đã trích</th>
                                    <th class="text-right"> Còn lại</th>
                                    <th class="text-right"> % chiết khấu</th>
                                    <th style="text-align:center; width: 10%">
                                        Tiền chiết khấu
                                    </th>
                                    <th title="Xóa tất cả dòng" class="red" v-on:click="RemoveAllRow(item)">
                                        <i class="fal fa-times"></i>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(ct, index2) in item.HoaDons"
                                    v-bind:style="{background : ct.TrangThai == 1 ? 'yellow' : 'none'}"
                                   >
                                    <td>{{ct.MaHoaDon}}</td>
                                    <td>{{moment(ct.NgayLapHoaDon).format('DD/MM/YYYY HH:mm')}}</td>
                                    <td class="text-right">{{formatNumber3Digit(ct.TongThanhToan)}}</td>
                                    <td class="text-right">
                                        {{formatNumber3Digit(ct.DaTrich)}}
                                    </td>
                                    <td class="text-right">{{formatNumber3Digit(ct.ConLai)}}</td>
                                    <td style="width: 5%">
                                        <input type="text" style="width:100px" class="text-right"
                                               onkeypress="keypressNumber_limitNumber(event, this)"
                                               v-on:keyup.13="Enter_FocusNext(5)"
                                               v-model="ct.PTChietKhau"
                                               v-on:keyup="editPTChietKhau(item,ct)" />
                                    </td>
                                    <td>
                                        <input type="text" style="width:120px" class="text-right"
                                               onkeypress="keypressNumber_limitNumber(event, this)"
                                               v-on:keyup.13="Enter_FocusNext(6)"
                                               v-model="ct.TienChietKhau"
                                               v-on:keyup="editTienChietKhau(item,ct)" />
                                    </td>
                                    <td class="text-center">
                                        <a title="Xóa dòng" class="red" v-on:click="RemoveOneRow(item,ct)">
                                            <i class="fal fa-times"></i>
                                        </a>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                </div>
                <div class="flex flex-row" v-if="ThongTinChiTiet.length > 0">
                    <div class="col-sm-12 col-md-12 col-lg-12 col-xs-12 ">
                        <div class="form-group">
                            <button class="btn btn-main" v-on:click="AddNewData_Cus">
                                <i class="fa fa-plus"></i> Thêm khách hàng
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">

                <button type="button" class="btn btn-cancel " data-dismiss="modal">
                    <i class="fa fa-ban"></i>Đóng
                </button>
                <button type="button" class="btn btn-cancel "
                        v-if="typeUpdate == 2 && newHoaDon.TrangThai && !$root.isKhoaSo">
                    <i class="fa fa-trash"></i> Xóa
                </button>
                <button type="button" class="btn btn-save "
                        v-if="!isLoading && typeUpdate === 2 && !$root.isKhoaSo">
                    <i class="fa fa-save"></i>
                    Cập nhật
                </button>
                <button type="button" class="btn btn-save "
                        v-if="!isLoading && typeUpdate === 1"
                        v-on:click="saveHoaDon">
                    <i class="fa fa-save"></i>
                    Lưu
                </button>
                <button type="button" class="btn btn-save " v-if="isLoading">
                    <i class="fa fa-save"></i>
                    Đang lưu
                </button>

            </div>
        </div>
    </div>
</div>

<script>
    var vmHoaHongKhachGioiThieu = new Vue({
        el: '#vmHoaHongKhachGioiThieu',
        components: {
            'my-date-time': cpmDatetime,
            'customers': cmpChoseCustomer,
            'dropdown': cmpDropdown1Item,
            'nhanviens': ComponentChoseStaff,
            'contacts': cmpNguoiLienHe,
        },
        created: function () {
            var self = this;
            self.UrlAPI = {
                HoaDon: '/api/DanhMuc/BH_HoaDonAPI/',
            }

            self.inforLogin = {
                ID_DonVi: VHeader.IdDonVi,
                ID_NhanVien: VHeader.IdNhanVien,
                UserLogin: VHeader.UserLogin,
            }

            self.roleChangeNgayLapHD = VHeader.Quyen.indexOf('HoaDon_ThayDoiThoiGian') > -1;

            self.PageLoad();
            console.log('vmHoaHongKhachGioiThieu')
        },
        computed: {
            sLoaiDoiTuong: function () {
                let self = this;
                let txt = '';
                switch (parseInt(self.newHoaDon.TongChietKhau)) {
                    case 1:
                        txt = 'Khách hàng';
                        break;
                    case 2:
                        txt = 'Nhà cung cấp';
                        break;
                    case 3:
                        txt = 'Bảo hiểm';
                        break;
                    case 4:
                        txt = 'Nhân viên';
                        break;
                    case 0:
                        txt = 'Khác';
                        break;
                }
                return txt;
            },
        },
        data: {
            saveOK: false,
            isLoading: false,
            typeUpdate: 1,
            isKhoaSo: false,
            inforOld: {

            },
            hdBoSung_Chosing: {
                ID: null,
            },
            txtKhachHang: '',
            txtNguoiGioiThieu: '',
            txtLienHe: '',
            itemChosing: {},

            newHoaDon: {
                ID: null,
                LoaiHoaDon: 41,
                MaHoaDon: '',
                NgayLapHoaDon: '',
                ID_DonVi: null,
                ID_CheckIn: null,// id NguoiGioiThieu
                TongChietKhau: '1', // Loại đối tượng giới thiệu (0.Khác, 1.Khách hàng, 2.Nhà cung cấp, 3.Bảo hiểm, 4.Nhân viên)
                TongTienHang: 0, // tổng tiền hoa hồng được nhận
                DaThanhToan: 0,// tongtien da thanhtoan cho khach = TongTienThu in SoQuy
                DienGiai: '',
                NguoiTao: '',
                An_Hien: false,// Là hóa đơn trích bổ sung
                TrangThai: 0,

                LoaiTien: 'Tiền mặt',
                MaNguoiGioiThieu: '',
                TenNguoiGioiThieu: '',
                SDTNguoiGioiThieu: '',
            },
            listData: {
                NhanViens: [],
                LienHes: [],
            },
            HoaDon_ofCus: {
                ListAll: [],
                ListBoSung: [],
            },
            ThongTinChiTiet: [],
        },
        methods: {
            PageLoad: function () {
                let self = this;
                self.GetListNhanVien();
                self.GetAllLienHe();
            },
            GetListNhanVien: function () {
                let self = this;
                ajaxHelper("/api/DanhMuc/NS_NhanVienAPI/" + "GetNS_NhanVien_InforBasic?idDonVi=" + self.inforLogin.ID_DonVi, 'GET').done(function (data) {
                    self.listData.NhanViens = data;
                })
            },
            GetAllLienHe: function () {
                let self = this;
                ajaxHelper("/api/DanhMuc/DM_LienHeAPI/" + "GetAllLienHe", 'GET').done(function (data) {
                    self.listData.LienHes = data;
                })
            },
            GetListHoaDon_byIDCus: async function (idCus) {
                let self = this;
                let param = {
                    IDCustomers: [idCus],
                    IDCars: [self.newHoaDon.ID_CheckIn],// muontamtruong idcar ~ idnguoi gioithieu
                }
                let xx = await ajaxHelper(self.UrlAPI.HoaDon + "GetListHoaDon_byIDCus", 'POST', param).done(function () {
                }).then(function (x) {
                    if (x.res) {
                        return x.dataSoure;
                    }
                    return [];
                });
                return xx;
            },
            showModal: function () {
                let self = this;
                self.saveOK = false;
                self.isLoading = false;
                self.typeUpdate = 1;
                self.ThongTinChiTiet = [];
                self.itemChosing = {
                    Index: -1,
                    ID_DoiTuong: null,
                }

                self.newHoaDon = {
                    ID: null,
                    LoaiHoaDon: 41,
                    MaHoaDon: '',
                    NgayLapHoaDon: moment(new Date()).format('YYYY-MM-DD HH:mm'),
                    ID_DonVi: VHeader.IdDonVi,
                    ID_CheckIn: null,// id NguoiGioiThieu
                    TongChietKhau: '1', // Loại đối tượng giới thiệu (0.Khác, 1.Khách hàng, 2.Nhà cung cấp, 3.Bảo hiểm, 4.Nhân viên)
                    TongTienHang: 0, // tổng tiền hoa hồng được nhận
                    DaThanhToan: 0,
                    DienGiai: '',
                    NguoiTao: VHeader.UserLogin,
                    An_Hien: false,// Là hóa đơn trích bổ sung
                    TrangThai: 0,

                    LoaiTien: 'Tiền mặt',
                    MaNguoiGioiThieu: '',
                    TenNguoiGioiThieu: '',
                    SDTNguoiGioiThieu: '',
                };

                $('#vmHoaHongKhachGioiThieu').modal('show');
            },
            showModalUpdate: function (idHoaDon, cthd = []) {
                let self = this;
                self.saveOK = false;
                self.isLoading = false;
                self.typeUpdate = 2;
            },
            Enter_FocusNext: function (index) {
                let $this = $(event.currentTarget);
                let $tr = $this.closest('tr').next();
                $tr.find('td').eq(index).find('input').focus().select();
            },
            CheckSave: function () {
                let self = this;

                if (commonStatisJs.CheckNull(self.newHoaDon.ID_CheckIn)) {
                    ShowMessage_Danger('Vui lòng chọn người giới thiệu');
                    return;
                }

                for (let i = 0; i < self.ThongTinChiTiet.length; i++) {
                    let forOut = self.ThongTinChiTiet[i];
                    for (let j = 0; j < forOut.HoaDons.length; j++) {
                        let forIn = forOut.HoaDons[j];
                        let ck = formatNumberToFloat(forIn.TienChietKhau);
                        if (ck === 0) {
                            ShowMessage_Danger('Vui lòng nhập đủ thông tin tiền chiết khấu');
                            return;
                        }
                    }
                }

                return true;
            },
            ChangeNgayLapHoaDon: function (e) {
                let self = this;
                let dt = moment(e).format('YYYY-MM-DD HH:mm');
                self.newHoaDon.NgayLapHoaDon = dt;
            },
            ResetNguoiGioiThieu: function () {
                let self = this;
                self.newHoaDon.MaNguoiGioiThieu = '';
                self.newHoaDon.TenNguoiGioiThieu = '';
                self.newHoaDon.SDTNguoiGioiThieu = '';
                self.newHoaDon.ID_CheckIn = null;
            },
            ChangeNguoiGioiThieu: function (item) {
                let self = this;
                switch (parseInt(self.newHoaDon.TongChietKhau)) {
                    case 1:
                    case 2:
                    case 3:
                        self.newHoaDon.MaNguoiGioiThieu = item.MaDoiTuong;
                        self.newHoaDon.TenNguoiGioiThieu = item.TenDoiTuong;
                        self.newHoaDon.SDTNguoiGioiThieu = item.DienThoai;
                        break;
                    case 4:
                        self.newHoaDon.MaNguoiGioiThieu = item.MaNhanVien;
                        self.newHoaDon.TenNguoiGioiThieu = item.TenNhanVien;
                        self.newHoaDon.SDTNguoiGioiThieu = item.DienThoai;
                        break;
                    case 0:
                        self.newHoaDon.MaNguoiGioiThieu = item.MaLienHe;
                        self.newHoaDon.TenNguoiGioiThieu = item.TenLienHe;
                        self.newHoaDon.SDTNguoiGioiThieu = item.SoDienThoai;
                        break;
                }
                self.newHoaDon.ID_CheckIn = item.ID;

                let $this = $(event.currentTarget);
                $($this).closest('div').hide();
                $($this).closest('div').prev('focus');
            },
            AddNewData_Cus: function () {
                let self = this;
                let obj = {
                    ID_DoiTuong: null,
                    MaDoiTuong: '',
                    TenDoiTuong: '',
                    DienThoai: '',
                    HoaDons: [],
                };
                self.ThongTinChiTiet.push(obj);
            },
            ChoseCustomer: async function (item) {
                let self = this;

                if (commonStatisJs.CheckNull(self.newHoaDon.ID_CheckIn)) {
                    ShowMessage_Danger('Vui lòng chọn người giới thiệu');
                    return;
                }
                let hd = await self.GetListHoaDon_byIDCus(item.ID);
                hd.map(function (x) {
                    x['PTChietKhau'] = ''
                    x['TienChietKhau'] = ''
                })
                self.HoaDon_ofCus.ListAll = hd;
                self.HoaDon_ofCus.ListBoSung = hd.filter(x => x.TrangThai === 1);
                console.log('hd')

                if (hd.length === 0) {
                    ShowMessage_Danger('Không tồn tại hóa đơn');
                    return;
                }
                let obj = {
                    ID_DoiTuong: item.ID,
                    MaDoiTuong: item.MaDoiTuong,
                    TenDoiTuong: item.TenDoiTuong,
                    DienThoai: item.DienThoai,
                    HoaDons: hd.filter(x => x.TrangThai === 0),
                };
                if (self.itemChosing.Index === -1) {
                    self.ThongTinChiTiet.push(obj);
                    self.ThongTinChiTiet = self.ThongTinChiTiet.filter(x => x.ID_DoiTuong !== null && x.HoaDons.length !== 0);
                }
                else {
                    for (let i = 0; i < self.ThongTinChiTiet.length; i++) {
                        let itFor = self.ThongTinChiTiet[i];
                        if (itFor.ID_DoiTuong === self.itemChosing.ID_DoiTuong) {
                            self.ThongTinChiTiet[i] = obj;
                            break;
                        }
                    }
                    self.ThongTinChiTiet = $.extend([], true, self.ThongTinChiTiet)
                }
            },
            ChangeCustomer: function (item, index) {
                let self = this;
                self.itemChosing = {
                    Index: index,
                    ID_DoiTuong: item.ID_DoiTuong,
                }
            },
            ResetCustomer: function () {
                let self = this;
                self.newHoaDon.ID_CheckIn = null;
                self.newHoaDon.TenDoiTuong = '';
                self.newHoaDon.MaDoiTuong = '';
            },
            ChangeLoaiDoiTuong: function () {
                let self = this;
                self.newHoaDon.ID_CheckIn = null;
                self.newHoaDon.TenDoiTuong = '';
                self.newHoaDon.MaDoiTuong = '';
            },
            showlistHDBoSung: function () {
                let self = this;
                let $this = $(event.currentTarget);
                $this.next().show();
            },
            Add_HoaDonBoSung: function (item) {
                let self = this;
                self.hdBoSung_Chosing.ID = item.ID_HoaDon_DuocCK;
                console.log('tt ',item.TrangThai)
                for (let i = 0; i < self.ThongTinChiTiet.length; i++) {
                    let itFor = self.ThongTinChiTiet[i];
                    if (itFor.ID_DoiTuong === item.ID_DoiTuong) {
                        if (item.TrangThai === 1) {// neu da trich full & bosung them: get sum (KhachDaTra)
                            item.ConLai = item.KhachDaTra;
                        }
                        self.ThongTinChiTiet[i].HoaDons.push(item);
                        break;
                    }
                }
                self.HoaDon_ofCus.ListBoSung = self.HoaDon_ofCus.ListBoSung.filter(x => x.ID_HoaDon_DuocCK !== item.ID_HoaDon_DuocCK);
            },
            RemoveAllRow: function (item) {
                let self = this;
                for (let i = 0; i < self.ThongTinChiTiet.length; i++) {
                    let itFor = self.ThongTinChiTiet[i];
                    if (itFor.ID_DoiTuong === item.ID_DoiTuong) {
                        self.ThongTinChiTiet.splice(i, 1);
                        break;
                    }
                }
                self.CaCulatorTongTienHang();
            },
            RemoveOneRow: function (item, ct) {
                let self = this;
                for (let i = 0; i < self.ThongTinChiTiet.length; i++) {
                    let itFor = self.ThongTinChiTiet[i];
                    if (itFor.ID_DoiTuong === item.ID_DoiTuong) {
                        for (let j = 0; j < itFor.HoaDons.length; j++) {
                            let forIn = itFor.HoaDons[j];
                            if (forIn.ID_HoaDon_DuocCK === ct.ID_HoaDon_DuocCK) {
                                itFor.HoaDons.splice(j, 1);
                                break;
                            }
                        }
                        break;
                    }
                }
                console.log('RemoveOneRow ', self.ThongTinChiTiet)
                // add back item to list HDBoSung
                self.HoaDon_ofCus.ListBoSung.push({
                    ID_DoiTuong: item.ID_DoiTuong,
                    MaDoiTuong: item.MaDoiTuong,
                    TenDoiTuong: item.TenDoiTuong,
                    ID_HoaDon_DuocCK: ct.ID_HoaDon_DuocCK,
                    MaHoaDon: ct.MaHoaDon,
                    NgayLapHoaDon: ct.NgayLapHoaDon,
                    TongThanhToan: ct.TongThanhToan,
                    KhachDaTra: ct.KhachDaTra,
                    DaTrich: ct.DaTrich,
                    ConLai: ct.ConLai,
                    TrangThai: ct.TrangThai,
                    PTChietKhau: '',
                    TienChietKhau: '',
                });
               
                self.CaCulatorTongTienHang();
            },
            editPTChietKhau: function (item, ct) {
                let self = this;
                let $this = $(event.currentTarget);
                let gtri = formatNumberToFloat($this.val());

                for (let i = 0; i < self.ThongTinChiTiet.length; i++) {
                    let itFor = self.ThongTinChiTiet[i];
                    if (itFor.ID_DoiTuong === item.ID_DoiTuong) {
                        for (let j = 0; j < itFor.HoaDons.length; j++) {
                            let forIn = itFor.HoaDons[j];
                            if (forIn.ID_HoaDon_DuocCK === ct.ID_HoaDon_DuocCK) {
                                itFor.HoaDons[j].TienChietKhau = formatNumber3Digit(forIn.ConLai * gtri / 100);
                                break;
                            }
                        }
                        break;
                    }
                }
                self.CaCulatorTongTienHang();
            },
            editTienChietKhau: function (item, ct) {
                let self = this;
                let $this = $(event.currentTarget);
                let gtri = formatNumberToFloat($this.val());
                let gtriFormat = gtri;

                let lastone = $this.val().toString().split('').pop();
                if (lastone !== '.') {
                    gtriFormat = formatNumber3Digit(gtri);
                }

                for (let i = 0; i < self.ThongTinChiTiet.length; i++) {
                    let itFor = self.ThongTinChiTiet[i];
                    if (itFor.ID_DoiTuong === item.ID_DoiTuong) {
                        for (let j = 0; j < itFor.HoaDons.length; j++) {
                            let forIn = itFor.HoaDons[j];
                            if (forIn.ID_HoaDon_DuocCK === ct.ID_HoaDon_DuocCK) {
                                itFor.HoaDons[j].PTChietKhau = gtri / forIn.ConLai * 100;
                                itFor.HoaDons[j].TienChietKhau = gtriFormat;
                                break;
                            }
                        }
                        break;
                    }
                }
                self.CaCulatorTongTienHang();
            },
            CaCulatorTongTienHang: function () {
                let self = this;
                let sum = 0;
                for (let i = 0; i < self.ThongTinChiTiet.length; i++) {
                    let itFor = self.ThongTinChiTiet[i];
                    for (let j = 0; j < itFor.HoaDons.length; j++) {
                        let forIn = itFor.HoaDons[j];
                        let gtri = formatNumberToFloat(forIn.TienChietKhau);
                        sum += gtri;
                    }
                }
                self.newHoaDon.TongTienHang = sum;
                self.newHoaDon.DaThanhToan = sum;
            },
            saveHoaDon: function () {// used to lui ngaylapHD
                let self = this;
                let check = self.CheckSave();
                if (!check) {
                    return;
                }

                let cthd = [];
                let url = '', sType = '', user = '', sOld = '', sListHD = '';

                let hd = {
                    MaHoaDon: self.newHoaDon.MaHoaDon,
                    LoaiHoaDon: 41,
                    ID_DonVi: self.inforLogin.ID_DonVi,
                    ID_NhanVien: self.inforLogin.ID_NhanVien,
                    ID_CheckIn: self.newHoaDon.ID_CheckIn,
                    NgayLapHoaDon: self.newHoaDon.NgayLapHoaDon,
                    TongChietKhau: self.newHoaDon.TongChietKhau,
                    TongTienHang: self.newHoaDon.TongTienHang,
                    NguoiTao: self.inforLogin.UserLogin,
                    DienGiai: self.newHoaDon.DienGiai,
                    ChoThanhToan: false,
                }

                for (let i = 0; i < self.ThongTinChiTiet.length; i++) {
                    let forOut = self.ThongTinChiTiet[i];
                    let sDetail = '';
                    for (let j = 0; j < forOut.HoaDons.length; j++) {
                        let forIn = forOut.HoaDons[j];
                        let obj = {
                            ID_ParentCombo: forIn.ID_HoaDon_DuocCK,
                            //ID_ThueSuat: forIn.ID_QuyHoaDon,
                            PTChietKhau: forIn.PTChietKhau,
                            TienChietKhau: forIn.TienChietKhau,
                            SoThuTu: 1,// 1.thucthu, 2.doanhthu
                            MaHangHoa: '',
                            TenHangHoa: '',
                            PTThue: forIn.TrangThai, //1.trich bosung
                        };
                        cthd.push(obj);
                        sDetail = sDetail.concat('<br /> - <a> ', forIn.MaHoaDon, ' </a>, Thực thu: ', formatNumber3Digit(forIn.ConLai),
                            ', PT chiết khấu: ', forIn.PTChietKhau, ', Tiền chiết khấu: ', formatNumber3Digit(forIn.TienChietKhau));
                    }
                    sListHD = sListHD.concat('<br /> ', i + 1, '. ', forOut.TenDoiTuong, ' (', forOut.MaDoiTuong, ')', sDetail);
                }

                if (self.typeUpdate === 1) {
                    url = 'Post_HoaDonTrichHoaHong';
                    sType = 'Thêm mới';
                    user = '<br /> Người tạo: '.concat(VHeader.UserLogin);
                }
                else {
                    sType = 'Cập nhật';
                    user = '<br /> Người sửa: '.concat(VHeader.UserLogin);
                    sOld = '<br /> <b> Thông tin cũ: </b>'.concat(
                        ' <br /> Mã phiếu: ', self.contactOld.TenLienHe,
                        ' <br /> Ngày lập phiếu: ', moment(data.NgayLapHoaDon).format('DD/MM/YYYY HH:mm'),
                        ' <br /> Người giới thiệu là: ', self.sLoaiDoiTuong,
                        ' <br /> Mã người giới thiệu: ', self.newHoaDon.MaNguoiGioiThieu,
                        ' <br /> Tên người giới thiệu: ', self.newHoaDon.TenNguoiGioiThieu,
                        ' <br /> Tổng thanh toán: ', formatNumber3Digit(self.newHoaDon.DaThanhToan));
                }

                let myData = {
                    objHoaDon: hd,
                    objCTHoaDon: cthd,
                }
                if (!$.isEmptyObject(hd)) {
                    self.isLoading = true;
                    ajaxHelper(self.UrlAPI.HoaDon + url, 'POST', myData).done(function (x) {
                        if (x.res) {
                            ShowMessage_Success(sType + ' phiếu trích hoa hồng thành công');

                            let data = x.data;
                            let diary = {
                                ID_DonVi: self.inforLogin.ID_DonVi,
                                ID_NhanVien: self.inforLogin.ID_NhanVien,
                                LoaiNhatKy: self.typeUpdate,
                                ChucNang: 'Phiếu trích hoa hồng',
                                NoiDung: sType.concat(' phiếu trích hoa hồng ', data.MaHoaDon),
                                NoiDungChiTiet: 'Nội dung chi tiết '.concat(' <br /> Mã phiếu: ', data.MaHoaDon,
                                    ' <br /> Ngày lập phiếu: ', moment(data.NgayLapHoaDon).format('DD/MM/YYYY HH:mm'),
                                    ' <br /> Người giới thiệu là: ', self.sLoaiDoiTuong,
                                    ' <br /> Mã người giới thiệu: ', self.newHoaDon.MaNguoiGioiThieu,
                                    ' <br /> Tên người giới thiệu: ', self.newHoaDon.TenNguoiGioiThieu,
                                    ' <br /> Tổng thanh toán: ', formatNumber3Digit(self.newHoaDon.DaThanhToan),
                                    sListHD, user, sOld),
                            }
                            Insert_NhatKyThaoTac_1Param(diary);
                        }
                        else {
                            ShowMessage_Danger(sType + ' phiếu trích hoa hồng thất bại');
                        }
                    }).always(function () {
                        self.isLoading = false;
                        $('#vmHoaHongKhachGioiThieu').modal('hide');
                    })
                }
            },
            showModalContact: function () {
                vmThemMoiLienHe.showModal();
            },
        }
    })

    $('#vmThemMoiLienHe').on('hidden.bs.modal', function () {
        if (vmThemMoiLienHe.saveOK) {
            let newObj = vmThemMoiLienHe.newContact;
            vmHoaHongKhachGioiThieu.newHoaDon.ID_CheckIn = newObj.ID;
            vmHoaHongKhachGioiThieu.newHoaDon.MaNguoiGioiThieu = newObj.MaLienHe;
            vmHoaHongKhachGioiThieu.newHoaDon.TenNguoiGioiThieu = newObj.TenLienHe;
            vmHoaHongKhachGioiThieu.newHoaDon.SDTNguoiGioiThieu = newObj.SoDienThoai;
            vmHoaHongKhachGioiThieu.listData.LienHes.push(newObj);
        }
    })

</script>
