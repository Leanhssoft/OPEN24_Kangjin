@using System.Web.Optimization;
@using banhang24.AppCache;
@using banhang24.Hellper;
@{
    Layout = null;
    ViewBag.Title = "Open24.vn - Đặt hàng";
}
<link rel="stylesheet" href="~/Content/Dathang.css" />
<div class="op-container" id="divPage">
    <input style="display:none" value="@ViewBag.shopCookies" id="txtShopCookie" />
    <input style="display:none" value="@ViewBag.cookieUserLogin" id="txtUserLogin" />
    <input style="display:none" value="@ViewBag.LoaiHoaDon" id="txtLoaiHoaDon" />
    <input type="hidden" value="@contant.GetUserCookies().ID" id="txtIDUser" />
    <div class="col-left">
        <div class=" op-filter">
            <section class="op-filter-body">
                <article class="boxLeft " data-bind="visible: ChiNhanhs()!=null && ChiNhanhs().length > 1">
                    <h3 class="op-filter-title" onclick="toggleSubFilter(this)">
                        <img src="/Content/images/icon/loaithuchi.png">  Chi nhánh
                    </h3>
                    <aside class="op-filter-container">
                        <div class="op-tag-picker dropdown">
                            <div data-toggle="dropdown" aria-expanded="false" id="choose_TenDonVi">
                                <ul data-bind="foreach: MangNhomDV">
                                    <li>
                                        <span data-bind="text: TenDonVi">
                                        </span>
                                        <span data-bind="click: $parent.CloseDV">
                                            <i class="fa fa-times"></i>
                                        </span>
                                    </li>
                                </ul>
                                <input type="text" class=" form-control" placeholder="Chọn bảng giá" id="dllChiNhanh">
                            </div>
                            <ul data-bind="foreach: ChiNhanhs" class="dropdown-menu" id="selec-all-DV">
                                <li>
                                    <a data-bind="text: TenDonVi,attr:{id: ID}, event:{click: $parent.selectedCN}"></a>
                                </li>
                            </ul>
                        </div>
                    </aside>
                </article>
                <!--ko if: $root.LoaiHoaDonMenu() === 1-->
                <article class="boxLeft" style="display:none">
                    <h3 class="op-filter-title" onclick="toggleSubFilter(this)">
                        <i class="fa fa-list"></i>
                        Loại phiếu
                    </h3>
                    <aside class="op-filter-container">
                        <div class="menuCheckbox">
                            <ul>
                                <li>
                                    <label><input type="checkbox" data-bind="checked: La_HDSuaChua"> Báo giá</label>
                                </li>
                                <li>
                                    <label><input type="checkbox" data-bind="checked: La_HDBan"> Đặt hàng</label>
                                </li>
                            </ul>
                        </div>
                    </aside>
                </article>
                <!--/ko-->
                <article class="boxLeft">
                    <h3 class="op-filter-title" onclick="toggleSubFilter(this)">
                        <img src="~/Content/images/icon/thoigian.png" />         Thời gian
                    </h3>
                    <aside class="op-filter-container">
                        <div class="menuCheckbox">
                            <div class="form-group floatleft">
                                <div class="radio-menu">
                                    <input type="radio" data-bind="checked: filterNgayLapHD" value="0" />
                                </div>
                                <div class="conten-choose">
                                    <div class="choose-date">
                                        <input type="text" class="dropdown form-control choose-date-show" placeholder="Toàn thời gian"
                                               value="Tháng này" data-bind=" enable: filterNgayLapHD()=='0'" data-toggle="dropdown" aria-expanded="true"
                                               id="txtNgayTao" autocomplete="off">
                                        <div class="dropdown-menu choseNgayTao">
                                            <div class="col-md-4 col-sm-4 col-xs-12">
                                                <h3>Theo ngày và tuần</h3>
                                                <ul>
                                                    <li value="1"><a href="javascript:void(0);">Hôm nay</a></li>
                                                    <li value="2"><a href="javascript:void(0);">Hôm qua</a></li>
                                                    <li value="3"><a href="javascript:void(0);">Tuần này</a></li>
                                                    <li value="4"><a href="javascript:void(0);">Tuần trước</a></li>
                                                </ul>
                                            </div>
                                            <div class="col-md-4 col-sm-4 col-xs-12">
                                                <h3>Theo tháng và quý</h3>
                                                <ul>
                                                    <li value="6"><a href="javascript:void(0);">Tháng này</a></li>
                                                    <li value="7"><a href="javascript:void(0);">Tháng trước</a></li>
                                                    <li value="10"><a href="javascript:void(0);">Quý này</a></li>
                                                    <li value="11"><a href="javascript:void(0);">Quý trước</a></li>
                                                </ul>
                                            </div>
                                            <div class="col-md-4 col-sm-4 col-xs-12">
                                                <h3>Theo năm</h3>
                                                <ul>
                                                    <li value="12"><a href="javascript:void(0);">Năm này</a></li>
                                                    <li value="13"><a href="javascript:void(0);">Năm trước</a></li>
                                                    <li value="0"><a href="javascript:void(0);">Toàn thời gian</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group floatleft">
                                <div class="radio-menu">
                                    <input type="radio" data-bind="checked: filterNgayLapHD" value="1" />
                                </div>
                                <div class="conten-choose">
                                    <div class="floatleft form-wrap ">
                                        <input type='text' class="form-control daterange" id="txtNgayTaoInput" name="daterange"
                                               placeholder="23/12/2017"
                                               data-bind="value: filterNgayLapHD_Input, enable: filterNgayLapHD()!=='0'" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </aside>
                </article>
                <article class="boxLeft">
                    <h3 class="op-filter-title" onclick="toggleSubFilter(this)">
                        <img src="~/Content/images/icon/trangthai (1).png" />     Trạng thái
                    </h3>
                    <aside class="op-filter-container">
                        <div class="menuCheckbox">
                            <ul>
                                <!--ko if: $root.LoaiHoaDonMenu() !== 1 -->
                                <li>
                                    <label><input type="checkbox" data-bind="checked: TT_TamLuu"> Phiếu tạm</label>
                                </li>
                                <li>
                                    <label><input type="checkbox" data-bind="checked: TT_DaDuyet"> Đã lưu</label>
                                </li>
                                <li>
                                    <label><input type="checkbox" data-bind="checked: TT_GiaoHang">Đang lưu hàng</label>
                                </li>
                                <li>
                                    <label><input type="checkbox" data-bind="checked: TT_HoanThanh"> Hoàn thành</label>
                                </li>
                                <li>
                                    <label><input type="checkbox" data-bind="checked: TT_DaHuy"> Đã hủy</label>
                                </li>
                                <!--/ko-->
                                <!--ko if: $root.LoaiHoaDonMenu() === 1-->
                                <li>
                                    <label><input type="checkbox" data-bind="checked: TT_TamLuu"> Chờ duyệt</label>
                                </li>
                                <li>
                                    <label><input type="checkbox" data-bind="checked: TT_DaDuyet"> Đã duyệt</label>
                                </li>
                                <li>
                                    <label><input type="checkbox" data-bind="checked: TT_GiaoHang"> Đang xử lý</label>
                                </li>
                                <li>
                                    <label><input type="checkbox" data-bind="checked: TT_HoanThanh"> Hoàn thành</label>
                                </li>
                                <li>
                                    <label><input type="checkbox" data-bind="checked: TT_DaHuy"> Đã hủy</label>
                                </li>
                                <!--/ko-->
                            </ul>
                        </div>
                    </aside>
                </article>
            </section>
            <div class="op-filter-footer">
                <button type="button" class="btn btn-link" style="color:red" onclick="closeFilter()">Hủy</button>
                <button type="button" class="btn btn-link" onclick="collapseSubFilter(this)">
                    <span>Thu gọn</span>
                </button>
                <button type="button" class="btn btn-link" style="display:none" onclick="expandSubFilter(this)">
                    <span>Mở rộng</span>
                </button>
                <button type="button" class="btn btn-main kv2Btn" onclick="closeFilter()">Hoàn tất</button>
            </div>
        </div>
    </div>
    <div class="col-right">
        <div class="op-header">
            <div class="op-header-title">
                <!--ko if: $root.LoaiHoaDonMenu() == 0 -->
                <h2 class="pull-left title">@banhang24.Resources.ResourceTexts.Exchange / Đặt hàng</h2>
                <!-- /ko -->
                <!-- ko if: $root.LoaiHoaDonMenu() == 1 -->
                <h2 class="pull-left title">@banhang24.Resources.ResourceTexts.Exchange / Báo giá sửa chữa</h2>
                <!-- /ko -->
            </div>
            <div class="flex flex-between">
                <div class=" header-button">
                    <!--ko if: $root.RoleInsert_Order() -->
                    <div class="btn-group" style="margin-right:5px;">
                        <div type="button" class="btn btn-main " data-bind="click: DatHang">
                            <i class="fa fa-plus"></i><font>Thêm mới</font>
                        </div>
                    </div>
                    <!-- /ko -->
                    <button class="btn-link shownhapxuat " id="shownhapxuat" title="Chức năng nhập xuất" style="width:30px;">
                        <i class="material-icons"> more_vert</i>
                    </button>
                    <!--ko if: $root.RoleExport_Order() -->
                    <div class="btn-group" style="margin-right: 3px;">
                        <button type="button" class=" btn btn-main dropdown-toggle btnExport" data-toggle="dropdown" hidden
                                data-bind="click: ExportExcel_DatHang" id="btnExport">
                            <i class="fa fa-file-excel-o"></i> Xuất file
                        </button>
                    </div>
                    <!-- /ko -->
                    <div class="btn-dropdown open pull-right" style="position: relative;">
                        <button type="button" class="btn btn-main" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" onclick="showCollumnFilter(this)"
                                id="btnViewCheck" hidden>
                            <i class="fa fa-angle-double-down"></i>
                        </button>
                        <div class="dropdown-list dropdown-list-two" style="display:none" id="myList">
                            <div class="col-sm-6 dropdown-left">
                                <ul data-bind="foreach: ListCheckBox">
                                    <!--ko if: $index() < $root.NumberColum_Div2()-->
                                    <li>
                                        <div class="checkbox">
                                            <label>
                                                <input type="checkbox" class="checkbox" checked="checked" data-bind="value: Key">
                                                <span></span>
                                                <label class="nopadding" data-bind="text: Value"></label>
                                            </label>
                                        </div>
                                    </li>
                                    <!--/ko-->
                                </ul>
                            </div>
                            <div class="col-sm-6 dropdown-right">
                                <ul data-bind="foreach: ListCheckBox">
                                    <!--ko if: $index() >= $root.NumberColum_Div2()-->
                                    <li>
                                        <div class="checkbox">
                                            <label>
                                                <input type="checkbox" class="checkbox" checked="checked" data-bind="value: Key">
                                                <span></span>
                                                <label class="nopadding" data-bind="text: Value"></label>
                                            </label>
                                        </div>
                                    </li>
                                    <!--/ko-->
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex ">
                    <div class="op-search">
                        <input type="text" class="form-control" placeholder="Mã hóa đơn, Tên KH, SĐT, Mã (tên) hàng hóa, Người tạo, Người bán" id="txtMaHD"
                               data-bind="value: filter,valueUpdate: 'afterkeydown'" autocomplete="off">
                        <button type="button" class=" op-search-button" data-bind="click: Click_IconSearch">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>
                    <button class="btn btn-main op-filter-toggle" onclick="showFilter()" title="Hiển thị bộ lọc">
                        <i class="material-icons">sort</i>
                    </button>
                </div>
            </div>
        </div>
        <div class="content-table " id="myScrollspy">
            <div class="table-frame">
                <table class="table table-new table-hover" id="tb">
                    <thead class="thead-boder">
                        <tr data-bind="foreach: $root.ListCheckBox()">
                            <th data-bind="attr:{class: Key}">
                                <a href="javascript:void(0)" data-bind="text: Value"></a>
                            </th>
                        </tr>
                    </thead>
                    <tbody data-bind="foreach: HoaDons">
                        <tr class="prev-tr-hide" id="table" data-bind="click: $parent.LoadChiTietHD,css:{bggray : $index()%2 == 1}">
                            <td class="@commonEnum.ColumnOrders.madathang" data-bind="text: MaHoaDon "></td>
                            <td class="@commonEnum.ColumnOrders.ngaylaphoadon "><span data-bind="text: moment(NgayLapHoaDon).format('DD/MM/YYYY HH:mm')!='Invalid date'? moment(NgayLapHoaDon).format('DD/MM/YYYY HH:mm'):''"></span></td>
                            <!--ko if: $root.LoaiHoaDonMenu() === 1 -->
                            <td class="@commonEnum.ColumnOrders.maphieutiepnhan ">
                                <a href="=javascript:void(0)" data-bind="text: MaPhieuTiepNhan, click: function(){ $root.gotoKhachHang($data,2)}"></a>
                            </td>
                            <td class="@commonEnum.ColumnOrders.bienso">
                                <a href="=javascript:void(0)" data-bind="text: BienSo, click: function(){ $root.gotoKhachHang($data,3)}"></a>
                            </td>
                            <!--/ko-->
                            <td class="@commonEnum.ColumnReturns.makhachhang ">
                                <a href="=javascript:void(0)" data-bind="text: MaDoiTuong, click: function(){ $root.gotoKhachHang($data,1)}"></a>
                            </td>
                            <td class="@commonEnum.ColumnOrders.tenkhachhang">
                                <span data-bind="text: TenDoiTuong"></span>
                                <span data-bind="text: TheoDoi== false?'':'{DEL}'" style="color:chocolate"></span>
                            </td>
                            <td class="@commonEnum.ColumnOrders.sodienthoai ">
                                <span data-bind="text:DienThoai"></span>
                            </td>
                            <td class="@commonEnum.ColumnOrders.diachi ">
                                <span data-bind="text:DiaChiKhachHang"></span>
                            </td>
                            <td class="@commonEnum.ColumnOrders.khuvuc ">
                                <span data-bind="text:KhuVuc"></span>
                            </td>
                            <td class="@commonEnum.ColumnOrders.tenchinhanh ">
                                <span data-bind="text: TenDonVi"></span>
                            </td>
                            <td class="@commonEnum.ColumnOrders.nguoiban ">
                                <span data-bind="text: TenNhanVien"></span>
                            </td>
                            <td class="@commonEnum.ColumnOrders.nguoitao ">
                                <span data-bind="text: NguoiTaoHD"></span>
                            </td>
                            <td class="@commonEnum.ColumnOrders.tongtienhang text-right">
                                <span data-bind="text: formatNumber3Digit(TongTienHang,2)"></span>
                            </td>
                            <td class="@commonEnum.ColumnInvoices.tienthue text-right">
                                <span data-bind="text: formatNumber3Digit(TongTienThue,2)"></span>
                            </td>
                            <td class="@commonEnum.ColumnOrders.tonggiamgia text-right">
                                <span data-bind="text: formatNumber3Digit(TongGiamGia,2)"></span>
                            </td>
                            <td class="@commonEnum.ColumnInvoices.tongchiphi text-right">
                                <span data-bind="text: formatNumber3Digit(TongChiPhi,2)"></span>
                            </td>
                            <td class="@commonEnum.ColumnOrders.khachcantra text-right">
                                <span data-bind="text: formatNumber3Digit(PhaiThanhToan,2)"></span>
                            </td>
                            <td class="@commonEnum.ColumnOrders.khachdatra text-right">
                                <span data-bind="text: formatNumber3Digit(KhachDaTra,2)"></span>
                            </td>
                            <td class="@commonEnum.ColumnOrders.ghichu">
                                <span data-bind="text: DienGiai"></span>
                            </td>
                            <!--ko if: $root.LoaiHoaDonMenu() !== 1 -->
                            <td class="@commonEnum.ColumnOrders.trangthai">
                                <span data-bind="text: TrangThai"></span>
                            </td>
                            <!--/ko-->
                            <!--ko if: $root.LoaiHoaDonMenu() === 1 -->
                            <td class="@commonEnum.ColumnOrders.trangthai">
                                <span data-bind="text: Gara_TrangThaiBG"></span>
                            </td>
                            <!--/ko-->
                        </tr>
                        <tr class="op-js-tr-hide">
                            <td colspan="20">
                                <div class="op-object-detail ">
                                    <ul class="nav nav-tabs">
                                        <li class="active" onclick="LoadGetHeight()"><a data-bind="attr:{href:'#home_'+ ID}" data-toggle="tab">Thông tin</a></li>
                                        <li onclick="LoadGetHeight()">
                                            <a data-toggle="tab"
                                               data-bind="attr:{href:'#his_'+ ID}, visible: $parent.VisibleHis_HisHDofDH, click: $parent.GetLichSuTraHang ">
                                                Nhật ký hóa đơn
                                            </a>
                                        </li>
                                        <li onclick="LoadGetHeight()">
                                            <a data-toggle="tab" data-bind="attr:{href:'#hisTT_'+ ID}, click: $parent.GetLichSuThanhToan">Nhật ký thanh toán</a>
                                        </li>
                                    </ul>
                                    <div class="tab-content">
                                        <div class="tab-pane active" data-bind="attr:{id:'home_'+ ID}">
                                            <div class="op-object-detail ">
                                                <div class="op-object-detail-left">
                                                    <div class="form-group floatleft">
                                                        <label class="css-form-label"> Chi nhánh:</label>
                                                        <div class="css-form-detail">
                                                            <span data-bind="text: TenDonVi"></span>
                                                        </div>
                                                    </div>
                                                    <div class="form-group floatleft">
                                                        <label class="css-form-label">Mã đặt hàng:</label>
                                                        <div class="css-form-detail">
                                                            <span data-bind="text: MaHoaDon "></span>
                                                        </div>
                                                    </div>
                                                    <div class="form-group floatleft ">
                                                        <label class="css-form-label">Ngày lập HĐ:</label>
                                                        <div class="css-form-detail">
                                                            <input type="text" class="form-control txtNgayLapHD"
                                                                   data-bind="value: moment(NgayLapHoaDon).format('DD/MM/YYYY HH:mm')!='Invalid date'? moment(NgayLapHoaDon).format('DD/MM/YYYY HH:mm'):''
                                                                               , enable: $parent.ThayDoi_NgayLapHD() && $parent.Enable_NgayLapHD()">
                                                        </div>
                                                    </div>
                                                    <div class="form-group floatleft">
                                                        <label class="css-form-label">Khách hàng:</label>
                                                        <div class="css-form-detail">
                                                            <span data-bind="text: TenDoiTuong">
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <!--ko if: $root.LoaiHoaDonMenu() === 1-->
                                                    <div class="form-group floatleft">
                                                        <label class="css-form-label">Tên công ty BH:</label>
                                                        <div class="css-form-detail">
                                                            <span data-bind="text: TenBaoHiem">
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <div class="form-group floatleft">
                                                        <label class="css-form-label">Liên hệ BH:</label>
                                                        <div class="css-form-detail ">
                                                            <div class="flexf flex-row" style="flex-wrap:wrap">
                                                                <span data-bind="text: LienHeBaoHiem"></span>
                                                                <span data-bind="visible:SoDienThoaiLienHeBaoHiem">-</span>
                                                                <span data-bind="text: SoDienThoaiLienHeBaoHiem"></span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <!--/ko-->
                                                    <div class="form-group floatleft ">
                                                        <label class="css-form-label">Bảng giá:</label>
                                                        <div class="css-form-detail">
                                                            <span data-bind="visible: TenBangGia!==null, text: TenBangGia">
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <div class="form-group floatleft">
                                                        <label class="css-form-label">Trạng thái:</label>
                                                        <div class="css-form-detail">
                                                            <!--ko if: !$root.LoaiHoaDonMenu() !== 1 -->
                                                            <span data-bind="text: TrangThai"></span>
                                                            <!--/ko-->
                                                            <!--ko if: $root.LoaiHoaDonMenu() === 1 -->
                                                            <span data-bind="text: Gara_TrangThaiBG"></span>
                                                            <!--/ko-->
                                                        </div>
                                                    </div>
                                                    <div class="form-group floatleft ">
                                                        <label class="css-form-label">Người bán:</label>
                                                        <div class="css-form-detail">
                                                            <select class="form-control"
                                                                    data-bind="options: $root.NhanViens, optionsText: 'TenNhanVien', optionsValue: 'ID', value: $data.ID_NhanVien,
                                                                                event:{change: $root.GetID_NhanVien},
                                                                                enable: $parent.Enable_NgayLapHD() && $parent.ThayDoi_NVienBan()"></select>
                                                        </div>
                                                    </div>
                                                    <div class="form-group floatleft">
                                                        <label class="css-form-label">Người tạo:</label>
                                                        <div class="css-form-detail">
                                                            <span data-bind="text: NguoiTaoHD"></span>
                                                        </div>
                                                    </div>
                                                    <div class="form-group floatleft ">
                                                        <label class="css-form-label">Ghi chú:</label>
                                                        <div class="css-form-detail">
                                                            <textarea rows="3" data-bind="value: DienGiai, enable: $parent.Enable_NgayLapHD()"></textarea>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="op-object-detail-right">
                                                    <div class="table-res loadcthd" style="overflow:scroll">
                                                        <table class="table-filter table table-detal">
                                                            <thead>
                                                                <tr>
                                                                    <th>
                                                                        <div class="col-md-3 header-title-filter">
                                                                            Mã hàng hóa  <span class="glyphicon glyphicon-search icon-filter"></span>
                                                                        </div>
                                                                        <div class="col-md-8">
                                                                            <div class="right-inner-addon" hidden>
                                                                                <span class="glyphicon glyphicon-search"></span>
                                                                                <input type="text" class="form-control"
                                                                                       data-bind="value: $parent.filterHangHoa_ChiTietHD, valueUpdate: 'afterkeydown'"
                                                                                       placeholder="Tìm kiếm chi tiết hàng hóa">
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-md-1">
                                                                            <span class="glyphicon glyphicon-chevron-left  icon-filter2" hidden></span>
                                                                        </div>
                                                                    </th>
                                                                    <th>Tên hàng</th>
                                                                    <th>Đvt</th>
                                                                    <th data-bind="visible: $root.ShowColumn_LoHang">Lô hàng</th>
                                                                    <th>Số lượng</th>
                                                                    <th>Đơn giá</th>
                                                                    <th>Chiết khấu</th>
                                                                    <th class="text-right">Giá bán</th>
                                                                    <!--ko if: $root.LoaiHoaDonMenu() === 1-->
                                                                    <th>Thuế</th>
                                                                    <!--/ko-->
                                                                    <th class="text-right">Thành tiền</th>
                                                                    <!--ko if: $root.LoaiHoaDonMenu() === 1-->
                                                                    <th>Thanh toán</th>
                                                                    <!--/ko-->
                                                                </tr>
                                                            </thead>
                                                            <tbody data-bind="foreach: $parent.PageResult_CTHoaDons">
                                                                <tr>
                                                                    <td>
                                                                        <span data-bind="text: MaHangHoa"></span>
                                                                        <span data-bind="text: Del" style="color:red"></span>
                                                                    </td>
                                                                    <td>
                                                                        <span data-bind="text: TenHangHoaThayThe"></span>
                                                                        <i class="fal fa-info-circle" title="Thành phần combo"
                                                                           data-bind="visible: LoaiHangHoa  ===3, click: $root.showTPComBo"></i>
                                                                        <span data-bind="text: ThuocTinh_GiaTri" style="color:chocolate"></span>
                                                                    </td>
                                                                    <td style="color: #8abb0f" data-bind="text: TenDonViTinh"></td>
                                                                    <td data-bind="visible: $root.ShowColumn_LoHang,click: $root.Goto_LoHang">
                                                                        <a href="javascript:void(0)" style="color:palevioletred" data-bind="text:MaLoHang !== '' && MaLoHang !== null? MaLoHang:''"></a>
                                                                    </td>
                                                                    <td class="text-center" data-bind="text: formatNumber3Digit(SoLuong)"></td>
                                                                    <td class="text-right" data-bind="text: formatNumber3Digit(DonGia) "></td>
                                                                    <td class="text-right" data-bind="text: formatNumber3Digit(GiamGia)"></td>
                                                                    <td class="text-right" data-bind="text: formatNumber3Digit(GiaBan)"></td>
                                                                    <!--ko if: $root.LoaiHoaDonMenu() === 1-->
                                                                    <td class="text-right" data-bind="text: formatNumber3Digit(TienThue)"></td>
                                                                    <!--/ko-->
                                                                    <td class="text-right" data-bind="text: formatNumber3Digit(ThanhTien) "></td>
                                                                    <!--ko if: $root.LoaiHoaDonMenu() === 1 -->
                                                                    <td class="text-right" data-bind="text: formatNumber3Digit(ThanhToan,2) "></td>
                                                                    <!--/ko-->
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    <div class="page container-fluid">
                                                        <div class="flex flex-end">
                                                            <a href="javascript:void(0)" data-bind="click: $root.StartPage_CTHD, visible: $root.VisibleStartPage_CTHD"><i class="fa fa-step-backward" aria-hidden="true"></i></a>
                                                            <a href="javascript:void(0)" data-bind="click: $root.BackPage_CTHD, visible: $root.VisibleStartPage_CTHD "><i class="fa fa-caret-left" aria-hidden="true"></i></a>
                                                            <ul data-bind="foreach: $root.PageList_CTHD">
                                                                <li>
                                                                    <a href="javascript:void(0)" data-bind="text: pageNumber, click: $root.GoToPage_CTHD, css: $root.GetClass_CTHD($data)"></a>
                                                                </li>
                                                            </ul>
                                                            <a href="javascript:void(0)" data-bind="click: $root.GoToNextPage_CTHD, visible: $root.VisibleEndPage_CTHD "><i class="fa fa-caret-right" aria-hidden="true"></i></a>
                                                            <a href="javascript:void(0)" data-bind="click: $root.EndPage_CTHD, visible: $root.VisibleEndPage_CTHD "><i class="fa fa-step-forward" aria-hidden="true"></i></a>
                                                            <div class="total-recos">
                                                                Hiển thị <span data-bind="text: $root.fromitem_CTHD"></span> - <span data-bind="text: $root.toitem_CTHD"></span> trên tổng số
                                                                <span data-bind="text: $root.TotalRecord_CTHD"></span> bản ghi
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="container-fluid op-table-summary" style="margin-bottom:30px">
                                                        <div class="row">
                                                            <div class="col-md-7">
                                                            </div>
                                                            <div class="col-md-5 footer-total-detail pull-right">
                                                                <div class="floatleft sum-prduct">
                                                                    <div class="col-xs-5 col-sm-5  col-lg-7 text-right">
                                                                        Tổng số lượng:
                                                                    </div>
                                                                    <div class="col-xs-7 col-sm-7 col-lg-5 text-right">
                                                                        <div class="row" data-bind="text:$parent.TongSLuong ">
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="floatleft sum-prduct">
                                                                    <div class="col-xs-5 col-sm-5  col-lg-7 text-right">
                                                                        Tổng tiền hàng:
                                                                    </div>
                                                                    <div class="col-xs-7 col-sm-7 col-lg-5 text-right">
                                                                        <div class="row" data-bind="text: formatNumber3Digit(TongTienHang,2)">
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="floatleft sum-prduct" data-bind="visible: TongTienThue > 0">
                                                                    <div class="col-xs-5 col-sm-5  col-lg-7 text-right">
                                                                        Thuế VAT : <span data-bind="visible: PTThueHoaDon > 0, text: '(' + PTThueHoaDon +'%)'"></span>
                                                                    </div>
                                                                    <div class="col-xs-7 col-sm-7 col-lg-5 text-right">
                                                                        <div class="row" data-bind="text: formatNumber3Digit(TongTienThue,2)">
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="floatleft sum-prduct">
                                                                    <div class="col-xs-5 col-sm-5  col-lg-7 text-right">
                                                                        Giảm giá phiếu đặt : <span data-bind="visible: TongChietKhau > 0, text: '(' + TongChietKhau +'%)'"></span>
                                                                    </div>
                                                                    <div class="col-xs-7 col-sm-7 col-lg-5 text-right">
                                                                        <div class="row" data-bind="text: formatNumber3Digit(TongGiamGia,2)">
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="floatleft sum-prduct" data-bind="visible: TongChiPhi > 0">
                                                                    <div class="col-xs-5 col-sm-5  col-lg-7 text-right">
                                                                        Tổng chi phí :
                                                                    </div>
                                                                    <div class="col-xs-7 col-sm-7 col-lg-5 text-right">
                                                                        <div class="row" data-bind="text: formatNumber3Digit(TongChiPhi,2)">
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="floatleft sum-prduct">
                                                                    <div class="col-xs-5 col-sm-5  col-lg-7 text-right">
                                                                        Tổng cộng:
                                                                    </div>
                                                                    <div class="col-xs-7 col-sm-7 col-lg-5 text-right">
                                                                        <div class="row" data-bind="text: formatNumber3Digit(TongThanhToan,2)"></div>
                                                                    </div>
                                                                </div>
                                                                <div class="floatleft sum-prduct">
                                                                    <div class="col-xs-5 col-sm-5  col-lg-7 text-right">
                                                                        Khách đã trả:
                                                                    </div>
                                                                    <div class="col-xs-7 col-sm-7 col-lg-5 text-right">
                                                                        <div class="row" data-bind="text: YeuCau =='4'?0:formatNumber3Digit(KhachDaTra,2)"></div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="op-object-detail-function">
                                                    <!-- ko if: $root.RoleUpdate_Order() && $root.Enable_NgayLapHD()-->
                                                    <button href="javascript:void(0)" class="btn btn-main" data-bind="click: $parent.updateHoaDon">
                                                        <i class="fa fa-save"></i> Lưu
                                                    </button>
                                                    <!--/ko-->
                                                    <!--ko if: $root.LoaiHoaDonMenu() === 1 && $root.RoleApprove_Order() && $root.Enable_NgayLapHD()-->
                                                    <button href="javascript:void(0)" class="btn btn-main btnXuLiDH"
                                                            data-bind="click: $root.DuyetBaoGia, visible: ChoThanhToan">
                                                        <i class="fa fa-recycle"></i>Duyệt báo giá
                                                    </button>
                                                    <!--/ko-->
                                                    <!-- ko if: $root.Show_BtnXulyDH() && $root.Enable_NgayLapHD()-->
                                                    <button href="javascript:void(0)" class="btn btn-main btnXuLiDH"
                                                            data-bind="click: $parent.XuLiDonHang, visible: (YeuCau ==='1' || YeuCau ==='2' || YeuCau =='') && ChoThanhToan == false">
                                                        <i class="fa fa-recycle"></i>Xử lí đơn hàng
                                                    </button>
                                                    <!--/ko-->
                                                    <!-- ko if: $root.Role_PrintHoaDon()-->
                                                    <div class="btn-group dropdown-mauin">
                                                        <button href="javascript:void(0)" class="btn btn-main btnPrint bor-r" data-bind="click: $parent.InHoaDon">
                                                            <i class="fa fa-print"></i> In
                                                        </button>
                                                        <button class="btn btn-main  dropdown-toggle dropdown-toggle-split" role="button" data-toggle="dropdown">
                                                            <span class="caret"></span>
                                                        </button>
                                                        <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel" data-bind="foreach:$root.ListTypeMauIn ">
                                                            <li>
                                                                <a data-bind="text:Value, click:function() { $root.PrinDatHang($parent,Key) }"></a>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                    <!--/ko-->
                                                    <!-- ko if: $root.RoleExport_Order()-->
                                                    <button href="javascript:void(0)" class="btn btn-main btnExportDetail" data-bind="click: $parent.ExportExcel_ChiTietPhieuDatHang">
                                                        <i class="fa fa-file-excel-o"></i> Xuất file
                                                    </button>
                                                    <!--/ko-->
                                                    <!-- ko if: $root.Show_BtnCopy()-->
                                                    <button href="javascript:void(0)" class="btn btn-main " data-bind="click: $parent.CopyDatHang">
                                                        <i class="fa fa-cut"></i> Sao chép
                                                    </button>
                                                    <!--/ko-->
                                                    <!-- ko if: $root.RoleDelete_Order() && $root.Enable_NgayLapHD()-->
                                                    <button href="javascript:void(0)" class="btn btn-cancel "
                                                            data-bind="click: $root.HuyHoaDon_updateChoThanhToan, visible: YeuCau !=='4'">
                                                        <i class="fa fa-close"></i> Hủy bỏ
                                                    </button>
                                                    <!--/ko-->
                                                </div>
                                            </div>
                                        </div>
                                        <div class="tab-pane tab-content-next" data-bind="attr:{id:'his_'+ ID}">
                                            <div class="table-res">
                                                <table class='table'>
                                                    <tr>
                                                        <th>Mã hóa đơn</th>
                                                        <th>Thời gian</th>
                                                        <th>Người tạo</th>
                                                        <th>Giá trị</th>
                                                        <th>Trạng thái</th>
                                                    </tr>
                                                    <tbody data-bind="foreach: $parent.LichSuTraHang">
                                                        <tr>
                                                            <td>
                                                                <a href="javascript:void(0)"
                                                                   data-bind="text: MaHoaDon, click: function(){ $root.ShowPopup_InforHD_PhieuThu($data, $parent)}"></a>
                                                            </td>
                                                            <td data-bind="text: moment(NgayLapHoaDon).format('DD/MM/YYYY HH:mm')!='Invalid date'? moment(NgayLapHoaDon).format('DD/MM/YYYY HH:mm'):''"></td>
                                                            <td data-bind="text: TenNhanVien"></td>
                                                            <td data-bind="text: formatNumber3Digit(TongTienHang,2)"></td>
                                                            <td data-bind="text: TrangThai"></td>
                                                        </tr>
                                                    </tbody>
                                                    <tfoot data-bind="visible: $parent.LichSuTraHang().length == 0">
                                                        <tr>
                                                            <td colspan="5">
                                                                <div class="bg-warning padding-10 text-center">
                                                                    <i>Không có dữ liệu</i>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    </tfoot>
                                                </table>
                                            </div>
                                        </div>
                                        <div class="tab-pane" data-bind="attr:{id:'hisTT_'+ ID}">
                                            <div class="table-res">
                                                <table class="table table-detal">
                                                    <thead>
                                                        <tr>
                                                            <th>Mã phiếu</th>
                                                            <th>Thời gian</th>
                                                            <th>Người tạo</th>
                                                            <th>Phương thức</th>
                                                            <th>Trạng thái</th>
                                                            <th>Tiền thu</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody data-bind="foreach: $parent.LichSuThanhToanDH">
                                                        <tr>
                                                            <td>
                                                                <a href="javascript:void(0)" class="blue"
                                                                   data-bind="text: MaHoaDon, click: function(){ $root.ShowPopup_InforHD_PhieuThu($data, $parent)}"></a>
                                                            </td>
                                                            <td data-bind="text: moment(NgayLapHoaDon).format('DD/MM/YYYY HH:mm')!='Invalid date'? moment(NgayLapHoaDon).format('DD/MM/YYYY HH:mm'):''"></td>
                                                            <td data-bind="text: NguoiTao"></td>
                                                            <td data-bind="text: PhuongThucTT"></td>
                                                            <td data-bind="text: TrangThai==false?'Đã hủy':'Đã thanh toán'"></td>
                                                            <td data-bind="text: formatNumber3Digit(TongTienThu,2)"></td>
                                                        </tr>
                                                    </tbody>
                                                    <tfoot data-bind="visible: $parent.LichSuThanhToanDH().length == 0">
                                                        <tr>
                                                            <td colspan="6">
                                                                <div class="bg-warning padding-10 text-center">
                                                                    <i>Không có dữ liệu</i>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    </tfoot>
                                                </table>
                                                <!--ko if: $root.Show_BtnThanhToanCongNo-->
                                                <div class=" op-object-detail-function btnThanhToan">
                                                    <button class="btn btn-main"
                                                            data-bind="click: $parent.showPopThanhToan">
                                                        <i class="fa fa-calculator"></i>&nbsp; Thanh toán
                                                    </button>
                                                </div>
                                                <!--/ko-->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        </tr>
                    </tbody>
                    <tfoot data-bind="visible: HoaDons().length > 0">
                        <tr class="border-bottom">
                            <td class="bg12 bold @commonEnum.ColumnOrders.madathang">Tổng cộng</td>
                            <td class="bg12 @commonEnum.ColumnOrders.ngaylaphoadon"></td>
                            <!--ko if: $root.LoaiHoaDonMenu() === 1 -->
                            <td class="bg12 @commonEnum.ColumnOrders.maphieutiepnhan"></td>
                            <td class="bg12 @commonEnum.ColumnOrders.bienso "></td>
                            <!--/ko-->
                            <td class="bg12 @commonEnum.ColumnOrders.makhachhang "></td>
                            <td class="bg12 @commonEnum.ColumnOrders.tenkhachhang"></td>
                            <td class="bg12 @commonEnum.ColumnOrders.sodienthoai "></td>
                            <td class="bg12 @commonEnum.ColumnOrders.diachi "></td>
                            <td class="bg12 @commonEnum.ColumnOrders.khuvuc "></td>
                            <td class="bg12 @commonEnum.ColumnOrders.tenchinhanh "></td>
                            <td class="bg12 @commonEnum.ColumnOrders.nguoiban "></td>
                            <td class="bg12 @commonEnum.ColumnOrders.nguoitao "></td>
                            <td class="bg12 @commonEnum.ColumnOrders.tongtienhang bold text-right" data-bind="text: formatNumber3Digit(TongTienHang(),2)"></td>
                            <td class="bg12 @commonEnum.ColumnInvoices.tienthue bold text-right" data-bind="text: formatNumber3Digit(TongTienThue(),2)"></td>
                            <td class="bg12 @commonEnum.ColumnOrders.tonggiamgia bold text-right" data-bind="text: formatNumber3Digit(TongGiamGia(),2)"></td>
                            <td class="bg12 @commonEnum.ColumnInvoices.tongchiphi bold text-right" data-bind="text: formatNumber3Digit(TongChiPhi(),2)"></td>
                            <td class="bg12 @commonEnum.ColumnOrders.khachcantra bold text-right" data-bind="text: formatNumber3Digit(TongThanhToan(),2)"></td>
                            <td class="bg12 @commonEnum.ColumnOrders.khachdatra bold text-right" data-bind="text: formatNumber3Digit(TongKhachTra(),2)"></td>
                            <td class="bg12 @commonEnum.ColumnOrders.ghichu "></td>
                            <td class="bg12 @commonEnum.ColumnOrders.trangthai"></td>
                        </tr>
                    </tfoot>
                    <tfoot class="Report_Empty" data-bind="visible: HoaDons().length === 0">
                        <tr class="text-center">
                            <td colspan="22">
                                <i>Không có dữ liệu</i>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <div class="page">
                <div class="flex flex-row">
                    <label>Số bản ghi:</label>
                    <select id="SelecttedPage" class="form-control seleted-page" data-bind="value: pageSize,
                                                options: pageSizes, event: {change: ResetCurrentPage}"></select>
                </div>
                <div class="flex flex-end">
                    <a href="javascript:void(0)" data-bind="click: $root.StartPage, visible: VisibleStartPage"><i class="fa fa-step-backward" aria-hidden="true"></i></a>
                    <a href="javascript:void(0)" data-bind="click: $root.BackPage, visible: VisibleStartPage "><i class="fa fa-caret-left" aria-hidden="true"></i></a>
                    <ul data-bind="foreach: PageList_Display">
                        <li>
                            <a href="javascript:void(0)" data-bind="text: pageNumber, click: $root.GoToPageHD, css: $root.GetClassHD($data)"></a>
                        </li>
                    </ul>
                    <a href="javascript:void(0)" data-bind="click: $root.GoToNextPage, visible: VisibleEndPage "><i class="fa fa-caret-right" aria-hidden="true"></i></a>
                    <a href="javascript:void(0)" data-bind="click: $root.EndPage, visible: VisibleEndPage "><i class="fa fa-step-forward" aria-hidden="true"></i></a>
                    <div class="total-recos">
                        Hiển thị <span data-bind="text: fromitem"></span> - <span data-bind="text: toitem"></span> trên tổng số
                        <span data-bind="text: TotalRecord"></span> hóa đơn.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="~/Scripts/Components/Input.js"></script>
<script src="~/Scripts/Components/NhanVien_KhachHang.js"></script>
@Html.Partial("~/Views/Gara/HoaDon/_ThuTienHoaDon.cshtml")
@Html.Partial("~/Views/Gara/HoaDon/_EditHoaHongHD.cshtml")
@Html.Partial("~/Views/Gara/HoaDon/_ThongTinHoaDon.cshtml")
@Html.Partial("~/Views/Gara/HoaDon/_ThanhPhanCombo.cshtml")

<div class="modal " id="modalPopuplgDelete">
    <div class="modal-dialog draggable modal-sm">
        @Html.Action("_modalDelete", new { area = "", Controller = "GiaoDich" })
    </div>
</div>
<script>
    var dathangTeamplate = '@commonEnum.MauInTeamPlates.DatHang';
    var funcName = '@RoleKey.DatHang';
    var w = $(window).width();
    var $table = '#tb';
    $(".op-filter-containertop ul li").css("display", "none");
    $(".op-filter-containertop ul li").eq(0).css("display", "block");
    $(".op-filter-containertop ul li").eq(1).css("display", "block");
    $(document).on('click', '.open-li', function () {
        $(".op-filter-containertop ul li").css("display", "block");
        $(this).toggle();
        $(this).next(".close-li").toggle();
    });
    $(document).on('click', '.close-li', function () {
        $(".op-filter-containertop ul li").css("display", "none");
        $(this).toggle();
        $(this).prev(".open-li").toggle();
        $(".op-filter-container ul li").eq(0).css("display", "block");
        $(".op-filter-container ul li").eq(1).css("display", "block");
    });
    var heigth = 0;
    var heightold = 0;
    var setTop = 0;
    function LoadGetHeight() {
        sleep(100).then(() => { setHeight(); });
    };
    function setHeight() {
        heigth = heigth - heightold;
        $('#tb tr').each(function () {
            if ($(this).hasClass('ac')) {
                heightold = $(this).height();
            }
        });
        heigth += heightold;
        $('.line-right').css("margin-top", setTop + "px").height(heigth);
    }
    function SetHeightShowDetail($this) {
        setTop = 35 + parseInt($this.height() * ($this.index() / 2));
        var t = $this.next(".op-js-tr-hide").css("display");
        if (t !== "none") {
            heightold = $this.next().height();
            heigth = parseInt($this.height()) + heightold;
            $('.line-right').height(heigth).css("margin-top", setTop + "px");
        }
    }
    $($table).on('click', '.prev-tr-hide', function () {
        setTop = 35 + parseInt($(this).height() * ($(this).index() / 2));
        $(this).parents(".table-reponsive").toggleClass("table_re");
        var t = $(this).next(".op-js-tr-hide").css("display");
        $(".prev-tr-hide td").not($(this).find("td")).removeClass("bor");
        $("td").not($(this).find("td")).removeClass("bg-gray");
        $(".prev-tr-hide").not($(this)).removeClass("bor-right");
        $(this).toggleClass("bor-right");
        $(this).find("td").toggleClass("bg-gray");
        $(this).find("td").toggleClass("bor");
        if (t == "none") {
            if (parseInt($('#SelecttedPage').val()) >= 20) {
                $(".table-reponsive").addClass('height470');
            }
            $(".op-js-tr-hide").removeClass("ac");
            $('.line-right').height(0).css("margin-top", "0px");
        }
        else {
            if (parseInt($('#SelecttedPage').val()) >= 20) {
                $(".table-reponsive").removeClass('height470');
            }
            $(".op-js-tr-hide").removeClass("ac");
            $(this).next(".op-js-tr-hide").addClass("ac");
            heightold = $(this).next().height();
            heigth = parseInt($(this).height()) + heightold;
            $('.line-right').height(heigth).css("margin-top", setTop + "px");
        }
    });
    $(function () {
        $('.datetimepicker4').datetimepicker({
            format: 'DD/MM/YYYY',
        });
    });
    $(document).on('click', '.choose-date .dropdown-menu ul li', function () {
        var date = $(this).find("a").html();
        $(".choose-date-show").val(date);
    });
    $(window.document).on('shown.bs.modal', '.modal', function () {
        window.setTimeout(function () {
            $('[autofocus]', this).focus();
            $('[autofocus]').select();
        }.bind(this), 100);
    });
    jQuery.datetimepicker.setLocale('vi');
</script>
<script>
    var loaiHoaDon = 3;
    $('#tb').on('click', '.icon-filter', function () {
        $(this).hide();
        $(this).closest('th').find('.icon-filter2').show();
        $(this).closest('th').next().toggle();
        if ($(window).width() <= 1024) {
            $(this).closest('th').find('.right-inner-addon input').attr("placeholder", "Tìm kiếm hàng hóa");
        }
        else { $(this).closest('th').find('.right-inner-addon input').attr('placeholder', 'Tìm kiếm chi tiết hàng hóa'); }
        if ($(this).closest('th').find('.right-inner-addon').css('display') === 'none') {
            $(this).closest('th').attr('colspan', 2).addClass('actioveFilter');
        }
        else {
            $(this).closest('th').attr('colspan', 1).removeClass('actioveFilter');
        }
        $(this).closest('th').find('.right-inner-addon').toggle();
    });
    $('#tb').on('click', ' .icon-filter2', function () {
        $(this).hide();
        $(this).closest('th').find('.icon-filter').show();
        $(this).closest('th').next().toggle();
        if ($(this).closest('th').find('.right-inner-addon').css('display') === 'none') {
            $(this).closest('th').attr('colspan', 2).addClass('actioveFilter');
        }
        else {
            $(this).closest('th').attr('colspan', 1).removeClass('actioveFilter');
        }
        $(this).closest('th').find('.right-inner-addon').toggle();
    });
</script>
<script src="@Html.WriteRenderFile(Scripts.Url("~/bundles/GiaoDichBan_Dat_Tra"))" type="text/javascript"></script>
<script>
    expand_sts = window.localStorage;
    $("#shownhapxuat").click(function () {
        if ($((".btnExport")).hasClass("forcehide")) {
            expand_import();
        } else {
            hide_import();
        }
    });
    if (localStorage.getItem("expand_sts") == "open") {
        expand_import();
    } else {
        hide_import();
    }
    function expand_import() {
        if ($("html").width() > 425) {
            $(".btnImport").removeClass("forcehide");
            $((".btnExport")).removeClass("forcehide");
            localStorage.setItem("expand_sts", "open");
        }
    };
    function hide_import() {
        if ($("html").width() > 425) {
            $(".btnImport").addClass("forcehide");
            $((".btnExport")).addClass("forcehide");
            localStorage.setItem("expand_sts", "close");
        }
    };
</script>
