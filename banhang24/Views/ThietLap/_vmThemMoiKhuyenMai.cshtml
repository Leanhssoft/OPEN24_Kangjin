<style>
    .jsSearchProduct {
        width: 100%;
    }

    #vmThemMoiKhuyenMai .dropdown-menu li {
        padding: 3px 8px;
        border-bottom: 1px solid #ccc
    }

    #vmThemMoiKhuyenMai .border-bottom {
        border-bottom: 1px solid #ccc
    }

    #vmThemMoiKhuyenMai .lbl-product {
        padding-top: 12px;
    }

        #vmThemMoiKhuyenMai .lbl-product .fontweight600 {
            font-weight: 600
        }
</style>

<div id="vmThemMoiKhuyenMai" class="modal fade">
    <div class="modal-dialog draggable modal-lg">
        <div class="modal-content ">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><i class="material-icons">close</i></button>
                <h4 class="modal-title">
                    {{typeUpdate===1?'Thêm mới':'Cập nhật'}} chương trình khuyến mại
                </h4>
            </div>
            <div class="modal-body ">
                <div class="col-lg-12 nopadding">
                    <div class="col-lg-6">
                        <div class="form-group row">
                            <label class="col-lg-5 nopadding-right">Mã chương trình</label>
                            <div class="col-lg-7">
                                <input class="form-control" type="text" title="Mã chương trình" v-model="objKhuyenMai.MaKhuyenMai" />
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-lg-5 nopadding-right">Tên chương trình</label>
                            <div class="col-lg-7">
                                <input class="form-control" type="text" title="Tên chương trình" v-model="objKhuyenMai.TenKhuyenMai" />
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="form-group row">
                            <label class="col-lg-2">Trạng thái</label>
                            <div class="col-lg-10">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" id="inlineRadio1" value="1" v-model="objKhuyenMai.TrangThai">
                                    <label class="form-check-label" for="inlineRadio1">Kích hoạt</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" id="inlineRadio2" value="0" v-model="objKhuyenMai.TrangThai">
                                    <label class="form-check-label" for="inlineRadio2">Chưa áp dụng</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-lg-2">Ghi chú</label>
                            <div class="col-lg-10">
                                <input class="form-control" type="text" title="Ghi chú" v-model="objKhuyenMai.GhiChu" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-12" style="padding-top:16px;">
                    <ul class="nav nav-tabs" role="tablist">
                        <li role="tab" class="nav-item active">
                            <a href="#hinhthucKhuyenMai" data-toggle="tab">Hình thức khuyến mại</a>
                        </li>
                        <li role="tab" class="nav-item">
                            <a href="#thoigianApDung" data-toggle="tab">Thời gian áp dụng</a>
                        </li>
                        <li role="tab" class="nav-item">
                            <a href="#phamviApDung" data-toggle="tab">Phạm vi áp dụng</a>
                        </li>
                    </ul>

                    <div class="tab-content" style="padding-top:16px">
                        <div id="hinhthucKhuyenMai" class="tab-pane active">
                            <div class="col-lg-12">
                                <div class="col-lg-5 col-md-5">
                                    <label class="col-lg-5 nopadding">Khuyến mại theo</label>
                                    <div class="col-lg-7 col-md-7">
                                        <loai-khuyen-mai placeholder="Chọn"
                                                         :text-search="objKhuyenMai.TxtLoaiKhuyenMai"
                                                         :list-all="ArrLoaiKhuyenMai"
                                                         :list-search="ArrLoaiKhuyenMai"
                                                         :id-chosing="objKhuyenMai.LoaiKhuyenMai"
                                                         v-on:on-select-item="ChangeLoaiKhuyenMai">
                                        </loai-khuyen-mai>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-6">
                                    <label class="col-lg-3 col-md-3">Hình thức</label>
                                    <div class="col-lg-9 col-md-9">
                                        <hinh-thuc-khuyen-mai placeholder="Chọn"
                                                              :text-search="objKhuyenMai.TxtHinhThuc"
                                                              :list-all="ArrHinhThucKhuyenMai.filter(x=>x.ID.toString().indexOf(objKhuyenMai.LoaiKhuyenMai) == 0)"
                                                              :list-search="ArrHinhThucKhuyenMai.filter(x=>x.ID.toString().indexOf(objKhuyenMai.LoaiKhuyenMai) == 0)"
                                                              :id-chosing="objKhuyenMai.HinhThuc"
                                                              v-on:on-select-item="ChangeHinhThucKM">
                                        </hinh-thuc-khuyen-mai>
                                    </div>
                                </div>
                            </div>

                            @*các hình thức khuyến mại*@
                            <div style="margin-top:24px">
                                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12" style="box-shadow: 1px 2px 9px 2px #cccc;padding:16px;margin-top:24px;">

                                    @*hoa don*@
                                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12" v-if="objKhuyenMai.HinhThuc == commonStatisJs.HinhThucKhuyenMai.HD_GIAM_GIAHD">
                                        <div class="col-lg-12 flex flex-row col-md-12 col-sm-12 col-xs-12" style="background-color: #dcdceb; height: 30px; align-items: center">
                                            <label class="col-lg-4">Tổng tiền hàng</label>
                                            <label class="col-lg-4">Giảm giá</label>
                                        </div>

                                        <div class="col-lg-12 flex flex-row nopadding-right nopadding-left  col-md-12 col-sm-12 col-xs-12" style="margin-top: 16px; align-items:center"
                                             v-for="(ctkm, index) in chitietKM">
                                            <div class="col-lg-4 flex flex-row nopadding-left">
                                                <label>Từ</label>
                                                <input class="form-control" style="margin-left:16px" title="Tồng tiền hàng từ"
                                                       v-model="ctkm.TongTienHang"
                                                       v-on:keyup="EditTongTienHang(ctkm,index)" />
                                            </div>
                                            <div class="col-lg-3 flex">
                                                <input class="form-control" title="Giá trị giảm giá"
                                                       v-model="ctkm.GiamGia"
                                                       v-on:keyup="EditGiamGia(ctkm,index)" />
                                            </div>
                                            <div class="col-lg-2 flex">
                                                <div class="toggle" v-on:click="ChangePtramVND(ctkm,index)"
                                                     v-bind:class="[ctkm.GiamGiaTheoPhanTram ? 'active-re' : '']">
                                                    <div class="toggle-line"></div>
                                                    <span class="toggle-element">VNĐ</span>
                                                    <span class="toggle-element toggle-element-percent selected">%</span>
                                                </div>
                                            </div>
                                            <div class="col-lg-3 flex flex-end nopading-right">
                                                <a href="javascript:void(0)" class="btn-gray" title="Xóa" v-on:click="RemoveChiTietKM (ctkm,index)">
                                                    <i class="material-icons" style="color:#B60201;">close</i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>

                                    @*hóa đơn - tặng hàng*@
                                    <div class="col-lg-12" v-if="objKhuyenMai.HinhThuc == commonStatisJs.HinhThucKhuyenMai.HD_TANG_HANG">
                                        <div class="col-lg-12 flex flex-row" style="background-color: #dcdceb; height: 30px; align-items: center">
                                            <label class="col-lg-3">Tổng tiền hàng</label>
                                            <label class="col-lg-2">SL tặng</label>
                                            <label class="col-lg-6">Tặng hàng/ Nhóm hàng</label>
                                        </div>

                                        <div class="col-lg-12 flex flex-row nopadding-right nopadding-left" style="margin-top: 16px;"
                                             v-for="(ctkm, index) in chitietKM">
                                            <div class="col-lg-3 flex flex-row nopadding-left">
                                                <label>Từ</label>
                                                <input class="form-control" style="margin-left:16px" title="Tồng tiền hàng từ"
                                                       v-model="ctkm.TongTienHang"
                                                       v-on:keyup="EditTongTienHang(ctkm,index)" />
                                            </div>
                                            <div class="col-lg-2 flex">
                                                <input class="form-control" title="Số lượng tặng"
                                                       v-model="ctkm.SoLuong"
                                                       v-on:keyup="EditSoLuongTang(ctkm,index)" />
                                            </div>
                                            <div class="col-lg-6 flex flex-column"
                                                 v-on:click="SetIndexChosing(index)">
                                                <products :id-chi-nhanh="inforLogin.ID_DonVi"
                                                          :role-add="true"
                                                          v-on:chose-product="ChoseHangTang"
                                                          v-on:show-modal="showModalNhomHang(index,false)">
                                                </products>
                                                <div v-if="ctkm.ID_DonViQuiDoi!=null"
                                                     v-bind:class="[ctkm.ID_DonViQuiDoi!=null?'lbl-product':'']">
                                                    <span>Sản phẩm:</span>
                                                    <span class="fontweight600"> {{ctkm.TenHangHoaTang}}</span>

                                                </div>
                                                <div v-if="ctkm.ID_NhomHangHoa!=null"
                                                     v-bind:class="[ctkm.ID_NhomHangHoa!=null?'lbl-product':'']">
                                                    <span>
                                                        Nhóm hàng:
                                                    </span>
                                                    <span class="fontweight600">
                                                        {{ctkm.TenNhomHangHoaTang}}
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="col-lg-1 flex flex-end nopading-right">
                                                <a href="javascript:void(0)" class="btn-gray" title="Xóa" v-on:click="RemoveChiTietKM (ctkm,index)">
                                                    <i class="material-icons" style="color:#B60201;">close</i>
                                                </a>
                                            </div>
                                        </div>


                                    </div>

                                    @*hóa đơn - giảm giá hàng*@
                                    <div class="col-lg-12" v-if="objKhuyenMai.HinhThuc == commonStatisJs.HinhThucKhuyenMai.HD_GIAM_GIA_HANG">
                                        <div class="col-lg-12 flex flex-row" style="background-color: #dcdceb; height: 30px; align-items: center">
                                            <label class="col-lg-3">Tổng tiền hàng</label>
                                            <label class="col-lg-2">Giảm giá</label>
                                            <label class="col-lg-7">Hàng/ Nhóm hàng được giảm giá</label>
                                        </div>

                                        <div class="col-lg-12 flex flex-row nopadding-right nopadding-left" style="margin-top: 16px;"
                                             v-for="(ctkm, index) in chitietKM">
                                            <div class="col-lg-3 flex flex-row nopadding-left">
                                                <label>Từ</label>
                                                <input class="form-control" style="margin-left:16px" title="Tồng tiền hàng từ"
                                                       v-model="ctkm.TongTienHang"
                                                       v-on:keyup="EditTongTienHang(ctkm,index)" />
                                            </div>
                                            <div class="col-lg-2 flex flex-row nopadding">
                                                <input class="form-control" title="Giá trị giảm giá"
                                                       v-model="ctkm.GiamGia"
                                                       v-on:keyup="EditGiamGia(ctkm,index)" />
                                                <div class="toggle" v-on:click="ChangePtramVND(ctkm,index)"
                                                     v-bind:class="[ctkm.GiamGiaTheoPhanTram ? 'active-re' : '']">
                                                    <div class="toggle-line"></div>
                                                    <span class="toggle-element">VNĐ</span>
                                                    <span class="toggle-element toggle-element-percent selected">%</span>
                                                </div>
                                            </div>
                                            <div class="col-lg-7 flex flex-row nopadding">
                                                <div class="col-lg-2">
                                                    <input class="form-control" title="Số lượng được giảm" placeholder="SL" v-model="ctkm.SoLuong" />
                                                </div>
                                                <div class="col-lg-7 nopadding" v-on:click="SetIndexChosing(index)">
                                                    <products :id-chi-nhanh="inforLogin.ID_DonVi"
                                                              :role-add="true"
                                                              v-on:chose-product="ChoseHangTang"
                                                              v-on:show-modal="showModalNhomHang(index,false)">
                                                    </products>
                                                    <div v-if="ctkm.ID_DonViQuiDoi!=null"
                                                         v-bind:class="[ctkm.ID_DonViQuiDoi!=null?'lbl-product':'']">
                                                        <span>Sản phẩm:</span>
                                                        <span class="fontweight600"> {{ctkm.TenHangHoaTang}}</span>

                                                    </div>
                                                    <div v-if="ctkm.ID_NhomHangHoa!=null"
                                                         v-bind:class="[ctkm.ID_NhomHangHoa!=null?'lbl-product':'']">
                                                        <span>
                                                            Nhóm hàng:
                                                        </span>
                                                        <span class="fontweight600">
                                                            {{ctkm.TenNhomHangHoaTang}}
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="col-lg-1 flex flex-end nopading-right">
                                                    <a href="javascript:void(0)" class="btn-gray" title="Xóa" v-on:click="RemoveChiTietKM (ctkm,index)">
                                                        <i class="material-icons" style="color:#B60201;">close</i>
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    @*hóa đơn - tặng điểm*@
                                    <div class="col-lg-12" v-if="objKhuyenMai.HinhThuc == commonStatisJs.HinhThucKhuyenMai.HD_TANG_DIEM">
                                        <div class="col-lg-12 flex flex-row" style="background-color: #dcdceb; height: 30px; align-items: center">
                                            <label class="col-lg-4">Tổng tiền hàng</label>
                                            <label class="col-lg-4">Điểm cộng</label>
                                        </div>

                                        <div class="col-lg-12 flex flex-row nopadding-right nopadding-left" style="margin-top: 16px; align-items:center"
                                             v-for="(ctkm, index) in chitietKM">
                                            <div class="col-lg-4 flex flex-row nopadding-left">
                                                <label>Từ</label>
                                                <input class="form-control" style="margin-left:16px" title="Tồng tiền hàng từ"
                                                       v-model="ctkm.TongTienHang"
                                                       v-on:keyup="EditTongTienHang(ctkm,index)" />
                                            </div>
                                            <div class="col-lg-3 flex">
                                                <input class="form-control" title="Số điểm được cộng"
                                                       v-model="ctkm.GiamGia"
                                                       v-on:keyup="EditGiamGia(ctkm,index)" />
                                            </div>
                                            <div class="col-lg-2 flex">
                                                <div class="toggle" v-on:click="ChangePtramVND(ctkm,index)"
                                                     v-bind:class="[ctkm.GiamGiaTheoPhanTram ? 'active-re' : '']">
                                                    <div class="toggle-line"></div>
                                                    <span class="toggle-element">VNĐ</span>
                                                    <span class="toggle-element toggle-element-percent selected">%</span>
                                                </div>
                                            </div>
                                            <div class="col-lg-3 flex flex-end nopading-right">
                                                <a href="javascript:void(0)" class="btn-gray" title="Xóa" v-on:click="RemoveChiTietKM (ctkm,index)">
                                                    <i class="material-icons" style="color:#B60201;">close</i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>

                                    @*hàng hóa*@
                                    <div class="col-lg-12" v-if="objKhuyenMai.HinhThuc == commonStatisJs.HinhThucKhuyenMai.HH_GIAM_GIA_HANG">
                                        <div class="col-lg-12 flex flex-row" style="background-color: #dcdceb; height: 30px; align-items: center">
                                            <label class="col-lg-5">Hàng/ Nhóm hàng mua</label>
                                            <label class="col-lg-2">Giảm giá</label>
                                            <label class="col-lg-5">Hàng/ Nhóm hàng được giảm giá</label>
                                        </div>

                                        <div class="col-lg-12 flex flex-row nopadding-right no-padding-left" style="margin-top: 16px;"
                                             v-for="(ctkm, index) in chitietKM">
                                            <div class="col-lg-5 flex flex-row nopadding-left">
                                                <div class="col-lg-3 nopadding-left">
                                                    <input class="form-control" title="Số lượng hàng mua" placeholder="SL"
                                                           v-model="ctkm.SoLuongMua"
                                                           v-on:keyup="EditSoLuongMua(ctkm,index)" />
                                                </div>
                                                <div class="col-lg-9 nopadding" v-on:click="SetIndexChosing(index)">
                                                    <products :id-chi-nhanh="inforLogin.ID_DonVi"
                                                              :role-add="true"
                                                              v-on:chose-product="ChoseHangMua"
                                                              v-on:show-modal="showModalNhomHang(index,true)">
                                                    </products>
                                                    <div v-if="ctkm.ID_DonViQuiDoiMua!=null"
                                                         v-bind:class="[ctkm.ID_DonViQuiDoiMua!=null?'lbl-product':'']">
                                                        <span>Sản phẩm:</span>
                                                        <span class="fontweight600"> {{ctkm.TenHangHoaMua}}</span>

                                                    </div>
                                                    <div v-if="ctkm.ID_NhomHangHoaMua!=null"
                                                         v-bind:class="[ctkm.ID_NhomHangHoaMua!=null?'lbl-product':'']">
                                                        <span>
                                                            Nhóm hàng:
                                                        </span>
                                                        <span class="fontweight600">
                                                            {{ctkm.TenNhomHangHoaMua}}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-lg-2 flex flex-row nopadding">
                                                <input class="form-control" placeholder="Giá trị"
                                                       v-model="ctkm.GiamGia"
                                                       v-on:keyup="EditGiamGia(ctkm,index)" />
                                                <div class="toggle" v-on:click="ChangePtramVND(ctkm,index)"
                                                     v-bind:class="[ctkm.GiamGiaTheoPhanTram ? 'active-re' : '']">
                                                    <div class="toggle-line"></div>
                                                    <span class="toggle-element">VNĐ</span>
                                                    <span class="toggle-element toggle-element-percent selected">%</span>
                                                </div>
                                            </div>
                                            <div class="col-lg-5 flex flex-row nopadding">
                                                <div class="col-lg-3">
                                                    <input class="form-control" title="Số lượng hàng được giảm giá" placeholder="SL"
                                                           v-model="ctkm.SoLuong"
                                                           v-on:keyup="EditSoLuongTang(ctkm,index)" />
                                                </div>
                                                <div class="col-lg-8 nopadding" v-on:click="SetIndexChosing(index)">
                                                    <products :id-chi-nhanh="inforLogin.ID_DonVi"
                                                              :role-add="true"
                                                              v-on:chose-product="ChoseHangTang"
                                                              v-on:show-modal="showModalNhomHang(index,false)">
                                                    </products>
                                                    <div v-if="ctkm.ID_DonViQuiDoi!=null"
                                                         v-bind:class="[ctkm.ID_DonViQuiDoi!=null?'lbl-product':'']">
                                                        <span>Sản phẩm:</span>
                                                        <span class="fontweight600"> {{ctkm.TenHangHoaTang}}</span>

                                                    </div>
                                                    <div v-if="ctkm.ID_NhomHangHoa!=null"
                                                         v-bind:class="[ctkm.ID_NhomHangHoa!=null?'lbl-product':'']">
                                                        <span>
                                                            Nhóm hàng:
                                                        </span>
                                                        <span class="fontweight600">
                                                            {{ctkm.TenNhomHangHoaTang}}
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="col-lg-1 flex flex-end nopading-right">
                                                    <a href="javascript:void(0)" class="btn-gray" title="Xóa" v-on:click="RemoveChiTietKM (ctkm,index)">
                                                        <i class="material-icons" style="color:#B60201;">close</i>
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    @*hàng hóa - tặng hàng*@
                                    <div class="col-lg-12" v-if="objKhuyenMai.HinhThuc == commonStatisJs.HinhThucKhuyenMai.HH_TANG_HANG">
                                        <div class="col-lg-12 flex flex-row" style="background-color: #dcdceb; height: 30px; align-items: center">
                                            <label class="col-lg-6">Hàng/ Nhóm hàng mua</label>
                                            <label class="col-lg-6">Hàng/ Nhóm hàng được tặng</label>
                                        </div>

                                        <div class="col-lg-12 flex flex-row nopadding-right no-padding-left" style="margin-top: 16px"
                                             v-for="(ctkm, index) in chitietKM">

                                            <div class="col-lg-6 flex flex-row nopadding-left">
                                                <div class="col-lg-3 nopadding-left">
                                                    <input class="form-control" title="Số lượng hàng mua" placeholder="SL mua"
                                                           v-model="ctkm.SoLuongMua"
                                                           v-on:keyup="EditSoLuongMua(ctkm,index)" />
                                                </div>
                                                <div class="col-lg-9 nopadding" v-on:click="SetIndexChosing(index)">
                                                    <products :id-chi-nhanh="inforLogin.ID_DonVi"
                                                              :role-add="true"
                                                              v-on:chose-product="ChoseHangMua"
                                                              v-on:show-modal="showModalNhomHang(index,true)">
                                                    </products>
                                                    <div v-if="ctkm.ID_DonViQuiDoiMua!=null"
                                                         v-bind:class="[ctkm.ID_DonViQuiDoiMua!=null?'lbl-product':'']">
                                                        <span>Sản phẩm:</span>
                                                        <span class="fontweight600"> {{ctkm.TenHangHoaMua}}</span>

                                                    </div>
                                                    <div v-if="ctkm.ID_NhomHangHoaMua!=null"
                                                         v-bind:class="[ctkm.ID_NhomHangHoaMua!=null?'lbl-product':'']">
                                                        <span>
                                                            Nhóm hàng:
                                                        </span>
                                                        <span class="fontweight600">
                                                            {{ctkm.TenNhomHangHoaMua}}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-lg-6 flex flex-row nopadding">
                                                <div class="col-lg-3">
                                                    <input class="form-control" title="Số lượng hàng tặng" placeholder="SL tặng"
                                                           v-model="ctkm.SoLuong"
                                                           v-on:keyup="EditSoLuongTang(ctkm,index)" />
                                                </div>
                                                <div class="col-lg-8 nopadding" v-on:click="SetIndexChosing(index)">
                                                    <products :id-chi-nhanh="inforLogin.ID_DonVi"
                                                              :role-add="true"
                                                              v-on:chose-product="ChoseHangTang"
                                                              v-on:show-modal="showModalNhomHang(index,false)">
                                                    </products>
                                                    <div v-if="ctkm.ID_DonViQuiDoi!=null"
                                                         v-bind:class="[ctkm.ID_DonViQuiDoi!=null?'lbl-product':'']">
                                                        <span>Sản phẩm:</span>
                                                        <span class="fontweight600"> {{ctkm.TenHangHoaTang}}</span>

                                                    </div>
                                                    <div v-if="ctkm.ID_NhomHangHoa!=null"
                                                         v-bind:class="[ctkm.ID_NhomHangHoa!=null?'lbl-product':'']">
                                                        <span>
                                                            Nhóm hàng:
                                                        </span>
                                                        <span class="fontweight600">
                                                            {{ctkm.TenNhomHangHoaTang}}
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="col-lg-1 flex flex-end nopading-right">
                                                    <a href="javascript:void(0)" class="btn-gray" title="Xóa" v-on:click="RemoveChiTietKM (ctkm,index)">
                                                        <i class="material-icons" style="color:#B60201;">close</i>
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    @*hàng hóa - tặng điểm*@
                                    <div class="col-lg-12" v-if="objKhuyenMai.HinhThuc == commonStatisJs.HinhThucKhuyenMai.HH_TANG_DIEM">
                                        <div class="col-lg-12 flex flex-row" style="background-color: #dcdceb; height: 30px; align-items: center">
                                            <label class="col-lg-6">Hàng/ Nhóm hàng mua</label>
                                            <label class="col-lg-4">Điểm cộng</label>
                                        </div>

                                        <div class="col-lg-12 flex flex-row nopadding-right no-padding-left" style="margin-top: 16px; align-items:center"
                                             v-for="(ctkm, index) in chitietKM">
                                            <div class="col-lg-6 flex flex-row nopadding-left">
                                                <div class="col-lg-3 nopadding-left">
                                                    <input class="form-control" title="Số lượng hàng mua" placeholder="SL mua"
                                                           v-model="ctkm.SoLuongMua"
                                                           v-on:keyup="EditSoLuongMua(ctkm,index)" />
                                                </div>
                                                <div class="col-lg-9 nopadding" v-on:click="SetIndexChosing(index)">
                                                    <products :id-chi-nhanh="inforLogin.ID_DonVi"
                                                              :role-add="true"
                                                              v-on:chose-product="ChoseHangMua"
                                                              v-on:show-modal="showModalNhomHang(index,true)">
                                                    </products>
                                                    <div v-if="ctkm.ID_DonViQuiDoiMua!=null"
                                                         v-bind:class="[ctkm.ID_DonViQuiDoiMua!=null?'lbl-product':'']">
                                                        <span>Sản phẩm:</span>
                                                        <span class="fontweight600"> {{ctkm.TenHangHoaMua}}</span>

                                                    </div>
                                                    <div v-if="ctkm.ID_NhomHangHoaMua!=null"
                                                         v-bind:class="[ctkm.ID_NhomHangHoaMua!=null?'lbl-product':'']">
                                                        <span>
                                                            Nhóm hàng:
                                                        </span>
                                                        <span class="fontweight600">
                                                            {{ctkm.TenNhomHangHoaMua}}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-lg-5 flex flex-row nopadding">
                                                <div class="col-lg-4">
                                                    <input class="form-control" title="Giá trị điểm cộng"
                                                           v-model="ctkm.GiamGia"
                                                           v-on:keyup="EditGiamGia(ctkm,index)" />
                                                </div>
                                                <div class="col-lg-8 nopadding">
                                                    <div class="toggle" v-on:click="ChangePtramVND(ctkm,index)"
                                                         v-bind:class="[ctkm.GiamGiaTheoPhanTram ? 'active-re' : '']">
                                                        <div class="toggle-line"></div>
                                                        <span class="toggle-element">VNĐ</span>
                                                        <span class="toggle-element toggle-element-percent selected">%</span>
                                                    </div>
                                                </div>

                                            </div>
                                            <div class="col-lg-1 flex flex-end nopading-right">
                                                <a href="javascript:void(0)" class="btn-gray" title="Xóa" v-on:click="RemoveChiTietKM (ctkm,index)">
                                                    <i class="material-icons" style="color:#B60201;">close</i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>

                                    @*hàng hóa - giá bán theo số lượng mua*@
                                    <div class="col-lg-12" v-if="objKhuyenMai.HinhThuc == commonStatisJs.HinhThucKhuyenMai.HH_GIA_BAN_THEO_SO_LUONG">

                                        <div class="col-lg-12 nopadding-left nopadding-right"
                                             v-bind:class="[index < chitietKM.length -1 ? 'border-bottom' : '']"
                                             style="align-items:center;padding-bottom:12px; padding-top:16px"
                                             v-for="(ctkm,index) in chitietKM">
                                            <div class="col-lg-2">
                                                <label>Khi mua</label>
                                            </div>
                                            <div class="col-lg-10">
                                                <div class="col-lg-12 nopadding">
                                                    <div class="col-lg-8 nopadding"
                                                         v-on:click="SetIndexChosing(index)">
                                                        <products :id-chi-nhanh="inforLogin.ID_DonVi"
                                                                  :role-add="true"
                                                                  v-on:chose-product="ChoseHangMua"
                                                                  v-on:show-modal="showModalNhomHang(index,true)">
                                                        </products>

                                                        <div v-if="ctkm.ID_DonViQuiDoiMua!=null"
                                                             v-bind:class="[ctkm.ID_DonViQuiDoiMua!=null?'lbl-product':'']">
                                                            <span>Sản phẩm:</span>
                                                            <span class="fontweight600"> {{ctkm.TenHangHoaMua}}</span>

                                                        </div>
                                                        <div v-if="ctkm.ID_NhomHangHoaMua!=null"
                                                             v-bind:class="[ctkm.ID_NhomHangHoaMua!=null?'lbl-product':'']">
                                                            <span>
                                                                Nhóm hàng:
                                                            </span>
                                                            <span class="fontweight600">
                                                                {{ctkm.TenNhomHangHoaMua}}
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-2">
                                                        <a href="javascript:void(0)" class="btn-gray" title="Xóa"
                                                           v-on:click="RemoveChiTietKM (ctkm,index)">
                                                            <i class="material-icons" style="color:#B60201;">close</i>
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-lg-10 col-lg-offset-2 nopadding" style="margin-top:24px">
                                                <div class="col-lg-12 nopadding flex flex-row" style="align-items: center; margin-bottom: 12px"
                                                     v-for="(ct,index2) in ctkm.details"
                                                     v-on:click="Loai24_SetIndexChosing(index,index2)">
                                                    <div class="col-lg-5 flex flex-row">
                                                        <label class="col-lg-6 nopadding-left">Số lượng từ</label>
                                                        <div class="col-lg-6 nopadding-left">
                                                            <input class="form-control" title="Số lượng hàng mua" placeholder="SL mua"
                                                                   v-model="ct.SoLuongMua"
                                                                   v-on:keyup="Loai24_EditSoLuongMua(index, index2)" />
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-3">
                                                        <loai-khuyen-mai-24 placeholder="Chọn"
                                                                            :text-search="ct.txtLoaiApDung"
                                                                            :list-all="GiaBanTheoSoLuong_LoaiKM"
                                                                            :list-search="GiaBanTheoSoLuong_LoaiKM"
                                                                            :id-chosing="ct.loaiApDung"
                                                                            v-on:on-select-item="Loai24_ChangeLoaiApDung">
                                                        </loai-khuyen-mai-24>
                                                    </div>
                                                    <div class="col-lg-3 nopadding-left">
                                                        <input class="form-control"
                                                               v-model="ct.GiaKhuyenMai"
                                                               v-on:keyup="Loai24_EditGiaKhuyenMai(index,index2)"
                                                               v-bind:placeholder="ct.loaiApDung == 2?'Giá trị giảm':'Nhập giá bán'"
                                                               v-bind:title="ct.loaiApDung == 2?'Giảm giá':'Giá bán'" />
                                                    </div>
                                                    <div class="col-lg-1 nopadding-left">
                                                        <div class="toggle" v-on:click="Loai24_ChangePtramVND(index, index2)"
                                                             v-if="ct.loaiApDung === 2"
                                                             v-bind:class="[ct.GiamGiaTheoPhanTram ? 'active-re' : '']">
                                                            <div class="toggle-line"></div>
                                                            <span class="toggle-element">VNĐ</span>
                                                            <span class="toggle-element toggle-element-percent selected">%</span>
                                                        </div>
                                                    </div>
                                                    <div class=" flex flex-end nopading-right col-lg-1">
                                                        <a href="javascript:void(0)" class="btn-gray" title="Xóa" v-on:click="Loai24_RemoveDetails (index,index2)">
                                                            <i class="material-icons" style="color:#B60201;">remove</i>
                                                        </a>
                                                    </div>
                                                </div>

                                                <div class="col-lg-4" style="margin-top:16px">
                                                    <a href="javascript:void(0)" class="btn-gray flex flex-row" title="Thêm dòng"
                                                       v-on:click="Loai24_AddDetail(index)">
                                                        <i class="material-icons" style="color:blue;">add</i>
                                                        <label>Thêm dòng</label>
                                                    </a>
                                                </div>
                                            </div>

                                        </div>
                                    </div>

                                </div>
                                <div class="col-lg-12" style="margin-top:24px">
                                    <button type="button" class="btn btn-main" v-on:click="ClickThemDieuKien">
                                        <i class="fa fa-plus"></i>
                                        <span>Thêm điều kiện</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div id="thoigianApDung" class="tab-pane">
                            <div class="col-lg-12 padding-10">
                                <div class="col-lg-2">
                                    <label>Hiệu lực từ ngày</label>
                                </div>
                                <div class="col-lg-9">
                                    <div class="col=lg-12 nopadding">
                                        <div class="col-lg-4 nopadding">
                                            <date-time :date-chose="objKhuyenMai.ThoiGianBatDau" placeholder="Từ ngày"
                                                       :format="TypeFormat"
                                                       v-on:change-date="DateFrom_Change">
                                            </date-time>
                                        </div>
                                        <div class="col-lg-2">
                                            <label>Đến ngày </label>
                                        </div>
                                        <div class="col-lg-4">
                                            <date-time :date-chose="objKhuyenMai.ThoiGianKetThuc" placeholder="Đến ngày"
                                                       :format="TypeFormat"
                                                       v-on:change-date="DateTo_Change">
                                            </date-time>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-12  padding-10">
                                <div class="col-lg-2">
                                    <label>Tháng áp dụng</label>
                                </div>
                                <div class="col-lg-9">
                                    <dropdown-multiple placeholder="Chọn tháng áp dụng"
                                                       :list-all="ArrMonth"
                                                       :list-chosed="objKhuyenMai.arrThangApDung"
                                                       :colshow="1"
                                                       :type-data="6"
                                                       :have-condition="true"
                                                       :show-item-all="true"
                                                       v-on:on-select-item="ChoseMonth">
                                    </dropdown-multiple>
                                </div>

                            </div>
                            <div class="col-lg-12 padding-10">
                                <div class="col-lg-2">
                                    <label>Ngày áp dụng</label>
                                </div>
                                <div class="col-lg-9">
                                    <dropdown-multiple placeholder="Chọn ngày áp dụng"
                                                       :list-all="ArrDay"
                                                       :list-chosed="objKhuyenMai.arrNgayApDung"
                                                       :colshow="1"
                                                       :type-data="6"
                                                       :have-condition="true"
                                                       :show-item-all="true"
                                                       v-on:on-select-item="ChoseDay">
                                    </dropdown-multiple>
                                </div>
                            </div>
                            <div class="col-lg-10 col-lg-offset-2 flex flex-row">
                                <input type="checkbox" value="1" v-model="objKhuyenMai.ApDungNgaySinhNhat" />
                                <label>
                                    Áp dụng vào <a>Ngày sinh nhật</a>
                                </label>
                            </div>
                            <div class="col-lg-12 padding-10">
                                <div class="col-lg-2">
                                    <label>Thứ áp dụng</label>
                                </div>
                                <div class="col-lg-9">
                                    <dropdown-multiple placeholder="Chọn thứ áp dụng"
                                                       :list-all="ArrDate"
                                                       :list-chosed="objKhuyenMai.arrThuApDung"
                                                       :colshow="1"
                                                       :type-data="6"
                                                       :have-condition="true"
                                                       :show-item-all="true"
                                                       v-on:on-select-item="ChoseDate">
                                    </dropdown-multiple>
                                </div>
                            </div>

                            <div class="col-lg-12 padding-10">
                                <div class="col-lg-2">
                                    <label>Giờ áp dụng</label>
                                </div>
                                <div class="col-lg-9">
                                    <dropdown-multiple placeholder="Chọn giờ áp dụng"
                                                       :list-all="ArrHours"
                                                       :list-chosed="objKhuyenMai.arrGioApDung"
                                                       :colshow="1"
                                                       :type-data="6"
                                                       :have-condition="true"
                                                       :show-item-all="true"
                                                       v-on:on-select-item="ChoseHour">
                                    </dropdown-multiple>
                                </div>
                            </div>

                        </div>

                        <div id="phamviApDung" class="tab-pane">
                            <div class="col-lg-12 padding-10">
                                <div class="col-lg-2">
                                    <label>Chi nhánh</label>
                                </div>
                                <div class="col-lg-9">
                                    <dropdown-multiple placeholder="Chọn chi nhánh áp dụng"
                                                       :list-all="listData.AllChiNhanhs"
                                                       :list-chosed="objKhuyenMai.arrChiNhanhApDung"
                                                       :colshow="1"
                                                       :type-data="6"
                                                       :have-condition="true"
                                                       :show-item-all="true"
                                                       v-on:on-select-item="ChoseChiNhanh">
                                    </dropdown-multiple>
                                </div>
                            </div>
                            <div class="col-lg-12 padding-10">
                                <div class="col-lg-2">
                                    <label>Nhân viên bán</label>
                                </div>
                                <div class="col-lg-9">
                                    <dropdown-multiple placeholder="Chọn nhân viên"
                                                       :list-all="listData.AllNhanViens"
                                                       :list-chosed="objKhuyenMai.arrNhanVienApDung"
                                                       :colshow="2"
                                                       :type-data="6"
                                                       :have-condition="true"
                                                       :show-item-all="true"
                                                       v-on:on-select-item="ChoseNhanVien">
                                    </dropdown-multiple>
                                </div>
                            </div>
                            <div class="col-lg-12 padding-10">
                                <div class="col-lg-2">
                                    <label>Nhóm khách</label>
                                </div>
                                <div class="col-lg-9">
                                    <dropdown-multiple placeholder="Chọn nhóm"
                                                       :list-all="listData.AllNhomKhachs"
                                                       :list-chosed="objKhuyenMai.arrNhomKhachApDung"
                                                       :colshow="1"
                                                       :type-data="6"
                                                       :have-condition="true"
                                                       :show-item-all="true"
                                                       v-on:on-select-item="ChoseNhomKhach">
                                    </dropdown-multiple>
                                </div>
                            </div>
                        </div>

                    </div>

                </div>
                <div class="modal-footer">
                    <div class="container-fluid">
                        <button type="button" class="btn btn-cancel" data-dismiss="modal">
                            <i class="fa fa-ban"></i> Bỏ qua
                        </button>
                        <button type="button" class="btn btn-main" v-on:click="SaveData" v-if="!isSaving">
                            <i class="fa fa-save"></i> Lưu
                        </button>
                        <button type="button" class="btn btn-main" v-if="isSaving">
                            <i class="fa fa-save"></i> Đang lưu
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
@Html.Partial("~/Views/HangHoa/_vmChuyenNhomHang.cshtml")

<script>
    var vmThemMoiKhuyenMai = new Vue({
        el: '#vmThemMoiKhuyenMai',
        components: {
            'loai-khuyen-mai': cmpDropdown1Item,
            'hinh-thuc-khuyen-mai': cmpDropdown1Item,
            'loai-khuyen-mai-24': cmpDropdown1Item,
            'dropdown-multiple': cmpDropdownMultipleItem,
            'products': cmpChoseProduct,
            'date-time': cpmDatetime
        },
        created: function () {
            let self = this;
            self.TypeFormat = 'DD/MM/YYYY';
            self.BH_KhuyenMaiAPI = '/api/DanhMuc/BH_KhuyenMaiAPI/';
            self.inforLogin = {
                ID_DonVi: VHeader.IdDonVi
            };
            self.ArrLoaiKhuyenMai = [
                { ID: commonStatisJs.LoaiKhuyenMai.HOA_DON, Text2: 'Hóa đơn' },
                { ID: commonStatisJs.LoaiKhuyenMai.HANG_HOA, Text2: 'Hàng hóa' },
            ];
            self.GiaBanTheoSoLuong_LoaiKM = [
                { ID: 1, Text2: 'Giá bán' },
                { ID: 2, Text2: 'Giảm giá' },
            ];
            self.ArrHinhThucKhuyenMai = [
                { ID: commonStatisJs.HinhThucKhuyenMai.HD_GIAM_GIAHD, Text2: 'Giảm giá hóa đơn' },
                { ID: commonStatisJs.HinhThucKhuyenMai.HD_TANG_HANG, Text2: 'Tặng hàng' },
                { ID: commonStatisJs.HinhThucKhuyenMai.HD_GIAM_GIA_HANG, Text2: 'Giảm giá hàng' },
                { ID: commonStatisJs.HinhThucKhuyenMai.HD_TANG_DIEM, Text2: 'Tặng điểm' },

                { ID: commonStatisJs.HinhThucKhuyenMai.HH_GIAM_GIA_HANG, Text2: 'Mua hàng giảm giá hàng' },
                { ID: commonStatisJs.HinhThucKhuyenMai.HH_TANG_HANG, Text2: 'Mua hàng tặng tặng' },
                { ID: commonStatisJs.HinhThucKhuyenMai.HH_TANG_DIEM, Text2: 'Mua hàng tặng điểm' },
                { ID: commonStatisJs.HinhThucKhuyenMai.HH_GIA_BAN_THEO_SO_LUONG, Text2: 'Giá bán theo số lượng mua' },
            ];

            self.ArrMonth = [];
            self.ArrDay = [];// ngay 1,2,3,..
            self.ArrDate = [];// thu 2,3,4
            self.ArrHours = [];
            self.PageLoad();
        },
        data: {
            typeUpdate: 1,
            saveOK: false,
            isSaving: false,
            indexChosing: -1,
            Loai24_indexChosingDetail: -1,
            isHangMua: true,
            listData: {
                AllChiNhanhs: [],
                AllNhomHangHoas: [],
                AllNhanViens: [],
                AllNhomKhachs: []
            },
            objKhuyenMai: {
                ID: const_GuidEmpty,
                MaKhuyenMai: '',
                TenKhuyenMai: '',
                LoaiKhuyenMai: commonStatisJs.LoaiKhuyenMai.HOA_DON,
                HinhThuc: commonStatisJs.HinhThucKhuyenMai.HD_GIAM_GIAHD,
                ThoiGianBatDau: moment(new Date()).format('YYYY-MM-DD'),
                ThoiGianKetThuc: moment(new Date()).add('years', 1).format('YYYY-MM-DD'),
                NgayApDung: '',
                ThangApDung: '',
                ThuApDung: '',
                GioApDung: '',
                ApDungNgaySinhNhat: 0,
                TatCaDonVi: true,
                TatCaDoiTuong: true,
                TatCaNhanVien: true,
                TrangThai: 1, //1.active,0.no active

                TxtLoaiKhuyenMai: '',
                TxtHinhThuc: '',

                arrThangApDung: [],
                arrNgayApDung: [],
                arrThuApDung: [],
                arrGioApDung: [],
                arrChiNhanhApDung: [],
                arrNhanVienApDung: [],
                arrNhomKhachApDung: [],
            },
            objKhuyenMaiOld: {},
            chitietKM: [],
            chitietKMOld: [],
        },
        methods: {
            PageLoad: async function () {
                let self = this;
                self.InitDefaultData();
                await self.GetListData_fromDB();
            },
            InitDefaultData: function () {
                let self = this;
                self.InitAllMonth();
                self.InitAllDay();
                self.InitAllDate();
                self.InitAllHours();
            },
            InitAllMonth: function () {
                let self = this;
                for (let i = 1; i < 13; i++) {
                    self.ArrMonth.push({ ID: i, Text1: 'Tháng ' + i });
                }
            },
            InitAllDay: function () {
                let self = this;
                for (let i = 1; i < 32; i++) {
                    self.ArrDay.push({ ID: i, Text1: 'Ngày ' + i });
                }
            },
            InitAllDate: function () {
                let self = this;
                for (let i = 2; i < 8; i++) {
                    self.ArrDate.push({ ID: i, Text1: 'Thứ ' + i });
                }
                self.ArrDate.push({ ID: 8, Text1: 'Chủ nhật ' });
            },
            InitAllHours: function () {
                let self = this;
                for (let i = 0; i < 24; i++) {
                    self.ArrHours.push({ ID: i, Text1: i });
                }
            },
            GetTree_NhomHangHoa: async function () {
                const xx = ajaxHelper('/api/DanhMuc/DM_NhomHangHoaAPI/' + "GetTree_NhomHangHoa", 'GET').done(function (xx) {
                }).then(function (xx) {
                    return xx.data;
                });
                return xx;
            },
            GetAllNhanVien: async function () {
                const xx = ajaxHelper('/api/DanhMuc/NS_NhanVienAPI/' + "GetNS_NhanVien_InforBasic?idDonVi=" + VHeader.IdDonVi, 'GET').done(function (xx) {
                }).then(function (data) {
                    return data;
                });
                return xx;
            },
            GetAllNhomKhach: async function () {
                const xx = ajaxHelper('/api/DanhMuc/DM_DoiTuongAPI/' + "GetNhomDoiTuong_DonVi?loaiDT=1", 'GET').done(function (xx) {
                }).then(function (xx) {
                    if (xx.res) {
                        return xx.data;
                    }
                    return [];
                });
                return xx;
            },
            GetListData_fromDB: async function () {
                let self = this;
                const allNhomHang = await self.GetTree_NhomHangHoa();
                const allNhanVien = await self.GetAllNhanVien();
                const allNhomKhach = await self.GetAllNhomKhach();

                self.listData.AllChiNhanhs = VHeader.ListChiNhanh
                    .map(function (x) {
                        return {
                            ID: x.ID,
                            Text1: x.TenDonVi
                        }
                    });

                self.listData.AllNhomKhachs = allNhomKhach.map(function (x) {
                    return {
                        ID: x.ID,
                        Text1: x.TenNhomDoiTuong
                    }
                });

                self.listData.AllNhanViens = allNhanVien.map(function (x) {
                    return {
                        ID: x.ID,
                        Text1: x.MaNhanVien,
                        Text2: x.TenNhanVien
                    }
                });
                self.listData.AllNhomHangHoas = allNhomHang;
            },
            newCTKM: function () {
                return {
                    STT: 0,
                    TongTienHang: '',
                    GiamGia: '', // diemcong, giamgia
                    GiamGiaTheoPhanTram: true,
                    ID_DonViQuiDoiMua: null,
                    ID_NhomHangHoaMua: null,
                    SoLuongMua: '',
                    ID_DonViQuiDoi: null,
                    ID_NhomHangHoa: null,
                    SoLuong: '',
                    GiaKhuyenMai: '',

                    TenHangHoaMua: '',
                    GiaBan_HangMua: 0,
                    TenHangHoaTang: '',
                    GiaBan_HangTang: 0,
                    TenNhomHangHoaMua: '',
                    TenNhomHangHoaTang: '',

                    details: [
                        {
                            STT: 0,
                            SoLuongMua: '',
                            loaiApDung: 1,// 1. giakhuyenmai, 2. giamgia
                            txtLoaiApDung: 'Giá bán',
                            GiaKhuyenMai: '',
                            GiamGia: '',
                            GiamGiaTheoPhanTram: true,
                        }
                    ]
                }
            },
            GetDMKhuyenMai_byId: async function (idKhuyenMai) {
                let self = this;
                const xx = await ajaxHelper(self.BH_KhuyenMaiAPI + "GetDMKhuyenMai_byId?idKhuyenMai=" + idKhuyenMai, "GET")
                    .done().then(function (data) {
                        return data;
                    });
                return xx;
            },

            GetChiTietKhuyenMai_byIdKhuyenMai: async function (idKhuyenMai) {
                let self = this;
                const xx = await ajaxHelper(self.BH_KhuyenMaiAPI + "getChiTiet_KhuyenMai?ID_KhuyenMai=" + idKhuyenMai, "GET")
                    .done().then(function (data) {
                        return data;
                    });
                return xx;
            },
            GetListChiNhanhApDung: async function (idKhuyenMai) {
                let self = this;
                const xx = await ajaxHelper(self.BH_KhuyenMaiAPI + "getLisDonViKM?ID_KhuyenMai=" + idKhuyenMai, "GET")
                    .done().then(function (data) {
                        return data;
                    });
                return xx;
            },

            GetListNhanVienApDung: async function (idKhuyenMai) {
                let self = this;
                const xx = await ajaxHelper(self.BH_KhuyenMaiAPI + "getlistNhanViemKM?ID_KhuyenMai=" + idKhuyenMai, "GET")
                    .done().then(function (data) {
                        return data;
                    });
                return xx;
            },

            GetListNhomKhachApDung: async function (idKhuyenMai) {
                let self = this;
                const xx = await ajaxHelper(self.BH_KhuyenMaiAPI + "getlistNhomHangKM?ID_KhuyenMai=" + idKhuyenMai, "GET")
                    .done().then(function (data) {
                        return data;
                    });
                return xx;
            },

            showModal: async function () {
                let self = this;
                self.typeUpdate = 1;
                self.saveOK = false;
                self.isSaving = false;
                self.chitietKM = [new self.newCTKM()];
                self.objKhuyenMai = {
                    ID: const_GuidEmpty,
                    MaKhuyenMai: '',
                    TenKhuyenMai: '',
                    LoaiKhuyenMai: commonStatisJs.LoaiKhuyenMai.HOA_DON,
                    HinhThuc: commonStatisJs.HinhThucKhuyenMai.HD_GIAM_GIAHD,
                    ThoiGianBatDau: moment(new Date()).format('YYYY-MM-DD'),
                    ThoiGianKetThuc: moment(new Date()).add('years', 1).format('YYYY-MM-DD'),
                    NgayApDung: '',
                    ThangApDung: '',
                    ThuApDung: '',
                    GioApDung: '',
                    ApDungNgaySinhNhat: 0,
                    TatCaDonVi: true,
                    TatCaDoiTuong: true,
                    TatCaNhanVien: true,
                    TrangThai: 1, //1.active,0.no active
                    NguoiTao: VHeader.UserLogin,

                    TxtLoaiKhuyenMai: 'Hóa đơn',
                    TxtHinhThuc: 'Giảm giá hóa đơn',

                    arrThangApDung: [],
                    arrNgayApDung: [],
                    arrThuApDung: [],
                    arrGioApDung: [],
                    arrChiNhanhApDung: [],
                    arrNhanVienApDung: [],
                    arrNhomKhachApDung: [],
                };

                $('#vmThemMoiKhuyenMai').modal('show');
            },
            showModalUpdate: async function (idKhuyenMai, typeUpdate = 2) {
                let self = this;
                self.typeUpdate = typeUpdate;// 1.insert/saochep, 2. update
                self.saveOK = false;
                self.isSaving = false;
                let dataKM = await self.GetDMKhuyenMai_byId(idKhuyenMai);
                let ctKM = await self.GetChiTietKhuyenMai_byIdKhuyenMai(idKhuyenMai);

                if (dataKM !== null) {
                    self.objKhuyenMai.ID = typeUpdate === 1 ? const_GuidEmpty : dataKM.ID;
                    self.objKhuyenMai.LoaiKhuyenMai = dataKM.LoaiKhuyenMai;
                    self.objKhuyenMai.HinhThuc = dataKM.HinhThuc;
                    self.objKhuyenMai.MaKhuyenMai = typeUpdate === 1 ? '' : dataKM.MaKhuyenMai;
                    self.objKhuyenMai.TenKhuyenMai = dataKM.TenKhuyenMai;
                    self.objKhuyenMai.ThoiGianBatDau = dataKM.ThoiGianBatDau;
                    self.objKhuyenMai.ThoiGianKetThuc = dataKM.ThoiGianKetThuc;
                    self.objKhuyenMai.GhiChu = dataKM.GhiChu;
                    self.objKhuyenMai.TatCaDoiTuong = dataKM.TatCaDoiTuong;
                    self.objKhuyenMai.TatCaDonVi = dataKM.TatCaDonVi;
                    self.objKhuyenMai.TatCaNhanVien = dataKM.TatCaNhanVien;
                    self.objKhuyenMai.ApDungNgaySinhNhat = dataKM.ApDungNgaySinhNhat;
                    self.objKhuyenMai.TrangThai = dataKM.TrangThai === true ? '1' : '0';
                    self.objKhuyenMai.TxtLoaiKhuyenMai = dataKM.LoaiKhuyenMai === commonStatisJs.LoaiKhuyenMai.HOA_DON ? 'Hóa đơn' : 'Hàng hóa';
                    let loaiKM = self.ArrHinhThucKhuyenMai.filter(x => x.ID === dataKM.HinhThuc);
                    self.objKhuyenMai.TxtHinhThuc = loaiKM.length > 0 ? loaiKM[0].Text2 : '';

                    let arrThang = dataKM.ThangApDung.split(',').filter(x => x !== '').map(Number).sort(function (x, y) {
                        let a = x; b = y;
                        return a > b ? 1 : a < b ? -1 : 0
                    });
                    let arrNgay = dataKM.NgayApDung.split(',').filter(x => x !== '').map(Number).sort(function (x, y) {
                        let a = x; b = y;
                        return a > b ? 1 : a < b ? -1 : 0
                    });
                    let arrThu = dataKM.ThuApDung.split(',').filter(x => x !== '').map(Number).sort(function (x, y) {
                        let a = x; b = y;
                        return a > b ? 1 : a < b ? -1 : 0
                    });
                    let arrGio = dataKM.GioApDung.split(',').filter(x => x !== '').map(Number).sort(function (x, y) {
                        let a = x; b = y;
                        return a > b ? 1 : a < b ? -1 : 0
                    });
                    self.objKhuyenMai.arrThangApDung = [];
                    self.objKhuyenMai.arrNgayApDung = [];
                    self.objKhuyenMai.arrThuApDung = [];
                    self.objKhuyenMai.arrGioApDung = [];
                    for (let i = 0; i < arrThang.length; i++) {
                        self.objKhuyenMai.arrThangApDung.push({ ID: arrThang[i], Text1: 'Tháng ' + arrThang[i] });
                    }
                    for (let i = 0; i < arrNgay.length; i++) {
                        self.objKhuyenMai.arrNgayApDung.push({ ID: arrNgay[i], Text1: 'Ngày ' + arrNgay[i] });
                    }
                    for (let i = 0; i < arrThu.length; i++) {
                        if (arrThu[i] === 8) {
                            self.objKhuyenMai.arrThuApDung.push({ ID: arrNgay[i], Text1: 'Chủ nhật' });
                        }
                        else {
                            self.objKhuyenMai.arrThuApDung.push({ ID: arrNgay[i], Text1: 'Ngày ' + arrNgay[i] });
                        }
                    }
                    for (let i = 0; i < arrGio.length; i++) {
                        self.objKhuyenMai.arrGioApDung.push({ ID: arrGio[i], Text1: arrGio[i] });
                    }

                    self.objKhuyenMaiOld = $.extend({}, self.objKhuyenMai);
                }
                // chitiet khuyenmai
                if (self.objKhuyenMai.HinhThuc === commonStatisJs.HinhThucKhuyenMai.HH_GIA_BAN_THEO_SO_LUONG) {
                    let arrIdQuyDoiMua = [];
                    let ctKMOut = [];
                    for (let i = 0; i < ctKM.length; i++) {
                        let itFor = ctKM[i];
                        let loaiApDung = 2, txtLoaiApDung = 'Giảm giá';
                        // do dùng chung ô input của Giảm giá - Giá khuyến mại
                        let giaKhuyenMaiNew = formatNumber3Digit(itFor.GiamGia);
                        if (itFor.GiaKhuyenMai > 0) {
                            loaiApDung = 1;
                            txtLoaiApDung = 'Giá bán';
                            giaKhuyenMaiNew = formatNumber3Digit(itFor.GiaKhuyenMai);
                        }

                        if (!commonStatisJs.CheckNull(itFor.ID_DonViQuiDoiMua) && $.inArray(itFor.ID_DonViQuiDoiMua, arrIdQuyDoiMua) === -1
                            || (!commonStatisJs.CheckNull(itFor.ID_NhomHangHoaMua) && $.inArray(itFor.ID_NhomHangHoaMua, arrIdQuyDoiMua) === -1)) {

                            if (!commonStatisJs.CheckNull(itFor.ID_DonViQuiDoiMua)) {
                                arrIdQuyDoiMua.push(itFor.ID_DonViQuiDoiMua);

                                ctKMOut.push({
                                    ID_DonViQuiDoi: null,
                                    TongTienHang: 0,
                                    ID_DonViQuiDoiMua: itFor.ID_DonViQuiDoiMua,
                                    ID_NhomHangHoaMua: null,
                                    ID_DonViQuiDoi: null,
                                    ID_NhomHangHoa: null,
                                    TongTienHang: 0,
                                    TenHangHoaMua: itFor.TenHangHoaMua,
                                    GiaBan_HangMua: itFor.GiaBan_HangMua, //todo
                                    TenHangHoaTang: '',
                                    GiaBan_HangTang: 0,
                                    TenNhomHangHoaMua: '',
                                    TenNhomHangHoaTang: '',

                                    details: [{
                                        STT: itFor.STT,
                                        SoLuongMua: itFor.SoLuongMua,
                                        GiaKhuyenMai: giaKhuyenMaiNew,
                                        GiamGia: itFor.GiamGia,
                                        GiamGiaTheoPhanTram: itFor.GiamGiaTheoPhanTram,
                                        loaiApDung: loaiApDung,
                                        txtLoaiApDung: txtLoaiApDung
                                    }]
                                });
                            }
                            if (!commonStatisJs.CheckNull(itFor.ID_NhomHangHoaMua)) {

                                arrIdQuyDoiMua.push(itFor.ID_NhomHangHoaMua);

                                ctKMOut.push({
                                    ID_DonViQuiDoi: null,
                                    TongTienHang: 0,
                                    ID_DonViQuiDoiMua: null,
                                    ID_NhomHangHoaMua: itFor.ID_NhomHangHoaMua,
                                    ID_DonViQuiDoi: null,
                                    ID_NhomHangHoa: null,
                                    TongTienHang: 0,
                                    TenHangHoaMua: '',
                                    GiaBan_HangMua: 0,
                                    TenHangHoaTang: '',
                                    GiaBan_HangTang: 0,
                                    TenNhomHangHoaMua: itFor.TenNhomHangHoaMua,
                                    TenNhomHangHoaTang: '',

                                    details: [{
                                        STT: itFor.STT,
                                        SoLuongMua: itFor.SoLuongMua,
                                        GiaKhuyenMai: giaKhuyenMaiNew,
                                        GiamGia: itFor.GiamGia,
                                        GiamGiaTheoPhanTram: itFor.GiamGiaTheoPhanTram,
                                        loaiApDung: loaiApDung,
                                        txtLoaiApDung: txtLoaiApDung
                                    }]
                                });
                            }
                        }
                        else {
                            for (let j = 0; j < ctKMOut.length; j++) {
                                let forIn = ctKMOut[j];
                                if (!commonStatisJs.CheckNull(forIn.ID_DonViQuiDoiMua) && forIn.ID_DonViQuiDoiMua === itFor.ID_DonViQuiDoiMua
                                    || !commonStatisJs.CheckNull(forIn.ID_NhomHangHoaMua) && forIn.ID_NhomHangHoaMua === itFor.ID_NhomHangHoaMua) {
                                    ctKMOut[j].details.push({
                                        STT: itFor.STT,
                                        SoLuongMua: itFor.SoLuongMua,
                                        GiaKhuyenMai: giaKhuyenMaiNew,
                                        GiamGia: itFor.GiamGia,
                                        GiamGiaTheoPhanTram: itFor.GiamGiaTheoPhanTram,
                                        loaiApDung: loaiApDung,
                                        txtLoaiApDung: txtLoaiApDung
                                    });
                                    break;
                                }
                            }
                        }
                    }
                    self.chitietKM = ctKMOut;
                    self.chitietKMOld = $.extend(true, [], ctKMOut);
                }
                else {
                    ctKM.map(function (x) {
                        x['TongTienHang'] = formatNumber3Digit(x.TongTienHang)
                        x['GiamGia'] = formatNumber3Digit(x.GiamGia)
                        x['TenHangHoaTang'] = x.TenHangHoa
                        x['TenNhomHangHoaTang'] = x.TenNhomHangHoa
                        x['details'] = [{
                            STT: 0,
                            SoLuongMua: '',
                            loaiApDung: 1,// 1. giakhuyenmai, 2. giamgia
                            txtLoaiApDung: 'Giá bán',
                            GiaKhuyenMai: '',
                            GiamGia: '',
                            GiamGiaTheoPhanTram: true,
                        }]
                    })
                    self.chitietKM = ctKM;
                    self.chitietKMOld = $.extend(true, [], ctKM);
                }

                // apdung: nhanvien, chinhanh, nhomkhach
                let chinhanhAD = await self.GetListChiNhanhApDung(idKhuyenMai);
                chinhanhAD.map(function (x) {
                    x['Text1'] = x.TenDonVi
                })
                let nvApDung = await self.GetListNhanVienApDung(idKhuyenMai);
                nvApDung.map(function (x) {
                    x['Text1'] = x.MaNhanVien
                    x['Text2'] = x.TenNhanVien
                })

                let nhomkhachAD = await self.GetListNhomKhachApDung(idKhuyenMai);
                nhomkhachAD.map(function (x) {
                    x['Text1'] = x.TenNhomDoiTuong
                });

                self.objKhuyenMai.arrChiNhanhApDung = chinhanhAD;
                self.objKhuyenMai.arrNhanVienApDung = nvApDung;
                self.objKhuyenMai.arrNhomKhachApDung = nhomkhachAD;

                $('#vmThemMoiKhuyenMai').modal('show');
            },
            Loai24_ChangeLoaiApDung: function (item) {
                let self = this;
                for (let i = 0; i < self.chitietKM.length; i++) {
                    if (i === self.indexChosing) {
                        for (let j = 0; j < self.chitietKM[i].details.length; j++) {
                            if (j === self.Loai24_indexChosingDetail) {
                                self.chitietKM[i].details[j].loaiApDung = item.ID;
                                self.chitietKM[i].details[j].txtLoaiApDung = item.Text2;
                            }
                        }
                        break;
                    }
                }
            },
            ChangeLoaiKhuyenMai: function (item) {
                let self = this;
                self.objKhuyenMai.LoaiKhuyenMai = item.ID;
                self.objKhuyenMai.TxtLoaiKhuyenMai = item.Text2;
                switch (item.ID) {
                    case commonStatisJs.LoaiKhuyenMai.HOA_DON:
                        {
                            self.objKhuyenMai.HinhThuc = commonStatisJs.HinhThucKhuyenMai.HD_GIAM_GIAHD;
                            self.objKhuyenMai.TxtHinhThuc = 'Giảm giá hóa đơn';
                        }
                        break;
                    case commonStatisJs.LoaiKhuyenMai.HANG_HOA:
                        {
                            self.objKhuyenMai.HinhThuc = commonStatisJs.HinhThucKhuyenMai.HH_GIAM_GIA_HANG;
                            self.objKhuyenMai.TxtHinhThuc = 'Mua hàng giảm giá hàng';
                        }
                        break;
                }
            },
            ChangeHinhThucKM: function (item) {
                let self = this;
                self.objKhuyenMai.HinhThuc = item.ID;
                self.objKhuyenMai.TxtHinhThuc = item.Text2;
            },
            ClickThemDieuKien: function () {
                let self = this;
                self.chitietKM.push(self.newCTKM());
            },
            DateFrom_Change: function (e) {
                let self = this;
                var dt = moment(e).format('YYYY-MM-DD');
                self.objKhuyenMai.ThoiGianBatDau = dt;
            },
            DateTo_Change: function (e) {
                let self = this;
                var dt = moment(e).format('YYYY-MM-DD');
                self.objKhuyenMai.ThoiGianKetThuc = dt;
            },
            ChoseMonth: function (lst) {
                let self = this;
                self.objKhuyenMai.arrThangApDung = lst;
            },
            ChoseDay: function (lst) {
                let self = this;
                self.objKhuyenMai.arrNgayApDung = lst;
            },
            ChoseDate: function (lst) {
                let self = this;
                self.objKhuyenMai.arrThuApDung = lst;
            },
            ChoseHour: function (lst) {
                let self = this;
                self.objKhuyenMai.arrGioApDung = lst;
            },
            ChoseChiNhanh: function (lst) {
                let self = this;
                self.objKhuyenMai.arrChiNhanhApDung = lst;
                if (lst.length > 0 && lst[0].ID !== null) {
                    self.objKhuyenMai.TatCaDonVi = false;
                }
            },
            ChoseNhanVien: function (lst) {
                let self = this;
                self.objKhuyenMai.arrNhanVienApDung = lst;
                if (lst.length > 0 && lst[0].ID !== null) {
                    self.objKhuyenMai.TatCaNhanVien = false;
                }
            },
            ChoseNhomKhach: function (lst) {
                let self = this;
                self.objKhuyenMai.arrNhomKhachApDung = lst;
                if (lst.length > 0 && lst[0].ID !== null) {
                    self.objKhuyenMai.TatCaDoiTuong = false;
                }
            },
            RemoveChiTietKM: function (ctkm, index) {
                let self = this;
                for (let i = 0; i < self.chitietKM.length; i++) {
                    if (i === index) {
                        self.chitietKM.splice(i, 1);
                        break;
                    }
                }
            },
            ChangePtramVND: function (ctkm, index) {
                let self = this;
                for (let i = 0; i < self.chitietKM.length; i++) {
                    if (i === index) {
                        self.chitietKM[i].GiamGiaTheoPhanTram = !self.chitietKM[i].GiamGiaTheoPhanTram
                        break;
                    }
                }
            },
            Loai24_ChangePtramVND: function (index, indexCT) {
                let self = this;
                for (let i = 0; i < self.chitietKM.length; i++) {
                    if (i === index) {
                        for (var j = 0; j < self.chitietKM[i].details.length; j++) {
                            if (j === indexCT) {
                                self.chitietKM[i].details[j].GiamGiaTheoPhanTram = !self.chitietKM[i].details[j].GiamGiaTheoPhanTram;
                            }
                        }
                        break;
                    }
                }
            },
            EditTongTienHang: function (ctkm, index) {
                let self = this;
                let elm = $(event.currentTarget);
                formatNumberObj(elm);
                let val = $(elm).val();

                for (let i = 0; i < self.chitietKM.length; i++) {
                    if (i === index) {
                        self.chitietKM[i].TongTienHang = formatNumber3Digit(val);
                        break;
                    }
                }
            },
            EditGiamGia: function (ctkm, index) {
                let self = this;
                let elm = $(event.currentTarget);
                formatNumberObj(elm);
                let val = elm.val();

                for (let i = 0; i < self.chitietKM.length; i++) {
                    if (i === index) {
                        if (self.chitietKM[i].GiamGiaTheoPhanTram) {
                            if (formatNumberToFloat(val) > 100) {
                                val = 100;
                            }
                        }
                        self.chitietKM[i].GiamGia = val;
                        break;
                    }
                }
            },
            EditSoLuongTang: function (ctkm, index) {
                let self = this;
                let elm = $(event.currentTarget);
                let val = $(elm).val();

                for (let i = 0; i < self.chitietKM.length; i++) {
                    if (i === index) {
                        self.chitietKM[i].SoLuong = val;
                        break;
                    }
                }
            },
            EditSoLuongMua: function (ctkm, index) {
                let self = this;
                let elm = $(event.currentTarget);
                let val = $(elm).val();

                for (let i = 0; i < self.chitietKM.length; i++) {
                    if (i === index) {
                        self.chitietKM[i].SoLuongMua = val;
                        break;
                    }
                }
            },
            Loai24_EditSoLuongMua: function (index, indexCT) {
                let self = this;
                let elm = $(event.currentTarget);
                let val = $(elm).val();

                for (let i = 0; i < self.chitietKM.length; i++) {
                    if (i === index) {
                        for (let j = 0; j < self.chitietKM[i].details.length; j++) {
                            if (j === indexCT) {
                                self.chitietKM[i].details[j].SoLuongMua = val;
                            }
                        }
                        break;
                    }
                }
            },

            Loai24_EditGiaKhuyenMai: function (index, indexCT) {
                let self = this;
                let elm = $(event.currentTarget);
                formatNumberObj(elm);
                let val = $(elm).val();

                for (let i = 0; i < self.chitietKM.length; i++) {
                    if (i === index) {
                        for (let j = 0; j < self.chitietKM[i].details.length; j++) {
                            let ct = self.chitietKM[i].details[j];
                            if (j === indexCT) {
                                if (ct.loaiApDung == 1) {// gia khuyenmai
                                    self.chitietKM[i].details[j].GiaKhuyenMai = val;
                                }
                                else {// giam gia %/vnd
                                    if (ct.GiamGiaTheoPhanTram) {
                                        if (formatNumberToFloat(val) > 100) {
                                            val = 100;
                                        }
                                    }
                                    self.chitietKM[i].details[j].GiamGia = val;
                                    // do dùng chung 1 ô input GiaKhuyenMai
                                    self.chitietKM[i].details[j].GiaKhuyenMai = val;
                                }
                                break;
                            }
                        }
                        break;
                    }
                }
            },
            Loai24_RemoveDetails: function (index, indexCT) {
                let self = this;
                for (let i = 0; i < self.chitietKM.length; i++) {
                    if (i === index) {
                        for (let j = 0; j < self.chitietKM[i].details.length; j++) {
                            if (j === indexCT) {
                                self.chitietKM[i].details.splice(j, 1);
                            }
                        }
                        break;
                    }
                }
            },
            Loai24_AddDetail: function (index) {
                let self = this;
                for (let i = 0; i < self.chitietKM.length; i++) {
                    if (i === index) {
                        self.chitietKM[i].details.push({
                            STT: 0,
                            SoLuongMua: '',
                            loaiApDung: 1,// 1. giakhuyenmai, 2. giamgia
                            txtLoaiApDung: 'Giá bán',
                            GiaKhuyenMai: '',
                            GiamGia: '',
                            GiamGiaTheoPhanTram: true,
                        });
                        break;
                    }
                }

            },
            SetIndexChosing: function (index) {
                let self = this;
                self.indexChosing = index;
            },
            Loai24_SetIndexChosing: function (index, indexCT) {
                let self = this;
                self.indexChosing = index;
                self.Loai24_indexChosingDetail = indexCT;
            },
            ChoseHangMua: function (proudctItem) {
                let self = this;
                for (let i = 0; i < self.chitietKM.length; i++) {
                    if (i === self.indexChosing) {
                        self.chitietKM[i].ID_DonViQuiDoiMua = proudctItem.ID_DonViQuiDoi;
                        self.chitietKM[i].TenHangHoaMua = proudctItem.TenHangHoa;
                        self.chitietKM[i].GiaBan_HangMua = proudctItem.GiaBan;
                        self.chitietKM[i].ID_NhomHangHoaMua = null;
                        self.chitietKM[i].TenNhomHangHoaMua = '';
                        break;
                    }
                }
            },
            ChoseHangTang: function (proudctItem) {
                let self = this;
                for (let i = 0; i < self.chitietKM.length; i++) {
                    if (i === self.indexChosing) {
                        self.chitietKM[i].ID_DonViQuiDoi = proudctItem.ID_DonViQuiDoi;
                        self.chitietKM[i].TenHangHoaTang = proudctItem.TenHangHoa;
                        self.chitietKM[i].GiaBan_HangTang = proudctItem.GiaBan;
                        self.chitietKM[i].ID_NhomHangHoa = null;
                        self.chitietKM[i].TenNhomHangHoaTang = '';
                        break;
                    }
                }
            },

            showModalNhomHang: function (index, isHangMua = false) {
                let self = this;
                self.indexChosing = index;
                self.isHangMua = isHangMua;
                vmChuyenNhomHang.showModal(0, self.listData.AllNhomHangHoas, 'Chọn nhóm hàng');
            },
            AgreeNhomHangTang: function (nhomChosed = { ID: null, TenNhomHang: '' }) {
                let self = this;
                if (self.isHangMua) {
                    // mua
                    for (let i = 0; i < self.chitietKM.length; i++) {
                        if (i === self.indexChosing) {
                            self.chitietKM[i].ID_NhomHangHoaMua = nhomChosed.ID;
                            self.chitietKM[i].TenNhomHangHoaMua = nhomChosed.TenNhomHang;
                            self.chitietKM[i].ID_DonViQuiDoiMua = null;
                            self.chitietKM[i].TenHangHoaMua = '';
                            break;
                        }
                    }
                }
                else {
                    // tang
                    for (let i = 0; i < self.chitietKM.length; i++) {
                        if (i === self.indexChosing) {
                            self.chitietKM[i].ID_NhomHangHoa = nhomChosed.ID;
                            self.chitietKM[i].TenNhomHangHoaTang = nhomChosed.TenNhomHang;
                            self.chitietKM[i].ID_DonViQuiDoi = null;
                            self.chitietKM[i].TenHangHoaTang = '';
                            break;
                        }
                    }
                }
            },
            CheckSave: async function () {
                let self = this;
                if (commonStatisJs.CheckNull(self.objKhuyenMai.TenKhuyenMai)) {
                    ShowMessage_Danger("Vui lòng nhập tên chương trình khuyến mại");
                    return false;
                }
                if (self.objKhuyenMai.LoaiKhuyenMai === commonStatisJs.LoaiKhuyenMai.HOA_DON) {
                    for (let i = 0; i < self.chitietKM.length; i++) {
                        let forOut = self.chitietKM[i];
                        let tongTienHang = formatNumberToFloat(forOut.TongTienHang);

                        if (tongTienHang == 0) {
                            ShowMessage_Danger("Vui lòng nhập giá trị Tổng tiền hàng");
                            return false;
                        }

                        switch (self.objKhuyenMai.HinhThuc) {
                            case commonStatisJs.HinhThucKhuyenMai.HD_GIAM_GIAHD:
                                {
                                    let giamGia = formatNumberToFloat(forOut.GiamGia);
                                    if (giamGia == 0) {
                                        ShowMessage_Danger("Vui lòng nhập giá trị Giảm giá");
                                        return false;
                                    }
                                }
                                break;
                            case commonStatisJs.HinhThucKhuyenMai.HD_TANG_HANG:
                                {
                                    let slTang = formatNumberToFloat(forOut.SoLuong);
                                    let idQuyDoiTang = forOut.ID_DonViQuiDoi;
                                    let idNhomHang = forOut.ID_NhomHangHoa;
                                    if (slTang == 0) {
                                        ShowMessage_Danger("Vui lòng nhập số lượng hàng được tặng");
                                        return false;
                                    }
                                    if (commonStatisJs.CheckNull(idQuyDoiTang) && commonStatisJs.CheckNull(idNhomHang)) {
                                        ShowMessage_Danger("Vui lòng chọn hàng/nhóm hàng được tặng");
                                        return false;
                                    }
                                }
                                break;
                            case commonStatisJs.HinhThucKhuyenMai.HD_GIAM_GIA_HANG:
                                {
                                    let giamGia = formatNumberToFloat(forOut.GiamGia);
                                    if (giamGia == 0) {
                                        ShowMessage_Danger("Vui lòng nhập giá trị Giảm giá");
                                        return false;
                                    }
                                    let slTang = formatNumberToFloat(forOut.SoLuong);
                                    let idQuyDoi = forOut.ID_DonViQuiDoi;
                                    let idNhomHang = forOut.ID_NhomHangHoa;
                                    if (slTang == 0) {
                                        ShowMessage_Danger("Vui lòng nhập số lượng hàng được giảm giá");
                                        return false;
                                    }
                                    if (commonStatisJs.CheckNull(idQuyDoi) && commonStatisJs.CheckNull(idNhomHang)) {
                                        ShowMessage_Danger("Vui lòng chọn hàng/nhóm hàng được giảm giá");
                                        return false;
                                    }
                                }
                                break;
                            case commonStatisJs.HinhThucKhuyenMai.HD_TANG_DIEM:
                                {
                                    let giamGia = formatNumberToFloat(forOut.GiamGia);
                                    if (giamGia == 0) {
                                        ShowMessage_Danger("Vui lòng nhập giá trị Điểm cộng");
                                        return false;
                                    }
                                }
                                break;
                        }
                    }
                }
                else {
                    for (let i = 0; i < self.chitietKM.length; i++) {
                        let forOut = self.chitietKM[i];

                        let idQuyDoiMua = formatNumberToFloat(forOut.ID_DonViQuiDoiMua);
                        let idNhomHangMua = formatNumberToFloat(forOut.ID_NhomHangHoaMua);
                        let soLuongMua = formatNumberToFloat(forOut.SoLuongMua);

                        if (commonStatisJs.CheckNull(idQuyDoiMua) && commonStatisJs.CheckNull(idNhomHangMua)) {
                            ShowMessage_Danger("Vui lòng chọn hàng/nhóm hàng mua");
                            return false;
                        }
                        if (soLuongMua == 0 && self.objKhuyenMai.HinhThuc !== commonStatisJs.HinhThucKhuyenMai.HH_GIA_BAN_THEO_SO_LUONG) {
                            ShowMessage_Danger("Vui lòng nhập Số lượng mua");
                            return false;
                        }

                        switch (self.objKhuyenMai.HinhThuc) {
                            case commonStatisJs.HinhThucKhuyenMai.HH_GIAM_GIA_HANG:
                                {
                                    let giamGia = formatNumberToFloat(forOut.GiamGia);
                                    let slTang = formatNumberToFloat(forOut.SoLuong);
                                    let idQuyDoi = forOut.ID_DonViQuiDoi;
                                    let idNhomHang = forOut.ID_NhomHangHoa;
                                    if (giamGia == 0) {
                                        ShowMessage_Danger("Vui lòng nhập giá trị Giảm giá");
                                        return false;
                                    }
                                    if (slTang == 0) {
                                        ShowMessage_Danger("Vui lòng nhập số lượng hàng được giảm giá");
                                        return false;
                                    }
                                    if (commonStatisJs.CheckNull(idQuyDoi) && commonStatisJs.CheckNull(idNhomHang)) {
                                        ShowMessage_Danger("Vui lòng chọn hàng/nhóm hàng được giảm giá");
                                        return false;
                                    }
                                }
                                break;
                            case commonStatisJs.HinhThucKhuyenMai.HH_TANG_HANG:
                                {
                                    let slTang = formatNumberToFloat(forOut.SoLuong);
                                    let idQuyDoiTang = forOut.ID_DonViQuiDoi;
                                    let idNhomHang = forOut.ID_NhomHangHoa;
                                    if (slTang == 0) {
                                        ShowMessage_Danger("Vui lòng nhập số lượng hàng được tặng");
                                        return false;
                                    }
                                    if (commonStatisJs.CheckNull(idQuyDoiTang) && commonStatisJs.CheckNull(idNhomHang)) {
                                        ShowMessage_Danger("Vui lòng chọn hàng/nhóm hàng được tặng");
                                        return false;
                                    }
                                }
                                break;
                            case commonStatisJs.HinhThucKhuyenMai.HH_GIA_BAN_THEO_SO_LUONG:
                                {
                                    for (let j = 0; j < forOut.details.length; j++) {
                                        let forIn = forOut.details[j];
                                        let soluongMua = formatNumberToFloat(forIn.SoLuongMua);
                                        if (soluongMua === 0) {
                                            ShowMessage_Danger("Vui lòng nhập Số lượng mua");
                                            return false;
                                        }
                                        let giaKhuyenMai = formatNumberToFloat(forIn.GiaKhuyenMai);
                                        if (giaKhuyenMai === 0) {
                                            if (forIn.loaiApDung === 1) {
                                                ShowMessage_Danger("Vui lòng nhập giá bán khuyến mại");
                                                return false;
                                            }
                                            else {
                                                ShowMessage_Danger("Vui lòng nhập giá trị Giảm giá");
                                                return false;
                                            }
                                        }
                                    }
                                }
                                break;
                            case commonStatisJs.HinhThucKhuyenMai.HH_TANG_DIEM:
                                {
                                    let giamGia = formatNumberToFloat(forOut.GiamGia);
                                    if (giamGia == 0) {
                                        ShowMessage_Danger("Vui lòng nhập giá trị Điểm cộng");
                                        return false;
                                    }
                                }
                                break;
                        }
                    }
                }

                if (!commonStatisJs.CheckNull(self.objKhuyenMai.MaKhuyenMai)) {
                    let checkExists = await ajaxHelper(self.BH_KhuyenMaiAPI + 'CheckExists_MaKhuyenMai?idKhuyenMai=' + self.objKhuyenMai.ID
                        + '&maKhuyenMai=' + self.objKhuyenMai.MaKhuyenMai, 'GET').done().then(function (data) {
                            return data;
                        });
                    if (checkExists) {
                        ShowMessage_Danger("Mã khuyến mại đã tồn tại");
                        return false;
                    }
                }
                return true;
            },
            SaveData: async function () {
                let self = this;
                if (self.isSaving) return;
                self.isSaving = true;

                let check = await self.CheckSave();
                if (!check) {
                    self.isSaving = false;
                    return false;
                }

                let myData = {
                    objKhuyenMai: self.objKhuyenMai
                }
                myData.objKhuyenMai.ThangApDung = self.objKhuyenMai.arrThangApDung.map(function (x) {
                    return x.ID;
                }).toString(",");
                myData.objKhuyenMai.NgayApDung = self.objKhuyenMai.arrNgayApDung.map(function (x) {
                    return x.ID;
                }).toString(",");
                myData.objKhuyenMai.ThuApDung = self.objKhuyenMai.arrThuApDung.map(function (x) {
                    return x.ID;
                }).toString(",");
                myData.objKhuyenMai.GioApDung = self.objKhuyenMai.arrGioApDung.map(function (x) {
                    return x.ID;
                }).toString(",");

                let ctKM = self.chitietKM;
                if (self.objKhuyenMai.LoaiKhuyenMai === commonStatisJs.LoaiKhuyenMai.HOA_DON) {
                    ctKM = ctKM.filter((x) => !commonStatisJs.CheckNull(x.TongTienHang))
                }
                else {
                    ctKM = ctKM.filter((x) => !commonStatisJs.CheckNull(x.ID_DonViQuiDoiMua) || !commonStatisJs.CheckNull(x.ID_NhomHangHoaMua))
                }
                ctKM.map((x, index) => {
                    x.STT = index + 1
                });
                self.isSaving = false;
                myData.objKhuyenMai.TrangThai = self.objKhuyenMai.TrangThai == '1' ? true : false;
                myData.objKhuyenMai.ApDungNgaySinhNhat = self.objKhuyenMai.ApDungNgaySinhNhat ? 1 : 0;

                let sLoai = 'Thêm mới', sDiary = '<b> Thông tin chi tiết: </b>', sDiaryOld = '';
                let url = 'PostDM_KhuyenMai';
                if (self.typeUpdate === 2) {
                    sLoai = 'Cập nhật';
                    url = 'PutDM_KhuyenMai';
                    myData.objKhuyenMai.NguoiSua = VHeader.UserLogin;

                    sDiaryOld = '<br /> <b> Thông tin cũ: </b>';
                    sDiaryOld += '<br />- Mã chương trình: '.concat(self.objKhuyenMaiOld.MaKhuyenMai,
                        '<br />- Tên chương trình: ', self.objKhuyenMaiOld.TenKhuyenMai,
                        '<br />- Hình thức: ', self.objKhuyenMaiOld.TxtHinhThuc);

                    let sDiaryDetailsOld = '';
                    switch (self.objKhuyenMaiOld.HinhThuc) {
                        case commonStatisJs.HinhThucKhuyenMai.HD_GIAM_GIAHD:
                            {
                                for (let i = 0; i < self.chitietKMOld.length; i++) {
                                    let itFor = self.chitietKMOld[i];
                                    sDiaryDetailsOld += '<br /> Tổng tiền hàng từ: '.concat(itFor.TongTienHang, ', giảm giá ', itFor.GiamGia, itFor.GiamGiaTheoPhanTram ? '%' : 'đ');
                                }
                            }
                            break;
                        case commonStatisJs.HinhThucKhuyenMai.HD_TANG_HANG:
                            {
                                for (let i = 0; i < self.chitietKMOld.length; i++) {
                                    let itFor = self.chitietKMOld[i];
                                    sDiaryDetailsOld += '<br /> Tổng tiền hàng từ: '.concat(itFor.TongTienHang, ', tặng ', itFor.SoLuong, !commonStatisJs.CheckNull(itFor.TenHangHoaTang) ? ' sản phẩm: ' + itFor.TenHangHoaTang : ' sản phẩm thuộc nhóm: ' + itFor.TenNhomHangHoaTang);
                                }
                            }
                            break;
                        case commonStatisJs.HinhThucKhuyenMai.HD_GIAM_GIA_HANG:
                            {
                                for (let i = 0; i < self.chitietKMOld.length; i++) {
                                    let itFor = self.chitietKMOld[i];
                                    sDiaryDetailsOld += '<br /> Tổng tiền hàng từ: '.concat(itFor.TongTienHang, ', giảm giá ', itFor.GiamGia, itFor.GiamGiaTheoPhanTram ? '%' : 'đ',
                                        !commonStatisJs.CheckNull(itFor.TenHangHoaTang) ? ' sản phẩm: ' + itFor.TenHangHoaTang : ' sản phẩm thuộc nhóm: ' + itFor.TenNhomHangHoaTang);
                                }
                            }
                            break;
                        case commonStatisJs.HinhThucKhuyenMai.HD_TANG_DIEM:
                            {
                                for (let i = 0; i < self.chitietKMOld.length; i++) {
                                    let itFor = self.chitietKMOld[i];
                                    sDiaryDetailsOld += '<br /> Tổng tiền hàng từ: '.concat(itFor.TongTienHang, ', tặng ', itFor.GiamGia, itFor.GiamGiaTheoPhanTram ? '%' : 'đ', ' điểm');
                                }
                            }
                            break;
                        case commonStatisJs.HinhThucKhuyenMai.HH_GIAM_GIA_HANG:
                            {
                                for (let i = 0; i < self.chitietKMOld.length; i++) {
                                    let itFor = self.chitietKMOld[i];
                                    sDiaryDetailsOld += '<br /> Mua '.concat(itFor.SoLuongMua,
                                        !commonStatisJs.CheckNull(itFor.TenHangHoaMua) ? ' sản phẩm: ' + itFor.TenHangHoaMua : 'sản phẩm thuộc nhóm: ' + itFor.TenNhomHangHoaMua, ' được giảm giá ',
                                        itFor.GiamGia, itFor.GiamGiaTheoPhanTram ? '% ' : 'đ ', itFor.SoLuong,
                                        !commonStatisJs.CheckNull(itFor.TenHangHoaTang) ? ' sản phẩm: ' + itFor.TenHangHoaTang : ' sản phẩm thuộc nhóm: ' + itFor.TenNhomHangHoaTang, ' được giảm giá ',
                                    );
                                }
                            }
                            break;
                        case commonStatisJs.HinhThucKhuyenMai.HH_TANG_HANG:
                            {
                                for (let i = 0; i < self.chitietKMOld.length; i++) {
                                    let itFor = self.chitietKMOld[i];
                                    sDiaryDetailsOld += '<br /> Mua '.concat(itFor.SoLuongMua,
                                        !commonStatisJs.CheckNull(itFor.TenHangHoaMua) ? ' sản phẩm: ' + itFor.TenHangHoaMua : ' sản phẩm thuộc nhóm: ' + itFor.TenNhomHangHoaMua, ' được tặng ',
                                        itFor.SoLuong,
                                        !commonStatisJs.CheckNull(itFor.TenHangHoaTang) ? ' sản phẩm: ' + itFor.TenHangHoaTang : ' sản phẩm thuộc nhóm: ' + itFor.TenNhomHangHoaTang
                                    );
                                }
                            }
                            break;
                        case commonStatisJs.HinhThucKhuyenMai.HH_TANG_DIEM:
                            {
                                for (let i = 0; i < self.chitietKMOld.length; i++) {
                                    let itFor = self.chitietKMOld[i];
                                    sDiaryDetailsOld += '<br /> Mua '.concat(itFor.SoLuongMua,
                                        !commonStatisJs.CheckNull(itFor.TenHangHoaMua) ? ' sản phẩm: ' + itFor.TenHangHoaMua : ' sản phẩm thuộc nhóm: ' + itFor.TenNhomHangHoaMua, ' được tặng ',
                                        itFor.GiamGia, itFor.GiamGiaTheoPhanTram ? '%' : 'đ', ' điểm'
                                    );
                                }
                            }
                            break;
                        case commonStatisJs.HinhThucKhuyenMai.HH_GIA_BAN_THEO_SO_LUONG:
                            {
                                for (let i = 0; i < self.chitietKMOld.length; i++) {
                                    let forOut = self.chitietKMOld[i];
                                    sDiaryOld += ' <br /> Khi mua '.concat(!commonStatisJs.CheckNull(forOut.TenHangHoaMua) ? 'sản phầm ' + forOut.TenHangHoaMua : 'sản phầm thuộc nhóm ' + forOut.TenNhomHangHoaMua);

                                    for (let j = 0; j < forOut.details.length; j++) {
                                        let forIn = forOut.details[j];
                                        let sDiaryDetailsOld = ' <br />- Số lượng từ: '.concat(forIn.SoLuongMua);

                                        if (forIn.loaiApDung === 1) {
                                            sDiaryDetailsOld += ', giá bán: '.concat(forIn.GiaKhuyenMai);
                                        }
                                        else {
                                            sDiaryDetailsOld += ', giảm giá: '.concat(forIn.GiaKhuyenMai, forIn.GiamGiaTheoPhanTram ? '%' : 'đ');
                                        }
                                        sDiaryOld += sDiaryDetailsOld;
                                    }
                                }
                            }
                            break;
                    }

                    sDiaryOld += sDiaryDetailsOld;
                }
                let dataKM = await ajaxHelper(self.BH_KhuyenMaiAPI + url, 'POST', myData).done()
                    .then(function (data) {
                        return data;
                    });

                if (dataKM.res) {
                    sDiary += '<br /> Hình thức khuyến mại: '.concat(self.objKhuyenMai.TxtHinhThuc);
                    let arrCTKM = [];
                    let idKhuyenMai = dataKM.dataSoure.ID;
                    if (self.objKhuyenMai.HinhThuc === commonStatisJs.HinhThucKhuyenMai.HH_GIA_BAN_THEO_SO_LUONG) {
                        let stt = 1;
                        for (let i = 0; i < ctKM.length; i++) {
                            let forOut = ctKM[i];
                            sDiary += ' <br /> Khi mua '.concat(!commonStatisJs.CheckNull(forOut.TenHangHoaMua) ? 'sản phầm ' + forOut.TenHangHoaMua : 'sản phầm thuộc nhóm ' + forOut.TenNhomHangHoaMua);

                            for (let j = 0; j < forOut.details.length; j++) {
                                let forIn = forOut.details[j];
                                let sDiaryDetails = ' <br />- Số lượng từ: '.concat(forIn.SoLuongMua);
                                let obj = {
                                    ID_DonViQuiDoiMua: forOut.ID_DonViQuiDoiMua,
                                    ID_NhomHangHoaMua: forOut.ID_NhomHangHoaMua,
                                    ID_DonViQuiDoi: null,
                                    ID_NhomHangHoa: null,
                                    TongTienHang: 0,

                                    STT: stt,
                                    SoLuongMua: forIn.SoLuongMua,
                                }
                                if (forIn.loaiApDung === 1) {
                                    // giakhuyenmai
                                    obj.GiaKhuyenMai = forIn.GiaKhuyenMai;
                                    obj.GiamGia = 0;
                                    obj.GiamGiaTheoPhanTram = false;
                                    sDiaryDetails += ', giá bán: '.concat(forIn.GiaKhuyenMai);
                                }
                                else {
                                    // giamgia
                                    obj.GiaKhuyenMai = 0;
                                    obj.GiamGia = forIn.GiaKhuyenMai;
                                    obj.GiamGiaTheoPhanTram = forIn.GiamGiaTheoPhanTram;
                                    sDiaryDetails += ', giảm giá: '.concat(forIn.GiaKhuyenMai, forIn.GiamGiaTheoPhanTram ? '%' : 'đ');
                                }
                                sDiary += sDiaryDetails;
                                arrCTKM.push(obj);
                                stt += 1;
                            }
                        }
                    }
                    else {
                        ctKM.map((x, index) => {
                            x.STT = index + 1
                        });
                        arrCTKM = ctKM;

                        let sDiaryDetails = '';
                        switch (self.objKhuyenMai.HinhThuc) {
                            case commonStatisJs.HinhThucKhuyenMai.HD_GIAM_GIAHD:
                                {
                                    for (let i = 0; i < ctKM.length; i++) {
                                        let itFor = ctKM[i];
                                        sDiaryDetails += '<br /> Tổng tiền hàng từ: '.concat(itFor.TongTienHang, ', giảm giá ', itFor.GiamGia, itFor.GiamGiaTheoPhanTram ? '%' : 'đ');
                                    }
                                }
                                break;
                            case commonStatisJs.HinhThucKhuyenMai.HD_TANG_HANG:
                                {
                                    for (let i = 0; i < ctKM.length; i++) {
                                        let itFor = ctKM[i];
                                        sDiaryDetails += '<br /> Tổng tiền hàng từ: '.concat(itFor.TongTienHang, ', tặng ', itFor.SoLuong, !commonStatisJs.CheckNull(itFor.TenHangHoaTang) ? ' sản phẩm: ' + itFor.TenHangHoaTang : ' sản phẩm thuộc nhóm: ' + itFor.TenNhomHangHoaTang);
                                    }
                                }
                                break;
                            case commonStatisJs.HinhThucKhuyenMai.HD_GIAM_GIA_HANG:
                                {
                                    for (let i = 0; i < ctKM.length; i++) {
                                        let itFor = ctKM[i];
                                        sDiaryDetails += '<br /> Tổng tiền hàng từ: '.concat(itFor.TongTienHang, ', giảm giá ', itFor.GiamGia, itFor.GiamGiaTheoPhanTram ? '%' : 'đ',
                                            !commonStatisJs.CheckNull(itFor.TenHangHoaTang) ? ' sản phẩm: ' + itFor.TenHangHoaTang : ' sản phẩm thuộc nhóm: ' + itFor.TenNhomHangHoaTang);
                                    }
                                }
                                break;
                            case commonStatisJs.HinhThucKhuyenMai.HD_TANG_DIEM:
                                {
                                    for (let i = 0; i < ctKM.length; i++) {
                                        let itFor = ctKM[i];
                                        sDiaryDetails += '<br /> Tổng tiền hàng từ: '.concat(itFor.TongTienHang, ', tặng ', itFor.GiamGia, itFor.GiamGiaTheoPhanTram ? '%' : 'đ', ' điểm');
                                    }
                                }
                                break;
                            case commonStatisJs.HinhThucKhuyenMai.HH_GIAM_GIA_HANG:
                                {
                                    for (let i = 0; i < ctKM.length; i++) {
                                        let itFor = ctKM[i];
                                        sDiaryDetails += '<br /> Mua '.concat(itFor.SoLuongMua,
                                            !commonStatisJs.CheckNull(itFor.TenHangHoaMua) ? ' sản phẩm: ' + itFor.TenHangHoaMua : ' sản phẩm thuộc nhóm: ' + itFor.TenNhomHangHoaMua, ' được giảm giá ',
                                            itFor.GiamGia, itFor.GiamGiaTheoPhanTram ? '% ' : 'đ ', itFor.SoLuong,
                                            !commonStatisJs.CheckNull(itFor.TenHangHoaTang) ? ' sản phẩm: ' + itFor.TenHangHoaTang : ' sản phẩm thuộc nhóm: ' + itFor.TenNhomHangHoaTang, ' được giảm giá ',
                                        );
                                    }
                                }
                                break;
                            case commonStatisJs.HinhThucKhuyenMai.HH_TANG_HANG:
                                {
                                    for (let i = 0; i < ctKM.length; i++) {
                                        let itFor = ctKM[i];
                                        sDiaryDetails += '<br /> Mua '.concat(itFor.SoLuongMua,
                                            !commonStatisJs.CheckNull(itFor.TenHangHoaMua) ? ' sản phẩm: ' + itFor.TenHangHoaMua : ' sản phẩm thuộc nhóm: ' + itFor.TenNhomHangHoaMua, ' được tặng ',
                                            itFor.SoLuong,
                                            !commonStatisJs.CheckNull(itFor.TenHangHoaTang) ? ' sản phẩm: ' + itFor.TenHangHoaTang : ' sản phẩm thuộc nhóm: ' + itFor.TenNhomHangHoaTang
                                        );
                                    }
                                }
                                break;
                            case commonStatisJs.HinhThucKhuyenMai.HH_TANG_DIEM:
                                {
                                    for (let i = 0; i < ctKM.length; i++) {
                                        let itFor = ctKM[i];
                                        sDiaryDetails += '<br /> Mua '.concat(itFor.SoLuongMua,
                                            !commonStatisJs.CheckNull(itFor.TenHangHoaMua) ? ' sản phẩm: ' + itFor.TenHangHoaMua : ' sản phẩm thuộc nhóm: ' + itFor.TenNhomHangHoaMua, ' được tặng ',
                                            itFor.GiamGia, itFor.GiamGiaTheoPhanTram ? '%' : 'đ', ' điểm'
                                        );
                                    }
                                }
                                break;
                        }

                        sDiary += sDiaryDetails;
                    }

                    let dataCTKM = await ajaxHelper(self.BH_KhuyenMaiAPI + 'PostDM_KhuyenMaiChiTiet?idKhuyenMai=' + idKhuyenMai, 'POST', { lstChiTietKM: arrCTKM }).done()
                        .then(function (data) {
                            return data;
                        });
                    if (dataCTKM.res) {
                        ShowMessage_Success(sLoai + ' chương trình khuyến mại thành công');

                    }

                    if (self.objKhuyenMai.arrChiNhanhApDung.length > 0 || self.objKhuyenMai.arrNhanVienApDung.length > 0 ||
                        self.objKhuyenMai.arrNhanVienApDung.length > 0) {
                        let arrChiNhanh = self.objKhuyenMai.arrChiNhanhApDung.filter(x => x.ID !== null).map(function (x) {
                            return x.ID;
                        });
                        let arrNhanVien = self.objKhuyenMai.arrNhanVienApDung.filter(x => x.ID !== null).map(function (x) {
                            return x.ID;
                        })
                        let arrNhomKhach = self.objKhuyenMai.arrNhomKhachApDung.filter(x => x.ID !== null).map(function (x) {
                            return x.ID;
                        })
                        let arrKMAD = [];
                        let objAD = { ID_DonVi: null, ID_NhanVien: null, ID_NhomKhachHang: null };

                        if (arrChiNhanh.length > 0) {
                            if (arrNhanVien.length > 0) {
                                if (arrNhomKhach.length > 0) {
                                    // full
                                    for (let i = 0; i < arrChiNhanh.length; i++) {
                                        for (let k = 0; k < arrNhanVien.length; k++) {
                                            for (let j = 0; j < arrNhomKhach.length; j++) {
                                                arrKMAD.push({ ID_DonVi: arrChiNhanh[i], ID_NhanVien: arrNhanVien[k], ID_NhomKhachHang: arrNhomKhach[j] })
                                            }
                                        }
                                    }

                                }
                                else {
                                    // chinhanh + nvien
                                    for (let i = 0; i < arrChiNhanh.length; i++) {
                                        for (let k = 0; k < arrNhanVien.length; k++) {
                                            arrKMAD.push({ ID_DonVi: arrChiNhanh[i], ID_NhanVien: arrNhanVien[k], ID_NhomKhachHang: null })
                                        }
                                    }
                                }
                            }
                            else {
                                // chinhanh + nhomkhach
                                if (arrNhomKhach.length > 0) {
                                    for (let i = 0; i < arrChiNhanh.length; i++) {
                                        for (let k = 0; k < arrNhomKhach.length; k++) {
                                            arrKMAD.push({ ID_DonVi: arrChiNhanh[i], ID_NhanVien: null, ID_NhomKhachHang: arrNhomKhach[k] })
                                        }
                                    }
                                }
                                else {
                                    // chinhanh
                                    for (let i = 0; i < arrChiNhanh.length; i++) {
                                        arrKMAD.push({ ID_DonVi: arrChiNhanh[i], ID_NhanVien: null, ID_NhomKhachHang: null })
                                    }
                                }
                            }
                        }
                        else {
                            if (arrNhanVien.length > 0) {
                                if (arrNhomKhach.length > 0) {
                                    // nvien + nhomkhach
                                    for (let k = 0; k < arrNhanVien.length; k++) {
                                        for (let j = 0; j < arrNhomKhach.length; j++) {
                                            arrKMAD.push({ ID_DonVi: null, ID_NhanVien: arrNhanVien[k], ID_NhomKhachHang: arrNhomKhach[j] })
                                        }
                                    }
                                }
                                else {
                                    // nhanvien
                                    for (let k = 0; k < arrNhanVien.length; k++) {
                                        arrKMAD.push({ ID_DonVi: null, ID_NhanVien: arrNhanVien[k], ID_NhomKhachHang: null })
                                    }
                                }
                            }
                            else {
                                if (arrNhomKhach.length > 0) {
                                    // nhomkhach
                                    for (let j = 0; j < arrNhomKhach.length; j++) {
                                        arrKMAD.push({ ID_DonVi: null, ID_NhanVien: null, ID_NhomKhachHang: arrNhomKhach[j] })
                                    }
                                }

                            }
                        }

                        let dataKMAD = await ajaxHelper(self.BH_KhuyenMaiAPI + 'PostDM_KhuyenMaiApDung?idKhuyenMai=' + idKhuyenMai, 'POST', { objKhuyenMaiApDung: arrKMAD }).done()
                            .then(function (data) {
                                return data;
                            });
                    }
                    self.saveOK = true;

                    let diary = {
                        ID_NhanVien: VHeader.IdNhanVien,
                        ID_DonVi: VHeader.IdDonVi,
                        ChucNang: 'Danh mục khuyến mại',
                        NoiDung: sLoai.concat(' chương trình khuyến mại. Tên chương trình: ', self.objKhuyenMai.TenKhuyenMai),
                        NoiDungChiTiet: sDiary.concat(sDiaryOld),
                        LoaiNhatKy: self.typeUpdate
                    }
                    Insert_NhatKyThaoTac_1Param(diary);
                }
                $('#vmThemMoiKhuyenMai').modal('hide');
            }
        }
    })

    $('#vmChuyenNhomHang').on('hidden.bs.modal', function () {
        if (vmChuyenNhomHang.saveOK) {
            let nhomChosed = {
                ID: vmChuyenNhomHang.arrIDChosed[0],
                TenNhomHang: vmChuyenNhomHang.TenNhomChoseds
            };
            vmThemMoiKhuyenMai.AgreeNhomHangTang(nhomChosed);
        }
    })
</script>
