var FormModel_NewHoaDon = function () {
    var self = this;
    self.ID = ko.observable('00000000-0000-0000-0000-000000000000');
    self.ID_HoaDon = ko.observable();
    self.IDRandom = ko.observable();
    self.LoaiHoaDon = ko.observable(1);
    self.MaHoaDon = ko.observable();
    self.MaHoaDonDB = ko.observable();
    self.NgayLapHoaDon = ko.observable(null);
    self.TongTienHang = ko.observable(0);
    self.PhaiThanhToan = ko.observable(0);// khachcantra
    self.PhaiThanhToanBaoHiem = ko.observable(0);
    self.TongThanhToan = ko.observable(0);// khach + baohiem phaiTT
    self.TongGiamGia = ko.observable(0);
    self.DaThanhToan = ko.observable(0);
    self.KhachDaTra = ko.observable(0);
    self.BaoHiemDaTra = ko.observable(0);
    self.TongTienThue = ko.observable(0);
    self.DienGiai = ko.observable('');
    self.DVTinhGiam = ko.observable('%');
    self.TongChietKhau = ko.observable(0);
    self.IsKhuyenMaiHD = ko.observable(false);
    self.ID_KhuyenMai = ko.observable(null);
    self.ID_NhomDTApplySale = ko.observable(null);
    self.KhuyeMai_GiamGia = ko.observable(0);
    self.TienThua = ko.observable(0);
    self.KhuyenMai_GhiChu = ko.observable('');
    self.TongGiamGiaKM_HD = ko.observable(0);
    self.NgayApDungGoiDV = ko.observable(moment().format('DD/MM/YYY'));
    self.HanSuDungGoiDV = ko.observable(moment().add(1, 'years').format('DD/MM/YYY'));
    self.TienMat = ko.observable(0);
    self.TienATM = ko.observable(0);
    self.TienGui = ko.observable(0);
    self.TienTheGiaTri = ko.observable(0);
    self.DiemQuyDoi = ko.observable(0);
    self.TTBangDiem = ko.observable(0);
    self.StatusOffline = ko.observable(0);
    self.ID_PhieuTiepNhan = ko.observable(null);
    self.ID_DoiTuong = ko.observable(null);
    self.MaPhieuTiepNhan = ko.observable('');
    self.BienSo = ko.observable('');
    self.ID_BaoHiem = ko.observable();
    self.LienHeBaoHiem = ko.observable();
    self.SoDienThoaiLienHeBaoHiem = ko.observable();
    self.ChiPhi = ko.observable();// chiphi ben thu 3 (cuahang tra)
    self.ChiPhi_GhiChu = ko.observable();
    self.TrangThaiHD = ko.observable(1);
    self.TenBaoHiem = ko.observable('');
    self.MaHoaDonTraHang = ko.observable();
    self.TenViTriHD = ko.observable();
    self.ID_ViTri = ko.observable();

    self.PTChietKhauHH = ko.observable(0);
    self.TongGiamGiaHang = ko.observable(0);
    self.TongTienHangChuaCK = ko.observable(0);
    self.TongTienKhuyenMai_CT = ko.observable(0);// kmai of hanghoa
    self.TongGiamGiaKhuyenMai_CT = ko.observable(0);

    self.PhaiThanhToanDB = ko.observable(0);
    self.TongTienMua = ko.observable(0);
    self.TongTienTra = ko.observable(0);
    self.DaTraKhach = ko.observable(0);
    self.PhaiTraKhach = ko.observable(0);
    self.HoanTraThuKhac = ko.observable(0);
    self.PTGiamDB = ko.observable(0);
    self.TongGiamGiaDB = ko.observable(0);
    self.PTThueDB = ko.observable(0);
    self.TongThueDB = ko.observable(0);
    self.TongGiaGocHangTra = ko.observable(0);
    self.TongChiPhiHangTra = ko.observable(0);
    self.TongChiPhi = ko.observable(0);
    self.HoanTraTamUng = ko.observable(0);
    self.MaHoaDonTH_NVien = ko.observable('');
    self.XuatKhoAll = ko.observable(false);
    self.DuyetBaoGia = ko.observable(false);
    self.TongTienPhuTung = ko.observable(0);
    self.TongTienDichVu = ko.observable(0);
    self.SoDuDatCoc = ko.observable(0);

    self.SoVuBaoHiem = ko.observable(0);
    self.KhauTruTheoVu = ko.observable(0);
    self.GiamTruBoiThuong = ko.observable(0);
    self.PTGiamTruBoiThuong = ko.observable(0);
    self.TongTienThueBaoHiem = ko.observable(0);
    self.PTThueBaoHiem = ko.observable(0);
    self.PTThueHoaDon = ko.observable(0);
    self.BHThanhToanTruocThue = ko.observable(0);
    self.TongTienBHDuyet = ko.observable(0);
    self.PTThueKhachHang = ko.observable(0);
    self.TongThueKhachHang = ko.observable(0);
    self.CongThucBaoHiem = ko.observable(0);
    self.GiamTruThanhToanBaoHiem = ko.observable(0);
    self.HeaderBH_GiaTriPtram = ko.observable(0);
    self.HeaderBH_Type = ko.observable(1);
    self.ID_Xe = ko.observable();
    self.ID_DonVi = ko.observable($('#txtDonVi').val());

    self.SetData = function (item) {
        self.ID(item.ID);
        self.ID_HoaDon(item.ID_HoaDon);
        self.IDRandom(item.IDRandom);
        self.LoaiHoaDon(item.LoaiHoaDon);
        self.MaHoaDon(item.MaHoaDon);
        self.MaHoaDonDB(item.MaHoaDonDB);
        self.NgayLapHoaDon(item.NgayLapHoaDon);
        self.TongTienHang(item.TongTienHang);
        self.PhaiThanhToan(item.PhaiThanhToan);
        self.PhaiThanhToanBaoHiem(item.PhaiThanhToanBaoHiem);
        self.TongThanhToan(item.TongThanhToan);
        self.TongGiamGia(item.TongGiamGia);
        self.DaThanhToan(item.DaThanhToan);
        self.KhachDaTra(item.KhachDaTra);
        self.BaoHiemDaTra(item.BaoHiemDaTra);
        self.TongTienThue(item.TongTienThue);
        self.DienGiai(item.DienGiai);
        self.DVTinhGiam(item.DVTinhGiam);
        self.TongChietKhau(item.TongChietKhau);
        self.IsKhuyenMaiHD(item.IsKhuyenMaiHD);
        self.ID_KhuyenMai(item.ID_KhuyenMai);
        self.ID_NhomDTApplySale(item.ID_NhomDTApplySale);
        self.KhuyeMai_GiamGia(item.KhuyeMai_GiamGia);
        self.TienThua(item.TienThua);
        self.KhuyenMai_GhiChu(item.KhuyenMai_GhiChu);
        self.TongGiamGiaKM_HD(item.TongGiamGiaKM_HD);
        self.NgayApDungGoiDV(item.NgayApDungGoiDV);
        self.HanSuDungGoiDV(item.HanSuDungGoiDV);
        self.TienMat(item.TienMat);
        self.TienATM(item.TienATM);
        self.TienGui(item.TienGui);
        self.TienTheGiaTri(item.TienTheGiaTri);
        self.DiemQuyDoi(item.DiemQuyDoi);
        self.TTBangDiem(item.TTBangDiem);
        self.StatusOffline(item.StatusOffline);
        self.ID_PhieuTiepNhan(item.ID_PhieuTiepNhan);
        self.ID_DoiTuong(item.ID_DoiTuong);
        self.MaPhieuTiepNhan(item.MaPhieuTiepNhan);
        self.BienSo(item.BienSo);
        self.ID_BaoHiem(item.ID_BaoHiem);
        self.LienHeBaoHiem(item.LienHeBaoHiem);
        self.SoDienThoaiLienHeBaoHiem(item.SoDienThoaiLienHeBaoHiem);
        self.ChiPhi(item.ChiPhi);
        self.ChiPhi_GhiChu(item.ChiPhi_GhiChu);
        self.TenViTriHD(item.TenViTriHD);
        self.ID_ViTri(item.ID_ViTri);

        self.PhaiThanhToanDB(item.PhaiThanhToanDB);
        self.TongTienMua(item.TongTienMua);
        self.TongTienTra(item.TongTienTra);
        self.DaTraKhach(item.DaTraKhach);
        self.PhaiTraKhach(item.HoanTraTamUng);// assign = hoantra
        self.HoanTraThuKhac(item.HoanTraThuKhac);
        self.PTThueDB(item.PTThueDB);
        self.TongThueDB(item.TongThueDB);
        self.TongGiaGocHangTra(item.TongGiaGocHangTra);
        self.PTGiamDB(item.PTGiamDB);
        self.TongGiamGiaDB(item.TongGiamGiaDB);
        self.TongChiPhi(item.TongChiPhi);
        self.TongChiPhiHangTra(item.TongChiPhiHangTra);
        self.HoanTraTamUng(item.HoanTraTamUng);
        self.MaHoaDonTH_NVien(item.MaHoaDonTH_NVien);
        self.TrangThaiHD(item.TrangThaiHD);
        self.TenBaoHiem(item.TenBaoHiem);
        self.XuatKhoAll(item.XuatKhoAll);
        self.DuyetBaoGia(item.DuyetBaoGia);
        self.MaHoaDonTraHang(item.MaHoaDonTraHang);

        self.PTChietKhauHH(item.PTChietKhauHH);
        self.TongGiamGiaHang(item.TongGiamGiaHang);
        self.TongTienHangChuaCK(item.TongTienHangChuaCK);
        self.TongTienKhuyenMai_CT(item.TongTienKhuyenMai_CT);
        self.TongGiamGiaKhuyenMai_CT(item.TongGiamGiaKhuyenMai_CT);
        self.SoDuDatCoc(item.SoDuDatCoc);

        self.SoVuBaoHiem(item.SoVuBaoHiem);
        self.KhauTruTheoVu(item.KhauTruTheoVu);
        self.GiamTruBoiThuong(item.GiamTruBoiThuong);
        self.PTGiamTruBoiThuong(item.PTGiamTruBoiThuong);
        self.TongTienThueBaoHiem(item.TongTienThueBaoHiem);
        self.PTThueBaoHiem(item.PTThueBaoHiem);
        self.PTThueHoaDon(item.PTThueHoaDon);
        self.BHThanhToanTruocThue(item.BHThanhToanTruocThue);
        self.TongTienBHDuyet(item.TongTienBHDuyet);
        self.PTThueKhachHang(item.PTThueKhachHang);
        self.TongThueKhachHang(item.TongThueKhachHang);
        self.CongThucBaoHiem(item.CongThucBaoHiem);
        self.GiamTruThanhToanBaoHiem(item.GiamTruThanhToanBaoHiem);
        self.HeaderBH_GiaTriPtram(item.HeaderBH_GiaTriPtram);
        self.HeaderBH_Type(item.HeaderBH_Type);
        self.ID_Xe(item.ID_Xe);
        self.ID_DonVi(item.ID_DonVi);
    }
}
var NewModel_BanHangLe = function () {
    var self = this;
    self.TenBaoHiem = ko.observable();
    var id_DonVi = $('#txtDonVi').val();
    var id_User = $('#txtIDUser').val();
    var userLogin = $('#txtUserLogin').val();
    var shopCookies = $('#txtShopCookie').val();
    var _idNhanVien = $('#txtIDNhanVien').val();
    var _subDomain = $('#subDomain').val();
    var DMDoiTuongUri = '/api/DanhMuc/DM_DoiTuongAPI/';
    var DMNguonKhachUri = '/api/DanhMuc/DM_NguonKhachAPI/';
    var BHHoaDonUri = '/api/DanhMuc/BH_HoaDonAPI/';
    var GaraAPI = '/api/DanhMuc/GaraAPI/';

    self.LoaiNganhNghe = ko.observable(0);
    switch (shopCookies.toUpperCase()) {
        case 'C16EDDA0-F6D0-43E1-A469-844FAB143014':// gara
            self.LoaiNganhNghe(1);
            break;
    }

    var tree = '';// use at treeview NhomHangHoa
    var tree2 = '';// use at treeview NhomHangHoa --> check KhuyenMai
    self.SubDomain = ko.observable(_subDomain.toLowerCase());
    self.ShopCookies = ko.observable(shopCookies);
    self.selectedGiaBan = ko.observable();
    self.selectedNVien = ko.observable();
    self.selectedPhongBan = ko.observable();
    self.selectedHangHoa = ko.observable();
    self.selectedNhomHangHoa = ko.observable();

    self.txtSoLuong = ko.observable(1);
    self.txtDonGia = ko.observable(0);
    self.txtSoLuongDT = ko.observable(1);
    self.txtDonGiaDT = ko.observable(0);

    self.filter = ko.observable();
    self.isSortAsc = ko.observable(true);
    self.selectedNCC = ko.observable();
    self.booleanAdd = ko.observable(true);
    self.countHDoffilne = ko.observable();
    self.filterGiaBan = ko.observable();
    self.filterNVien = ko.observable();
    self.selectedDoiTuong = ko.observable();
    self.IsNhapNhanh = ko.observable(true);
    self.IsNhapNhanh_DoiTra = ko.observable(true);
    var serverTime = sstime.GetDatetime();
    self.DateHDDefault = ko.observable(moment(serverTime).format('DD/MM/YYYY'));
    self.TimeHDDefault = ko.observable(moment(serverTime).format('HH:mm'));
    self.FilesSelect = ko.observableArray();
    self.TongThanhToan = ko.observable(0);
    self.ListTime = ko.observableArray();
    self.windowWidth = ko.observable($(window).width());
    self.ThietLap = ko.observableArray(); // thiet lap he thong
    self.ThietLap_TichDiem = ko.observableArray();
    self.ThietLap_TraHang = ko.observableArray();
    self.DienHienTai = ko.observable(0); // bind at popThanhToanThe
    self.TienQuyDoi = ko.observable(0); // so tien quy doi duoc tu Diem
    self.ChotSo_ChiNhanh = ko.observableArray();
    // Khuyen Mai
    self.ID_HHTang = ko.observable();
    self.ID_HHTangHoaDon = ko.observable();
    self.ID_KhuyenMai = ko.observable(); // to do add HangHoa KM
    self.DMKhuyenMai = ko.observableArray();
    self.ListKM_ofHangHoa = ko.observableArray();
    self.ListKM_ofHoaDon = ko.observableArray();
    self.KM_KMApDung = ko.observableArray();
    self.HangHoaTangs = ko.observableArray([]);
    self.HangHoaTang_HoaDons = ko.observableArray([]);
    self.HangHoaChoseTangs = ko.observableArray([]);
    self.ID_DonViQuiDoiMua = ko.observable();
    self.ID_NhomHHMua = ko.observable();
    self.SoLuongTang = ko.observable();
    self.SoLuongMua = ko.observable();
    self.HHTang_AfterRender = ko.observableArray();
    self.HHTangHoaDon_AfterRender = ko.observableArray();
    self.HH_KhuyenMai = ko.observable(); // to do view infor KhuyenMai of HangHoaHH_KhuyenMai
    self.HD_KhuyenMai = ko.observable(); // to do set value of rdoKMaiHD
    self.IsTangTheoNhom = ko.observable(false); // check xem HangHoa Khuyen Mai thuoc loai tang theo nhom OR tang theo ID_QuiDoi
    self.GiamGiaKM = ko.observable();
    self.GiamGiaTheoPhanTram = ko.observable();
    self.HinhThucKM = ko.observable();
    self.HHTang_HoaDon = ko.observableArray();
    self.ListIDNhanVienQuyen = ko.observableArray();
    self.TrangThaiKhachHang = ko.observableArray();
    self.PhongBans = ko.observableArray();
    self.TinhThanhs = ko.observableArray();
    self.QuanHuyens = ko.observableArray();
    self.AllQuanHuyens = ko.observableArray();
    self.NguonKhachs = ko.observableArray();
    self.NhomDoiTuongs = ko.observableArray();
    self.HangHoas = ko.observableArray();// fiter by Nhom
    self.PageResults = ko.observableArray();
    self.HangHoaOlds = ko.observableArray();
    self.HangHoaAll = ko.observableArray();// after filter TonKho > 0
    self.HangHoaAll_notLoHang = ko.observableArray();
    self.HoaDonTHs = ko.observableArray();
    self.HangHoaAfterAdds = ko.observableArray();
    self.HoaDons = ko.observable(new FormModel_NewHoaDon());
    self.NhanViens = ko.observableArray(); // lstNhanvien not ID_DonVi
    self.NhanViens_ChiNhanh = ko.observableArray(); // lstNhanvien with ID_DonVi (duplicate NVien)
    self.ChiTietHangHoa = ko.observableArray();
    self.NhomHangHoas = ko.observableArray();
    self.GiaBans = ko.observableArray(); // lst BangGia after change NCC, NVien
    self.AllBangGia = ko.observableArray(); // all BGia in DB
    self.AllGiaBanChiTiet = ko.observableArray();
    self.ChiTietDoiTuong = ko.observableArray();
    self.PhongBanSelected = ko.observableArray();
    self.HoaDonByIDViTri = ko.observableArray();
    self.HoaDonOffline = ko.observableArray();
    self.CongTy = ko.observableArray();
    self.ChiNhanhs = ko.observableArray();
    self.ChiNhanhs_byUser = ko.observableArray();
    self.ChiNhanh0 = ko.observableArray();
    // tab location
    self.AllPhongBans = ko.observableArray();
    self.AllNhomBans = ko.observableArray();
    self.PhongBans_byIDNhom = ko.observableArray();
    self.IDPhongBan_Chosing = ko.observable();
    self.MenhGiaTienGoiy = ko.observableArray();
    // modal TP dinh luong
    self.ListHangHoa_DinhLuong = ko.observableArray();
    self.All_DinhLuongDichVu = ko.observableArray();
    self.Grid_TPDinhLuongChosed = ko.observableArray();

    // modal infor hd of other user
    self.Modal_HoaDons = ko.observableArray();
    self.NumberTableUsed = ko.observable(0);
    self.NumberTableEmpty = ko.observable(0);
    self.titleChinhanh = ko.computed(function () {
        if (self.ChiNhanh0() !== null && self.ChiNhanh0() !== undefined) { return self.ChiNhanh0().TenDonVi; }
        else {
            return "";
        }
    });
    self.selectedChiNhanh = ko.observable();
    self.NhanVien0 = ko.observableArray();
    self.titleNhanvien = ko.computed(function () {
        if (self.NhanVien0() !== null && self.NhanVien0() !== undefined && self.NhanVien0().length > 0) { return self.NhanVien0()[0].TenNhanVien; }
        else {
            return "";
        }
    });
    self.GiaBan0 = ko.observableArray();
    self.titleGiaban = ko.computed(function () {
        if (self.GiaBan0() !== null && self.GiaBan0() !== undefined && self.GiaBan0().length > 0) { return self.GiaBan0()[0].TenGiaBan; }
        else {
            return "";
        }
    });
    self.CTHoaDonPrint = ko.observableArray();
    self.CTHoaDonPrintMH = ko.observableArray();
    self.InforHDprintf = ko.observableArray();
    self.DM_MauIn = ko.observableArray();
    self.NhomHHChosed = ko.observableArray();
    // count CTHD (header)
    self.SumProduct = ko.observable(0);
    self.SumQuantity = ko.observable(0);
    self.AllAccountBank = ko.observableArray();
    // chon nhieu nhom KhachHang
    self.NhomDoiTuongDB = ko.observableArray();
    self.NhomDoiTuongChosed = ko.observableArray();
    // hide/show colum CTHD
    self.show_STT = ko.observable(true);
    self.show_ProductCode = ko.observable(true);
    self.show_ProductName = ko.observable(true);
    self.show_ProductCount = ko.observable(true);
    self.show_ProductPrice = ko.observable(true);
    self.show_ProductSale = ko.observable(true);
    self.show_SumPrice = ko.observable(true);
    self.show_WidthProductName = ko.observable("calc(100% - 550px)");
    self.showHeader_STT = ko.observable(true);
    self.showHeader_ProductCode = ko.observable(true);
    self.showHeader_ProductName = ko.observable(true);
    self.showHeader_ProductCount = ko.observable(true);
    self.showHeader_ProductPrice = ko.observable(true);
    self.showHeader_SumPrice = ko.observable(true);
    self.showHeader_ProductSale = ko.observable(true);
    self.showHeader_WidthProductName = ko.observable("calc(100% - 550px)");

    // get cookie "Account" from brower (if deleted userLogin --> go to Login)
    var cookieAccount = $.cookie("Account");
    if (cookieAccount === undefined) {
        window.location.href = '/Login';
    }
    self.DMChungTus = ko.observableArray([
        { MaLoaiChungTu: 0, TenLoaiChungTu: 'Tất cả' },
        { MaLoaiChungTu: 1, TenLoaiChungTu: 'Hóa đơn' },
        { MaLoaiChungTu: 3, TenLoaiChungTu: 'Báo giá' },
        { MaLoaiChungTu: 6, TenLoaiChungTu: 'Trả hàng' },
    ]);
    self.selectLoaiChungTu = ko.observable();
    // Tra Hang
    self.selectNewProduct = ko.observable();
    self.NewProducts = ko.observableArray();
    self.HoaDonTraHang = ko.observableArray();
    self.indexOfMaHD = ko.observable();
    self.filterFromDate = ko.observable();
    self.filterToDate = ko.observable();
    self.pageSize = ko.observable(12);
    self.currentPage = ko.observable(0);
    self.pageSizeHD = ko.observable(4);
    //Phân trang trả hàng hóa đơn
    self.pageSizesTH = [10, 20, 30];
    self.pageSizeTH = ko.observable(10);
    self.currentPageTH = ko.observable(0);
    self.fromitemTH = ko.observable(1);
    self.toitemTH = ko.observable();
    self.PageCountTH = ko.observable();
    self.TotalRecordTH = ko.observable();
    // phan trang Dat Hang
    self.filterFromDateDH = ko.observable('01/01/2016');
    self.filterToDateDH = ko.observable(moment(new Date()).format('DD/MM/YYYY'));
    self.HoaDonDHs = ko.observableArray();
    self.pageSizesDH = [10, 20, 30];
    self.pageSizeDH = ko.observable(10);
    self.currentPageDH = ko.observable(0);
    self.fromitem = ko.observable(1);
    self.toitem = ko.observable();
    self.PageCountDH = ko.observable();
    self.TotalRecordDH = ko.observable();
    // DatHang
    self.StatusHD = ko.observable();
    self.ID_HoaDonUpdate = ko.observable();
    // ap dung giam gia theo nhom
    self.ListGroupSale = ko.observableArray();
    self.Quyen_NguoiDung = ko.observableArray();
    // Setting print invoice
    self.setViewSoDoPhong = ko.observable(false);
    self.setLuuTam = ko.observable(false);
    self.setNhapQuyCach = ko.observable(false);
    self.setHideProduct = ko.observable(false);
    self.setPrintDraft = ko.observable(false);
    self.setPrintPay = ko.observable(true);
    self.setPrintTicket = ko.observable(false);
    self.numberOfPrint = ko.observable(1);
    self.ListTempPrint = ko.observableArray();
    self.roleCurrent = ko.observable(0);

    self.roleChangePriceProduct = ko.observable(false);
    self.roleChangePriceProduct_Invoice = ko.observable(false); // change price of product at Invoice
    self.roleChangeSale_Invoice = ko.observable(false); // change sale of Invoice
    self.roleChangePriceProduct_Order = ko.observable(false);
    self.roleChangeSale_Order = ko.observable(false);
    self.roleChangePriceProduct_Return = ko.observable(false);
    self.roleChangeSale_Return = ko.observable(false);
    self.roleChangePriceProduct_ServicePackage = ko.observable(false);
    self.roleChangeSale_ServicePackage = ko.observable(false);
    self.RoleChange_ChietKhauNV = ko.observable(false);
    self.RoleView_ChietKhauNV = ko.observable(false);

    self.roleCustomer_Insert = ko.observable(false);
    self.roleCustomer_ThanhToanNo = ko.observable(false);
    self.RoleInsert_Invoice = ko.observable(false);
    self.RoleInsert_Order = ko.observable(false);
    self.RoleInsert_Service = ko.observable(false);
    self.RoleInsert_Return = ko.observable(false);
    self.RoleXuly_Order = ko.observable(false);

    // const localStorage
    const lcMaHD = 'maHDCache';
    const lcListHD = 'gara_lstHDLe';
    const lcListCTHD = 'gara_lstCTHDLe';
    const lcCTHDTraHang_fromHD = 'CTHDTraHang'; // save cache CTHD if TraHang from HD
    const lcListCTHD_DoiTra = 'lstCTHDLe_TraHang'; // save CTHD doi tra
    const lcProductKM_HoaDon = 'productKM_HoaDon';
    const lcDM_DoiTuong = 'DM_DoiTuongs'; // lst KH offline
    const lcCTDatHang_Const = 'lcCTDatHang';
    const lcSetPrintConst = "SetPrintBL";
    const lcXuLiDonHang_Const = 'lcXuLiDonHang';
    const nameHD_TraHang = 'Trả hàng '; // have space
    const nameHD_AddGoiDV = 'Gói DVụ ';
    const nameHD_UpdateDH = 'BG';
    const nameHD_InsertDH = 'Báo giá ';
    const nameHD_InsertBH = 'Hóa đơn ';
    const nameHD_InsertHDSC = 'Hóa đơn SC';

    function CheckHDNull_andRemove() {
        var lstHDFist = localStorage.getItem(lcListHD);
        if (lstHDFist === 'null') {
            localStorage.removeItem(lcListHD);
            localStorage.removeItem(lcListCTHD);
        }
    }
    function CheckCreateHD_fromOtherForm() {
        var addQuick = localStorage.getItem('InsertQuickly');
        if (addQuick !== null) {
            addQuick = parseInt(addQuick);
            localStorage.removeItem('InsertQuickly');
        }
        if (localStorage.getItem('fromTraHang') === 'true' || addQuick === 5) {
            localStorage.removeItem('fromTraHang');
            vmTraHang.ID_DonVi = id_DonVi;
            vmTraHang.LoaiHoaDon = self.HoaDons().LoaiHoaDon();
            vmTraHang.showModal();
        }
        else {
            var loaiHD = 0;
            if (localStorage.getItem('fromHoaDon') === 'true') {
                loaiHD = 1;
            }
            if (localStorage.getItem('fromDatHang') === 'true') {
                loaiHD = 3;
            }
            else {
                if (localStorage.getItem('fromGoiDichVu') === 'true') {
                    loaiHD = 19;
                }
            }
            var lstHD = localStorage.getItem(lcListHD);
            if (lstHD !== null) {
                lstHD = JSON.parse(lstHD);
            }
            else {
                lstHD = [];
            }
            var maHDNew = nameHD_InsertBH;
            switch (loaiHD) {
                case 1:
                    localStorage.removeItem('fromHoaDon');
                    break;
                case 3:
                    localStorage.removeItem('fromDatHang');
                    localStorage.removeItem(lcCTDatHang_Const);
                    localStorage.removeItem(lcXuLiDonHang_Const);
                    maHDNew = nameHD_InsertDH;
                    break;
                case 19:
                    localStorage.removeItem('fromGoiDichVu');
                    maHDNew = nameHD_AddGoiDV;
                    break;
            }
            if (loaiHD !== 0) {
                var max = GetMax_MaHoaDon(loaiHD, lstHD);
                var objHDNew = newHoaDon(loaiHD, max + 1);
                lstHD.push(objHDNew);
                localStorage.setItem(lcListHD, JSON.stringify(lstHD));
                self.HoaDons().MaHoaDon(maHDNew + (max + 1));
                localStorage.setItem(lcMaHD, self.HoaDons().MaHoaDon());
            }
        }
    }
    var initLoad = false;
    $(document).ready(function () {
        initLoad = true;
    });
    var db = new Dexie(_subDomain);
    db.version(1).stores({
        DM_DoiTuong: 'ID, Name_Phone',
        DM_HangHoa: 'ID, Name',
        NS_NhanVien: '++id',
        DM_GiaBan: 'ID',
        HDDatHang_UpdateStatus: 'ID, Status',
        HDDatHang_Offline: 'ID',
        HeThongTichDiem: 'ID_TichDiem',
        DM_MauIn: 'ID',
        Quyen_NguoiDung: '++id',
        HT_NguoiDung: 'ID',
        DM_QuanHuyen: 'ID',
        DM_LoHang: '++id',
        DM_DonVi: 'ID',
        KhachHang_HangHoa: 'ID_DoiTuong',
        ChietKhau_NhanVien: '++id',
        DM_KhuyenMai: 'ID',
        DM_TaiKhoanNganHang: 'ID',
        DM_NhanVienLienQuan: '++id',
        DM_ViTri: 'ID',
        DM_KhuVuc: 'ID',
        DM_DoiTuong_TrangThai: 'ID',
        DinhLuong_DichVu: 'ID',
    });
    db.version(21).stores({ DM_NhanVienLienQuan: null });
    var t;
    var now = serverTime;
    var date = now.getDate();
    if (date < 10) {
        date = '0' + date;
    }
    var month = now.getMonth() + 1;
    if (month < 10) {
        month = '0' + month;
    }
    day = date + "/" + month + "/" + now.getFullYear();
    function timer() {
        var currentTime = sstime.GetDatetime();
        var hours = currentTime.getHours();
        var minutes = currentTime.getMinutes()
        var sec = currentTime.getSeconds();
        if (hours < 10) {
            hours = "0" + hours;
        }
        if (minutes < 10) {
            minutes = "0" + minutes;
        }
        if (sec < 10) {
            sec = "0" + sec;
        }
        var t_str = hours + ":" + minutes;
        t = setTimeout(timer, 1000);
        self.DateHDDefault(day);
        self.TimeHDDefault(t_str);
    }
    function stopTimer() {
        clearTimeout(t);
    }
    // auto DongBoHoa HoaDon and update Status for HD DatHang
    var timeDongBo;
    function AutoUpdate_StatusHD_AndDongBoHoa() {
        timeDongBo = setTimeout(AutoUpdate_StatusHD_AndDongBoHoa, 5 * 1000 * 60); // 5 phut, load 1 lan
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            lstHD = lstHD.filter(x => x.StatusOffline === true);
            if (lstHD.length > 0) {
                UpdateStatus_HDDatHang();
                $('#btnDongBoHoa').trigger('click');
            }
        }
    }
    //window.open('', '_self', '').close();
    //AutoUpdate_StatusHD_AndDongBoHoa();
    function PageLoad() {
        GetUserCookies();
        GetListIDNhanVien_byUserLogin('KhachHang');
        GetNhanVien_NguoiDung();
        GetDMGiaBan_GBApDung();
        GetHT_Quyen_ByNguoiDung();
        GetHT_TichDiem();
        GetInforChiNhanh();
        GetKM_CTKhuyenMai();
        GetDM_TaiKhoanNganHang();
        GetListTrangThaiKhachHang();
        Call_ManyFunction_Onsuccess();
        CheckHDNull_andRemove();
        RemoveHD_undefinedTrangThai();
        UpdateDonVi_inCacheOld();
        CheckCreateHD_fromOtherForm();
        SetPageSize_FullProduct(true);
        GetTree_NhomHangHoa();
        GetCauHinhHeThong();
        Call_ManyFunctionDB_PageLoad();
        GetAllQuy_KhoanThuChi();
    }

    function CheckCache(funcName) {
        funcName = funcName + ': ';
        var cthd = localStorage.getItem(lcListCTHD);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);

            var xx = $.map(cthd, function (x) {
                return {
                    IDRandomHD: x.IDRandomHD,
                    IDRandom: x.IDRandom,
                    MaHoaDon: x.MaHoaDon,
                    TenHangHoa: x.TenHangHoa,
                    MaHangHoa: x.MaHangHoa,
                    SoLuong: x.SoLuong,
                    DonGia: x.DonGia,
                    ThanhTien: x.ThanhTien,
                    IDQuiDoi: x.ID_DonViQuiDoi,
                    ID_LoHang: x.ID_LoHang,
                    ID: x.ID,
                }
            });
            console.log(funcName, xx);
        }
        else {
            console.log(funcName, ' null');
        }
    }

    // use delete cache khong hop le
    function RemoveHD_undefinedTrangThai() {
        var arrIDRandom = [];
        var hd = localStorage.getItem(lcListHD);
        if (hd === null) {
            hd = [];
        }
        else {
            hd = JSON.parse(hd);
            hd = $.grep(hd, function (x) {
                return x.TrangThaiHD !== undefined;
            });
            for (let i = 0; i < hd.length; i++) {
                arrIDRandom.push(hd[i].IDRandom);
                if (hd[i].DiemGiaoDichDB === undefined) {
                    hd[i].DiemGiaoDichDB = 0;
                }
                if (hd[i].MaHoaDonDB === undefined) {
                    hd[i].MaHoaDonDB = hd[i].MaHoaDon;
                }
                if (hd[i].PhaiThanhToanDB === undefined) {
                    hd[i].PhaiThanhToanDB = 0;
                }
                if (hd[i].SoDuDatCoc === undefined) {
                    hd[i].SoDuDatCoc = 0;
                }

                if (hd[i].PTThueHoaDon === undefined) {
                    if (!commonStatisJs.CheckNull(hd[i].PTThue)) {
                        hd[i].PTThueHoaDon = hd[i].PTThue;
                    }
                    else {
                        hd[i].PTThueHoaDon = 0;
                    }
                }
                if (hd[i].KhauTruTheoVu === undefined) {
                    hd[i].KhauTruTheoVu = 0;
                }
                if (hd[i].GiamTruBoiThuong === undefined) {
                    hd[i].GiamTruBoiThuong = 0;
                }
                if (hd[i].PTGiamTruBoiThuong === undefined) {
                    hd[i].PTGiamTruBoiThuong = 0;
                }
                if (hd[i].TongTienThueBaoHiem === undefined) {
                    hd[i].TongTienThueBaoHiem = 0;
                }
                if (hd[i].PTThueBaoHiem === undefined) {
                    hd[i].PTThueBaoHiem = 0;
                }
                if (hd[i].BHThanhToanTruocThue === undefined) {
                    hd[i].BHThanhToanTruocThue = 0;
                }
                if (hd[i].TongTienBHDuyet === undefined) {
                    hd[i].TongTienBHDuyet = 0;
                }
                if (commonStatisJs.CheckNull(hd[i].PTThueKhachHang)) {
                    hd[i].PTThueKhachHang = hd[i].PTThueHoaDon;
                }
                if (commonStatisJs.CheckNull(hd[i].TongThueKhachHang)) {
                    hd[i].TongThueKhachHang = hd[i].TongTienThue;
                }
                if (commonStatisJs.CheckNull(hd[i].CongThucBaoHiem)) {
                    hd[i].CongThucBaoHiem = 0;
                }
                if (commonStatisJs.CheckNull(hd[i].GiamTruThanhToanBaoHiem)) {
                    hd[i].GiamTruThanhToanBaoHiem = 0;
                }
                if (commonStatisJs.CheckNull(hd[i].HeaderBH_GiaTriPtram)) {
                    hd[i].HeaderBH_GiaTriPtram = 0;
                }
                if (commonStatisJs.CheckNull(hd[i].HeaderBH_Type)) {
                    hd[i].HeaderBH_Type = 1;
                }
                if (commonStatisJs.CheckNull(hd[i].BienSo)) {
                    hd[i].BienSo = '';
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(hd));
        }
        var cthd = localStorage.getItem(lcListCTHD);
        if (cthd === null) {
            cthd = [];
        }
        else {
            cthd = JSON.parse(cthd);
            cthd = $.grep(cthd, function (x) {
                return $.inArray(x.IDRandomHD, arrIDRandom) > -1;
            });

            for (let i = 0; i < cthd.length; i++) {
                if (cthd[i].DuocTichDiem === undefined) {
                    cthd[i].DuocTichDiem = 1;
                    cthd[i].DichVuTheoGio = 0;
                }
                if (cthd[i].TenHangHoaThayThe === undefined) {
                    cthd[i].TenHangHoaThayThe = cthd[i].TenHangHoa;
                }
                if (cthd[i].DonGiaBaoHiem === undefined) {
                    cthd[i].DonGiaBaoHiem = 0;
                }
                if (commonStatisJs.CheckNull(cthd[i].ID_LichBaoDuong)) {
                    cthd[i].ID_LichBaoDuong = null;
                }
                if (commonStatisJs.CheckNull(cthd[i].ThanhPhanComBo)) {
                    cthd[i].ThanhPhanComBo = [];
                }
                for (let j = 0; j < cthd[i].ThanhPhan_DinhLuong.length; j++) {
                    if (commonStatisJs.CheckNull(cthd[i].ThanhPhan_DinhLuong[j].isDefault)) {
                        cthd[i].ThanhPhan_DinhLuong[j].isDefault = false;
                    }
                }
                for (let j = 0; j < cthd[i].ThanhPhanComBo.length; j++) {
                    for (let k = 0; k < cthd[i].ThanhPhanComBo[j].ThanhPhan_DinhLuong.length; k++) {
                        if (commonStatisJs.CheckNull(cthd[i].ThanhPhanComBo[j].ThanhPhan_DinhLuong[k].isDefault)) {
                            cthd[i].ThanhPhanComBo[j].ThanhPhan_DinhLuong[k].isDefault = false;
                        }
                    }
                }
                if (commonStatisJs.CheckNull(cthd[i].LoaiHangHoa)) {
                    if (cthd[i].LaHangHoa) {
                        cthd[i].LoaiHangHoa = 1;
                    }
                    else {
                        cthd[i].LoaiHangHoa = 2;
                    }
                }

                for (let j = 0; j < cthd[i].DM_LoHang.length; j++) {
                    if (cthd[i].DM_LoHang[j].TenHangHoaThayThe === undefined) {
                        cthd[i].DM_LoHang[j].TenHangHoaThayThe = cthd[i].DM_LoHang[j].TenHangHoa;
                    }
                    if (cthd[i].DM_LoHang[j].DonGiaBaoHiem === undefined) {
                        cthd[i].DM_LoHang[j].DonGiaBaoHiem = 0;
                    }
                    if (commonStatisJs.CheckNull(cthd[i].DM_LoHang[j].ID_LichBaoDuong)) {
                        cthd[i].DM_LoHang[j].ID_LichBaoDuong = null;
                    }
                    if (commonStatisJs.CheckNull(cthd[i].DM_LoHang[j].LoaiHangHoa)) {
                        cthd[i].DM_LoHang[j].LoaiHangHoa = 1;
                    }
                    cthd[i].DM_LoHang[j].ThanhPhanComBo = [];
                }
                for (let j = 0; j < cthd[i].HangCungLoais.length; j++) {
                    if (cthd[i].HangCungLoais[j].TenHangHoaThayThe === undefined) {
                        cthd[i].HangCungLoais[j].TenHangHoaThayThe = cthd[i].HangCungLoais[j].TenHangHoa;
                    }
                    if (cthd[i].HangCungLoais[j].DonGiaBaoHiem === undefined) {
                        cthd[i].HangCungLoais[j].DonGiaBaoHiem = 0;
                    }
                    if (commonStatisJs.CheckNull(cthd[i].HangCungLoais[j].ID_LichBaoDuong)) {
                        cthd[i].HangCungLoais[j].ID_LichBaoDuong = null;
                    }
                    if (commonStatisJs.CheckNull(cthd[i].HangCungLoais[j].LoaiHangHoa)) {
                        if (cthd[i].HangCungLoais[j].LaHangHoa) {
                            cthd[i].HangCungLoais[j].LoaiHangHoa = 1;
                        }
                        else {
                            cthd[i].HangCungLoais[j].LoaiHangHoa = 2;
                        }
                    }
                    cthd[i].HangCungLoais[j].ThanhPhanComBo = [];
                }
            }
            localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
        }
    }

    function UpdateDonVi_inCacheOld() {
        id_DonVi = id_DonVi.toLowerCase();

        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);

            for (let i = 0; i < lstHD.length; i++) {
                let forIn = lstHD[i];
                if (forIn.ID_DonVi.toLowerCase() !== id_DonVi) {
                    if (forIn.MaHoaDon.indexOf('Copy') === -1 && forIn.ID === const_GuidEmpty
                        && commonStatisJs.CheckNull(forIn.ID_HoaDon)) {
                        forIn.ID_DonVi = id_DonVi;
                    }
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(lstHD));
        }
    }

    function ResetPhieuTiepNhan_ifOtherChiNhanh() {
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);

            for (let i = 0; i < lstHD.length; i++) {
                let forIn = lstHD[i];
                if (forIn.IDRandom === self.HoaDons().IDRandom()) {
                    if (forIn.ID_DonVi.toLowerCase() !== self.ThongTinPhieuTiepNhan().ID_DonVi.toLowerCase()) {
                        Reset_PhieuTiepNhan();
                        UpdateCacheHDLe(forIn.IDRandom, false);
                        BindHD_byIDRandom(forIn.IDRandom);
                        self.HoaDons().HeaderBH_GiaTriPtram(0);
                    }
                    break;
                }
            }
        }
    }

    function UpdateTonKhoCTHD_FirstLoad(cacheName) {
        var cthd = localStorage.getItem(cacheName);
        if (cthd != null) {
            cthd = JSON.parse(cthd);

            var loaiHD = 1;
            if (cthd.length > 0) {
                loaiHD = cthd[0].LoaiHoaDon;
            }
            var xuatAm = true;
            switch (loaiHD) {
                case 1:
                    xuatAm = self.ThietLap().XuatAm;
                    break;
                case 3:
                    xuatAm = self.ThietLap().DatHangXuatAm;
                    break;
            }

            let cthd_LaHH = $.grep(cthd, function (x) {
                return x.LaHangHoa;
            })
            let arrIDQuiDoi = $.unique(cthd_LaHH.map(function (x) {
                return x.ID_DonViQuiDoi;
            }).sort());

            let arrIDLoHang = cthd_LaHH.filter(o => o.QuanLyTheoLoHang).map(function (x) {
                return x.ID_LoHang;
            });

            // idquidoi of combo
            for (let i = 0; i < cthd.length; i++) {
                let forOut = cthd[i];
                if (!commonStatisJs.CheckNull(forOut.ThanhPhanComBo) && forOut.ThanhPhanComBo.length > 0) {
                    for (let j = 0; j < forOut.ThanhPhanComBo.length; j++) {
                        let forIn = forOut.ThanhPhanComBo[j];
                        if (forIn.LoaiHangHoa === 1) {
                            arrIDQuiDoi.push(forIn.ID_DonViQuiDoi);
                            if (forIn.QuanLyTheoLoHang) {
                                arrIDLoHang.push(forIn.ID_LoHang);
                            }
                        }
                    }
                }
            }

            arrIDLoHang = $.unique($.grep(arrIDLoHang, function (x) {
                return x !== null;
            }).sort());

            if (arrIDQuiDoi.length === 0) {
                return;
            }

            var param = {
                ID_ChiNhanh: id_DonVi,
                ToDate: moment(new Date()).format('YYYY-MM-DD HH:mm'),
                ListIDQuyDoi: arrIDQuiDoi,
                ListIDLoHang: arrIDLoHang,
            }
            ajaxHelper(DMHangHoaUri + 'GetTonKho_byIDQuyDois', 'POST', param).done(function (x) {
                if (x.res) {
                    let data = x.data;
                    for (let j = 0; j < cthd.length; j++) {
                        let forOut = cthd[j];
                        let isUpdate = false;
                        if (forOut.MaHoaDon.indexOf('HD') === 0) {
                            isUpdate = true;
                        }
                        if (forOut.LaHangHoa) {
                            let dataDB = $.grep(data, function (o) {
                                return o.ID_DonViQuiDoi === forOut.ID_DonViQuiDoi
                                    && (!forOut.QuanLyTheoLoHang || (o.ID_LoHang === forOut.ID_LoHang))
                            });
                            if (dataDB.length > 0) {
                                cthd[j].TonKho = dataDB[0].TonKho + (isUpdate ? cthd[j].SoLuong : 0);
                            }
                            cthd[j].CssWarning = xuatAm === false && cthd[j].TonKho < forOut.SoLuong;

                            for (let k = 0; k < cthd[j].DM_LoHang.length; k++) {
                                let forIn = cthd[j].DM_LoHang[k];
                                let dataDB2 = $.grep(data, function (o) {
                                    return o.ID_DonViQuiDoi === forIn.ID_DonViQuiDoi
                                        && (!forIn.QuanLyTheoLoHang || (o.ID_LoHang === forIn.ID_LoHang))
                                });
                                if (dataDB2.length > 0) {
                                    cthd[j].DM_LoHang[k].TonKho = dataDB2[0].TonKho + (isUpdate ? cthd[j].DM_LoHang[k].SoLuong : 0);
                                }
                                cthd[j].DM_LoHang[k].CssWarning = xuatAm === false && cthd[j].DM_LoHang[k].TonKho < forIn.SoLuong;
                            }
                            for (let k = 0; k < cthd[j].HangCungLoais.length; k++) {
                                cthd[j].HangCungLoais[k].TonKho = cthd[j].TonKho;
                                cthd[j].HangCungLoais[k].CssWarning = cthd[j].CssWarning;
                            }
                        }

                        for (let k = 0; k < cthd[j].ThanhPhanComBo.length; k++) {
                            let forIn = cthd[j].ThanhPhanComBo[k];
                            let dataDB2 = $.grep(data, function (o) {
                                return o.ID_DonViQuiDoi === forIn.ID_DonViQuiDoi
                                    && (!forIn.QuanLyTheoLoHang || (o.ID_LoHang === forIn.ID_LoHang))
                            });
                            if (dataDB2.length > 0) {
                                cthd[j].ThanhPhanComBo[k].TonKho = dataDB2[0].TonKho + (isUpdate ? cthd[j].ThanhPhanComBo[k].SoLuong : 0);
                            }
                            cthd[j].ThanhPhanComBo[k].CssWarning = xuatAm === false && cthd[j].ThanhPhanComBo[k].TonKho < forIn.SoLuong;
                        }
                    }
                    localStorage.setItem(cacheName, JSON.stringify(cthd));
                }
            })
        }
    }
    function GetNhomDoiTuong_DonVi() {
        ajaxHelper(DMDoiTuongUri + 'GetNhomDoiTuong_DonVi?loaiDT=1', 'GET').done(function (obj) {
            if (obj.res === true) {
                let data = obj.data;
                if (self.ThietLap().QuanLyKhachHangTheoDonVi) {
                    // only get Nhom chua cai dat ChiNhanh or in this ChiNhanh
                    var arrNhom = [];
                    for (let i = 0; i < data.length; i++) {
                        if (data[i].NhomDT_DonVi.length > 0) {
                            var ex = $.grep(data[i].NhomDT_DonVi, function (x) {
                                return x.ID === id_DonVi;
                            });
                            if (ex.length) {
                                arrNhom.push(data[i]);
                            }
                        }
                        else {
                            arrNhom.push(data[i]);
                        }
                    }
                    self.NhomDoiTuongDB(arrNhom);
                }
                else {
                    self.NhomDoiTuongDB(data);
                }
            }
        });
    }
    // changeChiNhanh: don't need load again this func
    function Call_ManyFunctionDB_PageLoad() {
        ajaxHelper(BHHoaDonUri + "BanHang_ManyFunctionDB_PageLoad?idChiNhanh=" + id_DonVi, 'GET').done(function (obj) {
            if (obj.res === true) {
                self.TinhThanhs(obj.TinhThanh);
                self.NguonKhachs(obj.NguonKhach);
                self.CongTy(obj.CongTy);
                self.ChotSo_ChiNhanh(obj.ChotSo);
                self.VungMiens(obj.VungMien);
                self.ThietLap_TraHang(obj.CauHinhTraHang);

                vmThanhToan.ThietLapChotSo = obj.ChotSo;
                vmThemMoiKhach.listData.NguonKhachs = obj.NguonKhach;
                vmThemMoiNhomKhach.listData.VungMiens = obj.VungMien;
            }
        });
    }

    function GetNhomDoiTuong_DonVi() {
        ajaxHelper(DMDoiTuongUri + 'GetNhomDoiTuong_DonVi?loaiDT=1', 'GET').done(function (obj) {
            if (obj.res === true) {
                let data = obj.data;
                if (self.ThietLap().QuanLyKhachHangTheoDonVi) {
                    // only get Nhom chua cai dat ChiNhanh or in this ChiNhanh
                    var arrNhom = [];
                    for (let i = 0; i < data.length; i++) {
                        if (data[i].NhomDT_DonVi.length > 0) {
                            var ex = $.grep(data[i].NhomDT_DonVi, function (x) {
                                return x.ID === id_DonVi;
                            });
                            if (ex.length) {
                                arrNhom.push(data[i]);
                            }
                        }
                        else {
                            arrNhom.push(data[i]);
                        }
                    }
                    self.NhomDoiTuongDB(arrNhom);
                    vmThemMoiKhach.listData.NhomKhachs = arrNhom;
                    vmThemMoiKhach.QuanLyKhachHangTheoDonVi = true;
                }
                else {
                    self.NhomDoiTuongDB(data);
                    vmThemMoiKhach.listData.NhomKhachs = data;
                    vmThemMoiKhach.QuanLyKhachHangTheoDonVi = false;
                }
            }
        });
    }

    function AssignCTHD_ChoThanhToan(cthdDB, cacheCTHD, idRandomHD, maHoaDon) {
        // order by SoThuTu ASC --> group Hang Hoa by LoHang
        var arrCTsort = cthdDB.sort(function (a, b) {
            var x = a.SoThuTu,
                y = b.SoThuTu;
            return x < y ? -1 : x > y ? 1 : 0;
        });
        var arrIDQuiDoi = [];
        for (let i = 0; i < arrCTsort.length; i++) {
            // if TangKem of HangHoa --> not push CTHD
            if (arrCTsort[i].ID_TangKem !== null) {
                continue;
            }
            arrCTsort[i].IDRandomHD = idRandomHD;
            arrCTsort[i].MaHoaDon = maHoaDon;
            arrCTsort[i].LoaiHoaDon = 1;
            arrCTsort[i].SoLuongDaMua = 0;
            arrCTsort[i].TienChietKhau = arrCTsort[i].GiamGia;
            arrCTsort[i].DVTinhGiam = '%';
            arrCTsort[i].GiaBan = arrCTsort[i].DonGia;
            // get ThanhTien from DB
            arrCTsort[i].ChatLieu = '';
            if (arrCTsort[i].ID_ChiTietGoiDV !== null) {
                arrCTsort[i].ChatLieu = '4';
            }
            if (arrCTsort[i].TienChietKhau > 0 && arrCTsort[i].PTChietKhau === 0) {
                arrCTsort[i].DVTinhGiam = 'VND';
            }
            arrCTsort[i].SrcImage = null;
            arrCTsort[i].CssWarning = false;
            arrCTsort[i].IsKhuyenMai = false;
            arrCTsort[i].IsOpeningKMai = false;
            arrCTsort[i].DiemKhuyenMai = 0;
            arrCTsort[i].TenKhuyenMai = '';
            arrCTsort[i].HangHoa_KM = [];
            arrCTsort[i].HangCungLoais = [];
            arrCTsort[i].LaConCungLoai = false;
            // get ID_ChiTietDinhLuong, ID_ChiTietGoiDV from DB
            //arrCTsort[i].UsingService = false;
            arrCTsort[i].ListDonViTinh = [];
            arrCTsort[i].ShowWarningQuyCach = false;
            arrCTsort[i].SoLuongQuyCach = 0;
            let idVitri = arrCTsort[i].ID_ViTri;
            if (idVitri === const_GuidEmpty) arrCTsort[i].ID_ViTri = null;
            let dtStart = arrCTsort[i].ThoiGian;
            arrCTsort[i].TimeStart = 0;
            arrCTsort[i].TimeRemain = 0;
            arrCTsort[i].QuaThoiGian = 0;
            arrCTsort[i].SoPhutThucHien = arrCTsort[i].SoPhutThucHien === null ? 0 : arrCTsort[i].SoPhutThucHien;

            if (arrCTsort[i].LaHangHoa === false && arrCTsort[i].ThoiGianHoanThanh !== null) {
                arrCTsort[i].TimeStart = moment(dtStart).format('HH:mm');
                // tinh so phut da dung
                let daSD = getMinutesBetweenDates(dtStart, new Date());
                let conlai = arrCTsort[i].SoPhutThucHien - daSD;
                if (conlai > 0) {
                    arrCTsort[i].TimeRemain = conlai;// thoigian (setup) - thoigian(used)
                    arrCTsort[i].QuaThoiGian = 0;
                }
                else {
                    arrCTsort[i].TimeRemain = 0;
                    arrCTsort[i].QuaThoiGian = conlai;
                }
                arrCTsort[i].ThoiGianThucHien = arrCTsort[i].SoPhutThucHien;// assign ThoiGianThucHien = SoPhuThucHie (setup) --> bind in list SoDo
            }
            arrCTsort[i].ThoiGian = moment(dtStart).format('YYYY-MM-DD HH:mm');
            // lo hang
            let quanLiTheoLo = false;
            let idLoHang = arrCTsort[i].ID_LoHang;
            if (idLoHang !== null && idLoHang !== '00000000-0000-0000-0000-000000000000') {
                quanLiTheoLo = true;
            }
            arrCTsort[i].QuanLyTheoLoHang = quanLiTheoLo;
            arrCTsort[i].DM_LoHang = [];
            arrCTsort[i].ID_LoHang = idLoHang;
            arrCTsort[i].LotParent = quanLiTheoLo;
            // PhiDichVu, LaPTPhiDichVu (get from DB store)
            arrCTsort[i].TongPhiDichVu = arrCTsort[i].SoLuong * arrCTsort[i].PhiDichVu;
            if (arrCTsort[i].LaPTPhiDichVu) {
                arrCTsort[i].TongPhiDichVu = Math.round(arrCTsort[i].PhiDichVu * arrCTsort[i].SoLuong * arrCTsort[i].GiaBan / 100);
            }
            // check exist in cacheCTHD
            if ($.inArray(arrCTsort[i].ID_DonViQuiDoi, arrIDQuiDoi) === -1) {
                arrIDQuiDoi.unshift(arrCTsort[i].ID_DonViQuiDoi);
                // get MaLoHang from DB
                arrCTsort[i].IDRandom = CreateIDRandom('CTHD_');
                if (quanLiTheoLo) {
                    // push DM_Lo
                    let objLot = $.extend({}, arrCTsort[i]);
                    objLot.DM_LoHang = [];
                    objLot.HangCungLoais = [];
                    objLot.ThanhPhan_DinhLuong = [];
                    objLot.BH_NhanVienThucHien = [];
                    arrCTsort[i].DM_LoHang.push(objLot);
                }
                // USE FOR SPA (add BH_NhanVienThucHien)
                var nvThuHienOld = arrCTsort[i].BH_NhanVienThucHien;
                // remove BH_NhanVienThucHien old, and add again
                arrCTsort[i].BH_NhanVienThucHien = [];
                if (nvThuHienOld !== null) {
                    let lstNV_TH = '';
                    let lstNV_TV = '';
                    let lstNV_TH_Print = '';
                    let lstNV_TV_Print = '';
                    for (let j = 0; j < nvThuHienOld.length; j++) {
                        let itemFor = nvThuHienOld[j];
                        let isNVThucHien = itemFor.ThucHien_TuVan;
                        let tienCK = itemFor.TienChietKhau;
                        let gtriPtramCK = itemFor.PT_ChietKhau;
                        let isPTram = gtriPtramCK > 0 ? true : false;
                        let gtriCK_TH = 0;
                        let gtriCK_TV = 0;
                        let tacVu = 1;
                        let ckMacDinh = gtriPtramCK;
                        if (isNVThucHien) {
                            if (itemFor.TheoYeuCau) {
                                tacVu = 3;  // thuchien theo yeucau
                            }
                            else {
                                tacVu = 1;
                            }
                            if (isPTram) {
                                gtriCK_TH = gtriPtramCK;
                                lstNV_TH += itemFor.TenNhanVien + ' (' + gtriCK_TH + ' %), ';
                            }
                            else {
                                gtriCK_TH = tienCK;
                                lstNV_TH += itemFor.TenNhanVien + ' (' + formatNumber3Digit(gtriCK_TH) + ' đ), ';
                                ckMacDinh = tienCK / itemFor.HeSo / arrCTsort[i].SoLuong;
                            }
                            lstNV_TH_Print += itemFor.TenNhanVien + ', ';
                        }
                        else {
                            tacVu = 2;
                            if (isPTram) {
                                gtriCK_TV = gtriPtramCK;
                                lstNV_TV += itemFor.TenNhanVien + ' (' + gtriCK_TV + ' %), ';
                            }
                            else {
                                gtriCK_TV = tienCK;
                                lstNV_TV += itemFor.TenNhanVien + ' (' + formatNumber3Digit(gtriCK_TV) + ' đ), ';
                                ckMacDinh = tienCK / itemFor.HeSo / arrCTsort[i].SoLuong;
                            }
                            lstNV_TV_Print += itemFor.TenNhanVien + ', ';
                        }
                        let idRandom = CreateIDRandom('IDRandomCK_');
                        let itemNV = {
                            IDRandom: idRandom,
                            ID_NhanVien: itemFor.ID_NhanVien,
                            TenNhanVien: itemFor.TenNhanVien,
                            ThucHien_TuVan: isNVThucHien,
                            TienChietKhau: tienCK,
                            PT_ChietKhau: gtriPtramCK,
                            TheoYeuCau: false,
                            TacVu: tacVu,
                            HeSo: itemFor.HeSo,
                            ChietKhauMacDinh: ckMacDinh,
                            TinhChietKhauTheo: itemFor.TinhChietKhauTheo,
                        };
                        arrCTsort[i].BH_NhanVienThucHien.push(itemNV);
                    }
                    // to do assign GhiChu_NVThucHien
                    arrCTsort[i].GhiChu_NVThucHien = (lstNV_TH === '' ? '' : 'Thực hiện: ' + Remove_LastComma(lstNV_TH));
                    arrCTsort[i].GhiChu_NVTuVan = (lstNV_TV === '' ? '' : 'Tư vấn: ' + Remove_LastComma(lstNV_TV));
                    arrCTsort[i].GhiChu_NVThucHienPrint = (lstNV_TH_Print === '' ? '' : Remove_LastComma(lstNV_TH_Print));
                    arrCTsort[i].GhiChu_NVTuVanPrint = (lstNV_TV_Print === '' ? '' : Remove_LastComma(lstNV_TV_Print));
                }
                else {
                    arrCTsort[i].GhiChu_NVTuVan = ''
                    arrCTsort[i].GhiChu_NVTuVanPrint = '';
                    arrCTsort[i].GhiChu_NVThucHien = '';
                    arrCTsort[i].GhiChu_NVThucHienPrint = '';
                }
                // assign TP_DinhLuong for CTHD
                if (arrCTsort[i].ThanhPhan_DinhLuong !== null && arrCTsort[i].ThanhPhan_DinhLuong !== undefined) {
                    for (let k = 0; k < arrCTsort[i].ThanhPhan_DinhLuong.length; k++) {
                        let tpDL = arrCTsort[i].ThanhPhan_DinhLuong[k];
                        arrCTsort[i].ThanhPhan_DinhLuong[k].STT = k + 1;
                        arrCTsort[i].ThanhPhan_DinhLuong[k].isDefault = false;
                        arrCTsort[i].ThanhPhan_DinhLuong[k].IDRandom = CreateIDRandom('TPDL_');
                        arrCTsort[i].ThanhPhan_DinhLuong[k].SoLuongQuyCach = tpDL.SoLuong * tpDL.QuyCach;
                        arrCTsort[i].ThanhPhan_DinhLuong[k].SoLuongMacDinh = 1 / arrCTsort[i].SoLuong;
                        arrCTsort[i].ThanhPhan_DinhLuong[k].GiaVonAfter = tpDL.SoLuong * tpDL.GiaVon;
                    }
                }
                else {
                    arrCTsort[i].ThanhPhan_DinhLuong = [];
                }
                cacheCTHD.push(arrCTsort[i]);
            }
            else {
                // find in cacheCTHD with same ID_QuiDoi
                for (let j = 0; j < cacheCTHD.length; j++) {
                    if (cacheCTHD[j].MaHoaDon === maHoaDon && cacheCTHD[j].ID_DonViQuiDoi === arrCTsort[i].ID_DonViQuiDoi) {
                        if (quanLiTheoLo) {
                            let objLot = $.extend({}, arrCTsort[i]);
                            objLot.LotParent = false;
                            objLot.IDRandom = CreateIDRandom('DMLo_');
                            objLot.DM_LoHang = [];
                            objLot.HangCungLoais = [];
                            objLot.ThanhPhan_DinhLuong = [];
                            objLot.BH_NhanVienThucHien = [];
                            cacheCTHD[j].DM_LoHang.push(objLot);
                        }
                        else {
                            arrCTsort[i].IDRandomHD = idRandomHD;
                            arrCTsort[i].IDRandom = CreateIDRandom('RandomCT');
                            arrCTsort[i].LaConCungLoai = true;
                            arrCTsort[i].GhiChu_NVTuVan = ''
                            arrCTsort[i].GhiChu_NVTuVanPrint = '';
                            arrCTsort[i].GhiChu_NVThucHien = '';
                            arrCTsort[i].GhiChu_NVThucHienPrint = '';
                            arrCTsort[i].ThanhPhan_DinhLuong = [];
                            cacheCTHD[j].HangCungLoais.push(arrCTsort[i]);
                        }
                        break;
                    }
                }
            }
        }
        // sort CTHD by SoThuTu desc
        cacheCTHD = cacheCTHD.sort(function (a, b) {
            var x = a.SoThuTu, y = b.SoThuTu;
            return x < y ? 1 : x > y ? -1 : 0;
        });
        return cacheCTHD;
    }
    function SetDefaultPropertierCTHD(itemCT) {
        itemCT.IsKhuyenMai = false;
        itemCT.IsOpeningKMai = false;
        itemCT.TenKhuyenMai = '';
        itemCT.HangHoa_KM = [];
        itemCT.DiemKhuyenMai = 0;
        itemCT.GhiChu_NVThucHien = '';
        itemCT.BH_NhanVienThucHien = [];
        itemCT.GhiChu_NVTuVan = '';
        itemCT.GhiChu_NVThucHienPrint = ''; // used to printHoaDon (not show %ChietKhau)
        itemCT.GhiChu_NVTuVanPrint = '';
        itemCT.ListDonViTinh = [];
        itemCT.ShowWarningQuyCach = false;
        itemCT.SoLuongQuyCach = 0;
        itemCT.HangCungLoais = [];
        itemCT.LaConCungLoai = false;
        itemCT.ID_ViTri = null;
        itemCT.TenViTri = '';
        itemCT.TimeStart = 0;
        itemCT.QuaThoiGian = 0;
        itemCT.TimeRemain = 0;
        itemCT.ThoiGianThucHien = 0;
        itemCT.ThoiGian = moment(new Date()).format('YYYY-MM-DD HH:mm');
        return itemCT;
    }
    function CountTableUsed() {
        var totalTable = self.AllPhongBans().length;
        var ctHaveViTri = [];
        var arrID = [];
        var cthd = localStorage.getItem(lcListCTHD);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            for (let i = 0, k = cthd.length; i < k; i++) {
                if (cthd[i].ID_ViTri !== null) {
                    ctHaveViTri.push(cthd[i]);
                }
                // find in HangCungLoai
                for (let j = 0; j < cthd[i].HangCungLoais.length; j++) {
                    if (cthd[i].HangCungLoais[j].ID_ViTri !== null) {
                        ctHaveViTri.push(cthd[i].HangCungLoais[j]);
                    }
                }
                // find in DMLoHang
                for (let j = 0; j < cthd[i].DM_LoHang.length; j++) {
                    if (cthd[i].DM_LoHang[j].ID_ViTri !== null) {
                        ctHaveViTri.push(cthd[i].DM_LoHang[j]);
                    }
                }
            }
        }
        // find in cthd
        for (let i = 0; i < ctHaveViTri.length; i++) {
            if ($.inArray(ctHaveViTri[i].ID_ViTri, arrID) === -1) {
                arrID.push(ctHaveViTri[i].ID_ViTri);
            }
        }
        var ctDoiTra = localStorage.getItem(lcListCTHD_DoiTra);
        if (ctDoiTra !== null) {
            ctDoiTra = JSON.parse(ctDoiTra);
            ctHaveViTri = [];// reset & push again
            for (let i = 0, k = ctDoiTra.length; i < k; i++) {
                if (ctDoiTra[i].ID_ViTri !== null) {
                    ctHaveViTri.push(ctDoiTra[i]);
                }
                // find in HangCungLoai
                for (let j = 0; j < ctDoiTra[i].HangCungLoais.length; j++) {
                    if (ctDoiTra[i].HangCungLoais[j].ID_ViTri !== null) {
                        ctHaveViTri.push(ctDoiTra[i].HangCungLoais[j]);
                    }
                }
                // find in DMLoHang
                for (let j = 0; j < ctDoiTra[i].DM_LoHang.length; j++) {
                    if (ctDoiTra[i].DM_LoHang[j].ID_ViTri !== null) {
                        ctHaveViTri.push(ctDoiTra[i].DM_LoHang[j]);
                    }
                }
            }
            // find in cthd_doitra
            for (let i = 0; i < ctHaveViTri.length; i++) {
                if ($.inArray(ctHaveViTri[i].ID_ViTri, arrID) === -1) {
                    arrID.push(ctHaveViTri[i].ID_ViTri);
                }
            }
        }
        var countUsed = arrID.length;
        self.NumberTableUsed(countUsed);
        self.NumberTableEmpty(totalTable - countUsed);
    }
    function Add_NewProperties_CTHD() {
        var lstHDLe = localStorage.getItem(lcListHD);
        var cthdLe = localStorage.getItem(lcListCTHD);
        if (lstHDLe !== null) {
            lstHDLe = JSON.parse(lstHDLe);
            if (cthdLe !== null) {
                cthdLe = JSON.parse(cthdLe);
                for (let i = 0; i < cthdLe.length; i++) {
                    if (cthdLe[i].HangCungLoais === undefined) {
                        cthdLe[i].HangCungLoais = [];
                        cthdLe[i].LaConCungLoai = false;
                        cthdLe[i].ChatLieu = '';
                    }
                }
                localStorage.setItem(lcListCTHD, JSON.stringify(cthdLe));
            }
        }
    };

    // used when update hoadon
    function ChiPhiDV_updateIDRandomHD(idRandom, idHoaDon) {
        let cacheCP = localStorage.getItem('lcChiPhi');
        if (cacheCP !== null) {
            cacheCP = JSON.parse(cacheCP);
            for (let i = 0; i < cacheCP.length; i++) {
                let forOut = cacheCP[i];
                if (forOut.ID_HoaDon === idHoaDon) {
                    forOut.IDRandomHD = idRandom;
                    break;
                }
            }
            localStorage.setItem('lcChiPhi', JSON.stringify(cacheCP));
        }
    }

    function getListHoaDonLe() {
        var createHDfrom = localStorage.getItem('gara_CreateFrom');
        var lstHD = localStorage.getItem(lcListHD);
        var cthd = localStorage.getItem(lcListCTHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
        }
        else {
            lstHD = [];
        }
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
        }
        else {
            cthd = [];
        }

        switch (createHDfrom) {
            case 'TN_taohoadon':
            case 'TN_taobaogia':
                var phieuTN = localStorage.getItem('phieuTN');
                if (phieuTN !== null) {
                    phieuTN = JSON.parse(phieuTN);
                    var max = GetMax_MaHoaDon(phieuTN.LoaiHoaDon, lstHD);
                    var newHD = newHoaDon(phieuTN.LoaiHoaDon, max + 1);
                    localStorage.setItem(lcMaHD, newHD.MaHoaDon);
                    if (phieuTN.ID !== undefined && phieuTN.ID !== null) {
                        newHD.MaPhieuTiepNhan = phieuTN.MaPhieuTiepNhan.concat('_', phieuTN.BienSo);
                        newHD.ID_PhieuTiepNhan = phieuTN.ID;
                        newHD.ID_Xe = phieuTN.ID_Xe;
                        newHD.ID_BaoHiem = phieuTN.ID_BaoHiem;
                        newHD.ID_DoiTuong = phieuTN.ID_KhachHang;
                        newHD.TenBaoHiem = phieuTN.TenBaoHiem;
                        newHD.LienHeBaoHiem = phieuTN.NguoiLienHeBH;
                        newHD.SoDienThoaiLienHeBaoHiem = phieuTN.SoDienThoaiLienHeBH;
                    }
                    else {
                        newHD.MaPhieuTiepNhan = '';
                        newHD.ID_Xe = null;
                        newHD.ID_BaoHiem = null;
                        newHD.ID_DoiTuong = null;
                        newHD.TenBaoHiem = '';
                        newHD.LienHeBaoHiem = '';
                        newHD.SoDienThoaiLienHeBaoHiem = '';
                    }
                    lstHD.push(newHD);
                    localStorage.setItem(lcListHD, JSON.stringify(lstHD));

                    // assign matiepnhan
                    self.textSearchPhieuTN(phieuTN.MaPhieuTiepNhan);
                }
                break;
            case 'TN_xulyBG':
                var phieuTN = localStorage.getItem(lcXuLiDonHang_Const);
                if (phieuTN !== null) {
                    phieuTN = JSON.parse(phieuTN);
                    // get hddathang dangxuly by mahoadon cache
                    var maHDDH = localStorage.getItem(lcMaHD);
                    var phieuXL = $.grep(phieuTN, function (x) {
                        return x.MaHoaDon === maHDDH;
                    });
                    if (phieuXL.length > 0) {
                        let idRandomHD = CreateIDRandom('HD_');
                        phieuXL[0].IDRandom = idRandomHD;
                        phieuXL[0].NguoiTao = userLogin;
                        phieuXL[0].ID_NhanVien = _idNhanVien;
                        phieuXL[0].MaPhieuTiepNhan = phieuXL[0].MaPhieuTiepNhan ? phieuXL[0].MaPhieuTiepNhan.concat('_', phieuXL[0].BienSo) : '';
                        localStorage.setItem(lcMaHD, phieuXL[0].MaHoaDon);
                        var hdEx = $.grep(lstHD, function (x) {
                            return x.MaHoaDon === phieuXL[0].MaHoaDon;
                        });
                        if (hdEx.length > 0) {
                            lstHD = $.grep(lstHD, function (x) {
                                return x.MaHoaDon !== phieuXL[0].MaHoaDon;
                            });
                        }

                        lstHD.push(phieuXL[0]);
                        var ctietTN = localStorage.getItem(lcCTDatHang_Const);
                        if (ctietTN !== null) {
                            ctietTN = JSON.parse(ctietTN);

                            // chi get ctdathang dang xuly
                            ctietTN = $.grep(ctietTN, function (x) {
                                return x.MaHoaDon === phieuXL[0].MaHoaDon;
                            });
                            // remove of exist
                            cthd = $.grep(cthd, function (x) {
                                return x.MaHoaDon !== phieuXL[0].MaHoaDon;
                            });

                            for (let i = 0; i < ctietTN.length; i++) {
                                ctietTN[i].IDRandomHD = idRandomHD;// must assign again idRandom new
                                for (let j = 0; j < ctietTN[i].DM_LoHang.length; j++) {
                                    ctietTN[i].DM_LoHang[j].IDRandomHD = idRandomHD;
                                }
                                for (let j = 0; j < ctietTN[i].HangCungLoais.length; j++) {
                                    ctietTN[i].HangCungLoais[j].IDRandomHD = idRandomHD;
                                }
                                for (let j = 0; j < ctietTN[i].ThanhPhanComBo.length; j++) {
                                    ctietTN[i].ThanhPhanComBo[j].IDRandomHD = idRandomHD;
                                }
                                cthd.push(ctietTN[i]);
                            }
                            localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
                        }
                        localStorage.setItem(lcListHD, JSON.stringify(lstHD));
                    }
                }
                break;
            case 'TN_updateHD':
            case 'TN_copyHD':
            case 'TN_copyDH':
            case 'TN_copyTH':
                var idRandomHD = CreateIDRandom('HD_');
                var mahoadon = '';
                var cacheNameHD = 'lcHDSaoChep';
                var cacheNameCTHD = 'lcCTHDSaoChep';
                switch (createHDfrom) {
                    case 'TN_copyDH':
                        cacheNameHD = 'lcCopyDatHang';
                        cacheNameCTHD = 'lcCTDatHangCopy';
                        break;
                    case 'TN_copyTH':
                        cacheNameHD = 'lcHDTHSaoChep';
                        cacheNameCTHD = 'lcCTHDTHSaoChep';
                        break;
                }

                var hd = localStorage.getItem(cacheNameHD);
                if (hd !== null) {
                    hd = JSON.parse(hd);

                    let idHD = const_GuidEmpty;
                    if (hd.LoaiHoaDon !== 19) {
                        hd.MaPhieuTiepNhan = hd.BienSo ? hd.MaPhieuTiepNhan.concat('_', hd.BienSo) : '';
                    }
                    else {
                        $('#txtSearchCar').val(hd.BienSo);
                    }
                    // if updatehd
                    if (createHDfrom === 'TN_updateHD') {
                        mahoadon = hd.MaHoaDon;
                        idHD = hd.ID;
                        hdExist = $.grep(lstHD, function (x) {
                            return x.MaHoaDon === mahoadon;
                        });
                        // if exist: update status + nguoitao --> used to GetListHD_Opening by user
                        for (let i = 0; i < lstHD.length; i++) {
                            if (lstHD[i].MaHoaDon === mahoadon) {
                                lstHD[i].Status = 1;
                                lstHD[i].NguoiTao = userLogin;
                                break;
                            }
                        }
                    }
                    else {// else saochep
                        mahoadon = 'Copy' + hd.MaHoaDon;
                        hdExist = $.grep(lstHD, function (x) {
                            return x.MaHoaDon === mahoadon && x.NguoiTao === userLogin;
                        });
                    }
                    if (hdExist.length > 0) {
                        idRandomHD = hdExist[0].IDRandom;
                        ChiPhiDV_updateIDRandomHD(idRandomHD, hd.ID);
                    }
                    else {
                        ChiPhiDV_updateIDRandomHD(idRandomHD, hd.ID);

                        if (createHDfrom === 'TN_updateHD') {
                            hd.NgayLapHoaDon = moment(hd.NgayLapHoaDon).format('YYYY-MM-DD HH:mm'); // update HD --> keep ngay old
                        }
                        else {
                            hd.NgayLapHoaDon = null;// assign = null --> auto update time at BanLe (call func timer())
                        }
                        hd.MaHoaDon = mahoadon;
                        hd.IDRandom = idRandomHD;
                        hd.NguoiTao = userLogin;// save NguoiTao to do check when Delete_whenTimeout
                        hd.ID = idHD;
                        hd.XuatKhoAll = false;
                        lstHD.push(hd);
                    }
                    localStorage.setItem(lcListHD, JSON.stringify(lstHD));

                    // neu đang không mở nhiều HD giống nhau: add again CTHD SaoChep 
                    if (hdExist.length === 0) {
                        let ctCopy = localStorage.getItem(cacheNameCTHD);
                        if (ctCopy !== null) {
                            ctCopy = JSON.parse(ctCopy);
                            for (let i = 0; i < ctCopy.length; i++) {
                                ctCopy[i].MaHoaDon = mahoadon;
                                ctCopy[i].IDRandomHD = idRandomHD;
                                ctCopy[i].ThoiGianThucHien = ctCopy[i].SoPhutThucHien === null ? 0 : ctCopy[i].SoPhutThucHien;

                                // update DM_LoHang for ctCopy
                                for (let j = 0; j < ctCopy[i].DM_LoHang.length; j++) {
                                    ctCopy[i].DM_LoHang[j].MaHoaDon = mahoadon;
                                    ctCopy[i].DM_LoHang[j].IDRandomHD = idRandomHD;
                                }
                                // update IDRandomHD for HangCungLoai
                                for (let j = 0; j < ctCopy[i].HangCungLoais.length; j++) {
                                    ctCopy[i].HangCungLoais[j].MaHoaDon = mahoadon;
                                    ctCopy[i].HangCungLoais[j].IDRandomHD = idRandomHD;
                                }

                                for (let j = 0; j < ctCopy[i].ThanhPhanComBo.length; j++) {
                                    ctCopy[i].ThanhPhanComBo[j].MaHoaDon = mahoadon;
                                    ctCopy[i].ThanhPhanComBo[j].IDRandomHD = idRandomHD;
                                }
                                cthd.push(ctCopy[i]);
                            }
                            localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
                        }

                        // check khuyenmai hanghoa theo hoadon
                        let kmHoaDon = localStorage.getItem(lcProductKM_HoaDon);
                        if (kmHoaDon !== null) {
                            kmHoaDon = JSON.parse(kmHoaDon);
                            for (let i = 0; i < kmHoaDon.length; i++) {
                                if (kmHoaDon[i].MaHoaDon === mahoadon) {
                                    kmHoaDon[i].IDRandomHD = idRandomHD;
                                }
                            }
                            localStorage.setItem(lcProductKM_HoaDon, JSON.stringify(kmHoaDon));
                        }
                    }

                    localStorage.removeItem(cacheNameHD);
                    localStorage.removeItem(cacheNameCTHD);

                    _maHoaDon = mahoadon;
                    localStorage.setItem(lcMaHD, mahoadon);
                }
                break;
            case 'NH_XuatBan':
                var lcHDNhapHang = localStorage.getItem('lcHDForNH');
                if (lcHDNhapHang !== null) {
                    lcHDNhapHang = JSON.parse(lcHDNhapHang);
                    // awlay add newHoaDon
                    let countHD = GetMax_MaHoaDon(1, lstHD) + 1;
                    mahoadon = nameHD_InsertBH + countHD;
                    lcHDNhapHang.NgayLapHoaDon = null;
                    lcHDNhapHang.MaHoaDon = mahoadon;
                    lcHDNhapHang.IDRandom = idRandomHD;
                    lcHDNhapHang.ID_NhanVien = _idNhanVien; // assign again idnhanvien
                    lcHDNhapHang.NguoiTao = userLogin;
                    lcHDNhapHang.ID = const_GuidEmpty;
                    lstHD.push(lcHDNhapHang);
                    localStorage.setItem(lcListHD, JSON.stringify(lstHD));

                    // push to cthd
                    let lcCTNhapHang = localStorage.getItem('lcCTHDForNH');
                    if (lcCTNhapHang !== null) {
                        lcCTNhapHang = JSON.parse(lcCTNhapHang);
                        for (let i = 0; i < lcCTNhapHang.length; i++) {
                            lcCTNhapHang[i].MaHoaDon = mahoadon;
                            lcCTNhapHang[i].IDRandomHD = idRandomHD;
                            // update DM_LoHang for lcCTNhapHang
                            for (let j = 0; j < lcCTNhapHang[i].DM_LoHang.length; j++) {
                                lcCTNhapHang[i].DM_LoHang[j].MaHoaDon = mahoadon;
                                lcCTNhapHang[i].DM_LoHang[j].IDRandomHD = idRandomHD;
                            }
                            // update DM_LoHang for lcCTNhapHang
                            for (let j = 0; j < lcCTNhapHang[i].HangCungLoais.length; j++) {
                                lcCTNhapHang[i].HangCungLoais[j].MaHoaDon = mahoadon;
                                lcCTNhapHang[i].HangCungLoais[j].IDRandomHD = idRandomHD;
                            }
                            cthd.push(lcCTNhapHang[i]);
                        }
                        localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
                    }

                    _maHoaDon = mahoadon;
                    localStorage.setItem(lcMaHD, mahoadon);

                    localStorage.removeItem('lcHDForNH');
                    localStorage.removeItem('lcCTHDForNH');
                }
            default:
                // get maHD from cache
                break;
        }
        localStorage.removeItem('phieuTN');
        localStorage.removeItem('chitietTN');
        localStorage.removeItem('gara_CreateFrom');

        Add_NewProperties_CTHD();
        BindHD_CTHDafterSave();
        ShowDivDefault();
        // cthd Doi tra
        Bind_CTHĐoiTra_afterHideColumn();
        Call_6Func(true);
        $('#ddlDMChungTus').removeAttr('disabled');
    }

    // tinh so luong hang mua --> show at header
    function Caculator_AmountProduct() {
        var cthd = localStorage.getItem(lcListCTHD);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            // find hd opening--> get IDRandom
            var lstHD = localStorage.getItem(lcListHD);
            lstHD = JSON.parse(lstHD);
            var itemEx = GetHDOpening_byMaHoaDon(self.HoaDons().MaHoaDon(), lstHD);
            var sumQuantity = 0;
            var sumProduct = 0;
            if (itemEx.length > 0) {
                var arrCTHDopen = $.grep(cthd, function (x) {
                    return x.IDRandomHD === itemEx[0].IDRandom;
                });
                if (arrCTHDopen.length > 0) {
                    sumProduct = arrCTHDopen.length;
                    for (let i = 0; i < arrCTHDopen.length; i++) {
                        sumQuantity += parseFloat(arrCTHDopen[i].SoLuong);
                        // count HH Khuyen mai of Hang hoa
                        for (let j = 0; j < arrCTHDopen[i].HangHoa_KM.length; j++) {
                            sumQuantity += parseFloat(arrCTHDopen[i].HangHoa_KM[j].SoLuong);
                            sumProduct += 1;
                        }
                        // count Lot in Hang hoa
                        for (let k = 1; k < arrCTHDopen[i].DM_LoHang.length; k++) {
                            sumQuantity += parseFloat(arrCTHDopen[i].DM_LoHang[k].SoLuong);
                        }
                        // count hangcungloai
                        for (let k = 0; k < arrCTHDopen[i].HangCungLoais.length; k++) {
                            sumQuantity += parseFloat(arrCTHDopen[i].HangCungLoais[k].SoLuong);
                        }
                    }
                }
                // count HH Khuyen mai of  Hoa don
                var lstKM_ProductHD = localStorage.getItem(lcProductKM_HoaDon);
                if (lstKM_ProductHD !== null) {
                    lstKM_ProductHD = JSON.parse(lstKM_ProductHD);
                    lstKM_ProductHD = $.grep(lstKM_ProductHD, function (x) {
                        return x.IDRandomHD === itemEx[0].IDRandom;
                    });
                    for (let i = 0; i < lstKM_ProductHD.length; i++) {
                        sumQuantity += parseFloat(lstKM_ProductHD[i].SoLuong);
                        sumProduct += 1;
                    }
                }
            }
            // round number to 3 decimals (OK)
            var numberRound = Math.round(sumQuantity * 1000) / 1000;
            self.SumQuantity(numberRound);
            self.SumProduct(sumProduct);
        }
    }

    function CheckQuyenExist(maquyen) {
        var role = $.grep(self.Quyen_NguoiDung(), function (x) {
            return x.MaQuyen === maquyen;
        });
        return role.length > 0;
    }


    // search auto hanghoa
    new Vue({
        el: '#el',
        created: function () {
            this.timmer = null;
        },
        data: function () {
            return {
                query: '',
                indexFocus: 0,
                searchList: [],
                currentPage: 0,
                pageSize: 30,
            }
        },
        methods: {
            click: function (item) {
                var self = this;
                self.searchList = [];
                newModelBanLe.Click_ChoseHangLo(item, 1);
                self.hideList();

                self.query = item.MaHangHoa;
                $(function () {
                    $('#txtSearchHH').focus().select();
                })
            },
            hideList: function () {
                $('#el .drop-search').hide();
            },
            showList: function () {
                $('#el .drop-search').show();
            },
            search: function (event) {
                var self = this;
                clearTimeout(self.timmer);
                var keyCode = event.keyCode || event.which;
                if ($.inArray(keyCode, [13, 38, 40]) > -1) {
                    if (keyCode === 13 && self.searchList.length > 0 || keyCode === 38 || keyCode === 40) {
                        return;
                    }
                }
                self.indexFocus = 0;
                self.currentPage = 0;
                self.timmer = setTimeout(function () {
                    self.searchDB(keyCode);
                }, 300);
            },
            searchDB: function (keyCode) {
                var self = this;
                var txt = self.query.trim();
                if (txt === '') {
                    self.searchList = [];
                    self.hideList();
                    return;
                }

                var param = {
                    ID_ChiNhanh: id_DonVi,
                    ID_BangGia: newModelBanLe.selectedGiaBan() === null ? const_GuidEmpty : newModelBanLe.selectedGiaBan(),
                    TextSearch: txt,
                    LaHangHoa: '%%',
                    QuanLyTheoLo: '%%',
                    ConTonKho: newModelBanLe.setHideProduct(),
                    CurrentPage: self.currentPage,
                    PageSize: self.pageSize,
                };
                ajaxHelper("/api/DanhMuc/DM_HangHoaAPI/" + "Gara_JqAutoHangHoa", 'POST', param).done(function (x) {
                    if (x.res) {
                        if (self.currentPage === 0) {
                            self.searchList = x.dataSoure;
                        }
                        else {
                            for (let i = 0; i < x.dataSoure.length; i++) {
                                self.searchList.push(x.dataSoure[i]);
                            }
                        }
                        if (keyCode === 13) {
                            self.keyEnter();
                        }
                        self.showList();
                    }
                });
            },
            keyEnter: function () {
                var self = this;
                var chosing = $.grep(self.searchList, function (item, index) {
                    return index === self.indexFocus;
                });
                if (chosing.length > 0) {
                    self.query = chosing[0].MaHangHoa;
                    newModelBanLe.Click_ChoseHangLo(chosing[0], 1);

                    $(function () {
                        $('#txtSearchHH').focus().select();
                    })
                }
                self.searchList = [];
                this.hideList();
            },
            keyUp: function () {// key = 38
                var self = this;
                if (self.indexFocus < 0) {
                    self.indexFocus = 0;
                }
                else {
                    self.indexFocus = self.indexFocus - 1;
                }
            },
            keyDown: function () {// key = 40
                var self = this;
                if (self.indexFocus > self.searchList.length) {
                    self.indexFocus = 0;
                }
                else {
                    self.indexFocus = self.indexFocus + 1;
                }
            },
            scrollList: function () {
                let self = this;
                let elem = event.currentTarget;
                if (elem.scrollTop > (elem.scrollHeight - elem.offsetHeight - 200)) {
                    if (elem.scrollTop + elem.clientHeight >= elem.scrollHeight) {
                        let lenData = self.searchList.length;
                        if (lenData === (self.currentPage + 1) * self.pageSize) {
                            self.currentPage += 1;
                            self.searchDB();
                        }
                    }
                }
            }
        },
    });

    new Vue({
        el: '#elTraHang',
        created: function () {
            this.timmer = null;
        },
        data: function () {
            return {
                query: '',
                indexFocus: 0,
                searchList: [],
                currentPage: 0,
                pageSize: 30,
            }
        },
        methods: {
            click: function (item) {
                var self = this;
                self.searchList = [];
                newModelBanLe.Click_ChoseHangLo_DoiTra(item);
                self.hideList();

                self.query = item.MaHangHoa;
                $(function () {
                    $('#txtSearchHH_TH').focus().select();
                })
            },
            hideList: function () {
                $('#elTraHang .drop-search').hide();
            },
            showList: function () {
                $('#elTraHang .drop-search').show();
            },
            search: function () {
                var self = this;
                clearTimeout(self.timmer);
                var keyCode = event.keyCode || event.which;
                if ($.inArray(keyCode, [13, 38, 40]) > -1) {
                    if (keyCode === 13 && self.searchList.length > 0 || keyCode === 38 || keyCode === 40) {
                        return;
                    }
                }
                self.indexFocus = 0;
                self.currentPage = 0;
                self.timmer = setTimeout(function () {
                    self.searchDB(keyCode);
                }, 300);
            },
            searchDB: function (keyCode) {
                var self = this;
                var txt = locdau(self.query).trim();
                if (txt === '') {
                    self.searchList = [];
                    self.hideList();
                    return;
                }
                var param = {
                    ID_ChiNhanh: id_DonVi,
                    ID_BangGia: newModelBanLe.selectedGiaBan() === null ? const_GuidEmpty : newModelBanLe.selectedGiaBan(),
                    TextSearch: txt,
                    LaHangHoa: '%%',
                    QuanLyTheoLo: '%%',
                    ConTonKho: newModelBanLe.setHideProduct(),
                    CurrentPage: self.currentPage,
                    PageSize: self.pageSize,
                };
                ajaxHelper("/api/DanhMuc/DM_HangHoaAPI/" + "Gara_JqAutoHangHoa", 'POST', param).done(function (x) {
                    if (x.res) {
                        if (self.currentPage === 0) {
                            self.searchList = x.dataSoure;
                        }
                        else {
                            for (let i = 0; i < x.dataSoure.length; i++) {
                                self.searchList.push(x.dataSoure[i]);
                            }
                        }
                        if (keyCode === 13) {
                            self.keyEnter();
                        }
                        self.showList();
                    }
                });
            },
            keyEnter: function () {
                var self = this;
                var chosing = $.grep(self.searchList, function (item, index) {
                    return index === self.indexFocus;
                });
                if (chosing.length > 0) {
                    self.query = chosing[0].MaHangHoa;
                    newModelBanLe.Click_ChoseHangLo_DoiTra(chosing[0]);

                    $(function () {
                        $('#txtSearchHH_TH').focus().select();
                    })
                }
                self.searchList = [];
                this.hideList();
            },
            keyUp: function () {// key = 38
                var self = this;
                if (self.indexFocus < 0) {
                    self.indexFocus = 0;
                }
                else {
                    self.indexFocus = self.indexFocus - 1;
                }
            },
            keyDown: function () {// key = 40
                var self = this;
                if (self.indexFocus > self.searchList.length) {
                    self.indexFocus = 0;
                }
                else {
                    self.indexFocus = self.indexFocus + 1;
                }
            },
            scrollList: function () {
                let self = this;
                let elem = event.currentTarget;
                if (elem.scrollTop > (elem.scrollHeight - elem.offsetHeight - 200)) {
                    if (elem.scrollTop + elem.clientHeight >= elem.scrollHeight) {
                        let lenData = self.searchList.length;
                        if (lenData === (self.currentPage + 1) * self.pageSize) {
                            self.currentPage += 1;
                            self.searchDB();
                        }
                    }
                }
            }
        },
    });

    self.ListPhieuTiepNhan = ko.observableArray();
    self.textSearchPhieuTN = ko.observable();
    self.indexFocus_phieuTN = ko.observable(0);
    self.searchPhieuTiepNhan = function () {
        var self = this;
        var txt = locdau(self.textSearchPhieuTN());
        if (txt === '') {
            Reset_PhieuTiepNhan();
            self.ListPhieuTiepNhan([]);
            return;
        }
        var keyCode = event.keyCode;
        var param = {
            LstIDChiNhanh: [id_DonVi],
            TextSearch: txt,
            ID_HangXe: self.ChiTietDoiTuong() && self.ChiTietDoiTuong().length > 0 ? self.ChiTietDoiTuong()[0].ID : '%%',
        }
        if (keyCode !== 13) {
            ajaxHelper(GaraAPI + "JqAuto_PhieuTiepNhan", 'POST', param).done(function (x) {
                if (x.res) {
                    self.ListPhieuTiepNhan(x.dataSoure);
                }
            })
        }
        else {
            switch (keyCode) {
                case 13:
                    var chosing = $.grep(self.ListPhieuTiepNhan(), function (item, index) {
                        return index === self.indexFocus;
                    });
                    if (chosing.length > 0) {
                        self.ChosePhieuTiepNhan(chosing[0]);
                    }
                    break;
                case 38:
                    if (self.indexFocus_phieuTN() < 0) {
                        self.indexFocus_phieuTN(0);
                    }
                    else {
                        self.indexFocus_phieuTN(self.indexFocus_phieuTN() - 1);
                    }
                    break;
                case 40:
                    if (self.indexFocus_phieuTN() > self.ListPhieuTiepNhan().length) {
                        self.indexFocus_phieuTN(0);
                    }
                    else {
                        self.indexFocus_phieuTN(self.indexFocus_phieuTN() + 1);
                    }
                    break;
            }
        }
    }

    self.hideListPhieuTN = function () {
        $('#jqAutoPhieuTN .gara-search-dropbox').hide();
    }
    self.showListPhieuTN = function () {
        $('#jqAutoPhieuTN .gara-search-dropbox').show();
    }

    function ChangeKhachhang_GetListCar() {
        if (self.HoaDons().LoaiHoaDon() === 19) {
            var idCus = self.ChiTietDoiTuong() && self.ChiTietDoiTuong().length > 0 ? self.ChiTietDoiTuong()[0].ID : '';
            $.getJSON("/api/DanhMuc/GaraAPI/" + "JqAuto_SearchXe?txt&statusTN&idCustomer=" + idCus)
                .done(function (x) {
                    if (x.res) {
                        let data = x.dataSoure;
                        if (data.length === 1) {
                            self.ChoseCar(data[0]);
                        }
                        else {
                            vmSearchCar.searchList = data;
                        }
                    }
                });
        }
    }

    self.ChoseCar = function (car) {
        var hd = localStorage.getItem(lcListHD);
        if (hd !== null) {
            hd = JSON.parse(hd);
            for (let i = 0; i < hd.length; i++) {
                if (hd[i].IDRandom === self.HoaDons().IDRandom()) {
                    hd[i].ID_Xe = car.ID;
                    hd[i].BienSo = car.BienSo;
                    break;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(hd));
        }
    }

    // search car
    var vmSearchCar = new Vue({
        el: '#jqAutoSearchCar',
        created: function () {
            this.timmer = null;
        },
        data: function () {
            return {
                query: '',
                indexFocus: 0,
                searchList: [],
            }
        },
        methods: {
            addNewCar: function () {
                var chuxe = null;
                if (!commonStatisJs.CheckNull(newModelBanLe.ChiTietDoiTuong())) {
                    if (newModelBanLe.ChiTietDoiTuong().length > 0) {
                        chuxe = {
                            ID: newModelBanLe.ChiTietDoiTuong()[0].ID,
                            TenDoiTuong: newModelBanLe.ChiTietDoiTuong()[0].TenDoiTuong,
                            DienThoai: newModelBanLe.ChiTietDoiTuong()[0].DienThoai,
                        }
                    }
                }
                vmThemMoiXe.inforLogin = {
                    ID_NhanVien: _idNhanVien,
                    ID_User: id_User,
                    UserLogin: userLogin,
                    ID_DonVi: id_DonVi,
                }
                vmThemMoiXe.ShowModalNewCar(chuxe);
            },
            click: function (item) {
                var self = this;
                self.searchList = [];
                newModelBanLe.Change_KhachHang(item.ID_KhachHang);
                newModelBanLe.ChoseCar(item);
                self.hideList();

                self.query = item.BienSo;
                $(function () {
                    $('#txtSearchCar').focus().select();
                })
            },
            hideList: function () {
                $('#jqAutoSearchCar .gara-search-dropbox').hide();
            },
            showList: function () {
                $('#jqAutoSearchCar .gara-search-dropbox').show();
            },
            search: function (event) {
                var self = this;
                clearTimeout(self.timmer);
                var keyCode = event.keyCode || event.which;
                if ($.inArray(keyCode, [13, 38, 40]) > -1) {
                    if (keyCode === 13 && self.searchList.length > 0 || keyCode === 38 || keyCode === 40) {
                        return;
                    }
                }
                self.indexFocus = 0;
                self.timmer = setTimeout(function () {
                    self.searchDB(keyCode);
                }, 300);
            },
            searchDB: function (keyCode) {
                var self = this;
                var txt = locdau(self.query).trim();
                if (txt === '') {
                    self.searchList = [];
                    self.hideList();
                    // reset infor car
                    var hd = localStorage.getItem(lcListHD);
                    if (hd !== null) {
                        hd = JSON.parse(hd);
                        for (let i = 0; i < hd.length; i++) {
                            if (hd[i].IDRandom === newModelBanLe.HoaDons().IDRandom()) {
                                hd[i].ID_Xe = null;
                                hd[i].BienSo = '';
                                vmNKGoiBaoDuong.GetGoiDichVu_ofKhachHang(hd[i].ID_DoiTuong, null);
                                break;
                            }
                        }
                        localStorage.setItem(lcListHD, JSON.stringify(hd));
                    }
                    return;
                }

                var idCus = newModelBanLe.ChiTietDoiTuong() && newModelBanLe.ChiTietDoiTuong().length > 0 ?
                    newModelBanLe.ChiTietDoiTuong()[0].ID : '';
                $.getJSON("/api/DanhMuc/GaraAPI/" + "JqAuto_SearchXe?txt=" + txt + "&statusTN&idCustomer=" + idCus)
                    .done(function (x) {
                        if (x.res) {
                            self.searchList = x.dataSoure;
                            if (keyCode === 13) {
                                self.keyEnter();
                            }
                            self.showList();
                        }
                    });
            },
            keyEnter: function () {
                var self = this;
                var chosing = $.grep(self.searchList, function (item, index) {
                    return index === self.indexFocus;
                });
                if (chosing.length > 0) {
                    self.query = chosing[0].BienSo;
                    newModelBanLe.Change_KhachHang(chosing[0].ID_KhachHang);
                    newModelBanLe.ChoseCar(chosing[0]);

                    $(function () {
                        $('#txtSearchCar').focus().select();
                    })
                }
                self.searchList = [];
                this.hideList();
            },
            keyUp: function () {// key = 38
                var self = this;
                if (self.indexFocus < 0) {
                    self.indexFocus = 0;
                }
                else {
                    self.indexFocus = self.indexFocus - 1;
                }
            },
            keyDown: function () {// key = 40
                var self = this;
                if (self.indexFocus > self.searchList.length) {
                    self.indexFocus = 0;
                }
                else {
                    self.indexFocus = self.indexFocus + 1;
                }
            }
        },
    });

    $('#ThemMoiXemModal').on('hidden.bs.modal', function () {
        if (vmThemMoiXe.saveOK) {
            if (vmThemMoiXe.isNew) {
                self.ChoseCar(vmThemMoiXe.newCar);
                $('#txtSearchCar').val(vmThemMoiXe.newCar.BienSo);
            }
        }
    })

    var indexPhongBan = 0;
    var vm_PhongBan = new Vue({
        el: '#sodo',
        data: function () {
            return {
                query: '',
                filters: [],
            }
        },
        methods: {
            reset: function (item) {
                this.filters = [];
                this.query = '';
            },
            click: function (item) {
                self.ChosePhong_HD(item, 1, false);
                $('#divSearchVT').hide();
            },
            submit: function (event) {
                var keyPress = event.keyCode;
                switch (keyPress) {
                    case 13:
                        var result = this.findBy(this.query.trim());
                        var focus = false;
                        $('#allLocation li').each(function (i) {
                            if ($(this).hasClass('hoverenabled')) {
                                self.ChosePhong_HD(result[i]);
                                focus = true;
                            }
                        });
                        if (result.length > 0 && this.query !== '' && focus === false) {
                            self.ChosePhong_HD(result[0]);
                        }
                        $('#txtSearchVT').focus();
                        break;
                    case 37://left
                    case 38://up
                        indexPhongBan = indexPhongBan - 1;
                        if (indexPhongBan < 0) {
                            indexPhongBan = $("#allLocation li").length.length - 1;
                        }
                        this.loadFocus();
                        break;
                    case 39://right
                    case 40://dows
                        indexPhongBan = indexPhongBan + 1;
                        if (indexPhongBan >= $("#allLocation li").length) {
                            indexPhongBan = 0;
                        }
                        this.loadFocus();
                        break;
                }
            },
            loadFocus: function () {
                $('#allLocation li').removeClass('hoverenabled');
                $('#allLocation li').each(function (i) {
                    if (i === indexPhongBan) {
                        $(this).addClass('hoverenabled');
                        return false;
                    }
                });
                $('#txtSearchVT').focus();
            },
            findBy: function (value) {
                if (value === '') return self.AllPhongBans();
                let txt = locdau(value);
                return self.AllPhongBans().filter(function (item) {
                    return locdau(item['NameFull']).indexOf(txt) > -1;
                });
            }
        },
        computed: {
            resultPhongBan: function () {
                var result = this.findBy(this.query.trim());
                self.PhongBans_byIDNhom(result);
                $('#txtSearchVT').focus();
                return result;
            }
        }
    });

    function GetTree_NhomHangHoa() {
        ajaxHelper('/api/DanhMuc/DM_NhomHangHoaAPI/' + 'GetTree_NhomHangHoa', 'GET').done(function (obj) {
            if (obj.res === true) {
                let data = obj.data;
                if (data.length > 0) {
                    data = data.sort((a, b) => a.text.localeCompare(b.text, undefined, { caseFirst: "upper" }));
                }
                self.NhomHangHoas(data);
                // bind data on tree
                tree = $('#tree').tree({
                    primaryKey: 'id',
                    uiLibrary: 'bootstrap',
                    dataSource: data,
                    checkboxes: true,
                });
                // use to get arrIDNhomChild when check KMai
                tree2 = $('#tree2').tree({
                    primaryKey: 'id',
                    uiLibrary: 'bootstrap',
                    dataSource: data,
                    checkboxes: true,
                });
                partialProduct.NhomHangHoas(data);
            }
        })
    }
    self.querySearch = ko.observable("");
    $('#txtSearchNhomHH').keypress(function (e) {
        if (e.keyCode === 13) {
            var filter = locdau($(this).val());
            var arr = GetChildren_NhomHH([], self.NhomHangHoas(), filter, [], true);
            tree.destroy();
            tree = $('#tree').tree({
                primaryKey: 'id',
                uiLibrary: 'bootstrap',
                dataSource: arr,
                checkboxes: true,
            });
        }
    })
    function GetChildren_NhomHH(arrParent, arrJson, txtSearch, arr, isRoot) {
        if (txtSearch === '') {
            return self.NhomHangHoas();
        }
        for (let i = 0; i < arrJson.length; i++) {
            let tenNhom = locdau(arrJson[i].text);
            if (tenNhom.indexOf(txtSearch) > -1) {
                if (isRoot) {
                    arr.push(arrJson[i]);
                }
                else {
                    var ex = $.grep(arr, function (x) {
                        return x.id === arrParent.id;
                    })
                    if (ex.length === 0) {
                        arr.push(arrParent);
                    }
                    else {
                        // neu da ton tai, thoat vong for of children
                        return;
                    }
                }
            }
            if (arrJson[i].children.length > 0) {
                GetChildren_NhomHH(arrJson[i], arrJson[i].children, txtSearch, arr, false);
            }
        }
        return arr;
    }

    function GetUserCookies() {
        $.getJSON("/api/DanhMuc/NS_NhanVienAPI/" + 'GetUserCookies', function (nv_nd) {
            _idNhanVien = nv_nd.ID_NhanVien;
            id_User = nv_nd.ID;
            userLogin = nv_nd.TaiKhoan;
            id_DonVi = nv_nd.ID_DonVi;

            vmThemMoiKhach.inforLogin = {
                ID_NhanVien: _idNhanVien,
                ID_User: id_User,
                UserLogin: userLogin,
                ID_DonVi: id_DonVi,
            };

            WriteData_Dexie(db.HT_NguoiDung, [nv_nd]);
        });
    }
    self.ListNVien_TuVanThucHien = ko.observableArray();
    function GetNhanVien_NguoiDung() {
        ajaxHelper("/api/DanhMuc/NS_NhanVienAPI/" + 'GetNhanVien_NguoiDung', 'GET').done(function (x) {
            if (x.res === true) {
                let data = x.data;
                self.NhanViens_ChiNhanh(data);

                var lstNV_byDonVi = $.grep(data, function (x) {
                    return x.ID_DonVi === id_DonVi;
                });
                for (let i = 0; i < lstNV_byDonVi.length; i++) {
                    lstNV_byDonVi[i].StatusCV = 0;
                }
                self.NhanViens(lstNV_byDonVi);

                vmThanhToanGara.listData.NhanViens = lstNV_byDonVi;
                vmHoaHongHoaDon.listData.NhanViens = lstNV_byDonVi;

                let tenNV = '';
                let nvien = $.grep(self.NhanViens(), function (x) {
                    return x.ID === _idNhanVien;
                });
                if (nvien.length > 0) {
                    tenNV = nvien[0].TenNhanVien;
                }
                vmThanhToan.inforLogin = {
                    ID_NhanVien: _idNhanVien,
                    ID_User: id_User,
                    UserLogin: userLogin,
                    ID_DonVi: id_DonVi,
                    TenNhanVien: tenNV,
                };

                WriteData_Dexie(db.NS_NhanVien, data);
            }
        })
    }

    function GetDMGiaBan_GBApDung() {
        ajaxHelper("/api/DanhMuc/DM_GiaBanAPI/" + "GetDMGiaBan_GBApDung_ChiTiet?idDonVi=" + id_DonVi, 'GET').done(function (obj) {
            if (obj.res === true) {
                let data = obj.data;
                self.AllBangGia(data);
                BindLstBangGia_byNhanVien_andDoiTuong();
            }
        });
    };
    function BindLstBangGia_byNhanVien_andDoiTuong() {
        var objBGChung = {
            TenGiaBan: 'Bảng giá chuẩn',
            ID: const_GuidEmpty,
        }
        // filter BangGia by LoaiHoaDon
        var loaiHD = GetLoaiHoaDon_ofHDopening().toString();
        var arrBGLoaiChungTu = [];
        for (let i = 0; i < self.AllBangGia().length; i++) {
            let itGB = self.AllBangGia()[i];
            if (itGB.LoaiChungTuApDung !== null) {
                let arrChungTu = itGB.LoaiChungTuApDung.split(',');
                arrChungTu = RemoveItemEmpty(arrChungTu);
                // push BG co loai chung tu = loaiHD
                if ($.inArray(loaiHD, arrChungTu) > -1) {
                    arrBGLoaiChungTu.push(itGB);
                }
            }
        }
        // push BG co loai chung tu === null
        for (let i = 0; i < self.AllBangGia().length; i++) {
            if (self.AllBangGia()[i].LoaiChungTuApDung === null) {
                arrBGLoaiChungTu.push(self.AllBangGia()[i]);
            }
        }

        // get BangGia if BGia apply for all NhanVien, allDoiTuong
        var arrBGia = [];
        for (let i = 0; i < arrBGLoaiChungTu.length; i++) {
            if (arrBGLoaiChungTu[i].TatCaNhanVien && arrBGLoaiChungTu[i].TatCaDoiTuong) {
                arrBGia.push(arrBGLoaiChungTu[i]);
            }
        }
        // get BGia apply for NhanVien is chosing
        for (let i = 0; i < arrBGLoaiChungTu.length; i++) {
            let itFor = arrBGLoaiChungTu[i];
            let lenGBAD = itFor.DM_GiaBan_ApDung.length;
            if (itFor.TatCaNhanVien === false || itFor.TatCaDoiTuong === false) {
                if (itFor.TatCaNhanVien === false) {
                    // apply for all DoiTuong
                    if (itFor.TatCaDoiTuong) {
                        for (let j = 0; j < lenGBAD; j++) {
                            if (itFor.DM_GiaBan_ApDung[j].ID_NhanVien === self.selectedNVien()) {
                                arrBGia.push(itFor);
                                break; // esc for DM_GiaBan_ApDung
                            }
                        }
                    }
                    else {
                        // apply by ID_NhomDoiTuong
                        for (let j = 0; j < lenGBAD; j++) {
                            if (itFor.DM_GiaBan_ApDung[j].ID_NhanVien === self.selectedNVien()
                                && self.ChiTietDoiTuong() !== null && self.ChiTietDoiTuong().length > 0
                                && self.ChiTietDoiTuong()[0].ID_NhomDoiTuong.toLowerCase().indexOf(itFor.DM_GiaBan_ApDung[j].ID_NhomKhachHang) > -1) {
                                arrBGia.push(itFor);
                                break; // esc for DM_GiaBan_ApDung
                            }
                        }
                    }
                }
                else {
                    // chi con truong hop TatCaDoiTuong === false (OK)
                    if (itFor.TatCaDoiTuong === false) {
                        // apply by ID_NhomDoiTuong
                        for (let j = 0; j < lenGBAD; j++) {
                            if (self.ChiTietDoiTuong() !== null && self.ChiTietDoiTuong().length > 0) {
                                if (self.ChiTietDoiTuong()[0].ID_NhomDoiTuong !== null && self.ChiTietDoiTuong()[0].ID_NhomDoiTuong !== undefined
                                    && self.ChiTietDoiTuong()[0].ID_NhomDoiTuong.toLowerCase().indexOf(itFor.DM_GiaBan_ApDung[j].ID_NhomKhachHang) > -1) {
                                    arrBGia.push(itFor);
                                    break; // esc for DM_GiaBan_ApDung
                                }
                            }
                        }
                    }
                }
            }
        }
        arrBGia = FillterBangGia_byNgayTrongTuan(arrBGia);
        self.GiaBans(arrBGia);
        self.GiaBans.unshift(objBGChung);
    }
    function FillterBangGia_byNgayTrongTuan(lstBangGia) {
        // filter BangGia by NgayLapHD
        var dtNgayLapHD = moment($('#datepicker').val(), 'DD/MM/YYYY').format('YYYY-MM-DD');
        var today = (new Date(dtNgayLapHD)).getDay() + 1; // 1 --> 7 (1: chu nhat)
        // check null NgayTrongTuan
        var arrBGNgayTrongTuan = [];
        for (let i = 0; i < lstBangGia.length; i++) {
            if (lstBangGia[i].NgayTrongTuan !== null && lstBangGia[i].NgayTrongTuan !== undefined) {
                // push BG co loai chung tu = loaiHD
                if (lstBangGia[i].NgayTrongTuan.indexOf(today.toString()) > -1) {
                    arrBGNgayTrongTuan.push(lstBangGia[i]);
                }
            }
        }
        for (let i = 0; i < lstBangGia.length; i++) {
            if (lstBangGia[i].NgayTrongTuan === null) {
                // push BG co loai NgayTrongTuan === null
                arrBGNgayTrongTuan.push(lstBangGia[i]);
            }
        }
        return arrBGNgayTrongTuan;
    }
    function GetListTrangThaiKhachHang() {
        ajaxHelper(DMDoiTuongUri + 'GetListTrangThaiTimKiem', 'GET').done(function (obj) {
            var data = obj.data;
            if (obj.res === true && data !== undefined) {
                self.TrangThaiKhachHang(data);
                vmThemMoiKhach.listData.TrangThaiKhachs = data;
                WriteData_Dexie(db.DM_DoiTuong_TrangThai, data);
            }
        });
    };
    self.ListAllDoiTuong = ko.observableArray();// to do bind at list NguoiGioiThieu (ThemMoiKH)

    self.showHoaDonOffline = function () {
        $('#getoffline').modal('show');
        $('#btnDongBoHoa').removeAttr('disabled');
        $('#ddlDMChungTus').removeAttr('disabled');
        self.selectLoaiChungTu(0);
        // remove loai 19
        var lstLoaiChungTu = $.grep(self.DMChungTus(), function (x) {
            return x.MaLoaiChungTu !== 19;
        });
        self.DMChungTus(lstLoaiChungTu);
        // add again if spa
        if (IsShop_SpaSalon()) {
            self.DMChungTus.push({ MaLoaiChungTu: 19, TenLoaiChungTu: 'Gói dịch vụ' })
        }
        $('#lblStatusConnect').text("Có internet");
        $('.connect').css('color', 'blue');
        $(".connect i").css('color', 'blue');
        $('#btnDongBoHoa').css('display', '');
    }

    self.showPopupAddKH = function () {
        vmThemMoiKhach.listData.NhanViens = self.NhanViens();
        vmThemMoiKhach.showModalAdd();
    }

    self.showPopupEditKH = function (item) {
        item.TenTrangThai = '';
        item.TenNhanVienPhuTrach = '';
        item.TenNguoiGioiThieu = item.NguoiGioiThieu;
        vmThemMoiKhach.listData.NhanViens = self.NhanViens();
        vmThemMoiKhach.showModalUpdate(item);
    }

    function UpdateKH_inforBasic_IndexDB(objUpdate) {
        db.DM_DoiTuong.put(objUpdate);
    }
    function AddNewKH_indexDB(DM_DoiTuong) {
        db.DM_DoiTuong.put(DM_DoiTuong)
    }
    function ResetInput_KhachHang() {
        $('jqauto-customer .gara-search-HH').val('');
    }

    function ChiPhiHD_updateBienSo(bienso = '') {
        let cacheCP = localStorage.getItem('lcChiPhi');
        if (cacheCP !== null) {
            cacheCP = JSON.parse(cacheCP);
            for (let i = 0; i < cacheCP.length; i++) {
                let forOut = cacheCP[i];
                if (forOut.IDRandomHD === self.HoaDons().IDRandom()) {
                    cacheCP[i].BienSo = bienso;
                }
            }
            localStorage.setItem('lcChiPhi', JSON.stringify(cacheCP));
        }
    }

    function Reset_PhieuTiepNhan() {
        var change = false;
        var hd = localStorage.getItem(lcListHD);
        if (hd !== null) {
            hd = JSON.parse(hd);
            for (let i = 0; i < hd.length; i++) {
                if (hd[i].IDRandom === self.HoaDons().IDRandom()) {
                    if (!commonStatisJs.CheckNull(hd[i].ID_PhieuTiepNhan)) {
                        change = true;
                        hd[i].MaPhieuTiepNhan = '';
                        hd[i].ID_PhieuTiepNhan = null;
                        hd[i].ID_Xe = null;
                        hd[i].BienSo = null;
                        hd[i].ID_BaoHiem = null;
                        hd[i].TenBaoHiem = '';
                        hd[i].LienHeBaoHiem = '';
                        hd[i].SoDienThoaiLienHeBaoHiem = '';
                        hd[i].BH_SDT = '';
                        hd[i].BH_DiaChi = '';
                        hd[i].BH_Email = '';
                        hd[i].SoDuDatCoc = 0;
                        hd[i].PhaiThanhToanBaoHiem = 0;
                        hd[i].KhauTruTheoVu = 0;
                        hd[i].SoVuBaoHiem = 0;
                        hd[i].PTGiamTruBoiThuong = 0;
                        hd[i].GiamTruBoiThuong = 0;
                        hd[i].GiamTruThanhToanBaoHiem = 0;
                        hd[i].TongTienThueBaoHiem = 0;
                        hd[i].PTThueBaoHiem = 0;
                        hd[i].BaoHiemDaTra = 0;
                        hd[i].KhachDaTra = 0;
                        hd[i].TongTienBHDuyet = 0;
                        hd[i].CongThucBaoHiem = 0;
                        hd[i].HeaderBH_Type = 1;
                        hd[i].HeaderBH_GiaTriPtram = 0;
                        hd[i].LoaiHoaDon = hd[i].LoaiHoaDon === 25 ? 1 : hd[i].LoaiHoaDon;
                        self.textSearchPhieuTN('');

                        self.HoaDons().ID_PhieuTiepNhan(null);
                        self.HoaDons().ID_Xe(null);
                    }
                    break;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(hd));
        }

        if (change) {
            var cthd = localStorage.getItem(lcListCTHD);
            if (cthd !== null) {
                cthd = JSON.parse(cthd);
                for (let i = 0; i < cthd.length; i++) {
                    if (cthd[i].IDRandomHD === self.HoaDons().IDRandom()) {
                        cthd[i].DonGiaBaoHiem = 0;
                        cthd[i].ID_ChiTietGoiDV = null;

                        for (let k = 0; k < cthd[i].DM_LoHang.length; k++) {
                            cthd[i].DM_LoHang[k].DonGiaBaoHiem = 0;
                            cthd[i].DM_LoHang[k].ID_ChiTietGoiDV = null;

                        }
                        for (let k = 0; k < cthd[i].HangCungLoais.length; k++) {
                            cthd[i].HangCungLoais[k].DonGiaBaoHiem = 0;
                            cthd[i].HangCungLoais[k].ID_ChiTietGoiDV = null;
                        }
                    }
                }
                localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
            }

            ChiPhiHD_updateBienSo()

            self.HangMucSuaChuas([]);
            self.VatDungKemTheos([]);
        }
    }
    self.deleteNCC = function () {
        // reset CTDoiTuong
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            let itemHD = GetHDOpening_byMaHoaDon(self.HoaDons().MaHoaDon(), lstHD);
            if (itemHD.length > 0) {
                var idRandomHD = itemHD[0].IDRandom;
                if (itemHD[0].StatusOffline === false) {
                    var cthd = localStorage.getItem(lcListCTHD);
                    var usingService = [];
                    if (cthd !== null) {
                        cthd = JSON.parse(cthd);
                        usingService = $.grep(cthd, function (x) {
                            return x.IDRandomHD === idRandomHD && x.ChatLieu === '4';
                        });
                    }
                    if (usingService.length > 0) {
                        dialogConfirm('Thông báo', 'Đang sử dụng <b> gói dịch vụ sẵn </b>. Bạn có chắc chắn chuyển sang <b>mua mới không? </b>', function () {
                            Reset_PhieuTiepNhan();
                            AgreeDelete(idRandomHD, itemHD);
                            ResetInput_KhachHang();
                        });
                    }
                    else {
                        // xulydathang --> don't change 
                        if (itemHD[0].ID_HoaDon !== null) {
                            return;
                        }
                        Reset_PhieuTiepNhan();
                        AgreeDelete(idRandomHD, itemHD);
                        ResetInput_KhachHang();
                    }
                }
            }
            else {
                self.selectedNCC(null);
                ResetInput_KhachHang();
                Reset_PhieuTiepNhan();
            }
        }
        else {
            self.selectedNCC(null);
            ResetInput_KhachHang();
            Reset_PhieuTiepNhan();
        }
        // bind again infor HoaDon (bind after update KhuyenMai)
        var lstHDafter = localStorage.getItem(lcListHD);
        if (lstHDafter !== null) {
            lstHDafter = JSON.parse(lstHDafter);
            let itemHD = GetHDOpening_byMaHoaDon(_maHoaDon, lstHDafter);
            if (itemHD.length > 0) {
                self.HoaDons().SetData(itemHD[0]);
            }
        }
        $('#txtSearchHH').focus();
        ClearTextSearch();
        HideShow_Icon_ChietKhauNV();
    };

    function AgreeDelete(idRandomHD, itemHD) {
        // xuly dathang --> don't change khachhang
        if (((itemHD[0].LoaiHoaDon === 1 || itemHD[0].LoaiHoaDon === 25) && itemHD[0].ID_HoaDon === null)
            || itemHD[0].LoaiHoaDon === 19) {
            self.Change_KhachHang(null);
            self.KM_KMApDung([]);
            UpdateKhuyenMai_CTHD(null, idRandomHD);
            ResetKM_HangHoa_byIDRandomHD(idRandomHD);
            ResetKM_HoaDon(idRandomHD);
        }
        else {
            if (itemHD[0].LoaiHoaDon === 3 || (itemHD[0].LoaiHoaDon === 6 && itemHD[0].ID_HoaDon === null)) {
                self.Change_KhachHang(null);
            }
        }
        UpdateGiamGiaHD_ByNhomKH(idRandomHD);
        UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();
    }

    function SaveHD_RemoveDisable() {
        $('#btnSave, #btnSaveDatHang, #btnTaoHD').removeAttr('disabled');
        $('.bgwhite').hide();
        $('body').gridLoader({ show: false });
    }

    self.saveHoaDonTraHang = function (isTamLuu) {
        $('#btnSave, #btnSaveDatHang, #btnTaoHD').attr('disabled', 'disabled');
        // check role LuuNhap
        if (isTamLuu) {
            var saveDraft = $.grep(self.Quyen_NguoiDung(), function (x) {
                return x.MaQuyen === 'HoaDon_LuuNhap';
            });
            if (saveDraft.length === 0) {
                ShowMessage_Danger('Bạn không có quyền lưu nháp hóa đơn');
                SaveHD_RemoveDisable();
                return;
            }
        }
        $('body').gridLoader();
        var lstHDTemp = localStorage.getItem(lcListHD);
        if (lstHDTemp !== null) {
            lstHDTemp = JSON.parse(lstHDTemp);

            var itemHD = GetHDOpening_byMaHoaDon(_maHoaDon, lstHDTemp);
            if (itemHD.length > 0) {

                var idRandomHD = itemHD[0].IDRandom;
                var check = CheckNgayLapHD(itemHD[0].NgayLapHoaDon);
                if (!check) {
                    SaveHD_RemoveDisable();
                    return;
                }
                // check  tong giam gia > tien mua hang
                if (formatNumberToInt(itemHD[0].TongTienHang) < formatNumberToInt(itemHD[0].TongGiamGiaKM_HD)) {
                    ShowMessage_Danger('Giảm giá hóa đơn không được lớn hơn tổng tiền hàng');
                    SaveHD_RemoveDisable();
                    return;
                }

                //  HD Tra
                if (itemHD[0].LoaiHoaDon === 6) {
                    var idDonVi = itemHD[0].ID_DonVi;
                    if (idDonVi === undefined || idDonVi.indexOf('0000') > -1 || idDonVi === null) {
                        idDonVi = id_DonVi; // get from cookie
                    }
                    // phaiTTTraHang = tien ma cua hang phai TT thuc te trong hoa don 
                    var phaiTTTraHang = itemHD[0].TongGiaGocHangTra - itemHD[0].TongGiamGiaDB
                        + itemHD[0].TongThueDB - itemHD[0].TongChiPhiHangTra;
                    var phaiTTMuaMoi = itemHD[0].TongTienHang - itemHD[0].TongGiamGia + itemHD[0].TongTienThue;

                    // if HD offline --> not change MaHoaDon
                    var maHDSave = null;
                    if (itemHD[0].StatusOffline || itemHD[0].MaHoaDon.indexOf('Copy') > -1) {
                        maHDSave = itemHD[0].MaHoaDon;
                    }
                    // check NgayLapHD is null, and get
                    var ngaylapHD = GetNgayLapHD_whenSave(itemHD[0].NgayLapHoaDon);
                    // if TraHang from HD tich diem --> get DiemGD of TraHang--> save DB
                    var diemGD = 0;
                    if (itemHD[0].FromHDTichDiem) {
                        diemGD = GetDiemGiaoDich_HDTraHang(itemHD[0].TongGiaGocHangTra - itemHD[0].TongGiamGiaDB);
                    }
                    // gán ID_TaiKhoanChuyenKhoan + ID_TaiKhoanPos vào cả HDTra + HDMuaMoi
                    var chenhlechTraMua = phaiTTTraHang - phaiTTMuaMoi;
                    var objTraHang = {
                        LoaiHoaDon: 6,
                        ID: const_GuidEmpty,
                        ID_HoaDon: itemHD[0].ID_HoaDon, // ID_HoaDon goc
                        ID_DoiTuong: itemHD[0].ID_DoiTuong,
                        ID_BangGia: itemHD[0].ID_BangGia,
                        ID_NhanVien: itemHD[0].ID_NhanVien,
                        ID_DonVi: idDonVi,
                        NguoiTao: userLogin,
                        NgayLapHoaDon: ngaylapHD,
                        TongTienHang: itemHD[0].TongGiaGocHangTra, // 
                        PhaiThanhToan: phaiTTTraHang,
                        TongThanhToan: phaiTTTraHang,
                        TongGiamGia: itemHD[0].TongGiamGiaDB,
                        TongChiPhi: itemHD[0].TongChiPhiHangTra,
                        DaThanhToan: itemHD[0].DaTraKhach,
                        PTThueHoaDon: itemHD[0].PTThueDB,
                        TongTienThue: itemHD[0].TongThueDB,
                        PTThueBaoHiem: 0,
                        TongTienThueBaoHiem: 0,
                        ChoThanhToan: false,
                        DienGiai: itemHD[0].DienGiai,
                        DVTinhGiam: '%',
                        PTGiam: 0,
                        Status: 1, // open(1) - close(0) : use HDOffline
                        MaHoaDon: maHDSave,
                        StatusOffline: itemHD[0].StatusOffline,
                        TienMat: itemHD[0].TienMat, // luu vao So chi
                        TienGui: itemHD[0].TienGui,
                        TienATM: itemHD[0].TienATM,
                        TienThua: itemHD[0].TienThua,
                        DiemGiaoDich: diemGD, // tra hang thi bi tru diem
                        MaHoaDonTraHang: itemHD[0].MaHoaDonTraHang, // used to get when save history 
                        ID_TaiKhoanChuyenKhoan: itemHD[0].ID_TaiKhoanChuyenKhoan, // tra hang: vẫn cho phép trả = chuyển khoản
                        ID_TaiKhoanPos: null,// always null
                        IsTraNhanh: itemHD[0].IsTraNhanh,// check when save Diary to do update GiaVon,
                        BH_NhanVienThucHiens: [],

                        ChenhLechTraMua: chenhlechTraMua,// used to check at vmThanhToan
                        SoDuDatCoc: itemHD[0].SoDuDatCoc,
                        ID_Xe: itemHD[0].ID_Xe,
                        ID_PhieuTiepNhan: itemHD[0].ID_PhieuTiepNhan,
                    };
                    // if đổi trả gói DV --> loaiHD = 19
                    var loaiHD_DoiTra = 1;
                    if (itemHD[0].MaHoaDon.indexOf('DV') > -1) {
                        loaiHD_DoiTra = 19;
                        // format NgayApDung GoiDV
                        itemHD[0].NgayApDungGoiDV = moment(itemHD[0].NgayApDungGoiDV, 'DD/MM/YYYY').format('YYYY-MM-DD');
                        itemHD[0].HanSuDungGoiDV = moment(itemHD[0].HanSuDungGoiDV, 'DD/MM/YYYY').format('YYYY-MM-DD');
                    }
                    // if MuaMoi < TongTienTra: KhachCanTra = 0, nhung van phai luu PhaiThanhToan = Tong tien ma khach phai Thanh toan
                    var objMuaHang = {
                        LoaiHoaDon: loaiHD_DoiTra,
                        ID: const_GuidEmpty,
                        ID_DoiTuong: itemHD[0].ID_DoiTuong,
                        ID_BangGia: itemHD[0].ID_BangGia,
                        ID_NhanVien: itemHD[0].ID_NhanVien,
                        ID_DonVi: idDonVi,
                        NguoiTao: userLogin,
                        NgayLapHoaDon: moment(ngaylapHD, 'YYYY-MM-DD HH:mm').add(1, 'minutes').format('YYYY-MM-DD HH:mm'),
                        TongTienHang: itemHD[0].TongTienHang,
                        PhaiThanhToan: phaiTTMuaMoi,
                        TongThanhToan: phaiTTMuaMoi + formatNumberToFloat(itemHD[0].PhaiThanhToanBaoHiem),
                        TongGiamGia: itemHD[0].TongGiamGia,
                        DaThanhToan: itemHD[0].DaThanhToan,
                        PTThueHoaDon: itemHD[0].PTThueHoaDon,
                        PTThueBaoHiem: itemHD[0].PTThueBaoHiem,
                        TongTienThue: itemHD[0].TongTienThue,
                        TongTienThueBaoHiem: itemHD[0].TongTienThueBaoHiem,
                        ChiPhi: itemHD[0].TongChiPhi,
                        ChoThanhToan: false,
                        DienGiai: itemHD[0].DienGiai,
                        DVTinhGiam: '%',
                        TongChietKhau: itemHD[0].TongChietKhau,
                        Status: 1, // open(1) - close(0) : use HDOffline
                        MaHoaDon: null,
                        StatusOffline: itemHD[0].StatusOffline,
                        TienMat: itemHD[0].TienMat, // luu vao So thu
                        TienGui: itemHD[0].TienGui,
                        TienATM: itemHD[0].TienATM,
                        TienThua: itemHD[0].TienThua,
                        DiemGiaoDich: itemHD[0].DiemGiaoDich,
                        DiemQuyDoi: itemHD[0].DiemQuyDoi,
                        TTBangDiem: itemHD[0].TTBangDiem,
                        DiemHienTai: itemHD[0].DiemHienTai,
                        DiemKhuyenMai: itemHD[0].DiemKhuyenMai,
                        NgayApDungGoiDV: itemHD[0].NgayApDungGoiDV,
                        HanSuDungGoiDV: itemHD[0].HanSuDungGoiDV,
                        BH_NhanVienThucHiens: [],
                        ID_TaiKhoanChuyenKhoan: itemHD[0].ID_TaiKhoanChuyenKhoan,
                        ID_TaiKhoanPos: itemHD[0].ID_TaiKhoanPos,
                        ID_ViTri: itemHD[0].ID_ViTri,// doitra: co ID_ViTri (VD: tra hang + su dung DV)
                        CreateTime: itemHD[0].CreateTime,
                        ThoiGianThucHien: itemHD[0].ThoiGianThucHien,

                        ChenhLechTraMua: chenhlechTraMua,// used to check at vmThanhToan
                        SoDuDatCoc: itemHD[0].SoDuDatCoc,
                        ID_Xe: itemHD[0].ID_Xe,
                        ID_PhieuTiepNhan: itemHD[0].ID_PhieuTiepNhan,
                    };
                    if (vmThanhToanGara.GridNVienBanGoi_Chosed.length > 0) {
                        objMuaHang.BH_NhanVienThucHiens = vmThanhToanGara.GridNVienBanGoi_Chosed;
                    }
                    // check and assign TienTheGiaTri for objHoaDon --> save Quy_HoaDon
                    if (formatNumberToInt(itemHD[0].HoanTraTamUng) > 0) {
                        objTraHang.TienTheGiaTri = itemHD[0].TienTheGiaTri;
                    }
                    else {
                        objMuaHang.TienTheGiaTri = itemHD[0].TienTheGiaTri;
                    }
                    var objAdd = itemHD[0]; // get to print HoaDon
                    var cthd_TH = localStorage.getItem(lcListCTHD);
                    var arrCTHD_TraHang = [];
                    var arrCTHD_LoHang_TH = [];
                    if (cthd_TH !== null) {
                        cthd_TH = JSON.parse(cthd_TH);
                        arrCTHD_TraHang = $.grep(cthd_TH, function (item) {
                            return item.IDRandomHD === idRandomHD;
                        });
                        // add to do save CTHD
                        for (let i = 0; i < arrCTHD_TraHang.length; i++) {
                            arrCTHD_LoHang_TH.push(arrCTHD_TraHang[i]);
                            for (let j = 1; j < arrCTHD_TraHang[i].DM_LoHang.length; j++) {
                                arrCTHD_LoHang_TH.push(arrCTHD_TraHang[i].DM_LoHang[j]);
                            }
                            for (let j = 0; j < arrCTHD_TraHang[i].HangCungLoais.length; j++) {
                                arrCTHD_LoHang_TH.push(arrCTHD_TraHang[i].HangCungLoais[j]);
                            }
                        }
                        // check add Lot, but not chose Lot
                        var arrIDLo_Null = arrCTHD_LoHang_TH.filter(x => x.QuanLyTheoLoHang && x.ID_LoHang === null);
                        if (arrIDLo_Null.length > 0) {
                            ShowMessage_Danger('Vui lòng nhập đầy đủ thông tin lô cho hàng hóa');
                            SaveHD_RemoveDisable();
                            return;
                        }
                        // Check chưa chọn Lô (vì ID_Lo được sinh từ động, nên có thể ID_Lo !=null, nhưng không tồn tại trong DB)
                        // Hàng trả (không check lô ngừng kinh doanh)
                        var arrLo_notInput = '';
                        for (let j = 0; j < arrCTHD_LoHang_TH.length; j++) {
                            if (arrCTHD_LoHang_TH[j].QuanLyTheoLoHang && arrCTHD_LoHang_TH[j].ID_LoHang !== null) {
                                if (arrCTHD_LoHang_TH[j].MaLoHang === '') {
                                    arrLo_notInput += arrCTHD_LoHang_TH[j].TenHangHoa + ', ';
                                }
                            }
                        }
                        if (arrLo_notInput !== '') {
                            ShowMessage_Danger('Vui lòng nhập đầy đủ thông tin lô cho hàng hóa ' + arrLo_notInput);
                            SaveHD_RemoveDisable();
                            return;
                        }
                        // remove CTHD with QuanLyTheoLo, but ID_Lo== null
                        arrCTHD_LoHang_TH = GetArrCTHD_withIDLoHangOtherNull(arrCTHD_LoHang_TH);
                    }
                    var cthd_MH = localStorage.getItem(lcListCTHD_DoiTra);
                    var arrCTHD_MuaHang = [];
                    var arrCTHD_MuaHang_LoHang = [];
                    if (cthd_MH !== null) {
                        cthd_MH = JSON.parse(cthd_MH);
                        arrCTHD_MuaHang = $.grep(cthd_MH, function (item) {
                            return item.IDRandomHD === idRandomHD;
                        });
                        for (let i = 0; i < arrCTHD_MuaHang.length; i++) {
                            if (arrCTHD_MuaHang[i].SoLuong > 0) {
                                arrCTHD_MuaHang_LoHang.push(arrCTHD_MuaHang[i]);
                            }
                            for (let j = 1; j < arrCTHD_MuaHang[i].DM_LoHang.length; j++) {
                                if (arrCTHD_MuaHang[i].DM_LoHang[j].SoLuong > 0) {
                                    arrCTHD_MuaHang_LoHang.push(arrCTHD_MuaHang[i].DM_LoHang[j]);
                                }
                            }
                            for (let j = 0; j < arrCTHD_MuaHang[i].HangCungLoais.length; j++) {
                                if (arrCTHD_MuaHang[i].HangCungLoais[j].SoLuong > 0) {
                                    arrCTHD_MuaHang_LoHang.push(arrCTHD_MuaHang[i].HangCungLoais[j]);
                                }
                            }
                        }
                        // check add Lot, but not chose Lot
                        var arrIDLo_Null2 = arrCTHD_MuaHang_LoHang.filter(x => x.QuanLyTheoLoHang && x.ID_LoHang === null);
                        if (arrIDLo_Null2.length > 0) {
                            ShowMessage_Danger('Vui lòng nhập đầy đủ thông tin lô cho hàng hóa ');
                            SaveHD_RemoveDisable();
                            return;
                        }
                    }
                    if (arrCTHD_TraHang.length === 0) {
                        ShowMessage_Danger('Vui lòng nhập chi tiết trả hàng');
                        SaveHD_RemoveDisable();
                        return false;
                    }
                    // check MuaMoi enough TonKho
                    var msgErr = "";
                    // khong cho phep mua hang khi het ton 
                    if (self.ThietLap().XuatAm === false) {
                        for (let i = 0; i < arrCTHD_MuaHang.length; i++) {
                            // check TonKho if LaHangHoa = true
                            if (arrCTHD_MuaHang[i].LaHangHoa && arrCTHD_MuaHang[i].SoLuong > arrCTHD_MuaHang[i].TonKho) {
                                msgErr += arrCTHD_MuaHang[i].TenHangHoa + ", ";
                            }
                        }
                        if (msgErr !== "") {
                            msgErr = Remove_LastComma(msgErr);
                            ShowMessage_Danger('Không đủ số lượng tồn kho cho sản phẩm ' + msgErr);
                            SaveHD_RemoveDisable();
                            return false;
                        }
                    }
                    // check if Soluong = 0
                    for (let i = 0; i < arrCTHD_MuaHang.length; i++) {
                        if (arrCTHD_MuaHang[i].SoLuong === 0) {
                            msgErr += arrCTHD_MuaHang[i].TenHangHoa + ", ";
                        }
                    }
                    if (msgErr !== "") {
                        msgErr = Remove_LastComma(msgErr);
                        ShowMessage_Danger('Vui lòng nhập số lượng cho hàng hóa ' + msgErr);
                        SaveHD_RemoveDisable();
                        return false;
                    }
                    // update DonGia in CTHD TraHang if GiaBan > DonGia ban dau (update 21.12.2017)
                    var slTra = 0;
                    var slDaMua = 0;
                    // count SoLuongTra, SoLuongDaMua  --> check xem da tra het chua
                    for (let i = 0; i < arrCTHD_LoHang_TH.length; i++) {
                        arrCTHD_LoHang_TH[i].DonGia = arrCTHD_LoHang_TH[i].GiaBan;
                        slTra += arrCTHD_LoHang_TH[i].SoLuong;
                        slDaMua += arrCTHD_LoHang_TH[i].SoLuongDaMua;
                    }
                    // update DonGia in CTHD DoiTra if GiaBan > DonGia ban dau 
                    for (let i = 0; i < arrCTHD_MuaHang_LoHang.length; i++) {
                        arrCTHD_MuaHang_LoHang[i].DonGia = arrCTHD_MuaHang_LoHang[i].GiaBan;
                    }
                    // remove CTHD with QuanLyTheoLo, but ID_Lo== null
                    arrCTHD_MuaHang_LoHang = GetArrCTHD_withIDLoHangOtherNull(arrCTHD_MuaHang_LoHang);
                    if (arrCTHD_LoHang_TH.length === 0) {
                        ShowMessage_Danger('Vui lòng nhập thông tin hàng trả lại');
                        SaveHD_RemoveDisable();
                        return false;
                    }
                    // Nang/Ha Nhom after update infor KH
                    var myDataTH = {};
                    myDataTH.objHoaDon = objTraHang;
                    myDataTH.objCTHoaDon = arrCTHD_LoHang_TH;
                    myDataTH.IsSetGiaVonTrungBinh = self.ThietLap().GiaVonTrungBinh;
                    // remove cache CTTH with MaHD = 'Tra hang'
                    var cacheCTHH = localStorage.getItem(lcCTHDTraHang_fromHD);
                    if (cacheCTHH !== null) {
                        cacheCTHH = JSON.parse(cacheCTHH);
                        cacheCTHH = $.grep(cacheCTHH, function (x) {
                            return x.IDRandomHD !== idRandomHD;
                        });
                        localStorage.setItem(lcCTHDTraHang_fromHD, JSON.stringify(cacheCTHH));
                    }
                    if (objTraHang.StatusOffline === false) {
                        // update TonKho if HD mua and not offline
                        UpdateTonKho_forListHangHoa_andCTHD(myDataTH.objCTHoaDon, true);
                    }
                    // POST HD Tra
                    UpdateInforKH_inLstDoiTuongs(itemHD[0], slTra = slDaMua);

                    ajaxHelper(BHHoaDonUri + 'PostBH_HoaDon_SoQuy_Spa_NKySuDung', 'POST', myDataTH).done(function (objDB) {
                        if (objDB.res === true) {
                            var itemDB = objDB.data;
                            $('.bgwhite').hide();
                            objTraHang.ID = itemDB.ID;
                            objTraHang.MaHoaDon = itemDB.MaHoaDon;

                            HDTraHang_InsertTPDinhLuong(itemDB.ID);

                            // insert quy if Tong Tra > Khach Mua Moi
                            if (objTraHang.ChenhLechTraMua > 0) {
                                AssignValueHoaDon_ToPhieuThu(objTraHang);
                                vmThanhToanGara.SavePhieuThu();
                            }
                            UpdateDiemKH_toDB(objTraHang.ID_DoiTuong);

                            // Update Diem KH
                            var myDataMH = {};
                            if (arrCTHD_MuaHang_LoHang.length > 0) {
                                if (objMuaHang.StatusOffline === false) {
                                    // update TonKho if HD mua and not offline
                                    UpdateTonKho_forListHangHoa_andCTHD(arrCTHD_MuaHang_LoHang, false);
                                }
                                // save GioVao, GioRa
                                if (objMuaHang.CreateTime !== 0) {
                                    var objTime = GetGioVaoRa_ofHD(objMuaHang);
                                    objMuaHang.GioVao = objTime.GioVao;
                                    objMuaHang.GioRa = objTime.GioRa;
                                }
                                objMuaHang.ID_HoaDon = itemDB.ID;
                                myDataMH.objHoaDon = objMuaHang;
                                myDataMH.objCTHoaDon = arrCTHD_MuaHang_LoHang;
                                myDataMH.IsSetGiaVonTrungBinh = self.ThietLap().GiaVonTrungBinh;

                                ajaxHelper(BHHoaDonUri + 'PostBH_HoaDon_SoQuy_Spa_NKySuDung', 'POST', myDataMH).done(function (objDB2) {
                                    if (objDB2.res === true) {
                                        var itemMH = objDB2.data;
                                        objMuaHang.ID = itemMH.ID;
                                        objMuaHang.MaHoaDon = itemMH.MaHoaDon;

                                        if (objMuaHang.ChenhLechTraMua < 0) {
                                            AssignValueHoaDon_ToPhieuThu(objMuaHang);
                                            vmThanhToanGara.SavePhieuThu(objMuaHang.BH_NhanVienThucHiens);
                                        }
                                        vmThemMoiKhach.NangNhomKhachHang(objMuaHang.ID_DoiTuong);
                                    }

                                    objAdd = GetInforHDPrint(objAdd);

                                    let sumGiamGiaHang = 0, tongChuaTruCK = 0;
                                    sumGiamGiaHang = myDataMH.objCTHoaDon.reduce(function (_this, x) {
                                        return _this + x.TienChietKhau * x.SoLuong;
                                    }, 0);
                                    tongChuaTruCK = myDataMH.objCTHoaDon.reduce(function (_this, x) {
                                        return _this + (x.SoLuong * x.DonGia);
                                    }, 0);
                                    var arrCTHDMH_format = GetCTHDPrint_Format(myDataMH.objCTHoaDon);
                                    self.CTHoaDonPrintMH(arrCTHDMH_format);

                                    objAdd.TongGiamGiaHang = formatNumber3Digit(sumGiamGiaHang);
                                    objAdd.TongTienHangChuaCK = formatNumber3Digit(tongChuaTruCK);
                                    objAdd.TongGiamGiaHD_HH = formatNumber3Digit(sumGiamGiaHang + formatNumberToFloat(objAdd.TongGiamGia));
                                    self.InforHDprintf(objAdd);

                                    self.InHoaDon("DTH", false);

                                    BindHD_CTHDafterSave();
                                    Call_6Func();

                                    let isPrint = Check_AutoPrint(6);
                                    if (!isPrint) {
                                        window.close();
                                    }
                                }).always(function () {
                                    ResetPhieuThu_afterThanhToan();
                                })
                            }
                            else {
                                vmThemMoiKhach.NangNhomKhachHang(objTraHang.ID_DoiTuong);
                            }

                            objAdd.DiemGiaoDich = objMuaHang.DiemGiaoDich - objTraHang.DiemGiaoDich - objMuaHang.DiemQuyDoi;// bind at InHoaDon
                            if (arrCTHD_MuaHang_LoHang.length === 0) {
                                objAdd = GetInforHDPrint(objAdd);
                            }
                            var arrCTHD_format = GetCTHDPrint_Format(myDataTH.objCTHoaDon);
                            self.CTHoaDonPrint(arrCTHD_format); // CTHD tra Hang

                            if (arrCTHD_MuaHang_LoHang.length === 0) {
                                self.InforHDprintf(objAdd);
                                self.InHoaDon("TH", false);
                            }

                            // remove HD after save
                            var lstHDafter = localStorage.getItem(lcListHD);
                            lstHDafter = JSON.parse(lstHDafter);
                            lstHDafter = RemoveHD_byMaHoaDon(_maHoaDon, lstHDafter);
                            localStorage.setItem(lcListHD, JSON.stringify(lstHDafter));
                            // remove CTHoaDon in Cache
                            var cthd = localStorage.getItem(lcListCTHD);
                            if (cthd !== null) {
                                cthd = JSON.parse(cthd);
                                cthd = $.grep(cthd, function (item) {
                                    return item.IDRandomHD !== idRandomHD;
                                });
                                localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
                            }
                            // remove CTHD_Muamoi
                            var cacheCTHD_MH = localStorage.getItem(lcListCTHD_DoiTra);
                            if (cacheCTHD_MH !== null) {
                                cacheCTHD_MH = JSON.parse(cacheCTHD_MH);
                                cacheCTHD_MH = $.grep(cacheCTHD_MH, function (item) {
                                    return item.IDRandomHD !== idRandomHD;
                                });
                                localStorage.setItem(lcListCTHD_DoiTra, JSON.stringify(cacheCTHD_MH));
                            }
                            // get all CTHDTH if TraHang is from HoaDon
                            var cthdTraHang_fromHD = localStorage.getItem(lcCTHDTraHang_fromHD);
                            if (cthdTraHang_fromHD !== null) {
                                cthdTraHang_fromHD = JSON.parse(cthdTraHang_fromHD);
                                cthdTraHang_fromHD = $.grep(cthdTraHang_fromHD, function (x) {
                                    return x.IDRandomHD !== idRandomHD;
                                });
                                localStorage.getItem(lcCTHDTraHang_fromHD, JSON.stringify(cthdTraHang_fromHD));
                            }
                            UpdateWarning_CTHD_afterSave();

                            // chi reset neu trahang
                            // nguoclai: reset sau khi luu hoadon muamoi
                            if (arrCTHD_MuaHang_LoHang.length === 0) {
                                BindHD_CTHDafterSave();
                                Call_6Func();
                            }
                            ShowMessage_Success('Trả hàng thành công');
                        }
                        else {
                            ShowMessage_Danger('Trả hàng thất bại');
                        }
                        UpdateInforKH_toDB(objTraHang.ID_DoiTuong);
                        if (arrCTHD_MuaHang_LoHang.length === 0) {
                            let isPrint = Check_AutoPrint(4);
                            if (!isPrint) {
                                window.close();
                            }
                        }
                    }).always(function () {
                        self.HoaDonTHs([]);
                        SaveHD_RemoveDisable();
                        if (arrCTHD_MuaHang_LoHang.length === 0) {
                            ResetPhieuThu_afterThanhToan();
                        }
                    }).fail(function (x) {
                        var notSaleOffline = self.ThietLap() !== null && self.ThietLap().BanHangOffline === false;
                        if (notSaleOffline) {
                            ShowMessage_Danger('Mất kết nối mạng. Vui lòng thanh toán lại hóa đơn');
                            SaveHD_RemoveDisable();
                            return false;
                        }
                        SaveHDOffline();
                        objAdd = GetInforHDPrint(objAdd);
                        // caculator TongGiamGia all HangHoa
                        var sumGiamGiaHang = arrCTHD_MuaHang.reduce(function (_this, x) {
                            return _this + x.TienChietKhau * x.SoLuong;
                        }, 0);
                        // tongtien HangHoa chua tru chiet khau
                        var tongChuaTruCK = arrCTHD_MuaHang.reduce(function (_this, x) {
                            return _this + (x.SoLuong * x.DonGia);
                        }, 0);
                        objAdd.MaHoaDon = _maHoaDon;
                        objAdd.TongGiamGiaHang = sumGiamGiaHang;
                        objAdd.TongTienHangChuaCK = formatNumber3Digit(tongChuaTruCK);
                        objAdd.TongGiamGiaHD_HH = formatNumber3Digit(sumGiamGiaHang + formatNumberToFloat(objAdd.TongGiamGia));
                        self.InforHDprintf(objAdd);
                        var arrCTHD_format = GetCTHDPrint_Format(arrCTHD_TraHang);
                        var arrCTHDMH_format = GetCTHDPrint_Format(arrCTHD_MuaHang);
                        self.CTHoaDonPrint(arrCTHD_format); // CTHD tra Hang
                        self.CTHoaDonPrintMH(arrCTHDMH_format); // CTHD mua hang
                        if (arrCTHD_MuaHang.length > 0) {
                            self.InHoaDon("DTH", false);
                        }
                        else {
                            self.InHoaDon("TH", false);
                        }

                        BindHD_CTHDafterSave();
                        ShowMessage_Success('Không có kết nối Internet. Giao dịch đã được lưu tạm trên máy');
                        SaveHD_RemoveDisable();
                        Call_6Func();
                    });
                }
                else {
                    switch (itemHD[0].LoaiHoaDon) {
                        case 1:
                        case 19:
                        case 25:
                            self.saveHoaDonKhuyenMai(isTamLuu);
                            break;
                        case 3:
                            self.saveDatHang(false);
                            break;
                    }
                }
            }
            else {
                ShowMessage_Danger('Vui lòng nhập thông tin hóa đơn');
                SaveHD_RemoveDisable();
                return;
            }
        }
        else {
            ShowMessage_Danger('Vui lòng nhập thông tin hóa đơn');
            SaveHD_RemoveDisable();
            return;
        }
    }
    function SaveHDOffline() {
        $('.bgwhite').hide();
        // find itemHD with maHD
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            var itemHD = GetHDOpening_byMaHoaDon(_maHoaDon, lstHD);
            var maHDon = '';
            if (itemHD.length > 0) {
                var idRandomHD = itemHD[0].IDRandom;
                var saveFirst = false;
                if (itemHD[0].StatusOffline === false) {
                    var rd = Math.floor(Math.random() * 1000000 + 1);
                    switch (itemHD[0].LoaiHoaDon) {
                        case 1:
                            maHDon = 'HDO' + rd;
                            break;
                        case 3:
                            maHDon = 'DHO' + rd;
                            break;
                        case 6:
                            maHDon = 'THO' + rd;
                            break;
                        case 19:
                            maHDon = 'GDVO' + rd;
                            break;
                    }
                    for (let i = 0; i < lstHD.length; i++) {
                        if (lstHD[i].IDRandom === idRandomHD) {
                            // nếu cập nhật DatHang: vẫn update MaHoaDon (vì có cập nhật MaHoaDon cho CTHD) (không nên cập nhật mã BG nếu update todo)
                            // nhung trong DB, khong can update Ma
                            lstHD[i].MaHoaDon = maHDon;
                            lstHD[i].Status = 0;
                            lstHD[i].StatusOffline = true;
                            if (lstHD[i].NgayLapHoaDon === null) {
                                lstHD[i].NgayLapHoaDon = moment(new Date()).format('YYYY-MM-DD HH:mm');
                            }
                            break;
                        }
                    }
                    saveFirst = true;
                }
                else {
                    // if save again HDOffline -> change status HDOffline
                    for (let i = 0; i < lstHD.length; i++) {
                        if (lstHD[i].IDRandom === idRandomHD) {
                            lstHD[i].Status = 0;
                            // check NgayLapHD DD/MM/YYYY
                            var ngayLap_formatAgain = GetNgayLapHD_whenSave(lstHD[i].NgayLapHoaDon);
                            lstHD[i].NgayLapHoaDon = ngayLap_formatAgain;
                            break;
                        }
                    }
                    maHDon = _maHoaDon;
                }
                UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();
                // remove ltsHD with maHoaDon = itemHD[0].MaHoaDonTraHang
                for (let i = 0; i < lstHD.length; i++) {
                    if (lstHD[i].LoaiHoaDon === 3 && lstHD[i].MaHoaDon === itemHD[0].MaHoaDonTraHang) {
                        lstHD.splice(i, 1);
                    }
                }
                localStorage.setItem(lcListHD, JSON.stringify(lstHD));
                var cthd = localStorage.getItem(lcListCTHD);
                if (cthd !== null) {
                    cthd = JSON.parse(cthd);
                    // if SoLuong = 0 --> remove from listCTHD
                    cthd = $.grep(cthd, function (item) {
                        return item.SoLuong !== 0;
                    });
                    for (let i = 0; i < cthd.length; i++) {
                        if (cthd[i].IDRandomHD === idRandomHD) {
                            cthd[i].MaHoaDon = maHDon;
                            // update MaHoaDon for Dm_Lo
                            for (let j = 0; j < cthd[i].DM_LoHang.length; j++) {
                                cthd[i].DM_LoHang[j].MaHoaDon = maHDon;
                            }
                            // remove DM_LoHang have QuanLyTheoLo = true, but ID_LoHang= null
                            cthd[i].DM_LoHang = $.grep(cthd[i].DM_LoHang, function (x) {
                                return x.QuanLyTheoLoHang && x.ID_LoHang !== null;
                            })
                        }
                    }
                    localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
                }
                // update Hang KM of HoaDon
                var productKM_ofHD = localStorage.getItem(lcProductKM_HoaDon);
                if (productKM_ofHD !== null) {
                    productKM_ofHD = JSON.parse(productKM_ofHD);
                    for (let i = 0; i < productKM_ofHD.length; i++) {
                        if (productKM_ofHD[i].IDRandomHD === idRandomHD) {
                            productKM_ofHD[i].MaHoaDon = maHDon;
                        }
                    }
                    localStorage.setItem(lcProductKM_HoaDon, JSON.stringify(productKM_ofHD));
                }
                // update maHD offline for HD mua moi of TraHang
                var cthd_TraHang = localStorage.getItem(lcListCTHD_DoiTra);
                if (cthd_TraHang !== null) {
                    cthd_TraHang = JSON.parse(cthd_TraHang);
                    for (let i = 0; i < cthd_TraHang.length; i++) {
                        if (cthd_TraHang[i].IDRandomHD === idRandomHD) {
                            cthd_TraHang[i].MaHoaDon = maHDon;
                            // update MaHoaDon for Dm_Lo
                            for (let j = 0; j < cthd_TraHang[i].DM_LoHang.length; j++) {
                                cthd_TraHang[i].DM_LoHang[j].MaHoaDon = maHDon;
                            }
                            // remove DM_LoHang have QuanLyTheoLo = true, but ID_LoHang= null
                            cthd_TraHang[i].DM_LoHang = $.grep(cthd_TraHang[i].DM_LoHang, function (x) {
                                return x.QuanLyTheoLoHang && x.ID_LoHang !== null;
                            });
                        }
                    }
                    localStorage.setItem(lcListCTHD_DoiTra, JSON.stringify(cthd_TraHang));
                }
                // update status for HDDatHang if sumSoLuong int HD >= sum in lcCTDatHang
                var ctDatHang = localStorage.getItem(lcCTDatHang_Const);
                if (ctDatHang !== null) {
                    ctDatHang = JSON.parse(ctDatHang);
                    var arrIDQuiDoi_DatHang = [];
                    var arrIDLoHang_DatHang = [];
                    var sumConLai = 0;
                    var sumMua = 0;
                    // calculator Sum SoLuongDaMua, Sum SoLuongConLai
                    for (let i = 0; i < ctDatHang.length; i++) {
                        if (ctDatHang[i].MaHoaDon === itemHD[0].MaHoaDonTraHang) {
                            sumConLai += ctDatHang[i].SoLuongConLai;
                            // sum SoluongConLai in DM_Lo
                            for (let k = 1; k < ctDatHang[i].DM_LoHang.length; k++) {
                                if (ctDatHang[i].DM_LoHang[k].SoLuongConLai > 0) {
                                    sumConLai += ctDatHang[i].DM_LoHang[k].SoLuongConLai;
                                    // get ID_LoHang, ID_QuiDoi in cache ctDatHang
                                    arrIDLoHang_DatHang.push(ctDatHang[i].DM_LoHang[k].ID_LoHang);
                                    arrIDQuiDoi_DatHang.push(ctDatHang[i].DM_LoHang[k].ID_DonViQuiDoi);
                                }
                            }
                            for (let k = 0; k < ctDatHang[i].HangCungLoais.length; k++) {
                                if (ctDatHang[i].HangCungLoais[k].SoLuongConLai > 0) {
                                    sumConLai += ctDatHang[i].HangCungLoais[k].SoLuongConLai;
                                    arrIDQuiDoi_DatHang.push(ctDatHang[i].HangCungLoais[k].ID_DonViQuiDoi);
                                }
                            }
                            if (ctDatHang[i].SoLuongConLai > 0) {
                                if (ctDatHang[i].ID_LoHang !== null && ctDatHang[i].QuanLyTheoLoHang) {
                                    // push ID_LoHang from parent
                                    arrIDLoHang_DatHang.push(ctDatHang[i].ID_LoHang);
                                }
                                // get arrID_QuiDoi, arrID_Lo in cache ctDatHang
                                arrIDQuiDoi_DatHang.push(ctDatHang[i].ID_DonViQuiDoi);
                            }
                        }
                    }
                    // get unique ID (because if same ID_QuiDoi, ID_Lo same)
                    arrIDLoHang_DatHang = $.unique(arrIDLoHang_DatHang.sort());
                    arrIDQuiDoi_DatHang = $.unique(arrIDQuiDoi_DatHang.sort());
                    var arrIDQuiDoi_CTHD = [];
                    var arrIDLoHang_CTHD = [];
                    for (let j = 0; j < cthd.length; j++) {
                        var objCTHD = cthd[j];
                        if (objCTHD.IDRandomHD === idRandomHD) {
                            // sum SoLuongMua of HH same IDQuiDoi and (IDLoHang !=null || ID_LoHang must in arrIDLoHang)
                            if ($.inArray(objCTHD.ID_DonViQuiDoi, arrIDQuiDoi_DatHang) > -1
                                && (objCTHD.ID_LoHang === null || $.inArray(objCTHD.ID_LoHang, arrIDLoHang_DatHang) > -1)) {
                                sumMua += parseFloat(objCTHD.SoLuong);
                            }
                            // add ID_QuiDoi if exist in arrQuiDoi DatHang
                            if ($.inArray(objCTHD.ID_DonViQuiDoi, arrIDQuiDoi_CTHD) === -1 && $.inArray(objCTHD.ID_DonViQuiDoi, arrIDQuiDoi_DatHang) > -1) {
                                arrIDQuiDoi_CTHD.push(objCTHD.ID_DonViQuiDoi);
                            }
                            // add ID_LoHang if exist in arrLoHang DatHang
                            if ($.inArray(objCTHD.ID_LoHang, arrIDLoHang_CTHD) === -1 && objCTHD.ID_LoHang !== null
                                && $.inArray(objCTHD.ID_LoHang, arrIDLoHang_DatHang) > -1) {
                                arrIDLoHang_CTHD.push(objCTHD.ID_LoHang);
                            }
                            // sum && get ID_LoHang, ID_QuiDoi in DM_LoHang
                            for (let k = 1; k < cthd[j].DM_LoHang.length; k++) {
                                var itemLo = cthd[j].DM_LoHang[k];
                                if ($.inArray(itemLo.ID_DonViQuiDoi, arrIDQuiDoi_DatHang) > -1
                                    && (itemLo.ID_LoHang === null || $.inArray(itemLo.ID_LoHang, arrIDLoHang_DatHang) > -1)) {
                                    sumMua += parseFloat(itemLo.SoLuong);
                                }
                                // add ID_QuiDoi if exist in arrQuiDoi DatHang
                                if ($.inArray(itemLo.ID_DonViQuiDoi, arrIDQuiDoi_CTHD) === -1 && $.inArray(itemLo.ID_DonViQuiDoi, arrIDQuiDoi_DatHang) > -1) {
                                    arrIDQuiDoi_CTHD.push(itemLo.ID_DonViQuiDoi);
                                }
                                // add ID_LoHang if exist in arrLoHang DatHang
                                if ($.inArray(itemLo.ID_LoHang, arrIDLoHang_CTHD) === -1 && itemLo.ID_LoHang !== null
                                    && $.inArray(itemLo.ID_LoHang, arrIDLoHang_DatHang) > -1) {
                                    arrIDLoHang_CTHD.push(itemLo.ID_LoHang);
                                }
                            }
                        }
                    }
                    // get unique ID (because if same ID_QuiDoi, ID_Lo same)
                    arrIDLoHang_CTHD = $.unique(arrIDLoHang_CTHD.sort());
                    // if (len QuiDoi + len Lohang) in DatHang = (len QuiDoi + len Lohang) in CTHD
                    if (sumMua >= sumConLai && arrIDQuiDoi_DatHang.length === arrIDQuiDoi_CTHD.length && arrIDLoHang_DatHang.length === arrIDLoHang_CTHD.length) {
                        self.StatusHD(3);
                        self.ID_HoaDonUpdate(itemHD[0].ID_HoaDon);
                        // add data to indexDBlocal
                        AddHDDatHang_updateStatus();
                    }
                    else {
                        self.ID_HoaDonUpdate(itemHD[0].ID_HoaDon);
                        self.NotEndInvoice();
                        //$('#modalpopup_endDonDH').modal('show');
                    }
                }
                // update SoLuongConLai for BH_HoaDonChiTiet in HDDatHang offline
                db.HDDatHang_Offline.get(self.ID_HoaDonUpdate(), function (x) {
                    // delete in HDDatHang status
                    db.HDDatHang_UpdateStatus.get(self.ID_HoaDonUpdate(), function (x1) {
                        if (x1 !== undefined && x1.Status === 3) {
                            db.HDDatHang_UpdateStatus.delete(self.ID_HoaDonUpdate());
                        }
                    })
                });
                // update TonKho if save Offline lan 1 (Tra +, Mua -)
                if (saveFirst) {
                    // get CTHD is doing save
                    var cthd_using = cthd.filter(x => x.IDRandomHD === idRandomHD);
                    switch (itemHD[0].LoaiHoaDon) {
                        case 1:
                            // Mua -
                            UpdateTonKho_forListHangHoa_andCTHD(cthd_using, false);
                            break;
                        case 6:
                            // Tra +
                            UpdateTonKho_forListHangHoa_andCTHD(cthd_using, true);
                            // Mua -
                            var ctDoiTra = localStorage.getItem(lcListCTHD_DoiTra);
                            if (ctDoiTra !== null) {
                                ctDoiTra = JSON.parse(ctDoiTra);
                                ctDoiTra = ctDoiTra.filter(x => x.IDRandomHD === idRandomHD);
                                if (ctDoiTra.length > 0) {
                                    UpdateTonKho_forListHangHoa_andCTHD(ctDoiTra, false);
                                }
                            }
                            break;
                    }
                    // update warning CTHD, CTHD_DoiTra
                    UpdateWarning_CTHD_afterSave();
                }
            }
            // count HD offline
            var lstHDO = $.grep(lstHD, function (item) {
                return item.StatusOffline === true && item.NguoiTao === userLogin && item.ID_DonVi === id_DonVi;
            });
            self.HoaDonOffline(lstHDO);
            self.countHDoffilne(lstHDO.length);
            _maHoaDon = maHDon; // assign to do print
            self.HoaDons().MaHoaDon(maHDon);
            localStorage.setItem(lcMaHD, maHDon);
        }
    }
    function AddHDDatHang_updateStatus() {
        let tbl = db.HDDatHang_UpdateStatus;
        tbl.get(self.ID_HoaDonUpdate(), function (item) {
            tbl.put({ ID: self.ID_HoaDonUpdate(), Status: self.StatusHD() });
        });
    }
    // MuaHang(tru TonKho), TraHang(cong TonKho)
    // use when list HangHoa = list HangHoa + list LoHang
    function UpdateTonKho_forListHangHoa_andCTHD(objCTHD, isTraHang) {
        var idRandomHD = objCTHD[0].IDRandomHD;
        // update TonKho for cthd con lai
        var ctMua = localStorage.getItem(lcListCTHD);
        if (ctMua !== null) {
            ctMua = JSON.parse(ctMua);
            for (let i = 0; i < ctMua.length; i++) {
                // chi update nhung hang hoa con lai chua luu HoaDon
                if (ctMua[i].IDRandomHD !== idRandomHD) {
                    for (let j = 0; j < objCTHD.length; j++) {
                        let ctOld = objCTHD[j];
                        if (ctOld.ID_DonViQuiDoi === ctMua[i].ID_DonViQuiDoi && ctOld.LaHangHoa) {
                            if (ctOld.QuanLyTheoLoHang) {
                                for (let k = 0; i < ctMua[i].DM_LoHang.length; i++) {
                                    if (ctOld.ID_LoHang === ctMua[i].DM_LoHang[k].ID_LoHang) {
                                        if (isTraHang) {
                                            ctMua[i].DM_LoHang[k].TonKho = ctMua[i].DM_LoHang[k].TonKho + ctOld.SoLuong;
                                        }
                                        else {
                                            ctMua[i].DM_LoHang[k].TonKho = ctMua[i].DM_LoHang[k].TonKho - ctOld.SoLuong;
                                        }
                                        break;
                                    }
                                }
                                if (ctOld.ID_LoHang === ctMua[i].ID_LoHang) {
                                    if (isTraHang) {
                                        ctMua[i].TonKho = ctMua[i].TonKho + ctOld.SoLuong;
                                    }
                                    else {
                                        ctMua[i].TonKho = ctMua[i].TonKho - ctOld.SoLuong;
                                    }
                                    break;
                                }
                            }
                            else {
                                if (isTraHang) {
                                    ctMua[i].TonKho = ctMua[i].TonKho + ctOld.SoLuong;
                                }
                                else {
                                    ctMua[i].TonKho = ctMua[i].TonKho - ctOld.SoLuong;
                                }
                                break;
                            }
                        }
                    }
                }
            }
            localStorage.setItem(lcListCTHD, JSON.stringify(ctMua));
        }

        // update TonKho for cthd_DoiTra
        var ctDoi = localStorage.getItem(lcListCTHD_DoiTra);
        if (ctDoi !== null) {
            ctDoi = JSON.parse(ctDoi);
            for (let i = 0; i < ctDoi.length; i++) {
                // chi update nhung hang hoa con lai chua luu HoaDon
                if (ctDoi[i].IDRandomHD !== idRandomHD) {
                    for (let j = 0; j < objCTHD.length; j++) {
                        let ctOld = objCTHD[j];
                        if (ctOld.ID_DonViQuiDoi === ctDoi[i].ID_DonViQuiDoi && ctOld.LaHangHoa) {
                            if (ctOld.QuanLyTheoLoHang) {
                                for (let k = 0; i < ctDoi[i].DM_LoHang.length; i++) {
                                    if (ctOld.ID_LoHang === ctDoi[i].DM_LoHang[k].ID_LoHang) {
                                        if (isTraHang) {
                                            ctDoi[i].DM_LoHang[k].TonKho = ctDoi[i].DM_LoHang[k].TonKho + ctOld.SoLuong;
                                        }
                                        else {
                                            ctDoi[i].DM_LoHang[k].TonKho = ctDoi[i].DM_LoHang[k].TonKho - ctOld.SoLuong;
                                        }
                                        break;
                                    }
                                }
                                if (ctOld.ID_LoHang === ctDoi[i].ID_LoHang) {
                                    if (isTraHang) {
                                        ctDoi[i].TonKho = ctDoi[i].TonKho + ctOld.SoLuong;
                                    }
                                    else {
                                        ctDoi[i].TonKho = ctDoi[i].TonKho - ctOld.SoLuong;
                                    }
                                    break;
                                }
                            }
                            else {
                                if (isTraHang) {
                                    ctDoi[i].TonKho = ctDoi[i].TonKho + ctOld.SoLuong;
                                }
                                else {
                                    ctDoi[i].TonKho = ctDoi[i].TonKho - ctOld.SoLuong;
                                }
                                break;
                            }
                        }
                    }
                }
            }
            localStorage.setItem(lcListCTHD_DoiTra, JSON.stringify(ctDoi));
        }
    }
    // update warning For CTHD con lai (because after ThanhToan, TonKho will be change)
    function UpdateWarning_CTHD_afterSave() {
        var cthd = localStorage.getItem(lcListCTHD);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            for (let i = 0; i < cthd.length; i++) {
                let itemCTHD = cthd[i];
                let laHangHoa = itemCTHD.LaHangHoa;
                let loaiHD = itemCTHD.LoaiHoaDon;
                let xuatAm = true;
                switch (loaiHD) {
                    case 1:
                        xuatAm = self.ThietLap().XuatAm;
                        break;
                    case 3:
                        xuatAm = self.ThietLap().DatHangXuatAm;
                        break;
                }
                cthd[i].CssWarning = (xuatAm === false && laHangHoa && itemCTHD.TonKho < itemCTHD.SoLuong);
                for (let j = 0; j < itemCTHD.DM_LoHang.length; j++) {
                    cthd[i].DM_LoHang[j].CssWarning = (xuatAm === false && laHangHoa && itemCTHD.DM_LoHang[j].TonKho < itemCTHD.DM_LoHang[j].SoLuong);
                }
            }
            localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
        }
        var cthd_DT = localStorage.getItem(lcListCTHD_DoiTra);
        if (cthd_DT !== null) {
            cthd_DT = JSON.parse(cthd_DT);
            let xuatAm2 = self.ThietLap().XuatAm;
            for (let i = 0; i < cthd_DT.length; i++) {
                let itemCTHD = cthd_DT[i];
                let laHangHoa2 = itemCTHD.LaHangHoa;
                cthd_DT[i].CssWarning = (xuatAm2 === false && laHangHoa2 && itemCTHD.TonKho < itemCTHD.SoLuong);
                for (let j = 0; j < itemCTHD.DM_LoHang.length; j++) {
                    cthd_DT[i].DM_LoHang[j].CssWarning = (xuatAm2 === false && laHangHoa2 && itemCTHD.DM_LoHang[j].TonKho < itemCTHD.DM_LoHang[j].SoLuong);
                }
            }
            localStorage.setItem(lcListCTHD_DoiTra, JSON.stringify(cthd_DT));
        }
    }

    function GetMaHoaDonNew_byRole() {
        var maHDNew = nameHD_InsertBH + 1;
        var loaiHD = 1;
        if (!self.RoleInsert_Invoice()) {
            if (self.RoleInsert_Order()) {
                maHDNew = nameHD_InsertDH + '1';
                loaiHD = 3;
            }
            else {
                if (self.RoleInsert_Service()) {
                    maHDNew = nameHD_AddGoiDV + '1';
                    loaiHD = 19;
                }
                else {
                    if (self.RoleInsert_Return()) {
                        maHDNew = nameHD_TraHang + '1';
                        loaiHD = 6;
                    }
                    else {

                    }
                }
            }
        }
        return {
            MaHoaDon: maHDNew,
            LoaiHoaDon: loaiHD,
        }
    }
    function BindHD_CTHDafterSave() {
        // bind list HD by permission
        var lstHD = localStorage.getItem(lcListHD);
        var maHDNew = GetMaHoaDonNew_byRole().MaHoaDon;
        var idRandom = '';

        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            var arrPB_HD = GetListHD_Opening();
            if (arrPB_HD.length > 0) {
                // bind CTHoaDon with MaHon = last-child
                var hdLast = [];
                var maHDCache = localStorage.getItem(lcMaHD);
                if (maHDCache !== null && maHDCache !== '' && maHDCache !== 'null') {
                    hdLast = GetHDOpening_byMaHoaDon(maHDCache, arrPB_HD);
                    if (hdLast.length === 0) {
                        hdLast = arrPB_HD[arrPB_HD.length - 1];
                    }
                    else {
                        hdLast = hdLast[0];
                    }
                }
                else {
                    hdLast = arrPB_HD[arrPB_HD.length - 1];
                }

                _maHoaDon = hdLast.MaHoaDon;
                idRandom = hdLast.IDRandom;
                self.IDPhongBan_Chosing(hdLast.ID_ViTri);
                GetInForCustomer_byID(hdLast.ID_DoiTuong);
                self.SetNhanVien(hdLast.ID_NhanVien);
                self.SetChiNhanh(hdLast.ID_DonVi);
                BindLstBangGia_byNhanVien_andDoiTuong();
                self.SetBangGia(hdLast.ID_BangGia);
                BindHD_byIDRandom(idRandom);
                BindCTHD_byIDRandomHD(idRandom);
                OnOff_Timer(hdLast.NgayLapHoaDon);

                if (hdLast.StatusOffline === false) {
                    //$('input, select').removeAttr('disabled');
                }
            }
            else {
                let objEmpty = newHoaDon(1, 1);
                _maHoaDon = maHDNew;
                idRandom = objEmpty.IDRandom;
                self.PhongBanSelected([])
                self.PhongBanSelected.push(objEmpty);
                self.resetInforHD_CTHD(maHDNew);
                self.IDPhongBan_Chosing(null);
                ClearTextSearch();
                $('#txtDaThanhToan').text('');
                stopTimer();
                timer();
            }
            // bind HDOffline
            var lstHDO = $.grep(lstHD, function (x) {
                return x.StatusOffline === true && x.ID_DonVi === id_DonVi && x.NguoiTao === userLogin;
            });
            self.HoaDonOffline(lstHDO);
            self.countHDoffilne(lstHDO.length);
        }
        else {
            let objEmpty = newHoaDon(1, 1);
            var idBangGiaNew = objEmpty.ID_BangGia;
            if (idBangGiaNew !== undefined && idBangGiaNew !== null && idBangGiaNew !== const_GuidEmpty) {
                // add new HD with BanGia old --> keep BangGia after refresh
                lstHD = [];
                lstHD.push(objEmpty);
                localStorage.setItem(lcListHD, JSON.stringify(lstHD));
            }
            _maHoaDon = maHDNew;
            idRandom = objEmpty.IDRandom;
            self.PhongBanSelected([]);
            self.PhongBanSelected.push(objEmpty);
            self.resetInforHD_CTHD(maHDNew);
            self.IDPhongBan_Chosing(null);
            self.HoaDonOffline([]);
            self.countHDoffilne(0);
            ClearTextSearch();
            timer();
        }
        localStorage.setItem(lcMaHD, _maHoaDon);
        // get maHoaDon after close or Save
        GetCurrentPage_byMaHoaDon(_maHoaDon);
        localStorage.setItem('lcIDRandom', idRandom); // used to get at form DisplayCustomer when first load
    }

    function Bind_CTHĐoiTra_afterHideColumn() {
        if (_maHoaDon === '') {
            _maHoaDon = $('.gara-bill-label li.active font').text();
        }
        var loaiHD = GetLoaiHoaDon_ofHDopening();
        var cthd_TH = localStorage.getItem(lcListCTHD_DoiTra);
        if (cthd_TH !== null && cthd_TH !== '[]') {
            cthd_TH = JSON.parse(cthd_TH);
            // hide divMuaHang if not CTHD
            var idRandomHD = GetIDRandomHD_byMaHoaDon(_maHoaDon);
            var arrCTHD = $.grep(cthd_TH, function (itemCT) {
                return itemCT.IDRandomHD === idRandomHD;
            });
            // hide divMuaHang if not CTHD
            if (loaiHD === 6 && arrCTHD.length === 0) {
                $('#divMuaHang').css('display', 'none');
            }
            // bind CTHoaDOn
            self.NewProducts(arrCTHD);
        }
    }
    function GetInforHDPrint(objHD) {
        var tenDTuong = 'Khách lẻ';
        var itemEx = self.ChiTietDoiTuong();
        var notruoc = 0;
        var nosau = 0;
        var address = '';
        var phone = '';
        var maKH = '';
        var tongdiemKH = '';
        var ngaysinh = '';
        var tenNhomKH = 'Nhóm mặc định';
        var tongTaiKhoanThe = 0;
        var tongSuDungThe_TruocDo = 0;
        var soDuConLai_TruocDo = 0;
        var cusTax = '', soTK = '';
        var objPrint = $.extend({}, objHD);

        if (itemEx.length === 0) {
            // find in lst KH offline
            var khOffline = localStorage.getItem(lcDM_DoiTuong);
            if (khOffline !== null) {
                khOffline = JSON.parse(khOffline);
                var itemKH = $.grep(khOffline, function (item) {
                    return item.MaHoaDon === objPrint.MaHoaDon;
                });
                if (itemKH.length > 0) {
                    itemEx = itemKH;
                }
            }
        }
        if (itemEx.length > 0) {
            maKH = itemEx[0].MaDoiTuong;
            tenDTuong = itemEx[0].TenDoiTuong;
            address = itemEx[0].DiaChi;
            phone = itemEx[0].DienThoai;
            tongdiemKH = itemEx[0].TongTichDiem;
            notruoc = itemEx[0].NoTruoc;
            nosau = itemEx[0].NoHienTai;
            ngaysinh = itemEx[0].NgaySinh_NgayTLap === null ? '' : moment(itemEx[0].NgaySinh_NgayTLap).format('DD/MM/YYYY');
            tenNhomKH = itemEx[0].TenNhomDT;
            cusTax = itemEx[0].MaSoThue;
            soTK = itemEx[0].TaiKhoanNganHang;

            if (self.ChiTietDoiTuong() !== undefined && self.ChiTietDoiTuong() !== null && self.ChiTietDoiTuong().length > 0) {
                // lấy thông tin Thẻ giá trị từ Khách hàng đang chọn (phải get trước khi reset hoặc bind lại infor hóa đơn)
                tongTaiKhoanThe = vmThanhToanGara.theGiaTriCus.TongNapThe;
                tongSuDungThe_TruocDo = vmThanhToanGara.theGiaTriCus.SuDungThe - vmThanhToanGara.theGiaTriCus.HoanTraTheGiaTri;
                if (tongSuDungThe_TruocDo < 0) {
                    tongTaiKhoanThe += Math.abs(tongSuDungThe_TruocDo);
                }
                soDuConLai_TruocDo = vmThanhToanGara.theGiaTriCus.SoDuTheGiaTri;
            }
        }
        // khach hang
        phone = (phone === null || phone === undefined) ? '' : phone; // check phone null
        objPrint.MaDoiTuong = maKH;
        objPrint.TenDoiTuong = tenDTuong;
        objPrint.DiaChiKhachHang = address;
        objPrint.DienThoaiKhachHang = phone;
        objPrint.NgaySinh_NgayTLap = ngaysinh;
        objPrint.TongTichDiem = tongdiemKH;
        objPrint.TenNhomKhach = Remove_LastComma(tenNhomKH);
        objPrint.MaSoThue = cusTax;
        objPrint.TaiKhoanNganHang = soTK;

        if (objPrint.NgayLapHoaDon === null) {
            objPrint.NgayLapHoaDon = moment(new Date()).format('DD/MM/YYYY HH:mm');
        }
        else {
            objPrint.NgayLapHoaDon = moment(objHD.NgayLapHoaDon, 'YYYY-MM-DD HH:mm').format('DD/MM/YYYY HH:mm');
        }
        var ngaylapHD = objPrint.NgayLapHoaDon;
        objPrint.Ngay = moment(ngaylapHD, 'DD/MM/YYYY HH:mm').format('DD');
        objPrint.Thang = moment(ngaylapHD, 'DD/MM/YYYY HH:mm').format('MM');
        objPrint.Nam = moment(ngaylapHD, 'DD/MM/YYYY HH:mm').format('YYYY');

        // nhan vien BH
        var staffName = '';
        var itemNV = $.grep(self.NhanViens(), function (item) {
            return item.ID === objPrint.ID_NhanVien;
        });
        if (itemNV.length > 0) {
            staffName = itemNV[0].TenNhanVien;
        }
        objPrint.NhanVienBanHang = staffName;
        // chi nhanh
        objPrint.TenChiNhanh = '';
        objPrint.DienThoaiChiNhanh = '';
        objPrint.DiaChiChiNhanh = '';
        var itemChiNhanh = $.grep(self.ChiNhanhs(), function (item) {
            return item.ID === id_DonVi;
        });
        if (itemChiNhanh.length > 0) {
            objPrint.TenChiNhanh = itemChiNhanh[0].TenDonVi;
            objPrint.DienThoaiChiNhanh = itemChiNhanh[0].SoDienThoai;
            objPrint.DiaChiChiNhanh = itemChiNhanh[0].DiaChi;
        }
        // congty
        if (self.CongTy() !== null && self.CongTy().length > 0) {
            objPrint.LogoCuaHang = Open24FileManager.hostUrl + self.CongTy()[0].DiaChiNganHang;
            objPrint.TenCuaHang = self.CongTy()[0].TenCongTy;
            objPrint.DiaChiCuaHang = self.CongTy()[0].DiaChi;
        }
        // tong tien
        var tongcong = formatNumberToInt(objPrint.TongThanhToan);
        var daThanhToan = 0;
        var ptKhach = vmThanhToanGara.PhieuThuKhachPrint;
        var ptBaoHiem = vmThanhToanGara.PhieuThuBaoHiemPrint;

        var khach_mat = formatNumberToFloat(ptKhach.TienMat);
        var khach_ck = formatNumberToFloat(ptKhach.TienCK);
        var khach_pos = formatNumberToFloat(ptKhach.TienPOS);
        var khach_thegt = formatNumberToFloat(ptKhach.TienTheGiaTri);
        var khach_diem = formatNumberToFloat(ptKhach.TTBangDiem);
        var khach_coc = formatNumberToFloat(ptKhach.TienDatCoc);
        var khach_tt = formatNumberToFloat(ptKhach.DaThanhToan);
        var khachthieu = khach_tt - objHD.PhaiThanhToan;
        var khachthua = 0;

        var bh_mat = formatNumberToFloat(ptBaoHiem.TienMat);
        var bh_ck = formatNumberToFloat(ptBaoHiem.TienCK);
        var bh_pos = formatNumberToFloat(ptBaoHiem.TienPOS);
        var bh_thegt = formatNumberToFloat(ptBaoHiem.TienTheGiaTri);
        var bh_diem = formatNumberToFloat(ptBaoHiem.TTBangDiem);
        var bh_coc = formatNumberToFloat(ptBaoHiem.TienDatCoc);
        var bh_tt = formatNumberToFloat(ptBaoHiem.DaThanhToan);
        var bh_thieu = bh_tt - objHD.PhaiThanhToanBaoHiem;
        var bh_thua = 0;

        var hd_thieu = khach_tt + bh_tt - objHD.TongThanhToan;;
        var hd_thua = 0;

        if (khachthieu < 0) {
            khachthieu = Math.abs(khachthieu);
        }
        else {
            khachthua = Math.abs(khachthieu);
        }
        if (bh_thieu < 0) {
            bh_thieu = Math.abs(bh_thieu);
        }
        else {
            bh_thua = Math.abs(bh_thieu);
        }

        if (hd_thieu < 0) {
            hd_thieu = Math.abs(hd_thieu);
        }
        else {
            hd_thua = Math.abs(hd_thieu);
        }

        objPrint.KhachDaTra = formatNumber3Digit(khach_tt);
        objPrint.BaoHiemDaTra = formatNumber3Digit(bh_tt);
        objPrint.PhuongThucTT = '';

        if (ptKhach.DaThanhToan > 0) {
            objPrint.TienMat = formatNumber3Digit(khach_mat + bh_mat);
            objPrint.TienATM = formatNumber3Digit(khach_pos + bh_pos);
            objPrint.ChuyenKhoan = formatNumber3Digit(khach_ck + bh_ck);
            objPrint.TienTheGiaTri = formatNumber3Digit(khach_thegt + bh_thegt);
            objPrint.TienDoiDiem = formatNumber3Digit(khach_diem + bh_diem);
            objPrint.ID_TaiKhoanPos = ptKhach.ID_TaiKhoanPos;
            objPrint.ID_TaiKhoanChuyenKhoan = ptKhach.ID_TaiKhoanChuyenKhoan;
            objPrint.TraLaiTienDatCoc = ptKhach.TienDatCoc;
            objPrint.TTBangTienCoc = khach_coc;
            objPrint.PhuongThucTT = ptKhach.PhuongThucTT;

            daThanhToan = khach_tt;
            tongSuDungThe_TruocDo += khach_thegt;
            soDuConLai_TruocDo -= khach_thegt;// trừ tiền sử dụng thẻ
        }
        else {
            objPrint.TienMat = 0; // formatNumber3Digit(objHD.DaThanhToan);
            objPrint.TienATM = 0;
            objPrint.ChuyenKhoan = 0;
            objPrint.TienTheGiaTri = 0;
            objPrint.TienDoiDiem = 0;
            objPrint.ID_TaiKhoanPos = null;
            objPrint.ID_TaiKhoanChuyenKhoan = null;

            daThanhToan = 0;//objHD.DaThanhToan;

            if (bh_tt > 0) {
                objPrint.PhuongThucTT = ptBaoHiem.PhuongThucTT;
            }
        }
        objPrint.DaThanhToan = formatNumber3Digit(daThanhToan);
        objPrint.TenNganHangPOS = ptKhach.TenNganHangPos;
        objPrint.TenChuThePOS = ptKhach.TenChuThePos;
        objPrint.SoTaiKhoanPOS = ptKhach.SoTaiKhoanPos;

        objPrint.TenNganHangChuyenKhoan = ptKhach.TenNganHangCK;
        objPrint.TenChuTheChuyenKhoan = ptKhach.TenChuTheCK;
        objPrint.SoTaiKhoanChuyenKhoan = ptKhach.SoTaiKhoanCK;

        // if TraKhach
        if (objHD.HoanTraTamUng > 0) {
            tongSuDungThe_TruocDo -= khach_thegt; // trừ tiền sử dụng (vì trả lại TKThẻ)
            soDuConLai_TruocDo += khach_thegt;// cộng tiền vào TKThe
            tongcong = formatNumberToInt(objHD.HoanTraTamUng);
        }

        tongSuDungThe_TruocDo = tongSuDungThe_TruocDo < 0 ? 0 : tongSuDungThe_TruocDo;
        soDuConLai_TruocDo = soDuConLai_TruocDo < 0 ? 0 : soDuConLai_TruocDo;

        objPrint.TongCong = formatNumber3Digit(objHD.TongThanhToan);
        objPrint.TongTienTraHang = formatNumber3Digit(objHD.TongGiaGocHangTra);
        objPrint.TongTienTra = formatNumber3Digit(objHD.TongTienTra);
        objPrint.TongChiPhi = formatNumber3Digit(objHD.TongChiPhi);
        objPrint.TongChiPhiHangTra = formatNumber3Digit(objHD.TongChiPhiHangTra);
        objPrint.PhaiTraKhach = formatNumber3Digit(objHD.HoanTraTamUng);
        objPrint.DaTraKhach = formatNumber3Digit(objHD.DaTraKhach);
        objPrint.TongTaiKhoanThe = formatNumber3Digit(tongTaiKhoanThe);
        objPrint.TongSuDungThe = formatNumber3Digit(tongSuDungThe_TruocDo);
        objPrint.SoDuConLai = formatNumber3Digit(soDuConLai_TruocDo);
        objPrint.TongTienHoaDonMua = formatNumber3Digit(objHD.TongTienHang);
        objPrint.TongTienThue = formatNumber3Digit(objHD.TongTienThue);
        objPrint.TongThueKhachHang = formatNumber3Digit(objHD.TongThueKhachHang);
        objPrint.TongThueDB = formatNumber3Digit(objHD.TongThueDB);
        objPrint.TongSoLuongHang = formatNumber3Digit(self.SumQuantity());
        objPrint.TenPhongBan = objHD.TenViTriHD;
        objPrint.TongGiamGia = formatNumber3Digit(objHD.TongGiamGia);
        objPrint.TongGiamGiaHangTra = formatNumber3Digit(objHD.TongGiamGiaDB);
        objPrint.TienBangChu = DocSo(objHD.PhaiThanhToan);

        objPrint.TongKhach_BHThanhToan = formatNumber3Digit(khach_tt + bh_tt);
        objPrint.PhaiThanhToan = formatNumber3Digit(objHD.PhaiThanhToan);
        objPrint.PhaiThanhToanBaoHiem = formatNumber3Digit(objHD.PhaiThanhToanBaoHiem);
        objPrint.TongTienHang = formatNumber3Digit(objPrint.TongTienHoaDonMua);
        objPrint.DiemGiaoDich = formatNumber3Digit(objHD.DiemGiaoDich);
        objPrint.NoTruoc = formatNumber3Digit(notruoc);
        objPrint.NoSau = formatNumber3Digit(nosau);
        objPrint.BH_TenLienHe = objHD.LienHeBaoHiem;
        objPrint.BH_SDTLienHe = objHD.SoDienThoaiLienHeBaoHiem;

        objPrint.TienThua = formatNumber3Digit(khachthua);
        objPrint.TienKhachThieu = formatNumber3Digit(khachthieu);
        objPrint.BH_TienThua = formatNumber3Digit(bh_thua);
        objPrint.BH_ConThieu = formatNumber3Digit(bh_thieu);
        objPrint.HD_TienThua = formatNumber3Digit(hd_thieu);
        objPrint.HD_ConThieu = formatNumber3Digit(hd_thua);
        objPrint.KH_TienBangChu = DocSo(objHD.PhaiThanhToan);

        objPrint.TongTienHangChuaCK = formatNumber3Digit(objHD.TongTienHangChuaCK);
        objPrint.TongGiamGiaHang = formatNumber3Digit(objHD.TongGiamGiaHang);
        objPrint.TongGiamGiaHD_HH = formatNumber3Digit(objHD.TongGiamGiaHang + objHD.TongGiamGiaKM_HD);
        objPrint.TongTienBHDuyet = formatNumber3Digit(objHD.TongTienBHDuyet);
        objPrint.KhauTruTheoVu = formatNumber3Digit(objHD.KhauTruTheoVu);
        objPrint.GiamTruBoiThuong = formatNumber3Digit(objHD.GiamTruBoiThuong);
        objPrint.BHThanhToanTruocThue = formatNumber3Digit(objHD.BHThanhToanTruocThue);
        objPrint.TongTienThueBaoHiem = formatNumber3Digit(objHD.TongTienThueBaoHiem);
        objPrint.BH_TienBangChu = DocSo(objHD.PhaiThanhToanBaoHiem);

        // nhanvienthuchien
        let nvHoaDon = '';
        let nvHoaDon_inCK = '';
        if (objPrint.BH_NhanVienThucHiens !== null && objPrint.BH_NhanVienThucHiens.length > 0) {
            for (let i = 0; i < objPrint.BH_NhanVienThucHiens.length; i++) {
                let nv = objPrint.BH_NhanVienThucHiens[i];
                nvHoaDon += nv.TenNhanVien + ', ';
                nvHoaDon_inCK += nv.TenNhanVien.concat(nv.PT_ChietKhau > 0 ? ' ('.concat(nv.PT_ChietKhau, ' %)') : ' ('.concat(formatNumber3Digit(nv.TienChietKhau), ')'), ', ');
            }
        }
        objPrint.ChietKhauNVHoaDon = Remove_LastComma(nvHoaDon);
        objPrint.ChietKhauNVHoaDon_InGtriCK = Remove_LastComma(nvHoaDon_inCK);
        return objPrint;
    }
    function GetCTHDPrint_Format(arr) {
        var arrCTHD = [];
        for (let i = 0, li = arr.length; i < li; i++) {
            let itFor = $.extend({}, arr[i]);
            let dongia = formatNumberToInt(itFor.DonGia);
            let tienGiam = formatNumberToInt(itFor.TienChietKhau);
            let soluong = formatNumberToFloat(itFor.SoLuong);
            let bh_tt = soluong * formatNumberToFloat(itFor.DonGiaBaoHiem);
            itFor.DonGia = formatNumber3Digit(dongia);
            itFor.DonGiaBaoHiem = formatNumber3Digit(itFor.DonGiaBaoHiem);
            itFor.BH_ThanhTien = formatNumber3Digit(bh_tt);
            itFor.TienChietKhau = formatNumber3Digit(tienGiam);
            itFor.GiaBan = formatNumber3Digit(dongia - tienGiam);
            itFor.SoLuong = formatNumber3Digit(itFor.SoLuong, 4);
            itFor.ThanhTien = formatNumber3Digit(itFor.ThanhTien);
            itFor.SoLuongDVDaSuDung = 0;
            itFor.SoLuongDVConLai = 0;
            if (itFor.ChatLieu === '4') {
                for (let m = 0; m < vmNKGoiBaoDuong.listData.GoiDichVu.length; m++) {
                    let for1 = vmNKGoiBaoDuong.listData.GoiDichVu[m];
                    for (let j = 0; j < for1.lstDetail.length; j++) {
                        let for2 = for1.lstDetail[j];
                        for (let k = 0; k < for2.ComBo.length; k++) {
                            let for3 = for2.ComBo[k];
                            if (itFor.ID_ChiTietGoiDV === for3.ID_ChiTietGoiDV) {
                                itFor.SoLuongDVDaSuDung = for3.SoLuongDung + soluong;
                                itFor.SoLuongDVConLai = for3.TangKem ? for3.SoLuongTang - itFor.SoLuongDVDaSuDung : for3.SoLuongMua - itFor.SoLuongDVDaSuDung;
                                break;
                            }
                        }
                    }
                }
            }

            for (let k = 0; k < itFor.HangCungLoais.length; k++) {
                let cungloai = itFor.HangCungLoais[k];
                let dongia1 = formatNumberToInt(cungloai.DonGia);
                let tienGiam1 = formatNumberToInt(cungloai.TienChietKhau);
                let soluong1 = formatNumberToFloat(cungloai.SoLuong);
                let bh_tt1 = soluong1 * formatNumberToFloat(cungloai.DonGiaBaoHiem);
                itFor.HangCungLoais[k].SoLuong = formatNumber3Digit(soluong1);
                itFor.HangCungLoais[k].TienChietKhau = formatNumber3Digit(tienGiam1);
                itFor.HangCungLoais[k].TienThue = formatNumber3Digit(cungloai.TienThue);
                itFor.HangCungLoais[k].DonGia = formatNumber3Digit(dongia1);
                itFor.HangCungLoais[k].DonGiaBaoHiem = formatNumber3Digit(cungloai.DonGiaBaoHiem);
                itFor.HangCungLoais[k].BH_ThanhTien = formatNumber3Digit(bh_tt1);
                itFor.HangCungLoais[k].GiaBan = formatNumber3Digit(dongia1 - tienGiam1);
                itFor.HangCungLoais[k].ThanhTien = formatNumber3Digit(cungloai.ThanhTien);
                itFor.HangCungLoais[k].ThanhToan = formatNumber3Digit(cungloai.ThanhToan);
                itFor.HangCungLoais[k].SoLuongDVDaSuDung = 0;
                itFor.HangCungLoais[k].SoLuongDVConLai = 0;
            }

            // manv thuchien, tuvan
            let nvTH = '';
            let nvTV = '';
            let th_CoCK = '';
            let tv_CoCK = '';
            for (let k = 0; k < itFor.BH_NhanVienThucHien.length; k++) {
                let nvien = itFor.BH_NhanVienThucHien[k];
                switch (nvien.ThucHien_TuVan) {
                    case true:
                        nvTH += nvien.MaNhanVien + ', ';
                        th_CoCK += nvien.TenNhanVien.concat(nvien.PT_ChietKhau > 0 ? ' ('.concat(nvien.PT_ChietKhau, ' %)') : ' ('.concat(formatNumber3Digit(nvien.TienChietKhau), ')'), ', ');
                        break;
                    case false:
                        nvTV += nvien.MaNhanVien + ', ';
                        tv_CoCK += nvien.TenNhanVien.concat(nvien.PT_ChietKhau > 0 ? ' ('.concat(nvien.PT_ChietKhau, ' %)') : ' ('.concat(formatNumber3Digit(nvien.TienChietKhau), ')'), ', ');
                        break;
                }
            }
            itFor.NVThucHienDV_CoCK = Remove_LastComma(th_CoCK);
            itFor.NVTuVanDV_CoCK = Remove_LastComma(tv_CoCK);
            itFor.MaNVThucHien = Remove_LastComma(nvTH);
            itFor.MaNVTuVan = Remove_LastComma(nvTV);
            arrCTHD.push(itFor);
        }
        // order by STT ASC before print (in theo thứ tự Ngược so với thứ tự hiển thị trên hóa đơn ct (từ dưới lên))
        arrCTHD = arrCTHD.sort(function (a, b) {
            var x = a.SoThuTu, y = b.SoThuTu;
            return x > y ? 1 : x < y ? -1 : 0
        });
        return arrCTHD;
    }
    // get infor HD,CTHD offline
    self.goDetail = function (item) {
        $('#btnSave').removeAttr('disabled');
        $('#getoffline').modal('hide');
        $('#txtSearchHH').attr("disabled", "disabled");

        var idRandom = item.IDRandom;
        _maHoaDon = item.MaHoaDon;
        self.IDPhongBan_Chosing(item.ID_ViTri);// assign to do active PhongBan at SoDoPhong

        // disable search HangHoa
        // get chi tiet HoaDon with MHD ='HDO'
        var lstHD = localStorage.getItem(lcListHD);
        lstHD = JSON.parse(lstHD);
        var itemEx = GetHDOpening_byIDRandom(idRandom, lstHD);
        if (itemEx.length > 0) {
            BindHD_byIDRandom(idRandom);
            BindCTHD_byIDRandomHD(idRandom);
            GetInForCustomer_byID(itemEx[0].ID_DoiTuong);
            self.SetNhanVien(itemEx[0].ID_NhanVien);
            self.SetBangGia(itemEx[0].ID_BangGia);

            // chek if item is opening and exist
            var blExist = false;
            if (self.PhongBanSelected().length > 0) {
                $.map(self.PhongBanSelected(), function (item) {
                    if (item.IDRandom === _maHoaDon) {
                        blExist = true;
                        return;
                    }
                })
            }
            if (blExist) {
                GetCurrentPage_byMaHoaDon(_maHoaDon);
                $('.gara-bill-label li.active').removeClass('using');
                // add class 'using' li with maHoaDon
                $('.gara-bill-label li font').each(function () {
                    if ($(this).text() === _maHoaDon) {
                        $(this).parent().addClass('using');
                        return;
                    }
                });
            }
            else {
                // push
                self.PhongBanSelected.push(itemEx[0]);
                // update Status = 1 (HDoffline)
                for (let i = 0; i < lstHD.length; i++) {
                    if (lstHD[i].MaHoaDon === _maHoaDon) {
                        lstHD[i].Status = 1;
                        break;
                    }
                }
                localStorage.setItem(lcListHD, JSON.stringify(lstHD));
                localStorage.setItem(lcMaHD, _maHoaDon);
                GetCurrentPage_byMaHoaDon(_maHoaDon);
            }
        }
        $('input,select').attr('disabled', 'disabled');
        $('#ddlDMChungTus').removeAttr('disabled');
        Caculator_AmountProduct();
    }
    // if KH offline: 1. Don't saved --> save KhachHang in DB, after save HoaDon
    // else (2): get ID_DoiTuong saved, in assign HoaDon and save HoaDon
    function Check_KHOffline_AndSaveHoaDon(myData) {
        var idDTuongHD = myData.objHoaDon.ID_DoiTuong;
        var lstDoiTuong = localStorage.getItem(lcDM_DoiTuong);
        var itemDoiTuong = [];
        if (lstDoiTuong !== null) {
            var lstDoiTuong1 = JSON.parse(lstDoiTuong);
            itemDoiTuong = $.grep(lstDoiTuong1, function (item) {
                return item.ID === idDTuongHD;
            });
        }
        // if exist KH offline
        if (itemDoiTuong.length > 0) {
            // check ID_DoiTuong if KH offline (if KH offline saved)
            var afterDT = localStorage.getItem(lcDM_DoiTuong);
            if (afterDT !== null) {
                afterDT = JSON.parse(afterDT);
                let itemDToff = $.grep(afterDT, function (x) {
                    return x.MaDoiTuong === idDTuongHD;
                });
                if (itemDToff.length > 0) {
                    idDTuongHD = itemDToff[0].ID;
                }
            }
            if (idDTuongHD !== null && idDTuongHD.length >= 36) {
                myData.objHoaDon.ID_DoiTuong = idDTuongHD;
                PostHD_SoQuy_DongBo(myData);
            }
            else {
                // 1.add DoiTuong, HoaDon
                AddKhachHang_HoaDon(itemDoiTuong[0], myData, true, false);
            }
        }
        else {
            // check ID_DoiTuong if KH offline (if KH offline saved)
            var afterDT2 = localStorage.getItem(lcDM_DoiTuong);
            if (afterDT2 !== null) {
                afterDT2 = JSON.parse(afterDT2);
                let itemDToff = $.grep(afterDT2, function (x) {
                    return x.MaDoiTuong === idDTuongHD;
                });
                if (itemDToff.length > 0) {
                    idDTuongHD = itemDToff[0].ID;
                }
            }
            // assign again ID_DoiTuong 
            myData.objHoaDon.ID_DoiTuong = idDTuongHD;
            if (idDTuongHD === null || idDTuongHD.length >= 36) {
                PostHD_SoQuy_DongBo(myData);
            }
        }
    }
    function GetID_DoiTuong_THOffline(objHD) {
        var idDTuongHD = objHD.ID_DoiTuong;
        var lstDoiTuong = localStorage.getItem(lcDM_DoiTuong);
        if (lstDoiTuong !== null) {
            var lstDoiTuong1 = JSON.parse(lstDoiTuong);
            var itemDoiTuong = $.grep(lstDoiTuong1, function (item) {
                return item.ID === idDTuongHD;
            });
            if (itemDoiTuong.length > 0) {
                // check ID_DoiTuong if KH offline (if KH offline saved)
                var afterDT = localStorage.getItem(lcDM_DoiTuong);
                if (afterDT !== null) {
                    afterDT = JSON.parse(afterDT);
                    var itemDToff = $.grep(afterDT, function (x) {
                        return x.MaDoiTuong === idDTuongHD;
                    });
                    if (itemDToff.length > 0) {
                        idDTuongHD = itemDToff[0].ID;
                    }
                }
            }
        }
        return idDTuongHD;
    }
    self.DongBoHoa = function () {
        $('#btnDongBoHoa').attr('disabled', 'disabled');
        $('.divDongBoHoa').gridLoader();
        // getListHoadOn_offline
        var lst_HDoffline = localStorage.getItem(lcListHD);
        var cthd = localStorage.getItem(lcListCTHD);
        if (lst_HDoffline !== null) {
            lst_HDoffline = JSON.parse(lst_HDoffline);
            var lstHD_byUser = $.grep(lst_HDoffline, function (x) {
                return x.StatusOffline === true && x.NguoiTao === userLogin;
            })
            if (lstHD_byUser.length === 0) {
                ShowMessage_Danger('Không tồn tại hóa đơn offline');
                $('.divDongBoHoa').gridLoader({ show: false });
                $('#btnDongBoHoa').removeAttr('disabled');
                return;
            }
            // lst HD offline
            var lstHDO = $.grep(lstHD_byUser, function (item) {
                return item.LoaiHoaDon === 1;
            });
            // lst GDV offline
            var lstGDVO = $.grep(lstHD_byUser, function (item) {
                return item.LoaiHoaDon === 19;
            });
            var lstDHO = $.grep(lstHD_byUser, function (item) {
                return item.LoaiHoaDon === 3;
            });
            // lst HDTrahang offline
            var lstTHO = $.grep(lstHD_byUser, function (item) {
                return item.LoaiHoaDon === 6;
            });
            var productKMs = localStorage.getItem(lcProductKM_HoaDon);
            if (productKMs !== null) {
                productKMs = JSON.parse(productKMs);
            }
            else {
                productKMs = [];
            }
            let arrIDRandom = [];
            switch (self.selectLoaiChungTu()) {
                case 0: // tat ca
                    if (cthd !== null) {
                        cthd = JSON.parse(cthd);
                        // HDoffline
                        var maHoaDon = '';
                        for (let i = 0; i < lstHDO.length; i++) {
                            maHoaDon = lstHDO[i].MaHoaDon;
                            var arrHangHoa = [];
                            for (let j = 0; j < cthd.length; j++) {
                                if (cthd[j].MaHoaDon === maHoaDon) {
                                    // add Hang Khuyen Mai
                                    for (let k = 0; k < cthd[j].HangHoa_KM.length; k++) {
                                        arrHangHoa.push(cthd[j].HangHoa_KM[k]);
                                    }
                                    arrHangHoa.push(cthd[j]);
                                    // add Hang Hoa theo Lo
                                    for (let m = 1; m < cthd[j].DM_LoHang.length; m++) {
                                        arrHangHoa.push(cthd[j].DM_LoHang[m]);
                                    }
                                    // add HangCungLoai
                                    for (let m = 0; m < cthd[j].HangCungLoais.length; m++) {
                                        arrHangHoa.push(cthd[j].HangCungLoais[m]);
                                    }
                                }
                            }
                            // add product KhuyenMai of HoaDon into CTHD
                            for (let k = 0; k < productKMs.length; k++) {
                                if (productKMs[k].MaHoaDon === maHoaDon) {
                                    arrHangHoa.push(productKMs[k]);
                                }
                            }
                            // add GhiChu_KhuyenMai for objHD --> to do save DB
                            let ghichuKMHD = '';
                            for (let j = 0; j < arrHangHoa.length; j++) {
                                if (arrHangHoa[j].IsKhuyenMai) {
                                    ghichuKMHD += arrHangHoa[j].TenKhuyenMai + '<br /> ';
                                }
                            }
                            ghichuKMHD += lstHDO[i].KhuyenMai_GhiChu;
                            lstHDO[i].KhuyenMai_GhiChu = ghichuKMHD;
                            // check NgayLapHD is null, and get
                            let ngaylapHD = GetNgayLapHD_whenSave(lstHDO[i].NgayLapHoaDon);
                            lstHDO[i].NgayLapHoaDon = ngaylapHD;
                            // remove CTHD have QuanLyTheoLo, but ID_LoHang = null
                            arrHangHoa = GetArrCTHD_withIDLoHangOtherNull(arrHangHoa);
                            if (arrHangHoa.length > 0) {
                                let myData = {};
                                // ID_DonVi
                                if (lstHDO[i].ID_DonVi === '' || lstHDO[i].ID_DonVi === null || lstHDO[i].ID_DonVi === undefined) {
                                    lstHDO[i].ID_DonVi = id_DonVi;
                                }
                                myData.objHoaDon = lstHDO[i];
                                myData.objCTHoaDon = arrHangHoa;
                                myData.IsSetGiaVonTrungBinh = self.ThietLap().GiaVonTrungBinh;
                                Check_KHOffline_AndSaveHoaDon(myData);
                            }
                        }
                        // GDV offline
                        for (let i = 0; i < lstGDVO.length; i++) {
                            maHoaDon = lstGDVO[i].MaHoaDon;
                            var arrHangHoa_GDV = [];
                            for (let j = 0; j < cthd.length; j++) {
                                if (cthd[j].MaHoaDon === maHoaDon) {
                                    // add Hang Khuyen Mai
                                    for (let k = 0; k < cthd[j].HangHoa_KM.length; k++) {
                                        arrHangHoa_GDV.push(cthd[j].HangHoa_KM[k]);
                                    }
                                    if (cthd[j].SoLuong > 0) {
                                        arrHangHoa_GDV.push(cthd[j]);
                                    }
                                    // add Hang Hoa theo Lo
                                    for (let m = 1; m < cthd[j].DM_LoHang.length; m++) {
                                        if (cthd[j].DM_LoHang[m].SoLuong > 0) {
                                            arrHangHoa_GDV.push(cthd[j].DM_LoHang[m]);
                                        }
                                    }
                                    for (let m = 0; m < cthd[j].HangCungLoais.length; m++) {
                                        if (cthd[j].HangCungLoais[m].SoLuong > 0) {
                                            arrHangHoa_GDV.push(cthd[j].HangCungLoais[m]);
                                        }
                                    }
                                }
                            }
                            // add product KhuyenMai of HoaDon into CTHD
                            for (let k = 0; k < productKMs.length; k++) {
                                if (productKMs[k].MaHoaDon === maHoaDon) {
                                    arrHangHoa_GDV.push(productKMs[k]);
                                }
                            }
                            // add GhiChu_KhuyenMai for objHD --> to do save DB
                            let ghichuKMHD = '';
                            for (let j = 0; j < arrHangHoa_GDV.length; j++) {
                                if (arrHangHoa_GDV[j].IsKhuyenMai) {
                                    ghichuKMHD += arrHangHoa_GDV[j].TenKhuyenMai + '<br /> ';
                                }
                            }
                            ghichuKMHD += lstGDVO[i].KhuyenMai_GhiChu;
                            lstGDVO[i].KhuyenMai_GhiChu = ghichuKMHD;
                            // check NgayLapHD is null, and get
                            let ngaylapHD = GetNgayLapHD_whenSave(lstGDVO[i].NgayLapHoaDon);
                            lstGDVO[i].NgayLapHoaDon = ngaylapHD;
                            // remove CTHD have QuanLyTheoLo, but ID_LoHang = null
                            arrHangHoa_GDV = GetArrCTHD_withIDLoHangOtherNull(arrHangHoa_GDV);
                            if (arrHangHoa_GDV.length > 0) {
                                let myData = {};
                                // ID_DonVi
                                if (lstGDVO[i].ID_DonVi === '' || lstGDVO[i].ID_DonVi === null || lstGDVO[i].ID_DonVi === undefined) {
                                    lstGDVO[i].ID_DonVi = id_DonVi;
                                }
                                myData.objHoaDon = lstGDVO[i];
                                myData.objCTHoaDon = arrHangHoa_GDV;
                                myData.IsSetGiaVonTrungBinh = self.ThietLap().GiaVonTrungBinh;
                                // save KH offline + HD
                                Check_KHOffline_AndSaveHoaDon(myData);
                            }
                        }
                        // DatHangOffline
                        for (let i = 0; i < lstDHO.length; i++) {
                            maHoaDon = lstDHO[i].MaHoaDon;
                            var arrHangHoaDH = [];
                            for (let j = 0; j < cthd.length; j++) {
                                if (cthd[j].MaHoaDon === maHoaDon) {
                                    if (cthd[j].SoLuong > 0) {
                                        cthd[j].ID_ChiTietGoiDV = null;
                                        cthd[j].ChatLieu = '';
                                        arrHangHoaDH.push(cthd[j]);
                                    }
                                    // add Hang Hoa theo Lo
                                    for (let m = 1; m < cthd[j].DM_LoHang.length; m++) {
                                        if (cthd[j].DM_LoHang[m].SoLuong > 0) {
                                            cthd[j].DM_LoHang[m].ID_ChiTietGoiDV = null;
                                            cthd[j].DM_LoHang[m].ChatLieu = '';
                                            arrHangHoaDH.push(cthd[j].DM_LoHang[m]);
                                        }
                                    }
                                    for (let m = 0; m < cthd[j].HangCungLoais.length; m++) {
                                        if (cthd[j].HangCungLoais[m].SoLuong > 0) {
                                            cthd[j].HangCungLoais[m].ID_ChiTietGoiDV = null;
                                            cthd[j].HangCungLoais[m].ChatLieu = '';
                                            arrHangHoaDH.push(cthd[j].HangCungLoais[m]);
                                        }
                                    }
                                }
                            }
                            // remove CTHD have QuanLyTheoLo, but ID_LoHang = null
                            arrHangHoaDH = GetArrCTHD_withIDLoHangOtherNull(arrHangHoaDH);
                            if (arrHangHoaDH.length > 0) {
                                let myData = {};
                                // ID_DonVi
                                if (lstDHO[i].ID_DonVi === '' || lstDHO[i].ID_DonVi === null || lstDHO[i].ID_DonVi === undefined) {
                                    lstDHO[i].ID_DonVi = id_DonVi;
                                }
                                // check NgayLapHD is null, and get
                                let ngaylapHD = GetNgayLapHD_whenSave(lstDHO[i].NgayLapHoaDon);
                                lstDHO[i].NgayLapHoaDon = ngaylapHD;
                                myData.objHoaDon = lstDHO[i];
                                myData.objCTHoaDon = arrHangHoaDH;
                                myData.IsSetGiaVonTrungBinh = self.ThietLap().GiaVonTrungBinh;
                                Check_KHOffline_AndSaveHoaDon(myData);
                            }
                        }
                        // HDTraHang offline
                        if (lstTHO.length > 0) {
                            for (let i = 0; i < lstTHO.length; i++) {
                                let itFor = lstTHO[i];
                                maHoaDon = itFor.MaHoaDon;
                                var arrHangHoaTH = [];
                                for (let j = 0; j < cthd.length; j++) {
                                    if (cthd[j].MaHoaDon === maHoaDon) {
                                        if (cthd[j].SoLuong > 0) {
                                            arrHangHoaTH.push(cthd[j]);
                                        }
                                        // push DM_Lo
                                        for (let m = 1; m < cthd[j].DM_LoHang.length; m++) {
                                            if (cthd[j].DM_LoHang[m].SoLuong > 0) {
                                                arrHangHoaTH.push(cthd[j].DM_LoHang[m]);
                                            }
                                        }
                                        for (let m = 0; m < cthd[j].HangCungLoais.length; m++) {
                                            if (cthd[j].HangCungLoais[m].SoLuong > 0) {
                                                arrHangHoaTH.push(cthd[j].HangCungLoais[m]);
                                            }
                                        }
                                    }
                                }
                                // remove CTHD have QuanLyTheoLo, but ID_LoHang = null
                                arrHangHoaTH = GetArrCTHD_withIDLoHangOtherNull(arrHangHoaTH);
                                if (arrHangHoaTH.length > 0) {
                                    let myData = {};
                                    // ID_DonVi
                                    if (itFor.ID_DonVi === '' || itFor.ID_DonVi === null || itFor.ID_DonVi === undefined) {
                                        itFor.ID_DonVi = id_DonVi;
                                    }
                                    let ngaylapHD = GetNgayLapHD_whenSave(itFor.NgayLapHoaDon);
                                    let phaiTTTraHang = formatNumberToFloat(itFor.TongGiaGocHangTra) - formatNumberToFloat(itFor.TongGiamGiaDB) +
                                        formatNumberToFloat(itFor.TongThueDB);
                                    // if ThietLapTich Diem === true and ID_DoiTuong !== null --> update DiemGiaoDich for HD TraHang
                                    let diemGD = 0;
                                    if (itFor.FromHDTichDiem) {
                                        diemGD = GetDiemGiaoDich_HDTraHang(phaiTTTraHang);
                                    }
                                    // check KH offline
                                    let objTraHang = {
                                        LoaiHoaDon: 6,
                                        ID: const_GuidEmpty,
                                        ID_HoaDon: itFor.ID_HoaDon, // ID_HoaDon goc
                                        ID_DoiTuong: itFor.ID_DoiTuong,
                                        ID_BangGia: itFor.ID_BangGia,
                                        ID_NhanVien: itFor.ID_NhanVien,
                                        ID_DonVi: itFor.ID_DonVi,
                                        NgayLapHoaDon: ngaylapHD,
                                        TongTienHang: itFor.TongGiaGocHangTra, // 
                                        PhaiThanhToan: phaiTTTraHang,
                                        TongGiamGia: itFor.TongGiamGiaDB,
                                        TongChiPhi: itFor.TongChiPhiHangTra,
                                        DaThanhToan: itFor.DaTraKhach,
                                        PTThueHoaDon: 0,
                                        TongTienThue: 0,
                                        PTThueBaoHiem: 0,
                                        TongTienThueBaoHiem: 0,
                                        ChoThanhToan: false,
                                        DienGiai: itFor.DienGiai,
                                        DVTinhGiam: '%',
                                        PTGiam: 0,
                                        Status: 1, // open(1) - close(0) : use HDOffline
                                        MaHoaDon: maHoaDon,
                                        StatusOffline: false,
                                        TienMat: itFor.TienMat, // luu vao So chi
                                        TienGui: itFor.TienGui,
                                        TienThua: 0,
                                        DiemGiaoDich: diemGD,
                                        MaHoaDonTraHang: itFor.MaHoaDonTraHang, // used to get when save history 
                                        ID_TaiKhoanChuyenKhoan: itFor.ID_TaiKhoanChuyenKhoan,
                                        ID_TaiKhoanPos: itFor.ID_TaiKhoanPos,
                                        //IsTraGoiDV: itFor.IsTraGoiDV,
                                        BH_NhanVienThucHiens: [],
                                        ID_Xe: itFor.ID_Xe,
                                    };
                                    let phaiTTMuaMoi = formatNumberToFloat(itFor.TongTienHang) - formatNumberToFloat(itFor.TongGiamGia)
                                        + formatNumberToFloat(itFor.TongTienThue);
                                    let objMuaHang = {
                                        LoaiHoaDon: 1,
                                        ID: const_GuidEmpty,
                                        ID_DoiTuong: itFor.ID_DoiTuong,
                                        ID_BangGia: itFor.ID_BangGia,
                                        ID_NhanVien: itFor.ID_NhanVien,
                                        ID_DonVi: itFor.ID_DonVi,
                                        NgayLapHoaDon: ngaylapHD,
                                        TongTienHang: itFor.TongTienHang,
                                        PhaiThanhToan: phaiTTMuaMoi,
                                        TongGiamGia: itFor.TongGiamGia,
                                        DaThanhToan: itFor.DaThanhToan,
                                        PTThueHoaDon: itFor.PTThueHoaDon,
                                        TongTienThue: itFor.TongTienThue,
                                        PTThueBaoHiem: itFor.PTThueBaoHiem,
                                        TongTienThueBaoHiem: itFor.TongTienThueBaoHiem,
                                        ChoThanhToan: false,
                                        DienGiai: itFor.DienGiai,
                                        DVTinhGiam: '%',
                                        TongChietKhau: itFor.TongChietKhau,
                                        Status: 1,
                                        MaHoaDon: null,
                                        StatusOffline: false,
                                        TienMat: itFor.TienMat, // luu vao So thu
                                        TienGui: itFor.TienGui,
                                        TienThua: itFor.TienThua,
                                        DiemKhuyenMai: itFor.DiemKhuyenMai,
                                        DiemGiaoDich: itFor.DiemGiaoDich,
                                        DiemQuyDoi: itFor.DiemQuyDoi,
                                        TTBangDiem: itFor.TTBangDiem,
                                        DiemHienTai: itFor.DiemHienTai,
                                        BH_NhanVienThucHiens: itFor.BH_NhanVienThucHiens,
                                        ID_TaiKhoanChuyenKhoan: itFor.ID_TaiKhoanChuyenKhoan,
                                        ID_TaiKhoanPos: itFor.ID_TaiKhoanPos,
                                        ID_ViTri: itFor.ID_ViTri,
                                        CreateTime: itFor.CreateTime,
                                        ThoiGianThucHien: itFor.ThoiGianThucHien,
                                        ID_Xe: itFor.ID_Xe,
                                    };

                                    let loaiHD_DoiTra = 1;
                                    if (!commonStatisJs.CheckNull(itFor.NgayApDungGoiDV)) {
                                        loaiHD_DoiTra = 19;
                                        objMuaHang.NgayApDungGoiDV = moment(itFor.NgayApDungGoiDV, 'DD/MM/YYYY').format('YYYY-MM-DD');
                                        objMuaHang.HanSuDungGoiDV = moment(itFor.HanSuDungGoiDV, 'DD/MM/YYYY').format('YYYY-MM-DD');
                                    }
                                    objMuaHang.LoaiHoaDon = loaiHD_DoiTra;

                                    // check and assign TienTheGiTri for objHoaDon --> save Quy_HoaDon
                                    if (formatNumberToInt(itFor.PhaiTraKhach) > 0) {
                                        objTraHang.TienTheGiaTri = itFor.TienTheGiaTri;
                                    }
                                    else {
                                        objMuaHang.TienTheGiaTri = itFor.TienTheGiaTri;
                                    }
                                    myData.objHoaDon = objTraHang;
                                    myData.objCTHoaDon = arrHangHoaTH;
                                    myData.objTHO = itFor;
                                    myData.IsSetGiaVonTrungBinh = self.ThietLap().GiaVonTrungBinh;
                                    UpdateInforKH_toDB(objTraHang.ID_DoiTuong);
                                    console.log('myDataTH ', myData)

                                    ajaxHelper(BHHoaDonUri + 'PostBH_HoaDon_SoQuy_Spa_NKySuDung', 'POST', myData).done(function (x1) {
                                        if (x1.res) {
                                            var itemDB = x1.data;
                                            objTraHang.ID = itemDB.ID;
                                            objTraHang.MaHoaDon = itemDB.MaHoaDon;

                                            // insert quy if Tong Tra > Khach Mua Moi
                                            if (formatNumberToInt(myData.objTHO.DaTraKhach) > 0) {
                                                AssignValueHoaDon_ToPhieuThu(objTraHang);
                                                vmThanhToanGara.SavePhieuThu();
                                            }
                                            var cthd_MH = localStorage.getItem(lcListCTHD_DoiTra);
                                            var arrCTHD_MuaHang = [];
                                            var arrCTHD_MuaHang_LoHang = [];
                                            if (cthd_MH !== null) {
                                                cthd_MH = JSON.parse(cthd_MH);
                                                arrCTHD_MuaHang = $.grep(cthd_MH, function (item) {
                                                    return item.MaHoaDon === itemDB.MaHoaDon;
                                                });
                                                for (let n = 0; n < arrCTHD_MuaHang.length; n++) {
                                                    if (arrCTHD_MuaHang[n].SoLuong > 0) {
                                                        arrCTHD_MuaHang_LoHang.push(arrCTHD_MuaHang[n]);
                                                    }
                                                    for (let o = 1; o < arrCTHD_MuaHang[n].DM_LoHang.length; o++) {
                                                        arrCTHD_MuaHang_LoHang.push(arrCTHD_MuaHang[n].DM_LoHang[o]);
                                                    }
                                                    for (let m = 0; m < arrCTHD_MuaHang[n].HangCungLoais.length; m++) {
                                                        arrCTHD_MuaHang_LoHang.push(arrCTHD_MuaHang[n].HangCungLoais[m]);
                                                    }
                                                }
                                            }
                                            // remove CTHD have QuanLyTheoLo, but ID_LoHang = null
                                            arrCTHD_MuaHang_LoHang = GetArrCTHD_withIDLoHangOtherNull(arrCTHD_MuaHang_LoHang);
                                            if (arrCTHD_MuaHang.length > 0) {
                                                // save GioVao, GioRa
                                                if (objMuaHang.CreateTime !== 0) {
                                                    var objTime = GetGioVaoRa_ofHD(objMuaHang);
                                                    objMuaHang.GioVao = objTime.GioVao;
                                                    objMuaHang.GioRa = objTime.GioRa;
                                                }
                                                let myDataMH = {};
                                                objMuaHang.ID_HoaDon = itemDB.ID;
                                                myDataMH.objHoaDon = objMuaHang;
                                                myDataMH.objCTHoaDon = arrCTHD_MuaHang_LoHang;
                                                myDataMH.IsSetGiaVonTrungBinh = self.ThietLap().GiaVonTrungBinh;

                                                ajaxHelper(BHHoaDonUri + 'PostBH_HoaDon_SoQuy_Spa_NKySuDung', 'POST', myData).done(function (x2) {
                                                    if (x2.res) {
                                                        var itemMH = x2.data;
                                                        objMuaHang.ID = itemMH.ID;
                                                        objMuaHang.MaHoaDon = itemMH.MaHoaDon;

                                                        // insert quy if Khach Mua Moi > Tong Tra
                                                        if (formatNumberToInt(myData.objTHO.DaThanhToan) > 0) {
                                                            AssignValueHoaDon_ToPhieuThu(objMuaHang);
                                                            vmThanhToanGara.SavePhieuThu(objMuaHang.BH_NhanVienThucHiens);
                                                        }
                                                        cthd_MH = $.grep(cthd_MH, function (item) {
                                                            return item.MaHoaDon.indexOf('O') === -1;
                                                        });
                                                        localStorage.setItem(lcListCTHD_DoiTra, JSON.stringify(cthd));
                                                    }
                                                })
                                            }

                                            ShowMessage_Success('Thanh toán hóa đơn thành công');
                                        }
                                    })
                                }
                            }
                        }
                        // delete all HD with HDO
                        lst_HDoffline = $.grep(lst_HDoffline, function (x) {
                            return x.StatusOffline === false;
                        })
                        localStorage.setItem(lcListHD, JSON.stringify(lst_HDoffline));
                        // get idrandom after
                        for (let i = 0; i < lst_HDoffline.length; i++) {
                            arrIDRandom.push(lst_HDoffline[i].IDRandom);
                        }
                        // delete HDO in lstCTHoaDon
                        cthd = $.grep(cthd, function (x) {
                            return $.inArray(x.IDRandomHD, arrIDRandom) > -1;
                        })
                        localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
                        // gọi func sau khi xóa cache HD, CTHD: vì khi đồng bộ, async = true chạycác dòng lệnh theo thứ tự
                        Call_6Func();
                    }
                    // xoa all cache lstDoiTuong offline
                    localStorage.removeItem(lcDM_DoiTuong);
                    // remove all cache KM_of HD if HDO + DHO
                    productKMs = $.grep(productKMs, function (x) {
                        return x.MaHoaDon.indexOf('HDO') === -1 || (x.MaHoaDon.indexOf('HDO') > -1 && x.NguoiTao !== userLogin);
                    });
                    localStorage.setItem(lcProductKM_HoaDon, JSON.stringify(productKMs));
                    break;
                case 1: // hoa don
                    if (cthd !== null) {
                        let cthdCase1 = JSON.parse(cthd);
                        let maHoaDonHDO = '';
                        for (let k = 0; k < lstHDO.length; k++) {
                            maHoaDonHDO = lstHDO[k].MaHoaDon;
                            let arrHangHoaCase1 = [];
                            for (let j = 0; j < cthdCase1.length; j++) {
                                if (cthdCase1[j].MaHoaDon === maHoaDonHDO) {
                                    // push Hang KM
                                    for (let m = 0; m < cthdCase1[j].HangHoa_KM.length; m++) {
                                        arrHangHoaCase1.push(cthdCase1[j].HangHoa_KM[m]);
                                    }
                                    // push DM_Lo
                                    for (let n = 1; n < cthdCase1[j].DM_LoHang.length; n++) {
                                        //if (cthdCase1[j].DM_LoHang[n].SoLuong > 0) {
                                        arrHangHoaCase1.push(cthdCase1[j].DM_LoHang[n]);
                                        //}
                                    }
                                    for (let n = 0; n < cthdCase1[j].HangCungLoais.length; n++) {
                                        //if (cthdCase1[j].HangCungLoais[n].SoLuong > 0) {
                                        arrHangHoaCase1.push(cthdCase1[j].HangCungLoais[n]);
                                        //}
                                    }
                                    // push CT
                                    //if (cthdCase1[j].SoLuong > 0) {
                                    arrHangHoaCase1.push(cthdCase1[j]);
                                    //}
                                }
                            }
                            // add product KhuyenMai of HoaDon into CTHD
                            let productKMs = localStorage.getItem(lcProductKM_HoaDon);
                            if (productKMs !== null) {
                                productKMs = JSON.parse(productKMs);
                                for (let m = 0; m < productKMs.length; m++) {
                                    if (productKMs[m].MaHoaDon === maHoaDonHDO) {
                                        arrHangHoaCase1.push(productKMs[m]);
                                    }
                                }
                            }
                            // add GhiChu_KhuyenMai for objHD --> to do save DB
                            let ghichuKMHD = '';
                            for (let j = 0; j < arrHangHoaCase1.length; j++) {
                                if (arrHangHoaCase1[j].IsKhuyenMai) {
                                    ghichuKMHD += arrHangHoaCase1[j].TenKhuyenMai + '<br /> ';
                                }
                            }
                            ghichuKMHD += lstHDO[k].KhuyenMai_GhiChu;
                            lstHDO[k].KhuyenMai_GhiChu = ghichuKMHD;
                            // remove ID_LoHang = null
                            arrHangHoaCase1 = GetArrCTHD_withIDLoHangOtherNull(arrHangHoaCase1);
                            if (arrHangHoaCase1.length > 0) {
                                let myData = {};
                                // ID_DonVi
                                if (lstHDO[k].ID_DonVi === null || lstHDO[k].ID_DonVi === undefined) {
                                    lstHDO[k].ID_DonVi = id_DonVi;
                                }
                                let ngaylapHD = GetNgayLapHD_whenSave(lstHDO[k].NgayLapHoaDon);
                                lstHDO[k].NgayLapHoaDon = ngaylapHD;
                                myData.objHoaDon = lstHDO[k];
                                myData.objCTHoaDon = arrHangHoaCase1;
                                myData.IsSetGiaVonTrungBinh = self.ThietLap().GiaVonTrungBinh;

                                Check_KHOffline_AndSaveHoaDon(myData);
                            }
                        }
                        // delete all HD MuaHang offline
                        lst_HDoffline = $.grep(lst_HDoffline, function (item) {
                            return item.StatusOffline === false
                                || (item.StatusOffline === true && item.LoaiHoaDon !== 1)
                                || (item.StatusOffline === true && item.NguoiTao !== userLogin);
                        });
                        localStorage.setItem(lcListHD, JSON.stringify(lst_HDoffline));
                        // get idrandom after
                        for (let i = 0; i < lst_HDoffline.length; i++) {
                            arrIDRandom.push(lst_HDoffline[i].IDRandom);
                        }
                        // delete HDO in lstCTHoaDon
                        cthd = $.grep(cthd, function (x) {
                            return $.inArray(x.IDRandomHD, arrIDRandom) > -1;
                        });
                        localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
                    }
                    productKMs = $.grep(productKMs, function (x) {
                        return x.MaHoaDon.indexOf('HDO') === -1;
                    });
                    localStorage.setItem(lcProductKM_HoaDon, JSON.stringify(productKMs));
                    RemoveKHoffline_afterSave();
                    // gọi func sau khi xóa cache HD, CTHD: vì khi đồng bộ, async = true chạycác dòng lệnh theo thứ tự
                    Call_6Func();
                    break;
                case 3: // dathang
                    if (cthd !== null) {
                        let cthdCase1 = JSON.parse(cthd);
                        let maHoaDonHDO = '';
                        for (let k = 0; k < lstDHO.length; k++) {
                            maHoaDonHDO = lstDHO[k].MaHoaDon;
                            let arrHangHoaCase1 = [];
                            for (let j = 0; j < cthdCase1.length; j++) {
                                if (cthdCase1[j].MaHoaDon === maHoaDonHDO) {
                                    if (cthdCase1[j].SoLuong > 0) {
                                        cthdCase1[j].ID_ChiTietGoiDV = null;
                                        cthdCase1[j].ChatLieu = '';
                                        arrHangHoaCase1.push(cthdCase1[j]);
                                    }
                                    for (let n = 1; n < cthdCase1[j].DM_LoHang.length; n++) {
                                        if (cthdCase1[j].DM_LoHang[n].SoLuong > 0) {
                                            cthdCase1[j].DM_LoHang[n].ID_ChiTietGoiDV = null;
                                            cthdCase1[j].DM_LoHang[n].ChatLieu = '';
                                            arrHangHoaCase1.push(cthdCase1[j].DM_LoHang[n]);
                                        }
                                    }
                                    for (let n = 0; n < cthdCase1[j].HangCungLoais.length; n++) {
                                        if (cthdCase1[j].HangCungLoais[n].SoLuong > 0) {
                                            cthdCase1[j].HangCungLoais[n].ID_ChiTietGoiDV = null;
                                            cthdCase1[j].HangCungLoais[n].ChatLieu = '';
                                            arrHangHoaCase1.push(cthdCase1[j].HangCungLoais[n]);
                                        }
                                    }
                                }
                            }
                            // remove CTHD have QuanLyTheoLo, but ID_LoHang = null
                            arrHangHoaCase1 = GetArrCTHD_withIDLoHangOtherNull(arrHangHoaCase1);
                            if (arrHangHoaCase1.length > 0) {
                                let myData = {};
                                // ID_DonVi
                                if (lstDHO[k].ID_DonVi === '' || lstDHO[k].ID_DonVi === null || lstDHO[k].ID_DonVi === undefined) {
                                    lstDHO[k].ID_DonVi = id_DonVi;
                                }
                                // check NgayLapHD is null, and get
                                let ngaylapHD = GetNgayLapHD_whenSave(lstDHO[k].NgayLapHoaDon);
                                lstDHO[k].NgayLapHoaDon = ngaylapHD;
                                myData.objHoaDon = lstDHO[k];
                                myData.objCTHoaDon = arrHangHoaCase1;
                                myData.IsSetGiaVonTrungBinh = self.ThietLap().GiaVonTrungBinh;
                                Check_KHOffline_AndSaveHoaDon(myData);
                            }
                        }
                        // delete all HD DatHang offline
                        lst_HDoffline = $.grep(lst_HDoffline, function (item) {
                            return item.StatusOffline === false
                                || (item.StatusOffline === true && item.LoaiHoaDon !== 3)
                                || (item.StatusOffline === true && item.NguoiTao !== userLogin);
                        });
                        localStorage.setItem(lcListHD, JSON.stringify(lst_HDoffline));
                        // get idrandom after
                        for (let i = 0; i < lst_HDoffline.length; i++) {
                            arrIDRandom.push(lst_HDoffline[i].IDRandom);
                        }
                        // delete HDO in lstCTHoaDon
                        cthd = $.grep(cthd, function (x) {
                            return $.inArray(x.IDRandomHD, arrIDRandom) > -1;
                        });
                        localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
                    }
                    // remove KH offline in cache
                    RemoveKHoffline_afterSave();
                    // gọi func sau khi xóa cache HD, CTHD: vì khi đồng bộ, async = true chạycác dòng lệnh theo thứ tự
                    Call_6Func();
                    break;
                case 6: // tra hang
                    if (cthd !== null) {
                        cthd = JSON.parse(cthd);
                        if (lstTHO.length > 0) {
                            var maHDTHO = '';
                            for (let i = 0; i < lstTHO.length; i++) {
                                maHDTHO = lstTHO[i].MaHoaDon;

                                var arrHangHoaTHCase6 = [];
                                for (let j = 0; j < cthd.length; j++) {
                                    if (cthd[j].MaHoaDon === maHDTHO) {
                                        if (cthd[j].SoLuong > 0) {
                                            arrHangHoaTHCase6.push(cthd[j]);
                                        }
                                        for (let n = 1; n < cthd[j].DM_LoHang.length; n++) {
                                            if (cthd[j].DM_LoHang[n].SoLuong > 0) {
                                                arrHangHoaTHCase6.push(cthd[j].DM_LoHang[n]);
                                            }
                                        }
                                        for (let n = 0; n < cthd[j].HangCungLoais.length; n++) {
                                            if (cthd[j].HangCungLoais[n].SoLuong > 0) {
                                                arrHangHoaTHCase6.push(cthd[j].HangCungLoais[n]);
                                            }
                                        }
                                    }
                                }
                                // remove CTHD have QuanLyTheoLo, but ID_LoHang = null
                                arrHangHoaTHCase6 = GetArrCTHD_withIDLoHangOtherNull(arrHangHoaTHCase6);
                                if (arrHangHoaTHCase6 !== '') {
                                    let myData = {};
                                    // ID_DonVi
                                    if (lstTHO[i].ID_DonVi === '' || lstTHO[i].ID_DonVi === null || lstTHO[i].ID_DonVi === undefined) {
                                        lstTHO[i].ID_DonVi = id_DonVi;
                                    }
                                    let ngaylapHD = GetNgayLapHD_whenSave(lstTHO[i].NgayLapHoaDon);
                                    let phaiTTTraHang = formatNumberToFloat(lstTHO[i].TongGiaGocHangTra) - formatNumberToFloat(lstTHO[i].TongGiamGiaDB)
                                        + formatNumberToFloat(lstTHO[i].TongThueDB);

                                    let diemGD = 0;
                                    if (lstTHO[i].FromHDTichDiem) {
                                        diemGD = GetDiemGiaoDich_HDTraHang(lstTHO[i].TongGiaGocHangTra - lstTHO[i].TongGiamGiaDB);
                                    }

                                    let objTraHang = {
                                        LoaiHoaDon: 6,
                                        ID: const_GuidEmpty,
                                        ID_HoaDon: lstTHO[i].ID_HoaDon, // ID_HoaDon goc
                                        ID_DoiTuong: lstTHO[i].ID_DoiTuong,
                                        ID_BangGia: lstTHO[i].ID_BangGia,
                                        ID_NhanVien: lstTHO[i].ID_NhanVien,
                                        ID_DonVi: lstTHO[i].ID_DonVi,
                                        NgayLapHoaDon: ngaylapHD,
                                        TongTienHang: lstTHO[i].TongGiaGocHangTra, // 
                                        PhaiThanhToan: phaiTTTraHang,
                                        TongGiamGia: lstTHO[i].TongGiamGiaDB,
                                        TongChiPhi: lstTHO[i].TongChiPhiHangTra,
                                        DaThanhToan: lstTHO[i].DaTraKhach,
                                        PTThueHoaDon: 0,
                                        TongTienThue: 0,
                                        PTThueBaoHiem: 0,
                                        TongTienThueBaoHiem: 0,
                                        ChoThanhToan: false,
                                        DienGiai: lstTHO[i].DienGiai,
                                        DVTinhGiam: '%',
                                        PTGiam: 0,
                                        Status: 1, // open(1) - close(0) : use HDOffline
                                        MaHoaDon: maHDTHO,
                                        StatusOffline: false,
                                        TienMat: lstTHO[i].TienMat, // luu vao So chi
                                        TienGui: lstTHO[i].TienGui,
                                        TienThua: 0,
                                        DiemGiaoDich: diemGD,
                                        MaHoaDonTraHang: lstTHO[i].MaHoaDonTraHang, // used to get when save history 
                                        ID_TaiKhoanChuyenKhoan: lstTHO[i].ID_TaiKhoanChuyenKhoan,
                                        ID_TaiKhoanPos: lstTHO[i].ID_TaiKhoanPos,
                                        ID_Xe: lstTHO[i].ID_Xe,
                                    };
                                    let objMuaHang = {};
                                    // check and assign TienTheGiTri for objHoaDon --> save Quy_HoaDon
                                    if (formatNumberToInt(lstTHO[i].PhaiTraKhach) > 0) {
                                        objTraHang.TienTheGiaTri = lstTHO[i].TienTheGiaTri;
                                    }
                                    else {
                                        objMuaHang.TienTheGiaTri = lstTHO[i].TienTheGiaTri;
                                    }
                                    myData.objHoaDon = objTraHang;
                                    myData.objCTHoaDon = arrHangHoaTHCase6;
                                    myData.objTHO = lstTHO[i];   // assign to update Diem
                                    myData.IsSetGiaVonTrungBinh = self.ThietLap().GiaVonTrungBinh;
                                    UpdateInforKH_toDB(objTraHang.ID_DoiTuong);
                                    console.log('myData ', myData)
                                    ajaxHelper(BHHoaDonUri + "PostBH_HoaDon_SoQuy_Spa_NKySuDung", 'POST', myData).done(function (x1) {
                                        if (x1.res) {
                                            var itemDB = x1.data;
                                            objTraHang.ID = itemDB.ID;
                                            objTraHang.MaHoaDon = itemDB.MaHoaDon;

                                            // insert quy if Tong Tra > Khach Mua Moi
                                            if (formatNumberToInt(myData.objTHO.DaTraKhach) > 0) {
                                                AssignValueHoaDon_ToPhieuThu(objTraHang);
                                                vmThanhToanGara.SavePhieuThu();
                                            }

                                            var objTH = myData.objTHO;
                                            if (objTH.TongTienHang > 0) {
                                                var phaiTTMuaMoi = formatNumberToFloat(objTH.TongTienHang) - formatNumberToFloat(objTH.TongGiamGia) + formatNumberToFloat(objTH.TongTienThue);
                                                objMuaHang = {
                                                    LoaiHoaDon: 1,
                                                    ID: const_GuidEmpty,
                                                    ID_DoiTuong: objTH.ID_DoiTuong,
                                                    ID_BangGia: objTH.ID_BangGia,
                                                    ID_NhanVien: objTH.ID_NhanVien,
                                                    ID_DonVi: objTH.ID_DonVi,
                                                    NgayLapHoaDon: ngaylapHD,
                                                    TongTienHang: objTH.TongTienHang,
                                                    PhaiThanhToan: phaiTTMuaMoi,
                                                    TongGiamGia: objTH.TongGiamGia,
                                                    DaThanhToan: objTH.DaThanhToan,
                                                    PTThueHoaDon: objTH.PTThueHoaDon,
                                                    TongTienThue: objTH.TongTienThue,
                                                    PTThueBaoHiem: objTH.PTThueBaoHiem,
                                                    TongTienThueBaoHiem: objTH.TongTienThueBaoHiem,
                                                    ChoThanhToan: false,
                                                    DienGiai: objTH.DienGiai,
                                                    DVTinhGiam: '%',
                                                    TongChietKhau: objTH.TongChietKhau, // PTGiam
                                                    Status: 1, // open(1) - close(0) : use HDOffline
                                                    MaHoaDon: null,
                                                    StatusOffline: false,
                                                    TienMat: objTH.TienMat, // luu vao So thu
                                                    TienGui: objTH.TienGui,
                                                    TienThua: objTH.TienThua,
                                                    DiemKhuyenMai: objTH.DiemKhuyenMai,
                                                    DiemGiaoDich: objTH.DiemGiaoDich, // mua hang thi moi co diem giao dich
                                                    TTBangDiem: objTH.TTBangDiem,
                                                    DiemHienTai: objTH.DiemHienTai,
                                                    DiemQuyDoi: objTH.DiemQuyDoi,
                                                    BH_NhanVienThucHiens: objTH.BH_NhanVienThucHiens,
                                                    ID_TaiKhoanChuyenKhoan: objTH.ID_TaiKhoanChuyenKhoan,
                                                    ID_TaiKhoanPos: objTH.ID_TaiKhoanPos,
                                                    ID_ViTri: objTH.ID_ViTri,
                                                    CreateTime: objTH.CreateTime,
                                                    ThoiGianThucHien: objTH.ThoiGianThucHien,
                                                    ID_Xe: objTH.ID_Xe,
                                                };

                                                let loaiHD_DoiTra = 1;
                                                if (!commonStatisJs.CheckNull(lstTHO[i].NgayApDungGoiDV)) {
                                                    loaiHD_DoiTra = 19;
                                                    objMuaHang.NgayApDungGoiDV = moment(lstTHO[i].NgayApDungGoiDV, 'DD/MM/YYYY').format('YYYY-MM-DD');
                                                    objMuaHang.HanSuDungGoiDV = moment(lstTHO[i].HanSuDungGoiDV, 'DD/MM/YYYY').format('YYYY-MM-DD');
                                                }
                                                objMuaHang.LoaiHoaDon = loaiHD_DoiTra;

                                                let cthd_MH = localStorage.getItem(lcListCTHD_DoiTra);
                                                let arrCTHD_MuaHang = [];
                                                let arrCTHD_MuaHang_LoHang = [];
                                                if (cthd_MH !== null) {
                                                    cthd_MH = JSON.parse(cthd_MH);
                                                    arrCTHD_MuaHang = $.grep(cthd_MH, function (item) {
                                                        return item.MaHoaDon === itemDB.MaHoaDon;
                                                    });
                                                    for (let m = 0; m < arrCTHD_MuaHang.length; m++) {
                                                        for (let n = 1; n < arrCTHD_MuaHang[m].DM_LoHang.length; n++) {
                                                            if (arrCTHD_MuaHang[m].DM_LoHang[n].SoLuong > 0) {
                                                                arrCTHD_MuaHang_LoHang.push(arrCTHD_MuaHang[m].DM_LoHang[n]);
                                                            }
                                                        }
                                                        for (let n = 0; n < arrCTHD_MuaHang[m].HangCungLoais.length; n++) {
                                                            if (arrCTHD_MuaHang[m].HangCungLoais[n].SoLuong > 0) {
                                                                arrCTHD_MuaHang_LoHang.push(arrCTHD_MuaHang[m].HangCungLoais[n]);
                                                            }
                                                        }
                                                        if (arrCTHD_MuaHang[m].SoLuong > 0) {
                                                            arrCTHD_MuaHang_LoHang.push(arrCTHD_MuaHang[m]);
                                                        }
                                                    }
                                                }
                                                // remove CTHD have QuanLyTheoLo, but ID_LoHang = null
                                                arrCTHD_MuaHang = GetArrCTHD_withIDLoHangOtherNull(arrCTHD_MuaHang);
                                                // save GioVao, GioRa
                                                if (objMuaHang.CreateTime !== 0) {
                                                    let objTime = GetGioVaoRa_ofHD(objMuaHang);
                                                    objMuaHang.GioVao = objTime.GioVao;
                                                    objMuaHang.GioRa = objTime.GioRa;
                                                }
                                                let myDataMH = {};
                                                objMuaHang.ID_HoaDon = itemDB.ID;
                                                myDataMH.objHoaDon = objMuaHang;
                                                myDataMH.objCTHoaDon = arrCTHD_MuaHang;
                                                myDataMH.IsSetGiaVonTrungBinh = self.ThietLap().GiaVonTrungBinh;
                                                console.log('myDataMH ', myDataMH);

                                                // Post HD Mua
                                                ajaxHelper(BHHoaDonUri + "PostBH_HoaDon_SoQuy_Spa_NKySuDung", 'POST', myDataMH).done(function (x2) {
                                                    if (x2.res) {
                                                        var itemMH = x2.data;
                                                        objMuaHang.ID = itemMH.ID;
                                                        objMuaHang.MaHoaDon = itemMH.MaHoaDon;

                                                        // insert quy if Khach Mua Moi > Tong Tra
                                                        if (formatNumberToInt(myData.objTHO.DaThanhToan) > 0) {
                                                            AssignValueHoaDon_ToPhieuThu(objMuaHang);
                                                            vmThanhToanGara.SavePhieuThu(objMuaHang.BH_NhanVienThucHiens);
                                                        }
                                                        cthd_MH = $.grep(cthd_MH, function (item) {
                                                            return item.MaHoaDon.indexOf('O') === -1;
                                                        });
                                                        localStorage.setItem(lcListCTHD_DoiTra, JSON.stringify(cthd));
                                                    }
                                                })
                                            }
                                            ShowMessage_Success('Thanh toán hóa đơn thành công');
                                        }
                                    }).always(function () {
                                        $('#btnDongBoHoa,#btnSave').removeAttr('disabled');
                                        $('#getoffline').modal('hide');
                                    })
                                }
                            }
                            //delete cache THO
                            lst_HDoffline = $.grep(lst_HDoffline, function (x) {
                                return x.StatusOffline === false
                                    || (x.StatusOffline === true && x.LoaiHoaDon !== 6)
                                    || (x.StatusOffline === true && x.NguoiTao !== userLogin);
                            });
                            localStorage.setItem(lcListHD, JSON.stringify(lst_HDoffline));
                            // get idrandom after
                            for (let i = 0; i < lst_HDoffline.length; i++) {
                                arrIDRandom.push(lst_HDoffline[i].IDRandom);
                            }
                            // delete HDO in lstCTHoaDon
                            cthd = $.grep(cthd, function (x) {
                                return $.inArray(x.IDRandomHD, arrIDRandom) > -1;
                            });
                            localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
                        }
                    }
                    Call_6Func();
                    break;
                case 19: // goi dich vu
                    if (cthd !== null) {
                        var cthdCase1 = JSON.parse(cthd);
                        var maHoaDonGDV = '';
                        for (let k = 0; k < lstGDVO.length; k++) {
                            maHoaDonGDV = lstGDVO[k].MaHoaDon;
                            let arrHangHoaCase1 = [];
                            for (let j = 0; j < cthdCase1.length; j++) {
                                if (cthdCase1[j].MaHoaDon === maHoaDonGDV) {
                                    // push Hang KM
                                    for (let m = 0; m < cthdCase1[j].HangHoa_KM.length; m++) {
                                        arrHangHoaCase1.push(cthdCase1[j].HangHoa_KM[m]);
                                    }
                                    // push DM_Lo
                                    for (let n = 1; n < cthdCase1[j].DM_LoHang.length; n++) {
                                        arrHangHoaCase1.push(cthdCase1[j].DM_LoHang[n]);
                                    }
                                    for (let n = 0; n < cthdCase1[j].HangCungLoais.length; n++) {
                                        arrHangHoaCase1.push(cthdCase1[j].HangCungLoais[n]);
                                    }
                                    // push CT
                                    arrHangHoaCase1.push(cthdCase1[j]);
                                }
                            }
                            // add product KhuyenMai of HoaDon into CTHD
                            for (let m = 0; m < productKMs.length; m++) {
                                if (productKMs[m].MaHoaDon === maHoaDonHDO) {
                                    arrHangHoaCase1.push(productKMs[m]);
                                }
                            }
                            // add GhiChu_KhuyenMai for objHD --> to do save DB
                            let ghichuKMHD = '';
                            for (let j = 0; j < arrHangHoaCase1.length; j++) {
                                if (arrHangHoaCase1[j].IsKhuyenMai) {
                                    ghichuKMHD += arrHangHoaCase1[j].TenKhuyenMai + '<br /> ';
                                }
                            }
                            ghichuKMHD += lstGDVO[k].KhuyenMai_GhiChu;
                            lstGDVO[k].KhuyenMai_GhiChu = ghichuKMHD;
                            // remove ID_LoHang = null
                            arrHangHoaCase1 = GetArrCTHD_withIDLoHangOtherNull(arrHangHoaCase1);
                            if (arrHangHoaCase1.length > 0) {
                                let myData = {};
                                // ID_DonVi
                                if (lstGDVO[k].ID_DonVi === null || lstGDVO[k].ID_DonVi === undefined) {
                                    lstGDVO[k].ID_DonVi = id_DonVi;
                                }
                                let ngaylapHD = GetNgayLapHD_whenSave(lstGDVO[k].NgayLapHoaDon);
                                lstGDVO[k].NgayLapHoaDon = ngaylapHD;
                                myData.objHoaDon = lstGDVO[k];
                                myData.objCTHoaDon = arrHangHoaCase1;
                                myData.IsSetGiaVonTrungBinh = self.ThietLap().GiaVonTrungBinh;

                                Check_KHOffline_AndSaveHoaDon(myData);
                            }
                        }
                        // delete all HD MuaHang offline
                        lst_HDoffline = $.grep(lst_HDoffline, function (item) {
                            return item.StatusOffline === false
                                || (item.StatusOffline === true && item.LoaiHoaDon !== 19)
                                || (item.StatusOffline === true && item.NguoiTao !== userLogin);
                        });
                        localStorage.setItem(lcListHD, JSON.stringify(lst_HDoffline));
                        // get idrandom after
                        for (let i = 0; i < lst_HDoffline.length; i++) {
                            arrIDRandom.push(lst_HDoffline[i].IDRandom);
                        }
                        // delete HDO in lstCTHoaDon
                        cthd = $.grep(cthd, function (x) {
                            return $.inArray(x.IDRandomHD, arrIDRandom) > -1;
                        });
                        localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
                    }
                    productKMs = $.grep(productKMs, function (x) {
                        return x.MaHoaDon.indexOf('GDVO') === -1;
                    });
                    localStorage.setItem(lcProductKM_HoaDon, JSON.stringify(productKMs));
                    RemoveKHoffline_afterSave();
                    Call_6Func();
                    break;
            }
            // count again HDO
            var lstHDaftersave = localStorage.getItem(lcListHD);
            if (lstHDaftersave !== null) {
                lstHDaftersave = JSON.parse(lstHDaftersave);
                var listHDO_aftersave = $.grep(lstHDaftersave, function (x) {
                    return x.StatusOffline === true && x.NguoiTao === userLogin && x.ID_DonVi === id_DonVi;
                });
                self.countHDoffilne(listHDO_aftersave.length);
                self.HoaDonOffline(listHDO_aftersave);
            }
            BindHD_CTHDafterSave();
            //ActiveTab_SoDoPhong(false);
        }
        else {
            $('#btnDongBoHoa').removeAttr('disabled');
            ShowMessage_Danger('Không tồn tại hóa đơn offline');
        }
        $('.divDongBoHoa').gridLoader({ show: false });
    }
    function RemoveKHoffline_afterSave() {
        // get lstHD after save
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            var arrID_DoiTuong = [];
            for (let i = 0; i < lstHD.length; i++) {
                // get all ID_DoiTuong in lstHD
                arrID_DoiTuong.push(lstHD[i].ID_DoiTuong);
            }
            // delete in KH offline
            var khOffline = localStorage.getItem(lcDM_DoiTuong);
            if (khOffline !== null) {
                khOffline = JSON.parse(khOffline);
                for (let i = 0; i < khOffline.length; i++) {
                    // delete KH offline if (ID && MaDoiTuong) not exist in arrID_DoiTuong (OK)
                    if (($.inArray(khOffline[i].MaDoiTuong, arrID_DoiTuong) === -1) && ($.inArray(khOffline[i].ID, arrID_DoiTuong) === -1)) {
                        khOffline.splice(i, 1);
                    }
                }
                localStorage.setItem(lcDM_DoiTuong, JSON.stringify(khOffline));
            }
        }
        else {
            localStorage.removeItem(lcDM_DoiTuong);
        }
    }
    function ClearTextSearch() {
        $('#txtSearchHH').val('');
        $('#txtSoLuong').val('');// soluong,dongia at NhapNhanh_Thuong
        $('#txtDonGia').val('');
        $('#txtSearchDoiTra').val('');
        ResetInput_KhachHang();
    }

    self.addPhongBan = function () {
        $('#txtSearchHH').focus();
        self.HH_KhuyenMai(undefined);
        self.HD_KhuyenMai(undefined);
        ClearTextSearch();
        stopTimer();
        timer();
        HideShow_HeaderCTHD();

        var obj = GetMaHoaDonNew_byRole();
        var loaiHD = obj.LoaiHoaDon;
        var max = 1;
        var arrHD_byUser = [];
        var lstHDLe = localStorage.getItem(lcListHD);
        if (lstHDLe !== null) {
            lstHDLe = JSON.parse(lstHDLe);
            arrHD_byUser = $.grep(lstHDLe, function (x) {
                return x.StatusOffline === false && x.NguoiTao === userLogin && x.TrangThaiHD === 1;
            });
        }
        else {
            lstHDLe = [];
        }

        var arrLoai = [loaiHD];
        if (loaiHD === 1 || loaiHD === 25) {
            arrLoai = [1, 25];
        }
        var arrHD = $.grep(arrHD_byUser, function (x) {
            return $.inArray(x.LoaiHoaDon, arrLoai) > -1;
        });

        if (arrHD.length > 0) {
            max = Math.max.apply(Math, arrHD.map(function (item) {
                return item.MaHoaDon.match(/\d+/);
            }));
        }
        else {
            // khong add HoaDon 1, vi neu add sẽ bị add cùng lúc Hóa đơn 1, Hóa đơn 2
            if (lstHDLe.length > 0) {
                max = 0;
            }
            else {
                lstHDLe = [];
                let newObjFirst = newHoaDon(loaiHD, '1');
                lstHDLe.push(newObjFirst);
            }
        }
        var objNew = newHoaDon(loaiHD, max + 1);
        lstHDLe.push(objNew);
        localStorage.setItem(lcListHD, JSON.stringify(lstHDLe));
        _maHoaDon = objNew.MaHoaDon;
        localStorage.setItem(lcMaHD, _maHoaDon);
        GetCurrentPage_byMaHoaDon(_maHoaDon);
        self.resetInforHD_CTHD(_maHoaDon);
        ResetInfor_KhachHang();
        Call_6Func();
        self.HoaDons().IDRandom(objNew.IDRandom);// must assign IDRanDom --> check nhieu cho theo id nay
    }

    self.IsClickCloseHD = ko.observable(false);

    $('#modalPopuplgDelete').on('hidden.bs.modal', function () {
        // tranh truong hop goi ham update giaban khi GetThongTinHoaDon 
        // vi func CloseHoaDon nam trong the li cua func GetThongTinHoaDon
        self.IsClickCloseHD(false);
    })

    self.CloseHoaDon = function (item) {
        self.IsClickCloseHD(true);

        ClearTextSearch();
        var thisMaHD = this.MaHoaDon;
        var hdOpen = [];
        var idRandom = '';
        var idHoaDon = const_GuidEmpty;
        var lstHoaDon = localStorage.getItem(lcListHD);
        if (lstHoaDon !== null) {
            lstHoaDon = JSON.parse(lstHoaDon);
            hdOpen = GetHDOpening_byMaHoaDon(thisMaHD, lstHoaDon);
            if (hdOpen.length > 0) {
                // get IDRandom at this func because, when add HangHoa, not bind again PhongBanSelected, so IDRandom #
                idRandom = hdOpen[0].IDRandom;
                trangthaiHD = hdOpen[0].TrangThaiHD;
                idHoaDon = hdOpen[0].ID;
            }
        }
        else {
            lstHoaDon = [];
        }
        var lstCTHoaDon = localStorage.getItem(lcListCTHD);
        var itemEx = [];
        // find in CTHD Ban
        if (lstCTHoaDon !== null) {
            lstCTHoaDon = JSON.parse(lstCTHoaDon);
            itemEx = $.grep(lstCTHoaDon, function (x) {
                return x.IDRandomHD === idRandom;
            });
        }
        // find in CTHD Doi tra
        if (itemEx.length === 0) {
            var lstCTHoaDon_DoiTra = localStorage.getItem(lcListCTHD_DoiTra);
            if (lstCTHoaDon_DoiTra !== null) {
                lstCTHoaDon_DoiTra = JSON.parse(lstCTHoaDon_DoiTra);
                itemEx = $.grep(lstCTHoaDon_DoiTra, function (x) {
                    return x.IDRandomHD === idRandom;
                });
            }
        }

        if (itemEx.length > 0) {
            let tilte = 'Xác nhận xóa';
            let mes = 'Hệ thống sẽ không lưu thông tin chi tiết của <b>'.concat(thisMaHD, ' </b> trên màn hình bán hàng. Bạn có chắc chắn muốn xóa không?')
            if (idHoaDon !== const_GuidEmpty) {
                tilte = 'Đóng hóa đơn';
                mes = 'Bạn có chắc chắn muốn đóng hóa đơn <b> '.concat(thisMaHD, '</b> không?');
            }
            dialogConfirm(tilte, mes, function () {
                self.IsClickCloseHD(false);

                lstHoaDon = RemoveHD_byMaHoaDon(thisMaHD, lstHoaDon);
                localStorage.setItem(lcListHD, JSON.stringify(lstHoaDon));
                var lstCTHoaDon2 = jQuery.grep(lstCTHoaDon, function (x) {
                    return x.IDRandomHD !== idRandom;
                });
                localStorage.setItem(lcListCTHD, JSON.stringify(lstCTHoaDon2));
                // remove CTHoaDon in cache TraHang
                var cthd_TH = localStorage.getItem(lcListCTHD_DoiTra);
                if (cthd_TH !== null) {
                    cthd_TH = JSON.parse(cthd_TH);
                    var arrCTHD_THafter = $.grep(cthd_TH, function (x) {
                        return x.IDRandomHD !== idRandom;
                    });
                    localStorage.setItem(lcListCTHD_DoiTra, JSON.stringify(arrCTHD_THafter));
                }
                // delete cache CTTraHang
                var cthdTraHang = localStorage.getItem(lcCTHDTraHang_fromHD);
                if (cthdTraHang !== null) {
                    cthdTraHang = JSON.parse(cthdTraHang);
                    cthdTraHang = $.grep(cthdTraHang, function (itemCTTH) {
                        return itemCTTH.IDRandomHD !== idRandom;
                    });
                    localStorage.setItem(lcCTHDTraHang_fromHD, JSON.stringify(cthdTraHang));
                }
                // reset HD_KhuyenMai --> not chose radio
                self.HD_KhuyenMai(undefined);
                // delete productKM_HoaDon && bind again HHTang_HoaDon
                var lstProductKM_HD = localStorage.getItem(lcProductKM_HoaDon);
                if (lstProductKM_HD !== null) {
                    lstProductKM_HD = JSON.parse(lstProductKM_HD);
                    lstProductKM_HD = $.grep(lstProductKM_HD, function (x) {
                        return x.IDRandomHD !== idRandom;
                    });
                    localStorage.setItem(lcProductKM_HoaDon, JSON.stringify(lstProductKM_HD));
                }

                BindHD_CTHDafterSave();

                // remove cache XuLiDonHang
                var lcXuLiDonHang = localStorage.getItem(lcXuLiDonHang_Const);
                if (lcXuLiDonHang !== null) {
                    lcXuLiDonHang = JSON.parse(lcXuLiDonHang);
                    lcXuLiDonHang = $.grep(lcXuLiDonHang, function (xx) {
                        return xx.MaHoaDon !== thisMaHD;
                    });
                    localStorage.setItem(lcXuLiDonHang_Const, JSON.stringify(lcXuLiDonHang));
                    var lcCTDatHang = localStorage.getItem(lcCTDatHang_Const);
                    if (lcCTDatHang !== null) {
                        lcCTDatHang = JSON.parse(lcCTDatHang);
                        lcCTDatHang = $.grep(lcCTDatHang, function (x) {
                            return x.MaHoaDon !== thisMaHD;
                        });
                        localStorage.setItem(lcCTDatHang_Const, JSON.stringify(lcCTDatHang));
                    }
                }

                let cacheCP = localStorage.getItem('lcChiPhi');
                if (cacheCP !== null) {
                    cacheCP = JSON.parse(cacheCP);
                    cacheCP = $.grep(cacheCP, function (x) {
                        return x.IDRandomHD !== idRandom;
                    });
                    localStorage.setItem('lcChiPhi', JSON.stringify(cacheCP));
                }
                Call_6Func();
                HideShow_HeaderCTHD();
            })
        }
        else {
            self.IsClickCloseHD(false);
            lstHoaDon = RemoveHD_byMaHoaDon(thisMaHD, lstHoaDon);
            localStorage.setItem(lcListHD, JSON.stringify(lstHoaDon));
            GetCurrentPage_byMaHoaDon(_maHoaDon);
            BindHD_CTHDafterSave();
            Call_6Func();
            HideShow_HeaderCTHD();
        }
    }
    self.resetInforHD_CTHD = function (maHDNew) {
        self.textSearchPhieuTN('');
        $('#txtSearchCar').val('');
        self.NewProducts([]);
        self.HangHoaAfterAdds([]);
        self.HHTang_HoaDon([]);
        self.HoaDons(new FormModel_NewHoaDon());
        self.HoaDons().MaHoaDon(maHDNew);
        ResetInfor_KhachHang();
        self.SetNhanVien(_idNhanVien);
        BindLstBangGia_byNhanVien_andDoiTuong();
        self.SetBangGia(const_GuidEmpty);
        self.SetChiNhanh(id_DonVi);
    }
    function ResetInfor_KhachHang() {
        self.selectedNCC(null);
        self.ChiTietDoiTuong([]);
        self.SoDuDatCoc(0);

        vmSearchCar.searchList = [];
        vmThanhToanGara.theGiaTriCus.SoDuTheGiaTri = 0;
        vmThanhToanGara.theGiaTriCus.CongNoThe = 0;
        if (vmNKGoiBaoDuong.listData.GoiDichVu.length > 0) {
            vmNKGoiBaoDuong.listData.GoiDichVu = [];
            vmNKGoiBaoDuong.filterGDV.ListFilter = [];
        }
        ResetInput_KhachHang();
    }
    self.GetThongTinHoaDon = function (item) {
        if (self.IsClickCloseHD()) {
            return false;
        }
        // reset KhuyenMai to do set value new
        self.HH_KhuyenMai(undefined);
        self.HD_KhuyenMai(undefined);
        _maHoaDon = item.MaHoaDon;
        localStorage.setItem(lcMaHD, _maHoaDon);

        var idRandom = item.IDRandom;
        idRandom = item.IDRandom;
        self.IDPhongBan_Chosing(item.ID_ViTri);

        GetInForCustomer_byID(item.ID_DoiTuong);
        self.SetNhanVien(item.ID_NhanVien);
        BindLstBangGia_byNhanVien_andDoiTuong();
        self.SetBangGia(item.ID_BangGia);
        self.SetChiNhanh(item.ID_DonVi)
        BindHD_byIDRandom(idRandom);
        BindCTHD_byIDRandomHD(idRandom);
        OnOff_Timer(item.NgayLapHoaDon);
        // styele active hoadon opening
        $('.gara-bill-label  li.active').removeClass('active');
        $('.gara-bill-label  li font').each(function () {
            if ($(this).text() === _maHoaDon) {
                $(this).parent().addClass('active');
            }
        });
        $('#ddlDMChungTus').removeAttr('disabled');
        $('#txtSearchHH').focus();
        Call_6Func();
    }
    //phan trang: buton prev, next: HangHoa
    self.PageCount = ko.computed(function () {
        var div;
        if (self.HangHoas() !== null) {
            div = Math.floor(self.HangHoas().length / self.pageSize());
            div += self.HangHoas().length % self.pageSize() > 0 ? 1 : 0;
        }
        return div - 1;
    });
    function BindListHangHoa_ByPage() {
        var first = self.currentPage() * self.pageSize();
        var lst = self.HangHoas().slice(first, first + self.pageSize());
        self.PageResults($.extend(true, [], lst));
    }
    self.hasPrevious = ko.computed(function () {
        return self.currentPage() !== 0;
    });
    self.hasNext = ko.computed(function () {
        return self.currentPage() !== self.PageCount();
    });
    self.next = function () {
        if (self.currentPage() < self.PageCount()) {
            self.currentPage(self.currentPage() + 1);
        }
    }
    self.previous = function () {
        if (self.currentPage() !== 0) {
            self.currentPage(self.currentPage() - 1);
        }
    }
    // if HDTraHang: assign ListDonViTinh = [] --> not allow change
    function Reset_ListDVT_forCTHD_TraHang() {
        var cthd = localStorage.getItem(lcListCTHD);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            for (let i = 0; i < cthd.length; i++) {
                if (cthd[i].LoaiHoaDon === 6) {
                    cthd[i].ListDonViTinh = [];
                }
            }
            localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
        }
    }
    // not use
    self.Expand_ddlDonViTinh = function (item) {
        var thisObj = event.currentTarget;
        var isShow = item.ListDonViTinh.length > 0;
        if (isShow) {
            $(thisObj).addClass('open');
        }
    }

    function GetMax_MaHoaDon(loaiHD, lstHD) {
        var max = 0;
        var lstHD_byUser = $.grep(lstHD, function (x) {
            return x.StatusOffline === false && x.NguoiTao === userLogin && x.TrangThaiHD === 1;
        });
        var arrLoai = [loaiHD];
        if (loaiHD === 25 || loaiHD === 1) {
            arrLoai = [1, 25];
        }
        var arrHD = $.grep(lstHD_byUser, function (x) {
            return $.inArray(x.LoaiHoaDon, arrLoai) > -1;
        });
        if (arrHD.length > 0) {
            max = Math.max.apply(Math, arrHD.map(function (item) {
                return item.MaHoaDon.match(/\d+/);
            }));
        }
        else {
            max = 0;
        }
        return max;
    }

    function GetHDOpening_byMaHoaDon(maHD, lstHD) {
        var arr = $.grep(lstHD, function (x) {
            return x.MaHoaDon === maHD &&
                (x.NguoiTao === userLogin || $.inArray(x.TrangThaiHD, [3, 4, 7]) > -1); // 1.New, 3.HDTamLuu, 4.DaTT, 7.DaXoa
        });
        return arr;
    }

    function GetHDOpening_byIDRandom(idRandom, lstHD) {
        var arr = $.grep(lstHD, function (x) {
            return x.IDRandom === idRandom;
        });
        return arr;
    }

    function RemoveHD_byMaHoaDon(maHD, lstHD) {
        return $.grep(lstHD, function (x) {
            return x.MaHoaDon !== maHD;// neu mo HDTamLuu of user other --> remove
        })
    }
    function GetIDRandomHD_byMaHoaDon(maHD) {
        var idRandom = '';
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            var itemEx = GetHDOpening_byMaHoaDon(maHD, lstHD);
            if (itemEx.length > 0) {
                idRandom = itemEx[0].IDRandom;
            }
        }
        return idRandom;
    }
    function Focus_InputPhaiThanhToan() {
        if (self.windowWidth() > 1280) {
            // neu ipad: khong focus vao input
        }
    }
    // tinh tong thoi gian thuc hien dich vu (chi loai 1)
    function CaculatorTimeDoingService(laHangHoa, idRandomHD, isDoiTra) {
        if (laHangHoa === false) {
            var nameCache = lcListCTHD;
            if (isDoiTra) {
                nameCache = lcListCTHD_DoiTra;
            }
            var cthd = localStorage.getItem(nameCache);
            if (cthd !== null) {
                cthd = JSON.parse(cthd);
                var lstDV = $.grep(cthd, function (x) {
                    return x.IDRandomHD === idRandomHD && x.LaHangHoa === false;
                });
                var totalTime = 0;
                for (let i = 0; i < lstDV.length; i++) {
                    totalTime += lstDV[i].ThoiGianThucHien * lstDV[i].SoLuong;
                }
                // update time in lstHD
                var lstHD = localStorage.getItem(lcListHD);
                if (lstHD !== null) {
                    lstHD = JSON.parse(lstHD);
                    for (let i = 0; i < lstHD.length; i++) {
                        if (lstHD[i].IDRandom === idRandomHD) {
                            lstHD[i].ThoiGianThucHien = totalTime;
                            break;
                        }
                    }
                    localStorage.setItem(lcListHD, JSON.stringify(lstHD));
                }
            }
        }
    }
    // check hide- show input/ lable DonGia
    function GetRoleChangePrice(loaiHD) {
        var role = false;
        switch (loaiHD) {
            case 1:
            case 25:
                role = self.roleChangePriceProduct_Invoice();
                break;
            case 3:
                role = self.roleChangePriceProduct_Order();
                break;
            case 6:
                role = self.roleChangePriceProduct_Return();
                break;
            case 19:
                role = self.roleChangePriceProduct_ServicePackage();
                break;
        }
        return role;
    }

    function GetNgaySX_NgayHH(ctDoing) {
        var ngaysx = ctDoing.NgaySanXuat;
        if (!commonStatisJs.CheckNull(ngaysx)) {
            ngaysx = moment(ngaysx).format('DD/MM/YYYY');
        }
        var hansd = ctDoing.NgayHetHan;
        if (!commonStatisJs.CheckNull(hansd)) {
            hansd = moment(hansd).format('DD/MM/YYYY');
        }
        return {
            NgaySanXuat: ngaysx,
            NgayHetHan: hansd,
        }
    }

    function newHangHoa(ctDoing, hd, addCungLoai = false) {
        var loaiHD = addCungLoai ? ctDoing.LoaiHoaDon : hd.LoaiHoaDon;
        var ptThue = self.HoaDons().PTThueHoaDon() > 0 ? self.HoaDons().PTThueHoaDon() : 0;
        var ptGiamGiaHH = self.HoaDons().PTChietKhauHH() > 0 ? self.HoaDons().PTChietKhauHH() : 0;
        var headerBH = self.HoaDons().HeaderBH_GiaTriPtram();
        var dongiaBH = 0;

        var idRandom = CreateIDRandom('RandomCT_');
        let price = formatNumberToFloat(ctDoing.GiaBan);
        let tienCK = ptGiamGiaHH * price / 100;
        var tienthue = ptThue * (price - tienCK) / 100;

        var giaVon = ctDoing.GiaVon;
        var laHangHoa = ctDoing.LaHangHoa;
        if (!laHangHoa) {
            giaVon = 0;
        }
        var idCT_goiDV = ctDoing.ID_ChiTietGoiDV;
        idCT_goiDV = (idCT_goiDV === undefined ? null : idCT_goiDV);

        var tongphiDV = 0, soluong = ctDoing.SoLuong;
        if (loaiHD === 1 || loaiHD === 25) {
            tongphiDV = ctDoing.PhiDichVu;
            if (ctDoing.LaPTPhiDichVu) {
                // phidichvu: tinh truoc thue
                tongphiDV = Math.round(ctDoing.PhiDichVu * soluong * price / 100);
            }
        }
        var sophutTH = 0;
        if (addCungLoai) {
            sophutTH = ctDoing.TimeRemain;
        }
        else {
            sophutTH = ctDoing.SoPhutThucHien;
        }

        var lstDVT = addCungLoai ? ctDoing.ListDonViTinh : commonStatisJs.CheckNull(ctDoing.DonViTinh) ? [] : ctDoing.DonViTinh;
        if (headerBH > 0) {
            switch (parseInt(self.HoaDons().HeaderBH_Type())) {
                case 1:
                    dongiaBH = (price - tienCK) * headerBH / 100;
                    break;
                case 2:
                    dongiaBH = price * headerBH / 100;
                    break;
            }
        }

        var lot = GetNgaySX_NgayHH(ctDoing);
        var combo = [];
        if (!addCungLoai) {
            if (!commonStatisJs.CheckNull(ctDoing.ThanhPhanComBo)) {
                combo = ctDoing.ThanhPhanComBo;
            }
        }

        return {
            SoThuTu: 1,
            IDRandom: idRandom,
            IDRandomHD: addCungLoai ? ctDoing.IDRandomHD : hd.IDRandom,
            MaHoaDon: addCungLoai ? ctDoing.MaHoaDon : hd.MaHoaDon,
            LoaiHoaDon: loaiHD,
            GiaBan: price,
            DonGia: price, // GiaBan of HH ban dau
            GiaVon: giaVon,
            SoLuong: soluong,
            TonKho: ctDoing.TonKho,
            TenHangHoa: ctDoing.TenHangHoa,
            ThuocTinh_GiaTri: ctDoing.ThuocTinh_GiaTri,
            ThanhTien: soluong * (price - tienCK),
            ThanhToan: soluong * (price - tienCK + tienthue),
            ID_DonViQuiDoi: ctDoing.ID_DonViQuiDoi,
            TenDonViTinh: ctDoing.TenDonViTinh,
            MaHangHoa: ctDoing.MaHangHoa,
            ID_HangHoa: ctDoing.ID_HangHoa, // check when load list Lot
            TienChietKhau: tienCK,// tien giam gia
            PTChietKhau: ptGiamGiaHH, // giam gia: %
            DVTinhGiam: '%',
            ThoiGian: moment(new Date()).format('YYYY-MM-DD HH:mm'),// use get time when click TabSoDo
            GhiChu: ctDoing.GhiChuHH,
            SoLuongDaMua: 0, // Add trong TH tra hang,
            SoLuongConLai: 0,// use at Dathang: so luong con lai sau khi xu li don hang
            CssWarning: false, // warning if TonKho < SoLuong (setting XuatAm)
            LaHangHoa: ctDoing.LaHangHoa,
            ID_NhomHangHoa: ctDoing.ID_NhomHangHoa,
            TenNhomHangHoa: ctDoing.TenNhomHangHoa,
            IsKhuyenMai: false,
            IsOpeningKMai: false,
            ID_KhuyenMai: null,
            HangHoa_KM: [],
            TenKhuyenMai: '',
            PhiDichVu: ctDoing.PhiDichVu,
            LaPTPhiDichVu: ctDoing.LaPTPhiDichVu,
            TongPhiDichVu: tongphiDV,
            ThoiGianThucHien: sophutTH === null ? 0 : sophutTH,
            GhiChuHH: ctDoing.GhiChuHH,
            // lo
            QuanLyTheoLoHang: ctDoing.QuanLyTheoLoHang,
            DM_LoHang: [],
            ID_LoHang: ctDoing.ID_LoHang,
            LotParent: ctDoing.QuanLyTheoLoHang,  // if QuanLyTheoLo= true, lotParent= true -> check when update CTHD
            MaLoHang: ctDoing.MaLoHang,
            NgaySanXuat: lot.NgaySanXuat,
            NgayHetHan: lot.NgayHetHan,

            BH_NhanVienThucHien: [], // use spa
            GhiChu_NVThucHien: '',
            GhiChu_NVTuVan: '',
            GhiChu_NVThucHienPrint: '', // used to printHoaDon (not show %ChietKhau)
            GhiChu_NVTuVanPrint: '',
            ID_ChiTietDinhLuong: null,
            ID_ChiTietGoiDV: idCT_goiDV,
            ChatLieu: '',
            // use when TraHang KM || use dich vu co KM
            ID_TangKem: null,
            TangKem: false,
            ListDonViTinh: lstDVT,
            DiemKhuyenMai: 0,
            // use to check TonKho if same ID_HangHoa
            LaDonViChuan: ctDoing.LaDonViChuan,
            TyLeChuyenDoi: ctDoing.TyLeChuyenDoi,
            ShowWarningQuyCach: false,
            QuyCach: ctDoing.QuyCach,
            SoLuongQuyCach: 0,
            ThanhPhan_DinhLuong: addCungLoai ? ctDoing.QuanLyTheoLoHang ? [] : ctDoing.ThanhPhan_DinhLuong : [],
            HangCungLoais: [],
            LaConCungLoai: addCungLoai,
            PTThue: ptThue,
            TienThue: tienthue,
            ThoiGianBaoHanh: ctDoing.ThoiGianBaoHanh,
            LoaiThoiGianBH: addCungLoai ? ctDoing.LoaiThoiGianBH : ctDoing.LoaiBaoHanh,
            TimeStart: 0,// ampm
            QuaThoiGian: 0,// minutes (timeover)
            TimeRemain: sophutTH,
            TenViTri: addCungLoai ? ctDoing.TenViTri : hd.TenViTriHD,
            ID_ViTri: addCungLoai ? ctDoing.ID_ViTri : hd.ID_ViTri,
            DuocTichDiem: ctDoing.DuocTichDiem,
            DichVuTheoGio: ctDoing.DichVuTheoGio,

            TenHangHoaThayThe: ctDoing.TenHangHoa,
            ID_BaoDuong: null,
            DonGiaBaoHiem: dongiaBH,
            ID_LichBaoDuong: null,
            ThanhPhanComBo: combo,
            LoaiHangHoa: ctDoing.LoaiHangHoa,
            HoaHongTruocChietKhau: ctDoing.HoaHongTruocChietKhau,
        }
    }

    function UpdateAgain_DonViTinhCTHD(idHangHoa, isDoiTra = false) {
        var cacheName = lcListCTHD;
        if (isDoiTra) {
            cacheName = lcListCTHD_DoiTra;
        }
        var cthd = localStorage.getItem(cacheName);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);

            let cthd_sameIDHangHoa = $.grep(cthd, function (x) {
                return x.ID_HangHoa === idHangHoa;
            });

            // get all dvt of this hanghoa
            var arrDVT = [];
            for (let i = 0; i < cthd_sameIDHangHoa.length; i++) {
                let itFor = cthd_sameIDHangHoa[i];
                if (arrDVT.filter(x => x.ID_DonViQuiDoi === itFor.ID_DonViQuiDoi).length === 0) {
                    arrDVT.push({ ID_DonViQuiDoi: itFor.ID_DonViQuiDoi, TenDonViTinh: itFor.TenDonViTinh, Xoa: false });
                }

                for (let j = 0; j < itFor.ListDonViTinh.length; j++) {
                    // check exist in arrDVT & push
                    let itFor2 = itFor.ListDonViTinh[j];
                    if (arrDVT.filter(x => x.ID_DonViQuiDoi === itFor2.ID_DonViQuiDoi).length === 0) {
                        arrDVT.push({ ID_DonViQuiDoi: itFor2.ID_DonViQuiDoi, TenDonViTinh: itFor2.TenDonViTinh, Xoa: false });
                    }
                }
            }

            // update again lst DVT to cthd
            let find = 0;
            for (let i = 0; i < cthd.length; i++) {
                if (cthd[i].ID_HangHoa === idHangHoa) {
                    // get arrQuiDoi exist
                    let arrIDQuiDoi = [];
                    let arrEx = $.grep(cthd_sameIDHangHoa, function (x) {
                        return x.ID_DonViQuiDoi !== cthd[i].ID_DonViQuiDoi;
                    });
                    for (let k = 0; k < arrEx.length; k++) {
                        arrIDQuiDoi.push(arrEx[k].ID_DonViQuiDoi);
                    }
                    cthd[i].ListDonViTinh = $.grep(arrDVT, function (x) {
                        return $.inArray(x.ID_DonViQuiDoi, arrIDQuiDoi) == -1;
                    });
                    find = find + 1;
                    if (find === cthd_sameIDHangHoa.length) {
                        i = cthd.length;// esc for loop
                    }
                }
            }
        }
        localStorage.setItem(cacheName, JSON.stringify(cthd));
    }

    self.ChangeDonViTinh = function (item, parent, isDoiTra) {
        var newIDQuiDoi = item.ID_DonViQuiDoi;
        var oldIDQuiDoi = parent.ID_DonViQuiDoi;
        if (newIDQuiDoi !== oldIDQuiDoi) {
            var idRandomHD = parent.IDRandomHD;
            let dvtOld = { ID_DonViQuiDoi: oldIDQuiDoi, TenDonViTinh: parent.TenDonViTinh, Xoa: false };
            var cacheName = lcListCTHD;
            if (isDoiTra) {
                cacheName = lcListCTHD_DoiTra;
            }
            var cthd = localStorage.getItem(cacheName);
            if (cthd !== null) {
                cthd = JSON.parse(cthd);
                // update lst DonViTinh for cthd
                for (let i = 0; i < cthd.length; i++) {
                    if (cthd[i].ID_HangHoa === parent.ID_HangHoa) {
                        if (cthd[i].ID_DonViQuiDoi !== oldIDQuiDoi) {
                            cthd[i].ListDonViTinh.push(dvtOld);
                            cthd[i].ListDonViTinh = cthd[i].ListDonViTinh.filter(x => x.ID_DonViQuiDoi !== newIDQuiDoi);
                        }
                    }
                }

                // update DonGia, GiaVon, TonKho with new dvt
                ajaxHelper(DMHangHoaUri + 'GetDonViTinhKhacGiaoDich?iddvqd=' + newIDQuiDoi + '&iddv=' + id_DonVi, 'GET').done(function (data) {
                    let giavon = data[0].GiaVon;  // if LoHang not exist in DM_GiaVon --> get giavon of parent
                    if (parent.QuanLyTheoLoHang) {
                        if (data.filter(p => p.ID_LoHang === null).length === 0) {
                            data = data.filter(p => p.ID_LoHang === parent.ID_LoHang);
                            giavon = data[0].GiaVon;
                        }
                    }
                    let mahang = data[0].MaHangHoa;
                    let giaban = data[0].GiaBanHH;
                    let tonkho = data[0].TonKho;

                    for (let i = 0; i < cthd.length; i++) {
                        if (cthd[i].ID_DonViQuiDoi === oldIDQuiDoi) {
                            cthd[i].MaHangHoa = mahang;
                            cthd[i].DonGia = giaban;
                            cthd[i].GiaVon = giavon;
                            cthd[i].GiaBan = giaban;
                            cthd[i].TonKho = tonkho;
                            cthd[i].TienChietKhau = 0;
                            cthd[i].PTChietKhau = 0;
                            cthd[i].PTThue = 0;
                            cthd[i].TienThue = 0;
                            cthd[i].DVTinhGiam = '%';
                            cthd[i].ThanhTien = giaban * cthd[i].SoLuong;
                            cthd[i].ThanhToan = cthd[i].ThanhTien;
                            cthd[i].TenDonViTinh = item.TenDonViTinh;
                            cthd[i].ID_DonViQuiDoi = newIDQuiDoi;

                            for (let j = 0; j < cthd[i].DM_LoHang.length; j++) {
                                cthd[i].DM_LoHang[j].ID_DonViQuiDoi = newIDQuiDoi;
                                cthd[i].DM_LoHang[j].TenDonViTinh = item.TenDonViTinh;
                                cthd[i].DM_LoHang[j].MaHangHoa = mahang;
                                cthd[i].DM_LoHang[j].DonGia = giaban;
                                cthd[i].DM_LoHang[j].GiaBan = giaban;
                                cthd[i].DM_LoHang[j].GiaVon = giavon;
                                cthd[i].DM_LoHang[j].TonKho = tonkho;
                                cthd[i].DM_LoHang[j].ThanhTien = giaban * cthd[i].DM_LoHang[j].SoLuong;
                                cthd[i].DM_LoHang[j].ThanhToan = cthd[i].DM_LoHang[j].ThanhTien;
                                cthd[i].DM_LoHang[j].PTChietKhau = 0;
                                cthd[i].DM_LoHang[j].TienChietKhau = 0;
                                cthd[i].DM_LoHang[j].DVTinhGiam = '%';
                                cthd[i].DM_LoHang[j].TienThue = 0;
                                cthd[i].DM_LoHang[j].PTThue = 0;
                            }

                            for (let j = 0; j < cthd[i].HangCungLoais.length; j++) {
                                cthd[i].HangCungLoais[j].ID_DonViQuiDoi = newIDQuiDoi;
                                cthd[i].HangCungLoais[j].TenDonViTinh = item.TenDonViTinh;
                                cthd[i].HangCungLoais[j].MaHangHoa = mahang;
                                cthd[i].HangCungLoais[j].DonGia = giaban;
                                cthd[i].HangCungLoais[j].GiaVon = giavon;
                                cthd[i].HangCungLoais[j].GiaBan = giaban;
                                cthd[i].HangCungLoais[j].TonKho = tonkho;
                                cthd[i].HangCungLoais[j].ThanhTien = giaban * cthd[i].HangCungLoais[j].SoLuong;
                                cthd[i].HangCungLoais[j].ThanhToan = cthd[i].HangCungLoais[j].ThanhTien;
                                cthd[i].HangCungLoais[j].PTChietKhau = 0;
                                cthd[i].HangCungLoais[j].TienChietKhau = 0;
                                cthd[i].HangCungLoais[j].DVTinhGiam = '%';
                                cthd[i].HangCungLoais[j].TienThue = 0;
                                cthd[i].HangCungLoais[j].PTThue = 0;
                            }
                            break;
                        }
                    }
                    localStorage.setItem(cacheName, JSON.stringify(cthd));
                    BindCTHD_byIDRandomHD(idRandomHD);
                    ResetPTChietKhauHH_PTThue(idRandomHD);
                    UpdateCacheHDLe(idRandomHD, isDoiTra);
                    BindHD_byIDRandom(idRandomHD);
                });
            }
        }
    }

    // assign value for variable hide/show colunm & hide/show header
    function Get_SetHideShowColumCTHD() {
        var lcSetCTHD = localStorage.getItem('lcHideShowColumCTHD_BL');
        if (lcSetCTHD !== null) {
            lcSetCTHD = JSON.parse(lcSetCTHD);
            for (let i = 0; i < lcSetCTHD.length; i++) {
                self.show_STT(lcSetCTHD[i].ShowSTT);
                self.show_ProductCode(lcSetCTHD[i].ShowProductCode);
                self.show_ProductName(lcSetCTHD[i].ShowProductName);
                self.show_ProductPrice(lcSetCTHD[i].ShowProductPrice);
                self.show_SumPrice(lcSetCTHD[i].ShowSumPrice);
                self.show_ProductCount(lcSetCTHD[i].ShowProductCount);
                self.show_ProductSale(lcSetCTHD[i].ShowProductSale);
                HideShow_HeaderCTHD();
                break;
            }
        }
    }

    self.giamSoLuong = function (item) {
        var idRandom = item.IDRandom;
        var idQuiDoi = item.ID_DonViQuiDoi;
        var idCT_goiDV = item.ID_ChiTietGoiDV;
        idCT_goiDV = (idCT_goiDV === undefined ? null : idCT_goiDV);

        var objNumber = $('#munber_' + idRandom);
        var newNumber = formatNumberToFloat(objNumber.val());
        if (newNumber >= 1) {
            objNumber.val(newNumber - 1);
        }
        var lstHD = JSON.parse(localStorage.getItem(lcListHD));
        var itemHD = GetHDOpening_byMaHoaDon(_maHoaDon, lstHD);
        if (itemHD[0].StatusOffline === false) {
            var idRandomHD = itemHD[0].IDRandom;
            newNumber = parseFloat(objNumber.val());
            var cthdDoing = FindCTHD_isDoing(item, false);
            cthdDoing.SoLuong = newNumber;
            cthdDoing.ThanhToan = cthdDoing.SoLuong * (cthdDoing.DonGia - cthdDoing.TienChietKhau + cthdDoing.TienThue);
            cthdDoing.ThanhTien = cthdDoing.SoLuong * (cthdDoing.DonGia - cthdDoing.TienChietKhau);

            var cthd = localStorage.getItem(lcListCTHD);
            cthd = JSON.parse(cthd);
            cthd = updateCTHDLe(cthd, cthdDoing);
            localStorage.setItem(lcListCTHD, JSON.stringify(cthd));

            if (itemHD[0].LoaiHoaDon !== 6) {
                // check CongNo when use service
                //if (idCT_goiDV !== null) {
                //    var check = CheckCongNo_GoiDV_whenChangeSoLuong(item, parseFloat(objNumber.val()));
                //    if (check === false) {
                //        return check;
                //    }
                //}
                ChangeSoLuong_UpdateSLQuyCach(item, false, item.QuyCach, newNumber);
                UpdateSoLuong_TPDinhLuong_ofCTHD(idRandomHD, idRandom, newNumber, false);
                self.KM_KMApDung([]);
                UpdateKhuyenMai_CTHD(idQuiDoi, idRandomHD);
                if (item.ThanhPhanComBo.length > 0) {
                    for (let k = 0; k < cthdDoing.ThanhPhanComBo.length; k++) {
                        let tpCombo = cthdDoing.ThanhPhanComBo[k];
                        TangGiamSoLuong_updatePhiDichVu(tpCombo, tpCombo.SoLuongMacDinh * newNumber, false);
                    }
                    ChangeSoLuongParent_UpdateCombo(idRandom, newNumber, false);
                }
                else {
                    TangGiamSoLuong_updatePhiDichVu(cthdDoing, newNumber, false);
                }
                ResetKM_HangHoa(idQuiDoi, item.ID_NhomHangHoa, idRandomHD);
                ResetKM_HoaDon(idRandomHD);
                if (cthdDoing.DonGiaBaoHiem > 0) {
                    UpdateInforBaoHiem(idRandomHD);
                }
                UpdateCacheHDLe(idRandomHD, false);
                UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();
                UpdateWarning_forCTHD_byIDQuiDoi(idQuiDoi, idRandomHD);
                UpdateChietKhauNV_inCTHD(idRandom, false, cthdDoing);
                BindCTHD_byIDRandomHD(idRandomHD);
                // update status change = true for HDDatHang dang XuLy
                if (itemHD[0].LoaiHoaDon === 3) {
                    Update_StatusXuLy_ofHDDatHang(idRandomHD);
                }
            }
            else {
                ChangeSoLuong_UpdateSLQuyCach(item, false, item.QuyCach, newNumber);
                UpdateSoLuong_TPDinhLuong_ofCTHD(idRandomHD, idRandom, newNumber, true);
                if (item.ThanhPhanComBo.length > 0) {
                    ChangeSoLuongParent_UpdateCombo(idRandom, newNumber, false);
                }
                UpdateHD_TraHang(idRandomHD);
                // bind HangHoa after change QuyCach
                var cthd2 = localStorage.getItem(lcListCTHD);
                if (cthd2 !== null) {
                    cthd2 = JSON.parse(cthd2);
                    var ctHD = $.grep(cthd2, function (itemCT) {
                        return itemCT.IDRandomHD === idRandomHD;
                    });
                    self.HangHoaAfterAdds(ctHD);
                }
            }
            BindHD_byIDRandom(idRandomHD);
            Focus_InputPhaiThanhToan();
        }
        Caculator_AmountProduct();
        HideShow_Icon_ChietKhauNV();
    }
    self.tangSoLuong = function (item) {
        // item: CTHD, DM_LoHang
        var idRandom = item.IDRandom;
        var idRandomHD = item.IDRandomHD;
        var idQuiDoi = item.ID_DonViQuiDoi;
        var objNumber = $('#munber_' + idRandom);
        var newNumber = formatNumberToFloat(objNumber.val());
        var idCT_goiDV = item.ID_ChiTietGoiDV;
        idCT_goiDV = (idCT_goiDV === undefined ? null : idCT_goiDV);

        // get infor of this cthd
        var lstHD = JSON.parse(localStorage.getItem(lcListHD));
        var itemHD = GetHDOpening_byMaHoaDon(_maHoaDon, lstHD);
        if (itemHD[0].StatusOffline === false) {
            var cthdDoing = FindCTHD_isDoing(item, false);
            var cthd = localStorage.getItem(lcListCTHD);
            cthd = JSON.parse(cthd);
            // HD mua
            if (itemHD[0].LoaiHoaDon !== 6) {
                // check SoLuong > SoLuongConLai in service package in chosing
                var check = Check_Enought_SoLuongConLai_ServicePackage(item, (newNumber + 1));
                if (check !== '') {
                    ShowMessage_Danger(check);
                    return false;
                }
                // check CongNo when use service
                //if (idCT_goiDV !== null) {
                //    check = CheckCongNo_GoiDV_whenChangeSoLuong(item, newNumber + 1);
                //    if (check === false) {
                //        return check;
                //    }
                //}
                objNumber.val(newNumber + 1);
                cthdDoing.SoLuong = newNumber + 1;
                cthdDoing.ThanhToan = cthdDoing.SoLuong * (cthdDoing.DonGia - cthdDoing.TienChietKhau + cthdDoing.TienThue);
                cthdDoing.ThanhTien = cthdDoing.SoLuong * (cthdDoing.DonGia - cthdDoing.TienChietKhau);
                cthd = updateCTHDLe(cthd, cthdDoing);
                localStorage.setItem(lcListCTHD, JSON.stringify(cthd));

                ChangeSoLuong_UpdateSLQuyCach(item, false, item.QuyCach, newNumber + 1);
                UpdateSoLuong_TPDinhLuong_ofCTHD(idRandomHD, idRandom, newNumber + 1, false);
                self.KM_KMApDung([]);
                UpdateKhuyenMai_CTHD(idQuiDoi, idRandomHD);
                if (item.ThanhPhanComBo.length > 0) {
                    for (let k = 0; k < cthdDoing.ThanhPhanComBo.length; k++) {
                        let tpCombo = cthdDoing.ThanhPhanComBo[k];
                        TangGiamSoLuong_updatePhiDichVu(tpCombo, tpCombo.SoLuongMacDinh * cthdDoing.SoLuong, false);
                    }
                    ChangeSoLuongParent_UpdateCombo(idRandom, cthdDoing.SoLuong, false);
                }
                else {
                    TangGiamSoLuong_updatePhiDichVu(cthdDoing, cthdDoing.SoLuong, false);
                }
                ResetKM_HangHoa(idQuiDoi, item.ID_NhomHangHoa, idRandomHD);
                ResetKM_HoaDon(idRandomHD);
                if (cthdDoing.DonGiaBaoHiem > 0) {
                    UpdateInforBaoHiem(idRandomHD);
                }
                UpdateCacheHDLe(idRandomHD, false);
                UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();
                UpdateWarning_forCTHD_byIDQuiDoi(idQuiDoi, idRandomHD);
                UpdateChietKhauNV_inCTHD(idRandom, false, cthdDoing);
                BindCTHD_byIDRandomHD(idRandomHD);
                //CaculatorTimeDoingService(item.LaHangHoa, idRandomHD, false);
                // update status change = true for HDDatHang dang XuLy
                if (itemHD[0].LoaiHoaDon === 3) {
                    Update_StatusXuLy_ofHDDatHang(idRandomHD);
                }
                Focus_InputPhaiThanhToan();
            }
            else {
                // if TraNhanh --> cho phep tang SL
                if (itemHD[0].ID_HoaDon === null) {
                    objNumber.val(newNumber + 1);
                    newNumber = newNumber + 1;
                }
                else {
                    // chi cho phep tang if soluong tra < soluong da mua
                    if (newNumber < item.SoLuongDaMua) {
                        newNumber = newNumber + 1;
                        // truong hop SLDaMua la so thap phan
                        if (newNumber > item.SoLuongDaMua) {
                            newNumber = item.SoLuongDaMua;
                        }
                        objNumber.val(newNumber);
                    }
                }
                cthdDoing.SoLuong = newNumber;
                cthdDoing.ThanhToan = cthdDoing.SoLuong * (cthdDoing.DonGia - cthdDoing.TienChietKhau + cthdDoing.TienThue);
                cthdDoing.ThanhTien = cthdDoing.SoLuong * (cthdDoing.DonGia - cthdDoing.TienChietKhau);
                cthd = updateCTHDLe(cthd, cthdDoing);

                // update CTHD with soluongTra 
                for (let i = 0; i < cthd.length; i++) {
                    var itemOut = cthd[i];
                    if (itemOut.IDRandomHD === idRandomHD && itemOut.ID_DonViQuiDoi === idQuiDoi
                        && itemOut.ID_ChiTietGoiDV === idCT_goiDV) {
                        cthd[i].CssWarning = false;
                        break;
                    }
                }
                localStorage.setItem(lcListCTHD, JSON.stringify(cthd));

                ChangeSoLuong_UpdateSLQuyCach(item, false, item.QuyCach, newNumber);
                UpdateSoLuong_TPDinhLuong_ofCTHD(idRandomHD, idRandom, newNumber, true);
                if (item.ThanhPhanComBo.length > 0) {
                    ChangeSoLuongParent_UpdateCombo(idRandom, newNumber, false);
                }
                UpdateHD_TraHang(idRandomHD);
                // bind CTHD after change QuyCach
                var cthd2 = localStorage.getItem(lcListCTHD);
                if (cthd2 !== null) {
                    cthd2 = JSON.parse(cthd2);
                    var ctHD = $.grep(cthd2, function (itemCT) {
                        return itemCT.IDRandomHD === idRandomHD;
                    });
                    self.HangHoaAfterAdds(ctHD);
                }
            }
            BindHD_byIDRandom(idRandomHD);
        }
        Caculator_AmountProduct();
        HideShow_Icon_ChietKhauNV();
    }
    self.xoaHangHoa = function (item) {
        var idRandom = item.IDRandom;
        var idRandomHD = item.IDRandomHD;
        var idQuiDoi = item.ID_DonViQuiDoi;
        var maHoaDon = item.MaHoaDon;
        var loaiHD = item.LoaiHoaDon;
        _maHoaDon = maHoaDon;
        var cthdDoing = FindCTHD_isDoing(item, false);
        if (cthdDoing !== null) {

            var isOffline = CheckHoaDonOffline_byMaHoaDon(maHoaDon);
            if (isOffline === false) {
                return false;
            }
            var dvtDeleted = { ID_DonViQuiDoi: item.ID_DonViQuiDoi, TenDonViTinh: item.TenDonViTinh, Xoa: false };
            // !important: update truockhi xoa de get dvtinh old
            var cthd = localStorage.getItem(lcListCTHD);
            cthd = JSON.parse(cthd);
            cthd = XoaHangHoa_CheckCungLoai(cthd, item.LotParent, item.QuanLyTheoLoHang, item.LaConCungLoai, idRandom);
            for (let i = 0; i < cthd.length; i++) {
                if (cthd[i].ID_HangHoa === item.ID_HangHoa) {
                    cthd[i].ListDonViTinh.push(dvtDeleted);
                }
            }
            localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
            UpdateSoThuTu_CTHD(false, idRandomHD);
            // update TongTienHang if HD mua
            if (_maHoaDon.indexOf('Trả') === -1) {
                Reset_ListDVT_forCTHD_TraHang();
                UpdateInforBaoHiem(idRandomHD);
                UpdateCacheHDLe(idRandomHD, false);
                UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();

                if (cthdDoing.ThanhPhanComBo.length > 0) {
                    for (let k = 0; k < cthdDoing.ThanhPhanComBo.length; k++) {
                        let tpCombo = cthdDoing.ThanhPhanComBo[k];
                        TangGiamSoLuong_updatePhiDichVu(tpCombo, 0, false);
                    }
                }
                else {
                    TangGiamSoLuong_updatePhiDichVu(cthdDoing, 0, false, 1);
                }
            }
            else {
                UpdateHD_TraHang(idRandomHD);
            }
            // reset GiamGia, TienThue if delete all HangHoa of HoaDon
            var cthd_ofThisHD = $.grep(cthd, function (x) {
                return x.IDRandomHD === idRandomHD;
            });
            if (cthd_ofThisHD.length === 0) {
                var lstHD = localStorage.getItem(lcListHD);
                if (lstHD !== null) {
                    lstHD = JSON.parse(lstHD);
                    for (let i = 0; i < lstHD.length; i++) {
                        if (lstHD[i].IDRandom === idRandomHD) {
                            lstHD[i].TongChietKhau = 0
                            lstHD[i].TongGiamGia = 0;
                            lstHD[i].TongGiamGiaHangg = 0;
                            lstHD[i].PTChietKhauHH = 0;
                            lstHD[i].PTThueHoaDon = 0;
                            lstHD[i].TongTienThue = 0;
                            lstHD[i].PTThueBaoHiem = 0;
                            lstHD[i].TongTienThueBaoHiem = 0;
                        }
                    }
                    localStorage.setItem(lcListHD, JSON.stringify(lstHD));
                }
            }
            // bind CTHoaDOn
            self.KM_KMApDung([]);
            UpdateKhuyenMai_CTHD(null, idRandomHD);
            ResetKM_HangHoa(idQuiDoi, item.ID_NhomHangHoa, idRandomHD);
            BindCTHD_byIDRandomHD(idRandomHD);
            ResetKM_HoaDon(idRandomHD);
            if (loaiHD === 3) {
                Update_StatusXuLy_ofHDDatHang(idRandomHD);
            }
            BindHD_byIDRandom(idRandomHD);
            Focus_InputPhaiThanhToan();
            Caculator_AmountProduct();
            HideShow_Icon_ChietKhauNV();
        }
    }
    self.clickVND = function (item) {
        var idRandom = item.IDRandom;
        var idRandomHD = item.IDRandomHD;
        var $this = $('#vnd_' + idRandom);
        if ($this.hasClass('active-re')) {
            $this.removeClass('active-re');
        }
        else {
            $this.addClass('active-re');
        }

        var objSale = $('#pri-g_' + idRandom); // input giam gia
        var tienGiam = 0;
        var ptGiam = 0;
        var dvtGiam = '%';

        var ctDoing = FindCTHD_isDoing(item, false);
        if (ctDoing !== null) {
            ptGiam = ctDoing.PTChietKhau;
            tienGiam = ctDoing.TienChietKhau;
            dvtGiam = ctDoing.DVTinhGiam;

            if (!commonStatisJs.CheckNull(ctDoing.ID_ChiTietGoiDV) && parseInt(ctDoing.ChatLieu) === 4) {
                ShowMessage_Danger('Dịch vụ thuộc gói đã mua. Không thay đổi chiết khấu');
                return;
            }

            // if priceOld =0 (chua nhap gia von ban dau o hang hoa)
            if (ctDoing.GiaBan !== 0) {
                if ($this.hasClass('active-re')) {
                    // caculator agin %
                    ptGiam = tienGiam / ctDoing.GiaBan * 100;
                    objSale.val(formatNumber3Digit( ptGiam));
                    dvtGiam = '%';
                }
                else {
                    objSale.val(formatNumber3Digit(tienGiam));
                    dvtGiam = 'VND';
                    ptGiam = 0;
                }
                var cthd = localStorage.getItem(lcListCTHD);
                if (cthd !== null) {
                    cthd = JSON.parse(cthd);
                    cthd = updatePTVND(cthd, ctDoing, 1, ptGiam, dvtGiam);
                    localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
                }
                if (item.MaHoaDon.indexOf('Trả') > -1) {
                    UpdateHD_TraHang(idRandomHD);
                }
                else {
                    if (tienGiam > 0) {
                        cthdClickVND_ResetPTramHD(idRandomHD, 1);
                    }
                    UpdateCacheHDLe(idRandomHD, false);
                }
            }
        }
    }

    function cthdClickVND_ResetPTramHD(idRandomHD, type = 1) {
        var hd = localStorage.getItem(lcListHD);
        if (hd !== null) {
            hd = JSON.parse(hd);
            for (let i = 0; i < hd.length; i++) {
                if (hd[i].IDRandom === idRandomHD) {
                    switch (type) {
                        case 1:
                            hd[i].PTChietKhauHH = 0;
                            break;
                        case 2:
                            hd[i].PTThueHoaDon = 0;
                            break;
                    }
                    break;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(hd));
        }
    }

    self.cthd_clickThue = function (item) {
        var idRandom = item.IDRandom;
        var quanLiTheoLo = item.QuanLyTheoLoHang;
        quanLiTheoLo = (quanLiTheoLo === null ? false : quanLiTheoLo);
        var idCT_goiDV = item.ID_ChiTietGoiDV;
        idCT_goiDV = (idCT_goiDV === undefined ? null : idCT_goiDV);
        if (idCT_goiDV !== null && item.ChatLieu === '4') {
            return;
        }
        var $this = $('#taxCT_' + idRandom);
        if ($this.hasClass('active-re')) {
            $this.removeClass('active-re');
        }
        else {
            $this.addClass('active-re');
        }
        var objSale = $('#ipTaxCT_' + idRandom); // input giam gia
        var tienThue = 0;
        var ptThue = 0;
        var priceOld = 0;
        var giaSauCK = 0;
        var ctDoing = FindCTHD_isDoing(item, false);
        if (ctDoing !== null) {
            priceOld = ctDoing.GiaBan;
            ptThue = ctDoing.PTThue;
            tienThue = ctDoing.TienThue;
            giaSauCK = ctDoing.GiaBan - ctDoing.TienChietKhau;

            if (priceOld !== 0) {
                if ($this.hasClass('active-re')) {
                    ptThue = tienThue / giaSauCK * 100;
                    objSale.val(formatNumber3Digit(ptThue));
                }
                else {
                    objSale.val(formatNumber3Digit(tienThue));
                    ptThue = 0;
                }

                var cthd = localStorage.getItem(lcListCTHD);
                if (cthd !== null) {
                    cthd = JSON.parse(cthd);
                    cthd = updatePTVND(cthd, ctDoing, 2, ptThue, ctDoing.DVTingGiam);
                    localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
                }

                if (tienThue > 0 && ptThue === 0) {
                    cthdClickVND_ResetPTramHD(ctDoing.IDRandomHD, 2);
                }
            }
        }
    }

    self.cthd_editThue = function (item, e) {
        var sumTemp = 0;
        var idRandom = item.IDRandom;
        var idRandomHD = item.IDRandomHD;

        var rowID = item.ID_DonViQuiDoi;
        var thisObj = $(event.currentTarget); // input nhap giam gia
        var priceOld = 0;
        var tienThue = 0;
        var ptThue = 0;
        var giaSauCK = 0;

        var ctDoing = FindCTHD_isDoing(item, false);
        if (ctDoing !== null) {
            priceOld = ctDoing.GiaBan;
            ptThue = ctDoing.PTThue;
            giaSauCK = priceOld - ctDoing.TienChietKhau;

            if (!commonStatisJs.CheckNull(ctDoing.ID_ChiTietGoiDV) && parseInt(ctDoing.ChatLieu) === 4) {
                ShowMessage_Danger('Dịch vụ thuộc gói đã mua. Không thay đổi tiền thuế');
                if (ptThue > 0) {
                    thisObj.val(formatNumber3Digit(ptThue));
                }
                else {
                    thisObj.val(formatNumber3Digit(ctDoing.TienThue));
                }
                return;
            }

            if (priceOld === 0) {
                thisObj.val(0);
            }
            else {
                // format 000,000,000
                formatNumberObj(thisObj);
                var valThis = thisObj.val();
                if (valThis === '') {
                    valThis = 0;
                }
                if ($('#taxCT_' + idRandom).hasClass('active-re')) {
                    ptThue = formatNumberToFloat(valThis);
                    if (ptThue > 100) {
                        ptThue = 100;
                        thisObj.val(100);
                    }
                    tienThue = giaSauCK * ptThue / 100;
                }
                else {
                    tienThue = formatNumberToFloat(valThis);
                }
                sumTemp =(giaSauCK + tienThue) * ctDoing.SoLuong;

                ctDoing.PTThue = ptThue;
                ctDoing.TienThue = tienThue;
                ctDoing.ThanhToan = sumTemp;
                ctDoing.ThanhTien = giaSauCK * ctDoing.SoLuong;
            }
            $('#sum-f_' + idRandom).val(formatNumber3Digit(sumTemp));
            $('#ck_' + idRandom).text(formatNumber3Digit(ctDoing.TienChietKhau));
            $('#tax_' + idRandom).text(formatNumber3Digit(ctDoing.TienThue));
            $('#tax_' + idRandom).parent().css('display', ctDoing.TienThue > 0 ? '' : 'none');

            var cthd = localStorage.getItem(lcListCTHD);
            if (cthd !== null) {
                cthd = JSON.parse(cthd);
                cthd = updateCTHDLe(cthd, ctDoing);
                localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
            }

            UpdateChietKhauNV_inCTHD(idRandom, false, ctDoing);
            if (this.MaHoaDon.indexOf('Trả') > -1) {
                UpdateHD_TraHang(idRandomHD);
            }
            else {
                // reset KhuyenMai HangHoa, not bind CTHD
                ResetKM_HangHoa_ByIDQuiDoi_orNhomHang(rowID, item.ID_NhomHangHoa, idRandomHD);
                ResetKM_HoaDon(idRandomHD);
                UpdateCacheHDLe(idRandomHD, false, 4);
                UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();
                self.KM_KMApDung([]);
                UpdateKhuyenMai_CTHD(rowID, idRandomHD);
                // update status change = true for HDDatHang dang XuLy
                if (item.LoaiHoaDon === 3) {
                    Update_StatusXuLy_ofHDDatHang(idRandomHD);
                }
            }
            BindHD_byIDRandom(idRandomHD);
            ArrowRight_CTHD(item, event);
            ArrowLeft_CTHD(item, event);
        }
    }

    self.BaoHiemChosing = ko.observable();
    // get event from component jqauto-customer
    self.ChoseBaoHiem = function (item) {
        self.BaoHiemChosing(item);
        self.HoaDons().ID_BaoHiem(item.ID);
        var hd = localStorage.getItem(lcListHD);
        if (hd !== null) {
            hd = JSON.parse(hd);
            for (let i = 0; i < hd.length; i++) {
                if (hd[i].IDRandom === self.HoaDons().IDRandom()) {
                    hd[i].ID_BaoHiem = item.ID;
                    hd[i].TenBaoHiem = item.NguoiNopTien;
                    hd[i].BH_SDT = item.SoDienThoai;
                    hd[i].BH_DiaChi = item.DiaChi;
                    hd[i].BH_Email = item.Email;
                    break;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(hd));
        }
    }

    self.ChangeCus = function (item) {
        item.ID_NhomDoiTuong = item.IDNhomDoiTuongs;
        item.MaDoiTuong = item.MaNguoiNop;
        item.TenDoiTuong = item.NguoiNopTien;
        self.ChiTietDoiTuong([item]);
        self.Change_KhachHang(item.ID);
    }

    self.Gara_GetListBaoGia = function (idPhieuSC) {
        var param = {
            LstIDChiNhanh: [id_DonVi],
            ID_HangXe: idPhieuSC,
            FromDate: '2016-01-01',
            ToDate: moment(new Date()).format('YYYY-MM-DD'),
            TextSearch: "%",
            TrangThai: '0,1,2',
            CurrentPage: 0,
            PageSize: 0,
        }
        ajaxHelper(GaraAPI + '/Gara_GetListBaoGia', 'post', param).done(function (x) {
            if (x.res) {

            }
        })
    }

    self.ChosePhieuTiepNhan = function (item) {
        self.hideListPhieuTN();

        if (!commonStatisJs.CheckNull(self.HoaDons().ID_HoaDon())) {
            ShowMessage_Danger('Hóa đơn tạo từ báo giá. Không thể thay đổi thông tin phiếu tiếp nhận');
            return;
        }
        var hd = localStorage.getItem(lcListHD);
        if (hd !== null) {
            hd = JSON.parse(hd);
        }
        else {
            hd = [];
        }
        if (hd.length > 0) {
            for (let i = 0; i < hd.length; i++) {
                if (hd[i].IDRandom === self.HoaDons().IDRandom()) {
                    hd[i].LoaiHoaDon = hd[i].LoaiHoaDon === 1 ? 25 : hd[i].LoaiHoaDon;
                    hd[i].ID_PhieuTiepNhan = item.ID;
                    hd[i].ID_Xe = item.ID_Xe;
                    hd[i].BienSo = item.BienSo;
                    hd[i].ID_BaoHiem = item.ID_BaoHiem;
                    hd[i].TenBaoHiem = item.TenBaoHiem;
                    hd[i].LienHeBaoHiem = item.NguoiLienHeBH;
                    hd[i].SoDienThoaiLienHeBaoHiem = item.SoDienThoaiLienHeBH;
                    hd[i].MaPhieuTiepNhan = item.MaPhieuTiepNhan.concat('_', item.BienSo);
                    break;
                }
            }
            ChiPhiHD_updateBienSo(item.BienSo);
        }
        else {
            var newHD = newHoaDon(25, '1');
            newHD.ID_PhieuTiepNhan = item.ID;
            newHD.ID_Xe = item.ID_Xe;
            newHD.BienSo = item.BienSo;
            newHD.ID_BaoHiem = item.ID_BaoHiem;
            newHD.TenBaoHiem = item.TenBaoHiem;
            newHD.LienHeBaoHiem = item.NguoiLienHeBH;
            newHD.SoDienThoaiLienHeBaoHiem = item.SoDienThoaiLienHeBH;
            newHD.MaPhieuTiepNhan = item.MaPhieuTiepNhan.concat('_', item.BienSo);
            hd.push(newHD);
        }
        localStorage.setItem(lcListHD, JSON.stringify(hd));

        // update khachhang
        self.Change_KhachHang(item.ID_KhachHang);
        // get list baogia, hoadon of phieutn
        self.Gara_GetListBaoGia(item.ID);
    }

    self.ThongTinPhieuTiepNhan = ko.observable();
    self.HangMucSuaChuas = ko.observableArray();
    self.VatDungKemTheos = ko.observableArray();
    self.BaoDuong_TongPhuTung = ko.observable();
    function GetInfor_PhieuTiepNhan(isView = false) {
        var id = self.HoaDons().ID_PhieuTiepNhan();
        if (!commonStatisJs.CheckNull(id)) {
            $.getJSON(GaraAPI + 'PhieuTiepNhan_GetThongTinChiTiet?id=' + id).done(function (x) {
                if (x.res && x.dataSoure.length > 0) {
                    self.ThongTinPhieuTiepNhan(x.dataSoure[0]);

                    ResetPhieuTiepNhan_ifOtherChiNhanh();
                }

                $.getJSON(GaraAPI + "PhieuTiepNhan_GetTinhTrangXe?id=" + id).done(function (o) {
                    if (o.res) {
                        let hm = o.dataSoure.hangmuc.map(function (item, index) {
                            return {
                                STT: index + 1,
                                TenHangMuc: item.TenHangMuc,
                                TinhTrang: item.TinhTrang,
                                PhuongAnSuaChua: item.PhuongAnSuaChua,
                                Anh: item.Anh,
                            }
                        });

                        let vd = o.dataSoure.vatdung.map(function (item, index) {
                            return {
                                STT: index + 1,
                                TieuDe: item.TieuDe,
                                SoLuong: item.SoLuong,
                                FileDinhKem: item.FileDinhKem,
                            }
                        });
                        self.HangMucSuaChuas(hm);
                        self.VatDungKemTheos(vd);
                    }
                    if (isView) {
                        vmTiepNhanXe.UpdatePhieuTiepNhan(self.ThongTinPhieuTiepNhan(),
                            self.HangMucSuaChuas(), self.VatDungKemTheos());
                    }
                });
                if (!isView) {
                    vmNhatKyBaoDuong.GetListPhuTungBaoDuong_byCar(x.dataSoure[0].ID_Xe, x.dataSoure[0].ID);
                    vmNKGoiBaoDuong.GetGoiDichVu_ofKhachHang(x.dataSoure[0].ID_KhachHang, x.dataSoure[0].ID_Xe);
                }
            })
        }
        else {
            var hd = localStorage.getItem(lcListHD);
            if (hd !== null) {
                hd = JSON.parse(hd);
                var hdOpen = GetHDOpening_byIDRandom(self.HoaDons().IDRandom(), hd);
                if (hdOpen.length > 0) {
                    let idCus = hdOpen[0].ID_DoiTuong;
                    let idCar = hdOpen[0].ID_Xe;
                    if (!commonStatisJs.CheckNull(idCus)) {
                        vmNKGoiBaoDuong.GetGoiDichVu_ofKhachHang(idCus, idCar);
                    }
                }
            }
            self.HangMucSuaChuas([]);
            self.VatDungKemTheos([]);
        }
    }

    self.XemThongTinPhieuTiepNhan = function () {
        GetInfor_PhieuTiepNhan(true);
    }

    self.Change_KhachHang = function (idDoiTuong) {
        self.selectedNCC(idDoiTuong);

        if (_maHoaDon === '') {
            _maHoaDon = $('.gara-bill-label li.active font').text();
        }
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD === null) {
            lstHD = [];
        }
        else {
            lstHD = JSON.parse(lstHD);
        }
        var idRandomHD = '';
        var itemEx = GetHDOpening_byMaHoaDon(_maHoaDon, lstHD);
        if (itemEx.length === 0) {
            // Creat newHoaDon if not exist 
            if (_maHoaDon !== undefined && _maHoaDon.indexOf('Trả') === -1) {
                var newHD = newHoaDon(self.HoaDons().LoaiHoaDon(), 1);
                lstHD.push(newHD);
                idRandomHD = newHD.IDRandom;
                itemEx = [newHD];
            }
        }
        else {
            idRandomHD = itemEx[0].IDRandom;
        }
        var idBangGiaOld = null;
        // update ID_DoiTuong in hd
        for (let i = 0; i < lstHD.length; i++) {
            if (lstHD[i].IDRandom === idRandomHD) {
                if (lstHD[i].ID_DoiTuong !== idDoiTuong) {
                    idBangGiaOld = lstHD[i].ID_BangGia;

                    if (lstHD[i].LoaiHoaDon === 6) {
                        if (idDoiTuong !== null) {
                            if (idDoiTuong.indexOf('KHO') > -1) {
                                ShowMessage_Danger('Trả hàng: Không cho phép chọn khách hàng đang lưu offline');
                                return false;
                            }
                        }
                    }
                    lstHD[i].ID_DoiTuong = idDoiTuong;
                    // update hoadon: change kle --> khach other: reset khachdatra
                    if (!commonStatisJs.CheckNull(lstHD[i].ID) && lstHD[i].ID !== const_GuidEmpty) {
                        lstHD[i].KhachDaTra = 0;
                    }
                }
                break;
            }
        }
        localStorage.setItem(lcListHD, JSON.stringify(lstHD));

        // only reset if hd have cthd
        if (itemEx[0].StatusOffline === false) {
            GetInForCustomer_byID(idDoiTuong);
            BindLstBangGia_byNhanVien_andDoiTuong();

            // set default BangGia
            let arrBGNhom = $.grep(self.GiaBans(), function (x) {
                return x.DM_GiaBan_ApDung !== undefined && x.DM_GiaBan_ApDung.length > 0;
            });
            let nhomAD = [];
            if (arrBGNhom.length > 0) {
                for (let i = 0; i < arrBGNhom.length; i++) {
                    for (let j = 0; j < arrBGNhom[i].DM_GiaBan_ApDung.length; j++) {
                        let gbap = arrBGNhom[i].DM_GiaBan_ApDung[j];
                        // chi get banggia cai dat theo nhom
                        if (gbap.ID_NhomKhachHang !== const_GuidEmpty && self.ChiTietDoiTuong() !== null && self.ChiTietDoiTuong().length > 0
                            && self.ChiTietDoiTuong()[0].ID_NhomDoiTuong.toLowerCase().indexOf(gbap.ID_NhomKhachHang) > -1) {
                            nhomAD.push(arrBGNhom[i]);
                            break;
                        }
                    }
                }
            }

            // ưu tiên áp dụng bảng giá theo nhóm
            if (nhomAD.length === 1 && itemEx[0].LoaiHoaDon !== 6) {
                // update again GiaBan cthd
                if (idDoiTuong !== const_GuidEmpty) {
                    self.ChangeBangGia(nhomAD[0]);
                }
                else {
                    let bgc = {
                        TenGiaBan: 'Bảng giá chuẩn',
                        ID: const_GuidEmpty,
                    };
                    self.ChangeBangGia(bgc);
                }
            }
            else {
                // if KhachLe, check idbanggia old --> reset to bg chuan
                if (!commonStatisJs.CheckNull(idBangGiaOld) && idBangGiaOld !== const_GuidEmpty && idDoiTuong === null) {
                    let exist = $.grep(self.GiaBans(), function (x) {
                        return x.ID === idBangGiaOld;
                    });
                    if (exist.length === 0) {
                        let bgc = {
                            TenGiaBan: 'Bảng giá chuẩn',
                            ID: const_GuidEmpty,
                        };
                        self.ChangeBangGia(bgc);
                    }
                }
                if (itemEx[0].LoaiHoaDon !== 3) {
                    self.KM_KMApDung([]);
                    UpdateKhuyenMai_CTHD(null, idRandomHD);
                    ResetKM_HangHoa_byIDRandomHD(idRandomHD);
                    ResetKM_HoaDon(idRandomHD);
                }
                else {
                    Update_StatusXuLy_ofHDDatHang(idRandomHD);
                }

                UpdateCacheHDLe(idRandomHD, itemEx[0].LoaiHoaDon === 6);
                UpdateGiamGiaHD_ByNhomKH(idRandomHD);
                UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();

                BindHD_byIDRandom(idRandomHD);
                BindCTHD_byIDRandomHD(idRandomHD);
            }
        }
    }

    function GetInforKhachHangFromDB_ByID(id) {
        var date = moment(new Date()).format('YYYY-MM-DD HH:mm');
        if (id !== null) {
            ajaxHelper(DMDoiTuongUri + "GetInforKhachHang_ByID?idDoiTuong=" + id + '&idChiNhanh=' + id_DonVi
                + '&timeStart=' + date + '&timeEnd=' + date + '&wasChotSo=false', 'GET').done(function (data) {
                    if (data !== null) {
                        self.ChiTietDoiTuong(data);
                        GetTienDatCoc(id);
                        GetInfor_PhieuTiepNhan(false);
                        ChangeKhachhang_GetListCar();

                        vmThanhToanGara.GetSoDuTheGiaTri(id);
                    }
                    else {
                        ResetInfor_KhachHang();
                    }
                });
        }
    }

    function GetInForCustomer_byID(id) {
        if (id !== const_GuidEmpty && id !== null) {
            GetInforKhachHangFromDB_ByID(id);
        }
        else {
            ResetInfor_KhachHang();
        }
    }

    function GetAll_IDNhomChild_ofNhomHH(idNhom) {
        var allID = [];
        if (idNhom !== null) {
            tree2.check(tree2.getNodeById(idNhom));//check to do get all child
            allID = tree2.getCheckedNodes();
        }
        return allID;
    }

    self.ChangeBangGia = function (item) {
        var newValue = item.ID;
        self.SetBangGia(newValue);

        var isChangeBG = false;
        var itemHD = [];
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            if (_maHoaDon === '') {
                _maHoaDon = $('.gara-bill-label li.active font').text();
            }

            itemHD = GetHDOpening_byMaHoaDon(_maHoaDon, lstHD);
            if (itemHD.length > 0) {
                let idRandomHD = itemHD[0].IDRandom;
                for (let i = 0; i < lstHD.length; i++) {
                    if (lstHD[i].IDRandom === idRandomHD) {
                        if (lstHD[i].ID_BangGia !== newValue && lstHD[i].StatusOffline === false) {
                            lstHD[i].ID_BangGia = newValue;
                            isChangeBG = true;
                            break;
                        }
                    }
                }
                localStorage.setItem(lcListHD, JSON.stringify(lstHD));

                if (isChangeBG) {
                    ResetKM_HangHoa_byIDRandomHD(idRandomHD);
                    ResetKM_HoaDon(idRandomHD);

                    UpdateGiaBan_inCTHD_byBangGia(lcListCTHD, idRandomHD, itemHD[0].LoaiHoaDon);
                }
            }
        }
        $(event.currentTarget).closest('div').hide();
    }

    // update giaban in cache cthd (todo)
    function UpdateGiaBan_inCTHD_byBangGia(cacheName, idRandomHD, loaiHoaDon) {
        var cthd = localStorage.getItem(cacheName);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
        }
        else {
            cthd = [];
        }
        var arrQuiDoi = cthd.map(function (x) { return x.ID_DonViQuiDoi });
        // get giaban from DB
        var param = {
            ID_ChiNhanh: id_DonVi,
            ID_BangGia: self.selectedGiaBan(),
            LstIDQuiDois: arrQuiDoi,
        };
        ajaxHelper('/api/DanhMuc/DM_HangHoaAPI/Gara_GetListHangHoa_ByIDQuiDoi', 'POST', param).done(function (x) {
            if (x.res) {
                var banggia = x.dataSoure;
                if (banggia.length > 0) {
                    for (let j = 0; j < cthd.length; j++) {
                        if (cthd[j].IDRandomHD === idRandomHD) {
                            for (let m = 0, ml = banggia.length; m < ml; m++) {
                                let itemGB = banggia[m];
                                if (cthd[j].ID_DonViQuiDoi === itemGB.ID_DonViQuiDoi) {
                                    cthd[j].GiaBan = itemGB.GiaBan;
                                    cthd[j].TienChietKhau = 0;
                                    cthd[j].PTChietKhau = 0;
                                    cthd[j].PTThue = 0;
                                    cthd[j].TienThue = 0;
                                    cthd[j].DVTinhGiam = '%';
                                    cthd[j].DonGia = cthd[j].GiaBan;
                                    cthd[j].ThanhTien = cthd[j].GiaBan * cthd[j].SoLuong;
                                    cthd[j].ThanhToan = cthd[j].ThanhTien;

                                    for (let k = 0; k < cthd[j].HangCungLoais.length; k++) {
                                        cthd[j].HangCungLoais[k].GiaBan = itemGB.GiaBan;
                                        cthd[j].HangCungLoais[k].TienChietKhau = 0;
                                        cthd[j].HangCungLoais[k].PTChietKhau = 0;
                                        cthd[j].HangCungLoais[k].PTThue = 0;
                                        cthd[j].HangCungLoais[k].TienThue = 0;
                                        cthd[j].HangCungLoais[k].DVTinhGiam = '%';
                                        cthd[j].HangCungLoais[k].ThanhTien = itemGB.GiaBan * cthd[j].HangCungLoais[k].SoLuong;
                                        cthd[j].HangCungLoais[k].ThanhToan = cthd[j].HangCungLoais[k].ThanhTien;
                                    }
                                    for (let k = 0; k < cthd[j].DM_LoHang.length; k++) {
                                        cthd[j].DM_LoHang[k].GiaBan = itemGB.GiaBan;
                                        cthd[j].DM_LoHang[k].TienChietKhau = 0;
                                        cthd[j].DM_LoHang[k].PTChietKhau = 0;
                                        cthd[j].DM_LoHang[k].PTThue = 0;
                                        cthd[j].DM_LoHang[k].TienThue = 0;
                                        cthd[j].DM_LoHang[k].DVTinhGiam = '%';
                                        cthd[j].DM_LoHang[k].ThanhTien = itemGB.GiaBan * cthd[j].DM_LoHang[k].SoLuong;
                                        cthd[j].DM_LoHang[k].ThanhToan = cthd[j].DM_LoHang[k].ThanhTien;
                                    }

                                    break;
                                }
                            }
                        }
                    }
                }
                localStorage.setItem(cacheName, JSON.stringify(cthd));

                // reset thue, chhanghoa, ckhoadon in cache hd
                var hd = localStorage.getItem(lcListHD);
                if (hd !== null) {
                    hd = JSON.parse(hd);
                    for (let i = 0; i < hd.length; i++) {
                        if (hd[i].IDRandom === idRandomHD) {
                            hd[i].PTChietKhauHH = 0;
                            hd[i].PTThueHoaDon = 0;
                            hd[i].PTThueBaoHiem = 0;
                            hd[i].TongChietKhau = 0;
                            hd[i].TongGiamGia = 0;
                            hd[i].TongTienThueBaoHiem = 0;
                            break;
                        }
                    }
                    localStorage.setItem(lcListHD, JSON.stringify(hd));
                }

                if (loaiHoaDon === 6) {
                    var ctDoiTra = localStorage.getItem(lcListCTHD_DoiTra);
                    if (ctDoiTra !== null) {
                        ctDoiTra = JSON.parse(ctDoiTra);
                        // update thanhtien ctDoiTra
                        for (let j = 0; j < ctDoiTra.length; j++) {
                            if (ctDoiTra[j].IDRandomHD === idRandomHD) {
                                ctDoiTra[j].PTChietKhau = 0;
                                ctDoiTra[j].TienChietKhau = 0;
                                ctDoiTra[j].DVTinhGiam = '%';
                                ctDoiTra[j].DonGia = ctDoiTra[j].GiaBan;
                                ctDoiTra[j].ThanhTien = ctDoiTra[j].GiaBan * ctDoiTra[j].SoLuong;
                                for (let k = 0; k < ctDoiTra[j].DM_LoHang.length; k++) {
                                    ctDoiTra[j].DM_LoHang[k].PTChietKhau = 0;
                                    ctDoiTra[j].DM_LoHang[k].TienChietKhau = 0;
                                    ctDoiTra[j].DM_LoHang[k].DVTinhGiam = '%';
                                    ctDoiTra[j].DM_LoHang[k].DonGia = ctDoiTra[j].GiaBan;
                                    ctDoiTra[j].DM_LoHang[k].ThanhTien = ctDoiTra[j].GiaBan * ctDoiTra[j].DM_LoHang[k].SoLuong;
                                }
                                for (let k = 0; k < ctDoiTra[j].HangCungLoais.length; k++) {
                                    ctDoiTra[j].HangCungLoais[k].PTChietKhau = 0;
                                    ctDoiTra[j].HangCungLoais[k].TienChietKhau = 0;
                                    ctDoiTra[j].HangCungLoais[k].DVTinhGiam = '%';
                                    ctDoiTra[j].HangCungLoais[k].GiaBan = ctDoiTra[j].GiaBan;
                                    ctDoiTra[j].HangCungLoais[k].DonGia = ctDoiTra[j].GiaBan;
                                    ctDoiTra[j].HangCungLoais[k].ThanhTien = ctDoiTra[j].GiaBan * ctDoiTra[j].HangCungLoais[k].SoLuong;
                                }
                            }
                        }
                        localStorage.setItem(lcListCTHD_DoiTra, JSON.stringify(ctDoiTra));

                        // update tongtien trahang
                        var lstHD = JSON.parse(localStorage.getItem(lcListHD));
                        for (let i = 0; i < lstHD.length; i++) {
                            if (lstHD[i].IDRandom === idRandomHD) {
                                lstHD[i].TongGiaGocHangTra = sum;
                                localStorage.setItem(lcListHD, JSON.stringify(lstHD));
                                break;
                            }
                        }
                        UpdateCacheHDLe(idRandomHD, true);
                    }
                }
                else {
                    UpdateCacheHDLe(idRandomHD, false);
                }

                UpdateAllChietKhauNV_inCTHD(idRandomHD, false);
                UpdateGiamGiaHD_ByNhomKH(idRandomHD);
                UpdateChietKhauHD_NhanVien(idRandomHD);
                UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();
                Update_StatusXuLy_ofHDDatHang(idRandomHD);

                BindHD_byIDRandom(idRandomHD);
                BindCTHD_byIDRandomHD(idRandomHD);
            }
        })
    }

    function UpdateAllChietKhauNV_inCTHD(idRandomHD, isDoiTra = false) {
        var nameCache = lcListCTHD;
        if (isDoiTra) {
            nameCache = lcListCTHD_DoiTra;
        }
        var cthd = localStorage.getItem(nameCache);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);

            for (let i = 0; i < cthd.length; i++) {
                let itFor = cthd[i];
                if (itFor.IDRandomHD === idRandomHD) {
                    UpdateChietKhauNV_inCTHD(itFor.IDRandom, isDoiTra, itFor);

                    for (let j = 0; j < itFor.DM_LoHang.length; j++) {
                        let forIn = itFor.DM_LoHang[j];
                        UpdateChietKhauNV_inCTHD(forIn.IDRandom, isDoiTra, forIn);
                    }
                    for (let j = 0; j < itFor.HangCungLoais.length; j++) {
                        let forIn = itFor.HangCungLoais[j];
                        UpdateChietKhauNV_inCTHD(forIn.IDRandom, isDoiTra, forIn);
                    }

                    for (let j = 0; j < itFor.ThanhPhanComBo.length; j++) {
                        let forIn = itFor.ThanhPhanComBo[j];

                        if (forIn.BH_NhanVienThucHien.length > 0) {
                            let tongPhiDV = forIn.TongPhiDichVu;
                            if (forIn.LoaiHoaDon === 19) {
                                tongPhiDV = 0;
                            }

                            let gtriTinh = 0;
                            if (forIn.HoaHongTruocChietKhau === 1) {
                                gtriTinh = forIn.DonGia * forIn.SoLuong;
                            }
                            else {
                                gtriTinh = (forIn.DonGia - forIn.TienChietKhau) * forIn.SoLuong;
                            }
                            gtriTinh = gtriTinh - tongPhiDV;
                            gtriTinh = gtriTinh < 0 ? 0 : gtriTinh;

                            for (let k = 0; k < forIn.BH_NhanVienThucHien.length; k++) {
                                let nvien = forIn.BH_NhanVienThucHien[k];
                                let tienCKNew = nvien.ChietKhauMacDinh * forIn.SoLuong * nvien.HeSo;
                                if (nvien.PT_ChietKhau > 0) {
                                    tienCKNew = gtriTinh * nvien.PT_ChietKhau / 100 * nvien.HeSo;
                                }
                                cthd[i].ThanhPhanComBo[j].BH_NhanVienThucHien[k].TienChietKhau = tienCKNew;
                            }
                            forIn = CTHD_GetGhiChu_NVTuVanTH(forIn);
                        }
                        break;
                    }
                }
            }
        }
    }

    self.ChangeNVienBan = function (item) {
        $('#txtSearchHH').focus();
        var newValue = item.ID;
        self.SetNhanVien(newValue);
        if (_maHoaDon === '') {
            _maHoaDon = $('.gara-bill-label li.active font').text();
        }

        var idRandomHD = '';
        var itemOpen = [];
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD === null) {
            lstHD = [];
        }
        else {
            lstHD = JSON.parse(lstHD);
        }
        var itemEx = GetHDOpening_byMaHoaDon(_maHoaDon, lstHD);
        if (itemEx.length === 0) {
            // Creat newHoaDon if not exist and not HD TraHang
            // _maHoaDon === undefined when delete cacheMaHD
            if (_maHoaDon !== undefined && _maHoaDon.indexOf('Trả') === -1) {
                var newHD = newHoaDon(self.HoaDons().LoaiHoaDon(), 1);
                lstHD.push(newHD);
                idRandomHD = newHD.IDRandom;
            }
        }
        else {
            idRandomHD = itemEx[0].IDRandom;
        }
        for (let i = 0; i < lstHD.length; i++) {
            if (lstHD[i].IDRandom === idRandomHD) {
                if (lstHD[i].ID_NhanVien !== newValue) {
                    lstHD[i].ID_NhanVien = newValue;
                    lstHD[i].TenNhanVien = self.titleNhanvien();
                    itemOpen = lstHD[i];
                }
                break;
            }
        }
        localStorage.setItem(lcListHD, JSON.stringify(lstHD));

        if (itemOpen.StatusOffline === false) {
            BindLstBangGia_byNhanVien_andDoiTuong();
            // check exist ID_BangGia of HD in lst BangGia new
            let itemGB = $.grep(self.GiaBans(), function (item) {
                return item.ID === itemOpen.ID_BangGia;
            });
            if (itemGB.length === 0) {
                // if not exist: reset to BGChuan
                self.ChangeBangGia({ ID: const_GuidEmpty, TenGiaBan: 'Bảng giá chuẩn' });
            }
            else {
                self.KM_KMApDung([]);
                UpdateKhuyenMai_CTHD(null, idRandomHD);
                ResetKM_HangHoa_byIDRandomHD(idRandomHD);
                ResetKM_HoaDon(idRandomHD);
                UpdateCacheHDLe(idRandomHD, false);
                Update_StatusXuLy_ofHDDatHang(idRandomHD);
                UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();
                BindHD_byIDRandom(idRandomHD);
                BindCTHD_byIDRandomHD(idRandomHD);
                HideShow_Icon_ChietKhauNV();
            }
        }

        var $this = $(event.currentTarget);
        $this.closest('.gara-help-user').hide();
        $this.closest('.popup-detail').hide();
    }

    function BindCTHD_byIDRandomHD(idRandomHD) {
        var arr = [];
        var arrDT = [];

        var cthd = localStorage.getItem(lcListCTHD);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            arr = $.grep(cthd, function (x) {
                return x.IDRandomHD === idRandomHD;
            });
            self.HangHoaAfterAdds(arr);
        }
        else {
            self.HangHoaAfterAdds([]);
        }

        var cthdDT = localStorage.getItem(lcListCTHD_DoiTra);
        if (cthdDT !== null) {
            cthdDT = JSON.parse(cthdDT);
            arrDT = $.grep(cthdDT, function (x) {
                return x.IDRandomHD === idRandomHD;
            });
            self.NewProducts(arrDT);
        }
        else {
            self.NewProducts([]);
        }

        if (self.ThietLap().KhuyenMai) {
            // get lst product KM of HoaDon
            var lstKM_HD = localStorage.getItem(lcProductKM_HoaDon);
            if (lstKM_HD !== null) {
                lstKM_HD = JSON.parse(lstKM_HD);
                var arrProduct = $.grep(lstKM_HD, function (x) {
                    return x.IDRandomHD === idRandomHD;
                });
                self.HHTang_HoaDon(arrProduct);
            }
            else {
                self.HHTang_HoaDon([]);
            }
        }
        else {
            self.HHTang_HoaDon([]);
        }
    }

    function GetDataChotSo() {
        // to do check NgayLapHD
        ajaxHelper('/api/DanhMuc/HT_ThietLapAPI/GetDataChotSo?idChiNhanh=' + id_DonVi, 'GET').done(function (data) {
            if (data !== null && data.length > 0) {
                self.ChotSo_ChiNhanh(data);
                vmThanhToan.ThietLapChotSo = data;
            }
        })
    }
    function CheckNgayLapHD(ddMMyyyyHHmmss) {
        var dateNow = moment(new Date()).format('YYYY-MM-DD HH:mm');
        var ngaylapHD = GetNgayLapHD_whenSave(ddMMyyyyHHmmss);
        if (ngaylapHD === '') {
            ShowMessage_Danger('Vui lòng nhập ngày lập hóa đơn');

            $('#datepicker').datetimepicker(
                {
                    format: "d/m/Y",
                    defaultDate: new Date(),
                    mask: true,
                    maxDate: new Date(),
                    timepicker: false,
                });
            return false;
        }
        if (ngaylapHD.indexOf('_') > -1) {
            ShowMessage_Danger('Ngày lập hóa đơn chưa đúng định dạng');
            return false;
        }
        if (ngaylapHD > dateNow) {
            ShowMessage_Danger('Ngày lập hóa đơn  vượt quá thời gian hiện tại');
            return false;
        }
        if (self.ThietLap().KhoaSo && self.ChotSo_ChiNhanh().length > 0) {
            let dtChotSo = moment(self.ChotSo_ChiNhanh()[0].NgayChotSo).format('YYYY-MM-DD');
            if (moment(ngaylapHD, 'YYYY-MM-DD HH:mm').format('YYYY-MM-DD') <= dtChotSo) {
                ShowMessage_Danger("Ngày lập hóa đơn" + ' phải sau thời gian chốt sổ ' + moment(dtChotSo, 'YYYY-MM-DD').format('DD/MM/YYYY'));
                return false;
            }
        }
        return true;
    }
    $('#datepicker').keypress(function (e) {
        if (e.keyCode === 13) {
            var valDate = $(this).val();
            if (valDate.substr(6, 4) === '____') {
                valDate = valDate.substr(0, 6).concat(now.getFullYear());
                $('#datepicker').val(valDate);
                $('.xdsoft_datetimepicker').css('display', 'none');
            }
            self.ChangeNgayLapHD();
        }
    })
    $('#timepicker').keypress(function (e) {
        if (e.keyCode === 13) {
            self.ChangeNgayLapHD();
        }
    })
    self.ChangeNgayLapHD = function () {
        var datepicker = $('#datepicker').val();
        var timepicker = $('#timepicker').val();
        var dtpicker = datepicker + ' ' + timepicker;
        if (commonStatisJs.CheckNull(datepicker) || commonStatisJs.CheckNull(timepicker)) {
            ShowMessage_Danger('Ngày lập hóa đơn không đúng định dạng');
            return false;
        }
        var check = CheckNgayLapHD(dtpicker);
        if (!check) {
            return;
        }
        // get seconds now (because datetime only return YYYY-MM-DD HH:mm)
        var seconds = (new Date()).getSeconds();
        var dtchange = moment(dtpicker, 'DD/MM/YYYY HH:mm').format('YYYY-MM-DD HH:mm');

        if (_maHoaDon === '') {
            _maHoaDon = $('.gara-bill-label li.active font').text();
        }
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
        }
        else {
            lstHD = [];
        }
        var idRandomHD = '';
        // if not exist --> add new
        //if (lstHD.length === 0) {
        //    var newHD = newHoaDon(_maHoaDon);
        //    lstHD.push(newHD);
        //    idRandomHD = newHD.IDRandom;
        //}
        // find hd by mahoadon cuurent
        let hdFind = GetHDOpening_byMaHoaDon(_maHoaDon, lstHD);
        if (hdFind.length === 0) {
            var newHD = newHoaDon(self.HoaDons().LoaiHoaDon(), 1);
            lstHD.push(newHD);
            idRandomHD = newHD.IDRandom;
        }
        for (let i = 0; i < lstHD.length; i++) {
            if (lstHD[i].MaHoaDon === _maHoaDon && (lstHD[i].NguoiTao === userLogin || lstHD[i].TrangThaiHD === 3)) {
                // TraHang: khong cho nhap NgayTra < NgayMua
                if (lstHD[i].LoaiHoaDon === 6 && lstHD[i].ID_HoaDon !== null) {
                    var dtOld = moment(lstHD[i].NgayLapHD_ofHDGoc).format('YYYY-MM-DD HH:mm');
                    var dtNew = moment(dtchange).format('YYYY-MM-DD HH:mm');
                    if (dtNew < dtOld) {
                        ShowMessage_Danger('Ngày trả hàng phải sau ngày mua hàng');
                        return false;
                    }
                }
                lstHD[i].NgayLapHoaDon = dtchange;
                idRandomHD = lstHD[i].IDRandom;
                break;
            }
        }
        localStorage.setItem(lcListHD, JSON.stringify(lstHD));
        // assign again self.NgayLapHoaDon
        self.DateHDDefault(datepicker);
        self.TimeHDDefault(timepicker);
        stopTimer();
        // caculator SoSuHienTai by Time if ID_DoiTuong !=null (todo)
        // update ThoiGian in all CTHD with thisHD
        // get date from new Day
        dtchange = moment(dtchange, 'YYYY-MM-DD HH:mm').format('YYYY-MM-DD');
        var cthd = localStorage.getItem(lcListCTHD);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            for (let i = 0; i < cthd.length; i++) {
                if (cthd[i].IDRandomHD === idRandomHD) {
                    var time = cthd[i].ThoiGian.split(' ')[1];
                    var tgNew = dtchange.concat(' ', time);
                    cthd[i].ThoiGian = tgNew;
                    if (cthd[i].QuanLyTheoLoHang) {
                        for (let j = 0; j < cthd[i].DM_LoHang.length; j++) {
                            cthd[i].DM_LoHang[j].ThoiGian = tgNew;
                        }
                    }
                }
            }
            localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
        }

        // vi bang gia ap dung theo thu trong tuan
        BindLstBangGia_byNhanVien_andDoiTuong();
    }
    // ghi chu HD 
    self.editNote = function () {
        var hd = localStorage.getItem(lcListHD);
        if (hd !== null) {
            hd = JSON.parse(hd);
            for (let i = 0; i < hd.length; i++) {
                if (hd[i].IDRandom === self.HoaDons().IDRandom()) {
                    hd[i].DienGiai = $(event.currentTarget).val();
                    break;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(hd));
        }
    };
    // ghi chu HD 
    self.editGhiChuChiPhi = function () {
        var hd = localStorage.getItem(lcListHD);
        if (hd !== null) {
            hd = JSON.parse(hd);
            for (let i = 0; i < hd.length; i++) {
                if (hd[i].IDRandom === self.HoaDons().IDRandom()) {
                    hd[i].ChiPhi_GhiChu = $(event.currentTarget).val();
                    break;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(hd));
        }
    };
    // hd other user: update ghichu
    self.popup_editGhiChuHD = function () {
        var idRandomHD = self.Modal_HoaDons().IDRandom;
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            // update note HD
            for (let i = 0; i < lstHD.length; i++) {
                if (lstHD[i].IDRandom === idRandomHD) {
                    lstHD[i].DienGiai = $('#txtpop_NoteHD').val();
                    break;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(lstHD));
        }
    }
    self.UpdateCTHD_GhiChu = function (item, isDoiTra) {
        var idRandom = item.IDRandom;
        var quanlyTheoLo = item.QuanLyTheoLoHang;
        var ghichu = $(event.currentTarget).val();
        var concungloai = item.LaConCungLoai;
        var nameCache = lcListCTHD;
        if (isDoiTra) {
            nameCache = lcListCTHD_DoiTra;
        }
        var lcCTHD = localStorage.getItem(nameCache);
        if (lcCTHD !== null) {
            lcCTHD = JSON.parse(lcCTHD);
            if (item.LotParent || (concungloai === false && quanlyTheoLo === false)) {
                for (let i = 0; i < lcCTHD.length; i++) {
                    if (lcCTHD[i].IDRandom === idRandom) {
                        lcCTHD[i].GhiChu = ghichu;
                        break;
                    }
                }
            }
            else {
                if (quanlyTheoLo) {
                    for (let i = 0; i < lcCTHD.length; i++) {
                        for (let j = 0; j < lcCTHD[i].DM_LoHang.length; j++) {
                            if (lcCTHD[i].DM_LoHang[j].IDRandom === idRandom) {
                                lcCTHD[i].DM_LoHang[j].GhiChu = ghichu;
                                i = lcCTHD.length;  // esc for loop
                                break;
                            }
                        }
                    }
                }
                else {
                    for (let i = 0; i < lcCTHD.length; i++) {
                        for (let j = 0; j < lcCTHD[i].HangCungLoais.length; j++) {
                            if (lcCTHD[i].HangCungLoais[j].IDRandom === idRandom) {
                                lcCTHD[i].HangCungLoais[j].GhiChu = ghichu;
                                i = lcCTHD.length;
                                break;
                            }
                        }
                    }
                }
            }
            localStorage.setItem(nameCache, JSON.stringify(lcCTHD));
        }
    }
    self.editSoLuong_NhapThuong = function () {
        var $this = $(event.currentTarget);
        formatNumberObj($this);

        var valThis = formatNumberToFloat($this.val());
        var keyCode = event.keyCode || event.which;
        if (keyCode === 13) {
            if (self.ItemHH_LoChosing().ID_DonViQuiDoi === undefined) {
                ShowMessage_Danger('Vui lòng chọn hàng hóa');
                return;
            }
            if (valThis === 0) {
                ShowMessage_Danger('Vui lòng nhập số lượng cho hàng hóa');
                return;
            }
            self.Click_ChoseHangLo(self.ItemHH_LoChosing(), 2);
        }
    }
    function CheckHoaDonOffline_byMaHoaDon() {
        var maHoaDon = self.HoaDons().MaHoaDon();
        if (maHoaDon.indexOf('Copy') === -1 && maHoaDon.indexOf('O') >= 0) {
            ShowMessage_Danger('Hóa đơn đã được thanh toán offline. Không thể thay đổi thông tin');
            return false;
        }
    }
    self.editDonGia_NhapThuong = function () {
        var $this = $(event.currentTarget);
        formatNumberObj($this);
        var keycode = event.keyCode || event.which;
        if (keycode === 13) {
            var product = self.ItemHH_LoChosing();
            self.Click_ChoseHangLo(product, 3);
        }
    }
    self.SortProduct = function () {
        self.HangHoaAfterAdds.reverse();
    }
    self.myFilter = function (item, inputString) {
        var itemSearch = locdau(item.TenDoiTuong);
        var itemSearch2 = item.MaDoiTuong.toLowerCase();
        var iteSearch4 = item.DienThoai === null ? '' : item.DienThoai;
        var locdauInput = locdau(inputString);
        // nen bat chat khong cho nhap dau cach o MaKH
        var arr = itemSearch.split(/\s+/);
        var sThreechars = '';
        for (let i = 0; i < arr.length; i++) {
            sThreechars += arr[i].toString().split('')[0];
        }
        return itemSearch.indexOf(locdauInput) > -1 || itemSearch2.indexOf(locdauInput) > -1 ||
            sThreechars.indexOf(locdauInput) > -1 || (iteSearch4 !== null && iteSearch4.indexOf(locdauInput) > -1);
    }
    self.filterHH = function (item, inputString) {
        var itemSearch = locdau(item.TenHangHoa);
        var itemSearch2 = item.MaHangHoa.toLowerCase();
        var itemSearch3 = item.GiaBan.toString();
        var locdauInput = locdau(inputString);
        var arr = itemSearch.split(/\s+/);
        var sThreechars = '';
        // for loop faster
        var i = 0;
        var lengthArr = arr.length;
        for (i; i < lengthArr; i++) {
            sThreechars += arr[i].toString().split('')[0];
        }
        $('#txtSearchHH').focus();
        return itemSearch.indexOf(locdauInput) > -1 || itemSearch2.indexOf(locdauInput) > -1 || itemSearch3.indexOf(locdauInput) > -1 ||
            sThreechars.indexOf(locdauInput) > -1;
    }
    function UpdateWarning_forCTHD_byIDQuiDoi(idQuiDoi, idRandomHD) {
        var loaiHD = GetLoaiHoaDon_ofHDopening();
        var cthd = localStorage.getItem(lcListCTHD);
        var cthd_DoiTra = localStorage.getItem(lcListCTHD_DoiTra);

        if (cthd !== null) {
            cthd = JSON.parse(cthd);
        }
        else {
            cthd = [];
        }

        if (cthd_DoiTra !== null) {
            cthd_DoiTra = JSON.parse(cthd_DoiTra);
        }
        else {
            cthd_DoiTra = [];
        }

        let xuatAm = true;
        switch (loaiHD) {
            case 1:
            case 3:
                if (loaiHD === 1) {
                    xuatAm = self.ThietLap().XuatAm;
                }
                else {
                    xuatAm = self.ThietLap().DatHangXuatAm;
                }
                for (let i = 0; i < cthd.length; i++) {
                    if (cthd[i].IDRandomHD === idRandomHD && cthd[i].ID_DonViQuiDoi === idQuiDoi) {
                        if (cthd[i].QuanLyTheoLoHang === false) {
                            if (cthd[i].LaHangHoa) {
                                cthd[i].CssWarning = !xuatAm && (cthd[i].SoLuong > cthd[i].TonKho);
                                for (let j = 0; j < cthd[i].HangCungLoais.length; j++) {
                                    cthd[i].HangCungLoais[j].CssWarning = !xuatAm && (cthd[i].HangCungLoais[j].SoLuong > cthd[i].HangCungLoais[j].TonKho);
                                }
                            }
                        }
                        else {
                            if (cthd[i].LaHangHoa) {
                                cthd[i].CssWarning = !xuatAm && (cthd[i].SoLuong > cthd[i].TonKho);
                                for (let j = 1; j < cthd[i].DM_LoHang.length; j++) {
                                    cthd[i].DM_LoHang[j].CssWarning = !xuatAm && (cthd[i].DM_LoHang[j].SoLuong > cthd[i].DM_LoHang[j].TonKho);
                                }
                            }
                        }
                        break;
                    }
                }
                break;
            case 6:
                // waring in cthd Tra
                for (let i = 0; i < cthd.length; i++) {
                    if (cthd[i].IDRandomHD === idRandomHD && cthd[i].ID_DonViQuiDoi === idQuiDoi) {
                        cthd[i].CssWarning = (parseFloat(cthd[i].SoLuong) === 0);
                        for (let j = 0; j < cthd[i].DM_LoHang.length; j++) {
                            cthd[i].DM_LoHang[j].CssWarning = (parseFloat(cthd[i].DM_LoHang[j].SoLuong) === 0);
                        }
                        for (let j = 0; j < cthd[i].HangCungLoais.length; j++) {
                            cthd[i].HangCungLoais[j].CssWarning = (parseFloat(cthd[i].HangCungLoais[j].SoLuong) === 0);
                        }
                        break;
                    }
                }
                // waring in cthDoiTra
                if (self.ThietLap().XuatAm) {
                    for (let i = 0; i < cthd_DoiTra.length; i++) {
                        if (cthd_DoiTra[i].IDRandomHD === idRandomHD && cthd_DoiTra[i].ID_DonViQuiDoi === idQuiDoi) {
                            if (cthd_DoiTra[i].QuanLyTheoLoHang === false) {
                                if (cthd_DoiTra[i].LaHangHoa) {
                                    cthd_DoiTra[i].CssWarning = (cthd_DoiTra[i].SoLuong > cthd_DoiTra[i].TonKho);
                                    for (let j = 0; j < cthd_DoiTra[i].HangCungLoais.length; j++) {
                                        cthd_DoiTra[i].HangCungLoais[j].CssWarning = (cthd_DoiTra[i].HangCungLoais[j].SoLuong > cthd_DoiTra[i].HangCungLoais[j].TonKho);
                                    }
                                }
                            }
                            else {
                                if (cthd_DoiTra[i].LaHangHoa) {
                                    cthd_DoiTra[i].CssWarning = (cthd_DoiTra[i].SoLuong > cthd_DoiTra[i].TonKho);
                                    for (let j = 1; j < cthd_DoiTra[i].DM_LoHang.length; j++) {
                                        cthd_DoiTra[i].DM_LoHang[j].CssWarning = (cthd_DoiTra[i].DM_LoHang[j].SoLuong > cthd_DoiTra[i].DM_LoHang[j].TonKho);
                                    }
                                }
                            }
                            break;
                        }
                    }
                }
                break;
        }
        localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
        localStorage.getItem(lcListCTHD_DoiTra, JSON.stringify(cthd_DoiTra));
    }
    // use when edit SoLuong
    function ShowHideWarning_forCTHD_byIDQuiDoi(idRandomHD, idQuiDoi, idRandom) {
        var loaiHD = GetLoaiHoaDon_ofHDopening();
        var cthd = localStorage.getItem(lcListCTHD);
        var cthd_DoiTra = localStorage.getItem(lcListCTHD_DoiTra);
        var itemOpening = [];
        var showWarning = false;
        if (loaiHD === 3 || loaiHD === 1 || cthd_DoiTra === null) {
            if (cthd !== null) {
                cthd = JSON.parse(cthd);
                for (let i = 0; i < cthd.length; i++) {
                    if (cthd[i].ID_DonViQuiDoi === idQuiDoi && cthd[i].IDRandomHD === idRandomHD) {
                        if (cthd[i].QuanLyTheoLoHang === false) {
                            if (cthd[i].IDRandom === idRandom) {
                                showWarning = cthd[i].CssWarning;
                            }
                            else {
                                for (let j = 0; j < cthd[i].HangCungLoais.length; j++) {
                                    if (cthd[i].HangCungLoais[j].IDRandom === idRandom) {
                                        showWarning = cthd[i].HangCungLoais[j].CssWarning;
                                        break;
                                    }
                                }
                            }
                        }
                        else {
                            for (let j = 0; j < cthd[i].DM_LoHang.length; j++) {
                                if (cthd[i].DM_LoHang[j].IDRandom === idRandom) {
                                    if (cthd[i].DM_LoHang[j].LotParent) {
                                        showWarning = cthd[i].CssWarning;
                                    }
                                    else {
                                        showWarning = cthd[i].DM_LoHang[j].CssWarning;
                                    }
                                    break;
                                }
                            }
                        }
                        break;
                    }
                }
                if (showWarning) {
                    $('#show_wr_' + idRandom).css('display', '');
                }
                else {
                    $('#show_wr_' + idRandom).css('display', 'none');
                }
            }
        }
        else {
            // loai 6
            if (cthd_DoiTra !== null) {
                cthd_DoiTra = JSON.parse(cthd_DoiTra);
                for (let i = 0; i < cthd_DoiTra.length; i++) {
                    if (cthd_DoiTra[i].IDRandomHD === idRandomHD && cthd_DoiTra[i].ID_DonViQuiDoi === idQuiDoi) {
                        if (cthd_DoiTra[i].QuanLyTheoLoHang === false) {
                            if (cthd_DoiTra[i].IDRandom === idRandom) {
                                showWarning = cthd_DoiTra[i].CssWarning;
                            }
                            else {
                                for (let j = 0; j < cthd_DoiTra[i].HangCungLoais.length; j++) {
                                    if (cthd_DoiTra[i].HangCungLoais[j].IDRandom === idRandom) {
                                        showWarning = cthd_DoiTra[i].HangCungLoais[j].CssWarning;
                                        break;
                                    }
                                }
                            }
                        }
                        else {
                            for (let j = 0; j < cthd_DoiTra[i].DM_LoHang.length; j++) {
                                if (cthd_DoiTra[i].DM_LoHang[j].IDRandom === idRandom) {
                                    if (cthd_DoiTra[i].DM_LoHang[j].LotParent) {
                                        showWarning = cthd_DoiTra[i].CssWarning;
                                    }
                                    else {
                                        showWarning = cthd_DoiTra[i].DM_LoHang[j].CssWarning;
                                    }
                                    break;
                                }
                            }
                        }
                        break;
                    }
                }
                if (showWarning) {
                    $('#show_wrDT_' + idRandom).css('display', '');
                }
                else {
                    $('#show_wrDT_' + idRandom).css('display', 'none');
                }
            }
            // hide warning CTHD Tra if SoLuong !=0
            if (cthd !== null) {
                cthd = JSON.parse(cthd);
                for (let i = 0; i < cthd.length; i++) {
                    if (cthd[i].ID_DonViQuiDoi === idQuiDoi && cthd[i].IDRandomHD === idRandomHD) {
                        for (let j = 0; j < cthd[i].DM_LoHang.length; j++) {
                            if (cthd[i].DM_LoHang[j].IDRandom === idRandom) {
                                if (cthd[i].DM_LoHang[j].LotParent) {
                                    showWarning = cthd[i].CssWarning;
                                }
                                else {
                                    showWarning = cthd[i].DM_LoHang[j].CssWarning;
                                }
                                break;
                            }
                        }
                        break;
                    }
                }
                if (showWarning) {
                    $('#show_wr_' + idRandom).css('display', '');
                }
                else {
                    $('#show_wr_' + idRandom).css('display', 'none');
                }
            }
        }
    }

    // chi reset HH same ID_nhom or same ID_QuiDoi
    function ResetKM_HangHoa(idQuiDoi, idNhomHH, idRandomHD) {
        self.HH_KhuyenMai(undefined);
        var ctHD = [];
        var cthd = localStorage.getItem(lcListCTHD);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            // reset KhuyenMai of HangHoa & bind again
            for (let i = 0; i < cthd.length; i++) {
                if (cthd[i].IDRandomHD === idRandomHD) {
                    // only reset GiamGia if is opening KMai
                    if (cthd[i].IsOpeningKMai) {
                        // reset if same ID_nhomHH or same ID_QuiDoi
                        if (cthd[i].ID_DonViQuiDoi === idQuiDoi || cthd[i].ID_NhomHangHoa === idNhomHH) {
                            cthd[i].HangHoa_KM = [];
                            cthd[i].TenKhuyenMai = '';
                            // reset giamgia = 0
                            cthd[i].PTChietKhau = 0;
                            cthd[i].TienChietKhau = 0;
                            cthd[i].DVTinhGiam = '%';
                            cthd[i].IsOpeningKMai = false;
                            cthd[i].ID_KhuyenMai = null;
                            cthd[i].DiemKhuyenMai = 0;
                            // not update GiaBan, only update again TienChietKhau = 0
                            cthd[i].ThanhTien = cthd[i].GiaBan * cthd[i].SoLuong;
                            for (let k = 0; k < cthd[i].DM_LoHang.length; k++) {
                                cthd[i].DM_LoHang[k].PTChietKhau = 0;
                                cthd[i].DM_LoHang[k].TienChietKhau = 0;
                                cthd[i].DM_LoHang[k].DVTinhGiam = '%';
                                cthd[i].DM_LoHang[k].ThanhTien = cthd[i].DM_LoHang[k].GiaBan * cthd[i].DM_LoHang[k].SoLuong;
                            }
                            for (let k = 0; k < cthd[i].HangCungLoais.length; k++) {
                                cthd[i].HangCungLoais[k].PTChietKhau = 0;
                                cthd[i].HangCungLoais[k].TienChietKhau = 0;
                                cthd[i].HangCungLoais[k].DVTinhGiam = '%';
                                cthd[i].HangCungLoais[k].ThanhTien = cthd[i].HangCungLoais[k].GiaBan * cthd[i].HangCungLoais[k].SoLuong;
                            }
                        }
                    }
                    ctHD.push(cthd[i]);
                }
            }
            localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
        }
    }
    // use editSoLuong, editPrice, editSale
    // chi reset HH same ID_nhom or same ID_QuiDoi
    function ResetKM_HangHoa_ByIDQuiDoi_orNhomHang(idQuiDoi, idNhomHH, idRandomHD) {
        self.HH_KhuyenMai(undefined);
        var cthd = localStorage.getItem(lcListCTHD);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            // reset KhuyenMai of HangHoa & bind again
            for (let i = 0; i < cthd.length; i++) {
                if (cthd[i].IDRandomHD === idRandomHD) {
                    if (cthd[i].IsOpeningKMai) {
                        // reset if same ID_nhomHH or same ID_QuiDoi
                        if (cthd[i].ID_DonViQuiDoi === idQuiDoi || cthd[i].ID_NhomHangHoa === idNhomHH) {
                            cthd[i].HangHoa_KM = [];
                            cthd[i].TenKhuyenMai = '';
                            // reset giamgia = 0
                            cthd[i].PTChietKhau = 0;
                            cthd[i].TienChietKhau = 0;
                            cthd[i].DVTinhGiam = '%';
                            cthd[i].ID_KhuyenMai = null;
                            cthd[i].IsOpeningKMai = false;
                            cthd[i].DiemKhuyenMai = 0;
                            // not update GiaBan, only update again TienChietKhau = 0
                            cthd[i].ThanhTien = cthd[i].GiaBan * cthd[i].SoLuong;
                            for (let k = 0; k < cthd[i].DM_LoHang.length; k++) {
                                cthd[i].DM_LoHang[k].PTChietKhau = 0;
                                cthd[i].DM_LoHang[k].TienChietKhau = 0;
                                cthd[i].DM_LoHang[k].DVTinhGiam = '%';
                                cthd[i].DM_LoHang[k].ThanhTien = cthd[i].DM_LoHang[k].GiaBan * cthd[i].DM_LoHang[k].SoLuong;
                            }
                            for (let k = 0; k < cthd[i].HangCungLoais.length; k++) {
                                cthd[i].HangCungLoais[k].PTChietKhau = 0;
                                cthd[i].HangCungLoais[k].TienChietKhau = 0;
                                cthd[i].HangCungLoais[k].DVTinhGiam = '%';
                                cthd[i].HangCungLoais[k].ThanhTien = cthd[i].HangCungLoais[k].GiaBan * cthd[i].HangCungLoais[k].SoLuong;
                            }
                        }
                    }
                }
            }
            localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
        }
    }
    // use when change NCC, BangGia, NVien
    function ResetKM_HangHoa_byIDRandomHD(idRandomHD) {
        self.HH_KhuyenMai(undefined);
        var ctHD = [];
        var cthd = localStorage.getItem(lcListCTHD);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            // reset GiamGia, ThanhTien
            for (let i = 0; i < cthd.length; i++) {
                if (cthd[i].IDRandomHD === idRandomHD) {
                    if (cthd[i].IsOpeningKMai) {
                        cthd[i].HangHoa_KM = [];
                        cthd[i].TenKhuyenMai = '';
                        // reset giamgia = 0
                        cthd[i].PTChietKhau = 0;
                        cthd[i].TienChietKhau = 0;
                        cthd[i].DVTinhGiam = '%';
                        cthd[i].IsOpeningKMai = false;
                        cthd[i].ID_KhuyenMai = null;
                        cthd[i].DiemKhuyenMai = 0;
                        cthd[i].ThanhTien = cthd[i].GiaBan * cthd[i].SoLuong;
                        for (let k = 0; k < cthd[i].DM_LoHang.length; k++) {
                            cthd[i].DM_LoHang[k].PTChietKhau = 0;
                            cthd[i].DM_LoHang[k].TienChietKhau = 0;
                            cthd[i].DM_LoHang[k].DVTinhGiam = '%';
                            cthd[i].DM_LoHang[k].ThanhTien = cthd[i].DM_LoHang[k].GiaBan * cthd[i].DM_LoHang[k].SoLuong;
                        }
                        for (let k = 0; k < cthd[i].HangCungLoais.length; k++) {
                            cthd[i].HangCungLoais[k].PTChietKhau = 0;
                            cthd[i].HangCungLoais[k].TienChietKhau = 0;
                            cthd[i].HangCungLoais[k].DVTinhGiam = '%';
                            cthd[i].HangCungLoais[k].ThanhTien =cthd[i].HangCungLoais[k].GiaBan * cthd[i].HangCungLoais[k].SoLuong;
                        }
                    }
                }
            }
            localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
        }
    }

    function ResetKM_HoaDon(idRandomHD) {
        // reset HD_KhuyenMai --> not chose radio
        self.HD_KhuyenMai(undefined);
        // delete productKM_HoaDon && bind again HHTang_HoaDon
        var lstProductKM_HD = localStorage.getItem(lcProductKM_HoaDon);
        if (lstProductKM_HD !== null) {
            lstProductKM_HD = JSON.parse(lstProductKM_HD);
            lstProductKM_HD = $.grep(lstProductKM_HD, function (x) {
                return x.IDRandomHD !== idRandomHD;
            });
            localStorage.setItem(lcProductKM_HoaDon, JSON.stringify(lstProductKM_HD));
            self.HHTang_HoaDon([]);
        }
        // reset gg KM of HoaDon
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            for (let i = 0; i < lstHD.length; i++) {
                // neu dang mo KM hoadon
                if (lstHD[i].IDRandom === idRandomHD) {
                    lstHD[i].ID_KhuyenMai = null;
                    lstHD[i].PTGiam_KM = 0;
                    lstHD[i].DiemCong = 0;
                    lstHD[i].KhuyeMai_GiamGia = 0;
                    lstHD[i].TongGiamGiaKM_HD = lstHD[i].TongGiamGia;
                    lstHD[i].IsOpeningKMaiHD = false;
                    lstHD[i].DiemKhuyenMai = 0;
                    break;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(lstHD));
        }
    }

    function UpdateNhomKH_DB(idDoiTuong) {
        var lstNhom = $.map(self.NhomDoiTuongChosed(), function (x) { return x.ID });
        if (lstNhom.length > 0) {
            var lst = [];
            for (let i = 0; i < lstNhom.length; i++) {
                let obj = {
                    ID_DoiTuong: idDoiTuong,
                    ID_NhomDoiTuong: lstNhom[i],
                }
                lst.push(obj);
            }
            console.log(lst);
            var myData = {
                lstDM_DoiTuong_Nhom: lst,
            };
            ajaxHelper(DMDoiTuongUri + 'PutDM_DoiTuong_Nhom', 'PUT', myData).done(function () {

            })
        }
        else {
            // delete all nhom of DoiTuon in DB
            ajaxHelper(DMDoiTuongUri + 'DeleteAllNhom_ofDoiTuong?idDoiTuong=' + idDoiTuong, 'PUT').done(function (x) {
            })
        }
    }

    function UpdateDiemKH_toDB() {
        var itemDT = self.ChiTietDoiTuong();
        if (itemDT.length > 0) {
            var DM_DoiTuong = {
                ID: itemDT[0].ID,
                TongTichDiem: itemDT[0].TongTichDiem - vmThanhToanGara.PhieuThuKhach.DiemQuyDoi,
            }
            var myData = {};
            myData.objDoiTuong = DM_DoiTuong;
            ajaxHelper(DMDoiTuongUri + 'UpdateDiem_DMDoiTuong', 'POST', myData).done(function (err) {
                if (err !== '') {
                    ShowMessage_Danger(err);
                }
            });
        }
    }

    // neu KH oline, but update offline --> when save HD, update both infor KH
    function UpdateInforKH_toDB(idDoiTuong) {
        if (idDoiTuong !== null) {
            // check exist in cache lst ID_DoiTuong
            var lstID_DoiTuong = localStorage.getItem('lcID_DoiTuongOnline');
            if (lstID_DoiTuong !== null) {
                lstID_DoiTuong = JSON.parse(lstID_DoiTuong);
                if ($.inArray(idDoiTuong, lstID_DoiTuong) > -1) {
                    var itemDT = self.ChiTietDoiTuong();
                    if (itemDT.length > 0) {
                        var DM_DoiTuong = {
                            ID: idDoiTuong,
                            MaDoiTuong: itemDT[0].MaDoiTuong,
                            TenDoiTuong: itemDT[0].TenDoiTuong,
                            DienThoai: itemDT[0].DienThoai,
                            Email: itemDT[0].Email,
                            DiaChi: itemDT[0].DiaChi,
                            GioiTinhNam: itemDT[0].GioiTinhNam,
                            NgaySinh_NgayTLap: itemDT[0].NgaySinh_NgayTLap,
                            MaSoThue: itemDT[0].MaSoThue,
                            LoaiDoiTuong: 1,
                            GhiChu: itemDT[0].GhiChu,
                            ID_NguonKhach: itemDT[0].ID_NguonKhach,
                            ID_NguoiGioiThieu: itemDT[0].ID_NguoiGioiThieu,
                            ID_NhanVienPhuTrach: itemDT[0].ID_NhanVienPhuTrach,
                            LaCaNhan: itemDT[0].LaCaNhan,
                            ID_TinhThanh: itemDT[0].ID_TinhThanh,
                            ID_QuanHuyen: itemDT[0].ID_QuanHuyen,
                            ID_DonVi: id_DonVi,
                            NguoiTao: userLogin, // user dang nhap
                            TenDoiTuong_KhongDau: itemDT[0].TenDoiTuong_KhongDau,
                            TenDoiTuong_ChuCaiDau: itemDT[0].TenDoiTuong_ChuCaiDau,
                            DinhDang_NgaySinh: itemDT[0].DinhDang_NgaySinh,
                        };
                        var myData = {};
                        myData.id = idDoiTuong;
                        myData.objDoiTuong = DM_DoiTuong;
                        $.ajax({
                            url: DMDoiTuongUri + "PutDM_DoiTuong",
                            type: 'PUT',
                            dataType: 'json',
                            contentType: "application/x-www-form-urlencoded; charset=UTF-8",
                            data: myData,
                            success: function (item) {
                                // delete ID in cache
                                lstID_DoiTuong = $.grep(lstID_DoiTuong, function (x) {
                                    return x !== idDoiTuong;
                                });
                                localStorage.setItem('lcID_DoiTuongOnline', JSON.stringify(lstID_DoiTuong));
                            },
                            complete: function () {
                            }
                        })
                    }
                }
            }
        }
    }
    // Update SoLanMua by ID_QuiDoi of KhachHang
    function Update_SoLanMua_byIDQuiDoi(objHD, objCTHD, isTraHang) {
        // tra -, mua +
        if (objHD.ID_DoiTuong !== null) {
            var khHH = self.KhachHang_HangHoa().filter(x => x.ID_DoiTuong === objHD.ID_DoiTuong);
            if (khHH.length > 0) {
                var arrID_QuiDoiEx = [];
                // get all IDQuiDoi exist
                for (let i = 0; i < khHH[0].List_SoLuongMua.length; i++) {
                    arrID_QuiDoiEx.push(khHH[0].List_SoLuongMua[i].ID_DonViQuiDoi);
                }
                var arrNew = [];
                for (let i = 0; i < khHH[0].List_SoLuongMua.length; i++) {
                    for (let j = 0; j < objCTHD.length; j++) {
                        // if exist --> update SoLuong
                        if ($.inArray(objCTHD[j].ID_DonViQuiDoi, arrID_QuiDoiEx) > -1) {
                            if (objCTHD[j].ID_DonViQuiDoi === khHH[0].List_SoLuongMua[i].ID_DonViQuiDoi) {
                                if (isTraHang) {
                                    khHH[0].List_SoLuongMua[i].SoLuong = khHH[0].List_SoLuongMua[i].SoLuong - parseFloat(objCTHD[j].SoLuong);
                                }
                                else {
                                    khHH[0].List_SoLuongMua[i].SoLuong = khHH[0].List_SoLuongMua[i].SoLuong + parseFloat(objCTHD[j].SoLuong);
                                }
                            }
                        }
                        else {
                            // not exist, push new obj in List_SoLuongMua
                            let obj = {
                                ID_DonViQuiDoi: objCTHD[j].ID_DonViQuiDoi,
                                SoLuong: parseFloat(objCTHD[j].SoLuong),
                            };
                            arrNew.push(obj);
                            arrID_QuiDoiEx.push(objCTHD[j].ID_DonViQuiDoi);
                        }
                    }
                }
                // avoid case push khHH[0].List_SoLuongMua, and for loop run many time
                for (let i = 0; i < arrNew.length; i++) {
                    khHH[0].List_SoLuongMua.push(arrNew[i]);
                }
                // remove item exist, and push again
                var arrKH_HangHoa = $.grep(self.KhachHang_HangHoa(), function (x) {
                    return x.ID_DoiTuong !== objHD.ID_DoiTuong;
                });
                self.KhachHang_HangHoa().push(khHH[0]);
            }
            else {
                if (!isTraHang) {
                    var arr = {
                        ID_DoiTuong: objHD.ID_DoiTuong,
                        List_SoLuongMua: [
                            {
                                ID_DonViQuiDoi: objCTHD[0].ID_DonViQuiDoi,
                                SoLuong: parseFloat(objCTHD[0].SoLuong),
                            }],
                    }
                    // set default arrID_QuiDoi = first ID_QuiDoi
                    var arrID_QuiDoi = [objCTHD[0].ID_DonViQuiDoi];
                    for (let i = 1; i < objCTHD.length; i++) {
                        if ($.inArray(objCTHD[i].ID_DonViQuiDoi, arrID_QuiDoi) === -1) {
                            let obj = {
                                ID_DonViQuiDoi: objCTHD[i].ID_DonViQuiDoi,
                                SoLuong: parseFloat(objCTHD[i].SoLuong),
                            };
                            arr.List_SoLuongMua.push(obj);
                        }
                        else {
                            // update SoLuong
                            for (let j = 0; j < arr.List_SoLuongMua.length; j++) {
                                if (arr.List_SoLuongMua[j].ID_DonViQuiDoi === objCTHD[i].ID_DonViQuiDoi) {
                                    arr.List_SoLuongMua[j].SoLuong = arr.List_SoLuongMua[j].SoLuong + parseFloat(objCTHD[i].SoLuong);
                                }
                            }
                        }
                    }
                    khHH.push(arr);
                    self.KhachHang_HangHoa.push(arr);
                }
            }
            db.KhachHang_HangHoa.put(khHH[0]);
        }
    }

    // update status for HDDatHang
    function UpdateStatus_HDDatHang() {
        db.HDDatHang_UpdateStatus.each(function (x, cur) {
            // assign status, id --> update DB
            self.ID_HoaDonUpdate(x.ID);
            self.StatusHD(x.Status);
            UpdateStatudHD();
            // and remove from cache local DB
           // db.HDDatHang_UpdateStatus.delete(x.ID);
        });
    }
    function Insert_HT_ThongBao(DM_DoiTuong) {
        // remind birthday customer
        var objAdd =
        {
            ID_DonVi: id_DonVi,
            LoaiThongBao: 3,
            NoiDungThongBao: "<p onclick=\"loaddadoc('" + 'key' + "')\"> Khách hàng <a onclick=\"loadthongbao('3'," +
                "'" + DM_DoiTuong.MaDoiTuong + "', '" + 'key' + "')\">"
                + " <span class=\"blue\">" + DM_DoiTuong.TenDoiTuong + " </span>"
                + "</a> có sinh nhật hôm nay</p>",
            NguoiDungDaDoc: '',
        };
        ajaxHelper('/api/DanhMuc/HT_API/' + 'Post_HT_ThongBao', 'POST', objAdd).done(function (x) {
        });
    }
    function Delete_HT_ThongBao(maDoiTuong) {
        var today = moment(now).format('YYYY-MM-DD');
        var where = "  convert(varchar, getdate(), 23) = '" + today + "' AND LoaiThongBao= 3 and NoiDungThongBao like N'%" + maDoiTuong + "%'";
        ajaxHelper('/api/DanhMuc/HT_API/' + 'Delete_HT_ThongBao?where=' + where, 'DELETE').done(function (x) {
        })
    }

    function PostHD_SoQuy_DongBo(myData) {
        console.log('dongbo_myData ', myData);
        var urlPost = BHHoaDonUri + "SP_PostBH_HoaDon";
        var objHDAdd = myData.objHoaDon;

        switch (objHDAdd.LoaiHoaDon) {
            case 1:
                myData.objHoaDon.ChiPhi = objHDAdd.TongChiPhi;
                myData.objHoaDon.TongChiPhi = 0;
                if (objHDAdd.CreateTime !== 0) {
                    var objTime = GetGioVaoRa_ofHD(objHDAdd);
                    objHDAdd.GioVao = objTime.GioVao;
                    objHDAdd.GioRa = objTime.GioRa;
                    myData.objHoaDon.YeuCau = '1';
                }
                break;
            case 19:
                myData.objHoaDon.ChiPhi = objHDAdd.TongChiPhi;
                myData.objHoaDon.TongChiPhi = 0;
                myData.objHoaDon.NgayApDungGoiDV = moment(myData.objHoaDon.NgayApDungGoiDV, 'DD/MM/YYYY').format('YYYY-MM-DD');
                myData.objHoaDon.HanSuDungGoiDV = moment(myData.objHoaDon.HanSuDungGoiDV, 'DD/MM/YYYY').format('YYYY-MM-DD');
                break;
        }
        $.ajax({
            data: myData,
            url: urlPost,
            type: 'POST',
            async: false, // khong luu dong thoi
            dataType: 'json',
            contentType: "application/x-www-form-urlencoded; charset=UTF-8",
            success: function (obj) {
                if (obj.res === true) {
                    let itemDB = obj.data;
                    ShowMessage_Success('Thanh toán hóa đơn thành công');
                    // push DM_nguonKhach after add (todo)
                    objHDAdd.MaHoaDon = itemDB.MaHoaDon;
                    objHDAdd.ID = itemDB.ID;

                    AssignValueHoaDon_ToPhieuThu(objHDAdd);
                    vmThanhToanGara.SavePhieuThu(objHDAdd.BH_NhanVienThucHiens);
                    Insert_NhatKyThaoTac(objHDAdd, myData.objCTHoaDon, 1, 1);

                    // update status for HD DatHang in list indexDb local (HDDatHang_UpdateStatus)
                    UpdateStatus_HDDatHang();
                    RemoveKHoffline_afterSave();
                }
                else {
                    ShowMessage_Danger(obj.mes);
                }
                $('.divDongBoHoa').gridLoader({ show: false });
                $('#btnDongBoHoa,#btnSave').removeAttr('disabled');
                $('#getoffline').modal('hide');
            },
            complete: function () {
                SaveHD_RemoveDisable();
                $('.divDongBoHoa').gridLoader({ show: false });
                $('#btnDongBoHoa,#btnSave').removeAttr('disabled');
                $('#getoffline').modal('hide');
            }
        })
        UpdateInforKH_toDB(objHDAdd.ID_DoiTuong);
    }

    function SaveDiary_WhenTimeOut(hd, txt = '') {
        let diary = {
            ID_DonVi: id_DonVi,
            ID_NhanVien: _idNhanVien,
            LoaiNhatKy: 3,
            ChucNang: 'Gara',
            NoiDung: 'Timeout ' + txt,
            NoiDungChiTiet: 'Tài khoản đăng nhập: '.concat(userLogin,
                '<br /> ID_DoiTuong: ', hd.ID_DoiTuong,
                '<br /> Ngày lập: ', hd.NgayLapHoaDon,
                '<br /> Tổng tiền hàng: ', hd.TongTienHang,
                '<br /> Tổng thanh toán: ', hd.TongThanhToan,
                '<br /> Tổng thuế khách hàng: ', hd.TongTienThue,
                '<br /> Tổng giảm giá: ', hd.TongGiamGia,
                '<br /> Ngày lập: ', hd.NgayLapHoaDon,
                '<br /> Ngày tạo: ', new Date(),
            ),
        }
        Insert_NhatKyThaoTac_1Param(diary);
    }

    function DeleteHoaDon_WasSaved_WhenTimeout(objHoaDon) {
        var ngaylapHD = GetNgayLapHD_whenSave(objHoaDon.NgayLapHoaDon);
        var idChiNhanh = objHoaDon.ID_DonVi;
        //var userLogin = userLogin;
        var loaiHD = objHoaDon.LoaiHoaDon;
        ajaxHelper(BHHoaDonUri + 'DeleteBH_HoaDon_ByNgayLapHD?ngayLapHD=' + ngaylapHD + '&idChiNhanh=' + idChiNhanh
            + '&loaiHoaDon=' + loaiHD + '&userLogin=' + userLogin, 'DELETE').done(function (x) {
                SaveDiary_WhenTimeOut(objHoaDon, 'DeleteHoaDon_WasSaved_WhenTimeout');
            })
    }
    // if save 2 time, ngaylapHD have format 'DD/MM/YYY', so nedd formet again
    function GetNgayLapHD_whenSave(ngaylapHD) {
        if (ngaylapHD === null || ngaylapHD === undefined) {
            ngaylapHD = moment(new Date()).format('YYYY-MM-DD HH:mm');
        }
        else {
            var ddMMyyyy = ngaylapHD.split('/');
            if (ddMMyyyy.length > 1) {
                ngaylapHD = moment(ngaylapHD, 'DD/MM/YYYY HH:mm').format('YYYY-MM-DD HH:mm');
            }
            // else keep value YYYY-MM-DD
        }
        return ngaylapHD;
    }
    function GetGioVaoRa_ofHD(objHDAdd) {
        var ngaylapHD = objHDAdd.NgayLapHoaDon;
        if (ngaylapHD === null || ngaylapHD === undefined) {
            ngaylapHD = moment(new Date()).format('YYYY-MM-DD');
        }
        else {
            var ddMMyyyy = ngaylapHD.split('/');
            if (ddMMyyyy.length > 1) {
                ngaylapHD = moment(ngaylapHD, 'DD/MM/YYYY HH:mm').format('YYYY-MM-DD');
            }
            else {
                ngaylapHD = moment(ngaylapHD, 'YYYY-MM-DD HH:mm').format('YYYY-MM-DD');
            }
        }
        // gio vao
        var giovao = ConvertTimeFrom12To24(objHDAdd.CreateTime);
        var ngaygioVao = ngaylapHD.concat(' ', giovao);
        // giora = giovao + thoigianThucHien
        var thoigianThucHien = objHDAdd.ThoiGianThucHien;
        var dateVao = new Date(ngaygioVao);
        dateVao.setMinutes(dateVao.getMinutes() + thoigianThucHien);
        var ngaygioRa = moment(dateVao).format('YYYY-MM-DD HH:mm');
        ngaygioRa = ngaygioRa === 'Invalid date' ? null : ngaygioRa;
        return {
            GioVao: ngaygioVao,
            GioRa: ngaygioRa,
        }
    }
    function PostHD_TamLuu(myData) {
        var objHDAdd = myData.objHoaDon;
        var idRandomHD = objHDAdd.IDRandom;
        // remove HD_ChiTiet in objHoaDon
        delete myData.objHoaDon["BH_HoaDon_ChiTiet"];
        let ngayapdung = myData.objHoaDon.NgayApDungGoiDV;
        let handung = myData.objHoaDon.HanSuDungGoiDV;
        if (ngayapdung !== null) {
            if (handung !== '' && handung !== null) {
                handung = moment(handung, 'DD/MM/YYYY').format('YYYY-MM-DD');
            }
        }

        myData.objHoaDon.NgayApDungGoiDV = ngayapdung;
        myData.objHoaDon.HanSuDungGoiDV = handung;
        myData.objHoaDon.ChoThanhToan = true;
        myData.objHoaDon.YeuCau = 2;// tamluu
        myData.objHoaDon.DiemGiaoDich = 0;

        console.log('myData ', myData)
        ajaxHelper(BHHoaDonUri + 'PostBH_HoaDon_SoQuy_Spa_NKySuDung', 'POST', myData).done(function (obj) {
            if (obj.res === true) {
                // remove cache hdTamLuu
                var lstHD = localStorage.getItem(lcListHD);
                if (lstHD !== null) {
                    lstHD = JSON.parse(lstHD);
                    lstHD = $.grep(lstHD, function (x) {
                        return x.IDRandom !== idRandomHD;
                    });
                    localStorage.setItem(lcListHD, JSON.stringify(lstHD));
                }
                var cthd = localStorage.getItem(lcListCTHD);
                if (cthd !== null) {
                    cthd = JSON.parse(cthd);
                    cthd = $.grep(cthd, function (item) {
                        return item.IDRandomHD !== idRandomHD;
                    });
                    localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
                }
                ShowMessage_Success('Lưu tạm hóa đơn thành công');
                BindHD_CTHDafterSave();
                Call_6Func();
            }
            else {
                ShowMessage_Danger('Lưu tạm hóa đơn không thành công');
            }
            ResetPhieuThu_afterThanhToan();
        }).always(function () {
            SaveHD_RemoveDisable();
            $('#getoffline').modal('hide');
        });
    }

    function Insert_ThongBaoHetTonKho(cthd) {
        cthd = cthd.filter(x => x.LaHangHoa);
        var arrQuiDoi = cthd.map(function (x) {
            return x.ID_DonViQuiDoi;
        })
        var arrIDLo = cthd.filter(x => x.ID_LoHang !== null).map(function (x) {
            return x.ID_LoHang;
        })
        var param = {
            ID_ChiNhanh: id_DonVi,
            ListIDQuyDoi: arrQuiDoi,
            ListIDLoHang: arrIDLo,
        }
        ajaxHelper('/api/DanhMuc/HT_API/Insert_ThongBaoHetTon', 'POST', param).done(function (x) {
        })
    }


    function ResetPhieuThu_afterThanhToan() {
        vmThanhToanGara.PhieuThuKhach = vmThanhToanGara.newPhieuThu(1);
        vmThanhToanGara.PhieuThuBaoHiem = vmThanhToanGara.newPhieuThu(3);
        vmThanhToanGara.PhieuThuKhachPrint = vmThanhToanGara.newPhieuThu(1);
        vmThanhToanGara.PhieuThuBaoHiemPrint = vmThanhToanGara.newPhieuThu(3);
    }
    // if change HD DatHang dang xuly (updateHDDatHang = true) --> not print
    function PostHD_SoQuy_SaveHD(myData, updateHDDatHang) {
        var objHDAdd = myData.objHoaDon;
        var idRandomHD = objHDAdd.IDRandom;

        myData.objHoaDon.ChoThanhToan = false;
        myData.objHoaDon.ChiPhi = objHDAdd.TongChiPhi;
        myData.objHoaDon.TongChiPhi = 0;
        myData.objHoaDon.YeuCau = '1';
        myData.objHoaDon.NguoiTao = userLogin;// update again NguoiTao if HDTamLuu

        var isInsert = true;
        if (!commonStatisJs.CheckNull(objHDAdd.ID) && objHDAdd.ID !== const_GuidEmpty) {
            isInsert = false;
        }

        switch (objHDAdd.LoaiHoaDon) {
            case 1:
                if (objHDAdd.StatusOffline === false) {
                    // update TonKho if HD mua and not offline
                    UpdateTonKho_forListHangHoa_andCTHD(myData.objCTHoaDon, false);
                    // update again warning CTHD, CTHD_DoiTra
                    UpdateWarning_CTHD_afterSave();
                }
                // save GioVao, GioRa
                if (objHDAdd.CreateTime !== 0) {
                    var objTime = GetGioVaoRa_ofHD(objHDAdd);
                    objHDAdd.GioVao = objTime.GioVao;
                    objHDAdd.GioRa = objTime.GioRa;
                }
                break;
            case 3:
                if (objHDAdd.ID === const_GuidEmpty && objHDAdd.ID_PhieuTiepNhan !== null) {
                    // duyetbaogia = true --> chothanhtoan = fasle
                    objHDAdd.ChoThanhToan = !objHDAdd.DuyetBaoGia;
                }
                break;
        }
        var notSaleOffline = self.ThietLap() !== null && self.ThietLap().BanHangOffline === false;
        var urlPost = BHHoaDonUri + "PostBH_HoaDon_SoQuy_Spa_NKySuDung";
        if (objHDAdd.TrangThaiHD === 8) {
            urlPost = BHHoaDonUri + "UpdateHoaDon_OpenFromList";
            myData.objHoaDon.NguoiSua = userLogin;
        }
        $.ajax({
            data: myData,
            url: urlPost,
            type: 'POST',
            async: true, // run time slowly if 'true' and set timeout = 2500
            dataType: 'json',
            contentType: "application/x-www-form-urlencoded; charset=UTF-8",
        }).done(function (objDB) {
            console.log('savehd  ', objDB);
            if (objDB.res === true) {
                var itemDB = objDB.data;
                $('.bgwhite').hide();
                objHDAdd.MaHoaDon = itemDB.MaHoaDon;
                objHDAdd.ID = itemDB.ID;
                objHDAdd.NgayLapHoaDon = itemDB.NgayLapHoaDon;

                switch (objHDAdd.LoaiHoaDon) {
                    case 1:
                    case 25:
                        PostChiPhi(itemDB.BH_HoaDon_ChiTiet, objHDAdd, isInsert);
                        break;
                }

                AssignValueHoaDon_ToPhieuThu(objHDAdd);
                vmThanhToanGara.SavePhieuThu(objHDAdd.BH_NhanVienThucHiens);

                if (objHDAdd.XuatKhoAll) {
                    CreatePhieuXuatKho(itemDB.ID, itemDB.MaHoaDon);
                }

                if (objHDAdd.LoaiHoaDon !== 3) {
                    UpdateDiemKH_toDB();
                }

                // get maHDDatHang -> delete in cacheDatHang after save
                var maHDDatHang = myData.objHoaDon.MaHoaDonTraHang;
                // if updateHDDatHang --> don't remove (HD DatHang  + HD new create)
                var lstHDafter = [];
                if (updateHDDatHang === false) {
                    lstHDafter = localStorage.getItem(lcListHD);
                    lstHDafter = JSON.parse(lstHDafter);
                    // remove HD after save
                    lstHDafter = RemoveHD_byMaHoaDon(_maHoaDon, lstHDafter);
                    // remove hd DatHang (if HD was creat from DatHang)
                    lstHDafter = $.grep(lstHDafter, function (x) {
                        return x.MaHoaDon !== maHDDatHang;
                    });
                    localStorage.setItem(lcListHD, JSON.stringify(lstHDafter));
                    // remove CTHoaDon in Cache
                    var cthd = localStorage.getItem(lcListCTHD);
                    if (cthd !== null) {
                        cthd = JSON.parse(cthd);
                        cthd = $.grep(cthd, function (item) {
                            return item.IDRandomHD !== idRandomHD;
                        });
                        // remove cthd DatHang (if HD was creat from DatHang)
                        cthd = $.grep(cthd, function (x) {
                            return x.MaHoaDon !== maHDDatHang;
                        });
                        localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
                    }
                    // remove CTHD_Muamoi
                    var cacheCTHD_MH = localStorage.getItem(lcListCTHD_DoiTra);
                    if (cacheCTHD_MH !== null) {
                        cacheCTHD_MH = JSON.parse(cacheCTHD_MH);
                        cacheCTHD_MH = $.grep(cacheCTHD_MH, function (item) {
                            return item.IDRandomHD !== idRandomHD;
                        });
                        localStorage.setItem(lcListCTHD_DoiTra, JSON.stringify(cacheCTHD_MH));
                    }
                    // start print (khong in hoa don neu update HD DatHang dang xu ly)
                    myData.objHoaDon.MaHoaDon = itemDB.MaHoaDon;
                    var diemGD = myData.objHoaDon.DiemGiaoDich - myData.objHoaDon.DiemQuyDoi;
                    if (diemGD < 0) {
                        diemGD = myData.objHoaDon.DiemGiaoDich;
                    }
                    myData.objHoaDon.DiemGiaoDich = diemGD;
                    myData.objHoaDon = GetInforHDPrint(myData.objHoaDon);
                    self.InforHDprintf(myData.objHoaDon);
                    let ctHDprint = GetCTHDPrint_Format(myData.objCTHoaDon);
                    self.CTHoaDonPrint(ctHDprint);
                    switch (objHDAdd.LoaiHoaDon) {
                        case 1:
                        case 25:
                            self.InHoaDon("HDBL", false);
                            break;
                        case 3:
                            self.InHoaDon("DH", false);
                            break;
                        case 6:
                            self.InHoaDon("TH", false);
                            break;
                    }
                    // end Print
                }
                else {
                    Update_IDChiTietHD_toCTHD(objHDAdd.IDRandom, itemDB.BH_HoaDon_ChiTiet);
                    Update_StatusXuLy_ofHDDatHang(objHDAdd.IDRandom, false);
                    UpdateDH_RemoveAdd_TPCombo(objHDAdd.IDRandom);
                    UpdateCache_XuLyDonHang();
                    Update_IDChiTietHD_toCacheDH(itemDB.BH_HoaDon_ChiTiet);
                    let idHDNew = CreateHD_fromHDDatHang();
                    UpdateSoThuTu_CTHD(false, idHDNew);
                }
                // remove cache KH offline (remove after get inforHDPrint)
                RemoveKHoffline_afterSave();

                // update Status HD DatHang if XuLi het Don Hang
                CheckXuLyHet_DonDatHang(objHDAdd.LoaiHoaDon, objHDAdd.ID, objHDAdd.ID_HoaDon);
                if (objHDAdd.LoaiHoaDon === 1 || objHDAdd.XuatKhoAll) {
                    Insert_ThongBaoHetTonKho(myData.objCTHoaDon);
                }

                // remove cache DatHang 
                var lcXuLiDonHang = localStorage.getItem(lcXuLiDonHang_Const);
                if (lcXuLiDonHang !== null) {
                    lcXuLiDonHang = JSON.parse(lcXuLiDonHang);
                    lcXuLiDonHang = $.grep(lcXuLiDonHang, function (itemXL) {
                        return itemXL.MaHoaDon !== maHDDatHang;
                    });
                    localStorage.setItem(lcXuLiDonHang_Const, JSON.stringify(lcXuLiDonHang));
                    var lcCTDatHang = localStorage.getItem(lcCTDatHang_Const);
                    if (lcCTDatHang !== null) {
                        lcCTDatHang = JSON.parse(lcCTDatHang);
                        lcCTDatHang = $.grep(lcCTDatHang, function (itemXL) {
                            return itemXL.MaHoaDon !== maHDDatHang;
                        });
                        localStorage.setItem(lcCTDatHang_Const, JSON.stringify(lcCTDatHang));
                    }
                }

                // remove hang khuyen mai of HoaDon
                var arrproductKM = localStorage.getItem(lcProductKM_HoaDon);
                if (arrproductKM !== null) {
                    arrproductKM = JSON.parse(arrproductKM);
                    arrproductKM = $.grep(arrproductKM, function (item) {
                        return item.IDRandomHD !== idRandomHD;
                    });
                    localStorage.setItem(lcProductKM_HoaDon, JSON.stringify(arrproductKM));
                    self.HHTang_HoaDon(arrproductKM);
                }
                // update status for HDDatHang
                UpdateStatus_HDDatHang();

                BindHD_CTHDafterSave();
                Call_6Func();
                ShowMessage_Success('Thanh toán hóa đơn thành công');

                vmThemMoiKhach.NangNhomKhachHang(objHDAdd.ID_DoiTuong);
                if (objHDAdd.LoaiHoaDon === 25 && objHDAdd.ChoThanhToan === false) {
                    if (isInsert === false) {
                        vmNhatKyBaoDuong.Upadate_LichBaoDuong(itemDB.ID, itemDB.hangthaymoi, itemDB.NgayLapHoaDon, itemDB.NgayLapHoaDonOld)
                    }

                    let isPrint = Check_AutoPrint(objHDAdd.LoaiHoaDon);
                    vmNhatKyBaoDuong.Insert_LichNhacBaoDuong(objHDAdd.ID, myData.objCTHoaDon, isPrint);
                }
                else {
                    if (!updateHDDatHang) {
                        let isPrint = Check_AutoPrint(objHDAdd.LoaiHoaDon);
                        if (!isPrint) {
                            window.close();
                        }
                    }
                }
            }
            else {
                SaveDiary_WhenTimeOut(myData.objHoaDon, 'network limit');
                SaveHD_RemoveDisable();
                // network limit
                if (objDB.mes.indexOf('0x80131904') > -1) {
                    if (notSaleOffline) {
                        ShowMessage_Danger('Kết nối mạng không ổn định. Thao tác thất bại');
                        DeleteHoaDon_WasSaved_WhenTimeout(myData.objHoaDon);
                        return false;
                    }
                    SaveHDOffline();
                    if (updateHDDatHang === false) {
                        objHDAdd.MaHoaDon = _maHoaDon;
                        let objHDPrint = GetInforHDPrint(objHDAdd);
                        self.InforHDprintf(objHDPrint);
                        objCTAdd = GetCTHDPrint_Format(myData.objCTHoaDon);
                        self.CTHoaDonPrint(objCTAdd);
                        if (objHDAdd.LoaiHoaDon === 1) {
                            self.InHoaDon("HDBL", false);
                        }
                        else {
                            self.InHoaDon("DH", false);
                        }
                    }
                    BindHD_CTHDafterSave();
                    ShowMessage_Success('Không có kết nối Internet. Giao dịch đã được lưu tạm trên máy');
                    SaveHD_RemoveDisable();
                    Call_6Func();
                    DeleteHoaDon_WasSaved_WhenTimeout(myData.objHoaDon);
                }
            }
            ResetPhieuThu_afterThanhToan();
        })
            .fail(function (jqXHR, textStatus, errorThrown) {
                SaveDiary_WhenTimeOut(myData.objHoaDon, 'fail ' + jqXHR);
                SaveHD_RemoveDisable();
                if (notSaleOffline) {
                    ShowMessage_Danger('Kết nối mạng không ổn định. Thao tác thất bại');
                    return false;
                }
                SaveHDOffline();
                if (updateHDDatHang === false) {
                    objHDAdd.MaHoaDon = _maHoaDon;
                    let objHDPrint = GetInforHDPrint(objHDAdd);
                    self.InforHDprintf(objHDPrint);
                    objCTAdd = GetCTHDPrint_Format(myData.objCTHoaDon);
                    self.CTHoaDonPrint(objCTAdd);
                    if (objHDAdd.LoaiHoaDon === 1) {
                        self.InHoaDon("HDBL", false);
                    }
                    else {
                        self.InHoaDon("DH", false);
                    }
                }
                BindHD_CTHDafterSave();
                ShowMessage_Success('Không có kết nối Internet. Giao dịch đã được lưu tạm trên máy');
                Call_6Func();
            })
            .always(function (jqXHR, textStatus, errorThrown) {
                SaveHD_RemoveDisable();
                if (textStatus === 'timeout') {
                    DeleteHoaDon_WasSaved_WhenTimeout(myData.objHoaDon);
                }

                $('#getoffline').modal('hide');
                self.HoaDonTHs([]);
            });
        // if KH was update when offline --> update infor KH to DB
        UpdateInforKH_toDB(objHDAdd.ID_DoiTuong);
    }
    function PostHD_HoaDon_DichVu(myData) {
        var objHDAdd = myData.objHoaDon;
        var idRandomHD = objHDAdd.IDRandom;
        // if TamLuuHD --> clickGoiDV: assign again PhaiTT
        myData.objHoaDon.ChiPhi = objHDAdd.TongChiPhi;
        myData.objHoaDon.TongChiPhi = 0;

        if (commonStatisJs.CheckNull(objHDAdd.ID_Xe)) {
            ShowMessage_Danger('Vui lòng chọn xe khi mua gói bảo dưỡng');
            SaveHD_RemoveDisable();
            return;
        }

        let ngayapdung = myData.objHoaDon.NgayApDungGoiDV;
        if (ngayapdung === '' || ngayapdung === null) {
            ngayapdung = null;
        }
        else {
            ngayapdung = moment(ngayapdung, 'DD/MM/YYYY').format('YYYY-MM-DD');
        }
        let handung = myData.objHoaDon.HanSuDungGoiDV;
        if (handung === '' || handung === null) {
            handung = null;
        }
        else {
            handung = moment(handung, 'DD/MM/YYYY').format('YYYY-MM-DD');
        }
        myData.objHoaDon.NgayApDungGoiDV = ngayapdung;
        myData.objHoaDon.HanSuDungGoiDV = handung;
        // Mua goi DV: update GiaVon CTHD = 0, ID_ChiTietGoiDV: null, ChatLieu = empty
        for (let i = 0; i < myData.objCTHoaDon.length; i++) {
            myData.objCTHoaDon[i].GiaVon = 0;
            myData.objCTHoaDon[i].ID_ChiTietGoiDV = null;
            myData.objCTHoaDon[i].ChatLieu = '';
        }
        console.log('myData', myData)
        var urlPost = BHHoaDonUri + "PostBH_HoaDon_SoQuy_Spa_NKySuDung";
        if (objHDAdd.TrangThaiHD === 8) {
            urlPost = BHHoaDonUri + "UpdateHoaDon_OpenFromList";
        }
        $.ajax({
            data: myData,
            url: urlPost,
            //timeout: 8000,
            type: 'POST',
            async: true, // time run quickly if 'false' (if have many CTHD)
            dataType: 'json',
            contentType: "application/x-www-form-urlencoded; charset=UTF-8",
        }).done(function (objDB) {
            if (objDB.res === true) {
                var itemDB = objDB.data;
                $('.bgwhite').hide();
                objHDAdd.MaHoaDon = itemDB.MaHoaDon;
                objHDAdd.ID = itemDB.ID;
                objHDAdd.NgayLapHoaDon = itemDB.NgayLapHoaDon;

                AssignValueHoaDon_ToPhieuThu(objHDAdd);
                vmThanhToanGara.SavePhieuThu(objHDAdd.BH_NhanVienThucHiens);

                UpdateDiemKH_toDB();

                var lstHDafter = localStorage.getItem(lcListHD);
                lstHDafter = JSON.parse(lstHDafter);
                // remove HD after save
                lstHDafter = RemoveHD_byMaHoaDon(_maHoaDon, lstHDafter);
                localStorage.setItem(lcListHD, JSON.stringify(lstHDafter));
                // remove CTHoaDon in Cache
                var cthd = localStorage.getItem(lcListCTHD);
                if (cthd !== null) {
                    cthd = JSON.parse(cthd);
                    cthd = $.grep(cthd, function (item) {
                        return item.IDRandomHD !== idRandomHD;
                    });
                    localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
                }
                // start print
                myData.objHoaDon.MaHoaDon = itemDB.MaHoaDon;
                var diemGD = myData.objHoaDon.DiemGiaoDich - myData.objHoaDon.DiemQuyDoi;
                if (diemGD < 0) {
                    diemGD = myData.objHoaDon.DiemGiaoDich;
                }
                myData.objHoaDon.DiemGiaoDich = diemGD;
                myData.objHoaDon = GetInforHDPrint(myData.objHoaDon);
                self.InforHDprintf(myData.objHoaDon);
                var ctHDprint = GetCTHDPrint_Format(myData.objCTHoaDon);
                self.CTHoaDonPrint(ctHDprint);
                switch (objHDAdd.LoaiHoaDon) {
                    case 19:
                        self.InHoaDon("GDV", false);
                        break;
                }
                // end Print
                // save diary after print HoaDon --> to do get MaLoHang
                // remove hang khuyen mai of HoaDon
                var arrproductKM = localStorage.getItem(lcProductKM_HoaDon);
                if (arrproductKM !== null) {
                    arrproductKM = JSON.parse(arrproductKM);
                    arrproductKM = $.grep(arrproductKM, function (item) {
                        return item.IDRandomHD !== idRandomHD;
                    });
                    localStorage.setItem(lcProductKM_HoaDon, JSON.stringify(arrproductKM));
                    self.HHTang_HoaDon(arrproductKM);
                }

                BindHD_CTHDafterSave();
                Call_6Func();
                ShowMessage_Success('Thanh toán hóa đơn thành công');

                vmThemMoiKhach.NangNhomKhachHang(objHDAdd.ID_DoiTuong);
            }
            else {
                ShowMessage_Danger(objDB.mes);
            }
        }).fail(function () {
            var notSaleOffline = self.ThietLap() !== null && self.ThietLap().BanHangOffline === false;
            if (notSaleOffline) {
                ShowMessage_Danger('Kết nối mạng không ổn định. Thao tác thất bại');
                SaveHD_RemoveDisable();
                //DeleteHoaDon_WasSaved_WhenTimeout(myData.objHoaDon);
                return false;
            }
            SaveHDOffline();
            objHDAdd.MaHoaDon = _maHoaDon;
            var objHDPrint = GetInforHDPrint(objHDAdd);
            self.InforHDprintf(objHDPrint);
            objCTAdd = GetCTHDPrint_Format(myData.objCTHoaDon);
            self.CTHoaDonPrint(objCTAdd);
            self.InHoaDon("GDV", false);
            BindHD_CTHDafterSave();
            SaveHD_RemoveDisable();
            Call_6Func();
            ShowMessage_Success('Không có kết nối Internet. Giao dịch đã được lưu tạm trên máy');
        }).always(function () {
            SaveHD_RemoveDisable();
            $('#getoffline').modal('hide');
            self.HoaDonTHs([]);
            ResetPhieuThu_afterThanhToan();
        })
    }

    function HDTraHang_InsertTPDinhLuong(idHoaDon) {
        ajaxHelper(BHHoaDonUri + 'HDTraHang_InsertTPDinhLuong?idHoaDonTra=' + idHoaDon, 'GET').done(function (x) {
        });
    }

    function CheckXuLyHet_DonDatHang(loaiHoaDon, idHoaDon, idDatHang) {
        if ((loaiHoaDon === 1 || loaiHoaDon === 25) && idDatHang !== null && idDatHang !== const_GuidEmpty) {
            ajaxHelper(BHHoaDonUri + 'CheckXuLyHet_DonDathang?idHoaDon=' + idHoaDon + '&idDatHang=' + idDatHang, 'GET').done(function (x) {
                if (x === true) {
                    self.StatusHD(3);
                    self.ID_HoaDonUpdate(idDatHang);
                    UpdateStatudHD();
                }
                else {
                    self.ID_HoaDonUpdate(idDatHang);
                    self.NotEndInvoice(); // khong show modal question: auto update status = 2
                }
            });
        }
    }

    self.SetNhanVien = function (idNhanVien) {
        var itemNV = $.grep(self.NhanViens(), function (item) {
            return item.ID === idNhanVien;
        });
        if (itemNV.length > 0) {
            self.NhanVien0(itemNV);
        }
        else {
            if (self.NhanViens().length > 0) {
                self.NhanVien0([self.NhanViens()[0]]);
            }
        }
        self.selectedNVien(idNhanVien);

        $('.select-user1').css('display', 'none');
        $('#lstNVien span').each(function () {
            $(this).empty();
        });
        $(function () {
            $('span[id=spanCheckNV_' + idNhanVien + ']').append(element_appendCheck);
        });
    }

    self.SetBangGia = function (idBangGia) {
        var itemBG = $.grep(self.AllBangGia(), function (item) {
            return item.ID === idBangGia;
        });
        if (itemBG.length > 0) {
            self.GiaBan0(itemBG);
        }
        else {
            self.GiaBan0([{ ID: idBangGia, TenGiaBan: 'Bảng giá chuẩn' }]);
        }
        self.selectedGiaBan(idBangGia);
    }

    self.SetChiNhanh = function (idDonVi) {
        var itemCN = $.grep(self.ChiNhanhs(), function (item) {
            return item.ID === idDonVi;
        });
        if (itemCN.length > 0) {
            self.ChiNhanh0(itemCN[0]);
        }
        else {
            if (self.ChiNhanhs().length > 0) {
                self.ChiNhanh0(self.ChiNhanhs()[0]);
            }
            else {
                // get from DB (first load)
                $.getJSON('/api/DanhMuc/DM_DonViAPI/GetListDonViByID/' + idDonVi, function (data) {
                    if (data !== null && data.length > 0) {
                        self.ChiNhanh0(data[0]);
                    }
                });
            }
        }
        self.selectedChiNhanh(idDonVi);
    }

    self.ChangeChiNhanh = function (item) {
        $(event.currentTarget).closest('div').hide();
        id_DonVi = item.ID;
        localStorage.setItem('IdDonVi', id_DonVi);

        vmThemMoiKhach.inforLogin.ID_DonVi = id_DonVi;// used to check when NangNhomKhach

        vmHoaHongDV.inforHoaDon.ID_DonVi = id_DonVi;
        vmHoaHongDV.PageLoad();

        self.SetChiNhanh(id_DonVi);

        // update ID_DonVi in cache HoaDon
        var lstHDTemp = localStorage.getItem(lcListHD);
        if (lstHDTemp !== null) {
            lstHDTemp = JSON.parse(lstHDTemp);
            for (let i = 0; i < lstHDTemp.length; i++) {
                if (lstHDTemp[i].NguoiTao === userLogin && lstHDTemp[i].StatusOffline === false) {
                    lstHDTemp[i].ID_DonVi = id_DonVi;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(lstHDTemp));
        }

        var rememberme = localStorage.chkbx;
        $.ajax({
            url: '/api/DanhMuc/HT_ThietLapAPI/' + 'GetCauHinhHeThong?id=' + id_DonVi,
            success: function (item) {
                self.ThietLap(item);
                vmThanhToan.ThietLapCuaHang = [item];
            }
        });
        $.ajax({
            url: '/Home/KeepSession?id=' + id_DonVi + '&checkremember=' + rememberme,
            success: function () {
                ShowMessage_Success("Bạn vừa chuyển sang chi nhánh " + item.TenDonVi);
                // becuase get user from cookie --> so must get after update "Account" in API
                GetHT_Quyen_ByNguoiDung();
            }
        });

        GetListIDNhanVien_byUserLogin('KhachHang'); // load list KH after load all NhanVien lien quan
        GetAllMauIn_byChiNhanh();
        GetDataChotSo();
        GetKM_CTKhuyenMai();
        GetHT_TichDiem();
        GetDM_TaiKhoanNganHang();
        GetNhanVien_NguoiDung();
        GetDMGiaBan_GBApDung();
        GetNhomDoiTuong_DonVi();
        vmThanhPhanDinhLuong.ID_DonVi = id_DonVi;
        vmThanhPhanDinhLuong.GetAllDinhLuongDV();
    }

    function newHoaDon(loaiHoaDon, max) {
        var maHD = '';
        switch (loaiHoaDon) {
            case 1:
            case 25:
                maHD = nameHD_InsertBH.concat(max);
                break;
            case 3:
                maHD = nameHD_InsertDH.concat(max);
                break;
            case 6:
                maHD = nameHD_TraHang.concat(max);
                return obj = newHoaDonTraHang(null, maHD);
                break;
            case 19:
                maHD = nameHD_AddGoiDV.concat(max);
                break;
            //case 25:
            //    maHD = nameHD_InsertHDSC.concat(max)
            //    break;
        }

        var ngaysudungGoiDV = null;
        var ngayhethanGoiDV = null;
        if (loaiHoaDon === 19) {
            ngaysudungGoiDV = moment(new Date()).format('DD/MM/YYYY');
            var nextYear = now.getFullYear() + 1;
            // default: het han sau 1 nam
            ngayhethanGoiDV = moment(new Date()).format('DD/MM') + '/' + nextYear;
        }
        var idRandom = CreateIDRandom('HD_');
        return obj = {
            ID: const_GuidEmpty,
            LoaiHoaDon: loaiHoaDon, // HD ban le
            IDRandom: idRandom,
            MaHoaDon: maHD,
            MaHoaDonDB: null,
            ID_HoaDon: null,
            ID_DoiTuong: null,
            ID_ViTri: null,
            NguoiTao: userLogin,
            ID_BangGia: const_GuidEmpty,
            ID_NhanVien: _idNhanVien,
            ID_DonVi: id_DonVi,
            NgayLapHoaDon: null,
            DienGiai: '',
            DVTinhGiam: '%',
            ChoThanhToan: false,
            KhuyenMai_GhiChu: '',
            NgayApDungGoiDV: ngaysudungGoiDV,
            HanSuDungGoiDV: ngayhethanGoiDV,
            DiemGiaoDich: 0,

            TongTienHang: 0,
            PhaiThanhToan: 0,
            TongChietKhau: 0,
            TongGiamGia: 0,
            DaThanhToan: 0,
            KhachDaTra: 0, // tienkhachtra truoc
            BaoHiemDaTra: 0,
            PTThueHoaDon: 0,
            TongTienThue: 0,
            PTThueBaoHiem: 0,
            TongTienThueBaoHiem: 0,
            PTGiam_KM: 0,
            KhuyeMai_GiamGia: 0,
            TongGiamGiaKM_HD: 0,

            TongTienTra: 0,
            TongTienMua: 0,
            TongGiaGocHangTra: 0,
            TongChiPhi: 0,
            TongChiPhiHangTra: 0,
            HoanTraThuKhac: 0,
            PhaiThanhToanDB: 0,// phaitt hdmua: use at TraHang
            PTGiamDB: 0,
            TongGiamGiaDB: 0,
            TongThueDB: 0,
            PTThueDB: 0,
            HoanTraTamUng: 0,  // when tongtra > tongmua
            DaTraKhach: 0,
            PhaiTraKhach: 0,
            GiaoHang: false,

            Status: 1, // open(1) - close(0) : use HDOffline
            StatusOffline: false,
            TienMat: 0,
            TienATM: 0, // quyet the ATM
            TienGui: 0, // chuyen khoan Ngan hang
            TienTheGiaTri: 0,// TT qua thegiatri
            TTBangDiem: 0, // tien KH thanh toan = diem --> save in Quy_HoaDon_ChiTiet
            DiemQuyDoi: 0, // so diem quy doi tu tien --> save in Quy_HoaDon_ChiTiet
            TienThua: 0,
            ID_TaiKhoanPos: null, // in DM_TaiKhoanNganHang
            ID_TaiKhoanChuyenKhoan: null,
            BH_NhanVienThucHiens: [],
            ID_NhomDTApplySale: null,  // giam gia HD theo nhom

            TrangThaiHD: 1, // 1.New, 3.TamLuu, 4.DaThanhToan xong, 6.HDDatHang DH00, 7.HDTam Da dc xoa, 8. capnhat CTHD
            IsActive: '',
            YeuCau: "1", // 1.Tam, 2.Dang giao, 3.HThanh, 4.Huy
            IsKhuyenMaiHD: false,
            IsOpeningKMaiHD: false,
            DiemKhuyenMai: 0,

            DiemHienTai: 0, // = diem hien tai of KH - DiemQuyDoi --> save in DM_DoiTuong
            DiemCong: 0,   // use when KM_Cong diem
            DiemGiaoDichDB: 0, // updateHD: tru diem giaodich HD cu

            CreateTime: 0, // bắt đầu chọn bàn (phòng) lúc HH:mm
            ThoiGianThucHien: 0,// = total time doing service 
            TenViTriHD: '',
            TenNhanVien: self.titleNhanvien(),// send to Pos_display
            TenGiaBan: 'Bảng giá chuẩn',

            MaPhieuTiepNhan: '',
            ID_PhieuTiepNhan: null,
            ID_BaoHiem: null,

            LienHeBaoHiem: '',
            SoDienThoaiLienHeBaoHiem: '',
            PhaiThanhToanBaoHiem: 0,
            ChiPhi_GhiChu: '',
            TongThanhToan: 0,
            TenBaoHiem: '',
            XuatKhoAll: false,
            DuyetBaoGia: false,

            PTChietKhauHH: 0,
            TongGiamGiaHang: 0,
            TongTienHangChuaCK: 0,
            TongTienKhuyenMai_CT: 0,
            TongGiamGiaKhuyenMai_CT: 0,
            SoDuDatCoc: 0,

            SoVuBaoHiem: '',
            KhauTruTheoVu: 0,
            GiamTruBoiThuong: 0,
            PTGiamTruBoiThuong: 0,
            TongTienThueBaoHiem: 0,
            PTThueBaoHiem: 0,
            PTThueHoaDon: 0,
            BHThanhToanTruocThue: 0,
            TongTienBHDuyet: 0,
            CongThucBaoHiem: 0,
            TongThueKhachHang: 0,
            PTThueKhachHang: 0,
            GiamTruThanhToanBaoHiem: 0,
            HeaderBH_Type: 1,
            HeaderBH_GiaTriPtram: 0,
            ID_Xe: null,
            BienSo: '',
        }
    }
    function newHoaDonTraHang(item, maHDTra) {
        var ngaylapHD = moment(new Date()).format("YYYY-MM-DD HH:mm");
        ngaylapHD = null;
        var idRandom = CreateIDRandom('HD_');
        if (item === null) {
            return obj = {
                LoaiHoaDon: 6,
                IDRandom: idRandom,
                MaHoaDon: maHDTra,
                MaHoaDonDB: null,
                MaHoaDonTraHang: '',
                ID: const_GuidEmpty,
                ID_HoaDon: null, // ID hoa don tra
                ID_DoiTuong: null,
                ID_BangGia: const_GuidEmpty,
                NguoiTao: userLogin,
                ID_DonVi: id_DonVi,
                ID_NhanVien: _idNhanVien,
                NgayLapHoaDon: ngaylapHD,
                TongTienHang: 0,
                PhaiThanhToan: 0,
                TongGiamGia: 0,
                DaThanhToan: 0,
                PTThueHoaDon: 0,
                TongTienThue: 0,
                PTThueBaoHiem: 0,
                TongTienThueBaoHiem: 0,
                ChoThanhToan: false,
                DienGiai: '',
                DVTinhGiam: '%',
                TongChietKhau: 0,
                Status: 1, // open(1) - close(0) : use HDOffline
                StatusOffline: false,
                TienMat: 0,
                TienATM: 0,
                TienGui: 0,
                TienTheGiaTri: 0,
                TienThua: 0,
                ID_TaiKhoanPos: null,
                ID_TaiKhoanChuyenKhoan: null,
                BH_NhanVienThucHiens: [],
                ID_NhomDTApplySale: null, // giam gia HD theo nhom
                // Tra Hang
                PhaiThanhToanDB: 0,
                TongGiaGocHangTra: 0,
                TongChiPhi: 0,
                TongChiPhiHangTra: 0,
                HoanTraThuKhac: 0,
                TongTienTra: 0,
                PhaiTraKhach: 0,
                DaTraKhach: 0,
                GiaoHang: false,
                MaHoaDonTH_NVien: nameHD_TraHang,
                TongGiamGiaDB: 0,
                PTGiamDB: 0,
                TongThueDB: 0,
                PTThueDB: 0,
                TongTienMua: 0, // = TongTienHang - GiamGia (HD Tra_MuaMoi)
                TrangThaiHD: 1,
                IsActive: '',
                KhachDaTra: 0,
                BaoHiemDaTra: 0,
                HoanTraTamUng: 0,
                IsKhuyenMaiHD: false, // co khuyen mai hay khong
                IsOpeningKMaiHD: false, // KM da duoc mo
                PTGiam_KM: 0,
                KhuyeMai_GiamGia: 0,
                TongGiamGiaKM_HD: 0,
                KhuyenMai_GhiChu: '',
                FromHDTichDiem: false, // tra tu HD co diem giao dich > 0
                DiemKhuyenMai: 0,
                // TichDiem
                DiemGiaoDich: 0, // save in HoaDon
                TTBangDiem: 0, // tien KH thanh toan = diem --> save in Quy_HoaDon_ChiTiet
                DiemQuyDoi: 0, // so diem quy doi tu tien --> save in Quy_HoaDon_ChiTiet
                DiemHienTai: 0, // = diem hien tai of KH - DiemQuyDoi --> save in DM_DoiTuong
                DiemCong: 0,  // use when KM_Cong diem
                DiemGiaoDichDB: 0,
                // Goi dich vu
                NgayApDungGoiDV: null,
                HanSuDungGoiDV: null,
                CreateTime: 0, // bắt đầu chọn bàn, phòng lúc HH:mm
                ID_ViTri: null,
                ThoiGianThucHien: 0,
                TenViTriHD: '',
                TenNhanVien: self.titleNhanvien(),

                MaPhieuTiepNhan: '',
                ID_PhieuTiepNhan: null,
                ID_BaoHiem: null,
                LienHeBaoHiem: '',
                SoDienThoaiLienHeBaoHiem: '',
                PhaiThanhToanBaoHiem: 0,
                ChiPhi: 0,
                ChiPhi_GhiChu: '',
                TongThanhToan: 0,
                TenBaoHiem: '',
                XuatKhoAll: false,
                DuyetBaoGia: false,

                PTChietKhauHH: 0,
                TongGiamGiaHang: 0,
                TongTienHangChuaCK: 0,
                TongTienKhuyenMai_CT: 0,
                TongGiamGiaKhuyenMai_CT: 0,
                SoDuDatCoc: 0,

                SoVuBaoHiem: '',
                KhauTruTheoVu: 0,
                GiamTruBoiThuong: 0,
                PTGiamTruBoiThuong: 0,
                TongTienThueBaoHiem: 0,
                PTThueBaoHiem: 0,
                PTThueHoaDon: 0,
                BHThanhToanTruocThue: 0,
                TongTienBHDuyet: 0,
                CongThucBaoHiem: 0,
                TongThueKhachHang: 0,
                PTThueKhachHang: 0,
                GiamTruThanhToanBaoHiem: 0,
                HeaderBH_Type: 1,
                HeaderBH_GiaTriPtram: 0,
                ID_Xe: null,
                BienSo: '',
            }
        }
        else {
            var fromHDTichDiem = false;
            if (item.DiemGiaoDich !== null && item.DiemGiaoDich > 0) {
                fromHDTichDiem = true;
            }
            // neu tra goi DV
            var sNameMaHD = nameHD_TraHang;
            var ngaysudungGoiDV = null;
            var ngayhethanGoiDV = null;
            if (maHDTra.indexOf('DV') > -1) {
                sNameMaHD = ' Trả ';
                ngaysudungGoiDV = moment(new Date()).format('DD/MM/YYYY');
                var nextYear = now.getFullYear() + 1;
                ngayhethanGoiDV = moment(new Date()).format('DD/MM') + '/' + nextYear;
            }
            var ckHoaDon = item.TongChietKhau;
            if (ckHoaDon === 0) {
                ckHoaDon = item.TongGiamGia / (item.PhaiThanhToan + item.TongGiamGia) * 100;
            }
            // use tinh PTThue HD
            return obj = {
                LoaiHoaDon: 6,
                IDRandom: idRandom,
                MaHoaDon: maHDTra,
                MaHoaDonDB: null,
                MaHoaDonTraHang: item.MaHoaDon,
                ID: const_GuidEmpty,
                ID_HoaDon: item.ID, // ID hoa don tra
                ID_DoiTuong: item.ID_DoiTuong,
                ID_BangGia: item.ID_BangGia,
                ID_NhanVien: item.ID_NhanVien,
                ID_DonVi: item.ID_DonVi,
                NguoiTao: userLogin,
                NgayLapHoaDon: ngaylapHD,
                NgayLapHD_ofHDGoc: moment(item.NgayLapHoaDon).format("YYYY-MM-DD HH:mm"), // used to compare (NgayTra, NgayMua)
                TongTienHang: 0,
                PhaiThanhToan: 0,
                TongGiamGia: 0,
                DaThanhToan: 0,
                PTThueHoaDon: 0,
                TongTienThue: 0,
                PTThueBaoHiem: 0,
                TongTienThueBaoHiem: 0,
                ChoThanhToan: false,
                DienGiai: item.DienGiai,
                DVTinhGiam: '%',
                TongChietKhau: 0, // PTGiam
                Status: 1,
                StatusOffline: false,
                TienMat: 0,
                TienATM: 0,
                TienGui: 0,
                TienThua: 0,
                ID_TaiKhoanPos: null,
                ID_TaiKhoanChuyenKhoan: null,
                BH_NhanVienThucHiens: [],
                ID_NhomDTApplySale: null, // giam gia HD theo nhom
                // Tra Hang
                PhaiThanhToanDB: 0,
                TongGiaGocHangTra: 0,
                TongChiPhi: 0,
                TongChiPhiHangTra: 0,
                HoanTraThuKhac: 0,
                TongTienTra: 0,
                PhaiTraKhach: 0,
                DaTraKhach: 0,
                GiaoHang: false,
                MaHoaDonTH_NVien: sNameMaHD + item.MaHoaDon + ' - ' + item.TenNhanVien,
                TongGiamGiaDB: 0,
                PTGiamDB: ckHoaDon,
                PTThueDB: item.PTThueHoaDon,
                TongThueDB: 0,
                TrangThaiHD: 1,
                IsActive: '',
                KhachDaTra: 0, // display when click XuLiDonHang
                BaoHiemDaTra: 0,
                HoanTraTamUng: 0,
                IsKhuyenMaiHD: false,
                IsOpeningKMaiHD: false, // KM da duoc mo
                PTGiam_KM: 0,
                KhuyeMai_GiamGia: 0,
                TongGiamGiaKM_HD: 0,
                KhuyenMai_GhiChu: '',
                FromHDTichDiem: fromHDTichDiem, // tra tu HD co diem giao dich > 0
                // TichDiem
                DiemGiaoDich: 0, // save in HoaDon
                TTBangDiem: 0, // tien KH thanh toan = diem --> save in Quy_HoaDon_ChiTiet
                DiemQuyDoi: 0, // so diem quy doi tu tien --> save in Quy_HoaDon_ChiTiet
                DiemHienTai: 0, // = diem hien tai of KH - DiemQuyDoi --> save in DM_DoiTuong
                DiemCong: 0,// use when KM_Cong diem  = diemHD + diemHH
                DiemKhuyenMai: 0,
                DiemGiaoDichDB: item.DiemGiaoDich,
                // Goi dich vu
                NgayApDungGoiDV: ngaysudungGoiDV,
                HanSuDungGoiDV: ngayhethanGoiDV,
                CreateTime: 0, // bắt đầu chọn bàn, phòng lúc HH:mm
                ID_ViTri: item.ID_ViTri,
                TienTheGiaTri: 0,
                ThoiGianThucHien: 0,
                TenViTriHD: '',
                TenNhanVien: item.TenNhanVien,

                MaPhieuTiepNhan: item.MaPhieuTiepNhan,
                ID_PhieuTiepNhan: item.ID_PhieuTiepNhan,
                ID_BaoHiem: null,
                LienHeBaoHiem: item.LienHeBaoHiem,
                SoDienThoaiLienHeBaoHiem: item.SoDienThoaiLienHeBaoHiem,
                PhaiThanhToanBaoHiem: 0,
                ChiPhi: 0,
                ChiPhi_GhiChu: '',
                TongThanhToan: 0,
                TenBaoHiem: '',
                XuatKhoAll: false,
                DuyetBaoGia: false,

                PTChietKhauHH: 0,
                TongGiamGiaHang: 0,
                TongTienHangChuaCK: 0,
                TongTienKhuyenMai_CT: 0,
                TongGiamGiaKhuyenMai_CT: 0,
                SoDuDatCoc: 0,

                SoVuBaoHiem: '',
                KhauTruTheoVu: 0,
                GiamTruBoiThuong: 0,
                PTGiamTruBoiThuong: 0,
                TongTienThueBaoHiem: 0,
                PTThueBaoHiem: 0,
                PTThueHoaDon: 0,
                BHThanhToanTruocThue: 0,
                TongTienBHDuyet: 0,
                CongThucBaoHiem: 0,
                TongThueKhachHang: 0,
                PTThueKhachHang: 0,
                GiamTruThanhToanBaoHiem: 0,
                HeaderBH_Type: 1,
                HeaderBH_GiaTriPtram: 0,
                ID_Xe: item.ID_Xe,
                BienSo: item.BienSo,
            }
        }
    }

    self.arrFilterGiaBan = ko.computed(function () {
        var _filter = self.filterGiaBan();
        return arrFilter = ko.utils.arrayFilter(self.GiaBans(), function (prod) {
            var chon = true;
            var arr = locdau(prod.TenGiaBan).split(/\s+/);
            var sSearch = '';
            for (let i = 0; i < arr.length; i++) {
                sSearch += arr[i].toString().split('')[0];
            }
            if (chon && _filter) {
                chon = (locdau(prod.TenGiaBan).indexOf(locdau(_filter)) > -1 ||
                    sSearch.indexOf(locdau(_filter).toLowerCase()) > -1
                );
            }
            return chon;
        });
    });
    self.arrFilterNhanVien = ko.computed(function () {
        var _filter = self.filterNVien();
        return arrFilter = ko.utils.arrayFilter(self.NhanViens(), function (prod) {
            var chon = true;
            var arr = locdau(prod.TenNhanVien).split(/\s+/);
            var sSearch = '';
            for (let i = 0; i < arr.length; i++) {
                sSearch += arr[i].toString().split('')[0];
            }
            if (chon && _filter) {
                chon = (locdau(prod.TenNhanVien).indexOf(locdau(_filter)) > -1 ||
                    sSearch.indexOf(locdau(_filter)) > -1
                );
            }
            return chon;
        });
    });
    // KhachHang
    self.ValidateEmail = function (item) {
        if (item.Email() !== '' && item.Email() !== undefined && item.Email() !== null) {
            var re = /^(([^<>()[\]\\.,;:\s@#ẮẰẲẴẶĂẤẦẨẪẬÂÁÀÃẢẠĐẾỀỂỄỆÊÉÈẺẼẸÍÌỈĨỊỐỒỔỖỘÔỚỜỞỠỢƠÓÒÕỎỌỨỪỬỮỰƯÚÙỦŨỤÝỲỶỸỴ"]+(\.[^<>()[\]\\.,;:\s@#ẮẰẲẴẶĂẤẦẨẪẬÂÁÀÃẢẠĐẾỀỂỄỆÊÉÈẺẼẸÍÌỈĨỊỐỒỔỖỘÔỚỜỞỠỢƠÓÒÕỎỌỨỪỬỮỰƯÚÙỦŨỤÝỲỶỸỴ"]+)*)|(".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/i;
            var valReturn = re.test(item.Email().trim());
            if (valReturn === false) {
                ShowMessage_Danger('Email không hợp lệ');
                self.checkEmail(false);
            }
            else {
                self.checkEmail(true);
            }
        }
    }

    self.filterDoiTuong = function (item, inputString) {
        var itemSearch = locdau(item.TenDoiTuong);
        var itemSearch2 = locdau(item.MaDoiTuong);
        var locdauInput = locdau(inputString);
        // nen bat chat khong cho nhap dau cach o MaKH
        var arr = itemSearch.split(/\s+/);
        var sThreechars = '';
        for (let i = 0; i < arr.length; i++) {
            sThreechars += arr[i].toString().split('')[0];
        }
        return itemSearch.indexOf(locdauInput) > -1 || itemSearch2.indexOf(locdauInput) > -1 ||
            sThreechars.indexOf(locdauInput) > -1;
    }
    self.filterNhanVien = function (item, inputString) {
        var itemSearch = locdau(item.TenNhanVien);
        var itemSearch2 = locdau(item.MaNhanVien);
        var locdauInput = locdau(inputString);
        var arr = itemSearch.split(/\s+/);
        var sThreechars = '';
        for (let i = 0; i < arr.length; i++) {
            sThreechars += arr[i].toString().split('')[0];
        }
        return itemSearch.indexOf(locdauInput) > -1 || itemSearch2.indexOf(locdauInput) > -1 ||
            sThreechars.indexOf(locdauInput) > -1;
    }
    self.filterNguonKH = function (item, inputString) {
        var itemSearch = locdau(item.TenNguonKhach);
        var locdauInput = locdau(inputString);
        var arr = itemSearch.split(/\s+/);
        var sThreechars = '';
        for (let i = 0; i < arr.length; i++) {
            sThreechars += arr[i].toString().split('')[0];
        }
        return itemSearch.indexOf(locdauInput) > -1 ||
            sThreechars.indexOf(locdauInput) > -1;
    }
    self.filterProvince = function (item, inputString) {
        var itemSearch = locdau(item.TenTinhThanh);
        var locdauInput = locdau(inputString);
        var arr = itemSearch.split(/\s+/);
        var sThreechars = '';
        for (let i = 0; i < arr.length; i++) {
            sThreechars += arr[i].toString().split('')[0];
        }
        return itemSearch.indexOf(locdauInput) > -1 ||
            sThreechars.indexOf(locdauInput) > -1;
    }
    self.filterDistrict = function (item, inputString) {
        var itemSearch = locdau(item.TenQuanHuyen);
        var locdauInput = locdau(inputString);
        var arr = itemSearch.split(/\s+/);
        var sThreechars = '';
        for (let i = 0; i < arr.length; i++) {
            sThreechars += arr[i].toString().split('')[0];
        }
        return itemSearch.indexOf(locdauInput) > -1 ||
            sThreechars.indexOf(locdauInput) > -1;
    }

    self.mouseoutTenThayThe = function (item) {
        var $this = $(event.currentTarget);
        var txt = Remove_LastComma($this.val());
        if (txt === '') {
            txt = item.TenHangHoa;
            $this.val(txt);
        }
    }

    self.editTenThayThe = function (item, isDoiTra = false) {
        var $this = $(event.currentTarget);
        var txt = Remove_LastComma($this.val());
        if (txt === '') {
            txt = item.TenHangHoa;
        }

        var idRandom = item.IDRandom;
        var quanLiTheoLo = item.QuanLyTheoLoHang;
        var concungloai = item.LaConCungLoai;

        var cacheName = lcListCTHD;
        if (isDoiTra) {
            cacheName = lcListCTHD_DoiTra;
        }

        var cthd = localStorage.getItem(cacheName);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            if (quanLiTheoLo) {
                if (item.LotParent) {
                    for (let i = 0; i < cthd.length; i++) {
                        if (cthd[i].IDRandom === idRandom) {
                            cthd[i].TenHangHoaThayThe = txt;
                            for (let j = 0; j < cthd[i].DM_LoHang.length; j++) {
                                cthd[i].DM_LoHang[j].TenHangHoaThayThe = txt;
                            }
                            break;
                        }
                    }
                }
                else {
                    for (let i = 0; i < cthd.length; i++) {
                        for (let j = 0; j < cthd[i].DM_LoHang.length; j++) {
                            if (cthd[i].DM_LoHang[j].IDRandom === idRandom) {
                                cthd[i].DM_LoHang[j].TenHangHoaThayThe = txt;
                                break;
                            }
                        }
                    }
                }
            }
            else {
                if (concungloai) {
                    for (let i = 0; i < cthd.length; i++) {
                        for (let j = 0; j < cthd[i].HangCungLoais.length; j++) {
                            if (cthd[i].HangCungLoais[j].IDRandom === idRandom) {
                                cthd[i].HangCungLoais[j].TenHangHoaThayThe = txt;
                                break;
                            }
                        }
                    }
                }
                else {
                    for (let i = 0; i < cthd.length; i++) {
                        if (cthd[i].IDRandom === idRandom) {
                            cthd[i].TenHangHoaThayThe = txt;
                            break;
                        }
                    }
                }
            }
        }
        localStorage.setItem(cacheName, JSON.stringify(cthd));

        Enter_SoLuongPriceCTHD(item, event, 'ten_', 2);
    }

    self.editSoluong = function (item) {
        _maHoaDon = item.MaHoaDon;
        var idRandomHD = item.IDRandomHD;
        var rowID = item.ID_DonViQuiDoi;
        var idRandom = item.IDRandom;

        var thisObj = $(event.currentTarget);
        formatNumberObj(thisObj); // 000,000
        var objThanhTien = $('#sum-f_' + idRandom);

        var thanhtien = 0;
        var priceAfterSale = 0;
        var loaiHD = 1;
        var ctDoing = FindCTHD_isDoing(item, false);
        if (ctDoing !== null) {
            loaiHD = ctDoing.LoaiHoaDon;

            // get ID_KhuyenMai from CTHD
            var cthd = localStorage.getItem(lcListCTHD);
            if (cthd !== null) {
                cthd = JSON.parse(cthd);
                let thisItem = $.grep(cthd, function (x) {
                    return x.IDRandom === idRandom;
                });
                if (thisItem.length > 0) {
                    if (thisItem[0].ID_KhuyenMai !== null && thisItem[0].ID_KhuyenMai !== undefined) {
                        // neu truoc do co khuyen mai, reset TienChietKhau = 0
                        ctDoing.TienChietKhau = 0;
                        $('#btn_sale_' + idRandom).text(0)
                    }
                }
            }
            priceAfterSale = formatNumberToFloat(ctDoing.GiaBan) - formatNumberToFloat(ctDoing.TienChietKhau)
                + formatNumberToFloat(ctDoing.TienThue);

            // if clear soluong --> default = 0
            var newNumber = formatNumberToFloat(thisObj.val());
            var sluongOld = newNumber;
            var keyCode = event.keyCode || event.which;
            // press up
            if (keyCode === 38) {
                newNumber = sluongOld + 1;
                thisObj.val(formatNumber3Digit(newNumber));
            }
            // press down
            if (keyCode === 40) {
                if (sluongOld > 1) {
                    newNumber = sluongOld - 1;
                }
                thisObj.val(formatNumber3Digit(newNumber));
            }
            // check so luong dich vu > so luong con lai trong goi
            var check = Check_Enought_SoLuongConLai_ServicePackage(item, newNumber);
            if (check !== '') {
                // nhap quá --> reset ve soluong bandau
                thisObj.val(item.SoLuong);
                ShowMessage_Danger(check);
                return false;
            }
            // check CongNo when use service
            //if (idCT_goiDV !== null) {
            //    check = CheckCongNo_GoiDV_whenChangeSoLuong(item, newNumber);
            //    if (check === false) {
            //        return check;
            //    }
            //}

            //get itemHD --> check LoaiHoaDon
            if (loaiHD === 6 && self.HoaDons().ID_HoaDon() !== null) {
                // trahang tu HDMua --> chi nhap toida = soluongmua
                if (newNumber > this.SoLuongDaMua) {
                    thisObj.val(this.SoLuongDaMua);
                    newNumber = this.SoLuongDaMua;
                }
            }
            thanhtien = priceAfterSale * newNumber;
            ctDoing.ThanhToan = thanhtien;
            ctDoing.ThanhTien = (ctDoing.GiaBan - ctDoing.TienChietKhau) * newNumber;
            ctDoing.SoLuong = newNumber;

            // not bind ThanhTien if use GoiDV
            if (item.ChatLieu !== '4' || loaiHD === 6) {
                objThanhTien.val(formatNumber3Digit(thanhtien));
                objThanhTien.text(formatNumber3Digit(thanhtien)); // use for lable
            }
            // update ds cache cthoadon
            var cthd = localStorage.getItem(lcListCTHD);
            if (cthd !== null) {
                cthd = JSON.parse(cthd);
                cthd = updateCTHDLe(cthd, ctDoing);
                localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
            }
            UpdateWarning_forCTHD_byIDQuiDoi(rowID, idRandomHD);
            ChangeSoLuong_UpdateSLQuyCach(item, false, item.QuyCach, newNumber);
            UpdateSoLuong_TPDinhLuong_ofCTHD(idRandomHD, idRandom, newNumber, false);
            UpdateChietKhauNV_inCTHD(idRandom, false, ctDoing);
            ShowHideWarning_forCTHD_byIDQuiDoi(idRandomHD, rowID, idRandom);
            if (loaiHD === 6) {
                if (item.ThanhPhanComBo.length > 0) {
                    ChangeSoLuongParent_UpdateCombo(idRandom, newNumber, false);
                }
                UpdateHD_TraHang(idRandomHD);
            }
            else {
                if (ctDoing.DonGiaBaoHiem > 0) {
                    UpdateInforBaoHiem(idRandomHD);
                }
                ResetKM_HangHoa_ByIDQuiDoi_orNhomHang(rowID, item.ID_NhomHangHoa, idRandomHD);
                ResetKM_HoaDon(idRandomHD);
                UpdateCacheHDLe(idRandomHD, false);
                UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();
                self.KM_KMApDung([]);
                UpdateKhuyenMai_CTHD(rowID, idRandomHD);
                // update status change = true for HDDatHang dang XuLy
                if (loaiHD === 3) {
                    Update_StatusXuLy_ofHDDatHang(idRandomHD);
                }
                if (item.ThanhPhanComBo.length > 0) {
                    for (let k = 0; k < ctDoing.ThanhPhanComBo.length; k++) {
                        let tpCombo = ctDoing.ThanhPhanComBo[k];
                        TangGiamSoLuong_updatePhiDichVu(tpCombo, tpCombo.SoLuongMacDinh * newNumber, false);
                    }
                    ChangeSoLuongParent_UpdateCombo(idRandom, newNumber, false, 1);
                }
                else {
                    TangGiamSoLuong_updatePhiDichVu(ctDoing, ctDoing.SoLuong, false);
                }
            }
            BindHD_byIDRandom(idRandomHD);
            Caculator_AmountProduct();
            // bind soluongQuyCach
            var objQC = $('#quycach_' + idRandom);
            if (parseFloat(objQC.text()) !== 0) {
                var soluongQuyCach = item.QuyCach * newNumber;
                objQC.text(formatNumber3Digit(soluongQuyCach));
            }
        }
        Enter_SoLuongPriceCTHD(item, event, 'munber_', 1);
        Shift_SoLuongPriceCTHD(item, event, 'munber_', 1, 16);
        ArrowRight_CTHD(item, event);
        ArrowLeft_CTHD(item, event);
    }
    self.editSale = function (item, e) {
        var sumTemp = 0;
        var rowID = item.ID_DonViQuiDoi;
        var idRandom = item.IDRandom;
        var idRandomHD = item.IDRandomHD;

        var thisObj = $(event.currentTarget); // input nhap giam gia
        var priceOld = item.GiaBan;
        var tienGiam = 0;
        var ptGiam = 0;

        var ctDoing = FindCTHD_isDoing(item, false);
        if (ctDoing !== null) {
            priceOld = ctDoing.GiaBan;
            ptGiam = ctDoing.PTChietKhau;
            tienGiam = ctDoing.TienChietKhau;

            if (!commonStatisJs.CheckNull(ctDoing.ID_ChiTietGoiDV) && parseInt(ctDoing.ChatLieu) === 4) {
                ShowMessage_Danger('Dịch vụ thuộc gói đã mua. Không thay đổi chiết khấu');
                if (ptGiam > 0) {
                    thisObj.val(ptGiam);
                }
                else {
                    thisObj.val(formatNumber3Digit(tienGiam));
                }
                return;
            }

            // neu gia cu = 0 => khong cho phep nhap giam gia
            if (priceOld === 0) {
                thisObj.val(0);
            }
            else {
                // format 000,000,000
                formatNumberObj(thisObj);
                var valThis = thisObj.val();
                if (valThis === '') {
                    valThis = 0;
                }
                if ($('#vnd_' + idRandom).hasClass('active-re')) {
                    // neu giam gia > 100 %
                    if (formatNumberToFloat(valThis) > 100) {
                        thisObj.val(100);
                        valThis = 100;
                    }
                    tienGiam = priceOld * parseFloat(valThis) / 100;
                    ptGiam = parseFloat(valThis);
                }
                else {
                    // neu giam gia > gia cu
                    if (formatNumberToInt(valThis) > priceOld) {
                        thisObj.val(formatNumber3Digit(priceOld));
                        valThis = priceOld;
                    }
                    tienGiam = formatNumberToInt(valThis);
                }
                var giasauCK = priceOld - tienGiam;
                if (ctDoing.PTThue > 0) {
                    ctDoing.TienThue = ctDoing.PTThue * giasauCK / 100;
                }
                sumTemp = (priceOld - tienGiam + ctDoing.TienThue) * ctDoing.SoLuong;
            }
            ctDoing.PTChietKhau = ptGiam;
            ctDoing.TienChietKhau = tienGiam;
            ctDoing.ThanhToan = sumTemp;
            ctDoing.ThanhTien = (priceOld - tienGiam) * ctDoing.SoLuong;

            $('#sum-f_' + idRandom).val(formatNumber3Digit(sumTemp));
            $('#ck_' + idRandom).text(formatNumber3Digit(tienGiam));
            $('#tax_' + idRandom).text(formatNumber3Digit(ctDoing.TienThue));
            $('#ck_' + idRandom).parent().css('display', tienGiam > 0 ? '' : 'none');
            $('#tax_' + idRandom).parent().css('display', ctDoing.TienThue > 0 ? '' : 'none');

            var cthd = localStorage.getItem(lcListCTHD);
            if (cthd === null) {
                cthd = [];
            }
            else {
                cthd = JSON.parse(cthd);
            }
            cthd = updateCTHDLe(cthd, ctDoing);
            localStorage.setItem(lcListCTHD, JSON.stringify(cthd));

            UpdateChietKhauNV_inCTHD(idRandom, false, ctDoing);
            if (this.MaHoaDon.indexOf('Trả') > -1) {
                UpdateHD_TraHang(idRandomHD);
            }
            else {
                ResetKM_HangHoa_ByIDQuiDoi_orNhomHang(rowID, item.ID_NhomHangHoa, idRandomHD);
                ResetKM_HoaDon(idRandomHD);
                if (self.HoaDons().HeaderBH_GiaTriPtram() > 0 && self.HoaDons().HeaderBH_Type() === 1) {
                    UpdateDonGiaBaoHiem_byHeaderBH(ctDoing.IDRandom, ctDoing);
                    UpdateInforBaoHiem(idRandomHD);
                }
                UpdateCacheHDLe(idRandomHD, false, 3);
                UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();
                self.KM_KMApDung([]);
                UpdateKhuyenMai_CTHD(rowID, idRandomHD);
                if (item.LoaiHoaDon === 3) {
                    Update_StatusXuLy_ofHDDatHang(idRandomHD);
                }
            }
            BindHD_byIDRandom(idRandomHD);
            ArrowRight_CTHD(item, event);
            ArrowLeft_CTHD(item, event);
            // hide div giam gia && focus text ThanhToan
            var key = e.keyCode || e.which;
            if (key === 13 || key === 27) {
                $('#callprice_' + idRandom).toggle();
                if ($('.cantrakhach').css('display') === "none") {
                    $('#txtDaThanhToan').select();
                }
                else {
                    $('#txtDaTraKhach').select();
                }
            }
        }
    }

    //var timeoutPrice = null;
    //self.editPrice = function (item, e) {
    //    if (timeoutPrice != null) {
    //        clearTimeout(timeoutPrice);
    //    }
    //    timeoutPrice = setTimeout(function () {
    //        timeoutPrice = null;
    //        console.log(2)
    //        self.editPrice_Exe(item, e);
    //    }, 100);  
    //}

    self.editPrice = function (item, event) {
        var thisObj = $(event.currentTarget);
        formatNumberObj(thisObj);
        var priceNew = formatNumberToFloat(thisObj.val());

        var objID = item.ID_DonViQuiDoi;
        var idRandom = item.IDRandom;
        var idRandomHD = item.IDRandomHD;

        var sum = 0;
        var sum_f = $('#sum-f_' + idRandom);

        // get infor from CTHD old
        var ctDoing = FindCTHD_isDoing(item, false);
        if (ctDoing !== null) {
            let tienGiam = ctDoing.TienChietKhau;
            let tienThue = ctDoing.TienThue;

            if (!commonStatisJs.CheckNull(ctDoing.ID_ChiTietGoiDV) && parseInt(ctDoing.ChatLieu) === 4) {
                ShowMessage_Danger('Dịch vụ thuộc gói đã mua. Không thay đổi đơn giá');
                thisObj.val(formatNumber3Digit(ctDoing.GiaBan));
                return;
            }

            // is clear price
            if (thisObj.val() === '') {
                priceNew = 0;
                tienGiam = 0;
                tienThue = 0;
                ctDoing.PTChietKhau = self.HoaDons().PTChietKhauHH();
                ctDoing.PTThue = self.HoaDons().PTThueHoaDon();
            }
            // caculator again tienGiam, newPrice
            if (ctDoing.PTChietKhau > 0) {
                tienGiam =ctDoing.PTChietKhau * priceNew / 100;
            }
            if (ctDoing.PTThue > 0) {
                tienThue =ctDoing.PTThue * (priceNew - tienGiam) / 100;
            }
            sum = formatNumberToFloat(ctDoing.SoLuong) * (priceNew - tienGiam + tienThue);

            ctDoing.DonGia = priceNew;
            ctDoing.GiaBan = priceNew;
            ctDoing.TienChietKhau = tienGiam;
            ctDoing.TienThue = tienThue;
            ctDoing.ThanhToan = sum;
            ctDoing.ThanhTien = (priceNew - tienGiam) * ctDoing.SoLuong;
            sum_f.val(formatNumber3Digit(sum));
            $('#ck_' + idRandom).text(formatNumber3Digit(ctDoing.TienChietKhau));
            $('#tax_' + idRandom).text(formatNumber3Digit(ctDoing.TienThue));
            $('#ck_' + idRandom).parent().css('display', tienGiam > 0 ? '' : 'none');
            $('#tax_' + idRandom).parent().css('display', tienThue > 0 ? '' : 'none');

            // update ds cache cthoadon
            var cthd = localStorage.getItem(lcListCTHD);
            if (cthd !== null) {
                cthd = JSON.parse(cthd);
                cthd = updateCTHDLe(cthd, ctDoing);
                localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
            }
            UpdateChietKhauNV_inCTHD(idRandom, false, ctDoing);
            if (item.MaHoaDon.indexOf('Trả') > -1) {
                UpdateHD_TraHang(idRandomHD);
            }
            else {
                // reset KM of HangHoa, but not bind CTHD
                ResetKM_HangHoa_ByIDQuiDoi_orNhomHang(objID, item.ID_NhomHangHoa, idRandomHD);
                ResetKM_HoaDon(idRandomHD);
                if (self.HoaDons().HeaderBH_GiaTriPtram() > 0) {
                    UpdateDonGiaBaoHiem_byHeaderBH(ctDoing.IDRandom, ctDoing);
                    UpdateInforBaoHiem(idRandomHD);
                }
                UpdateCacheHDLe(idRandomHD, false);
                UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();
                self.KM_KMApDung([]);
                UpdateKhuyenMai_CTHD(objID, idRandomHD);
                // update status change = true for HDDatHang dang XuLy
                if (item.LoaiHoaDon === 3) {
                    Update_StatusXuLy_ofHDDatHang(idRandomHD);
                }
            }
        }
        BindHD_byIDRandom(idRandomHD);
        Enter_SoLuongPriceCTHD(item, event, '', 2);
        Shift_SoLuongPriceCTHD(item, event, '', 2, 16);
        ArrowRight_CTHD(item, event);
        ArrowLeft_CTHD(item, event);
    }

    function ResetPTChietKhauHH_PTThue(idRandomHD) {
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            for (let i = 0; i < lstHD.length; i++) {
                if (lstHD[i].IDRandom === idRandomHD) {
                    lstHD[i].PTChietKhauHH = 0;
                    lstHD[i].PTThueHoaDon = 0;
                    break;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(lstHD));
        }
    }

    self.editSumPrice = function (item) {
        var idRandom = item.IDRandom;
        var thisObj = $(event.currentTarget);
        formatNumberObj(thisObj);
        var objPrice = $('input[id =' + idRandom + ']');

        var idRandomHD = item.IDRandomHD;
        var objID = item.ID_DonViQuiDoi;

        var sumPrice = formatNumberToInt(thisObj.val());
        var priceNew = 0;
        var soluong = 1;
        var priceOld = 0;

        // get infor from CTHD old
        var ctDoing = FindCTHD_isDoing(item, false);
        if (ctDoing !== null) {
            priceOld = ctDoing.GiaBan;
            soluong = ctDoing.SoLuong;

            if (!commonStatisJs.CheckNull(ctDoing.ID_ChiTietGoiDV) && parseInt(ctDoing.ChatLieu) === 4) {
                ShowMessage_Danger('Dịch vụ thuộc gói đã mua. Không sửa thành tiền');
                thisObj.val(formatNumber3Digit(ctDoing.ThanhTien));
                return false;
            }

            // is clear price
            if (thisObj.val() === '') {
                valThis = 0;
            }

            if (soluong === 0) {
                // keep GiaBan, caculator again SoLuong
                soluong = sumPrice / priceOld;
                priceNew = priceOld;
                $('#munber_' + idRandom).val(formatNumber3Digit(soluong));
            }
            else {
                priceNew = Caculator_Price_byTienGiam(0, soluong, sumPrice);
                objPrice.val(formatNumber3Digit(priceNew));
            }
            // reset chietkhau, thue
            ctDoing.PTChietKhau = 0;
            ctDoing.TienChietKhau = 0;
            ctDoing.TienThue = 0;
            ctDoing.PTThue = 0;
            ctDoing.SoLuong = soluong;
            ctDoing.DonGia = priceNew;
            ctDoing.GiaBan = priceNew;
            ctDoing.ThanhToan = sumPrice;
            ctDoing.ThanhTien = sumPrice;
            $('#ck_' + idRandom).text(formatNumber3Digit(ctDoing.TienChietKhau));
            $('#tax_' + idRandom).text(formatNumber3Digit(ctDoing.TienThue));
            $('#ck_' + idRandom).parent().css('display', 'none');
            $('#tax_' + idRandom).parent().css('display', 'none');

            // update ds cache cthoadon
            var cthd = localStorage.getItem(lcListCTHD);
            if (cthd !== null) {
                cthd = JSON.parse(cthd);
                cthd = updateCTHDLe(cthd, ctDoing);
                localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
            }
            UpdateChietKhauNV_inCTHD(idRandom, false, ctDoing);
            if (this.MaHoaDon.indexOf('Trả') > -1) {
                UpdateHD_TraHang(idRandomHD);
            }
            else {
                ResetPTChietKhauHH_PTThue(idRandomHD);

                // reset KM of HangHoa, but not bind CTHD
                ResetKM_HangHoa_ByIDQuiDoi_orNhomHang(objID, item.ID_NhomHangHoa, idRandomHD);
                ResetKM_HoaDon(idRandomHD);
                if (self.HoaDons().HeaderBH_GiaTriPtram() > 0) {
                    UpdateDonGiaBaoHiem_byHeaderBH(ctDoing.IDRandom, ctDoing);
                    UpdateInforBaoHiem(idRandomHD);
                }
                UpdateCacheHDLe(idRandomHD, false);
                UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();
                self.KM_KMApDung([]);
                UpdateKhuyenMai_CTHD(objID, idRandomHD);
                if (item.LoaiHoaDon === 3) {
                    Update_StatusXuLy_ofHDDatHang(idRandomHD);
                }
            }
        }
        BindHD_byIDRandom(idRandomHD);
        Enter_SoLuongPriceCTHD(item, event, 'sum-f_', 3);
        ArrowRight_CTHD(item, event);
        ArrowLeft_CTHD(item, event);
    }

    self.Click_UseBaoHiem = function () {
        var nowUse = false;
        var $this = $(event.currentTarget);
        if ($this.is(':checked')) {
            nowUse = true;
        }
        if (commonStatisJs.CheckNull(nowUse && self.ThongTinPhieuTiepNhan().ID_BaoHiem)) {
            ShowMessage_Danger('Chưa khai báo thông tin bảo hiểm ở phiếu tiếp nhận');
            $this.prop('checked', false);
            return;
        }
        var lcHD = localStorage.getItem(lcListHD);
        if (lcHD !== null) {
            lcHD = JSON.parse(lcHD);
            var idRandomHD = self.HoaDons().IDRandom();

            for (let i = 0; i < lcHD.length; i++) {
                if (lcHD[i].IDRandom === idRandomHD) {
                    if (!nowUse) {
                        lcHD[i].ID_BaoHiem = null;
                        lcHD[i].PTGiamTruBoiThuong = 0;
                        lcHD[i].PTThueBaoHiem = 0;
                        lcHD[i].TenBaoHiem = '';
                        lcHD[i].LienHeBaoHiem = '';
                        lcHD[i].SoDienThoaiLienHeBaoHiem = '';
                        lcHD[i].KhauTruTheoVu = 0;
                        lcHD[i].GiamTruBoiThuong = 0;
                        lcHD[i].BaoHiemDaTra = 0;
                        lcHD[i].TongTienThueBaoHiem = 0;
                        lcHD[i].CongThucBaoHiem = 0;
                        lcHD[i].TongTienBHDuyet = 0;
                        lcHD[i].PhaiThanhToanBaoHiem = 0;
                        lcHD[i].BHThanhToanTruocThue = 0;
                    }
                    else {
                        lcHD[i].ID_BaoHiem = self.ThongTinPhieuTiepNhan().ID_BaoHiem;
                        lcHD[i].TenBaoHiem = self.ThongTinPhieuTiepNhan().TenBaoHiem;
                        lcHD[i].LienHeBaoHiem = self.ThongTinPhieuTiepNhan().NguoiLienHeBH;
                        lcHD[i].SoDienThoaiLienHeBaoHiem = self.ThongTinPhieuTiepNhan().SoDienThoaiLienHeBH;
                    }
                    break;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(lcHD));

            if (!nowUse) {
                // reset in cthd
                var cthd = localStorage.getItem(lcListCTHD);
                if (cthd !== null) {
                    cthd = JSON.parse(cthd);
                    for (let i = 0; i < cthd.length; i++) {
                        if (cthd[i].IDRandomHD === idRandomHD) {
                            cthd[i].DonGiaBaoHiem = 0;

                            for (let k = 0; k < cthd[i].DM_LoHang.length; k++) {
                                cthd[i].DM_LoHang[k].DonGiaBaoHiem = 0;
                            }
                            for (let k = 0; k < cthd[i].HangCungLoais.length; k++) {
                                cthd[i].HangCungLoais[k].DonGiaBaoHiem = 0;
                            }
                        }
                    }
                    localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
                }
            }

            UpdateCacheHDLe(idRandomHD, false);
            BindHD_byIDRandom(idRandomHD);
            BindCTHD_byIDRandomHD(idRandomHD);
        }
    }

    self.editDonGiaBaoHiem = function (item) {
        var thisObj = $(event.currentTarget);
        formatNumberObj(thisObj);

        var ctDoing = FindCTHD_isDoing(item, false);
        if (ctDoing !== null) {
            let idRandomHD = ctDoing.IDRandomHD;
            let giaBHDuyet = formatNumberToFloat(thisObj.val());
            ctDoing.DonGiaBaoHiem = giaBHDuyet;

            // update ds cache cthoadon
            var cthd = localStorage.getItem(lcListCTHD);
            if (cthd !== null) {
                cthd = JSON.parse(cthd);
                cthd = updateCTHDLe(cthd, ctDoing);
                localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
            }
            if (item.MaHoaDon.indexOf('Trả') > -1) {
                UpdateHD_TraHang(idRandomHD);
            }
            else {
                ResetKM_HangHoa_ByIDQuiDoi_orNhomHang(item.ID_DonViQuiDoi, item.ID_NhomHangHoa, idRandomHD);
                ResetKM_HoaDon(idRandomHD);
                UpdateInforBaoHiem(idRandomHD);
                UpdateCacheHDLe(idRandomHD, false);
                UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();
                self.KM_KMApDung([]);
                UpdateKhuyenMai_CTHD(item.ID_DonViQuiDoi, idRandomHD);
                // update status change = true for HDDatHang dang XuLy
                if (item.LoaiHoaDon === 3) {
                    Update_StatusXuLy_ofHDDatHang(idRandomHD);
                }
            }
            BindHD_byIDRandom(ctDoing.IDRandomHD);
        }
        Enter_SoLuongPriceCTHD(item, event, 'giabh_', 2);
        Shift_SoLuongPriceCTHD(item, event, 'giabh_', 2, 16);
        ArrowRight_CTHD(item, event);
        ArrowLeft_CTHD(item, event);
    }

    // focus tien phai tra when enter (shift) SoLuong|DonGia CTHDDoiTra
    function FocusTienThanhToan_WhenEnterCTHDDoiTra(idRandomHD) {
        // tra khach
        if ($('.khachcantra').css('display') === 'none') {
            var lstCTDoiTra = localStorage.getItem(lcListCTHD_DoiTra);
            if (lstCTDoiTra !== null) {
                lstCTDoiTra = JSON.parse(lstCTDoiTra);
                var cthd_opening = $.grep(lstCTDoiTra, function (x) {
                    return x.IDRandomHD === idRandomHD;
                });
                if (cthd_opening.length > 0) {
                    // co doi tra
                    $('#txtDaTraKhach').focus().select();
                }
                else {
                    // khong doi tra
                    $('#txtDaTraKhach_KM').focus().select();
                }
            }
            else {
                // khong doi tra
                $('#txtDaTraKhach_KM').focus().select();
            }
        }
        else {
            // khach tra   
            $('#txtDaThanhToan').focus().select();
        }
    }
    function FocusTienThanhToan_WhenShiftCTHD(loaiHD, idRandomHD) {
        if (loaiHD === 6) {
            FocusTienThanhToan_WhenEnterCTHDDoiTra(idRandomHD);
        }
        else {
            // khach tra
            $('#txtDaThanhToan').focus().select();
        }
    }
    // type: 1.soluong, 2.price, 3 giaBH
    function Enter_SoLuongPriceCTHD(itemCT, e, charStart, type) {
        var key = e.keyCode || e.which;
        if (key === 13) {
            var cthd = JSON.parse(localStorage.getItem(lcListCTHD));
            // get all CTHD of HD opening
            var idRandomHD = itemCT.IDRandomHD;
            var cthd_opening = $.grep(cthd, function (x) {
                return x.IDRandomHD === idRandomHD;
            });
            var lstCTDoiTra = localStorage.getItem(lcListCTHD_DoiTra);
            if (lstCTDoiTra !== null) {
                lstCTDoiTra = JSON.parse(lstCTDoiTra);
            }
            else {
                lstCTDoiTra = [];
            }
            var idRandomFocus = null;
            for (let i = 0; i < cthd_opening.length; i++) {
                let itFor = cthd_opening[i];
                if (itFor.ID_DonViQuiDoi === itemCT.ID_DonViQuiDoi) {
                    if (itFor.DM_LoHang.length > 0) {
                        if (itFor.IDRandom === itemCT.IDRandom) {
                            if (itFor.DM_LoHang.length > 1) {
                                idRandomFocus = itFor.DM_LoHang[1].IDRandom;
                            }
                            else {
                                if (i < cthd_opening.length - 1) {
                                    idRandomFocus = cthd_opening[i + 1].IDRandom;
                                }
                                else {
                                    // find in doitra
                                    let obj = Find_RandomFocus_CTDoiTra(itemCT.LoaiHoaDon, idRandomHD, lstCTDoiTra, type);
                                    idRandomFocus = obj.IDRandom;
                                    charStart = obj.CharStart;
                                }
                            }
                        }
                        else {
                            // find LoHang
                            for (let j = 0; j < itFor.DM_LoHang.length; j++) {
                                if (itFor.DM_LoHang[j].IDRandom === itemCT.IDRandom) {
                                    if (j < itFor.DM_LoHang.length - 1) {
                                        // focus in next Lot
                                        idRandomFocus = itFor.DM_LoHang[j + 1].IDRandom;
                                    }
                                    else {
                                        // find li next
                                        if (i < cthd_opening.length - 1) {
                                            // focus in next Lot
                                            idRandomFocus = cthd_opening[i + 1].IDRandom;
                                        }
                                        else {
                                            // find CTDoiTra
                                            let obj = Find_RandomFocus_CTDoiTra(itemCT.LoaiHoaDon, idRandomHD, lstCTDoiTra, type);
                                            idRandomFocus = obj.IDRandom;
                                            charStart = obj.CharStart;
                                        }
                                    }
                                    break;
                                }
                            }
                        }
                    }
                    else {
                        // find li next
                        if (i < cthd_opening.length - 1) {
                            if (itFor.IDRandom === itemCT.IDRandom) {
                                // find in HangCungLoai
                                if (itFor.HangCungLoais.length > 0) {
                                    // focus HangCungLoai first
                                    idRandomFocus = itFor.HangCungLoais[0].IDRandom;
                                }
                                else {
                                    if (itFor.ThanhPhanComBo.length > 0) {
                                        // focus HangCungLoai first
                                        idRandomFocus = itFor.ThanhPhanComBo[0].IDRandom;
                                    }
                                    else {
                                        // focus in next Lot
                                        idRandomFocus = cthd_opening[i + 1].IDRandom;
                                    }
                                }
                            }
                            else {
                                // find in HangCungLoai
                                if (itFor.HangCungLoais.length > 0) {
                                    let obj = Return_RandomFocus(cthd_opening, i, itemCT, lstCTDoiTra, charStart, idRandomHD, false, type);
                                    idRandomFocus = obj.IDRandom;
                                    charStart = obj.CharStart;
                                }
                                else {
                                    // focus in next Lot
                                    idRandomFocus = cthd_opening[i + 1].IDRandom;
                                }
                            }
                        }
                        else {
                            // find HangCungLoai
                            if (itFor.HangCungLoais.length > 0) {
                                if (itFor.IDRandom === itemCT.IDRandom) {
                                    idRandomFocus = itFor.HangCungLoais[0].IDRandom;
                                }
                                else {
                                    let obj = Return_RandomFocus(cthd_opening, i, itemCT, lstCTDoiTra, charStart, idRandomHD, false, type);
                                    idRandomFocus = obj.IDRandom;
                                    charStart = obj.CharStart;
                                }
                            }
                            else {
                                if (itFor.ThanhPhanComBo.length > 0) {
                                    if (itFor.IDRandom === itemCT.IDRandom) {
                                        idRandomFocus = itFor.ThanhPhanComBo[0].IDRandom;
                                    }
                                }
                                else {
                                    // find CTDoiTra
                                    let obj = Find_RandomFocus_CTDoiTra(itemCT.LoaiHoaDon, cthd_opening[0].LoaiHoaDon, idRandomHD, lstCTDoiTra, type);
                                    idRandomFocus = obj.IDRandom;
                                    charStart = obj.CharStart;
                                }
                            }
                        }
                    }
                    break;
                }
            }
            if (idRandomFocus !== null) {
                $('input[id=' + charStart + idRandomFocus + ']').focus().select();
            }
        }
    }
    function Shift_SoLuongPriceCTHD(itemCT, e, charStart, type, keyCode) {
        var key = e.keyCode || e.which;
        // 16.shift
        if (key === keyCode) {
            var cthd = JSON.parse(localStorage.getItem(lcListCTHD));
            var idRandomHD = itemCT.IDRandomHD;
            // get all CTHD of HD opening
            var cthd_opening = $.grep(cthd, function (x) {
                return x.IDRandomHD === idRandomHD;
            });
            var idRandomFocus = null;
            for (let i = 0; i < cthd_opening.length; i++) {
                if (cthd_opening[i].ID_DonViQuiDoi === itemCT.ID_DonViQuiDoi) {
                    if (cthd_opening[i].DM_LoHang.length > 0) {
                        if (cthd_opening[i].IDRandom === itemCT.IDRandom) {
                            idRandomFocus = GetIDRandom_ofLiPev_ctMua(i, cthd_opening, itemCT.LoaiHoaDon, idRandomHD, idRandomFocus);
                        }
                        else {
                            // find LoHang
                            for (let j = 1; j < cthd_opening[i].DM_LoHang.length; j++) {
                                if (cthd_opening[i].DM_LoHang[j].IDRandom === itemCT.IDRandom) {
                                    if (j - 1 === 0) {
                                        idRandomFocus = cthd_opening[i].IDRandom;
                                    }
                                    else {
                                        idRandomFocus = cthd_opening[i].DM_LoHang[j - 1].IDRandom;
                                    }
                                    break;
                                }
                            }
                        }
                    }
                    else {
                        if (cthd_opening[i].HangCungLoais.length > 0) {
                            // find hangcungloai
                            if (cthd_opening[i].IDRandom === itemCT.IDRandom) {
                                idRandomFocus = GetIDRandom_ofLiPev_ctMua(i, cthd_opening, itemCT.LoaiHoaDon, idRandomHD, idRandomFocus);
                            }
                            else {
                                for (let j = 0; j < cthd_opening[i].HangCungLoais.length; j++) {
                                    if (cthd_opening[i].HangCungLoais[j].IDRandom === itemCT.IDRandom) {
                                        if (j - 1 >= 0) {
                                            idRandomFocus = cthd_opening[i].HangCungLoais[j - 1].IDRandom;
                                        }
                                        else {
                                            idRandomFocus = cthd_opening[i].IDRandom;
                                        }
                                        break;
                                    }
                                }
                            }
                        }
                        else {
                            idRandomFocus = GetIDRandom_ofLiPev_ctMua(i, cthd_opening, itemCT.LoaiHoaDon, idRandomHD, idRandomFocus);
                        }
                    }
                    break;
                }
            }
            if (idRandomFocus !== null) {
                if (type === 3) {
                    $('#' + charStart + idRandomFocus).focus().select();
                }
                else {
                    $('input[id=' + charStart + idRandomFocus + ']').focus().select();
                }
            }
        }
    }
    function Find_RandomFocus_CTDoiTra(loaiHD, idRandomHD, lstCTDoiTra, type) {
        lstCTDoiTra = $.grep(lstCTDoiTra, function (x) {
            return x.IDRandomHD === idRandomHD;
        });
        if (lstCTDoiTra.length > 0) {
            return {
                IDRandom: lstCTDoiTra[0].IDRandom,
                CharStart: type === 1 ? 'numberTH_' : 'priceTH_',
            }
        }
        else {
            // focus txtThanhToan
            FocusTienThanhToan_WhenShiftCTHD(loaiHD, idRandomHD);
            return {
                IDRandom: null,
                CharStart: '',
            }
        }
    }
    function Combo_FocusLiNext(ctDoing, idRandom, charStart, isDoiTra) {
        let idFocus = null;
        for (let i = 0; i < ctDoing.ThanhPhanComBo.length; i++) {
            let itFor = ctDoing.ThanhPhanComBo[i];
            if (itFor.IDRandom === idRandom) {
                if (i < ctDoing.ThanhPhanComBo.length - 1) {
                    idFocus = ctDoing.ThanhPhanComBo[i + 1].IDRandom;
                }
                else {
                    idFocus = Combo_FindLiNext(ctDoing.IDRandom, isDoiTra)
                }
            }
        }
        if (idFocus !== null) {
            $('input[id=' + charStart + idFocus + ']').focus().select();
        }
    }

    function Combo_FindLiNext(idPrev, isDoiTra) {
        var cacheName = lcListCTHD;
        if (isDoiTra) {
            cacheName = lcListCTHD_DoiTra;
        }
        var cthd = localStorage.getItem(cacheName);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            for (let i = 0; i < cthd.length; i++) {
                let itFor = cthd[i];
                if (itFor.IDRandom === idPrev) {
                    if (i < cthd.length - 1) {
                        return cthd[i + 1].IDRandom;
                    }
                }
            }
        }
        return null;
    }

    function Return_RandomFocus(cthd_opening, i, itemCT, lstCTDoiTra, charStart, idRandomHD, isDoiTra, type) {
        let idRandomFocus = '';
        for (let j = 0; j < cthd_opening[i].HangCungLoais.length; j++) {
            if (cthd_opening[i].HangCungLoais[j].IDRandom === itemCT.IDRandom) {
                if (j < cthd_opening[i].HangCungLoais.length - 1) {
                    // focus in next Lot
                    idRandomFocus = cthd_opening[i].HangCungLoais[j + 1].IDRandom;
                }
                else {
                    // find li next
                    if (i < cthd_opening.length - 1) {
                        // focus in next Lot
                        idRandomFocus = cthd_opening[i + 1].IDRandom;
                    }
                    else {
                        if (isDoiTra === false) {
                            let obj = Find_RandomFocus_CTDoiTra(itemCT.LoaHoaDon, idRandomHD, lstCTDoiTra, type);
                            idRandomFocus = obj.IDRandom;
                            charStart = obj.CharStart;
                        }
                        else {
                            idRandomFocus = null;
                            FocusTienThanhToan_WhenEnterCTHDDoiTra(idRandomHD);
                        }
                    }
                }
                break;
            }
        }
        return {
            IDRandom: idRandomFocus,
            CharStart: charStart,
        }
    }
    function GetIDRandom_ofLiPev_ctMua(i, cthd_opening, loaiHD, idRandomHD, idRandomFocus) {
        if (i - 1 >= 0) {
            let lstLoHang = cthd_opening[i - 1].DM_LoHang;
            if (lstLoHang.length > 0) {
                // focus LoHang last
                idRandomFocus = lstLoHang[lstLoHang.length - 1].IDRandom;
            }
            else {
                // focus in prev li
                lstLoHang = cthd_opening[i - 1].HangCungLoais;
                if (lstLoHang.length > 0) {
                    idRandomFocus = lstLoHang[lstLoHang.length - 1].IDRandom;
                }
                else {
                    idRandomFocus = cthd_opening[i - 1].IDRandom;
                }
            }
        }
        else {
            FocusTienThanhToan_WhenShiftCTHD(loaiHD, idRandomHD);
            idRandomFocus = null;
        }
        return idRandomFocus;
    }
    function GetIDRandom_ofLiPev_ctDoiTra(i, cthd_opening, loaiHD, idRandomHD, idRandomFocus, charStart, type) {
        if (i - 1 >= 0) {
            let lstLoHang = cthd_opening[i - 1].DM_LoHang;
            if (lstLoHang.length > 0) {
                // focus LoHang last
                idRandomFocus = lstLoHang[lstLoHang.length - 1].IDRandom;
            }
            else {
                // focus in prev li
                lstLoHang = cthd_opening[i - 1].HangCungLoais;
                if (lstLoHang.length > 0) {
                    idRandomFocus = lstLoHang[lstLoHang.length - 1].IDRandom;
                }
                else {
                    idRandomFocus = cthd_opening[i - 1].IDRandom;
                }
            }
        }
        else {
            // find in cthd Tra
            let ctTra = localStorage.getItem(lcListCTHD);
            if (ctTra !== null) {
                ctTra = JSON.parse(ctTra);
                ctTra = $.grep(ctTra, function (x) {
                    return x.IDRandomHD === idRandomHD;
                });
                if (ctTra.length > 0) {
                    switch (type) {
                        case 1:
                            charStart = 'munber_';
                            break;
                        case 2:
                            charStart = '';
                            break;
                        case 3:
                            charStart = 'sum-f_';
                            break;
                    }
                    let ctLast = ctTra[ctTra.length - 1];// get ctTra last
                    let lenAr = ctLast.DM_LoHang.length;
                    if (lenAr > 0) {
                        if (lenAr === 1) {
                            idRandomFocus = ctLast.IDRandom;
                        }
                        else {
                            idRandomFocus = ctLast.DM_LoHang[lenAr - 1].IDRandom;
                        }
                    }
                    else {
                        lenAr = ctLast.HangCungLoais.length;
                        if (lenAr > 0) {
                            idRandomFocus = ctLast.HangCungLoais[lenAr - 1].IDRandom;
                        }
                        else {
                            idRandomFocus = ctLast.IDRandom;
                        }
                    }
                }
                else {
                    FocusTienThanhToan_WhenShiftCTHD(loaiHD, idRandomHD);
                }
            }
            else {
                FocusTienThanhToan_WhenShiftCTHD(loaiHD, idRandomHD);
            }
        }
        return {
            IDRandom: idRandomFocus,
            CharStart: charStart,
        }
    };
    function Enter_DoiTra(itemCT, e, charStart, type) {
        var key = e.keyCode || e.which;
        if (key === 13) {
            var lstCTDoiTra = localStorage.getItem(lcListCTHD_DoiTra);
            if (lstCTDoiTra !== null) {
                lstCTDoiTra = JSON.parse(lstCTDoiTra);
                var idRandomHD = itemCT.IDRandomHD;
                // get all CTHD of HD opening
                var cthd_opening = $.grep(lstCTDoiTra, function (x) {
                    return x.IDRandomHD === idRandomHD;
                });
                var idRandomFocus = null;
                for (let i = 0; i < cthd_opening.length; i++) {
                    let itFor = cthd_opening[i];
                    if (itFor.ID_DonViQuiDoi === itemCT.ID_DonViQuiDoi) {
                        if (itFor.DM_LoHang.length > 0) {
                            if (itFor.IDRandom === itemCT.IDRandom) {
                                if (itFor.DM_LoHang.length > 1) {
                                    idRandomFocus = itFor.DM_LoHang[1].IDRandom;
                                }
                                else {
                                    if (i < cthd_opening.length - 1) {
                                        idRandomFocus = cthd_opening[i + 1].IDRandom;
                                    }
                                    else {
                                        FocusTienThanhToan_WhenEnterCTHDDoiTra(idRandomHD);
                                    }
                                }
                            }
                            else {
                                // find LoHang
                                for (let j = 0; j < itFor.DM_LoHang.length; j++) {
                                    if (itFor.DM_LoHang[j].IDRandom === itemCT.IDRandom) {
                                        if (j < itFor.DM_LoHang.length - 1) {
                                            // focus in next Lot
                                            idRandomFocus = itFor.DM_LoHang[j + 1].IDRandom;
                                        }
                                        else {
                                            // find li next
                                            if (i < cthd_opening.length - 1) {
                                                // focus in next Lot
                                                idRandomFocus = cthd_opening[i + 1].IDRandom;
                                            }
                                            else {
                                                FocusTienThanhToan_WhenEnterCTHDDoiTra(idRandomHD);
                                            }
                                        }
                                        break;
                                    }
                                }
                            }
                        }
                        else {
                            // find li next
                            if (i < cthd_opening.length - 1) {
                                if (itFor.IDRandom === itemCT.IDRandom) {
                                    // find in HangCungLoai
                                    if (itFor.HangCungLoais.length > 0) {
                                        idRandomFocus = itFor.HangCungLoais[0].IDRandom;
                                    }
                                    else {
                                        if (itFor.ThanhPhanComBo.length > 0) {
                                            idRandomFocus = itFor.ThanhPhanComBo[0].IDRandom;
                                        }
                                        else {
                                            // focus in next Lot
                                            idRandomFocus = cthd_opening[i + 1].IDRandom;
                                        }
                                    }
                                }
                                else {
                                    // find in HangCungLoai
                                    if (itFor.HangCungLoais.length > 0) {
                                        let obj = Return_RandomFocus(cthd_opening, i, itemCT, lstCTDoiTra, charStart, idRandomHD, true, type);
                                        idRandomFocus = obj.IDRandom;
                                        charStart = obj.CharStart;
                                    }
                                    else {
                                        // focus in next Lot
                                        idRandomFocus = cthd_opening[i + 1].IDRandom;
                                    }
                                }
                            }
                            else {
                                // find HangCungLoai
                                if (itFor.HangCungLoais.length > 0) {
                                    if (itFor.IDRandom === itemCT.IDRandom) {
                                        idRandomFocus = itFor.HangCungLoais[0].IDRandom;
                                    }
                                    else {
                                        let obj = Return_RandomFocus(cthd_opening, i, itemCT, lstCTDoiTra, charStart, idRandomHD, true, type);
                                        idRandomFocus = obj.IDRandom;
                                        charStart = obj.CharStart;
                                    }
                                }
                                else {
                                    if (itFor.ThanhPhanComBo.length > 0) {
                                        if (itFor.IDRandom === itemCT.IDRandom) {
                                            idRandomFocus = itFor.ThanhPhanComBo[0].IDRandom;
                                        }
                                    }
                                    else {
                                        // find CTDoiTra
                                        FocusTienThanhToan_WhenEnterCTHDDoiTra(idRandomHD);
                                        idRandomFocus = null;
                                    }
                                }
                            }
                        }
                        break;
                    }
                }
                if (idRandomFocus !== null) {
                    $('input[id=' + charStart + idRandomFocus + ']').focus().select();
                }
            }
        }
    }
    function Shift_DoiTra(itemCT, e, charStart, type, keyCode) {
        var key = e.keyCode || e.which;
        // 16.shift
        if (key === keyCode) {
            var cthd = JSON.parse(localStorage.getItem(lcListCTHD_DoiTra)); // ct mua moi
            var idRandomHD = itemCT.IDRandomHD;
            // get all CTHD of HD opening
            var cthd_opening = $.grep(cthd, function (x) {
                return x.IDRandomHD === idRandomHD;
            })
            var idRandomFocus = null;
            for (let i = 0; i < cthd_opening.length; i++) {
                if (cthd_opening[i].ID_DonViQuiDoi === itemCT.ID_DonViQuiDoi) {
                    if (cthd_opening[i].DM_LoHang.length > 0) {
                        if (cthd_opening[i].IDRandom === itemCT.IDRandom) {
                            let obj = GetIDRandom_ofLiPev_ctDoiTra(i, cthd_opening, itemCT.LoaiHoaDon, idRandomHD, idRandomFocus, charStart, type);
                            idRandomFocus = obj.IDRandom;
                            charStart = obj.CharStart;
                        }
                        else {
                            // find LoHang
                            for (let j = 1; j < cthd_opening[i].DM_LoHang.length; j++) {
                                if (cthd_opening[i].DM_LoHang[j].IDRandom === itemCT.IDRandom) {
                                    if (j - 1 === 0) {
                                        idRandomFocus = cthd_opening[i].IDRandom;
                                    }
                                    else {
                                        idRandomFocus = cthd_opening[i].DM_LoHang[j - 1].IDRandom;
                                    }
                                    break;
                                }
                            }
                        }
                    }
                    else {
                        if (cthd_opening[i].HangCungLoais.length > 0) {
                            // find hangcungloai
                            if (cthd_opening[i].IDRandom === itemCT.IDRandom) {
                                let obj = GetIDRandom_ofLiPev_ctDoiTra(i, cthd_opening, itemCT.LoaiHoaDon, idRandomHD, idRandomFocus, charStart, type);
                                idRandomFocus = obj.IDRandom;
                                charStart = obj.CharStart;
                            }
                            else {
                                for (let j = 0; j < cthd_opening[i].HangCungLoais.length; j++) {
                                    if (cthd_opening[i].HangCungLoais[j].IDRandom === itemCT.IDRandom) {
                                        if (j - 1 >= 0) {
                                            idRandomFocus = cthd_opening[i].HangCungLoais[j - 1].IDRandom;
                                        }
                                        else {
                                            idRandomFocus = cthd_opening[i].IDRandom;
                                        }
                                        break;
                                    }
                                }
                            }
                        }
                        else {
                            let obj = GetIDRandom_ofLiPev_ctDoiTra(i, cthd_opening, itemCT.LoaiHoaDon, idRandomHD, idRandomFocus, charStart, type);
                            idRandomFocus = obj.IDRandom;
                            charStart = obj.CharStart;
                        }
                    }
                    break;
                }
            }
            if (idRandomFocus !== null) {
                if (type === 3) {
                    $('#' + charStart + idRandomFocus).focus().select();
                }
                else {
                    $('input[id=' + charStart + idRandomFocus + ']').focus().select();
                }
            }
        }
    }
    self.showDivSale_CTHD = function (item) {
        var role = GetRoleChangePrice(item.LoaiHoaDon);
        if (role === false) {
            return false;
        }
        var idRandom = item.IDRandom;
        var quanLiTheoLo = item.QuanLyTheoLoHang;
        quanLiTheoLo = (quanLiTheoLo === null ? false : quanLiTheoLo);
        var $this = $(event.currentTarget);
        var ipGiam = $('#pri-g_' + idRandom);
        var iconGiam = $('#vnd_' + idRandom); // vnd or %
        var ptGiam = 0;
        var tienGiam = 0;
        var ctDoing = FindCTHD_isDoing(item, false);
        if (ctDoing !== null) {
            ptGiam = ctDoing.PTChietKhau;
            tienGiam = ctDoing.TienChietKhau;

            if (ptGiam > 0 || tienGiam === 0) {
                ipGiam.val(formatNumber3Digit(ptGiam));
                iconGiam.addClass('active-re');
            }
            else {
                ipGiam.val(formatNumber3Digit(tienGiam));
                iconGiam.removeClass('active-re');
            }

            if (ctDoing.PTThue > 0 || (ctDoing.TienThue === 0 && ctDoing.PTThue === 0)) {
                $('#ipTaxCT_' + idRandom).val(formatNumber3Digit(ctDoing.PTThue));
                $('#taxCT_' + idRandom).addClass('active-re');
            }
            else {
                $('#ipTaxCT_' + idRandom).val(formatNumber3Digit(ctDoing.TienThue));
                $('#taxCT_' + idRandom).removeClass('active-re');
            }
        }
        $($this).siblings(".gara-popup-chietkhau").toggle();
        ipGiam.focus().select().focus();
    }
    function GetRoleChangeSaleHD() {
        var loaihd = GetLoaiHoaDon_ofHDopening();
        var role = false;
        switch (loaihd) {
            case 1:
                role = self.roleChangeSale_Invoice();
                break;
            case 3:
                role = self.roleChangeSale_Order();
                break;
            case 6:
                role = self.roleChangeSale_Return();
                break;
            case 19:
                role = self.roleChangeSale_ServicePackage();
                break;
        }
        return role;
    }

    // only hide .arrow-left when click out
    $(document).mouseup(function () {
        $('.arrow-left').mouseup(function () {
            return false;// don't hide
        });
        $('.arrow-left').hide();
    });

    // giamgia
    function HD_UpdatePtramCK() {
        var lcHD = localStorage.getItem(lcListHD);
        if (lcHD !== null) {
            lcHD = JSON.parse(lcHD);
            for (let i = 0; i < lcHD.length; i++) {
                if (lcHD[i].IDRandom === self.HoaDons().IDRandom()) {
                    lcHD[i].TongChietKhau = self.HoaDons().TongChietKhau();
                    break;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(lcHD));
        }
    }

    // chiet khau hanghoa 
    self.ShowDiv_ChietKhauHangHoa = function () {
        var role = GetRoleChangePrice(self.HoaDons().LoaiHoaDon());
        if (role === false) {
            return false;
        }
        var $thisNext = $(event.currentTarget).next();
        $thisNext.show();
        $thisNext.find('.op-js-css-toggle-option').removeClass('op-js-toggle-2');
        if (self.HoaDons().PTChietKhauHH() > 0 || self.HoaDons().TongGiamGiaHang() === 0) {
            $thisNext.find('.op-js-css-toggle-option').addClass("op-js-toggle-2");
            $thisNext.find('.gara-VAT-percent').addClass("selected");
        }
        else {
            $thisNext.find('.gara-VAT-VND').addClass("selected");
        }
        $(function () {
            $thisNext.children().eq(0).find('input').select().focus();
        })
    }

    self.ChietKhauHangHoa_ClickTaxVND = function () {
        var $this = $(event.currentTarget);
        var $closest = $this.closest('.op-js-css-toggle-option');
        $closest.removeClass('op-js-toggle-2');

        $this.next().removeClass('selected');

        if (!$this.hasClass('selected')) {
            $this.addClass("selected");
        }

        if (self.HoaDons().TongGiamGiaHang() > 0) {
            if (self.HoaDons().PTChietKhauHH() > 0) {
                self.HoaDons().PTChietKhauHH(0);
            }
            HD_UpdatePtramChietKhauHhangHoa();
        }
        $(function () {
            $this.closest('div').find('input').select().focus();
        })
    }

    self.ChietKhauHangHoa_ClickTaxPtram = function () {
        var $this = $(event.currentTarget);
        var $closest = $this.closest('.op-js-css-toggle-option');
        $closest.addClass('op-js-toggle-2');

        $this.prev().removeClass('selected');
        if (!$this.hasClass('selected')) {
            $this.addClass("selected");
        }

        if (self.HoaDons().TongGiamGiaHang() > 0) {
            let ptCK = self.HoaDons().TongGiamGiaHang() / self.HoaDons().TongTienHangChuaCK() * 100;
            self.HoaDons().PTChietKhauHH(ptCK);
            HD_UpdatePtramChietKhauHhangHoa();
        }
        $(function () {
            $this.closest('div').find('input').select().focus();
        })
    }

    self.ChietKhauHangHoa_Edit = function () {
        var $this = $(event.currentTarget);
        var ptCK = self.HoaDons().PTChietKhauHH(); // HH00948
        var tongCKHang = 0;

        if ($this.val() === '') {
            ptCK = tongCKHang = 0;
        }
        else {
            if ($('#ckHang_Ptram').hasClass('selected')) {
                // %
                if (formatNumberToFloat($this.val()) > 100) {
                    ptCK = 100;
                    $this.val(100);
                }
                else {
                    ptCK = formatNumberToFloat($this.val());
                }
                tongCKHang = ptCK * self.HoaDons().TongTienHangChuaCK() / 100;
            }
            else {
                // vnd
                formatNumberObj($this);
                tongCKHang = formatNumberToFloat($this.val());
            }
        }
        self.HoaDons().TongGiamGiaHang(tongCKHang);
        self.HoaDons().PTChietKhauHH(ptCK);

        var idRandomHD = self.HoaDons().IDRandom();
        var lcHD = localStorage.getItem(lcListHD);
        if (lcHD !== null) {
            lcHD = JSON.parse(lcHD);
            for (let i = 0; i < lcHD.length; i++) {
                if (lcHD[i].IDRandom === idRandomHD) {
                    lcHD[i].PTChietKhauHH = ptCK;
                    lcHD[i].TongGiamGiaHang = tongCKHang;
                    break;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(lcHD));
        }
        var isDoiTra = self.HoaDons().LoaiHoaDon() === 6;
        Update_ChietKhau_forCTHD(idRandomHD, isDoiTra);
        UpdateCacheHDLe(idRandomHD, isDoiTra, 1);
        Update_StatusXuLy_ofHDDatHang(idRandomHD);
        if (self.HoaDons().HeaderBH_GiaTriPtram() > 0 && self.HoaDons().HeaderBH_Type() === 1) {
            UpdateDonGiaBaoHiem_byHeaderBH();
            UpdateInforBaoHiem(idRandomHD);
        }
        BindHD_byIDRandom(idRandomHD);
        BindCTHD_byIDRandomHD(idRandomHD);
    }

    self.ShowDivSale_HD = function () {
        var role = GetRoleChangeSaleHD();
        if (role === false) {
            return false;
        }
        var $thisNext = $(event.currentTarget).next();
        $thisNext.show();
        $thisNext.find('.op-js-css-toggle-option').removeClass('op-js-toggle-2');

        if (self.HoaDons().TongChietKhau() > 0 || (self.HoaDons().TongChietKhau() === 0 && self.HoaDons().TongGiamGia() === 0)) {
            $thisNext.find('.op-js-css-toggle-option').addClass('op-js-toggle-2');
            $thisNext.find('.gara-VAT-percent').addClass("selected");
        }
        else {
            $thisNext.find('.gara-VAT-VND').addClass("selected");
        }
        $(function () {
            $thisNext.children().eq(0).find('input').select().focus();
        })
        self.GetlistGroupSale();
    }

    self.editSalePr = function () {
        var $this = $(event.currentTarget);
        var ptCK = self.HoaDons().TongChietKhau();
        var tongGiam = self.HoaDons().TongGiamGiaKM_HD();

        if ($this.val() === '') {
            ptCK = tongGiam = 0;
        }
        else {
            if ($('#hd_CKPtram').hasClass('selected')) {
                // %
                if (formatNumberToFloat($this.val()) > 100) {
                    ptCK = 100;
                    $this.val(100);
                }
                else {
                    ptCK = formatNumberToFloat($this.val());
                }
                tongGiam = ptCK * formatNumberToFloat(self.HoaDons().PhaiThanhToan()) / 100;
            }
            else {
                // vnd
                ptCK = 0;
                formatNumberObj($this);
                tongGiam = formatNumberToFloat($this.val());
            }
        }
        self.HoaDons().TongGiamGia(tongGiam);
        self.HoaDons().TongGiamGiaKM_HD(tongGiam + self.HoaDons().KhuyeMai_GiamGia());
        self.HoaDons().TongChietKhau(ptCK);

        // update GiamGia for HD
        var itemHD = [];
        var idRandomHD = self.HoaDons().IDRandom();
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            for (let i = 0; i < lstHD.length; i++) {
                if (lstHD[i].IDRandom === self.HoaDons().IDRandom()) {
                    lstHD[i].TongGiamGia = tongGiam;
                    lstHD[i].TongChietKhau = ptCK;
                    itemHD = lstHD[i];
                    break;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(lstHD))
        }
        UpdateCacheHDLe(idRandomHD, self.HoaDons().LoaiHoaDon() === 6, 1);
        // check xem HD co dang KM Tich diem khong
        var isTichDiemHD_GiamGia = Check_ThietLapTichDiem_GiamGiaHD();
        if (!isTichDiemHD_GiamGia) {
            if (itemHD.IsOpeningKMaiHD && itemHD.TongGiamGia > 0) {
                // reset KhuyenMai
                var lstHD2 = localStorage.getItem(lcListHD);
                if (lstHD2 !== null) {
                    lstHD2 = JSON.parse(lstHD2);
                    for (let i = 0; i < lstHD2.length; i++) {
                        if (lstHD2[i].IDRandom === idRandomHD) {
                            lstHD2[i].ID_KhuyenMai = null;
                            lstHD2[i].PTGiam_KM = 0;
                            lstHD2[i].DiemCong = 0;
                            lstHD2[i].KhuyeMai_GiamGia = 0;
                            lstHD2[i].TongGiamGiaKM_HD = lstHD2[i].TongGiamGia;
                            lstHD2[i].IsOpeningKMaiHD = false;
                            lstHD2[i].KhuyenMai_GhiChu = "";
                            break;
                        }
                    }
                    localStorage.setItem(lcListHD, JSON.stringify(lstHD2));
                }
            }
        }
        UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();
        UpdateChietKhauHD_NhanVien(idRandomHD);
        BindHD_byIDRandom(idRandomHD);
        Update_StatusXuLy_ofHDDatHang(idRandomHD);
    }

    self.clickVNDPr = function () {
        var $this = $(event.currentTarget);
        $this.next().removeClass('selected');

        if (!$this.hasClass('selected')) {
            $this.addClass("selected");
        }
        if (self.HoaDons().TongTienHang() > 0) {
            if (self.HoaDons().TongChietKhau() > 0) {
                self.HoaDons().TongChietKhau(0);
            }
            HD_UpdatePtramCK();
        }
        $(function () {
            $this.closest('div').find('input').select().focus();
        })
    }

    self.clickNoVNDPr = function () {
        var $this = $(event.currentTarget);
        $this.prev().removeClass('selected');
        if (!$this.hasClass('selected')) {
            $this.addClass("selected");
        }
        if (self.HoaDons().TongTienHang() > 0) {
            let ptCK = self.HoaDons().TongGiamGia() / self.HoaDons().TongTienHang() * 100;
            self.HoaDons().TongChietKhau(ptCK);
            HD_UpdatePtramCK();
        }
        $(function () {
            $this.closest('div').find('input').select().focus();
        })
    }

    // VAT
    function HD_UpdatePtramThue() {
        var lcHD = localStorage.getItem(lcListHD);
        if (lcHD !== null) {
            lcHD = JSON.parse(lcHD);
            for (let i = 0; i < lcHD.length; i++) {
                if (lcHD[i].IDRandom === self.HoaDons().IDRandom()) {
                    lcHD[i].PTThueHoaDon = self.HoaDons().PTThueHoaDon();
                    break;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(lcHD));
        }
    }

    function HD_UpdatePtramChietKhauHhangHoa() {
        var lcHD = localStorage.getItem(lcListHD);
        if (lcHD !== null) {
            lcHD = JSON.parse(lcHD);
            for (let i = 0; i < lcHD.length; i++) {
                if (lcHD[i].IDRandom === self.HoaDons().IDRandom()) {
                    lcHD[i].PTChietKhauHH = self.HoaDons().PTChietKhauHH();
                    break;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(lcHD));
        }
    }

    self.ShowDivTax_HD = function () {
        var role = GetRoleChangeSaleHD();
        if (role === false) {
            return false;
        }
        var $thisNext = $(event.currentTarget).next();
        $thisNext.show();
        $thisNext.find('.selected').removeClass('selected');
        $thisNext.find('.op-js-css-toggle-option').removeClass('op-js-toggle-2');
        if (self.HoaDons().PTThueHoaDon() > 0 || (self.HoaDons().PTThueHoaDon() === 0 && self.HoaDons().TongTienThue() === 0)) {
            $thisNext.find('.gara-VAT-percent').addClass("selected");
            $thisNext.find('.op-js-css-toggle-option').addClass('op-js-toggle-2');
        }
        else {
            $thisNext.find('.gara-VAT-VND').addClass("selected");
        }
        $(function () {
            $thisNext.find('input').eq(0).select().focus();
        })
    }

    self.HD_ClickTaxVND = function () {
        var $this = $(event.currentTarget);
        $this.next().removeClass('selected');

        if (!$this.hasClass('selected')) {
            $this.addClass("selected");
        }
        if (self.HoaDons().TongTienHang() > 0) {
            if (self.HoaDons().PTThueHoaDon() > 0) {
                self.HoaDons().PTThueHoaDon(0);
            }
            HD_UpdatePtramThue();
        }
        $(function () {
            $this.closest('div').find('input').select().focus();
        })
    }

    self.HD_ClickTaxPtram = function () {
        var $this = $(event.currentTarget);
        $this.prev().removeClass('selected');
        if (!$this.hasClass('selected')) {
            $this.addClass("selected");
        }
        if (self.HoaDons().TongTienHang() > 0) {
            let ptThue = self.HoaDons().TongTienThue() / (self.HoaDons().TongTienHang()) * 100;
            self.HoaDons().PTThueHoaDon(ptThue);
            HD_UpdatePtramThue();
        }
        $(function () {
            $this.closest('div').find('input').select().focus();
        })
    }

    function Update_TienThue_forCTHD(idRandomHD, isDoiTra) {
        var cacheCTHD = lcListCTHD;
        if (isDoiTra) {
            cacheCTHD = lcListCTHD_DoiTra;
        }
        var ptThue = self.HoaDons().TongTienThue() / (self.HoaDons().TongTienHang()) * 100;
        var ptThueHD = self.HoaDons().PTThueHoaDon();
        ptThueHD = ptThueHD > 0 ? ptThueHD : 0;
        var cthd = localStorage.getItem(cacheCTHD);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            for (let i = 0; i < cthd.length; i++) {
                if (cthd[i].IDRandomHD === idRandomHD) {
                    if (cthd[i].ChatLieu !== '4') {
                        cthd[i].PTThue = ptThueHD;
                        cthd[i].TienThue = ptThue * (cthd[i].DonGia - cthd[i].TienChietKhau) / 100;
                        cthd[i].ThanhToan = cthd[i].SoLuong * (cthd[i].DonGia - cthd[i].TienChietKhau + cthd[i].TienThue);
                    }

                    for (let j = 0; j < cthd[i].DM_LoHang.length; j++) {
                        if (cthd[i].DM_LoHang[j].ChatLieu !== '4') {
                            cthd[i].DM_LoHang[j].PTThue = ptThueHD;
                            cthd[i].DM_LoHang[j].TienThue = ptThue * (cthd[i].DM_LoHang[j].GiaBan - cthd[i].DM_LoHang[j].TienChietKhau) / 100;
                            cthd[i].DM_LoHang[j].ThanhToan = cthd[i].DM_LoHang[j].SoLuong *
                                (cthd[i].DM_LoHang[j].GiaBan - cthd[i].DM_LoHang[j].TienChietKhau + cthd[i].DM_LoHang[j].TienThue);
                        }
                    }
                    for (let j = 0; j < cthd[i].HangCungLoais.length; j++) {
                        if (cthd[i].HangCungLoais[j].ChatLieu !== '4') {
                            cthd[i].HangCungLoais[j].PTThue = ptThueHD;
                            cthd[i].HangCungLoais[j].TienThue = ptThue * (cthd[i].HangCungLoais[j].GiaBan - cthd[i].HangCungLoais[j].TienChietKhau) / 100;
                            cthd[i].HangCungLoais[j].ThanhToan = cthd[i].HangCungLoais[j].SoLuong
                                * (cthd[i].HangCungLoais[j].GiaBan - cthd[i].HangCungLoais[j].TienChietKhau + cthd[i].HangCungLoais[j].TienThue);
                        }
                    }
                }
            }
            localStorage.setItem(cacheCTHD, JSON.stringify(cthd));
        }
    }

    function Update_ChietKhau_forCTHD(idRandomHD, isDoiTra) {
        var cacheCTHD = lcListCTHD;
        if (isDoiTra) {
            cacheCTHD = lcListCTHD_DoiTra;
        }
        var ptCK = self.HoaDons().TongGiamGiaHang() / self.HoaDons().TongTienHangChuaCK() * 100;
        var ptCKHH = self.HoaDons().PTChietKhauHH();
        ptCKHH = ptCKHH > 0 ? ptCKHH : 0;

        var cthd = localStorage.getItem(cacheCTHD);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            for (let i = 0; i < cthd.length; i++) {
                if (cthd[i].IDRandomHD === idRandomHD) {
                    if (cthd[i].ChatLieu !== '4') {
                        cthd[i].PTChietKhau = ptCKHH;
                        cthd[i].TienChietKhau = ptCK * cthd[i].GiaBan / 100;
                        if (cthd[i].PTThue > 0) {
                            cthd[i].TienThue = cthd[i].PTThue * (cthd[i].DonGia - cthd[i].TienChietKhau) / 100;
                        }
                        cthd[i].ThanhTien = cthd[i].SoLuong * (cthd[i].GiaBan - cthd[i].TienChietKhau);
                        cthd[i].ThanhToan = cthd[i].SoLuong * (cthd[i].GiaBan - cthd[i].TienChietKhau + cthd[i].TienThue);

                        // phidichvu: tinh theo thanhtien
                        if (cthd[i].LaPTPhiDichVu) {
                            cthd[i].TongPhiDichVu = cthd[i].PhiDichVu * formatNumberToFloat(cthd[i].GiaBan) * cthd[i].SoLuong / 100;
                        }
                        else {
                            cthd[i].TongPhiDichVu = cthd[i].PhiDichVu * cthd[i].SoLuong;
                        }
                    }

                    for (let j = 0; j < cthd[i].DM_LoHang.length; j++) {
                        if (cthd[i].DM_LoHang[j].ChatLieu !== '4') {
                            cthd[i].DM_LoHang[j].PTChietKhau = ptCKHH;
                            cthd[i].DM_LoHang[j].TienChietKhau = ptCK * cthd[i].DM_LoHang[j].GiaBan / 100;
                            if (cthd[i].DM_LoHang[j].PTThue > 0) {
                                cthd[i].DM_LoHang[j].TienThue = cthd[i].DM_LoHang[j].PTThue
                                    * (cthd[i].DM_LoHang[j].DonGia - cthd[i].DM_LoHang[j].TienChietKhau) / 100;
                            }
                            cthd[i].DM_LoHang[j].ThanhTien = cthd[i].DM_LoHang[j].SoLuong *
                                (cthd[i].DM_LoHang[j].GiaBan - cthd[i].DM_LoHang[j].TienChietKhau);
                            cthd[i].DM_LoHang[j].ThanhToan = cthd[i].DM_LoHang[j].SoLuong *
                                (cthd[i].DM_LoHang[j].GiaBan - cthd[i].DM_LoHang[j].TienChietKhau + cthd[i].DM_LoHang[j].TienThue);

                            if (cthd[i].DM_LoHang[j].LaPTPhiDichVu) {
                                cthd[i].DM_LoHang[j].TongPhiDichVu = cthd[i].DM_LoHang[j].PhiDichVu * cthd[i].DM_LoHang[j].GiaBan * cthd[i].DM_LoHang[j].SoLuong / 100;
                            }
                            else {
                                cthd[i].DM_LoHang[j].TongPhiDichVu = cthd[i].DM_LoHang[j].PhiDichVu * cthd[i].DM_LoHang[j].SoLuong;
                            }
                        }
                    }
                    for (let j = 0; j < cthd[i].HangCungLoais.length; j++) {
                        if (cthd[i].HangCungLoais[j].ChatLieu !== '4') {
                            cthd[i].HangCungLoais[j].PTChietKhau = ptCKHH;
                            cthd[i].HangCungLoais[j].TienChietKhau = ptCK * cthd[i].HangCungLoais[j].GiaBan / 100;
                            if (cthd[i].HangCungLoais[j].PTThue > 0) {
                                cthd[i].HangCungLoais[j].TienThue = cthd[i].HangCungLoais[j].PTThue
                                    * (cthd[i].HangCungLoais[j].DonGia - cthd[i].HangCungLoais[j].TienChietKhau) / 100;
                            }
                            cthd[i].HangCungLoais[j].ThanhTien = cthd[i].HangCungLoais[j].SoLuong
                                * (cthd[i].HangCungLoais[j].GiaBan - cthd[i].HangCungLoais[j].TienChietKhau);
                            cthd[i].HangCungLoais[j].ThanhToan = cthd[i].HangCungLoais[j].SoLuong
                                * (cthd[i].HangCungLoais[j].GiaBan - cthd[i].HangCungLoais[j].TienChietKhau + cthd[i].HangCungLoais[j].TienThue);

                            if (cthd[i].HangCungLoais[j].LaPTPhiDichVu) {
                                cthd[i].HangCungLoais[j].TongPhiDichVu = cthd[i].HangCungLoais[j].PhiDichVu * cthd[i].HangCungLoais[j].GiaBan * cthd[i].HangCungLoais[j].SoLuong / 100;
                            }
                            else {
                                cthd[i].HangCungLoais[j].TongPhiDichVu = cthd[i].HangCungLoais[j].PhiDichVu * cthd[i].HangCungLoais[j].SoLuong;
                            }
                        }
                    }
                }
            }
            localStorage.setItem(cacheCTHD, JSON.stringify(cthd));

            // update again cknhanvien 
            for (let i = 0; i < cthd.length; i++) {
                let itFor = cthd[i];
                UpdateChietKhauNV_inCTHD(itFor.IDRandom, isDoiTra, itFor);

                for (let j = 0; j < itFor.DM_LoHang.length; j++) {
                    let forIn = itFor.DM_LoHang[j];
                    UpdateChietKhauNV_inCTHD(forIn.IDRandom, isDoiTra, forIn);
                }
                for (let j = 0; j < itFor.HangCungLoais.length; j++) {
                    let forIn = itFor.HangCungLoais[j];
                    UpdateChietKhauNV_inCTHD(forIn.IDRandom, isDoiTra, forIn);
                }

                for (let k = 0; k < cthd[i].ThanhPhanComBo.length; k++) {
                    Combo_UpdateChietKhauNV(itFor.IDRandom, cthd[i].ThanhPhanComBo[k].IDRandom, isDoiTra);
                }
            }
        }
    }

    self.editTax = function () {
        var $this = $(event.currentTarget);
        var ptThue = self.HoaDons().PTThueHoaDon();
        var tienThue = self.HoaDons().TongTienThue();
        var tiensauCK = self.HoaDons().TongTienHang();

        if ($this.val() === '') {
            ptThue = tienThue = 0;
        }
        else {
            if ($('#hd_TaxPtram').hasClass('selected')) {
                // %
                if (formatNumberToFloat($this.val()) > 100) {
                    ptThue = 100;
                    $this.val(100);
                }
                else {
                    ptThue = formatNumberToFloat($this.val());
                }
                tienThue = ptThue * tiensauCK / 100;
            }
            else {
                // vnd
                formatNumberObj($this);
                tienThue = formatNumberToFloat($this.val());
            }
        }
        self.HoaDons().TongTienThue(tienThue);
        self.HoaDons().PTThueHoaDon(ptThue);

        var changeTaxBH = false;
        var idRandomHD = self.HoaDons().IDRandom();
        var lcHD = localStorage.getItem(lcListHD);
        if (lcHD !== null) {
            lcHD = JSON.parse(lcHD);
            for (let i = 0; i < lcHD.length; i++) {
                if (lcHD[i].IDRandom === idRandomHD) {
                    lcHD[i].PTThueHoaDon = ptThue;
                    lcHD[i].TongTienThue = tienThue;
                    lcHD[i].TongThueKhachHang = tienThue;

                    if (lcHD[i].TongTienThueBaoHiem > 0) {
                        changeTaxBH = true;
                    }
                    // alway reset thuebh = 0
                    lcHD[i].TongTienThueBaoHiem = 0;
                    lcHD[i].PTThueBaoHiem = 0;

                    self.HoaDons().TongTienThueBaoHiem(lcHD[i].TongTienThueBaoHiem);
                    self.HoaDons().PTThueBaoHiem(lcHD[i].PTThueBaoHiem);
                    self.HoaDons().TongThueKhachHang(lcHD[i].TongThueKhachHang);
                    break;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(lcHD));
        }

        var isDoiTra = self.HoaDons().LoaiHoaDon() === 6;
        if (changeTaxBH) {
            vmThongTinThanhToanBaoHiem.SetInforBaoHiem_fromHoaDon(self.HoaDons());
            vmThongTinThanhToanBaoHiem.Caculator();
            self.AgreeBaoHiem();
            UpdateCacheHDLe(idRandomHD, isDoiTra, 5);
            BindHD_byIDRandom(idRandomHD);
        }
        else {
            UpdateCacheHDLe(idRandomHD, isDoiTra, 2);
            BindHD_byIDRandom(idRandomHD);
        }
        Update_StatusXuLy_ofHDDatHang(idRandomHD);
        Update_TienThue_forCTHD(idRandomHD, isDoiTra);
        BindCTHD_byIDRandomHD(idRandomHD);
    }

    self.editTongChiPhi = function () {
        var $this = $(event.currentTarget);
        formatNumberObj($this);

        var idRandomHD = self.HoaDons().IDRandom();
        var lcHD = localStorage.getItem(lcListHD);
        if (lcHD !== null) {
            lcHD = JSON.parse(lcHD);
            for (let i = 0; i < lcHD.length; i++) {
                if (lcHD[i].IDRandom === idRandomHD) {
                    lcHD[i].TongChiPhi = formatNumberToFloat($this.val());
                    break;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(lcHD));
        }

        UpdateCacheHDLe(idRandomHD, self.HoaDons().LoaiHoaDon() === 6);
        BindHD_byIDRandom(idRandomHD);
    }

    self.showPopupBaoHiem = function () {
        vmThongTinThanhToanBaoHiem.showModalInsert(self.HoaDons());
    }

    self.XuatKhoAll_Change = function (status) {
        self.HoaDons().XuatKhoAll(status);

        var hd = localStorage.getItem(lcListHD);
        if (hd !== null) {
            hd = JSON.parse(hd);
            for (let i = 0; i < hd.length; i++) {
                if (hd[i].IDRandom === self.HoaDons().IDRandom()) {
                    hd[i].XuatKhoAll = status;
                    break;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(hd));
        }
    }

    self.DuyetBaoGia_Change = function (status) {
        self.HoaDons().DuyetBaoGia(!self.HoaDons().DuyetBaoGia());
        var hd = localStorage.getItem(lcListHD);
        if (hd !== null) {
            hd = JSON.parse(hd);
            for (let i = 0; i < hd.length; i++) {
                if (hd[i].IDRandom === self.HoaDons().IDRandom()) {
                    hd[i].DuyetBaoGia = status;
                    break;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(hd));
        }
    }

    self.editDaTra = function () {
        var $this = $(event.currentTarget);
        formatNumberObj($this);
        var datra = formatNumberToInt($this.val());

        var cantra = self.HoaDons().PhaiThanhToan();
        var tienthua = datra - cantra;
        self.HoaDons().TienThua(tienthua);

        var idRandom = '';
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            for (let i = 0; i < lstHD.length; i++) {
                if (lstHD[i].IDRandom === self.HoaDons().IDRandom()) {
                    lstHD[i].DaThanhToan = datra;
                    lstHD[i].TienMat = datra;
                    lstHD[i].TienGui = 0;
                    lstHD[i].TienATM = 0;
                    lstHD[i].TienThua = tienthua;
                    idRandom = lstHD[i].IDRandom;
                    break;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(lstHD));
            UpdateChietKhauHD_NhanVien(idRandom);
            BindHD_byIDRandom(idRandom);
        }
        Update_StatusXuLy_ofHDDatHang(idRandom);
    }

    self.editHoanTraTamUng = function () {
        var hoantraObj = formatNumberObj($('#txtHoanTraTamUng'));
        var hoantra = formatNumberToInt(hoantraObj);
        if (_maHoaDon === '') {
            _maHoaDon = $('.gara-bill-label li.active font').text();
        }
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            for (let i = 0; i < lstHD.length; i++) {
                if (lstHD[i].MaHoaDon === _maHoaDon && (lstHD[i].NguoiTao === userLogin || lstHD[i].TrangThaiHD === 3)) {
                    lstHD[i].HoanTraTamUng = hoantra;
                    lstHD[i].DaTraKhach = hoantra;
                    lstHD[i].TienMat = hoantra; // hoantra = tienmat
                    lstHD[i].TienATM = 0;
                    lstHD[i].TienGui = 0;
                    lstHD[i].TienTheGiaTri = 0;
                    break;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(lstHD));
        }
    }

    // bind infor HoaDon knockout by IDRandom
    function BindHD_byIDRandom(idRandom) {
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            var itemHD = $.grep(lstHD, function (x) {
                return x.IDRandom === idRandom;
            })
            if (itemHD.length > 0) {
                if (itemHD[0].TienGui === 0 && itemHD[0].TienMat === 0
                    && itemHD[0].TienATM === 0 && itemHD[0].TienTheGiaTri === 0) {
                    itemHD[0].TienMat = itemHD[0].LoaiHoaDon === 3 ? 0 : itemHD[0].PhaiThanhToan;
                }
                // Nếu còn số dư trong thẻ, và trước đó chưa agree
                self.HoaDons().SetData(itemHD[0]);
                if (itemHD[0].StatusOffline) {
                    $('input, select').attr('disabled', 'disabled');
                }
            }
            else {
                self.HoaDons(new FormModel_NewHoaDon());
            }
            self.textSearchPhieuTN(self.HoaDons().MaPhieuTiepNhan())
            if (self.HoaDons().LoaiHoaDon() === 19) {
                vmSearchCar.query = self.HoaDons().BienSo();
            }
            // assign tenbaohiem at component
            $('.gara-bill-result jqauto-customer .gara-search-HH').val(self.HoaDons().TenBaoHiem());
        }
        Enable_DisableNgayLapHD();
    }
    shortcut.add("F1", function () {
        var tabSoDo = $('#tabSoDo')
        if (tabSoDo.css('display') !== 'none') {
            $('#banhangsodo, #banhanghanghoa').removeClass('active');
            $('#tabSoDo li').removeClass('active');
            $('#tabSoDo li:eq(0)').addClass('active');
            $('#banhangsodo').addClass('active');
            $('#banhangsodo').show();
            $('#divListHD').hide();
            self.ClickTab_PhongBan(false)// bind infor time in list PhongBan
        }
    });
    shortcut.add("F2", function () {
        var tabSoDo = $('#tabSoDo')
        if (tabSoDo.css('display') !== 'none') {
            $('#banhangsodo, #banhanghanghoa').removeClass('active');
            $('#tabSoDo li').removeClass('active');
            $('#tabSoDo li:eq(1)').addClass('active');
            $('#banhanghanghoa').addClass('active');
            $('#banhangsodo').hide();
            $('#divListHD').show();
        }
    });
    shortcut.add("F3", function () {
        $('#txtSearchHH').focus();
    });
    shortcut.add("F4", function () {
        $('#txtSearchKH').focus();
    });
    shortcut.add("F7", function () {
        //$('#divTax').trigger('click');
        self.ShowDivTax_HD();
    });
    shortcut.add('F8', function () {
        self.ShowDivSale_HD();
    });
    function Reset_SettingPrint() {
        self.setPrintDraft(false);
        self.setPrintPay(true);
        self.setPrintTicket(false);
        self.setLuuTam(false);
        self.numberOfPrint(1);
    }
    function Check_PrintTicket(itemHD) {
        self.setPrintTicket(false);
        // neu HD tao tu HD dat hang --> printTichet= false
        //if (itemHD.TrangThaiHD === 2) {
        if (itemHD.ID_HoaDon !== null) {
            self.setPrintTicket(false);
        }
        else {
            var lcSetPrint = localStorage.getItem(lcSetPrintConst);
            if (lcSetPrint !== null) {
                lcSetPrint = JSON.parse(lcSetPrint);
                for (let i = 0; i < lcSetPrint.length; i++) {
                    var itemSet = lcSetPrint[i];
                    if (itemSet.LoaiHoaDon === itemHD.LoaiHoaDon && itemSet.ID_DonVi === id_DonVi) {
                        self.setPrintTicket(itemSet.PrintTicket);
                        break;
                    }
                }
            }
        }
        return self.setPrintTicket();
    }
    function Assign_ThongTinPhieuTN_toHoaDon() {
        if (self.HoaDons().ID_PhieuTiepNhan() && self.ThongTinPhieuTiepNhan()) {
            var tn = self.ThongTinPhieuTiepNhan();
            self.InforHDprintf().BienSo = tn.BienSo;
            self.InforHDprintf().ChuXe_DiaChi = tn.ChuXe_DiaChi;
            self.InforHDprintf().ChuXe_Email = tn.ChuXe_Email;
            self.InforHDprintf().ChuXe_SDT = tn.ChuXe_SDT;
            self.InforHDprintf().ChuXe = tn.ChuXe;
            self.InforHDprintf().DungTich = tn.DungTich;
            self.InforHDprintf().HopSo = tn.HopSo;
            self.InforHDprintf().MauSon = tn.MauSon;
            self.InforHDprintf().NamSanXuat = tn.NamSanXuat;
            self.InforHDprintf().NgayVaoXuong = moment(tn.NgayVaoXuong).format('DD/MM/YYYY HH:mm');
            self.InforHDprintf().NgayXuatXuongDuKien = tn.NgayXuatXuongDuKien ? moment(tn.NgayXuatXuongDuKien).format('DD/MM/YYYY HH:mm') : '';
            self.InforHDprintf().NhanVienTiepNhan = tn.NhanVienTiepNhan;
            self.InforHDprintf().SoKhung = tn.SoKhung;
            self.InforHDprintf().SoKmRa = tn.SoKmRa;
            self.InforHDprintf().SoKmVao = tn.SoKmVao;
            self.InforHDprintf().SoMay = tn.SoMay;
            self.InforHDprintf().TenHangXe = tn.TenHangXe;
            self.InforHDprintf().TenMauXe = tn.TenMauXe;
            self.InforHDprintf().TenLoaiXe = tn.TenLoaiXe;
            self.InforHDprintf().TenLienHe = tn.TenLienHe;
            self.InforHDprintf().SoDienThoaiLienHe = tn.SoDienThoaiLienHe;
            self.InforHDprintf().CoVanDichVu = tn.CoVanDichVu;
            self.InforHDprintf().CoVan_SDT = tn.CoVan_SDT;
        }
    }

    self.InNhap = function () {
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            var hd = GetHDOpening_byIDRandom(self.HoaDons().IDRandom(), lstHD);
            if (hd.length > 0) {
                hd = GetInforHDPrint(hd[0]);
                self.InforHDprintf(hd);

                self.InforHDprintf().BH_TenLienHe = hd.LienHeBaoHiem;
                self.InforHDprintf().BH_SDTLienHe = hd.SoDienThoaiLienHeBaoHiem;

                var cthd = localStorage.getItem(lcListCTHD);
                if (cthd !== null) {
                    cthd = JSON.parse(cthd);
                    let arr = $.grep(cthd, function (x) {
                        return x.IDRandomHD === hd.IDRandom;
                    });

                    arr = GetCTHoaDon_FromArr(arr, hd.IDRandom);

                    let arrCTHD_format = GetCTHDPrint_Format(arr);
                    self.CTHoaDonPrint(arrCTHD_format);

                    HDPrint_SumDichVuHangHoa(arr);

                    var machungtu = '';
                    switch (self.HoaDons().LoaiHoaDon()) {
                        case 1:
                        case 25:
                            machungtu = 'HDBL';
                            break;
                        case 3:
                            machungtu = 'DH';
                            break;
                        case 6:
                            machungtu = 'TH';
                            break;
                        case 19:
                            machungtu = 'GDV';
                            break;
                    }
                    self.InHoaDon(machungtu, true);
                }
            }
        }
    }

    function HDPrint_SumDichVuHangHoa(cthd) {
        var arrHH = cthd.filter(x => x.LaHangHoa);
        var arrDV = cthd.filter(x => x.LaHangHoa === false);

        var tongDV = 0, tongDV_truocVAT = 0, tongDV_truocCK = 0;
        var tongHH = 0, tongHH_truocVAT = 0, tongHH_truocCK = 0;
        var DV_tongthue = 0, DV_tongCK = 0, DV_tongSL = 0;
        var HH_tongthue = 0, HH_tongCK = 0, HH_tongSL = 0;
        for (let k = 0; k < arrHH.length; k++) {
            let itFor = arrHH[k];
            let soluong = formatNumberToFloat(itFor.SoLuong);
            HH_tongSL += soluong;
            tongHH += formatNumberToFloat(itFor.ThanhToan);
            tongHH_truocVAT += formatNumberToFloat(itFor.ThanhTien);
            tongHH_truocCK += soluong * formatNumberToFloat(itFor.DonGia);
            HH_tongthue += soluong * formatNumberToFloat(itFor.TienThue);
            HH_tongCK += soluong * formatNumberToFloat(itFor.TienChietKhau);
        }
        for (let k = 0; k < arrDV.length; k++) {
            let itFor = arrDV[k];
            let soluong = formatNumberToFloat(itFor.SoLuong);
            DV_tongSL += soluong;
            tongDV += formatNumberToFloat(itFor.ThanhToan);
            tongDV_truocVAT += formatNumberToFloat(itFor.ThanhTien);
            tongDV_truocCK += soluong * formatNumberToFloat(itFor.DonGia);
            DV_tongthue += soluong * formatNumberToFloat(itFor.TienThue);
            DV_tongCK += soluong * formatNumberToFloat(itFor.TienChietKhau);
        }

        self.InforHDprintf().TongSL_PhuTung = HH_tongSL;
        self.InforHDprintf().TongTienPhuTung = formatNumber3Digit(tongHH);
        self.InforHDprintf().TongThue_PhuTung = formatNumber3Digit(HH_tongthue);
        self.InforHDprintf().TongCK_PhuTung = formatNumber3Digit(HH_tongCK);
        self.InforHDprintf().TongTienPhuTung_TruocVAT = formatNumber3Digit(tongHH_truocVAT);
        self.InforHDprintf().TongTienPhuTung_TruocCK = formatNumber3Digit(tongHH_truocCK);

        self.InforHDprintf().TongSL_DichVu = DV_tongSL;
        self.InforHDprintf().TongTienDichVu = formatNumber3Digit(tongDV);
        self.InforHDprintf().TongThue_DichVu = formatNumber3Digit(DV_tongthue);
        self.InforHDprintf().TongCK_DichVu = formatNumber3Digit(DV_tongCK);
        self.InforHDprintf().TongTienDichVu_TruocVAT = formatNumber3Digit(tongDV_truocVAT);
        self.InforHDprintf().TongTienDichVu_TruocCK = formatNumber3Digit(tongDV_truocCK);
    }

    function Check_AutoPrint(loaiHoaDon) {
        let print = true;
        if (loaiHoaDon === 25) {
            loaiHoaDon = 1;
        }
        var lcSetPrint = localStorage.getItem(lcSetPrintConst);
        if (lcSetPrint !== null) {
            lcSetPrint = JSON.parse(lcSetPrint);
            for (let i = 0; i < lcSetPrint.length; i++) {
                let itemSet = lcSetPrint[i];
                if (itemSet.LoaiHoaDon === loaiHoaDon && itemSet.ID_DonVi === id_DonVi) {
                    print = self.setPrintPay();
                    break;
                }
            }
        }
        return print;
    }

    // maChungTu (DM_LoaiChungTu)
    self.InHoaDon = function (maChungTu, isPrintDraft) {
        var loaiHoaDon = self.HoaDons().LoaiHoaDon();
        if (loaiHoaDon === 25) {
            loaiHoaDon = 1;
        }
        // if not reset, get value old
        Reset_SettingPrint();
        var idTemPrint = $('#ddlTempPrint').val();
        // if set print when pay --> print
        var lcSetPrint = localStorage.getItem(lcSetPrintConst);
        if (lcSetPrint !== null) {
            lcSetPrint = JSON.parse(lcSetPrint);
            for (let i = 0; i < lcSetPrint.length; i++) {
                var itemSet = lcSetPrint[i];
                if (itemSet.LoaiHoaDon === loaiHoaDon && itemSet.ID_DonVi === id_DonVi) {
                    self.setPrintDraft(itemSet.PrintDraft);
                    self.setPrintPay(itemSet.PrintPay);
                    self.setPrintTicket(itemSet.PrintTicket);
                    self.numberOfPrint(formatNumberToInt(itemSet.NumberOfPrint));
                    idTemPrint = itemSet.TempPrint;
                    break;
                }
            }
        }
        var print = false;
        // if is PrintDraft --> cho phep in
        if (isPrintDraft === true || loaiHoaDon === 12) {
            print = true;
        }
        else {
            if (self.setPrintTicket() === true) {
                print = true;
            }
            else {
                print = self.setPrintPay();
            }
        }
        if (print) {
            // assign value of phieutiepnhan to hoadon
            var itemMauIn = [];
            if (idTemPrint === undefined || idTemPrint === null) {
                // neu chua cai dat mau in --> get mau mac dinh
                itemMauIn = $.grep(self.DM_MauIn(), function (x) {
                    return x.MaLoaiChungTu === maChungTu && x.LaMacDinh;
                });
            }
            else {
                // get temp by ID is selected
                itemMauIn = $.grep(self.DM_MauIn(), function (x) {
                    return x.ID === idTemPrint && x.MaLoaiChungTu === maChungTu;
                });
                // Vì khi load lần đầu, đã load mẫu mặc định của hóa đơn,
                // nên bị lấy lại id mẫu in cũ của hóa đơn
                // vì vậy phải check lại id mẫu in và mã chứng từ
                if (itemMauIn.length === 0) {
                    itemMauIn = $.grep(self.DM_MauIn(), function (x) {
                        return x.MaLoaiChungTu === maChungTu && x.LaMacDinh;
                    });
                }
            }
            var url = '';
            if (itemMauIn.length > 0) {
                url = '/api/DanhMuc/ThietLapApi/GetContentFIlePrint?idMauIn=' + itemMauIn[0].ID;
            }
            else {
                url = '/api/DanhMuc/ThietLapApi/GetContentFIlePrintTypeChungTu?maChungTu=' + maChungTu + '&idDonVi=' + id_DonVi;
            }

            HDPrint_SumDichVuHangHoa(self.CTHoaDonPrint());
            Assign_ThongTinPhieuTN_toHoaDon();

            ajaxHelper(url, 'GET').done(function (result) {
                let temp = result;
                let data = ''.concat('<script src="/Scripts/knockout-3.4.2.js"></script>');
                data = data.concat("<script > var item1= ", JSON.stringify(self.CTHoaDonPrint()), ';',
                    " var item2= ", JSON.stringify(self.CTHoaDonPrintMH()), ' ;',
                    " var item3= ", JSON.stringify(self.InforHDprintf()), ' ;',
                    " var item4= ", JSON.stringify(self.HangMucSuaChuas()), ' ;',
                    " var item5= ", JSON.stringify(self.VatDungKemTheos()), ' ;',
                    " </script>");
                data = data.concat(" <script type='text/javascript' src='/Scripts/Thietlap/MauInTeamplate.js'></script>");
                PrintExtraReport(temp, data, self.numberOfPrint(), isPrintDraft === true ? 0 : 1);
            }).fail(function () {
                if (itemMauIn.length > 0) {
                    var dulieuMauIn = ReplaceString_toData(itemMauIn[0].DuLieuMauIn);
                    var dulieuMauIn1 = ''.concat('<script src="/Scripts/knockout-3.4.2.js"></script>');
                    dulieuMauIn1 = dulieuMauIn1.concat("<script > var item1=" + JSON.stringify(self.CTHoaDonPrint())
                        + "; var item2=" + JSON.stringify(self.CTHoaDonPrintMH())
                        + "; var item3=" + JSON.stringify(self.InforHDprintf()) + "; </script>");
                    dulieuMauIn1 = dulieuMauIn1.concat('<script type="text/javascript"> ',
                        "function ConvertMinutes_ToHourMinutes(sophut) { ",
                        " sophut = parseFloat(sophut); ",
                        " sophut = Math.round(sophut * Math.pow(10, 2)) / Math.pow(10, 2); ",
                        " var lastone = sophut.toString().split('').pop(); ",
                        " if (lastone !== '.') {",
                        " sophut = parseFloat(sophut);",
                        " }",
                        " var div = sophut / 60;",
                        " var hours = Math.floor(div);",
                        " var minutes = parseFloat((div - hours) * 60);",
                        " if (hours > 0) {",
                        " return hours.toString().concat(' giờ ', minutes, ' phút');",
                        " }",
                        " return minutes.toString().concat(' phút'); } </script>"
                    );
                    // tránh lỗi chưa load được file MauInTeamplate.js từ server (declare at here)
                    dulieuMauIn1 = dulieuMauIn1.concat('<script type="text/javascript"> var dataMauIn = function () {' +
                        'var self = this;' +
                        'self.CTHoaDonPrint = ko.observableArray(item1);' +
                        'self.CTHoaDonPrintMH = ko.observableArray(item2);' +
                        'self.InforHDprintf = ko.observable(item3);' +
                        '};' +
                        'ko.applyBindings(new dataMauIn()) </script> ');
                    PrintExtraReport(dulieuMauIn, dulieuMauIn1, self.numberOfPrint());
                }

            })
        }
    }
    self.showpopuptrahangHD = function () {
        vmTraHang.ID_DonVi = id_DonVi;
        vmTraHang.LoaiNganhNghe = self.LoaiNganhNghe();
        if (!commonStatisJs.CheckNull(self.HoaDons().MaHoaDon()) && self.HoaDons().MaHoaDon().indexOf('DV') > -1) {
            vmTraHang.LoaiHoaDon = 19;
        }
        else {
            vmTraHang.LoaiHoaDon = 1;
        }
        vmTraHang.showModal();
    }

    self.filterMaHD = ko.observable();
    self.arrPagging = ko.observableArray();
    self.pageSizeTraHang = ko.observable(10);
    self.currentPageTraHang = ko.observable(0);
    self.fromItemTraHang = ko.observable(1);
    self.toItemTraHang = ko.observable();
    self.PageCountTrahang = ko.computed(function () {
        if (self.pageSizeTraHang()) {
            if (self.arrPagging() !== null) {
                return Math.ceil(self.arrPagging().length / self.pageSizeTraHang());
            }
            else {
                return 0
            }
        }
        else {
            return 1;
        }
    });
    self.filteredHDTraHang = ko.computed(function () {
        var first = self.currentPageTraHang() * self.pageSizeTraHang();
        var filterMaHD = self.filterMaHD();
        var arrFilter;
        if (filterMaHD) {
            arrFilter = ko.utils.arrayFilter(self.HoaDonTHs(), function (prod) {
                var arr = locdau(prod.TenDoiTuong).split(/\s+/);
                var sSearch = '';
                for (let i = 0; i < arr.length; i++) {
                    sSearch += arr[i].toString().split('')[0];
                }
                return (locdau(prod.MaHoaDon).indexOf(locdau(filterMaHD)) >= 0 ||
                    locdau(prod.TenDoiTuong).indexOf(locdau(filterMaHD)) >= 0 ||
                    locdau(prod.DienThoai).indexOf(locdau(filterMaHD)) >= 0 ||
                    sSearch.indexOf(locdau(filterMaHD))) >= 0;
            });
        }
        else {
            if (self.filterFromDate()) {
                var ngayLapHD = moment(self.filterFromDate(), 'DD/MM/YYYY').format('YYYY-MM-DD');
                arrFilter = ko.utils.arrayFilter(self.HoaDonTHs(), function (prop) {
                    return (moment(prop.NgayLapHoaDon).format('YYYY-MM-DD') === ngayLapHD);
                });
            }
            else {
                arrFilter = self.HoaDonTHs();
            }
        }
        if (arrFilter !== null) {
            self.arrPagging(arrFilter);
            self.fromItemTraHang((self.currentPageTraHang() * self.pageSizeTraHang()) + 1);
            if (((self.currentPageTraHang() + 1) * self.pageSizeTraHang()) > arrFilter.length) {
                self.toItemTraHang(arrFilter.length)
            } else {
                self.toItemTraHang((self.currentPageTraHang() * self.pageSizeTraHang()) + self.pageSizeTraHang());
            }
            if (self.PageCountTrahang() > 1) {
                // neu currentPageTraHang > tong so trang (tuc currentPageTraHang = PageCountTrahang vi PageCountTrahang bat du tu trang 0)
                if (self.currentPageTraHang() === self.PageCountTrahang()) {
                    self.currentPageTraHang(0);
                }
                return arrFilter.slice(self.currentPageTraHang() * self.pageSizeTraHang(), (self.currentPageTraHang() * self.pageSizeTraHang()) + self.pageSizeTraHang())
            }
            else {
                return arrFilter;
            }
        }
    });
    self.PageListTraHang = ko.computed(function () {
        var arrPage = [];
        var allPage = self.PageCountTrahang();
        var currentPage = self.currentPageTraHang();
        if (allPage > 4) {
            var i = 0;
            if (currentPage === 0) {
                i = parseInt(self.currentPageTraHang()) + 1;
            }
            else {
                i = self.currentPageTraHang();
            }
            if (allPage >= 5 && currentPage > allPage - 5) {
                if (currentPage >= allPage - 2) {
                    // get 5 trang cuoi cung
                    for (let i = allPage - 5; i < allPage; i++) {
                        let obj = {
                            pageNumber: i + 1,
                        };
                        arrPage.push(obj);
                    }
                }
                else {
                    // get currentPage - 2 , currentPage, currentPage + 2
                    for (let j = currentPage - 2; (j <= currentPage + 2) && j < allPage; j++) {
                        let obj = {
                            pageNumber: j + 1,
                        };
                        arrPage.push(obj);
                    }
                }
            }
            else {
                // get 5 trang dau
                if (i >= 2) {
                    while (arrPage.length < 5) {
                        let obj = {
                            pageNumber: i - 1,
                        };
                        arrPage.push(obj);
                        i = i + 1;
                    }
                }
                else {
                    while (arrPage.length < 5) {
                        let obj = {
                            pageNumber: i,
                        };
                        arrPage.push(obj);
                        i = i + 1;
                    }
                }
            }
        }
        else {
            // neu chi co 1 trang --> khong hien thi DS trang
            if (allPage > 1) {
                for (let i = 0; i < allPage; i++) {
                    let obj = {
                        pageNumber: i + 1,
                    };
                    arrPage.push(obj);
                }
            }
        }
        return arrPage;
    });
    self.GoToPageTraHang = function (page) {
        self.currentPageTraHang(page.pageNumber - 1);
    };
    self.GetClassTraHang = function (page) {
        return ((page.pageNumber - 1) === self.currentPageTraHang()) ? "click" : "";
    };
    self.StartPageTraHang = function (page) {
        self.currentPageTraHang(0);
    };
    self.BackPageTraHang = function (page) {
        if (self.currentPageTraHang() > 1) {
            self.currentPageTraHang(self.currentPageTraHang() - 1);
        }
    };
    self.GoToNextPageTraHang = function (page) {
        if (self.currentPageTraHang() < self.PageCountTrahang() - 1) {
            self.currentPageTraHang(self.currentPageTraHang() + 1);
        }
    };
    self.EndPageTraHang = function (page) {
        if (self.currentPageTraHang() < self.PageCountTrahang() - 1) {
            self.currentPageTraHang(self.PageCountTrahang() - 1);
        }
    };
    self.VisibleStartPageTraHang = ko.computed(function () {
        if (self.PageListTraHang().length > 0) {
            return self.PageListTraHang()[0].pageNumber !== 1;
        }
    });
    self.VisibleEndPageTraHang = ko.computed(function () {
        if (self.PageListTraHang().length > 0) {
            return self.PageListTraHang()[self.PageListTraHang().length - 1].pageNumber !== self.PageCountTrahang();
        }
    });
    // End Solution 2
    self.HideShow_ListBangGia = function () {
        var $this = $(event.currentTarget);
        var thisChild = $this.next();
        // show Lst BangGia if not HD offline or TraHang from HD
        var check = CheckHDOffline_orTraHangfromHD();
        if (check === 0) {
            if (thisChild.css('display') === 'none') {
                thisChild.show();
            }
            else {
                thisChild.hide();
            }
            $this.find("font i").toggle();
        }
        // neu chua load dc bangia: load lai o day
        BindLstBangGia_byNhanVien_andDoiTuong();
    }
    // use when click show list BangGia, NhanVien, ChiNhanh
    function CheckHDOffline_orTraHangfromHD() {
        var lstHD = localStorage.getItem(lcListHD);
        // 1.HD offline, 2.TraHang from HD
        // 0.Cac truong hop con lai
        var check = 0;
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            if (_maHoaDon === '') {
                _maHoaDon = $('.gara-bill-label li.active font').text();
            }
            var itemHD = GetHDOpening_byMaHoaDon(_maHoaDon, lstHD);
            // if HD offline OR TraHang from HD
            if (itemHD.length > 0) {
                if (itemHD[0].StatusOffline) {
                    check = 1;
                }
                else {
                    if (itemHD[0].LoaiHoaDon === 6 && itemHD[0].ID_HoaDon !== null) {
                        check = 2;
                    }
                }
            }
        }
        return check;
    }

    $('#vmTraHang').on('hidden.bs.modal', function () {
        if (vmTraHang.saveOK) {
            if (vmTraHang.isTraNhanh) {
                newModelBanLe.TraNhanh();
            }
            else {
                newModelBanLe.clickChonTraHang(vmTraHang.invoiceChosing);
            }
        }
    });

    self.clickChonTraHang = function (item) {
        // check Thoi gian tra hang sau khi mua hang
        if (self.ThietLap().GioiHanThoiGianTraHang) {
            if (self.ThietLap_TraHang().length > 0) {
                var soNgay = self.ThietLap_TraHang()[0].SoNgayGioiHan;
                var dtNow = new Date(moment(new Date()).format('YYYY-MM-DD'));
                var dtNgayLapHDGoc = new Date(moment(item.NgayLapHoaDon).format('YYYY-MM-DD'));
                // get milliseconds betwwen 2 days
                var diff = new Date(dtNow - dtNgayLapHDGoc);
                // get days
                var days = diff / 1000 / 60 / 60 / 24;
                // nếu trả hàng quá số ngày cho phép
                if (soNgay < days) {
                    if (self.ThietLap_TraHang().ChoPhepTraHang) {
                        // show warning, but vẫn cho trả hàng
                        ShowMessage_Danger('Hóa đơn đã quá thời gian trả hàng, nhưng vẫn cho phép trả nếu bạn muốn');
                    }
                    else {
                        // không cho trả
                        ShowMessage_Danger('Hóa đơn chỉ được đổi trả trong vòng ' + soNgay + ' ngày');
                        return;
                    }
                }
            }
        }
        $('#btnSave').css('display', '');
        $('#btnSaveDatHang, #btnTaoHD').css('display', 'none');
        self.DateHDDefault(moment(serverTime).format('DD/MM/YYYY'));
        self.TimeHDDefault(moment(serverTime).format('HH:mm'));
        // if is opening TraHang of HD --> not add
        var isOpening = false;
        for (let i = 0; i < self.PhongBanSelected().length; i++) {
            if (self.PhongBanSelected()[i].LoaiHoaDon === 6) {
                let itemFor = self.PhongBanSelected()[i];
                if (itemFor.MaHoaDonTraHang === item.MaHoaDon) {
                    _maHoaDon = itemFor.MaHoaDon;
                    isOpening = true;
                    break;
                }
            }
        }
        var nameMaHD = nameHD_TraHang;
        var isTraGoiDV = false;
        if (item.LoaiHoaDon === 19) {
            nameMaHD = 'Trả gói DV ';
            isTraGoiDV = true;
        }
        if (!isOpening) {
            var lstHDLe = localStorage.getItem(lcListHD);
            if (lstHDLe !== null) {
                lstHDLe = JSON.parse(lstHDLe);
                max = GetMax_MaHoaDon(6, lstHDLe);
            }
            else {
                lstHDLe = [];
                var newObjFirst = newHoaDon(1, '1');
                lstHDLe.push(newObjFirst);
                max = 0;
            }
            _maHoaDon = nameMaHD + (max + 1);
            localStorage.setItem(lcMaHD, _maHoaDon);
            self.HoaDons().MaHoaDon(_maHoaDon);

            if (item.ID_BangGia === null) {
                item.ID_BangGia = const_GuidEmpty;
            }
            var objNew = newHoaDonTraHang(item, nameMaHD + (max + 1));
            objNew.ThuTuThe = item.ThuTuThe;// gtri Thanh toán từ thẻ gtrị sau khi trả hàng
            lstHDLe.push(objNew);
            localStorage.setItem(lcListHD, JSON.stringify(lstHDLe));
            GetCurrentPage_byMaHoaDon(_maHoaDon)
            // add in cache CTHD
            var lstCTHD = localStorage.getItem(lcListCTHD);
            if (lstCTHD === null || lstCTHD.length === 0) {
                lstCTHD = [];
            }
            else {
                lstCTHD = JSON.parse(lstCTHD);
            }
            // remove CTHD is TP dinh luong (only get DichVu or HangHoa)
            item.BH_HoaDon_ChiTiet = $.grep(item.BH_HoaDon_ChiTiet, function (x) {
                return x.ID === x.ID_ChiTietDinhLuong || x.ID_ChiTietDinhLuong === null;
            })
            // order by SoThuTu ASC --> group Hang Hoa by LoHang
            var cthdDB = item.BH_HoaDon_ChiTiet.sort(function (a, b) {
                var x = a.SoThuTu,
                    y = b.SoThuTu;
                return x < y ? -1 : x > y ? 1 : 0;
            });

            // neu combo --> chi get TP con
            var cthd = [];
            for (let i = 0; i < cthdDB.length; i++) {
                if (cthdDB[i].ID === cthdDB[i].ID_ParentCombo) {
                    for (let j = 0; j < cthdDB[i].ThanhPhanComBo.length; j++) {
                        cthd.push(cthdDB[i].ThanhPhanComBo[j]);
                    }
                }
                else {
                    cthd.push(cthdDB[i]);
                }
            }

            var arrIDQuiDoi = [];
            var cthdLoHang = [];
            // get chi tiet HoaDon with MHD = Hoa don tra hang
            for (let i = 0; i < cthd.length; i++) {
                cthd[i].MaHoaDon = _maHoaDon;
                cthd[i].IDRandomHD = objNew.IDRandom;
                cthd[i].LoaiHoaDon = 6;
                cthd[i].SoLuongDaMua = cthd[i].SoLuongConLai;
                cthd[i].SoLuong = 0;
                cthd[i].ThanhTien = 0;
                cthd[i].DVTinhGiam = "%";
                cthd[i].PTChietKhau = 0;
                cthd[i].TienChietKhau = 0;
                cthd[i].ThanhToan = 0;
                cthd[i].GiaBan = cthd[i].DonGia - cthd[i].GiamGia;// !important : get thue from DB
                cthd[i].DonGia = cthd[i].GiaBan; // change DonGia = GiaBan
                cthd[i].CssWarning = false;
                cthd[i].ThanhPhan_DinhLuong = [];

                let quanlytheolo = cthd[i].QuanLyTheoLoHang;
                cthd[i].QuanLyTheoLoHang = quanlytheolo;
                cthd[i].DM_LoHang = [];
                cthd[i].LotParent = quanlytheolo;
                cthd[i].ID_ChiTietGoiDV = cthd[i].ID; // luu de khong tinh TonKho khi TraGoi (phan biet qua ID_ChiTietGoiDV)
                cthd[i].ChatLieu = '1';// tra HD
                if (isTraGoiDV) {
                    cthd[i].ChatLieu = '2'; // tra goidv
                }
                cthd[i] = SetDefaultPropertierCTHD(cthd[i]);
                // delete key ID, ID_HoaDon ==> save not error
                delete cthd[i]['ID'];
                delete cthd[i]['ID_HoaDon'];

                let lotSX = GetNgaySX_NgayHH(cthd[i]);
                cthd[i].NgaySanXuat = lotSX.NgaySanXuat;
                cthd[i].NgayHetHan = lotSX.NgayHetHan;

                cthd[i] = AssignThanhPhanComBo_toCTHD(cthd[i]);

                if (commonStatisJs.CheckNull(cthd[i].DonGiaBaoHiem)) {
                    cthd[i].DonGiaBaoHiem = 0;
                }

                // find in cthdLoHang with same ID_QuiDoi, TangKem !== this TagKem 
                let itemCT_before = $.grep(cthdLoHang, function (x) {
                    return x.ID_DonViQuiDoi === cthd[i].ID_DonViQuiDoi && x.TangKem !== cthd[i].TangKem;
                })
                // if HangTang: add into CTHD 1 row
                if ($.inArray(cthd[i].ID_DonViQuiDoi, arrIDQuiDoi) === -1 || itemCT_before.length > 0) {

                    arrIDQuiDoi.unshift(cthd[i].ID_DonViQuiDoi);
                    cthd[i].SoThuTu = arrIDQuiDoi.length;
                    cthd[i].IDRandom = CreateIDRandom('RandomCT_');

                    if (quanlytheolo) {
                        let objLot = $.extend({}, cthd[i]);
                        objLot.HangCungLoais = [];
                        objLot.DM_LoHang = [];
                        cthd[i].DM_LoHang.push(objLot);
                    }
                    cthdLoHang.unshift(cthd[i]);
                }
                else {
                    // find in cthdLoHang with same ID_QuiDoi
                    for (let j = 0; j < cthdLoHang.length; j++) {
                        if (cthdLoHang[j].ID_DonViQuiDoi === cthd[i].ID_DonViQuiDoi) {
                            if (quanlytheolo) {
                                let objLot = $.extend({}, cthd[i]);
                                objLot.IDRandom = CreateIDRandom('RandomCT_');
                                objLot.HangCungLoais = [];
                                objLot.DM_LoHang = [];
                                objLot.LotParent = false;
                                cthdLoHang[j].DM_LoHang.push(objLot);
                            }
                            else {
                                cthd[i].IDRandom = CreateIDRandom('RandomCT_');
                                cthd[i].LaConCungLoai = true;
                                cthdLoHang[j].HangCungLoais.push(cthd[i]);
                            }
                            break;
                        }
                    }
                }
            }
            // push in cache CTHD (xu li nhieu CT cung luc)
            for (let i = 0; i < cthdLoHang.length; i++) {
                lstCTHD.push(cthdLoHang[i]);
            }
            localStorage.setItem(lcListCTHD, JSON.stringify(lstCTHD));
            // set cache CTTraHang --> check when add HangHoa
            var cacheCTTH = localStorage.getItem(lcCTHDTraHang_fromHD);
            if (cacheCTTH !== null) {
                cacheCTTH = JSON.parse(cacheCTTH);
                for (let i = 0; i < cthdLoHang.length; i++) {
                    cacheCTTH.push(cthdLoHang[i]);
                }
            }
            else {
                // because item.BH_HoaDon_ChiTiet is a array
                cacheCTTH = cthdLoHang;
            }
            localStorage.setItem(lcCTHDTraHang_fromHD, JSON.stringify(cacheCTTH));
            var arrCTHD = $.grep(lstCTHD, function (item) {
                return item.IDRandomHD === objNew.IDRandom;
            });
            self.HangHoaAfterAdds(arrCTHD);
            self.NewProducts([]);
            GetInForCustomer_byID(item.ID_DoiTuong);
            self.SetNhanVien(item.ID_NhanVien);
            self.SetBangGia(item.ID_BangGia);
            self.SetChiNhanh(item.ID_DonVi);
            self.HoaDons().SetData(objNew);
            self.PhongBanSelected.push(objNew);
        }
        else {
            // Find HD Tra Hang and active
            let hd = localStorage.getItem(lcListHD);
            hd = JSON.parse(hd);
            let itemChose = GetHDOpening_byMaHoaDon(_maHoaDon, hd);
            GetInForCustomer_byID(itemChose[0].ID_DoiTuong);
            self.SetNhanVien(itemChose[0].ID_NhanVien);
            self.SetChiNhanh(itemChose[0].ID_DonVi);
            self.SetBangGia(itemChose[0].ID_BangGia);
            BindCTHD_byIDRandomHD(itemChose[0].IDRandom);
            self.HoaDons().SetData(itemChose[0]);

            var arrCTHD_TH = [];
            var cthd_TraHang = localStorage.getItem(lcListCTHD_DoiTra);
            if (cthd_TraHang !== null) {
                cthd_TraHang = JSON.parse(cthd_TraHang);
                arrCTHD_TH = $.grep(cthd_TraHang, function (item) {
                    return item.IDRandomHD === itemChose[0].IDRandom;
                });
                if (arrCTHD_TH.length > 0) {
                    ShowMuaHang();
                }
                else {
                    HideMuaHang();
                }
            }
            else {
                HideMuaHang();
            }
            GetCurrentPage_byMaHoaDon(_maHoaDon);
        }

        Call_6Func();
        ActiveTab_SoDoPhong(false);

    }
    shortcut.add('ESC', function (item) {
        $('#txtDaThanhToan').select();
    });

    $('#btnDongBoHoa').click(function () {
        self.DongBoHoa();
    });


    function ShowMuaHang() {
        if ($('#HangHoaView').hasClass("sli-gos")) {
            $("#CTHDView").addClass("height99");
        } else {
            $("#CTHDView").removeClass("height99");
        }
        $(".slider").show();
        $('#HangHoaView').show();
        $('#divMuaHang').show();
    }
    function HideMuaHang() {
        $(".slider").hide();
        $('#HangHoaView').hide();
        $('#divMuaHang').hide();
    }
    function ShowDivDefault() {
        $('#CTHDView').show();
        $('#divGhiChu,#divMenuRight').show();// khong can show divListHD, vi neu view Sodo Phong, thi div nay se bi hien thi
    }

    // get list chi nhanh
    function GetInforChiNhanh() {
        ajaxHelper('/api/DM_DonViAPI/' + 'GetListDonVi1', 'GET').done(function (data) {
            if (data !== null) {
                self.ChiNhanhs(data);
                vmThemMoiNhomKhach.listData.ChiNhanhs = data;
                $('#divChiNhanh0').show();
                WriteData_Dexie(db.DM_DonVi, data);
            }
        });
    }
    // Tra Hang
    function UpdateHD_TraHang(idRandomHD) {
        var lstHD = localStorage.getItem(lcListHD);
        lstHD = JSON.parse(lstHD);
        // caculator TongTien at CTHD
        var cthd = localStorage.getItem(lcListCTHD);
        cthd = JSON.parse(cthd);
        var sumTH = 0;
        var thueCT = 0;
        for (let i = 0; i < cthd.length; i++) {
            if (cthd[i].IDRandomHD === idRandomHD) {
                sumTH += cthd[i].ThanhTien;
                thueCT += cthd[i].TienThue * cthd[i].SoLuong;
                for (let j = 1; j < cthd[i].DM_LoHang.length; j++) {
                    sumTH += cthd[i].DM_LoHang[j].ThanhTien;
                    thueCT += cthd[i].DM_LoHang[j].TienThue * cthd[i].DM_LoHang[j].SoLuong;
                }
                for (let j = 0; j < cthd[i].HangCungLoais.length; j++) {
                    sumTH += cthd[i].HangCungLoais[j].ThanhTien;
                    thueCT += cthd[i].HangCungLoais[j].TienThue * cthd[i].HangCungLoais[j].SoLuong;
                }
            }
        }
        for (let i = 0; i < lstHD.length; i++) {
            if (lstHD[i].IDRandom === idRandomHD) {
                // trahang
                lstHD[i].TongGiaGocHangTra = sumTH;
                lstHD[i].TongThueDB = thueCT;

                if (lstHD[i].PTThueDB > 0) {
                    lstHD[i].TongThueDB = lstHD[i].PTThueDB * sumTH / 100;
                }
                if (isNaN(lstHD[i].TongThueDB)) {
                    lstHD[i].TongThueDB = 0;
                }

                let tongtra = sumTH - lstHD[i].TongChiPhiHangTra + lstHD[i].TongThueDB;
                if (lstHD[i].PTGiamDB > 0) {
                    lstHD[i].TongGiamGiaDB = lstHD[i].PTGiamDB * tongtra / 100;
                }
                tongtra = tongtra - lstHD[i].TongGiamGiaDB;
                tongtra = tongtra < 0 ? 0 : tongtra;
                lstHD[i].TongTienTra = tongtra;

                // muahang
                let tongmua = lstHD[i].TongTienHang - formatNumberToFloat(lstHD[i].TongGiamGiaKM_HD);
                tongmua = tongmua < 0 ? 0 : tongmua;
                lstHD[i].TongTienMua = tongmua;

                // phaithanhtoan thuần (chưa trừ trả hàng, đặt cọc,...)
                let phaiTTKH = tongmua - lstHD[i].TongTienBHDuyet
                    + lstHD[i].KhauTruTheoVu + lstHD[i].GiamTruBoiThuong + lstHD[i].TongThueKhachHang;

                let phaiTT = phaiTTKH - tongtra;
                if (phaiTT < 0) {
                    lstHD[i].HoanTraTamUng = Math.abs(phaiTT);
                    lstHD[i].DaTraKhach = lstHD[i].HoanTraTamUng;
                    lstHD[i].TienMat = lstHD[i].HoanTraTamUng;
                    lstHD[i].DaThanhToan = 0;
                }
                else {
                    lstHD[i].DaThanhToan = phaiTT;
                    lstHD[i].TienMat = phaiTT;
                    lstHD[i].HoanTraTamUng = 0;
                    lstHD[i].DaTraKhach = 0;
                }
                lstHD[i].PhaiThanhToan = phaiTTKH;
                lstHD[i].TongThanhToan = phaiTTKH;

                lstHD[i].TienGui = 0;
                lstHD[i].TienATM = 0;
                lstHD[i].TienTheGiaTri = 0;
                lstHD[i].TienThua = 0;
                break;
            }
        }
        localStorage.setItem(lcListHD, JSON.stringify(lstHD));
    }

    self.addLot_DoiTra = function (item) {
        if (_maHoaDon === '') {
            _maHoaDon = $('.gara-bill-label li.active font').text();
        }
        var idQuiDoi = item.ID_DonViQuiDoi;
        var cthd = localStorage.getItem(lcListCTHD_DoiTra);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            var idRandomHD = GetIDRandomHD_byMaHoaDon(_maHoaDon);
            var idRandomCungLoai = '';
            if (item.QuanLyTheoLoHang === false) {
                // add HangCungLoai
                // find cthd parent & add same
                let cthdPr = $.grep(cthd, function (x) {
                    return x.ID_DonViQuiDoi === idQuiDoi && x.ID_ChiTietGoiDV === item.ID_ChiTietGoiDV;
                });
                if (cthdPr.length > 0) {
                    for (let i = 0; i < cthd.length; i++) {
                        if (cthd[i].IDRandom === cthdPr[0].IDRandom) {
                            let cungloai = $.extend({}, cthd[i]);
                            cungloai.SoLuong = 1;
                            let obj = newHangHoa(cungloai, null, true);
                            idRandomCungLoai = obj.IDRandom;
                            cthd[i].HangCungLoais.push(obj);
                            break;
                        }
                    }
                }
            }
            else {
                // add Lot    
                for (let i = 0; i < cthd.length; i++) {
                    var itFor = cthd[i];
                    if (itFor.IDRandomHD === idRandomHD && itFor.ID_DonViQuiDoi === idQuiDoi) {
                        let lohang = $.extend({}, itFor);
                        lohang.SoLuong = 1;
                        let countLot = itFor.DM_LoHang.length;
                        let idRandom = CreateIDRandom('RandomCT_');
                        lohang.SoLuong = 1;
                        let objLot = newHangHoa(lohang, null, true);
                        objLot.NgaySanXuat = itFor.NgaySanXuat;
                        objLot.NgayHetHan = itFor.NgayHetHan;
                        objLot.LotParent = false;
                        objLot.IDRandom = idRandom;
                        objLot.SoThuTu = countLot + 1;
                        objLot.DM_LoHang = [];
                        objLot.HangCungLoais = [];
                        objLot.ThanhPhan_DinhLuong = [];
                        objLot.BH_NhanVienThucHien = [];
                        cthd[i].DM_LoHang.push(objLot);
                        break;
                    }
                }
            }
            localStorage.setItem(lcListCTHD_DoiTra, JSON.stringify(cthd));
            UpdateCacheHDLe(idRandomHD, true);
            UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();
            if (!commonStatisJs.CheckNull(idRandomCungLoai)) {
                UpdateSoLuong_TPDinhLuong_ofCTHD(idRandomHD, idRandomCungLoai, 1, true);
            }
            BindHD_byIDRandom(idRandomHD);
            Focus_InputPhaiThanhToan();
            var arrCTHD = $.grep(cthd, function (item) {
                return item.IDRandomHD === idRandomHD;
            });
            self.NewProducts(arrCTHD);
            HideShow_Icon_ChietKhauNV();
        }
    };
    self.RemoveLot_DoiTra = function (item) {
        var idRandomHD = item.IDRandomHD;
        // item: DM_LoHang
        var cthd = localStorage.getItem(lcListCTHD_DoiTra);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            for (let i = 0; i < cthd.length; i++) {
                let itemCT = cthd[i];
                if (itemCT.IDRandomHD === idRandomHD && itemCT.ID_DonViQuiDoi === item.ID_DonViQuiDoi) {
                    for (let j = 0; j < itemCT.DM_LoHang.length; j++) {
                        if (itemCT.DM_LoHang[j].IDRandom === item.IDRandom) {
                            cthd[i].DM_LoHang.splice(j, 1);
                            break;
                        }
                    }
                    break;
                }
            }
            // update agin STT for DM_Lo
            for (let i = 0; i < cthd.length; i++) {
                let itemCT = cthd[i];
                if (itemCT.IDRandomHD === idRandomHD && itemCT.ID_DonViQuiDoi === item.ID_DonViQuiDoi) {
                    for (let j = 0; j < itemCT.DM_LoHang.length; j++) {
                        cthd[i].DM_LoHang[j].SoThuTu = (j + 1);
                    }
                    break;
                }
            }
            localStorage.setItem(lcListCTHD_DoiTra, JSON.stringify(cthd));
            UpdateCacheHDLe(idRandomHD, true);
            UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();
            BindHD_byIDRandom(idRandomHD);
            Focus_InputPhaiThanhToan();
            // hide divMuaHang if not CTHD
            var arrCTHD = $.grep(cthd, function (item) {
                return item.IDRandomHD === idRandomHD;
            });
            self.NewProducts(arrCTHD);
        }
        HideShow_Icon_ChietKhauNV();
    }
    self.ClickChoseLot_DoiTra = function (item) {
        var $this = $(event.currentTarget);
        var ngaysx = moment(item.NgaySanXuat).format('DD/MM/YYYY');
        var hethan = moment(item.NgayHetHan).format('DD/MM/YYYY');
        var idRandom = $this.closest('.ctLo').attr('id');
        if (ngaysx === 'Invalid date') {
            ngaysx = '';
        }
        if (hethan === 'Invalid date') {
            hethan = '';
        }
        var idLoHang = item.ID_LoHang;
        var maLoHang = item.MaLoHang;
        var idRandomHD = self.HoaDons().IDRandom();

        // add cache CTHD
        var cthd = localStorage.getItem(lcListCTHD_DoiTra);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            for (let i = 0; i < cthd.length; i++) {
                let itFor = cthd[i];
                if (itFor.IDRandomHD === idRandomHD && itFor.ID_DonViQuiDoi === item.ID_DonViQuiDoi) {
                    // if change ID_LoHang --> update, not push
                    for (let j = 0; j < itFor.DM_LoHang.length; j++) {
                        if (itFor.DM_LoHang[j].IDRandom === idRandom) {
                            // if first DM_LoHang--> update ID_LoHang for CTHD if LotParent
                            if (j === 0) {
                                cthd[i].ID_LoHang = idLoHang;
                                cthd[i].MaLoHang = maLoHang; // add properties MaLoHang --> used to save LichSuThaoTac
                                cthd[i].TonKho = item.TonKho;
                                cthd[i].NgaySanXuat = item.NgaySanXuat;// --> used to InHoaDon
                                cthd[i].NgayHetHan = item.NgayHetHan;
                                cthd[i].CssWarning = (self.ThietLap().XuatAm && cthd[i].TonKho < cthd[i].SoLuong);
                            }
                            cthd[i].DM_LoHang[j].ID_LoHang = idLoHang;
                            cthd[i].DM_LoHang[j].MaLoHang = maLoHang;
                            cthd[i].DM_LoHang[j].NgaySanXuat = ngaysx;
                            cthd[i].DM_LoHang[j].NgayHetHan = hethan;
                            cthd[i].DM_LoHang[j].TonKho = item.TonKho;
                            cthd[i].DM_LoHang[j].CssWarning = (self.ThietLap().XuatAm && cthd[i].DM_LoHang[j].TonKho < cthd[i].DM_LoHang[j].SoLuong);
                            break;
                        }
                    }
                    break;
                }
            }
            localStorage.setItem(lcListCTHD_DoiTra, JSON.stringify(cthd));
            // bind again to do bind ID_LoHang
            var arrCTHD = $.grep(cthd, function (x) {
                return x.IDRandomHD === idRandomHD;
            });
            self.NewProducts(arrCTHD);
        }
        HideShow_Icon_ChietKhauNV();
    }
    function XoaHangHoa_CheckCungLoai(cthd, lotParent, quanlytheolo, concungloai, idRandom) {
        if (lotParent || (concungloai === false && quanlytheolo === false)) {
            for (let i = 0; i < cthd.length; i++) {
                if (cthd[i].IDRandom === idRandom) {
                    cthd.splice(i, 1);
                    break;
                }
            }
        }
        else {
            if (quanlytheolo) {
                for (let i = 0; i < cthd.length; i++) {
                    for (let j = 0; j < cthd[i].DM_LoHang.length; j++) {
                        if (cthd[i].DM_LoHang[j].IDRandom === idRandom) {
                            cthd[i].DM_LoHang.splice(j, 1);
                            i = cthd.length;  // esc for loop
                            break;
                        }
                    }
                }
            }
            else {
                for (let i = 0; i < cthd.length; i++) {
                    for (let j = 0; j < cthd[i].HangCungLoais.length; j++) {
                        if (cthd[i].HangCungLoais[j].IDRandom === idRandom) {
                            cthd[i].HangCungLoais.splice(j, 1);
                            i = cthd.length;
                            break;
                        }
                    }
                }
            }
        }
        return cthd;
    }
    self.xoaHangHoa_DoiTra = function (item) {
        _maHoaDon = item.MaHoaDon;
        var isOffline = CheckHoaDonOffline_byMaHoaDon(_maHoaDon);
        if (isOffline === false) {
            return false;
        }
        var dvtDeleted = { ID_DonViQuiDoi: item.ID_DonViQuiDoi, TenDonViTinh: item.TenDonViTinh, Xoa: false };
        var idRandomHD = item.IDRandomHD;
        // xoa in CTHD_TraHang
        var cthd_TH = localStorage.getItem(lcListCTHD_DoiTra);
        cthd_TH = JSON.parse(cthd_TH);
        cthd_TH = XoaHangHoa_CheckCungLoai(cthd_TH, item.LotParent, item.QuanLyTheoLoHang, item.LaConCungLoai, item.IDRandom);
        // push dvt was delete into cthd (if same ID_HangHoa)
        for (let i = 0; i < cthd_TH.length; i++) {
            if (cthd_TH[i].ID_HangHoa === item.ID_HangHoa) {
                cthd_TH[i].ListDonViTinh.push(dvtDeleted);
            }
        }
        localStorage.setItem(lcListCTHD_DoiTra, JSON.stringify(cthd_TH));
        UpdateCacheHDLe(idRandomHD, true);
        UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();
        UpdateSoThuTu_CTHD(true, idRandomHD);
        // reset GiamGia, Thue if delete all HangHoa of HoaDon
        var cthd_ofThisHD = $.grep(cthd_TH, function (x) {
            return x.IDRandomHD === idRandomHD;
        });
        if (cthd_ofThisHD.length === 0) {
            var lstHD = localStorage.getItem(lcListHD);
            if (lstHD !== null) {
                lstHD = JSON.parse(lstHD);
                for (let i = 0; i < lstHD.length; i++) {
                    if (lstHD[i].IDRandom === idRandomHD) {
                        lstHD[i].TongChietKhau = 0
                        lstHD[i].TongGiamGia = 0;
                        lstHD[i].PTThueHoaDon = 0;
                        lstHD[i].PTThueBaoHiem = 0;
                        lstHD[i].TongTienThue = 0;
                        lstHD[i].TongTienThueBaoHiem = 0;
                        lstHD[i].PTChietKhauHH = 0;
                        lstHD[i].TongGiamGiaHang = 0;
                    }
                }
                localStorage.setItem(lcListHD, JSON.stringify(lstHD));
            }
        }
        self.NewProducts(cthd_ofThisHD);
        BindHD_byIDRandom(idRandomHD);
        Focus_InputPhaiThanhToan();
        HideShow_Icon_ChietKhauNV();
    }
    self.tangSolLuong_DoiTra = function (item) {
        var idRandom = item.IDRandom;
        var idRandomHD = item.IDRandomHD;
        var idQuiDoi = item.ID_DonViQuiDoi;
        var idCT_goiDV = item.ID_ChiTietGoiDV;
        idCT_goiDV = (idCT_goiDV === undefined ? null : idCT_goiDV);
        var objNumberTH = $('#numberTH_' + idRandom);
        var newSoLuong = parseFloat(objNumberTH.val()) + 1;
        _maHoaDon = item.MaHoaDon;

        // find & update ctdoitra
        var cthdDoing = FindCTHD_isDoing(item, true);
        if (cthdDoing !== null) {
            cthdDoing.SoLuong = newSoLuong;
            cthdDoing.ThanhToan = newSoLuong * (cthdDoing.GiaBan - cthdDoing.TienChietKhau + cthdDoing.TienThue);
            cthdDoing.ThanhTien = newSoLuong * (cthdDoing.DonGia - cthdDoing.TienChietKhau);

            var cthd_TH = localStorage.getItem(lcListCTHD_DoiTra);
            cthd_TH = JSON.parse(cthd_TH);
            cthd_TH = updateCTHDLe(cthd_TH, cthdDoing);
            localStorage.setItem(lcListCTHD_DoiTra, JSON.stringify(cthd_TH));

            UpdateWarning_forCTHD_byIDQuiDoi(idQuiDoi, idRandomHD);
            ChangeSoLuong_UpdateSLQuyCach(item, true, item.QuyCach, newSoLuong);
            UpdateSoLuong_TPDinhLuong_ofCTHD(idRandomHD, idRandom, newSoLuong, true);
            UpdateChietKhauNV_inCTHD(idRandom, true, cthdDoing);
            if (item.ThanhPhanComBo.length > 0) {
                ChangeSoLuongParent_UpdateCombo(idRandom, cthdDoing.SoLuong, true);
            }
            UpdateCacheHDLe(idRandomHD, true);
            UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();
            BindHD_byIDRandom(idRandomHD);
            Focus_InputPhaiThanhToan();
            Bind_CTHĐoiTra_afterHideColumn();
            HideShow_Icon_ChietKhauNV();
        }
    }
    self.giamSolLuong_DoiTra = function (item) {
        var idRandom = item.IDRandom;
        var idRandomHD = item.IDRandomHD;
        var idCT_goiDV = item.ID_ChiTietGoiDV;
        var idQuiDoi = item.ID_DonViQuiDoi;
        idCT_goiDV = (idCT_goiDV === undefined ? null : idCT_goiDV);

        var objNumberTH = $('#numberTH_' + idRandom);
        var numberTH = parseFloat(objNumberTH.val());
        if (numberTH >= 1) {
            numberTH = numberTH - 1;
            objNumberTH.val(numberTH);
        }
        _maHoaDon = item.MaHoaDon;

        var cthdDoing = FindCTHD_isDoing(item, true);
        cthdDoing.SoLuong = numberTH;
        cthdDoing.ThanhTien = numberTH * (cthdDoing.GiaBan - cthdDoing.TienChietKhau);
        cthdDoing.ThanhToan = numberTH * (cthdDoing.GiaBan - cthdDoing.TienChietKhau + cthdDoing.TienThue);

        var cthd_TH = localStorage.getItem(lcListCTHD_DoiTra);
        cthd_TH = JSON.parse(cthd_TH);
        cthd_TH = updateCTHDLe(cthd_TH, cthdDoing);
        localStorage.setItem(lcListCTHD_DoiTra, JSON.stringify(cthd_TH));

        UpdateWarning_forCTHD_byIDQuiDoi(idQuiDoi, idRandomHD);
        ChangeSoLuong_UpdateSLQuyCach(item, true, item.QuyCach, numberTH);
        UpdateSoLuong_TPDinhLuong_ofCTHD(idRandomHD, idRandom, numberTH, true);
        UpdateChietKhauNV_inCTHD(idRandom, true, cthdDoing);
        if (item.ThanhPhanComBo.length > 0) {
            ChangeSoLuongParent_UpdateCombo(idRandom, cthdDoing.SoLuong, true);
        }
        UpdateCacheHDLe(idRandomHD, true);
        UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();
        BindHD_byIDRandom(idRandomHD);
        Focus_InputPhaiThanhToan();
        Bind_CTHĐoiTra_afterHideColumn();
        HideShow_Icon_ChietKhauNV();
    }
    self.editPhiTraHang = function () {
        var $this = $(event.currentTarget);
        formatNumberObj($this);
        var valThis = formatNumberToInt($this.val());
        var idRandomHD = self.HoaDons().IDRandom();
        // update TongTienTra
        var lstHDLe = localStorage.getItem(lcListHD);
        if (lstHDLe !== null) {
            lstHDLe = JSON.parse(lstHDLe);
            for (let i = 0; i < lstHDLe.length; i++) {
                if (lstHDLe[i].IDRandom === idRandomHD) {
                    lstHDLe[i].TongChiPhiHangTra = valThis;
                    break;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(lstHDLe));
            UpdateCacheHDLe(idRandomHD, true);
            BindHD_byIDRandom(idRandomHD);
        }
    }
    self.editSoLuong_DoiTra = function (item) {
        var rowID = this.ID_DonViQuiDoi;
        var idRandom = item.IDRandom;
        var idRandomHD = item.IDRandomHD;
        var idCT_goiDV = item.ID_ChiTietGoiDV;
        idCT_goiDV = (idCT_goiDV === undefined ? null : idCT_goiDV);
        var thisObj = $(event.currentTarget);
        formatNumberObj(thisObj); // 000,000

        var objThanhTien = $('#sumTH_' + idRandom);
        var newNumber = parseFloat(thisObj.val());

        var ctDoing = FindCTHD_isDoing(item, true);
        if (ctDoing !== null) {
            if (isNaN(newNumber)) {
                newNumber = 0;
            }
            var sluongOld = newNumber;
            var keyCode = event.keyCode || event.which;
            // press up
            if (keyCode === 38) {
                newNumber = sluongOld + 1;
                thisObj.val(formatNumber3Digit(newNumber));
            }
            // press down
            if (keyCode === 40) {
                if (sluongOld > 1) {
                    newNumber = sluongOld - 1;
                    thisObj.val(formatNumber3Digit(newNumber));
                }
            }
            thanhtien = (ctDoing.DonGia - ctDoing.TienChietKhau + ctDoing.TienThue) * newNumber;
            ctDoing.SoLuong = newNumber;
            ctDoing.ThanhToan = thanhtien;
            ctDoing.ThanhTien = (ctDoing.DonGia - ctDoing.TienChietKhau) * newNumber;

            objThanhTien.val(formatNumber3Digit(thanhtien));
            objThanhTien.text(formatNumber3Digit(thanhtien)); // use for lable

            // update ds cache cthoadon
            var cthd = localStorage.getItem(lcListCTHD_DoiTra);
            if (cthd !== null) {
                cthd = JSON.parse(cthd);
                cthd = updateCTHDLe(cthd, ctDoing);
                localStorage.setItem(lcListCTHD_DoiTra, JSON.stringify(cthd));
            }
            UpdateWarning_forCTHD_byIDQuiDoi(rowID, idRandomHD);
            ChangeSoLuong_UpdateSLQuyCach(item, true, item.QuyCach, newNumber);
            UpdateSoLuong_TPDinhLuong_ofCTHD(idRandomHD, idRandom, newNumber, true);
            UpdateChietKhauNV_inCTHD(idRandom, true, ctDoing);
            ShowHideWarning_forCTHD_byIDQuiDoi(idRandomHD, rowID, idRandom);
            if (item.ThanhPhanComBo.length > 0) {
                ChangeSoLuongParent_UpdateCombo(idRandom, ctDoing.SoLuong, true, 1);
            }
            UpdateCacheHDLe(idRandomHD, true);
            UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();
            HideShow_Icon_ChietKhauNV();
            BindHD_byIDRandom(idRandomHD);
            Enter_DoiTra(item, event, 'numberTH_', 1);
            Shift_DoiTra(item, event, 'numberTH_', 1, 16);
            ArrowRight_CTHD(item, event);
            ArrowLeft_CTHD(item, event);
        }
    }

    self.cthd_clickThueDoiTra = function (item) {
        var idRandom = item.IDRandom;
        var $this = $('#taxCT_' + idRandom);
        if ($this.hasClass('active-re')) {
            $this.removeClass('active-re');
        }
        else {
            $this.addClass('active-re');
        }
        var objSale = $('#ipTaxCT_' + idRandom); // input giam gia
        var tienThue = 0;
        var ptThue = 0;
        var priceOld = 0;
        var giaSauCK = 0;
        var ctDoing = FindCTHD_isDoing(item, true);
        if (ctDoing !== null) {
            priceOld = ctDoing.GiaBan;
            ptThue = ctDoing.PTThue;
            tienThue = ctDoing.TienThue;
            giaSauCK = ctDoing.GiaBan - ctDoing.TienChietKhau;

            if (priceOld !== 0) {
                if ($this.hasClass('active-re')) {
                    ptThue = tienThue / giaSauCK * 100;
                    objSale.val(ptThue);
                }
                else {
                    objSale.val(formatNumber3Digit(tienThue));
                    ptThue = 0;
                }

                var cthd = localStorage.getItem(lcListCTHD_DoiTra);
                if (cthd !== null) {
                    cthd = JSON.parse(cthd);
                    cthd = updatePTVND(cthd, ctDoing, 2, ptThue, ctDoing.DVTingGiam);
                    localStorage.setItem(lcListCTHD_DoiTra, JSON.stringify(cthd));
                }
            }
        }
    }

    self.cthd_editThueDoiTra = function (item, e) {
        var sumTemp = 0;
        var idRandom = item.IDRandom;
        var idRandomHD = item.IDRandomHD;

        var rowID = item.ID_DonViQuiDoi;
        var thisObj = $(event.currentTarget); // input nhap giam gia
        var priceOld = 0;
        var tienThue = 0;
        var ptThue = 0;
        var giaSauCK = 0;

        var ctDoing = FindCTHD_isDoing(item, true);
        if (ctDoing !== null) {
            priceOld = ctDoing.GiaBan;
            ptThue = ctDoing.PTThue;
            giaSauCK = priceOld - ctDoing.TienChietKhau;

            if (priceOld === 0) {
                thisObj.val(0);
            }
            else {
                // format 000,000,000
                formatNumberObj(thisObj);
                var valThis = thisObj.val();
                if (valThis === '') {
                    valThis = 0;
                }
                if ($('#taxCT_' + idRandom).hasClass('active-re')) {
                    ptThue = formatNumberToFloat(valThis);
                    if (ptThue > 100) {
                        ptThue = 100;
                        thisObj.val(100);
                    }
                    tienThue = giaSauCK * ptThue / 100;
                }
                else {
                    tienThue =formatNumberToFloat(valThis);
                }
                sumTemp = (giaSauCK + tienThue) * ctDoing.SoLuong;

                ctDoing.PTThue = ptThue;
                ctDoing.TienThue = tienThue;
                ctDoing.ThanhToan = sumTemp;
                ctDoing.ThanhTien = giaSauCK * ctDoing.SoLuong;
            }
            $('#sumTH_' + idRandom).val(formatNumber3Digit(sumTemp));
            $('#ck_' + idRandom).text(formatNumber3Digit(ctDoing.TienChietKhau));
            $('#tax_' + idRandom).text(formatNumber3Digit(ctDoing.TienThue));
            $('#tax_' + idRandom).parent().css('display', ctDoing.TienThue > 0 ? '' : 'none');

            var cthd = localStorage.getItem(lcListCTHD_DoiTra);
            if (cthd !== null) {
                cthd = JSON.parse(cthd);
                cthd = updateCTHDLe(cthd, ctDoing);
                localStorage.setItem(lcListCTHD_DoiTra, JSON.stringify(cthd));
            }

            UpdateCacheHDLe(idRandomHD, true, 4);
            UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();
            BindHD_byIDRandom(idRandomHD);
            UpdateChietKhauNV_inCTHD(idRandom, true, ctDoing);
        }
    }
    self.clickVND_DoiTra = function (item) {
        _maHoaDon = item.MaHoaDon;
        var idRandom = item.IDRandom;
        var idRandomHD = item.IDRandomHD;
        var $this = $('#vndTH_' + idRandom);
        if ($this.hasClass('active-re')) {
            $this.removeClass('active-re');
        }
        else {
            $this.addClass('active-re');
        }
        var objSale = $('#pri-gTH_' + idRandom); // input giam gia
        var tienGiam = 0;
        var ptGiam = 0;
        var priceOld = 0;
        var dvtGiam = '%';

        // get infor from CTHD old
        var ctDoing = FindCTHD_isDoing(item, true);
        if (ctDoing !== null) {
            priceOld = ctDoing.GiaBan;
            ptGiam = ctDoing.PTChietKhau;
            tienGiam = ctDoing.TienChietKhau;

            // if priceOld =0 (chua nhap gia von ban dau o hang hoa)
            if (priceOld !== 0) {
                if ($this.hasClass('active-re')) {
                    // caculator again %
                    ptGiam = tienGiam / priceOld * 100;
                    objSale.val(ptGiam);
                    dvtGiam = '%';
                }
                else {
                    objSale.val(formatNumber3Digit(tienGiam));
                    dvtGiam = 'VND';
                    ptGiam = 0;
                }
            }

            var cthd = localStorage.getItem(lcListCTHD_DoiTra);
            if (cthd !== null) {
                cthd = JSON.parse(cthd);
                cthd = updatePTVND(cthd, ctDoing, 1, ptGiam, dvtGiam);
                localStorage.setItem(lcListCTHD_DoiTra, JSON.stringify(cthd));
            }
            UpdateCacheHDLe(idRandomHD, true);
            BindHD_byIDRandom(idRandomHD);
            Focus_InputPhaiThanhToan();
        }
    }
    self.editPrice_DoiTra = function (item, e) {
        var objID = item.ID_DonViQuiDoi;
        var idRandom = item.IDRandom;
        var idRandomHD = item.IDRandomHD;
        var thisObj = $('#priceTH_' + idRandom);
        var objVal = formatNumberObj(thisObj);
        var price = formatNumberToInt(objVal);
        var sumTemp = 0;
        var sum_f = $('#sumTH_' + idRandom);

        var priceNew = price;
        var tienGiam = 0;
        var tienThue = 0;

        var ctDoing = FindCTHD_isDoing(item, true);
        if (ctDoing !== null) {
            tienGiam = ctDoing.TienChietKhau;
            tienThue = ctDoing.TienThue;

            // if clear price
            if (thisObj.val() === '') {
                priceNew = 0;
                tienGiam = 0;
                tienThue = 0;
                ctDoing.PTChietKhau = self.HoaDons().PTChietKhauHH();
                ctDoing.PTThue = self.HoaDons().PTThueHoaDon();
            }
            // assign again sale
            if (ctDoing.PTChietKhau > 0) {
                tienGiam = ctDoing.PTChietKhau * priceNew / 100;
            }
            if (ctDoing.PTThue > 0) {
                tienThue =ctDoing.PTThue * (priceNew - tienGiam) / 100;
            }
            sumTemp = parseFloat(ctDoing.SoLuong) * (priceNew - tienGiam + tienThue);
            ctDoing.TienChietKhau = tienGiam;
            ctDoing.TienThue = tienThue;
            ctDoing.ThanhTien = (priceNew - tienGiam) * ctDoing.SoLuong;
            ctDoing.ThanhToan = sumTemp;
            ctDoing.DonGia = priceNew;
            ctDoing.GiaBan = priceNew;

            sum_f.val(formatNumber3Digit(sumTemp));
            $('#ck_' + idRandom).text(formatNumber3Digit(ctDoing.TienChietKhau));
            $('#tax_' + idRandom).text(formatNumber3Digit(ctDoing.TienThue));

            // update ds cache cthoadon
            var cthd_TH = localStorage.getItem(lcListCTHD_DoiTra);
            if (cthd_TH !== null) {
                cthd_TH = JSON.parse(cthd_TH);
                cthd_TH = updateCTHDLe(cthd_TH, ctDoing);
                localStorage.setItem(lcListCTHD_DoiTra, JSON.stringify(cthd_TH));
            }
            UpdateCacheHDLe(idRandomHD, true);
            UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();
            BindHD_byIDRandom(idRandomHD);
            UpdateChietKhauNV_inCTHD(idRandom, true, ctDoing);
            Enter_DoiTra(item, event, 'priceTH_', 2);
            Shift_DoiTra(item, event, 'priceTH_', 2, 16);
            ArrowRight_CTHD(item, event);
            ArrowLeft_CTHD(item, event);
        }
    }
    self.editSale_DoiTra = function (item, e) {
        var sumTemp = 0;
        var idRandom = item.IDRandom;
        var idRandomHD = item.IDRandomHD;
        var thisObj = $(event.currentTarget);

        var priceOld = 0;
        var priceNew = 0;
        var tienGiam = 0;
        var tienThue = 0;

        var ctDoing = FindCTHD_isDoing(item, true);
        if (ctDoing !== null) {
            priceOld = ctDoing.GiaBan;
            tienGiam = ctDoing.TienChietKhau;
            tienThue = ctDoing.TienThue;

            // neu gia cu = 0 => khong cho phep nhap giam gia
            if (priceOld === 0) {
                thisObj.val(0);
            }
            else {
                // format 000,000,000
                formatNumberObj(thisObj);

                var valThis = thisObj.val();
                if (valThis === '') {
                    valThis = 0;
                    tienGiam = 0;
                }
                if ($('#vndTH_' + idRandom).hasClass('active-re')) {
                    // neu giam gia > 100 %
                    if (formatNumberToFloat(valThis) > 100) {
                        thisObj.val(100);
                        valThis = 100;
                    }
                    tienGiam = priceOld * parseFloat(valThis) / 100;
                    ctDoing.PTChietKhau = formatNumberToFloat(valThis);
                }
                else {
                    tienGiam = formatNumberToFloat(valThis);
                }
                priceNew = priceOld - tienGiam; // use to caculator ThanhTien
                if (ctDoing.PTThue > 0) {
                    tienThue = ctDoing.PTThue * priceNew / 100;
                }
                sumTemp = (priceNew - tienThue) * ctDoing.SoLuong;
                ctDoing.TienChietKhau = tienGiam;
                ctDoing.TienThue = tienThue;
                ctDoing.ThanhTien = priceNew * ctDoing.SoLuong;
                ctDoing.ThanhToan = sumTemp;
            }
            // set value new GiamGia, ThanhTien
            $('#sumTH_' + idRandom).val(formatNumber3Digit(sumTemp));
            $('#ck_' + idRandom).text(formatNumber3Digit(ctDoing.TienChietKhau));
            $('#tax_' + idRandom).text(formatNumber3Digit(ctDoing.TienThue));
            $('#ck_' + idRandom).parent().css('display', tienGiam > 0 ? '' : 'none');
            $('#tax_' + idRandom).parent().css('display', ctDoing.TienThue > 0 ? '' : 'none');

            var cthd = localStorage.getItem(lcListCTHD_DoiTra);
            if (cthd !== null) {
                cthd = JSON.parse(cthd);
                cthd = updateCTHDLe(cthd, ctDoing);
                localStorage.setItem(lcListCTHD_DoiTra, JSON.stringify(cthd));
            }
            UpdateCacheHDLe(idRandomHD, true);
            UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();
            BindHD_byIDRandom(idRandomHD);
            UpdateChietKhauNV_inCTHD(idRandom, true, ctDoing);
            ArrowRight_CTHD(item, event);
            ArrowLeft_CTHD(item, event);
        }
    }
    self.editSumPrice_DoiTra = function (item) {
        var idRandom = item.IDRandom;
        var idRandomHD = item.IDRandomHD;
        var quanLiTheoLo = item.QuanLyTheoLoHang;
        quanLiTheoLo = (quanLiTheoLo === null ? false : quanLiTheoLo);
        var thisObj = $(event.currentTarget);
        var objVal = formatNumberObj(thisObj);
        var objPrice = $('#priceTH_' + idRandom);
        var sumPrice = formatNumberToInt(objVal);

        var priceNew = 0;
        var soluong = 1;
        var tienGiam = 0;
        var ptGiam = 0;

        // use when SoLuong = 0 (caculator again SoLuong)
        var priceOld = 0;
        var ctDoing = FindCTHD_isDoing(item, true);
        if (ctDoing !== null) {
            priceOld = ctDoing.priceOld;
            ptGiam = ctDoing.PTChietKhau;
            tienGiam = ctDoing.TienChietKhau;
            soluong = ctDoing.SoLuong;

            // is clear price
            if (thisObj.val() === '') {
                sumPrice = 0;
            }
            if (soluong === 0) {
                // keep GiaBan, caculator again SoLuong
                soluong = sumPrice / (priceOld - tienGiam);
                priceNew = priceOld;
                // assign SoLuong for input
                $('#numberTH_' + idRandom).val(formatNumber3Digit(soluong));
            }
            else {
                // caculator again tienGiam
                if (ptGiam > 0) {
                    if (ptGiam === 100) {
                        ptGiam = 0;
                    }
                    priceNew = Caculator_Price(ptGiam, soluong, sumPrice);
                    tienGiam = ptGiam * priceNew / 100;
                }
                else {
                    priceNew = Caculator_Price_byTienGiam(tienGiam, soluong, sumPrice);
                }
                // assign DonGia,TienGiam for input
                objPrice.val(formatNumber3Digit(priceNew));
                $('#btn_saleDT_' + idRandom).text(formatNumber3Digit(tienGiam));
            }

            ctDoing.PTChietKhau = ptGiam;
            ctDoing.TienThue = 0;
            ctDoing.PTThue = 0;
            ctDoing.DonGia = priceNew;
            ctDoing.GiaBan = priceNew;
            ctDoing.SoLuong = soluong;
            ctDoing.TienChietKhau = tienGiam;
            ctDoing.ThanhTien = sumPrice;
            ctDoing.ThanhToan = sumPrice;

            // update ds cache cthoadon
            var cthd = localStorage.getItem(lcListCTHD_DoiTra);
            if (cthd !== null) {
                cthd = JSON.parse(cthd);
                cthd = updateCTHDLe(cthd, ctDoing);
                localStorage.setItem(lcListCTHD_DoiTra, JSON.stringify(cthd));
            }
            UpdateCacheHDLe(idRandomHD, true);
            UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();
            UpdateChietKhauNV_inCTHD(idRandom, true, ctDoing);
            BindHD_byIDRandom(idRandomHD);
            ArrowRight_CTHD(item, event);
            ArrowLeft_CTHD(item, event);
        }
    }
    self.showDivSale_CTHD_DoiTra = function (item) {
        var role = GetRoleChangePrice(item.LoaiHoaDon);
        if (role === false) {
            return false;
        }
        var idRandom = item.IDRandom;
        var quanLiTheoLo = item.QuanLyTheoLoHang;
        quanLiTheoLo = (quanLiTheoLo === null ? false : quanLiTheoLo);
        var $this = $(event.currentTarget);
        var ipGiam = $('#pri-gTH_' + idRandom);
        var iconGiam = $('#vndTH_' + idRandom); // vnd or %
        var ptGiam = 0;
        var tienGiam = 0;
        var ctDoing = FindCTHD_isDoing(item, true);
        if (ctDoing !== null) {
            ptGiam = ctDoing.PTChietKhau;
            tienGiam = ctDoing.TienChietKhau;

            if (ptGiam > 0 || tienGiam === 0) {
                ipGiam.val(formatNumber3Digit(ptGiam));
                iconGiam.addClass('active-re');
            }
            else {
                ipGiam.val(formatNumber3Digit(tienGiam));
                iconGiam.removeClass('active-re');
            }

            if (ctDoing.PTThue > 0 || (ctDoing.TienThue === 0 && ctDoing.PTThue === 0)) {
                $('#ipTaxCT_' + idRandom).val(formatNumber3Digit(ctDoing.PTThue));
                $('#taxCT_' + idRandom).addClass('active-re');
            }
            else {
                $('#ipTaxCT_' + idRandom).val(formatNumber3Digit(ctDoing.TienThue));
                $('#taxCT_' + idRandom).removeClass('active-re');
            }
        }
        $($this).siblings(".gara-popup-chietkhau").toggle();
        ipGiam.focus().select().focus();
    }
    self.editDaTraKhach = function () {
        var $this = $(event.currentTarget);
        formatNumberObj($this);
        var datra = formatNumberToFloat($this.val());
        var idRandomHD = '';
        // update DaThanhToan, TienMat 
        if (_maHoaDon === '') {
            _maHoaDon = $('.gara-bill-label li.active font').text();
        }
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            for (let i = 0; i < lstHD.length; i++) {
                if (lstHD[i].MaHoaDon === _maHoaDon && (lstHD[i].NguoiTao === userLogin || lstHD[i].TrangThaiHD === 3)) {
                    lstHD[i].DaTraKhach = datra;
                    lstHD[i].TienMat = datra;
                    idRandomHD = lstHD[i].IDRandom;
                    break;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(lstHD));
        }
        BindHD_byIDRandom(idRandomHD);
    }
    // not use
    self.editDaTraKhach_DoiTra = function () {
        var datraObj = formatNumberObj($('#txtDaTraKhach'));
        var datra = formatNumberToInt(datraObj);
        var idRandomHD = '';
        $('#txtDaTraKhach').val(formatNumber3Digit(datra));
        // update DaThanhToan, TienMat 
        if (_maHoaDon === '') {
            _maHoaDon = $('.gara-bill-label li.active font').text();
        }
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            for (let i = 0; i < lstHD.length; i++) {
                if (lstHD[i].MaHoaDon === _maHoaDon && (lstHD[i].NguoiTao === userLogin || lstHD[i].TrangThaiHD === 3)) {
                    lstHD[i].DaTraKhach = datra;
                    lstHD[i].TienMat = datra;
                    idRandomHD = lstHD[i].IDRandom;
                    break;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(lstHD));
        }
        BindHD_byIDRandom(idRandomHD);
    }

    self.TraNhanh = function () {
        ShowDivDefault();
        $('#txtSearchHH').focus();
        $('.hasGiamGia').css('display', 'none');
        $('#btnSave').css('display', '');
        $('#btnTaoHD, #btnSaveDatHang').css('display', 'none');
        self.DateHDDefault(moment(serverTime).format('DD/MM/YYYY'));
        self.TimeHDDefault(moment(serverTime).format('HH:mm'));
        var lstHDLe = localStorage.getItem(lcListHD);
        if (lstHDLe !== null && lstHDLe.indexOf('[]' > -1)) {
            lstHDLe = JSON.parse(lstHDLe);
            // get all HoaDon with MaHoaDon !='HDO' and !='Hóa'
            var arrHD = $.grep(lstHDLe, function (item) {
                //return item.MaHoaDon.indexOf('O') === -1 && item.MaHoaDon.indexOf('Hóa') === -1;
                return item.StatusOffline === false && item.LoaiHoaDon !== 1 && item.LoaiHoaDon !== 3;
            });
            if (arrHD.length === 0) {
                max = 0;
            }
            else {
                max = Math.max.apply(Math, arrHD.map(function (item) {
                    return item.MaHoaDon.match(/\d+/);
                }));
            }
        }
        else {
            lstHDLe = [];
            var newObjFirst = newHoaDon(1, '1');
            lstHDLe.push(newObjFirst);
            max = 0;
        }
        _maHoaDon = 'Trả hàng ' + (max + 1);
        localStorage.setItem(lcMaHD, _maHoaDon);
        var objNew = newHoaDonTraHang(null, 'Trả hàng ' + (max + 1));
        lstHDLe.push(objNew);
        localStorage.setItem(lcListHD, JSON.stringify(lstHDLe));
        self.PhongBanSelected.push(objNew);
        GetCurrentPage_byMaHoaDon(_maHoaDon);
        self.HoaDons().SetData(objNew);// hide/show div trahang
        self.HangHoaAfterAdds([]);
        self.NewProducts([]);
        Caculator_AmountProduct();
        NhapThuong_HideShow_txtDonGia();
        Enable_DisableNgayLapHD();
        SetPageSize_FullProduct(false);
    }
    self.selectLoaiChungTu.subscribe(function (newVal) {
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            var lstHDoffline = [];
            if (newVal === 0) {
                lstHDoffline = $.grep(lstHD, function (item) {
                    return item.StatusOffline === true && item.NguoiTao === userLogin && item.ID_DonVi === id_DonVi;
                });
            }
            else {
                lstHDoffline = $.grep(lstHD, function (item) {
                    return item.StatusOffline === true && item.LoaiHoaDon === newVal && item.NguoiTao === userLogin
                        && item.ID_DonVi === id_DonVi;
                });
            }
            self.HoaDonOffline(lstHDoffline);
        }
    })
    // Phan trang DS HoaDon
    function GetCurrentPage_byMaHoaDon(maHoaDon) {
        var beforeIndex = self.indexOfMaHD();
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            var lstHDisOpening = $.grep(lstHD, function (item) {
                return item.Status === 1 && (item.NguoiTao === userLogin || item.TrangThaiHD === 3);
            });
            for (let i = 0; i < lstHDisOpening.length; i++) {
                if (lstHDisOpening[i].MaHoaDon === maHoaDon) {
                    self.indexOfMaHD(i);
                    break;
                }
            }
        }
        // change indexOfMaHD when indexOfMaHD not change ==> change result_HoaDon (!important)
        if (beforeIndex === self.indexOfMaHD()) {
            self.indexOfMaHD(beforeIndex - 1);
            self.indexOfMaHD(beforeIndex);
        }
    }
    self.result_HoaDon = ko.computed(function () {
        var arrPage = [];
        var currentIndex = self.indexOfMaHD();
        var lstHDisOpening = GetListHD_Opening();
        var lenArr = lstHDisOpening.length;
        // currentIndex = undefined when close HDOffline, and refresh
        if (currentIndex === undefined || isNaN(currentIndex) || currentIndex < self.pageSizeHD()) {
            if (lenArr > 0) {
                for (let i = 0; i < lenArr; i++) {
                    if (arrPage.length < self.pageSizeHD()) {
                        arrPage.push(lstHDisOpening[i]);
                    }
                }
            }
            else {
                var maHDNew = '';
                if (_maHoaDon !== '') {
                    maHDNew = _maHoaDon;
                }
                var objEmpty = newHoaDon(1, 1);
                arrPage.push(objEmpty);
                _maHoaDon = maHDNew;
            }
        }
        else {
            // currentIndex > pageSizeHD 
            if (self.pageSizeHD() === 1 && currentIndex === lenArr) {
                arrPage.push(lstHDisOpening[lenArr - 1]);
            }
            else {
                for (let i = currentIndex - (self.pageSizeHD() - 1); i < lenArr; i++) {
                    if (arrPage.length < self.pageSizeHD()) {
                        arrPage.push(lstHDisOpening[i]);
                    }
                }
            }
        }
        self.PhongBanSelected(arrPage);
        for (let i = 0; i < arrPage.length; i++) {
            arrPage[i].IsActive = '';
            if (arrPage[i].MaHoaDon === self.HoaDons().MaHoaDon() && (arrPage[i].NguoiTao === userLogin || arrPage[i].TrangThaiHD === 3)) {
                arrPage[i].IsActive = 'active';
                break;
            }
        }
        return arrPage;
    });
    self.hasPrevHD = ko.computed(function () {
        if (self.PhongBanSelected().length > 0) {
            var maHDFirst = self.PhongBanSelected()[0].MaHoaDon;
            var lstHD = localStorage.getItem(lcListHD);
            if (lstHD !== null) {
                lstHD = JSON.parse(lstHD);
                var lstHDisOpening = GetListHD_Opening();
                if (lstHDisOpening.length > 0) {
                    if (maHDFirst === lstHDisOpening[0].MaHoaDon) {
                        return false;
                    }
                    else {
                        return true;
                    }
                }
                else {
                    return false;
                }
            }
            else {
                return false;
            }
        }
        else {
            return false;
        }
    });
    self.hasNextHD = ko.computed(function () {
        // if load first: self.PhongBanSelected().length === 0
        if (self.PhongBanSelected().length > 0) {
            var maHDLast = self.PhongBanSelected()[self.PhongBanSelected().length - 1].MaHoaDon;
            var lstHD = localStorage.getItem(lcListHD);
            if (lstHD !== null) {
                lstHD = JSON.parse(lstHD);
                var lstHDisOpening = GetListHD_Opening();
                if (lstHDisOpening.length > 0) {
                    if (maHDLast === lstHDisOpening[lstHDisOpening.length - 1].MaHoaDon) {
                        return false;
                    }
                    else {
                        return true;
                    }
                }
                else {
                    return false;
                }
            }
            else {
                return false;
            }
        }
    });
    self.nextHoaDon = function () {
        var indexCurrent = self.indexOfMaHD();
        var maHDLast = self.PhongBanSelected()[self.PhongBanSelected().length - 1].MaHoaDon;
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            // only get hdopening
            let hdOpening = $.grep(lstHD, function (x) {
                return x.Status === 1;
            });
            // find index MaHDLast
            for (let i = 0; i < hdOpening.length; i++) {
                if (hdOpening[i].MaHoaDon === maHDLast) {
                    indexCurrent = i;
                    break;
                }
            }
        }
        _maHoaDon = localStorage.getItem(lcMaHD)
        self.indexOfMaHD(indexCurrent + 1);
    }
    self.prevHoaDon = function () {
        self.indexOfMaHD(self.indexOfMaHD() - 1);
    }
    self.ShowinforTon_Dat = function (item) {
        $(".content-warning").hide();
        $('#wr_' + item.IDRandom).show();
        $(".content-warning").mouseup(function () {
            return false;
        });
        $(".main-warning").mouseup(function () {
            return false;
        });
        $(document).mouseup(function () {
            $(".content-warning").hide();
        });
    }
    self.clickHoaDon = function () {
        $('#txtSearchHH').focus();
        if (self.HoaDons().StatusOffline()) {
            return false;
        }
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            var loaiHD = self.HoaDons().LoaiHoaDon();
            // check if click douple this tab
            if (loaiHD === 1 || loaiHD === 25) {
                return;
            }
            var countHD = GetMax_MaHoaDon(1, lstHD) + 1;
            var idRandomHD = self.HoaDons().IDRandom();
            for (let i = 0; i < lstHD.length; i++) {
                if (lstHD[i].IDRandom === idRandomHD) {
                    lstHD[i].MaHoaDon = nameHD_InsertBH + countHD;
                    lstHD[i].LoaiHoaDon = self.HoaDons().ID_PhieuTiepNhan() !== null ? 25 : 1;
                    lstHD[i].NgayApDungGoiDV = null;
                    lstHD[i].HanSuDungGoiDV = null;
                    break;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(lstHD));
            var cthd = localStorage.getItem(lcListCTHD);
            if (cthd !== null) {
                cthd = JSON.parse(cthd);
                for (let i = 0; i < cthd.length; i++) {
                    if (cthd[i].IDRandomHD === idRandomHD) {
                        cthd[i].LoaiHoaDon = 1;
                        cthd[i].MaHoaDon = nameHD_InsertBH + countHD;
                        cthd[i].BH_NhanVienThucHien = [];
                        cthd[i].GhiChu_NVThucHien = '';
                        cthd[i].GhiChu_NVTuVan = '';
                        cthd[i].GhiChu_NVThucHienPrint = '';
                        cthd[i].GhiChu_NVTuVanPrint = '';
                        cthd[i].ThoiGianThucHien = 0;
                        cthd[i].ID_ViTri = null;
                        cthd[i].TenViTri = '';
                        if (self.ThietLap().XuatAm === false) {
                            if (cthd[i].QuanLyTheoLoHang === false) {
                                if (cthd[i].LaHangHoa) {
                                    cthd[i].CssWarning = (cthd[i].SoLuong > cthd[i].TonKho);
                                }
                            }
                            else {
                                if (cthd[i].LaHangHoa) {
                                    cthd[i].CssWarning = (cthd[i].SoLuong > cthd[i].TonKho);
                                    for (let j = 1; j < cthd[i].DM_LoHang.length; j++) {
                                        cthd[i].DM_LoHang[j].CssWarning = (cthd[i].DM_LoHang[j].SoLuong > cthd[i].DM_LoHang[j].TonKho);
                                    }
                                }
                            }
                        }
                        else {
                            cthd[i].CssWarning = false;
                            for (let j = 0; j < cthd[i].DM_LoHang.length; j++) {
                                cthd[i].DM_LoHang[j].CssWarning = false;
                            }
                        }
                        // update MaHoaDon fror DM_Lo
                        for (let j = 0; j < cthd[i].DM_LoHang.length; j++) {
                            cthd[i].DM_LoHang[j].MaHoaDon = cthd[i].MaHoaDon;
                            cthd[i].DM_LoHang[j].LoaiHoaDon = 1;
                        }
                        for (let j = 0; j < cthd[i].HangCungLoais.length; j++) {
                            cthd[i].HangCungLoais[j].MaHoaDon = cthd[i].MaHoaDon;
                            cthd[i].HangCungLoais[j].LoaiHoaDon = 1;
                        }
                        for (let j = 0; j < cthd[i].ThanhPhanComBo.length; j++) {
                            cthd[i].ThanhPhanComBo[j].MaHoaDon = cthd[i].MaHoaDon;
                            cthd[i].ThanhPhanComBo[j].LoaiHoaDon = 1;
                        }
                    }
                }
                localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
            }

            _maHoaDon = nameHD_InsertBH + countHD;
            localStorage.setItem(lcMaHD, _maHoaDon);
        }
        self.KM_KMApDung([]);
        UpdateKhuyenMai_CTHD(null, idRandomHD);
        UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();
        BindHD_CTHDafterSave();
        Call_6Func();
        ActiveTab_SoDoPhong();
    }

    function ChangeLoaiHD_ResetHD(hd, maHDNew, loaiHD) {
        var idRandomHD = self.HoaDons().IDRandom();
        for (let i = 0; i < hd.length; i++) {
            if (hd[i].IDRandom === idRandomHD) {
                hd[i].MaHoaDon = maHDNew;
                hd[i].LoaiHoaDon = loaiHD;
                hd[i].YeuCau = 1;
                hd[i].ID_KhuyenMai = null;
                hd[i].IsKhuyenMaiHD = false;
                hd[i].KhuyenMai_GhiChu = '';
                hd[i].KhuyeMai_GiamGia = 0;
                hd[i].DiemGiaoDich = 0;
                hd[i].DiemHienTai = 0;
                hd[i].TTBangDiem = 0;
                hd[i].ID_ViTri = null;
                hd[i].TenViTriHD = '';
                hd[i].CreateTime = 0;
                hd[i].ThoiGianThucHien = '';
                hd[i].BH_NhanVienThucHiens = [];
                hd[i].PTChietKhauHH = 0;
                hd[i].PTThueHoaDon = 0;

                if (loaiHD === 19) {
                    let ngaysudungGoiDV = moment(new Date()).format('DD/MM/YYYY');
                    let nextYear = now.getFullYear() + 1;
                    let ngayhethanGoiDV = moment(new Date()).format('DD/MM') + '/' + nextYear;
                    hd[i].NgayApDungGoiDV = ngaysudungGoiDV;
                    hd[i].HanSuDungGoiDV = ngayhethanGoiDV;
                }
                else {
                    hd[i].NgayApDungGoiDV = null;
                    hd[i].HanSuDungGoiDV = null;
                }
                break;
            }
        }
        return hd;
    }

    function ChangeLoaiHD_CTHD(cthd, maHDNew, loaiHD) {
        var idRandomHD = self.HoaDons().IDRandom();
        for (let i = 0; i < cthd.length; i++) {
            if (cthd[i].IDRandomHD === idRandomHD) {
                cthd[i].LoaiHoaDon = loaiHD;
                cthd[i].MaHoaDon = maHDNew;
                cthd[i].BH_NhanVienThucHien = [];
                cthd[i].GhiChu_NVThucHien = '';
                cthd[i].GhiChu_NVTuVan = '';
                cthd[i].GhiChu_NVThucHienPrint = '';
                cthd[i].GhiChu_NVTuVanPrint = '';
                cthd[i].ThoiGianThucHien = 0;
                cthd[i].PhiDichVu = 0;
                cthd[i].TongPhiDichVu = 0;
                cthd[i].ID_ViTri = null;
                cthd[i].TenViTri = '';

                cthd[i].ChatLieu = '';
                cthd[i].ID_ChiTietGoiDV = null;
                cthd[i].ID_ChiTietDinhLuong = null;
                cthd[i].PTChietKhau = 0;
                cthd[i].TienChietKhau = 0;
                cthd[i].PTThue = 0;
                cthd[i].TienThue = 0;
                cthd[i].ID_KhuyenMai = null;
                cthd[i].IsKhuyenMai = false;
                cthd[i].TenKhuyenMai = '';
                cthd[i].HangHoa_KM = [];
                cthd[i].TangKem = false;
                cthd[i].DonGia = cthd[i].GiaBan;
                cthd[i].ThanhTien = cthd[i].GiaBan * cthd[i].SoLuong;
                cthd[i].ThanhToan = cthd[i].ThanhTien;

                if (self.ThietLap().DatHangXuatAm === false) {
                    if (cthd[i].QuanLyTheoLoHang === false) {
                        if (cthd[i].LaHangHoa) {
                            cthd[i].CssWarning = (cthd[i].SoLuong > cthd[i].TonKho);
                        }
                    }
                    else {
                        if (cthd[i].LaHangHoa) {
                            cthd[i].CssWarning = (cthd[i].SoLuong > cthd[i].TonKho);
                            for (let j = 1; j < cthd[i].DM_LoHang.length; j++) {
                                cthd[i].DM_LoHang[j].CssWarning = (cthd[i].DM_LoHang[j].SoLuong > cthd[i].DM_LoHang[j].TonKho);
                            }
                        }
                    }
                }
                else {
                    cthd[i].CssWarning = false;
                    for (let j = 0; j < cthd[i].DM_LoHang.length; j++) {
                        cthd[i].DM_LoHang[j].CssWarning = false;
                    }
                }

                for (let j = 0; j < cthd[i].DM_LoHang.length; j++) {
                    cthd[i].DM_LoHang[j].MaHoaDon = maHDNew;
                    cthd[i].DM_LoHang[j].LoaiHoaDon = loaiHD;
                    cthd[i].DM_LoHang[j].ID_ViTri = null;
                    cthd[i].DM_LoHang[j].TenViTri = '';
                    cthd[i].DM_LoHang[j].ChatLieu = '';
                    cthd[i].DM_LoHang[j].ID_ChiTietGoiDV = null;
                    cthd[i].DM_LoHang[j].ID_ChiTietDinhLuong = null;
                    cthd[i].DM_LoHang[j].PTChietKhau = 0;
                    cthd[i].DM_LoHang[j].TienChietKhau = 0;
                    cthd[i].DM_LoHang[j].PhiDichVu = 0;
                    cthd[i].DM_LoHang[j].TongPhiDichVu = 0;
                    cthd[i].DM_LoHang[j].PTThue = 0;
                    cthd[i].DM_LoHang[j].TienThue = 0;
                    cthd[i].DM_LoHang[j].DonGia = cthd[i].DM_LoHang[j].GiaBan;
                    cthd[i].DM_LoHang[j].ThanhTien = cthd[i].DM_LoHang[j].GiaBan * cthd[i].DM_LoHang[j].SoLuong;
                    cthd[i].DM_LoHang[j].ThanhToan = cthd[i].DM_LoHang[j].ThanhTien;
                }
                for (let j = 0; j < cthd[i].HangCungLoais.length; j++) {
                    cthd[i].HangCungLoais[j].MaHoaDon = maHDNew;
                    cthd[i].HangCungLoais[j].LoaiHoaDon = loaiHD;
                    cthd[i].HangCungLoais[j].ID_ViTri = null;
                    cthd[i].HangCungLoais[j].TenViTri = '';
                    cthd[i].HangCungLoais[j].ChatLieu = '';
                    cthd[i].HangCungLoais[j].ID_ChiTietGoiDV = null;
                    cthd[i].HangCungLoais[j].ID_ChiTietDinhLuong = null;
                    cthd[i].HangCungLoais[j].PTChietKhau = 0;
                    cthd[i].HangCungLoais[j].TienChietKhau = 0;
                    cthd[i].HangCungLoais[j].PhiDichVu = 0;
                    cthd[i].HangCungLoais[j].TongPhiDichVu = 0;
                    cthd[i].HangCungLoais[j].PTThue = 0;
                    cthd[i].HangCungLoais[j].TienThue = 0;
                    cthd[i].HangCungLoais[j].DonGia = cthd[i].HangCungLoais[j].GiaBan;
                    cthd[i].HangCungLoais[j].ThanhTien = cthd[i].HangCungLoais[j].GiaBan * cthd[i].HangCungLoais[j].SoLuong;
                    cthd[i].HangCungLoais[j].ThanhToan = cthd[i].HangCungLoais[j].ThanhTien;
                }
                for (let j = 0; j < cthd[i].ThanhPhanComBo.length; j++) {
                    cthd[i].ThanhPhanComBo[j].MaHoaDon = maHDNew;
                    cthd[i].ThanhPhanComBo[j].LoaiHoaDon = loaiHD;
                }
            }
        }
        return cthd;
    }

    function ChangeLoaiHD_CheckHasKhuyenMai_orUsingService(loaiHD) {
        if (_maHoaDon === '') {
            _maHoaDon = $('.gara-bill-label li.active font').text();
        }

        var loaiHDCurrent = self.HoaDons().LoaiHoaDon();
        var maHDOld = self.HoaDons().MaHoaDon();
        var idRandomHD = self.HoaDons().IDRandom();
        if (loaiHDCurrent === loaiHD) {
            return;
        }

        var countHD = 1;
        let maHDNew = '', mes = '';
        var hd = localStorage.getItem(lcListHD);
        if (hd !== null) {
            hd = JSON.parse(hd);
        }
        else {
            hd = [];
        }
        countHD = GetMax_MaHoaDon(loaiHD, hd) + 1;
        switch (loaiHD) {
            case 3:
                maHDNew = nameHD_InsertDH + countHD;
                mes = 'báo giá';
                break;
            case 19:
                maHDNew = nameHD_AddGoiDV + countHD;
                mes = 'mua gói bảo dưỡng mới';
                break;
        }

        var cthd = localStorage.getItem(lcListCTHD);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
        }
        else {
            cthd = [];
        }

        var haveKhuyenMai = false;
        var hdCurrent = GetHDOpening_byIDRandom(idRandomHD, hd);
        if (hdCurrent.length > 0) {
            haveKhuyenMai = hdCurrent[0].ID_KhuyenMai != null && hdCurrent[0].ID_KhuyenMai !== undefined;

            if (haveKhuyenMai === false) {
                let ctKM = $.grep(cthd, function (x) {
                    return x.IDRandomHD === idRandomHD && x.ID_KhuyenMai !== null && x.ID_KhuyenMai !== undefined;
                });
                if (ctKM.length > 0) {
                    haveKhuyenMai = true;
                }
            }

            if (haveKhuyenMai) {
                dialogConfirm_OKCancel('Xác nhận', 'Hóa đơn đang có chương trình khuyến mại được áp dụng. Bạn có chắc chắn chuyển sang <b>' + mes + ' </b> không?', function () {
                    hd = ChangeLoaiHD_ResetHD(hd, maHDNew, loaiHD);
                    cthd = ChangeLoaiHD_CTHD(cthd, maHDNew, loaiHD);
                    localStorage.setItem(lcListHD, JSON.stringify(hd));
                    localStorage.setItem(lcListCTHD, JSON.stringify(cthd));

                    // remove KM of HoaDon
                    let lstKM_HD = localStorage.getItem(lcProductKM_HoaDon);
                    if (lstKM_HD !== null) {
                        lstKM_HD = JSON.parse(lstKM_HD);
                        lstKM_HD = $.grep(lstKM_HD, function (x) {
                            return x.IDRandomHD !== idRandomHD;
                        });
                        localStorage.setItem(lcProductKM_HoaDon, JSON.stringify(lstKM_HD));
                    }
                    localStorage.setItem(lcMaHD, maHDNew);
                    if (loaiHD === 19) {
                        Reset_PhieuTiepNhan();
                    }
                    BindHD_CTHDafterSave();
                    UpdateCacheHDLe(idRandomHD, false);
                    Call_6Func();
                    ActiveTab_SoDoPhong();
                }, function () {
                    $('#modalPopuplgDelete').modal("hide");
                    _maHoaDon = maHDOld;
                    localStorage.setItem(lcMaHD, _maHoaDon);
                    self.HoaDons().LoaiHoaDon(loaiHDCurrent);

                    Call_6Func();
                    ActiveTab_SoDoPhong();
                });
            }
            else {
                let usingService = false;
                let useGDV = $.grep(cthd, function (x) {
                    return x.IDRandomHD === idRandomHD && x.ChatLieu === '4';
                });
                if (useGDV.length > 0) {
                    usingService = true;
                }
                if (usingService) {
                    dialogConfirm_OKCancel('Xác nhận', 'Hóa đơn đang sử dụng <b> gói bảo dưỡng </b>. Bạn có chắc chắn chuyển sang <b>' + mes + ' </b> không?', function () {
                        hd = ChangeLoaiHD_ResetHD(hd, maHDNew, loaiHD);
                        cthd = ChangeLoaiHD_CTHD(cthd, maHDNew, loaiHD);
                        localStorage.setItem(lcListHD, JSON.stringify(hd));
                        localStorage.setItem(lcListCTHD, JSON.stringify(cthd));

                        localStorage.setItem(lcMaHD, maHDNew);
                        Reset_PhieuTiepNhan();
                        BindHD_CTHDafterSave();
                        UpdateCacheHDLe(idRandomHD, false);
                        Call_6Func();
                        ActiveTab_SoDoPhong();
                    }, function () {
                        $('#modalPopuplgDelete').modal("hide");
                        _maHoaDon = maHDOld;
                        localStorage.setItem(lcMaHD, _maHoaDon);
                        self.HoaDons().LoaiHoaDon(loaiHDCurrent);
                        Call_6Func();
                        ActiveTab_SoDoPhong();
                    });
                }
                else {
                    for (let i = 0; i < hd.length; i++) {
                        if (hd[i].IDRandom === idRandomHD) {
                            hd[i].MaHoaDon = maHDNew;
                            hd[i].LoaiHoaDon = loaiHD;
                            hd[i].DiemQuyDoi = 0;
                            hd[i].TTBangDiem = 0;

                            if (loaiHD === 19) {
                                let ngaysudungGoiDV = moment(new Date()).format('DD/MM/YYYY');
                                let nextYear = now.getFullYear() + 1;
                                let ngayhethanGoiDV = moment(new Date()).format('DD/MM') + '/' + nextYear;
                                hd[i].NgayApDungGoiDV = ngaysudungGoiDV;
                                hd[i].HanSuDungGoiDV = ngayhethanGoiDV;
                            }
                            else {
                                hd[i].NgayApDungGoiDV = null;
                                hd[i].HanSuDungGoiDV = null;
                                hd[i].DiemGiaoDich = 0;
                            }
                            break;
                        }
                    }

                    for (let i = 0; i < cthd.length; i++) {
                        if (cthd[i].IDRandomHD === idRandomHD) {
                            cthd[i].LoaiHoaDon = loaiHD;
                            cthd[i].MaHoaDon = maHDNew;

                            for (let j = 0; j < cthd[i].DM_LoHang.length; j++) {
                                cthd[i].DM_LoHang[j].MaHoaDon = maHDNew;
                                cthd[i].DM_LoHang[j].LoaiHoaDon = loaiHD;
                            }
                            for (let j = 0; j < cthd[i].HangCungLoais.length; j++) {
                                cthd[i].HangCungLoais[j].MaHoaDon = maHDNew;
                                cthd[i].HangCungLoais[j].LoaiHoaDon = loaiHD;
                            }
                            for (let j = 0; j < cthd[i].ThanhPhanComBo.length; j++) {
                                cthd[i].ThanhPhanComBo[j].MaHoaDon = maHDNew;
                                cthd[i].ThanhPhanComBo[j].LoaiHoaDon = loaiHD;
                            }
                        }
                    }
                    localStorage.setItem(lcListHD, JSON.stringify(hd));
                    localStorage.setItem(lcListCTHD, JSON.stringify(cthd));

                    if (loaiHD === 19) {
                        Reset_PhieuTiepNhan();
                    }
                    localStorage.setItem(lcMaHD, maHDNew);
                    BindHD_CTHDafterSave();
                    Call_6Func();
                }
            }
        }
        else {
            let objHDNew = newHoaDon(loaiHD, 1);
            hd.push(objHDNew);
            localStorage.setItem(lcListHD, JSON.stringify(hd));
            _maHoaDon = objHDNew.MaHoaDon;
            localStorage.setItem(lcMaHD, objHDNew.MaHoaDon);
            BindHD_CTHDafterSave();
            Call_6Func();
            ActiveTab_SoDoPhong();
        }
    }

    self.clickDatHang = function () {
        ChangeLoaiHD_CheckHasKhuyenMai_orUsingService(3);
    }
    self.saveDatHang = function (updateHDDatHang) {
        var lstHDTemp = localStorage.getItem(lcListHD);
        var objAdd = [];
        if (lstHDTemp !== null) {
            lstHDTemp = JSON.parse(lstHDTemp);
            objAdd = GetHDOpening_byMaHoaDon(_maHoaDon, lstHDTemp);

            if (commonStatisJs.CheckNull(objAdd[0].ID_DoiTuong) || objAdd[0].ID_DoiTuong === const_GuidEmpty) {
                ShowMessage_Danger('Vui lòng chọn khách hàng khi đặt hàng');
                SaveHD_RemoveDisable();
                return false;
            }

            // tim CTHoaDon t/u voi HoaDon
            var objCTAdd = [];
            var listAllCTHD = localStorage.getItem(lcListCTHD);
            if (listAllCTHD !== null) {
                listAllCTHD = JSON.parse(listAllCTHD);
                objCTAdd = GetCTHoaDon_FromArr(listAllCTHD, objAdd[0].IDRandom);
            }
            if (objCTAdd.length === 0) {
                ShowMessage_Danger('Vui lòng nhập chi tiết hóa đơn');
                SaveHD_RemoveDisable();
                return false;
            }
            var msgErr = "";
            if (self.ThietLap().DatHangXuatAm === false) {
                // check if SoLuong > TonKho
                for (let i = 0; i < objCTAdd.length; i++) {
                    if (objCTAdd[i].LaHangHoa && objCTAdd[i].SoLuong > objCTAdd[i].TonKho) {
                        msgErr += objCTAdd[i].TenHangHoa + ", ";
                    }
                }
                if (msgErr !== "") {
                    msgErr = Remove_LastComma(msgErr);
                    ShowMessage_Danger('Không đủ số lượng tồn kho cho sản phẩm ' + msgErr);
                    SaveHD_RemoveDisable();
                    return false;
                }
            }
            for (let i = 0; i < objCTAdd.length; i++) {
                if (objCTAdd[i].QuanLyTheoLoHang) {
                    if (objCTAdd[i].ID_LoHang === null || objCTAdd[i].ID_LoHang === undefined) {
                        ShowMessage_Danger('Vui lòng nhập đầy đủ thông tin lô cho hàng hóa');
                        SaveHD_RemoveDisable();
                        return;
                    }
                }
            }

            for (let i = 0; i < objCTAdd.length; i++) {
                objCTAdd[i].DonGia = objCTAdd[i].GiaBan;
                // reset DatHang: ID_ChiTietGoiDV: null, ChatLieu = empty
                objCTAdd[i].ID_ChiTietGoiDV = null;
                objCTAdd[i].ChatLieu = '';
            }
            // remove CTHD with QuanLyTheoLo, but ID_Lo== null
            objCTAdd = GetArrCTHD_withIDLoHangOtherNull(objCTAdd);
            var myData = {};
            let maHoaDon = objAdd[0].MaHoaDon;
            if (objAdd[0].StatusOffline === true || maHoaDon.indexOf('Copy') > -1 || objAdd[0].ID !== const_GuidEmpty) {
                objAdd[0].MaHoaDon = maHoaDon;
            }
            else {
                objAdd[0].MaHoaDon = null;
            }
            // ID_DonVi
            if (objAdd[0].ID_DonVi === undefined || objAdd[0].ID_DonVi === null || objAdd[0].ID_DonVi === '') {
                objAdd[0].ID_DonVi = id_DonVi;
            }
            delete objAdd[0]["ID_HoaDon"];

            var ngaylapHD = GetNgayLapHD_whenSave(objAdd[0].NgayLapHoaDon);
            objAdd[0].NgayLapHoaDon = ngaylapHD;
            myData.objHoaDon = objAdd[0];
            myData.objCTHoaDon = objCTAdd;
            myData.IsSetGiaVonTrungBinh = self.ThietLap().GiaVonTrungBinh;
            var lstDoiTuong = localStorage.getItem(lcDM_DoiTuong)
            var itemDoiTuong = [];
            if (lstDoiTuong !== null) {
                var lstDoiTuong1 = JSON.parse(lstDoiTuong);
                itemDoiTuong = $.grep(lstDoiTuong1, function (item) {
                    return item.ID === objAdd[0].ID_DoiTuong;
                });
            }
            if (itemDoiTuong.length > 0) {
                // 1.add DoiTuong, HoaDon
                AddKhachHang_HoaDon(itemDoiTuong[0], myData, false, updateHDDatHang);
            }
            else {
                PostHD_SoQuy_SaveHD(myData, updateHDDatHang);
            }
        }
        else {
            ShowMessage_Danger('Vui lòng nhập thông tin hóa đơn');
            SaveHD_RemoveDisable();
            return;
        }
    }

    function Update_StatusXuLy_ofHDDatHang(idRandomHD, isChangeHDXuLy = true) {
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            // find DH000
            var hdXuLy = $.grep(lstHD, function (x) {
                return x.LoaiHoaDon === 3 && x.IDRandom === idRandomHD && x.ID !== const_GuidEmpty;
            });
            // update Status change = true
            if (hdXuLy.length > 0) {
                for (let i = 0; i < lstHD.length; i++) {
                    if (lstHD[i].ID === hdXuLy[0].ID) {
                        lstHD[i].IsChangeHDXuLy = isChangeHDXuLy;
                        break;
                    }
                }
                localStorage.setItem(lcListHD, JSON.stringify(lstHD));
            }
        }
    }

    // create HDBan and return IDRandomHD 
    function Update_IDChiTietHD_toCTHD(idRandomHD, cthdDB) {
        var cthd = localStorage.getItem(lcListCTHD);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            for (let i = 0; i < cthdDB.length; i++) {
                for (let j = 0; j < cthd.length; j++) {
                    if (cthd[j].IDRandomHD === idRandomHD) {
                        for (let k = 0; k < cthd[j].ThanhPhanComBo.length; k++) {
                            let forCb1 = cthd[j].ThanhPhanComBo[k];
                            if (!commonStatisJs.CheckNull(cthdDB[i].ThanhPhanComBo)) {
                                for (let m = 0; m < cthdDB[i].ThanhPhanComBo.length; m++) {
                                    let forCb2 = cthdDB[i].ThanhPhanComBo[m];
                                    if (forCb1.ID_DonViQuiDoi === forCb2.ID_DonViQuiDoi) {
                                        cthd[j].ThanhPhanComBo[k].ID = forCb2.ID;
                                    }
                                }
                            }
                        }

                        if (cthd[j].ID_DonViQuiDoi === cthdDB[i].ID_DonViQuiDoi
                            && cthd[j].ID_LoHang === cthdDB[i].ID_LoHang) {
                            cthd[j].ID = cthdDB[i].ID;
                            break;
                        }
                    }
                }
            }
            localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
        }
    }
    function CreateHD_fromHDDatHang() {
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            var max = GetMax_MaHoaDon(1, lstHD);
            var itemHD = $.grep(lstHD, function (item) {
                return item.MaHoaDonTraHang === self.HoaDons().MaHoaDon() && item.StatusOffline === false && item.NguoiTao === userLogin;
            });
            var lcXuLiDonHang = localStorage.getItem(lcXuLiDonHang_Const);
            var itemHDGoc = [];
            if (lcXuLiDonHang !== null) {
                lcXuLiDonHang = JSON.parse(lcXuLiDonHang);
                itemHDGoc = $.grep(lcXuLiDonHang, function (itemXL) {
                    return itemXL.MaHoaDon === self.HoaDons().MaHoaDon();
                });
            }
            var idRandomHD = '';
            if (itemHD.length > 0) {
                // Da tao HD from this HD DH000
                _maHoaDon = itemHD[0].MaHoaDon;
                idRandomHD = itemHD[0].IDRandom;
                localStorage.setItem(lcMaHD, _maHoaDon);
            }
            else {
                if (itemHDGoc.length > 0) {
                    var maHDNew = nameHD_InsertBH;
                    maHDNew = maHDNew + (max + 1);
                    localStorage.setItem(lcMaHD, maHDNew);

                    var khachDaTra = 0;
                    var tongGiamGia = itemHDGoc[0].TongGiamGia;
                    var tongchiphi = 0;
                    // Yeu Cau = 1: PhieuTam
                    if (itemHDGoc[0].YeuCau === "1") {
                        // neu HD DatHang chua duoc xu li lan nao --> giu nguyen KhachDaTra
                        khachDaTra = itemHDGoc[0].KhachDaTra;
                        tongchiphi = itemHDGoc[0].TongChiPhi; // xuly lan1--> lay chi phi
                    }
                    else {
                        // neu XuLyHD nhung khong HoanTraTamUng (todo)
                        // nguoc lai, gan KhachDaTra = 0  (vi da duoc hoan tra tam ung khi xu li lan 1)
                        khachDaTra = 0;
                        // neu HD dat hang co giam gia la VND --> gan tonggiam gia =0 (vi da giam gia het khi xu li don hang lan 1)
                        if (itemHDGoc[0].TongChietKhau === 0) {
                            // neu thay đổi giảm giá (VND): tongGG = tongGGnew - tongGGold
                            tongGiamGia = itemHDGoc[0].TongGiamGia - itemHDGoc[0].TongGiamGiaDB;
                            tongGiamGia = tongGiamGia < 0 ? 0 : tongGiamGia;
                        }
                    }
                    idRandomHD = CreateIDRandom('HD_');
                    var maphieuTN = commonStatisJs.CheckNull(itemHDGoc[0].BienSo) ? '' : itemHDGoc[0].MaPhieuTiepNhan.concat('_', itemHDGoc[0].BienSo);
                    var objHDNew = {
                        ID: const_GuidEmpty,
                        IDRandom: idRandomHD,
                        LoaiHoaDon: itemHDGoc[0].ID_PhieuTiepNhan !== null ? 25 : 1,
                        MaHoaDon: maHDNew,
                        MaHoaDonDB: null,
                        MaHoaDonTraHang: itemHDGoc[0].MaHoaDon,
                        ID_HoaDon: itemHDGoc[0].ID,
                        ID_DoiTuong: itemHDGoc[0].ID_DoiTuong,
                        ID_BangGia: itemHDGoc[0].ID_BangGia,
                        ID_NhanVien: itemHDGoc[0].ID_NhanVien,
                        ID_DonVi: itemHDGoc[0].ID_DonVi,
                        NguoiTao: userLogin,
                        NgayLapHoaDon: null,
                        TongTienHang: itemHDGoc[0].TongTienHang,
                        PhaiThanhToan: itemHDGoc[0].PhaiThanhToan,
                        TongGiamGia: tongGiamGia,
                        DaThanhToan: itemHDGoc[0].DaThanhToan,
                        PTThueHoaDon: itemHDGoc[0].PTThueHoaDon,
                        TongTienThue: itemHDGoc[0].TongTienThue,
                        PTThueBaoHiem: 0,
                        TongTienThueBaoHiem: 0,
                        ChoThanhToan: false,
                        DienGiai: itemHDGoc[0].DienGiai,
                        DVTinhGiam: itemHDGoc[0].DVTinhGiam,
                        TongChietKhau: itemHDGoc[0].TongChietKhau, // PTGiam
                        Status: 1, // open(1) - close(0) : use HDOffline
                        StatusOffline: false,
                        TienMat: itemHDGoc[0].TienMat,
                        TienGui: itemHDGoc[0].TienGui,
                        TienThua: 0,
                        // Tra Hang
                        PhaiThanhToanDB: 0,
                        TongGiaGocHangTra: 0,
                        TongChiPhi: tongchiphi,
                        TongChiPhiHangTra: 0,
                        HoanTraThuKhac: 0,
                        TongTienTra: 0,
                        PhaiTraKhach: 0,
                        DaTraKhach: 0,
                        GiaoHang: false,
                        MaHoaDonTH_NVien: '',
                        TongGiamGiaDB: 0,
                        PTGiamDB: 0,
                        TongThueDB: 0,
                        PTThueDB: 0,
                        TrangThaiHD: 1,// HD xuly tuDH
                        IsActive: '',
                        KhachDaTra: khachDaTra,
                        BaoHiemDaTra: 0,// todo
                        KhuyeMai_GiamGia: itemHDGoc[0].KhuyeMai_GiamGia,
                        DiemGiaoDich: 0,
                        TTBangDiem: 0,
                        DiemQuyDoi: 0,
                        DiemHienTai: 0,
                        DiemGiaoDichDB: 0,
                        DiemCong: 0, // use when KM_Cong diem

                        // Goi dich vu
                        NgayApDungGoiDV: null,
                        HanSuDungGoiDV: null,
                        IsChangeHDXuLy: false,
                        BH_NhanVienThucHiens: [],
                        TienTheGiaTri: 0,
                        ThoiGianThucHien: 0,
                        CreateTime: 0,
                        TenViTriHD: '',
                        ID_ViTri: null,
                        TenNhanVien: itemHDGoc[0].TenNhanVien,

                        MaPhieuTiepNhan: maphieuTN,
                        ID_PhieuTiepNhan: itemHDGoc[0].ID_PhieuTiepNhan,
                        ID_BaoHiem: itemHDGoc[0].ID_BaoHiem,
                        LienHeBaoHiem: itemHDGoc[0].LienHeBaoHiem,
                        SoDienThoaiLienHeBaoHiem: itemHDGoc[0].SoDienThoaiLienHeBaoHiem,
                        PhaiThanhToanBaoHiem: itemHDGoc[0].PhaiThanhToanBaoHiem,
                        ChiPhi_GhiChu: itemHDGoc[0].ChiPhi_GhiChu,
                        TongThanhToan: itemHDGoc[0].TongThanhToan,
                        TenBaoHiem: itemHDGoc[0].TenBaoHiem,

                        XuatKhoAll: false,
                        DuyetBaoGia: false,

                        PTChietKhauHH: itemHDGoc[0].PTChietKhauHH,
                        TongGiamGiaHang: itemHDGoc[0].TongGiamGiaHang,
                        TongTienHangChuaCK: 0,
                        TongTienKhuyenMai_CT: 0,
                        TongGiamGiaKhuyenMai_CT: 0,
                        SoDuDatCoc: 0,

                        SoVuBaoHiem: '',
                        KhauTruTheoVu: 0,
                        GiamTruBoiThuong: 0,
                        PTGiamTruBoiThuong: 0,
                        TongTienThueBaoHiem: 0,
                        PTThueBaoHiem: 0,
                        BHThanhToanTruocThue: 0,
                        TongTienBHDuyet: 0,
                        TongThueKhachHang: itemHDGoc[0].TongTienThue,
                        PTThueKhachHang: 0,
                        CongThucBaoHiem: 0,
                        GiamTruThanhToanBaoHiem: 0,
                        HeaderBH_Type: 1,
                        HeaderBH_GiaTriPtram: 0,
                        ID_Xe: itemHDGoc[0].ID_Xe,
                        BienSo: itemHDGoc[0].BienSo,
                    }
                    lstHD.push(objHDNew);
                    localStorage.setItem(lcListHD, JSON.stringify(lstHD));

                    // find CTHD with maHD & push
                    var cthd = localStorage.getItem(lcListCTHD);
                    if (cthd !== null) {
                        cthd = JSON.parse(cthd);
                        var ctDatHangCopy = localStorage.getItem(lcCTDatHang_Const);
                        if (ctDatHangCopy !== null) {
                            ctDatHangCopy = JSON.parse(ctDatHangCopy);
                            for (let i = 0; i < ctDatHangCopy.length; i++) {
                                if (ctDatHangCopy[i].MaHoaDon === _maHoaDon) {
                                    ctDatHangCopy[i].IDRandom = CreateIDRandom('RandomCT_');
                                    ctDatHangCopy[i].IDRandomHD = idRandomHD;
                                    ctDatHangCopy[i].MaHoaDon = maHDNew;
                                    ctDatHangCopy[i].LoaiHoaDon = objHDNew.LoaiHoaDon;
                                    ctDatHangCopy[i].ID_ChiTietGoiDV = ctDatHangCopy[i].ID;
                                    if (ctDatHangCopy[i].QuanLyTheoLoHang === false) {
                                        // show warning if TonKho < SoLuong
                                        if (self.ThietLap().XuatAm === false && ctDatHangCopy[i].LaHangHoa && ctDatHangCopy[i].TonKho < ctDatHangCopy[i].SoLuong) {
                                            ctDatHangCopy[i].CssWarning = true;
                                        }
                                        else {
                                            ctDatHangCopy[i].CssWarning = false;
                                        }
                                        // soluong parent = 0
                                        if (ctDatHangCopy[i].SoLuongConLai === 0) {
                                            // find HangCungLoais with SoLuongConlai > 0
                                            let itemSL_otherZero = $.grep(ctDatHangCopy[i].HangCungLoais, function (x) {
                                                return x.SoLuongConLai > 0;
                                            });
                                            if (itemSL_otherZero.length > 0) {
                                                let min = Math.min.apply(Math, itemSL_otherZero.map(function (x) {
                                                    return x.SoThuTu.toString().match(/\d+/);
                                                }));
                                                // assign HangCungLoai with stt min for CTDatHang
                                                for (let k = 0; k < ctDatHangCopy[i].HangCungLoais.length; k++) {
                                                    let minSTT = ctDatHangCopy[i].HangCungLoais[k];
                                                    if (minSTT.SoThuTu === min) {
                                                        ctDatHangCopy[i].ID_ChiTietGoiDV = minSTT.ID;
                                                        ctDatHangCopy[i].SoLuongConLai = minSTT.SoLuongConLai;
                                                        ctDatHangCopy[i].SoLuongDaMua = minSTT.SoLuongConLai;
                                                        ctDatHangCopy[i].SoLuong = minSTT.SoLuongConLai;
                                                        ctDatHangCopy[i].DonGia = minSTT.DonGia;
                                                        ctDatHangCopy[i].GiaBan = minSTT.GiaBan;
                                                        ctDatHangCopy[i].TienChietKhau = minSTT.TienChietKhau;
                                                        ctDatHangCopy[i].PTChietKhau = minSTT.PTChietKhau;
                                                        ctDatHangCopy[i].PTThue = minSTT.PTThue;
                                                        ctDatHangCopy[i].TienThue = minSTT.TienThue;
                                                        ctDatHangCopy[i].DVTinhGiam = minSTT.PTChietKhau > 0 || minSTT.TienChietKhau === 0 ? '%' : 'VND';
                                                        let giasauCK = minSTT.GiaBan - minSTT.TienChietKhau;
                                                        ctDatHangCopy[i].ThanhTien = minSTT.SoLuongConLai * giasauCK;
                                                        ctDatHangCopy[i].ThanhToan = minSTT.SoLuongConLai * (giasauCK + minSTT.TienThue);
                                                        break;
                                                    }
                                                }
                                                // remove HangCungLoais with SoLuongConLai = 0 or STT min  (because HangCungLoai min are now parent)
                                                ctDatHangCopy[i].HangCungLoais = $.grep(ctDatHangCopy[i].HangCungLoais, function (x) {
                                                    return x.SoLuongConLai > 0 && x.SoThuTu !== min;
                                                });
                                            }
                                        }
                                        else { // soluong parent !=0 
                                            // remove lot with SoLuongConLai = 0
                                            ctDatHangCopy[i].HangCungLoais = $.grep(ctDatHangCopy[i].HangCungLoais, function (x) {
                                                return x.SoLuongConLai > 0;
                                            });
                                            ctDatHangCopy[i].SoLuongDaMua = ctDatHangCopy[i].SoLuongConLai;
                                            ctDatHangCopy[i].SoLuong = ctDatHangCopy[i].SoLuongConLai;
                                            let giasauCK = ctDatHangCopy[i].GiaBan - ctDatHangCopy[i].TienChietKhau;
                                            ctDatHangCopy[i].ThanhTien = ctDatHangCopy[i].SoLuongConLai * giasauCK;
                                            ctDatHangCopy[i].ThanhToan = ctDatHangCopy[i].SoLuongConLai * (giasauCK + ctDatHangCopy[i].TienThue)
                                        }
                                    }
                                    else { // quanlytheolo
                                        if (ctDatHangCopy[i].SoLuongConLai === 0) {
                                            // find DM_LoHang with SoLuongConlai > 0
                                            let itemSL_otherZero = $.grep(ctDatHangCopy[i].DM_LoHang, function (x) {
                                                return x.SoLuongConLai > 0;
                                            });
                                            if (itemSL_otherZero.length > 0) {
                                                let min = Math.min.apply(Math, itemSL_otherZero.map(function (x) {
                                                    return x.SoThuTu.toString().match(/\d+/);
                                                }));
                                                // assign LoHang min for CTDatHang
                                                for (let k = 0; k < ctDatHangCopy[i].DM_LoHang.length; k++) {
                                                    let minSTT = ctDatHangCopy[i].DM_LoHang[k];
                                                    if (minSTT.SoThuTu === min) {
                                                        ctDatHangCopy[i].DM_LoHang[k].LoaiHoaDon = objHDNew.LoaiHoaDon;
                                                        ctDatHangCopy[i].DM_LoHang[k].LotParent = true;
                                                        ctDatHangCopy[i].DM_LoHang[k].IDRandom = ctDatHangCopy[i].IDRandom;
                                                        ctDatHangCopy[i].DM_LoHang[k].IDRandomHD = idRandomHD;

                                                        ctDatHangCopy[i].ID_ChiTietGoiDV = minSTT.ID;
                                                        ctDatHangCopy[i].SoLuongConLai = minSTT.SoLuongConLai;
                                                        ctDatHangCopy[i].SoLuongDaMua = minSTT.SoLuongConLai;
                                                        ctDatHangCopy[i].SoLuong = minSTT.SoLuongConLai;
                                                        ctDatHangCopy[i].DonGia = minSTT.DonGia;
                                                        ctDatHangCopy[i].GiaBan = minSTT.GiaBan;
                                                        ctDatHangCopy[i].TienChietKhau = minSTT.TienChietKhau;
                                                        ctDatHangCopy[i].PTChietKhau = minSTT.PTChietKhau;
                                                        ctDatHangCopy[i].DVTinhGiam = minSTT.PTChietKhau > 0 || minSTT.TienChietKhau === 0 ? '%' : 'VND';
                                                        let giasauCK = minSTT.GiaBan - minSTT.TienChietKhau;
                                                        ctDatHangCopy[i].ThanhTien = minSTT.SoLuongConLai * giasauCK;
                                                        ctDatHangCopy[i].ThanhToan = minSTT.SoLuongConLai * (giasauCK + ctDatHangCopy[i].TienThue);
                                                        // assign again ID_lohang for CTHDDathang (because CTDatHangold have ID_Lohang old)
                                                        ctDatHangCopy[i].ID_LoHang = minSTT.ID_LoHang;
                                                        break;
                                                    }
                                                }
                                                // remove DM_LoHang with SoLuongConLai = 0
                                                ctDatHangCopy[i].DM_LoHang = $.grep(ctDatHangCopy[i].DM_LoHang, function (x) {
                                                    return x.SoLuongConLai > 0;
                                                });
                                            }
                                        }
                                        else { // soluong parent !=0 
                                            // remove lot with SoLuongConLai = 0
                                            ctDatHangCopy[i].DM_LoHang = $.grep(ctDatHangCopy[i].DM_LoHang, function (x) {
                                                return x.SoLuongConLai > 0;
                                            });
                                            ctDatHangCopy[i].SoLuongDaMua = ctDatHangCopy[i].SoLuongConLai;
                                            ctDatHangCopy[i].SoLuong = ctDatHangCopy[i].SoLuongConLai;
                                            let giasauCK = ctDatHangCopy[i].GiaBan - ctDatHangCopy[i].TienChietKhau;
                                            ctDatHangCopy[i].ThanhTien = ctDatHangCopy[i].SoLuongConLai * giasauCK;
                                            ctDatHangCopy[i].ThanhToan = ctDatHangCopy[i].SoLuongConLai * (giasauCK + ctDatHangCopy[i].TienThue);
                                        }
                                    }// end else quanlytheolo
                                    // update infor MaHoaDon, IDRandom, IDRandomHD into DM_LoHang, HangcungLoais after remove 

                                    if (ctDatHangCopy[i].SoLuongConLai > 0) {
                                        if (ctDatHangCopy[i].LaPTPhiDichVu) {
                                            ctDatHangCopy[i].TongPhiDichVu = RoundDecimal(ctDatHangCopy[i].PhiDichVu * ctDatHangCopy[i].GiaBan * ctDatHangCopy[i].SoLuong / 100);
                                        }
                                        else {
                                            ctDatHangCopy[i].TongPhiDichVu = ctDatHangCopy[i].PhiDichVu * ctDatHangCopy[i].SoLuong;
                                        }
                                        for (let k = 1; k < ctDatHangCopy[i].DM_LoHang.length; k++) {
                                            let forIn = ctDatHangCopy[i].DM_LoHang[k];
                                            ctDatHangCopy[i].DM_LoHang[k].IDRandom = CreateIDRandom('RandomCT_');
                                            ctDatHangCopy[i].DM_LoHang[k].IDRandomHD = idRandomHD;
                                            ctDatHangCopy[i].DM_LoHang[k].MaHoaDon = maHDNew;
                                            ctDatHangCopy[i].DM_LoHang[k].LoaiHoaDon = objHDNew.LoaiHoaDon;
                                            ctDatHangCopy[i].DM_LoHang[k].ID_ChiTietGoiDV = forIn.ID;
                                            ctDatHangCopy[i].DM_LoHang[k].SoLuongDaMua = forIn.SoLuongConLai;
                                            ctDatHangCopy[i].DM_LoHang[k].SoLuong = forIn.SoLuongConLai;
                                            let giasauCK = forIn.GiaBan - forIn.TienChietKhau;
                                            ctDatHangCopy[i].DM_LoHang[k].ThanhTien = forIn.SoLuongConLai * giasauCK;
                                            ctDatHangCopy[i].DM_LoHang[k].ThanhToan = forIn.SoLuongConLai * (giasauCK + forIn.TienThue);

                                            for (let m = 0; m < forIn.ThanhPhan_DinhLuong.length; m++) {
                                                // update again soluong in tpdluong
                                                forIn.ThanhPhan_DinhLuong[m].SoLuong = forIn.ThanhPhan_DinhLuong[m].SoLuongMacDinh * forIn.SoLuongConLai;
                                            }
                                        }
                                        for (let k = 0; k < ctDatHangCopy[i].HangCungLoais.length; k++) {
                                            let forIn = ctDatHangCopy[i].HangCungLoais[k];
                                            ctDatHangCopy[i].HangCungLoais[k].IDRandom = CreateIDRandom('RandomCT_');
                                            ctDatHangCopy[i].HangCungLoais[k].IDRandomHD = idRandomHD;
                                            ctDatHangCopy[i].HangCungLoais[k].MaHoaDon = maHDNew;
                                            ctDatHangCopy[i].HangCungLoais[k].LoaiHoaDon = objHDNew.LoaiHoaDon;
                                            ctDatHangCopy[i].HangCungLoais[k].ID_ChiTietGoiDV = forIn.ID;
                                            ctDatHangCopy[i].HangCungLoais[k].SoLuongDaMua = forIn.SoLuongConLai;
                                            ctDatHangCopy[i].HangCungLoais[k].SoLuong = forIn.SoLuongConLai;
                                            let giasauCK = forIn.GiaBan - forIn.TienChietKhau;
                                            ctDatHangCopy[i].HangCungLoais[k].ThanhTien = forIn.SoLuongConLai * giasauCK;
                                            ctDatHangCopy[i].HangCungLoais[k].ThanhToan = forIn.SoLuongConLai * (giasauCK + forIn.TienThue);
                                            for (let m = 0; m < forIn.ThanhPhan_DinhLuong.length; m++) {
                                                forIn.ThanhPhan_DinhLuong[m].SoLuong = forIn.ThanhPhan_DinhLuong[m].SoLuongMacDinh * forIn.SoLuongConLai;
                                            }

                                            if (ctDatHangCopy[i].LaPTPhiDichVu) {
                                                ctDatHangCopy[i].HangCungLoais[k].TongPhiDichVu = RoundDecimal(ctDatHangCopy[i].PhiDichVu * forIn.GiaBan * forIn.SoLuong / 100);
                                            }
                                            else {
                                                ctDatHangCopy[i].HangCungLoais[k].TongPhiDichVu = ctDatHangCopy[i].PhiDichVu * forIn.SoLuong;
                                            }
                                        }
                                        for (let k = 0; k < ctDatHangCopy[i].ThanhPhanComBo.length; k++) {
                                            let forIn = ctDatHangCopy[i].ThanhPhanComBo[k];
                                            ctDatHangCopy[i].ThanhPhanComBo[k].IDRandom = CreateIDRandom('RandomCT_');
                                            ctDatHangCopy[i].ThanhPhanComBo[k].IDRandomHD = idRandomHD;
                                            ctDatHangCopy[i].ThanhPhanComBo[k].MaHoaDon = maHDNew;
                                            ctDatHangCopy[i].ThanhPhanComBo[k].LoaiHoaDon = objHDNew.LoaiHoaDon;
                                            ctDatHangCopy[i].ThanhPhanComBo[k].ID_ChiTietGoiDV = forIn.ID;
                                            ctDatHangCopy[i].ThanhPhanComBo[k].SoLuongDaMua = forIn.SoLuongConLai;
                                            ctDatHangCopy[i].ThanhPhanComBo[k].SoLuong = forIn.SoLuongConLai;
                                            let giasauCK = forIn.GiaBan - forIn.TienChietKhau;
                                            ctDatHangCopy[i].ThanhPhanComBo[k].ThanhTien = forIn.SoLuongConLai * giasauCK;
                                            ctDatHangCopy[i].ThanhPhanComBo[k].ThanhToan = forIn.SoLuongConLai * (giasauCK + forIn.TienThue);
                                            for (let m = 0; m < forIn.ThanhPhan_DinhLuong.length; m++) {
                                                forIn.ThanhPhan_DinhLuong[m].SoLuong = forIn.ThanhPhan_DinhLuong[m].SoLuongMacDinh * forIn.SoLuongConLai;
                                            }
                                            if (forIn.LaPTPhiDichVu) {
                                                ctDatHangCopy[i].ThanhPhanComBo[k].TongPhiDichVu = RoundDecimal(forIn.PhiDichVu * forIn.GiaBan * forIn.SoLuong / 100);
                                            }
                                            else {
                                                ctDatHangCopy[i].ThanhPhanComBo[k].TongPhiDichVu = forIn.PhiDichVu * forIn.SoLuong;
                                            }
                                        }
                                        cthd.push(ctDatHangCopy[i]);
                                    }
                                }// end if _maHoaDon
                            }// end for ctDatHang
                            localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
                        }

                        _maHoaDon = maHDNew;
                        localStorage.setItem(lcMaHD, maHDNew);
                        UpdateCacheHDLe(idRandomHD, false);
                        UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();

                        // update tpdinhluong for cthd from dathang
                        var cthd = localStorage.getItem(lcListCTHD);
                        if (cthd !== null) {
                            cthd = JSON.parse(cthd);
                            for (let i = 0; i < cthd.length; i++) {
                                let itFor = cthd[i];
                                UpdateSoLuong_TPDinhLuong_ofCTHD(itFor.IDRandomHD, itFor.IDRandom, itFor.SoLuong, false);
                            }
                        }
                    }
                }
            }
            return idRandomHD;
        }
    }

    // used to assign ID_ChiTietGDV for cthd ban
    function Update_IDChiTietHD_toCacheDH(cthdDB) {
        var lcCTDatHang = localStorage.getItem(lcCTDatHang_Const);
        if (lcCTDatHang !== null) {
            lcCTDatHang = JSON.parse(lcCTDatHang);
            for (let i = 0; i < cthdDB.length; i++) {
                for (let j = 0; j < lcCTDatHang.length; j++) {
                    if (lcCTDatHang[j].ID_DonViQuiDoi === cthdDB[i].ID_DonViQuiDoi) {

                        for (let k = 0; k < lcCTDatHang[j].ThanhPhanComBo.length; k++) {
                            let forCb1 = lcCTDatHang[j].ThanhPhanComBo[k];
                            if (!commonStatisJs.CheckNull(cthdDB[i].ThanhPhanComBo)) {
                                for (let m = 0; m < cthdDB[i].ThanhPhanComBo.length; m++) {
                                    let forCb2 = cthdDB[i].ThanhPhanComBo[m];
                                    if (forCb1.ID_DonViQuiDoi === forCb2.ID_DonViQuiDoi) {
                                        lcCTDatHang[j].ThanhPhanComBo[k].ID = forCb2.ID;
                                    }
                                }
                            }
                        }

                        if (lcCTDatHang[j].ThanhTien === cthdDB[i].ThanhTien) {
                            lcCTDatHang[j].ID = cthdDB[i].ID;
                            break;
                        }
                        else {
                            for (let k = 1; k < lcCTDatHang[j].DM_LoHang.length; k++) {
                                if (lcCTDatHang[j].DM_LoHang[k].ThanhTien === cthdDB[i].ThanhTien) {
                                    lcCTDatHang[j].DM_LoHang[k].ID = cthdDB[i].ID;
                                    j = lcCTDatHang.length; // esc loop lcCTDatHang
                                    break;
                                }
                            }
                            if (j < lcCTDatHang.length) {
                                for (let k = 0; k < lcCTDatHang[j].HangCungLoais.length; k++) {
                                    if (lcCTDatHang[j].HangCungLoais[k].ThanhTien === cthdDB[i].ThanhTien) {
                                        lcCTDatHang[j].HangCungLoais[k].ID = cthdDB[i].ID;
                                        j = lcCTDatHang.length; // esc loop lcCTDatHang
                                        break;
                                    }
                                }
                            }
                        }
                    }
                }
            }
            localStorage.setItem(lcCTDatHang_Const, JSON.stringify(lcCTDatHang));
        }
    }
    function UpdateCache_XuLyDonHang() {
        // update cache ctDH
        var lcCTDatHang = localStorage.getItem(lcCTDatHang_Const);
        if (lcCTDatHang !== null) {
            lcCTDatHang = JSON.parse(lcCTDatHang);
            var lstCTHD = localStorage.getItem(lcListCTHD);
            lstCTHD = JSON.parse(lstCTHD);
            var idRandomHD = GetIDRandomHD_byMaHoaDon(_maHoaDon);
            // find cthd with idRandomHD 
            var cthdNew = $.grep(lstCTHD, function (x) {
                return x.IDRandomHD === idRandomHD;
            });
            var arrIDQuiDoiEx = [];
            for (let i = 0; i < lcCTDatHang.length; i++) {
                let cacheDH = lcCTDatHang[i];
                for (let j = 0; j < cthdNew.length; j++) {
                    let cthd = cthdNew[j];
                    if (cthd.ID_DonViQuiDoi === cacheDH.ID_DonViQuiDoi) {
                        arrIDQuiDoiEx.push(cacheDH.ID_DonViQuiDoi);
                        if (cthd.QuanLyTheoLoHang) {
                            if (cthd.ID_LoHang === cacheDH.ID_LoHang) {
                                lcCTDatHang[i].SoLuongConLai = parseFloat(cthd.SoLuong) - cacheDH.SoLuong + cacheDH.SoLuongConLai;
                                lcCTDatHang[i].DonGia = parseFloat(cthd.DonGia);
                                lcCTDatHang[i].GiaBan = parseFloat(cthd.GiaBan);
                                lcCTDatHang[i].TienChietKhau = parseFloat(cthd.TienChietKhau);
                                lcCTDatHang[i].PTChietKhau = parseFloat(cthd.PTChietKhau);
                                lcCTDatHang[i].PTThue = parseFloat(cthd.PTThue);
                                lcCTDatHang[i].TienThue = parseFloat(cthd.TienThue);
                                lcCTDatHang[i].ThanhTien = parseFloat(cthd.ThanhTien);
                                lcCTDatHang[i].ThanhToan = parseFloat(cthd.ThanhToan);
                            }
                        }
                        else {
                            lcCTDatHang[i].SoLuongConLai = parseFloat(cthd.SoLuong) - cacheDH.SoLuong + cacheDH.SoLuongConLai;
                            lcCTDatHang[i].DonGia = parseFloat(cthd.DonGia);
                            lcCTDatHang[i].GiaBan = parseFloat(cthd.GiaBan);
                            lcCTDatHang[i].TienChietKhau = parseFloat(cthd.TienChietKhau);
                            lcCTDatHang[i].PTChietKhau = parseFloat(cthd.PTChietKhau);
                            lcCTDatHang[i].PTThue = parseFloat(cthd.PTThue);
                            lcCTDatHang[i].TienThue = parseFloat(cthd.TienThue);
                            lcCTDatHang[i].ThanhTien = parseFloat(cthd.ThanhTien);
                            lcCTDatHang[i].ThanhToan = parseFloat(cthd.ThanhToan);
                        }

                        for (let k = 0; k < cacheDH.DM_LoHang.length; k++) {
                            for (let m = 0; m < cthd.DM_LoHang.length; m++) {
                                if (cacheDH.DM_LoHang[k].IDRandom === cthd.DM_LoHang[m].IDRandom) {
                                    lcCTDatHang[i].DM_LoHang[k].SoLuongConLai = parseFloat(cthd.DM_LoHang[m].SoLuong) - cacheDH.DM_LoHang[k].SoLuong + cacheDH.DM_LoHang[k].SoLuongConLai;
                                    lcCTDatHang[i].DM_LoHang[k].DonGia = parseFloat(cthd.DM_LoHang[m].DonGia);
                                    lcCTDatHang[i].DM_LoHang[k].GiaBan = parseFloat(cthd.DM_LoHang[m].GiaBan);
                                    lcCTDatHang[i].DM_LoHang[k].TienChietKhau = parseFloat(cthd.DM_LoHang[m].TienChietKhau);
                                    lcCTDatHang[i].DM_LoHang[k].PTChietKhau = parseFloat(cthd.DM_LoHang[m].PTChietKhau);
                                    lcCTDatHang[i].DM_LoHang[k].PTThue = parseFloat(cthd.DM_LoHang[m].PTThue);
                                    lcCTDatHang[i].DM_LoHang[k].TienThue = parseFloat(cthd.DM_LoHang[m].TienThue);
                                    lcCTDatHang[i].DM_LoHang[k].ThanhTien = parseFloat(cthd.DM_LoHang[m].ThanhTien);
                                    lcCTDatHang[i].DM_LoHang[k].ThanhToan = parseFloat(cthd.DM_LoHang[m].ThanhToan);
                                    break;
                                }
                            }
                        }
                        for (let k = 0; k < cacheDH.HangCungLoais.length; k++) {
                            for (let m = 0; m < cthd.HangCungLoais.length; m++) {
                                if (cacheDH.HangCungLoais[k].IDRandom === cthd.HangCungLoais[m].IDRandom) {
                                    lcCTDatHang[i].HangCungLoais[k].SoLuongConLai = parseFloat(cthd.HangCungLoais[m].SoLuong) - cacheDH.HangCungLoais[k].SoLuong + cacheDH.HangCungLoais[k].SoLuongConLai;
                                    lcCTDatHang[i].HangCungLoais[k].DonGia = parseFloat(cthd.HangCungLoais[m].DonGia);
                                    lcCTDatHang[i].HangCungLoais[k].GiaBan = parseFloat(cthd.HangCungLoais[m].GiaBan);
                                    lcCTDatHang[i].HangCungLoais[k].TienChietKhau = parseFloat(cthd.HangCungLoais[m].TienChietKhau);
                                    lcCTDatHang[i].HangCungLoais[k].PTChietKhau = parseFloat(cthd.HangCungLoais[m].PTChietKhau);
                                    lcCTDatHang[i].HangCungLoais[k].PTThue = parseFloat(cthd.HangCungLoais[m].PTThue);
                                    lcCTDatHang[i].HangCungLoais[k].TienThue = parseFloat(cthd.HangCungLoais[m].TienThue);
                                    lcCTDatHang[i].HangCungLoais[k].ThanhTien = parseFloat(cthd.HangCungLoais[m].ThanhTien);
                                    lcCTDatHang[i].HangCungLoais[k].ThanhToan = parseFloat(cthd.HangCungLoais[m].ThanhToan);
                                    break;
                                }
                            }
                        }

                        for (let k = 0; k < cacheDH.ThanhPhanComBo.length; k++) {
                            for (let m = 0; m < cthd.ThanhPhanComBo.length; m++) {
                                if (cacheDH.ThanhPhanComBo[k].IDRandom === cthd.ThanhPhanComBo[m].IDRandom) {
                                    lcCTDatHang[i].ThanhPhanComBo[k].SoLuongConLai = cthd.ThanhPhanComBo[m].SoLuong - cacheDH.ThanhPhanComBo[k].SoLuong + cacheDH.ThanhPhanComBo[k].SoLuongConLai;
                                    lcCTDatHang[i].ThanhPhanComBo[k].DonGia = parseFloat(cthd.ThanhPhanComBo[m].DonGia);
                                    lcCTDatHang[i].ThanhPhanComBo[k].GiaBan = parseFloat(cthd.ThanhPhanComBo[m].GiaBan);
                                    lcCTDatHang[i].ThanhPhanComBo[k].TienChietKhau = parseFloat(cthd.ThanhPhanComBo[m].TienChietKhau);
                                    lcCTDatHang[i].ThanhPhanComBo[k].PTChietKhau = parseFloat(cthd.ThanhPhanComBo[m].PTChietKhau);
                                    lcCTDatHang[i].ThanhPhanComBo[k].ThanhTien = parseFloat(cthd.ThanhPhanComBo[m].ThanhTien);
                                    break;
                                }
                            }
                        }
                        break;
                    }
                }
            }
            // push CTHD not exist in cache XuLy (only have in CTHD)
            var arrIDQuiDoi_NotExistDH = []
            for (let i = 0; i < lstCTHD.length; i++) {
                let itemFor = lstCTHD[i];
                if (lstCTHD[i].IDRandomHD === idRandomHD) {
                    if ($.inArray(itemFor.ID_DonViQuiDoi, arrIDQuiDoiEx) === -1) {
                        itemFor.SoLuongConLai = itemFor.SoLuong;
                        for (let j = 0; j < itemFor.DM_LoHang.length; j++) {
                            itemFor.DM_LoHang[j].SoLuongConLai = itemFor.DM_LoHang[j].SoLuong;
                        }
                        for (let j = 0; j < itemFor.HangCungLoais.length; j++) {
                            itemFor.HangCungLoais[j].SoLuongConLai = itemFor.HangCungLoais[j].SoLuong;
                        }
                        for (let j = 0; j < itemFor.ThanhPhanComBo.length; j++) {
                            itemFor.ThanhPhanComBo[j].SoLuongConLai = itemFor.ThanhPhanComBo[j].SoLuong;
                        }
                        lcCTDatHang.push(itemFor);
                    }
                    arrIDQuiDoi_NotExistDH.push(itemFor.ID_DonViQuiDoi);
                }
            }
            // remove cacheXuLy if notexist in CTHD
            lcCTDatHang = $.grep(lcCTDatHang, function (x) {
                return $.inArray(x.ID_DonViQuiDoi, arrIDQuiDoi_NotExistDH) > -1;
            })
            localStorage.setItem(lcCTDatHang_Const, JSON.stringify(lcCTDatHang));
            // update cache xulyDH
            var lcHDXuLy = localStorage.getItem(lcXuLiDonHang_Const);
            lcHDXuLy = JSON.parse(lcHDXuLy);
            var lstHD = localStorage.getItem(lcListHD);
            lstHD = JSON.parse(lstHD);
            for (let i = 0; i < lcHDXuLy.length; i++) {
                if (lcHDXuLy[i].MaHoaDon === _maHoaDon) {
                    for (let j = 0; j < lstHD.length; j++) {
                        if (lstHD[j].MaHoaDon === lcHDXuLy[i].MaHoaDon) {
                            lcHDXuLy[i].ID_DoiTuong = lstHD[j].ID_DoiTuong;
                            lcHDXuLy[i].ID_NhanVien = lstHD[j].ID_NhanVien;
                            lcHDXuLy[i].ID_BangGia = lstHD[j].ID_BangGia;
                            lcHDXuLy[i].ID_DonVi = lstHD[j].ID_DonVi;
                            lcHDXuLy[i].DienGiai = self.HoaDons().DienGiai();
                            lcHDXuLy[i].TongTienHang = lstHD[j].TongTienHang;
                            lcHDXuLy[i].PTThueHoaDon = lstHD[j].PTThueHoaDon;
                            lcHDXuLy[i].TongTienThue = lstHD[j].TongTienThue;
                            lcHDXuLy[i].PTThueBaoHiem = lstHD[j].PTThueBaoHiem;
                            lcHDXuLy[i].TongTienThueBaoHiem = lstHD[j].TongTienThueBaoHiem;
                            lcHDXuLy[i].PhaiThanhToan = lstHD[j].PhaiThanhToan;
                            lcHDXuLy[i].TongThanhToan = lcHDXuLy[i].PhaiThanhToan;
                            lcHDXuLy[i].TongGiamGia = lstHD[j].TongGiamGia;
                            lcHDXuLy[i].PTChietKhauHH = lstHD[j].PTChietKhauHH;
                            lcHDXuLy[i].TongTienHangChuaCK = lstHD[j].TongTienHangChuaCK;
                            lcHDXuLy[i].TongGiamGiaHang = lstHD[j].TongGiamGiaHang;
                            lcHDXuLy[i].TongGiamGiaKM_HD = lstHD[j].TongGiamGiaKM_HD;
                            lcHDXuLy[i].TongChietKhau = lstHD[j].TongChietKhau;
                            lcHDXuLy[i].TienMat = lstHD[j].TongTienHang;
                            lcHDXuLy[i].TienGui = 0;
                            lcHDXuLy[i].KhachDaTra = lcHDXuLy[i].KhachDaTra != 0 ? lcHDXuLy[i].KhachDaTra : 0;
                            // update from BG le --> BG suachua
                            lcHDXuLy[i].ID_PhieuTiepNhan = lstHD[j].ID_PhieuTiepNhan;
                            let maPhieu = lstHD[j].MaPhieuTiepNhan; // vi maphieuTN đã bao gồm biển số
                            if (maPhieu.indexOf(lstHD[j].BienSo) > -1) {
                                maPhieu = maPhieu.split('_')[0];
                            }
                            lcHDXuLy[i].MaPhieuTiepNhan = maPhieu;
                            lcHDXuLy[i].ID_Xe = lstHD[j].ID_Xe;
                            lcHDXuLy[i].BienSo = lstHD[j].BienSo;
                            lcHDXuLy[i].ID_BaoHiem = lstHD[j].ID_BaoHiem;
                            break;
                        }
                    }
                }
            }
            localStorage.setItem(lcXuLiDonHang_Const, JSON.stringify(lcHDXuLy));
        }
    }

    function UpdateDH_RemoveAdd_TPCombo(idRandomHD) {
        var ctDatHang = localStorage.getItem(lcCTDatHang_Const);
        if (ctDatHang !== null) {
            ctDatHang = JSON.parse(ctDatHang);

            var cthd = localStorage.getItem(lcListCTHD);
            if (cthd !== null) {
                cthd = JSON.parse(cthd);
                for (let i = 0; i < cthd.length; i++) {
                    let forCT = cthd[i];
                    if (forCT.IDRandomHD === idRandomHD) {
                        for (let m = 0; m < ctDatHang.length; m++) {
                            let forDH = ctDatHang[m];
                            if (forCT.ID_DonViQuiDoi === forDH.ID_DonViQuiDoi) {
                                if (forCT.ThanhPhanComBo.length === 0) {
                                    ctDatHang[m].ThanhPhanComBo = [];
                                }
                                else {
                                    let qdCTHD = $.map(forCT.ThanhPhanComBo, function (o) {
                                        return o.ID_DonViQuiDoi;
                                    })
                                    let qdDH = $.map(forDH.ThanhPhanComBo, function (o) {
                                        return o.ID_DonViQuiDoi;
                                    });

                                    let DHnotEx_CTHD = $.grep(forDH.ThanhPhanComBo, function (o) {
                                        return $.inArray(o.ID_DonViQuiDoi, qdCTHD) === -1;
                                    });
                                    let cthd_notExDH = $.grep(forCT.ThanhPhanComBo, function (o) {
                                        return $.inArray(o.ID_DonViQuiDoi, qdDH) === -1;
                                    })

                                    let idRemove = $.map(DHnotEx_CTHD, function (o) {
                                        return o.ID_DonViQuiDoi;
                                    })
                                    ctDatHang[m].ThanhPhanComBo = $.grep(ctDatHang[m].ThanhPhanComBo, function (o) {
                                        return $.inArray(o.ID_DonViQuiDoi, idRemove) === -1;
                                    })

                                    // add if cthd not exist in cacheDH
                                    for (let k = 0; k < cthd_notExDH.length; k++) {
                                        cthd_notExDH[k].SoLuongConLai = cthd_notExDH[k].SoLuong;
                                        ctDatHang[m].ThanhPhanComBo.push(cthd_notExDH[k]);
                                    }
                                }

                                if (forCT.HangCungLoais.length === 0) {
                                    ctDatHang[m].HangCungLoais = [];
                                }
                                else {
                                    // add if not exist
                                    if (forCT.HangCungLoais.length !== forDH.HangCungLoais.length) {
                                        let arrIDRandomCTOld = $.map(forDH.HangCungLoais, function (o) {
                                            return o.IDRandom;
                                        })
                                        let arrIDRandomCTNew = $.map(forCT.HangCungLoais, function (o) {
                                            return o.IDRandom;
                                        })
                                        // add new if not exists in cache old
                                        for (let k = 0; k < forCT.HangCungLoais.length; k++) {
                                            if ($.inArray(forCT.HangCungLoais[k].IDRandom, arrIDRandomCTOld) === -1) {
                                                forCT.HangCungLoais[k].SoLuongConLai = forCT.HangCungLoais[k].SoLuong;
                                                ctDatHang[m].HangCungLoais.push(forCT.HangCungLoais[k]);
                                                arrIDRandomCTOld.push(forCT.HangCungLoais[k].IDRandom);
                                            }
                                        }

                                        // remove if not exists in cthd
                                        ctDatHang[m].HangCungLoais = $.grep(ctDatHang[m].HangCungLoais, function (o) {
                                            return $.inArray(o.IDRandom, arrIDRandomCTNew) > -1
                                                && $.inArray(o.IDRandom, arrIDRandomCTOld) > - 1;
                                        })
                                    }
                                }

                                if (forCT.QuanLyTheoLoHang) {

                                    let loCTHD = $.map(forCT.DM_LoHang, function (o) {
                                        return o.ID_LoHang;
                                    })
                                    let loDH = $.map(forDH.DM_LoHang, function (o) {
                                        return o.ID_LoHang;
                                    });

                                    let DHnotEx_CTHD = $.grep(forDH.DM_LoHang, function (o) {
                                        return $.inArray(o.ID_LoHang, loCTHD) === -1;
                                    });
                                    let cthd_notExDH = $.grep(forCT.DM_LoHang, function (o) {
                                        return $.inArray(o.ID_LoHang, loDH) === -1;
                                    })

                                    let arrIDRemove = $.map(DHnotEx_CTHD, function (o) {
                                        return o.ID_LoHang;
                                    })

                                    ctDatHang[m].DM_LoHang = $.grep(ctDatHang[m].DM_LoHang, function (o) {
                                        return $.inArray(o.ID_LoHang, arrIDRemove) === -1;
                                    })

                                    // if delete Lot parent: assign parent = lot{0}
                                    if ($.inArray(forDH.ID_LoHang, arrIDRemove) > -1 && ctDatHang[m].DM_LoHang.length > 0) {
                                        let lot0 = ctDatHang[m].DM_LoHang[0];
                                        ctDatHang[m].ID_LoHang = lot0.ID_LoHang;
                                        ctDatHang[m].MaLoHang = lot0.MaLoHang;
                                        ctDatHang[m].SoLuong = lot0.SoLuong;
                                        ctDatHang[m].SoLuongConLai = lot0.SoLuongConLai;
                                        ctDatHang[m].DonGia = lot0.DonGia;
                                        ctDatHang[m].GiaBan = lot0.GiaBan;
                                        ctDatHang[m].TienChietKhau = parseFloat(lot0.TienChietKhau);
                                        ctDatHang[m].PTChietKhau = parseFloat(lot0.PTChietKhau);
                                        ctDatHang[m].PTThue = parseFloat(lot0.PTThue);
                                        ctDatHang[m].TienThue = parseFloat(lot0.TienThue);
                                        ctDatHang[m].ThanhTien = parseFloat(lot0.ThanhTien);
                                        ctDatHang[m].ThanhToan = parseFloat(lot0.ThanhToan);
                                    }

                                    // if change all lot 
                                    if (ctDatHang[m].DM_LoHang.length === 0 && cthd_notExDH.length > 0) {
                                        let lot0 = cthd_notExDH;
                                        ctDatHang[m].ID_LoHang = lot0.ID_LoHang;
                                        ctDatHang[m].MaLoHang = lot0.MaLoHang;
                                        ctDatHang[m].SoLuong = lot0.SoLuong;
                                        ctDatHang[m].SoLuongConLai = lot0.SoLuongConLai;
                                        ctDatHang[m].DonGia = lot0.DonGia;
                                        ctDatHang[m].GiaBan = lot0.GiaBan;
                                        ctDatHang[m].TienChietKhau = parseFloat(lot0.TienChietKhau);
                                        ctDatHang[m].PTChietKhau = parseFloat(lot0.PTChietKhau);
                                        ctDatHang[m].PTThue = parseFloat(lot0.PTThue);
                                        ctDatHang[m].TienThue = parseFloat(lot0.TienThue);
                                        ctDatHang[m].ThanhTien = parseFloat(lot0.ThanhTien);
                                        ctDatHang[m].ThanhToan = parseFloat(lot0.ThanhToan);
                                    }

                                    // add if cthd not exist in cacheDH
                                    for (let k = 0; k < cthd_notExDH.length; k++) {
                                        cthd_notExDH[k].SoLuongConLai = cthd_notExDH[k].SoLuong;
                                        ctDatHang[m].DM_LoHang.push(cthd_notExDH[k]);
                                    }
                                }
                                break;
                            }
                        }
                    }
                }
            }
            localStorage.setItem(lcCTDatHang_Const, JSON.stringify(ctDatHang));
        }
    }
    self.TaoHDDatHang = function () {
        var lstHD = localStorage.getItem(lcListHD);

        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            var hdDatHangXuLy = $.grep(lstHD, function (x) {
                return x.IsChangeHDXuLy !== undefined && x.IsChangeHDXuLy === true
                    && x.IDRandom === self.HoaDons().IDRandom();
            });
            if (hdDatHangXuLy.length > 0) {
                // nếu đã tạo hóa đơn từ đơn đặt hàng
                var itemHD = $.grep(lstHD, function (item) {
                    return item.MaHoaDonTraHang === self.HoaDons().MaHoaDon() && item.StatusOffline === false && item.NguoiTao === userLogin;
                });
                if (itemHD.length === 0) {
                    dialogConfirm_OKCancel("Lưu đơn hàng", "Bạn có muốn lưu báo giá trước khi tạo hóa đơn không?", function (x1) {
                        self.saveDatHang(true);
                    }, function () {
                        $('#modalPopuplgDelete').modal('hide');
                        let idRandomHD = CreateHD_fromHDDatHang();
                        UpdateKhuyenMai_CTHD(null, idRandomHD);
                        UpdateSoThuTu_CTHD(false, idRandomHD);
                        BindHD_CTHDafterSave();
                    })
                }
                else {
                    let idRandomHD = CreateHD_fromHDDatHang();
                    UpdateKhuyenMai_CTHD(null, idRandomHD);
                    UpdateSoThuTu_CTHD(false, idRandomHD);
                    BindHD_CTHDafterSave();
                }
            }
            else {
                let idRandomHD = CreateHD_fromHDDatHang();
                UpdateKhuyenMai_CTHD(null, idRandomHD);
                UpdateSoThuTu_CTHD(false, idRandomHD);
                BindHD_CTHDafterSave();
            }
        }
        Call_6Func();
    }
    self.EndInvoice = function () {
        $('#modalpopup_endDonDH').modal('hide');
        self.StatusHD(3);
        UpdateStatudHD();
    }
    self.NotEndInvoice = function () {
        $('#modalpopup_endDonDH').modal('hide');
        self.StatusHD(2); // dang giao hang
        UpdateStatudHD();
    }
    $('#modalpopup_endDonDH').on('hidden.bs.modal', function () {
        // Nếu chưa chọn kết thúc/ hoặc không kết thúc xử lý đơn hàng, nhưng modal lại bị ẩn đi, thì update Sattus = 2 (Đang giao hàng)
        if (self.StatusHD() === undefined) {
            self.NotEndInvoice();
        }
    });
    function UpdateStatudHD() {
        if (self.ID_HoaDonUpdate() !== undefined) {
            ajaxHelper(BHHoaDonUri + 'Update_StatusHD?id=' + self.ID_HoaDonUpdate() + '&Status=' + self.StatusHD(), 'POST').done(function (data) {
                if (data === '') {
                    //ShowMessage_Success('Cập nhật hóa đơn thành công');
                }
            }).fail(function () {
                AddHDDatHang_updateStatus();
            });
        }
    }
    function GetCauHinhHeThong() {
        ajaxHelper('/api/DanhMuc/HT_ThietLapAPI/' + "GetCauHinhHeThong/" + id_DonVi, 'GET').done(function (data) {
            if (data !== null) {
                self.ThietLap(data);
                vmThanhToan.ThietLapCuaHang = [data];
                localStorage.setItem('lcHeThong', JSON.stringify(data));
                GetNhomDoiTuong_DonVi();
            }
        });
    }
    self.VisibleDatHang = ko.computed(function () {
        if (self.ThietLap() === null) {
            return false;
        }
        else {
            if (self.ThietLap().DatHang === true) {
                return true;
            }
            else {
                // if have DatHang --> show
                var lstHD = localStorage.getItem(lcListHD);
                if (lstHD !== null) {
                    lstHD = JSON.parse(lstHD);
                    var hdDatHang = $.grep(lstHD, function (item) {
                        return item.LoaiHoaDon === 3;
                    });
                    if (hdDatHang.length > 0) {
                        var maHDCache = localStorage.getItem(lcMaHD);
                        if (maHDCache !== null) {
                            var itemEX = GetHDOpening_byMaHoaDon(maHDCache, lstHD);
                            if (itemEX.length > 0) {
                                if (itemEX[0].LoaiHoaDon === 3) {
                                    return true;
                                }
                                else {
                                    return false;
                                }
                            }
                        }
                    }
                    else {
                        return false;
                    }
                }
                else {
                    return false;
                }
            }
        }
    });
    // Phieu Thu
    self.showPopupLapPhieuThu = function () {

        if (self.CongTy().length > 0) {
            vmThanhToan.inforCongTy = {
                TenCongTy: self.CongTy()[0].TenCongTy,
                DiaChiCuaHang: self.CongTy()[0].DiaChi,
                LogoCuaHang: Open24FileManager.hostUrl + self.CongTy()[0].DiaChiNganHang,
                TenChiNhanh: self.titleChinhanh,
            };
        }
        vmThanhToan.listData.arrIDDonVi = [id_DonVi];
        vmThanhToan.listData.KhoanThuChis = self.KhoanThuChis();
        vmThanhToan.listData.NhanViens = self.NhanViens();
        vmThanhToan.listData.AccountBanks = self.AllAccountBank();
        vmThanhToan.listData.ChiNhanhs = self.ChiNhanhs();
        vmHoaHongHoaDon.listData.ChietKhauHoaDons = vmThanhToanGara.listData.ChietKhauHoaDons;
        vmThanhToan.showModalThanhToan(null, 2);
    }
    self.arrTraCuuHangHoa = ko.observableArray();
    self.showPopupTraCuuHH = function () {
        $('#trahanghoamodal').modal('show');
        $('#txtTraCuuHH').val("");
        self.arrTraCuuHangHoa([]);
        self.TotalRecordTK(0);
        self.PageCountTK(0);
    }
    $('#txtTraCuuHH').keypress(function (e) {
        if (e.keyCode === 13) {
            self.currentPageTK(0);
            var search = $('#txtTraCuuHH').val();
            if (search !== null) {
                searchTheKho();
            } else {
                self.arrTraCuuHangHoa([]);
            }
        }
    })
    self.pageSizesTK = [10, 20, 30];
    self.pageSizeTK = ko.observable(self.pageSizesTK[0]);
    self.currentPageTK = ko.observable(0);
    self.fromitemtk = ko.observable(1);
    self.toitemtk = ko.observable();
    self.arrPagging = ko.observableArray();
    self.PageCountTK = ko.observable();
    self.TotalRecordTK = ko.observable(0);
    var isGoToNext = false;
    function searchTheKho(isGoToNext) {
        hidewait('table_TraCuu');
        var search = $('#txtTraCuuHH').val();
        ajaxHelper('/api/DanhMuc/DM_HangHoaAPI/' + 'TraCuuHangHoa?currentPage=' + self.currentPageTK() + '&pageSize=' + self.pageSizeTK() + '&id_donvi=' + id_DonVi + '&txtSearch=' + search, 'GET').done(function (data) {
            self.arrTraCuuHangHoa(data.data.lstHH);
            self.TotalRecordTK(data.data.Rowcount);
            self.PageCountTK(data.data.pageCount);
            $('#wait').remove();
        });
    };
    self.PageList_Display_TheKho = ko.computed(function () {
        var arrPage = [];
        var allPage = self.PageCountTK();
        var currentPage = self.currentPageTK();
        if (allPage > 4) {
            var i = 0;
            if (currentPage === 0) {
                i = parseInt(self.currentPageTK()) + 1;
            }
            else {
                i = self.currentPageTK();
            }
            if (allPage >= 5 && currentPage > allPage - 5) {
                if (currentPage >= allPage - 2) {
                    // get 5 trang cuoi cung
                    for (let i = allPage - 5; i < allPage; i++) {
                        let obj = {
                            pageNumberTK: i + 1,
                        };
                        arrPage.push(obj);
                    }
                }
                else {
                    // get currentPage - 2 , currentPage, currentPage + 2
                    if (currentPage === 1) {
                        for (let j = currentPage - 1; (j <= currentPage + 3) && j < allPage; j++) {
                            let obj = {
                                pageNumberTK: j + 1,
                            };
                            arrPage.push(obj);
                        }
                    } else {
                        for (let j = currentPage - 2; (j <= currentPage + 2) && j < allPage; j++) {
                            let obj = {
                                pageNumberTK: j + 1,
                            };
                            arrPage.push(obj);
                        }
                    }
                }
            }
            else {
                // get 5 trang dau
                if (i >= 2) {
                    while (arrPage.length < 5) {
                        let obj = {
                            pageNumberTK: i - 1,
                        };
                        arrPage.push(obj);
                        i = i + 1;
                    }
                }
                else {
                    while (arrPage.length < 5) {
                        let obj = {
                            pageNumberTK: i,
                        };
                        arrPage.push(obj);
                        i = i + 1;
                    }
                }
            }
        }
        else {
            // neu chi co 1 trang --> khong hien thi DS trang
            if (allPage > 1) {
                for (let i = 0; i < allPage; i++) {
                    let obj = {
                        pageNumberTK: i + 1,
                    };
                    arrPage.push(obj);
                }
            }
        }
        return arrPage;
    });
    self.PageResultTKs = ko.computed(function () {
        if (self.arrTraCuuHangHoa() !== null) {
            self.fromitemtk((self.currentPageTK() * self.pageSizeTK()) + 1);
            if (((self.currentPageTK() + 1) * self.pageSizeTK()) > self.arrTraCuuHangHoa().length) {
                var fromItem = (self.currentPageTK() + 1) * self.pageSizeTK();
                if (fromItem < self.TotalRecordTK()) {
                    self.toitemtk((self.currentPageTK() + 1) * self.pageSizeTK());
                }
                else {
                    self.toitemtk(self.TotalRecordTK());
                }
            } else {
                self.toitemtk((self.currentPageTK() * self.pageSizeTK()) + self.pageSizeTK());
            }
        }
    });
    self.ResetCurrentPageTheKho = function () {
        self.currentPageTK(0);
        searchTheKho();
    };
    self.VisibleStartPageTheKho = ko.computed(function () {
        if (self.PageList_Display_TheKho().length > 0) {
            return self.PageList_Display_TheKho()[0].pageNumberTK !== 1;
        }
    });
    self.VisibleEndPageTheKho = ko.computed(function () {
        if (self.PageList_Display_TheKho().length > 0) {
            return self.PageList_Display_TheKho()[self.PageList_Display_TheKho().length - 1].pageNumberTK !== self.PageCountTK();
        }
    });
    self.GoToPage = function (page) {
        if (page.pageNumberTK !== '.') {
            self.currentPageTK(page.pageNumberTK - 1);
            searchTheKho();
        }
    };
    self.GetClass = function (page) {
        return ((page.pageNumberTK - 1) === self.currentPageTK()) ? "click" : "";
    };
    self.StartPageTheKho = function () {
        self.currentPageTK(0);
        searchTheKho();
    }
    self.BackPageTheKho = function () {
        if (self.currentPageTK() > 1) {
            self.currentPageTK(self.currentPageTK() - 1);
            searchTheKho();
        }
    }
    self.GoToNextPageTheKho = function () {
        if (self.currentPageTK() < self.PageCountTK() - 1) {
            self.currentPageTK(self.currentPageTK() + 1);
            searchTheKho();
        }
    }
    self.EndPageTheKho = function () {
        if (self.currentPageTK() < self.PageCountTK() - 1) {
            self.currentPageTK(self.PageCountTK() - 1);
            searchTheKho();
        }
    }

    function CheckInput(obj) {
        var sReturn = '';
        var id = obj.ID();
        var maDT = obj.MaDoiTuong();
        var tenDT = obj.TenDoiTuong();
        var date1 = obj.NgaySinh_NgayTLap();
        var date2 = moment(new Date()).format('YYYY-MM-DD');
        var email = obj.Email();
        var phone = obj.DienThoai();
        var idTinhThanh = obj.ID_TinhThanh();
        var idQuanHuyen = obj.ID_QuanHuyen();
        var idNguoiGioiThieu = obj.ID_NguoiGioiThieu();
        var idNguoiQuanLy = obj.ID_NhanVienPhuTrach();
        if (tenDT === null || tenDT === "" || tenDT === undefined) {
            sReturn = 'Bạn chưa nhập tên khách hàng <br />';
        }
        // check MaDoiTuong contain char special
        if (CheckChar_Special(maDT)) {
            sReturn += 'Mã khách hàng không được chứa kí tự đặc biệt <br />';
        }
        if (email !== '' && email !== undefined && email !== null) {
            //var re = /^(([^<>()[\]\\.,;:\s@#ẮẰẲẴẶĂẤẦẨẪẬÂÁÀÃẢẠĐẾỀỂỄỆÊÉÈẺẼẸÍÌỈĨỊỐỒỔỖỘÔỚỜỞỠỢƠÓÒÕỎỌỨỪỬỮỰƯÚÙỦŨỤÝỲỶỸỴ\"]+(\.[^<>()[\]\\.,;:\s@#ẮẰẲẴẶĂẤẦẨẪẬÂÁÀÃẢẠĐẾỀỂỄỆÊÉÈẺẼẸÍÌỈĨỊỐỒỔỖỘÔỚỜỞỠỢƠÓÒÕỎỌỨỪỬỮỰƯÚÙỦŨỤÝỲỶỸỴ\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/i;
            var re = /^(([^<>()[\]\\.,;:\s@#ẮẰẲẴẶĂẤẦẨẪẬÂÁÀÃẢẠĐẾỀỂỄỆÊÉÈẺẼẸÍÌỈĨỊỐỒỔỖỘÔỚỜỞỠỢƠÓÒÕỎỌỨỪỬỮỰƯÚÙỦŨỤÝỲỶỸỴ"]+(\.[^<>()[\]\\.,;:\s@#ẮẰẲẴẶĂẤẦẨẪẬÂÁÀÃẢẠĐẾỀỂỄỆÊÉÈẺẼẸÍÌỈĨỊỐỒỔỖỘÔỚỜỞỠỢƠÓÒÕỎỌỨỪỬỮỰƯÚÙỦŨỤÝỲỶỸỴ"]+)*)|(".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/i;
            var valReturn = re.test(email);
            if (valReturn === false) {
                sReturn += 'Email không hợp lệ <br />';
            }
        }
        if (Is_undefined_empty_GuidEmpty(idTinhThanh) === false) {
            var itemTT = $.grep(self.TinhThanhs(), function (item) {
                return item.ID === idTinhThanh;
            });
            if (itemTT.length === 0) {
                sReturn += 'Tỉnh thành không tồn tại trong hệ thống <br />';
            }
        }
        if (Is_undefined_empty_GuidEmpty(idQuanHuyen) === false) {
            var itemQH = $.grep(self.QuanHuyens(), function (item) {
                return item.ID === idQuanHuyen;
            });
            if (itemQH.length === 0) {
                sReturn += 'Quận huyện không tồn tại trong hệ thống <br />';
            }
        }

        if (Is_undefined_empty_GuidEmpty(idNguoiQuanLy) === false) {
            var itemNV = $.grep(self.NhanViens(), function (item) {
                return item.ID === idNguoiQuanLy;
            });
            if (itemNV.length === 0) {
                sReturn += 'Người quản lý không tồn tại trong hệ thống <br />';
            }
        }
        return sReturn;
    }
    // Khuyen mai
    function GetKM_CTKhuyenMai() {
        ajaxHelper('/api/DanhMuc/BH_KhuyenMaiAPI/' + 'GetKM_CTKhuyenMai?idDonVi=' + id_DonVi, 'GET').done(function (data) {
            if (data !== null) {
                self.DMKhuyenMai(data);
                WriteData_Dexie(db.DM_KhuyenMai, data);
            }
        });
    }
    function Check_KhuyenMaiNhom() {
        var itemKM = $.grep(self.ListKM_ofHangHoa(), function (x) {
            return x.ID_KhuyenMai === self.ID_KhuyenMai();
        });
        if (itemKM.length > 0 && self.CTHD_ChosingKM().ID_NhomHangHoa !== null) {
            for (let i = 0; i < itemKM[0].DM_KhuyenMai_ChiTiet.length; i++) {
                var ctKM = itemKM[0].DM_KhuyenMai_ChiTiet[i];
                var arrChilds = GetAll_IDNhomChild_ofNhomHH(ctKM.ID_NhomHangHoaMua);
                tree2.uncheckAll();
                if ($.inArray(self.CTHD_ChosingKM().ID_NhomHangHoa, arrChilds) > -1) {
                    // if KM Nhom --> return object
                    return {
                        ID_KhuyenMai: itemKM[0].ID_KhuyenMai,
                        ID_ChiTietKM: ctKM.ID,
                        ID_NhomHHMua: ctKM.ID_NhomHangHoaMua,
                        ID_NhomHHTang: ctKM.ID_NhomHangHoa,
                        SoLuongTang: ctKM.SoLuong,
                        SoLuongMua: ctKM.SoLuongMua,
                        //GiaKhuyenMai: ctKM.GiaKhuyenMai,
                        GiamGiaTheoPhanTram: ctKM.GiamGiaTheoPhanTram,
                        GiamGia: ctKM.GiamGia,
                    };
                }
            }
        }
        // else return false
        return false;
    }

    function ChekKhuyenMai_ByIDQuiDoi() {
        var itemKM = $.grep(self.ListKM_ofHangHoa(), function (x) {
            return x.ID_KhuyenMai === self.ID_KhuyenMai();
        });
        var idQuyDoi = self.CTHD_ChosingKM().ID_DonViQuiDoi;
        if (itemKM.length > 0 && !commonStatisJs.CheckNull(idQuyDoi)) {
            // sum soluongmua by idnhom
            var cthd = localStorage.getItem(lcListCTHD);
            if (cthd !== null) {
                cthd = JSON.parse(cthd);

                var arrCT_sameQD = $.grep(cthd, function (x) {
                    return x.IDRandomHD === self.CTHD_ChosingKM().IDRandomHD
                        && x.ID_DonViQuiDoi === idQuyDoi;
                })

                var sortDESC = itemKM[0].DM_KhuyenMai_ChiTiet.sort(function (a, b) {
                    let x = a.SoLuongMua,
                        y = b.SoLuongMua;
                    return x < y ? 1 : x > y ? -1 : 0;
                });

                if (arrCT_sameQD.length > 0) {
                    for (let i = 0; i < sortDESC.length; i++) {
                        let ctKM = sortDESC[i];
                        if (ctKM.ID_DonViQuiDoiMua === idQuyDoi) {
                            // tong soluong theo idQuiDoi
                            let sumSLMua = 0;
                            for (let i = 0; i < arrCT_sameQD.length; i++) {
                                let itFor = arrCT_sameQD[i];
                                sumSLMua += parseInt(itFor.SoLuong);
                                for (let j = 1; j < itFor.DM_LoHang.length; j++) {
                                    sumSLMua += parseInt(itFor.DM_LoHang[j].SoLuong);
                                }
                                for (let j = 0; j < itFor.HangCungLoais.length; j++) {
                                    sumSLMua += parseInt(itFor.HangCungLoais[j].SoLuong);
                                }
                            }

                            if (sumSLMua >= ctKM.SoLuongMua) {
                                // if KM Nhom --> return object
                                return {
                                    ID_KhuyenMai: itemKM[0].ID_KhuyenMai,
                                    ID_ChiTietKM: ctKM.ID,
                                    ID_NhomHHMua: ctKM.ID_NhomHangHoaMua,
                                    ID_NhomHHTang: ctKM.ID_NhomHangHoa,
                                    SoLuongTang: ctKM.SoLuong,
                                    SoLuongMua: ctKM.SoLuongMua,
                                    GiaKhuyenMai: ctKM.GiaKhuyenMai,
                                    GiamGiaTheoPhanTram: ctKM.GiamGiaTheoPhanTram,
                                    GiamGia: ctKM.GiamGia,
                                    SoLuongMuaThucTe: sumSLMua,
                                };
                            }
                        }
                    }
                }
            }
        }
        return false;
    }
    // use check KhuyenMai HangHoa: - Tang Hang/Giam Gia Hang/Gia Ban Theo SL Mua
    function GetSum_SoLuongHang_SameGroup(idQuiDoi) {
        var slMua = 0;
        var arrIDQuiDoi = [];
        var cthd = localStorage.getItem(lcListCTHD);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            var itemKM = $.grep(self.ListKM_ofHangHoa(), function (x) {
                return x.ID_KhuyenMai === self.ID_KhuyenMai();
            });
            if (itemKM.length > 0) {
                var isKMNhom = Check_KhuyenMaiNhom();
                if (isKMNhom !== false) {
                    // find in CT Khuyen Mai with ID_Nhom was return from Check_KhuyenMaiNhom
                    var arrChilds = GetAll_IDNhomChild_ofNhomHH(isKMNhom.ID_NhomHHMua);
                    tree2.uncheckAll();
                    for (let j = 0; j < cthd.length; j++) {
                        if (cthd[j].IDRandomHD === self.CTHD_ChosingKM().IDRandomHD) {
                            if ($.inArray(cthd[j].ID_NhomHangHoa, arrChilds) > -1) {
                                slMua += parseFloat(cthd[j].SoLuong);
                                // sum LoHang
                                for (let k = 1; k < cthd[j].DM_LoHang.length; k++) {
                                    slMua += parseFloat(cthd[j].DM_LoHang[k].SoLuong);
                                }
                                for (let k = 0; k < cthd[j].HangCungLoais.length; k++) {
                                    slMua += parseFloat(cthd[j].HangCungLoais[k].SoLuong);
                                }
                            }
                        }
                    }
                    // get all HangHoa thuoc Nhom
                    var arrHH_byNhom = $.grep(self.HangHoaAll(), function (x) {
                        return $.inArray(x.ID_NhomHangHoa, arrChilds) > -1;
                    });
                    // get all ID_QuiDoi from lst Hang Hoa above
                    for (let i = 0; i < arrHH_byNhom.length; i++) {
                        arrIDQuiDoi.push(arrHH_byNhom[i].ID_DonViQuiDoi);
                    }
                }
                else {
                    // when GetListKM_ofHangHoa, get IDQuiDoi using pass
                    if (idQuiDoi === null) {
                        idQuiDoi = self.CTHD_ChosingKM().ID_DonViQuiDoi;
                    }
                    arrIDQuiDoi = [idQuiDoi];
                    for (let j = 0; j < cthd.length; j++) {
                        if (cthd[j].IDRandomHD === self.CTHD_ChosingKM().IDRandomHD) {
                            if (cthd[j].ID_DonViQuiDoi === idQuiDoi) {
                                slMua = parseFloat(cthd[j].SoLuong);
                                // sum LoHang
                                for (let k = 1; k < cthd[j].DM_LoHang.length; k++) {
                                    slMua += parseFloat(cthd[j].DM_LoHang[k].SoLuong);
                                }
                                for (let k = 0; k < cthd[j].HangCungLoais.length; k++) {
                                    slMua += parseFloat(cthd[j].HangCungLoais[k].SoLuong);
                                }
                            }
                        }
                    }
                }
                var ctDoiTuong = self.ChiTietDoiTuong();
                if (ctDoiTuong !== null && ctDoiTuong.length > 0) {
                    var itemKH_HH = $.grep(self.KhachHang_HangHoa(), function (x) {
                        return x.ID_DoiTuong === ctDoiTuong[0].ID;
                    });
                    if (itemKH_HH.length > 0) {
                        for (let i = 0; i < itemKH_HH[0].List_SoLuongMua.length; i++) {
                            if ($.inArray(itemKH_HH[0].List_SoLuongMua[i].ID_DonViQuiDoi, arrIDQuiDoi) > -1) {
                                slMua += parseFloat(itemKH_HH[0].List_SoLuongMua[i].SoLuong);
                            }
                        }
                    }
                }
            }
        }
        return slMua;
    }
    // use at func GetListKM_ofHangHoa, updateKhuyenMai_CTHD
    function CheckKhuyenMaiKH_bySumSoLuongMua(idQuiDoi, soluongMuaMoi, soluongKhuyenMai, isKMNhom, idNhomMua) {
        var soLuongDaMua = soluongMuaMoi;
        var ctDoiTuong = self.ChiTietDoiTuong();
        if (ctDoiTuong !== null && ctDoiTuong.length > 0) {
            var arrIDQuiDoi = [];
            var itemKH_HH = self.KhachHang_HangHoa().filter(x => x.ID_DoiTuong === ctDoiTuong[0].ID);
            // khuyen mai theo nhom
            if (isKMNhom) {
                // get all Nhom (contains Nhom Childs)
                var arrNhomHHChilds = GetAll_IDNhomChild_ofNhomHH(idNhomMua);
                tree2.uncheckAll();
                // get all HangHoa thuoc Nhom
                var arrHH_byNhom = $.grep(self.HangHoaAll(), function (x) {
                    return $.inArray(x.ID_NhomHangHoa, arrNhomHHChilds) > -1;
                });
                // get all ID_QuiDoi from lst Hang Hoa above
                for (let i = 0; i < arrHH_byNhom.length; i++) {
                    arrIDQuiDoi.push(arrHH_byNhom[i].ID_DonViQuiDoi);
                }
            }
            else {
                arrIDQuiDoi.push(idQuiDoi);
            }
            // sum SoLuong da mua by Nhom/ID_quidoi
            if (itemKH_HH.length > 0) {
                for (let i = 0; i < itemKH_HH[0].List_SoLuongMua.length; i++) {
                    if ($.inArray(itemKH_HH[0].List_SoLuongMua[i].ID_DonViQuiDoi, arrIDQuiDoi) > -1) {
                        soLuongDaMua += parseFloat(itemKH_HH[0].List_SoLuongMua[i].SoLuong);
                    }
                }
            }
        }
        return soLuongDaMua >= soluongKhuyenMai;
    }
    // get list KM enough condition (fiter from list DMKhuyenMai)
    function GetList_KMApDung() {
        for (let i = 0; i < self.DMKhuyenMai().length; i++) {
            var itemKM = self.DMKhuyenMai()[i];
            var objKhuyenMai = {
                ID_KhuyenMai: null,
                TenKhuyenMai: "",
                HinhThuc: "", // 21: Mua hang giam hang; 22: mua hang tang hang; 23: mua hang tang diem; 24: gia ban theo SL Mua
                HinhThucKhuyenMai: "",
                Months: [],
                Dates: [],
                Hours: [],
                Days: [],
                ApDungNgaySinh: 0,
                ID_QuyDoiMuas: [],
                ID_QuyDoiTangs: [],
                ID_NhomHHMuas: [],
                ID_NhomHHTangs: [],
                ID_NhomKHs: [],
                ID_NhanViens: [],
                DM_KhuyenMai_ChiTiet: [],
                Note_HinhThuc: '', // ghi chu tuong ung voi tung loai hinh thuc KM
            };
            objKhuyenMai.ID_KhuyenMai = itemKM.ID;
            objKhuyenMai.TenKhuyenMai = itemKM.TenKhuyenMai;
            objKhuyenMai.HinhThucKhuyenMai = itemKM.TenHinhThucKM;
            objKhuyenMai.HinhThuc = itemKM.HinhThuc;
            objKhuyenMai.ApDungNgaySinh = itemKM.ApDungNgaySinhNhat;
            if (itemKM.ThangApDung !== '') {
                objKhuyenMai.Months = itemKM.ThangApDung.split('_');
            }
            if (itemKM.NgayApDung !== '') {
                objKhuyenMai.Dates = itemKM.NgayApDung.split('_');
            }
            if (itemKM.ThuApDung !== '') {
                objKhuyenMai.Days = itemKM.ThuApDung.split('_');
            }
            if (itemKM.GioApDung !== '') {
                objKhuyenMai.Hours = itemKM.GioApDung.split('_');
            }
            for (let j = 0; j < itemKM.DM_KhuyenMai_ApDung.length; j++) {
                var itemKM_AD = itemKM.DM_KhuyenMai_ApDung[j];
                if (itemKM_AD.ID_NhomKhachHang !== null && $.inArray(itemKM_AD.ID_NhomKhachHang, objKhuyenMai.ID_NhomKHs) === -1) {
                    objKhuyenMai.ID_NhomKHs.push(itemKM_AD.ID_NhomKhachHang);
                }
                if (itemKM_AD.ID_NhanVien !== null && $.inArray(itemKM_AD.ID_NhanVien, objKhuyenMai.ID_NhanViens) === -1) {
                    objKhuyenMai.ID_NhanViens.push(itemKM_AD.ID_NhanVien);
                }
            }
            for (let j = 0; j < itemKM.DM_KhuyenMai_ChiTiet.length; j++) {
                var itemKMCT = itemKM.DM_KhuyenMai_ChiTiet[j];
                if (itemKMCT.ID_DonViQuiDoiMua !== null && $.inArray(itemKMCT.ID_DonViQuiDoiMua, objKhuyenMai.ID_QuyDoiMuas) === -1) {
                    objKhuyenMai.ID_QuyDoiMuas.push(itemKMCT.ID_DonViQuiDoiMua);
                }
                if (itemKMCT.ID_DonViQuiDoi !== null && $.inArray(itemKMCT.ID_DonViQuiDoi, objKhuyenMai.ID_QuyDoiTangs) === -1) {
                    objKhuyenMai.ID_QuyDoiTangs.push(itemKMCT.ID_DonViQuiDoi);
                }
                if (itemKMCT.ID_NhomHangHoa !== null) {
                    var arrNhomChildTang = GetAll_IDNhomChild_ofNhomHH(itemKMCT.ID_NhomHangHoa);
                    tree2.uncheckAll();
                    if (arrNhomChildTang.length > 0) {
                        for (let k = 0; k < arrNhomChildTang.length; k++) {
                            if ($.inArray(arrNhomChildTang[k], objKhuyenMai.ID_NhomHHTangs) === -1) {
                                objKhuyenMai.ID_NhomHHTangs.push(arrNhomChildTang[k]);
                            }
                        }
                    }
                }
                if (itemKMCT.ID_NhomHangHoaMua !== null) {
                    var arrNhomChildMua = GetAll_IDNhomChild_ofNhomHH(itemKMCT.ID_NhomHangHoaMua);
                    tree2.uncheckAll();
                    if (arrNhomChildMua.length > 0) {
                        for (let k = 0; k < arrNhomChildMua.length; k++) {
                            if ($.inArray(arrNhomChildMua[k], objKhuyenMai.ID_NhomHHMuas) === -1) {
                                objKhuyenMai.ID_NhomHHMuas.push(arrNhomChildMua[k]);
                            }
                        }
                    }
                }
            }
            // sort to do check SoLuongMua tương ứng với GiaKhuyenMai
            itemKM.DM_KhuyenMai_ChiTiet = itemKM.DM_KhuyenMai_ChiTiet.sort(function (a, b) {
                var x = a.SoLuongMua,
                    y = b.SoLuongMua;
                return x < y ? -1 : x > y ? 1 : 0;
            });
            objKhuyenMai.DM_KhuyenMai_ChiTiet = itemKM.DM_KhuyenMai_ChiTiet;
            self.KM_KMApDung.push(objKhuyenMai);
        }
        // remove KMai tang diem if HeThong khong cai dat tinh nang tich diem
        if (self.ThietLap().TinhNangTichDiem === false) {
            var listKM = $.grep(self.KM_KMApDung(), function (x) {
                return x.HinhThuc !== 14 && x.HinhThuc !== 23;
            });
            self.KM_KMApDung(listKM);
        }
    }
    function UpdateKhuyenMai_CTHD(idQDoi, idRandomHD) {
        var dtNow = new Date();
        var _month = (dtNow.getMonth() + 1).toString(); // 1-12 (+1 because getMoth() return 0-11)
        var _date = (dtNow.getDate()).toString(); // 1- 31
        var _hours = (dtNow.getHours()).toString(); // 1-24
        var _day = (dtNow.getDay() + 1).toString(); // mon:2, tues:3, wed:4, thur:5, fri:6, sat: 7, sun: 8
        var _weekofMonth = Math.ceil(dtNow.getDate() / 7); // get week of Month ( 1- 5);
        // get list Km enough condition
        GetList_KMApDung();
        var idNhanVien = self.selectedNVien();
        var idNhomKH = null;
        var ngaysinhFull = 0;
        var ngaysinh = 0;
        var thangsinh = 0;
        var tuansinh = 0;
        var arrNhomKH = [];
        var ctDoiTuong = self.ChiTietDoiTuong();
        // if chose KH --> get idNhomKH + ngaysinh
        if (ctDoiTuong !== null && ctDoiTuong.length > 0) {
            idNhomKH = ctDoiTuong[0].ID_NhomDoiTuong.toLowerCase();
            arrNhomKH = idNhomKH.split(', ');
            ngaysinhFull = ctDoiTuong[0].NgaySinh_NgayTLap;
        }
        if (ngaysinhFull !== 0 && ngaysinhFull !== null) {
            var dtNgaySinh = new Date(moment(ngaysinhFull).format('YYYY-MM-DD')); // must format 'YYYY-MM-DD'
            // get day, moth from dayFull
            ngaysinh = dtNgaySinh.getDate();
            thangsinh = (dtNgaySinh.getMonth() + 1).toString();
            tuansinh = Math.ceil(dtNgaySinh.getDate() / 7);
        }
        // get list KM by ID_DoiTuong and ID_NhanVien
        var arrKM_forDT = [];
        for (let i = 0; i < self.KM_KMApDung().length; i++) {
            // get KM apply for HangHoa
            var xItem = self.KM_KMApDung()[i];
            if (xItem.HinhThuc.toString().startsWith('2')) {
                if (xItem.ApDungNgaySinh !== 0) {
                    // if chose KH
                    if (ctDoiTuong !== null && ctDoiTuong.length > 0) {
                        // check ID_NhanVien, ID_nhomKH
                        if ((xItem.Months.length === 0 || $.inArray(_month, xItem.Months) > -1)
                            && (xItem.Dates.length === 0 || $.inArray(_date, xItem.Dates) > -1)
                            && (xItem.Days.length === 0 || $.inArray(_day, xItem.Days) > -1)
                            && (xItem.Hours.length === 0 || $.inArray(_hours, xItem.Hours) > -1)
                            && (xItem.ID_NhanViens.length === 0 || $.inArray(idNhanVien, xItem.ID_NhanViens) > -1)
                            && (xItem.ID_NhomKHs.length === 0 || xItem.ID_NhomKHs.some(r => arrNhomKH.indexOf(r) >= 0))) {
                            switch (xItem.ApDungNgaySinh) {
                                case 1: // ap dung ngay sinh theo ngay
                                    if (ngaysinh.toString() === _date) {
                                        arrKM_forDT.push(xItem);
                                    }
                                    break;
                                case 2: // ap dung ngay sinh theo tuan
                                    if (tuansinh.toString() === _weekofMonth) {
                                        arrKM_forDT.push(xItem);
                                    }
                                    break;
                                case 3: // ap dung ngay sinh theo thang
                                    if (thangsinh.toString() === _month) {
                                        arrKM_forDT.push(xItem);// esc for KM_KMApDung
                                    }
                                    break;
                            }
                        }
                    }
                }
                else {
                    // if ApDungNgaySinh = 0
                    if ((xItem.Months.length === 0 || $.inArray(_month, xItem.Months) > -1)
                        && (xItem.Dates.length === 0 || $.inArray(_date, xItem.Dates) > -1)
                        && (xItem.Days.length === 0 || $.inArray(_day, xItem.Days) > -1)
                        && (xItem.Hours.length === 0 || $.inArray(_hours, xItem.Hours) > -1)
                        && (xItem.ID_NhanViens.length === 0 || $.inArray(idNhanVien, xItem.ID_NhanViens) > -1)
                        && (xItem.ID_NhomKHs.length === 0 || xItem.ID_NhomKHs.some(r => arrNhomKH.indexOf(r) >= 0))) {
                        arrKM_forDT.push(xItem);
                    }
                }
            }
        }
        for (let i = 0; i < arrKM_forDT.length; i++) {
            arrKM_forDT[i].DM_KhuyenMai_ChiTiet.sort(function (a, b) {
                // order by ASC
                var x = a.SoLuongMua, y = b.SoLuongMua;
                return x > y ? 1 : x < y ? -1 : 0;
            });
        }
        var lcCTHD = localStorage.getItem(lcListCTHD);
        if (lcCTHD !== null) {
            lcCTHD = JSON.parse(lcCTHD);
            // reset IsKhuyenMai for CTHD with _maHoaDon before check KhuyenMai when document is readly
            for (let i = 0; i < lcCTHD.length; i++) {
                if (lcCTHD[i].LoaiHoaDon !== 6 && lcCTHD[i].IDRandomHD === idRandomHD) {
                    if (initLoad === true) {
                        lcCTHD[i].IsKhuyenMai = false;
                    }
                }
            }
            // reset IsKhuyenMai for CTHD with _maHoaDon before check KhuyenMai
            for (let i = 0; i < lcCTHD.length; i++) {
                if (lcCTHD[i].LoaiHoaDon !== 6 && lcCTHD[i].IDRandomHD === idRandomHD) {
                    if (initLoad === true) {
                        lcCTHD[i].IsKhuyenMai = false;
                    }
                }
            }
            if (self.ThietLap().KhuyenMai === true) {
                for (let i = 0; i < lcCTHD.length; i++) {
                    // KM Hoadon/GoiDV
                    if ((lcCTHD[i].LoaiHoaDon === 1 || lcCTHD[i].LoaiHoaDon === 19)
                        && lcCTHD[i].IDRandomHD === idRandomHD) {
                        for (let j = 0; j < arrKM_forDT.length; j++) {
                            var itemAD = arrKM_forDT[j];
                            for (let k = 0; k < itemAD.DM_KhuyenMai_ChiTiet.length; k++) {
                                var itemCT = itemAD.DM_KhuyenMai_ChiTiet[k];
                                var arrNhomChilds = GetAll_IDNhomChild_ofNhomHH(itemCT.ID_NhomHangHoaMua);
                                tree2.uncheckAll();
                                // if ID_QuiDoi in ID_QuyDoiMuas OR in NhomHHMua
                                if ($.inArray(lcCTHD[i].ID_DonViQuiDoi, itemAD.ID_QuyDoiMuas) > -1
                                    || $.inArray(lcCTHD[i].ID_NhomHangHoa, arrNhomChilds) > -1) {
                                    if ($.inArray(lcCTHD[i].ID_DonViQuiDoi, itemAD.ID_QuyDoiMuas) > -1) {
                                        // if same ID_QuiDoiMua
                                        if (lcCTHD[i].ID_DonViQuiDoi === itemCT.ID_DonViQuiDoiMua) {
                                            let slMuaLoHang = parseFloat(lcCTHD[i].SoLuong);
                                            for (let l = 1; l < lcCTHD[i].DM_LoHang.length; l++) {
                                                slMuaLoHang += parseFloat(lcCTHD[i].DM_LoHang[l].SoLuong);
                                            }
                                            for (let l = 0; l < lcCTHD[i].HangCungLoais.length; l++) {
                                                slMuaLoHang += parseFloat(lcCTHD[i].HangCungLoais[l].SoLuong);
                                            }
                                            // have KM if enough SoLuongMua
                                            var enoughSumSL = CheckKhuyenMaiKH_bySumSoLuongMua(lcCTHD[i].ID_DonViQuiDoi, slMuaLoHang, itemCT.SoLuongMua, false, null);
                                            if (enoughSumSL) {
                                                lcCTHD[i].IsKhuyenMai = true;
                                                break;
                                            }
                                        }
                                    }// end if by ID_QuiDoi
                                    else {
                                        if ($.inArray(lcCTHD[i].ID_NhomHangHoa, arrNhomChilds) > -1) {
                                            let slMua = parseFloat(itemCT.SoLuongMua);
                                            let slMua_ofNhom = 0;
                                            // get all HH in CTHD same MaHoaDon + ID_NhomHH
                                            for (let m = 0; m < lcCTHD.length; m++) {
                                                if (lcCTHD[m].IDRandomHD === idRandomHD && $.inArray(lcCTHD[m].ID_NhomHangHoa, arrNhomChilds) > -1) {
                                                    slMua_ofNhom += parseFloat(lcCTHD[m].SoLuong);
                                                    // sum SoLuong in LoHang
                                                    for (let l = 1; l < lcCTHD[m].DM_LoHang.length; l++) {
                                                        slMua_ofNhom += parseFloat(lcCTHD[m].DM_LoHang[l].SoLuong);
                                                    }
                                                    for (let l = 0; l < lcCTHD[m].HangCungLoais.length; l++) {
                                                        slMua_ofNhom += parseFloat(lcCTHD[m].HangCungLoais[l].SoLuong);
                                                    }
                                                }
                                            }
                                            // if exists 1 HangHoa in NhomHH had KhuyenMai -> not set IsKhuyenMai = true for other HangHoas in same ID_nhomHH
                                            var hh_inNhomHH = $.grep(lcCTHD, function (xx) {
                                                return xx.IDRandomHD === idRandomHD && $.inArray(xx.ID_NhomHangHoa, arrNhomChilds) > -1;
                                            });
                                            // if SoThuTu of HH in NhomHH = max -> set IsKhuyenMai = true
                                            var max = Math.max.apply(Math, hh_inNhomHH.map(function (item) {
                                                return item.SoThuTu;
                                            }));
                                            var enoughSumSLNhom = CheckKhuyenMaiKH_bySumSoLuongMua(lcCTHD[i].ID_DonViQuiDoi, slMua_ofNhom, slMua, true, itemCT.ID_NhomHangHoaMua);
                                            if (enoughSumSLNhom) {
                                                if (lcCTHD[i].ID_DonViQuiDoi === idQDoi) {
                                                    // assign IsKhuyenMai = false for all HangHoa in Nhom
                                                    for (let m = 0; m < lcCTHD.length; m++) {
                                                        if (lcCTHD[m].IDRandomHD === idRandomHD && $.inArray(lcCTHD[m].ID_NhomHangHoa, arrNhomChilds) > -1) {
                                                            lcCTHD[m].IsKhuyenMai = false;
                                                        }
                                                    }
                                                    // assign IsKhuyenMai for itself is chosing
                                                    lcCTHD[i].IsKhuyenMai = true;
                                                    break;
                                                }
                                                else {
                                                    // assign IsKhuyenMai for HangHoa in Nhom have SoThuTu =max
                                                    if (lcCTHD[i].SoThuTu === max) {
                                                        lcCTHD[i].IsKhuyenMai = true;
                                                        break;
                                                    }
                                                }
                                            }
                                        }
                                    }// else by Nhom
                                } // end check by Nhom or ID_QuiDoi
                            }// enf for Dm_KhuyenMai_ChiTiet
                        } // end for self.KM_ApDung
                    } // end check CTHD with maHoaDon
                }// end for CTHD
            } // end check ThietLap().KhuyenMai === true
            localStorage.setItem(lcListCTHD, JSON.stringify(lcCTHD));
            // caculator TongTienHang (because not yet update TongTienHang in cache lstHD)
            var _sum = 0;
            for (let i = 0; i < lcCTHD.length; i++) {
                if (lcCTHD[i].IDRandomHD === idRandomHD) {
                    _sum += lcCTHD[i].ThanhTien;
                    for (let j = 1; j < lcCTHD[i].DM_LoHang.length; j++) {
                        _sum += lcCTHD[i].DM_LoHang[j].ThanhTien;
                    }
                    for (let j = 0; j < lcCTHD[i].HangCungLoais.length; j++) {
                        _sum += lcCTHD[i].HangCungLoais[j].ThanhTien;
                    }
                }
            }
            // Update KhuyenMai for HoaDon
            if (self.ThietLap().KhuyenMai === true) {
                var lstHD = localStorage.getItem(lcListHD);
                if (lstHD !== null) {
                    lstHD = JSON.parse(lstHD);
                    for (let i = 0; i < lstHD.length; i++) {
                        if ((lstHD[i].LoaiHoaDon === 1 || lstHD[i].LoaiHoaDon === 19) && lstHD[i].IDRandom === idRandomHD) {
                            // assign again IsKhuyenMai = false (because xoa/tang/giam soluong --> change TongTienHang)
                            lstHD[i].IsKhuyenMaiHD = false;
                            for (let j = 0; j < self.KM_KMApDung().length; j++) {
                                // get KM apply for HoaDon
                                var itemKM2 = self.KM_KMApDung()[j];
                                if (itemKM2.HinhThuc.toString().startsWith('1')) {
                                    for (let k = 0; k < itemKM2.DM_KhuyenMai_ChiTiet.length; k++) {
                                        if (itemKM2.DM_KhuyenMai_ChiTiet[k].TongTienHang <= _sum) {
                                            // check ThoiGian + PhamVi Ap dung
                                            if (itemKM2.ApDungNgaySinh !== 0) {
                                                // if chose KH
                                                if (ctDoiTuong !== null && ctDoiTuong.length > 0) {
                                                    if ((itemKM2.Months.length === 0 || $.inArray(_month, itemKM2.Months) > -1)
                                                        && (itemKM2.Dates.length === 0 || $.inArray(_date, itemKM2.Dates) > -1)
                                                        && (itemKM2.Days.length === 0 || $.inArray(_day, itemKM2.Days) > -1)
                                                        && (itemKM2.Hours.length === 0 || $.inArray(_hours, itemKM2.Hours) > -1)
                                                        && (itemKM2.ID_NhanViens.length === 0 || $.inArray(idNhanVien, itemKM2.ID_NhanViens) > -1)
                                                        && (itemKM2.ID_NhomKHs.length === 0 || itemKM2.ID_NhomKHs.some(r => arrNhomKH.indexOf(r) >= 0))) {
                                                        switch (itemKM2.ApDungNgaySinh) {
                                                            case 1: // ap dung ngay sinh theo ngay
                                                                if (ngaysinh.toString() === _date) {
                                                                    lstHD[i].IsKhuyenMaiHD = true;
                                                                    break;
                                                                }
                                                                break;
                                                            case 2: // ap dung ngay sinh theo tuan
                                                                if (tuansinh.toString() === _weekofMonth) {
                                                                    lstHD[i].IsKhuyenMaiHD = true;
                                                                    break;
                                                                }
                                                                break;
                                                            case 3: // ap dung ngay sinh theo thang
                                                                if (thangsinh.toString() === _month) {
                                                                    lstHD[i].IsKhuyenMaiHD = true;
                                                                    break;
                                                                }
                                                                break;
                                                        }
                                                    }
                                                }
                                                else {
                                                    // if not chose KH
                                                    lstHD[i].IsKhuyenMaiHD = false;
                                                    break;
                                                }
                                            }
                                            else {
                                                // if ApDungNgaySinh = 0
                                                if ((itemKM2.Months.length === 0 || $.inArray(_month, itemKM2.Months) > -1)
                                                    && (itemKM2.Dates.length === 0 || $.inArray(_date, itemKM2.Dates) > -1)
                                                    && (itemKM2.Days.length === 0 || $.inArray(_day, itemKM2.Days) > -1)
                                                    && (itemKM2.Hours.length === 0 || $.inArray(_hours, itemKM2.Hours) > -1)
                                                    && (itemKM2.ID_NhanViens.length === 0 || $.inArray(idNhanVien, itemKM2.ID_NhanViens) > -1)
                                                    && (itemKM2.ID_NhomKHs.length === 0 || xItem.ID_NhomKHs.some(r => arrNhomKH.indexOf(r) >= 0))) {
                                                    lstHD[i].IsKhuyenMaiHD = true;
                                                    break;
                                                }
                                            }
                                        }
                                    } // end for KM_ChiTiet
                                    // if IsKhuyenMaiHD =true --> ESC for loop, else -> continue
                                    if (lstHD[i].IsKhuyenMaiHD) {
                                        break;
                                    }
                                }
                            }// end for Km_ApDung
                            break;
                        }// end check _maHoaDon
                    }// end for lstHD
                    localStorage.setItem(lcListHD, JSON.stringify(lstHD));
                }
            }
        }
    }
    self.CTHD_ChosingKM = ko.observableArray(); // used to assign IDRandomHD for HangTang (todo ) -- thay the cho self.ID_DonViQuiDoiMua, ID_NhomHHMua
    self.GetListKM_ofHangHoa = function (item) {
        var ctDoing = FindCTHD_isDoing(item, false);
        self.CTHD_ChosingKM(ctDoing);
        var idNhomHHMua = item.ID_NhomHangHoa;
        // if HD offline --> don't show modal KMai (because DHO, THO not have KMai)
        if (item.MaHoaDon.indexOf('HDO') > -1) {
            return;
        }
        $('#titleKhuyenMai').text('Khuyến mại trên ' + item.MaHangHoa + ' ' + item.TenHangHoa);
        self.ID_DonViQuiDoiMua(item.ID_DonViQuiDoi); // get to set ID_HHTang.subcrible
        self.ID_NhomHHMua(idNhomHHMua); // get to find list HangHoaTang from ID_NhomHHTang self.CTHD_ChosingKM().ID_DonViQuiDoi
        $('#promotiont').modal('show');
        // reset self.ListKM_ofHangHoa
        self.ListKM_ofHangHoa([]);
        var dtNow = new Date();
        var _month = (dtNow.getMonth() + 1).toString(); // 1-12 (+1 because getMoth() return 0-11)
        var _date = (dtNow.getDate()).toString(); // 1- 31
        var _hours = (dtNow.getHours()).toString(); // 1-24
        var _day = (dtNow.getDay() + 1).toString(); // mon:2, tues:3, wed:4, thur:5, fri:6, sat: 7, sun: 8
        var _weekofMonth = Math.ceil(dtNow.getDate() / 7); // get week of Month ( 1- 5);
        if (self.KM_KMApDung().length === 0) {
            GetList_KMApDung();
        }
        var ctDoiTuong = self.ChiTietDoiTuong();
        var itemKH_HH = [];
        var idDoiTuong = null;
        if (ctDoiTuong !== null && ctDoiTuong.length > 0) {
            idDoiTuong = ctDoiTuong[0].ID;
            itemKH_HH = self.KhachHang_HangHoa().filter(x => x.ID_DoiTuong === ctDoiTuong[0].ID);
        }
        var cthd = localStorage.getItem(lcListCTHD);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            var idRandomHD = item.IDRandomHD;
            // get soluongMua (sau khi tang/giam/sua soluong)
            var objSoLuong = $('#munber_' + item.IDRandom);
            // neu khong tich diem cho Hang giam gia --> chi lay hang khong co giam gia
            var tichDiemHangSale = CheckKM_TichDiem_forHangGiamGia();
            for (let i = 0; i < self.KM_KMApDung().length; i++) {
                var itemKM = self.KM_KMApDung()[i];
                if (itemKM.HinhThuc.toString().startsWith('2')) {
                    for (let j = 0; j < itemKM.DM_KhuyenMai_ChiTiet.length; j++) {
                        // mỗi lần for: phải reset lại sumSoLuong
                        var sumByNhom = 0;
                        var sumNhom_CongDiem = 0;// so luong hang thuc te duoc cong diem
                        var itemCT = itemKM.DM_KhuyenMai_ChiTiet[j];
                        var arrNhomChilds = GetAll_IDNhomChild_ofNhomHH(itemCT.ID_NhomHangHoaMua);
                        tree2.uncheckAll();
                        if (idNhomHHMua !== null && $.inArray(idNhomHHMua, arrNhomChilds) > -1) {
                            for (let k = 0; k < cthd.length; k++) {
                                if (cthd[k].IDRandomHD === idRandomHD) {
                                    // caculator sum SoLuong in Nhom
                                    if ($.inArray(cthd[k].ID_NhomHangHoa, arrNhomChilds) > -1) {
                                        sumByNhom += parseFloat(cthd[k].SoLuong);
                                        for (let m = 1; m < cthd[k].DM_LoHang.length; m++) {
                                            sumByNhom += parseFloat(cthd[k].DM_LoHang[m].SoLuong);
                                        }
                                        for (let m = 0; m < cthd[k].HangCungLoais.length; m++) {
                                            sumByNhom += parseFloat(cthd[k].HangCungLoais[m].SoLuong);
                                        }
                                        // so luong hang thuc te duoc cong diem
                                        if (!tichDiemHangSale) {
                                            if (cthd[k].TienChietKhau === 0) {
                                                sumNhom_CongDiem += parseFloat(cthd[k].SoLuong);
                                                for (let m = 1; m < cthd[k].DM_LoHang.length; m++) {
                                                    if (cthd[k].DM_LoHang[m].TienChietKhau === 0) {
                                                        sumNhom_CongDiem += parseFloat(cthd[k].DM_LoHang[m].SoLuong);
                                                    }
                                                }
                                                for (let m = 0; m < cthd[k].HangCungLoais.length; m++) {
                                                    if (cthd[k].HangCungLoais[m].TienChietKhau === 0) {
                                                        sumNhom_CongDiem += parseFloat(cthd[k].HangCungLoais[m].SoLuong);
                                                    }
                                                }
                                            }
                                        }
                                        else {
                                            sumNhom_CongDiem = sumByNhom;
                                        }
                                    }
                                }
                            }
                            // cong soluong voi nhung hang da mua truoc do
                            if (idDoiTuong !== null && itemKH_HH.length > 0) {
                                var arrIDQuiDoi2 = [];
                                var arrHH_byNhom = $.grep(self.HangHoaAll(), function (x) {
                                    return $.inArray(x.ID_NhomHangHoa, arrNhomChilds) > -1;
                                });
                                // get all ID_QuiDoi from lst Hang Hoa above
                                for (let k = 0; k < arrHH_byNhom.length; k++) {
                                    arrIDQuiDoi2.push(arrHH_byNhom[k].ID_DonViQuiDoi);
                                }
                                for (let k = 0; k < itemKH_HH[0].List_SoLuongMua.length; k++) {
                                    if ($.inArray(itemKH_HH[0].List_SoLuongMua[k].ID_DonViQuiDoi, arrIDQuiDoi2) > -1) {
                                        sumByNhom += parseFloat(itemKH_HH[0].List_SoLuongMua[k].SoLuong);
                                    }
                                }
                            }
                            var enoughSoLuong = CheckKhuyenMaiKH_bySumSoLuongMua(item.ID_DonViQuiDoi, sumByNhom, itemCT.SoLuongMua, true, itemCT.ID_NhomHangHoaMua);
                            // Nếu chưa đủ số lượng mua so với SoLuongMua trong ChiTietKhuyenMai (Giá bán theo SL mua) -> không push
                            if (enoughSoLuong) {
                                itemKM.HangHoaChoseTangs = [];
                                if (itemKM.HinhThuc === 24 || itemKM.HinhThuc === 23) {
                                    if (sumByNhom >= itemCT.SoLuongMua) {
                                        // update NoteHinhThuc
                                        if (itemKM.HinhThuc === 24) {
                                            if (itemCT.GiamGia !== null) {
                                                if (itemCT.GiamGiaTheoPhanTram) {
                                                    itemKM.Note_HinhThuc = 'Mua '.concat(itemCT.SoLuongMua, ' giảm giá ', itemCT.GiamGia, ' % mỗi sản phẩm');
                                                }
                                                else {
                                                    itemKM.Note_HinhThuc = 'Mua '.concat(itemCT.SoLuongMua, ' giảm giá ', formatNumber3Digit(itemCT.GiamGia), ' đ mỗi sản phẩm');
                                                }
                                            }
                                            else {
                                                itemKM.Note_HinhThuc = 'Mua ' + itemCT.SoLuongMua + ' giá ' + formatNumber3Digit(itemCT.GiaKhuyenMai);
                                            }
                                        }
                                        else {
                                            // diem: save in column GiamGia
                                            if (itemCT.GiamGiaTheoPhanTram) {
                                                itemKM.Note_HinhThuc = 'Tặng ' + formatNumber3Digit(itemCT.GiamGia) + " % điểm";
                                            }
                                            else {
                                                var diemCong = Math.floor(sumNhom_CongDiem / itemCT.SoLuongMua);
                                                itemKM.Note_HinhThuc = 'Tặng ' + formatNumber3Digit(itemCT.GiamGia * diemCong) + " điểm";
                                            }
                                        }
                                        self.ListKM_ofHangHoa.push(itemKM);
                                    }
                                }
                                else {
                                    self.ListKM_ofHangHoa.push(itemKM);
                                }
                            }
                        }
                        else {
                            // reset soluongMua
                            var sumSLQuiDoi = formatNumberToFloat(objSoLuong.val());
                            var sumNhom_CongDiem2 = 0;// so luong hang thuc te duoc cong diem
                            // check ID_QuiDoi Mua
                            if (itemCT.ID_DonViQuiDoiMua === item.ID_DonViQuiDoi) {
                                for (let k = 0; k < cthd.length; k++) {
                                    if (cthd[k].IDRandomHD === idRandomHD
                                        && cthd[k].ID_DonViQuiDoi === item.ID_DonViQuiDoi) {
                                        // tinh so luong hang thu te duoc cong diem
                                        if (!tichDiemHangSale) {
                                            if (cthd[k].TienChietKhau === 0) {
                                                sumNhom_CongDiem2 = sumSLQuiDoi;
                                            }
                                        }
                                        else {
                                            sumNhom_CongDiem2 = sumSLQuiDoi;
                                        }
                                        // cong so luong bao gom soluong of Lo
                                        for (let l = 1; l < cthd[k].DM_LoHang.length; l++) {
                                            sumSLQuiDoi += parseFloat(cthd[k].DM_LoHang[l].SoLuong);
                                            // tinh soluong Lohang duoc cong diem
                                            if (!tichDiemHangSale && cthd[k].DM_LoHang[l].TienChietKhau === 0) {
                                                sumNhom_CongDiem2 += parseFloat(cthd[k].DM_LoHang[l].SoLuong);
                                            }
                                        }
                                        // cong so luong bao gom soluong of Lo
                                        for (let l = 1; l < cthd[k].HangCungLoais.length; l++) {
                                            sumSLQuiDoi += parseFloat(cthd[k].HangCungLoais[l].SoLuong);
                                            // tinh soluong Lohang duoc cong diem
                                            if (!tichDiemHangSale && cthd[k].HangCungLoais[l].TienChietKhau === 0) {
                                                sumNhom_CongDiem2 += parseFloat(cthd[k].HangCungLoais[l].SoLuong);
                                            }
                                        }
                                        break;
                                    }
                                }
                                // cong soluong voi nhung hang da mua truoc do
                                if (idDoiTuong !== null && itemKH_HH.length > 0) {
                                    for (let k = 0; k < itemKH_HH[0].List_SoLuongMua.length; k++) {
                                        if (itemKH_HH[0].List_SoLuongMua[k].ID_DonViQuiDoi === item.ID_DonViQuiDoi) {
                                            sumSLQuiDoi += parseFloat(itemKH_HH[0].List_SoLuongMua[k].SoLuong);
                                            break;// because only 1 --> so break
                                        }
                                    }
                                }
                                var enoughSoLuong2 = CheckKhuyenMaiKH_bySumSoLuongMua(item.ID_DonViQuiDoi, sumSLQuiDoi, itemCT.SoLuongMua, false, null);
                                // Nếu chưa đủ số lượng mua so với SoLuongMua trong ChiTietKhuyenMai (Giá bán theo SL mua) -> không push
                                if (enoughSoLuong2) {
                                    itemKM.HangHoaChoseTangs = [];
                                    if (itemKM.HinhThuc === 24 || itemKM.HinhThuc === 23) {
                                        if (sumSLQuiDoi >= itemCT.SoLuongMua) {
                                            // update NoteHinhThuc
                                            if (itemKM.HinhThuc === 24) {
                                                if (itemCT.GiamGia !== null) {
                                                    if (itemCT.GiamGiaTheoPhanTram) {
                                                        itemKM.Note_HinhThuc = 'Mua '.concat(itemCT.SoLuongMua, ' giảm giá ', itemCT.GiamGia, ' % mỗi sản phẩm');
                                                    }
                                                    else {
                                                        itemKM.Note_HinhThuc = 'Mua '.concat(itemCT.SoLuongMua, ' giảm giá ', formatNumber3Digit(itemCT.GiamGia), ' đ mỗi sản phẩm');
                                                    }
                                                }
                                                else {
                                                    itemKM.Note_HinhThuc = 'Mua ' + itemCT.SoLuongMua + ' giá ' + formatNumber3Digit(itemCT.GiaKhuyenMai);
                                                }
                                            }
                                            else {
                                                // diem: save in column GiamGia
                                                if (itemCT.GiamGiaTheoPhanTram) {
                                                    itemKM.Note_HinhThuc = 'Tặng ' + formatNumber3Digit(itemCT.GiamGia) + " % điểm";
                                                }
                                                else {
                                                    var diemCong2 = Math.floor(sumNhom_CongDiem2 / itemCT.SoLuongMua);
                                                    itemKM.Note_HinhThuc = 'Tặng ' + formatNumber3Digit(diemCong2 * itemCT.GiamGia) + " điểm";
                                                }
                                            }
                                            self.ListKM_ofHangHoa.push(itemKM);
                                        }
                                    }
                                    else {
                                        self.ListKM_ofHangHoa.push(itemKM);
                                    }
                                }
                            }
                        }
                    }
                }
            }
            // remove KM if douple (because push from DM_KhuyenMaiChiTiet)
            var arrUnique = $.unique(self.ListKM_ofHangHoa().sort());
            self.ListKM_ofHangHoa(arrUnique);
            var arrKhuyenMai = [];
            for (let i = 0; i < cthd.length; i++) {
                if (cthd[i].IDRandomHD === idRandomHD && cthd[i].ID_DonViQuiDoi === item.ID_DonViQuiDoi) {
                    // if HangHoa da chon KM -> load list HangTang in popup
                    if (cthd[i].ID_KhuyenMai !== null && cthd[i].ID_KhuyenMai !== undefined) {
                        self.HH_KhuyenMai(cthd[i].ID_KhuyenMai);
                        arrKhuyenMai = cthd[i].HangHoa_KM;
                    }
                }
            }
            // assign HH Khuyen Mai for self.ListKM_ofHangHoa
            if (self.HH_KhuyenMai() !== undefined) {
                for (let i = 0; i < self.ListKM_ofHangHoa().length; i++) {
                    if (self.ListKM_ofHangHoa()[i].ID_KhuyenMai === self.HH_KhuyenMai()) {
                        self.ListKM_ofHangHoa()[i].HangHoaChoseTangs = arrKhuyenMai;
                        break;
                    }
                }
            }
        }
        self.HHTang_AfterRender(self.ListKM_ofHangHoa());
        self.ListKM_ofHangHoa([]);
        for (let i = 0; i < self.HHTang_AfterRender().length; i++) {
            self.ListKM_ofHangHoa.push(self.HHTang_AfterRender()[i]);
        }
    }
    self.LoadHangHoaTang = function (item) {
        self.ID_KhuyenMai(item.ID_KhuyenMai); // assign to do add HangHoa
        var itemKM = $.grep(self.DMKhuyenMai(), function (km) {
            return km.ID === item.ID_KhuyenMai;
        });
        self.HinhThucKM(itemKM[0].HinhThuc);
        var isKMNhom = Check_KhuyenMaiNhom();
        // get IDNhomHHTang by ID_NhomHHMua
        var idNhomHHTang = [];
        var arrHHTang = [];
        var arrChildsNhomTang = [];
        if (isKMNhom !== false) {
            for (let i = 0; i < itemKM[0].DM_KhuyenMai_ChiTiet.length; i++) {
                let itemCTKM = itemKM[0].DM_KhuyenMai_ChiTiet[i];
                if (itemCTKM.ID === isKMNhom.ID_ChiTietKM) {
                    idNhomHHTang.push(itemCTKM.ID_NhomHangHoa);
                    idNhomHHTang.push(itemCTKM.ID_DonViQuiDoi);
                    self.SoLuongMua(itemCTKM.SoLuongMua);// assign SLTang, SLMua to do check Add HHTang
                    self.SoLuongTang(itemCTKM.SoLuong);
                    self.IsTangTheoNhom(true);
                    self.GiamGiaKM(itemCTKM.GiamGia);
                    self.GiamGiaTheoPhanTram(itemCTKM.GiamGiaTheoPhanTram);
                    // get Nhom Childs Tang
                    arrChildsNhomTang = GetAll_IDNhomChild_ofNhomHH(itemCTKM.ID_NhomHangHoa);
                    tree2.uncheckAll();
                    // nếu nhóm được hưởng đồng thời 2 khuyến mại trong cùng 1 chương trình KM --> load all hàng thuộc nhóm
                    // (VD: Mua 2 hàng nhóm A, được KM hàng nhóm B, hoặc nhóm C )
                    let other = $.grep(itemKM[0].DM_KhuyenMai_ChiTiet, function (x) {
                        return x.ID !== itemCTKM.ID && x.ID_NhomHangHoaMua === itemCTKM.ID_NhomHangHoaMua;
                    });
                    if (other.length > 0) {
                        for (let j = 0; j < other.length; j++) {
                            let arrIDNhom = GetAll_IDNhomChild_ofNhomHH(other[j].ID_NhomHangHoa);
                            tree2.uncheckAll();
                            for (let k = 0; k < arrIDNhom.length; k++) {
                                arrChildsNhomTang.push(arrIDNhom[k]);
                            }
                        }
                    }
                    break;
                }
            }
            // get lst HangHoa in NhomHHTang
            arrHHTang = $.grep(self.HangHoaAll(), function (x) {
                return ($.inArray(x.ID_DonViQuiDoi.toLowerCase(), idNhomHHTang) > -1) ||
                    (x.ID_NhomHangHoa !== null && $.inArray(x.ID_NhomHangHoa, arrChildsNhomTang) > -1);
            });
        }
        if (arrHHTang.length === 0) {
            // get lst HHTang by ID_QuiDoiMua
            var arrID_QuiDoiTang = [];
            var itemKMCT = [];
            for (let i = 0; i < itemKM[0].DM_KhuyenMai_ChiTiet.length; i++) {
                if (itemKM[0].DM_KhuyenMai_ChiTiet[i].ID_DonViQuiDoiMua === self.CTHD_ChosingKM().ID_DonViQuiDoi) {
                    itemKMCT = itemKM[0].DM_KhuyenMai_ChiTiet[i];
                    // get ID_QuiDoi tang + ID_NhomHH Tang
                    arrID_QuiDoiTang.push(itemKMCT.ID_DonViQuiDoi);
                    arrID_QuiDoiTang.push(itemKMCT.ID_NhomHangHoa);
                    arrChildsNhomTang = GetAll_IDNhomChild_ofNhomHH(itemKMCT.ID_NhomHangHoa);
                    tree2.uncheckAll();
                }
            }
            // remove item null in arrID_QuiDoiTang
            arrID_QuiDoiTang = $.grep(arrID_QuiDoiTang, function (x) {
                return x !== null;
            });
            // get all Hang Hoa with ID_QuiDoi OR ID_NhomHH
            arrHHTang = $.grep(self.HangHoaAll(), function (itemHH) {
                return $.inArray(itemHH.ID_DonViQuiDoi.toLowerCase(), arrID_QuiDoiTang) > -1 ||
                    (itemHH.ID_NhomHangHoa !== null && $.inArray(itemHH.ID_NhomHangHoa, arrChildsNhomTang) > -1);
            });
            self.SoLuongTang(itemKMCT.SoLuong);// assign SLTang to do check Add HHTang
            self.SoLuongMua(itemKMCT.SoLuongMua);
            self.GiamGiaKM(itemKMCT.GiamGia);
            self.GiamGiaTheoPhanTram(itemKMCT.GiamGiaTheoPhanTram);
            self.IsTangTheoNhom(false);
        }
        // add ID_Random for HangTang --> get ID_LoHang for HangKM (save DB)
        for (let i = 0; i < arrHHTang.length; i++) {
            var rd = Math.floor(Math.random() * 100000000 + 1);
            arrHHTang[i].KM_IDRandom = 'KM_IDRandom' + rd;
        }
        self.HangHoaTangs(arrHHTang);
    }
    self.fiterHHTang = function (item, inputString) {
        var itemSearch = locdau(item.TenHangHoa);
        var itemSearch2 = locdau(item.MaHangHoa);
        var locdauInput = locdau(inputString);
        var arr = itemSearch.split(/\s+/);
        var sThreechars = '';
        var i = 0;
        var lengthArr = arr.length;
        for (i; i < lengthArr; i++) {
            sThreechars += arr[i].toString().split('')[0];
        }
        var ss = itemSearch.indexOf(locdauInput) > -1 || itemSearch2.indexOf(locdauInput) > -1 ||
            sThreechars.indexOf(locdauInput) > -1;
        return ss;
    }
    self.ID_HHTang.subscribe(function (newID) {
        if (newID !== undefined) {
            var idKhuyenMai = self.ID_KhuyenMai();
            var itemHH = $.grep(self.HangHoaTangs(), function (item) {
                return item.KM_IDRandom === newID;
            });
            self.ID_HHTang(undefined);
            if (itemHH.length > 0) {
                $(function () {
                    // find all input with id start  'txtAuto' and not id ='txtAuto_'+ idKhuyenMai;
                    $('input[id^=txtAuto_]').not('#txtAuto_' + idKhuyenMai).val('');
                });
                var tienChietKhau = 0;
                var ptChietKhau = 0;
                var giaBan = 0;
                // caculator TienChietKhau,GiaBan by HinhThucKM
                switch (self.HinhThucKM()) {
                    case 21: // mua hang giamgia hang
                        if (self.GiamGiaTheoPhanTram()) {
                            tienChietKhau =self.GiamGiaKM() * itemHH[0].GiaBan / 100;
                            ptChietKhau = self.GiamGiaKM();
                        }
                        else {
                            tienChietKhau = self.GiamGiaKM();
                            ptChietKhau = 0;
                        }
                        break;
                    case 22: // mua hang tang hang
                        tienChietKhau = itemHH[0].GiaBan;
                        ptChietKhau = 0;
                        break;
                    case 24:
                        loaiKM_note = ' giá ';
                        break;
                }
                giaBan = itemHH[0].GiaBan - tienChietKhau;
                var quanLyTheoLo = itemHH[0].QuanLyTheoLoHang;
                quanLyTheoLo = (quanLyTheoLo === undefined || quanLyTheoLo === null ? false : quanLyTheoLo);
                var giaVon = itemHH[0].GiaVon;
                var laHangHoa = itemHH[0].LaHangHoa;
                if (!laHangHoa) {
                    giaVon = 0;
                }
                var objHH = {
                    SoThuTu: 1,
                    ID_KhuyenMai: null, // not set ID_KhuyenMai for HangTang of HangHoa
                    MaHangHoa: itemHH[0].MaHangHoa,
                    TenHangHoa: itemHH[0].TenHangHoa,
                    ID_HangHoa: itemHH[0].ID,
                    ThuocTinh_GiaTri: itemHH[0].ThuocTinh_GiaTri,
                    SoLuong: 1,
                    GiaBan: itemHH[0].GiaBan, // keep price old, only change tienchietkhau
                    DonGia: itemHH[0].GiaBan,
                    GiaVon: giaVon,
                    TienChietKhau: tienChietKhau, // Tang hang --> GiamGia = GiaBan
                    PTChietKhau: ptChietKhau, // giam gia: %
                    ThanhTien: giaBan,
                    TonKho: itemHH[0].TonKho,
                    ID_DonViQuiDoi: itemHH[0].ID_DonViQuiDoi,
                    ID_LoHang: itemHH[0].ID_LoHang, // assign ID_LoHang KM --> caculator TonKho by LoHang
                    QuanLyTheoLoHang: quanLyTheoLo,
                    TenDonViTinh: itemHH[0].TenDonViTinh,
                    ID_TangKem: self.CTHD_ChosingKM().ID_DonViQuiDoi,
                    TangKem: true,
                    GhiChu: '',
                    IDRandomHD: self.CTHD_ChosingKM().IDRandomHD,
                    ThanhToan: giaBan,
                    PTThue: 0,
                    TienThue: 0,
                    GhiChu_NVThucHien: '',
                    GhiChu_NVTuVan: '',
                    GhiChu_NVThucHienPrint: '',
                    GhiChu_NVTuVanPrint: '',
                    ThanhPhan_DinhLuong: [],
                    BH_NhanVienThucHien: [],
                    ThanhPhanComBo: [],
                    HangCungLoais: [],
                    HoaHongTruocChietKhau: 0,
                }
                var sumSL_inCTHD = GetSum_SoLuongHang_SameGroup(null);
                // tinh SLTang phu hop voi HH da mua
                // số lượng tặng: tùy thuộc vào ID_Nhom/ID_QuiDoi của hàng tặng đang chọn (todo - KM tặng hàng)
                var sluongTang_PhuHop = (sumSL_inCTHD / self.SoLuongMua()) * self.SoLuongTang();
                //console.log('sumSL_inCTHD ', sumSL_inCTHD, 'sltang', self.SoLuongMua(), 'slMua ', self.SoLuongTang(), 'ph ', sluongTang_PhuHop);
                // caculator sum Soluong in HHTang
                var sumSL = 0;
                for (let i = 0; i < self.ListKM_ofHangHoa().length; i++) {
                    let itemKM = self.ListKM_ofHangHoa()[i];
                    if (itemKM.ID_KhuyenMai === idKhuyenMai) {
                        for (let j = 0; j < itemKM.HangHoaChoseTangs.length; j++) {
                            var itemHHTang = itemKM.HangHoaChoseTangs[j];
                            sumSL += itemHHTang.SoLuong;
                        }
                    }
                }
                if (sumSL < sluongTang_PhuHop) {
                    // find ListKM_ofHangHoa with ID_KhuyenMai && add objHH --> HangHoaChoseTangs
                    for (let i = 0; i < self.ListKM_ofHangHoa().length; i++) {
                        let itemKM = self.ListKM_ofHangHoa()[i];
                        if (itemKM.ID_KhuyenMai === idKhuyenMai) {
                            let sluongOld = 0;
                            for (let j = 0; j < itemKM.HangHoaChoseTangs.length; j++) {
                                if (itemKM.HangHoaChoseTangs[j].ID_DonViQuiDoi === newID) {
                                    sluongOld = itemKM.HangHoaChoseTangs[j].SoLuong;
                                    // xoa old
                                    self.ListKM_ofHangHoa()[i].HangHoaChoseTangs.splice(j, 1);
                                    break;
                                }
                            }
                            // add new
                            objHH.SoLuong = parseFloat(sluongOld) + 1;
                            objHH.ThanhTien = objHH.SoLuong * giaBan;
                            objHH.ThanhToan = objHH.ThanhTien;
                            self.ListKM_ofHangHoa()[i].HangHoaChoseTangs.unshift(objHH);
                            break;
                        }
                    }
                }
                else {
                    ShowMessage_Danger('Quá số lượng hàng tặng');
                    return;
                }
                // assign ListKM_ofHangHoa =[] , after push again
                self.HHTang_AfterRender(self.ListKM_ofHangHoa());
                self.ListKM_ofHangHoa([]);
                for (let i = 0; i < self.HHTang_AfterRender().length; i++) {
                    self.ListKM_ofHangHoa.push(self.HHTang_AfterRender()[i]);
                }
            }
        }
    });
    self.ChoseKhuyenMai = function (item) {
        self.HH_KhuyenMai(item.ID_KhuyenMai);
        self.ID_KhuyenMai(item.ID_KhuyenMai);
    }
    self.AddKhuyenMai_forHangHoa = function () {
        if (self.HH_KhuyenMai() === undefined) {
            ShowMessage_Danger('Vui lòng chọn chương trình khuyến mại');
            return;
        }
        else {
            var itemKM = $.grep(self.ListKM_ofHangHoa(), function (x) {
                return x.ID_KhuyenMai === self.HH_KhuyenMai();
            });
            if (itemKM.length > 0) {
                switch (itemKM[0].HinhThuc) {
                    case 21:
                    case 22:
                        if (itemKM[0].HangHoaChoseTangs.length === 0) {
                            ShowMessage_Danger('Vui lòng chọn hàng khuyến mại');
                            return;
                        }
                        break;
                    case 23:// tangdiem
                        if (self.ChiTietDoiTuong() === null || (self.ChiTietDoiTuong() && self.ChiTietDoiTuong().length === 0)) {
                            ShowMessage_Danger('Vui lòng chọn khách hàng áp dụng');
                            return;
                        }
                        break;
                }
                // check ID_QuiDoiMua {KM theo nhom/ KM theo ID_QuiDoi}
                var slCanMua = 0;
                var slTang = 0;
                var isTangNhom = false;
                var giaKhuyenMai = 0;
                // use with HinhThuc = 23
                var diemCong = 0;
                var congPTramDiem = true;
                var checkTangNhom = Check_KhuyenMaiNhom();
                if (checkTangNhom === false) {
                    isTangNhom = false;
                    var kmQD = ChekKhuyenMai_ByIDQuiDoi();
                    if (kmQD !== false) {
                        slCanMua = kmQD.SoLuongMua;
                        slTang = kmQD.SoLuongTang;
                        giaKhuyenMai = kmQD.GiaKhuyenMai;
                        diemCong = kmQD.GiamGia;
                        congPTramDiem = kmQD.GiamGiaTheoPhanTram;
                    }
                }
                else {
                    isTangNhom = true;
                    slCanMua = checkTangNhom.SoLuongMua;
                    slTang = checkTangNhom.SoLuongTang;
                    giaKhuyenMai = checkTangNhom.GiaKhuyenMai;
                    diemCong = checkTangNhom.GiamGia;
                    congPTramDiem = checkTangNhom.GiamGiaTheoPhanTram;
                }
                var idRandomHD = GetIDRandomHD_byMaHoaDon(_maHoaDon);
                var loaiKM_note = '';

                switch (itemKM[0].HinhThuc) {
                    case 21:
                        if (self.GiamGiaTheoPhanTram()) {
                            loaiKM_note = ' giảm giá ' + self.GiamGiaKM() + '% cho ';
                        }
                        else {
                            loaiKM_note = ' giảm giá ' + self.GiamGiaKM() + ' cho '; // GG theo VND
                        }
                        break;
                    case 22:
                        loaiKM_note = ' tặng ';
                        break;
                    case 23:
                        var soluongMua_Now = 0;
                        // neu khong tich diem cho Hang giam gia --> chi lay hang khong co giam gia
                        var tichDiemHangSale = CheckKM_TichDiem_forHangGiamGia();
                        // Neu đủ số lượng, vẫn áp dụng KM
                        var cthd_23 = localStorage.getItem(lcListCTHD);
                        if (cthd_23 !== null) {
                            cthd_23 = JSON.parse(cthd_23);
                            // get CTHD by IDRandomHD
                            cthd_23 = $.grep(cthd_23, function (x) {
                                return x.IDRandomHD === idRandomHD;
                            });
                            if (isTangNhom) {
                                let arrChilds = GetAll_IDNhomChild_ofNhomHH(checkTangNhom.ID_NhomHHMua);
                                tree2.uncheckAll();
                                // get all cthd with IDNhom thuoc  arrChilds
                                let ctByNhom = $.grep(cthd_23, function (x) {
                                    return $.inArray(x.ID_NhomHangHoa, arrChilds) > -1;
                                });
                                // count soluongmua
                                if (!tichDiemHangSale) {
                                    for (let i = 0; i < ctByNhom.length; i++) {
                                        if (ctByNhom[i].TienChietKhau === 0) {
                                            soluongMua_Now += parseFloat(ctByNhom[i].SoLuong);
                                        }
                                        for (let k = 1; k < ctByNhom[i].DM_LoHang.length; k++) {
                                            if (ctByNhom[i].DM_LoHang[k].TienChietKhau === 0) {
                                                soluongMua_Now += parseFloat(ctByNhom[i].DM_LoHang[k].SoLuong);
                                            }
                                        }
                                        for (let k = 0; k < ctByNhom[i].HangCungLoais.length; k++) {
                                            if (ctByNhom[i].HangCungLoais[k].TienChietKhau === 0) {
                                                soluongMua_Now += parseFloat(ctByNhom[i].HangCungLoais[k].SoLuong);
                                            }
                                        }
                                    }
                                }
                                else {
                                    for (let i = 0; i < ctByNhom.length; i++) {
                                        soluongMua_Now += parseFloat(ctByNhom[i].SoLuong);
                                        for (let k = 1; k < ctByNhom[i].DM_LoHang.length; k++) {
                                            soluongMua_Now += parseFloat(ctByNhom[i].DM_LoHang[k].SoLuong);
                                        }
                                        for (let k = 0; k < ctByNhom[i].HangCungLoais.length; k++) {
                                            soluongMua_Now += parseFloat(ctByNhom[i].HangCungLoais[k].SoLuong);
                                        }
                                    }
                                }
                            }
                            else {
                                for (let j = 0; j < itemKM[0].DM_KhuyenMai_ChiTiet.length; j++) {
                                    let itemCTKM = itemKM[0].DM_KhuyenMai_ChiTiet[j];
                                    // DM_KhuyenMai_ChiTiet had order by SoLuongMua ASC --> get item first if conditional = true
                                    for (let i = 0; i < cthd_23.length; i++) {
                                        if (itemCTKM.ID_DonViQuiDoiMua === cthd_23[i].ID_DonViQuiDoi) {
                                            if (!tichDiemHangSale) {
                                                if (cthd_23[i].TienChietKhau === 0) {
                                                    soluongMua_Now = parseFloat(cthd_23[i].SoLuong);
                                                }
                                                // cong so luong in DM_Lo
                                                for (let k = 1; k < cthd_23[i].DM_LoHang.length; k++) {
                                                    if (cthd_23[i].DM_LoHang[k].TienChietKhau === 0) {
                                                        soluongMua_Now += parseFloat(cthd_23[i].DM_LoHang[k].SoLuong);
                                                    }
                                                }
                                                for (let k = 0; k < cthd_23[i].HangCungLoais.length; k++) {
                                                    if (cthd_23[i].HangCungLoais[k].TienChietKhau === 0) {
                                                        soluongMua_Now += parseFloat(cthd_23[i].HangCungLoais[k].SoLuong);
                                                    }
                                                }
                                            }
                                            else {
                                                soluongMua_Now = parseFloat(cthd_23[i].SoLuong);
                                                // cong so luong in DM_Lo
                                                for (let k = 1; k < cthd_23[i].DM_LoHang.length; k++) {
                                                    soluongMua_Now += parseFloat(cthd_23[i].DM_LoHang[k].SoLuong);
                                                }
                                                for (let k = 0; k < cthd_23[i].HangCungLoais.length; k++) {
                                                    soluongMua_Now += parseFloat(cthd_23[i].HangCungLoais[k].SoLuong);
                                                }
                                            }
                                            break;
                                        }
                                    }
                                }
                            }
                            if (congPTramDiem) {
                                loaiKM_note = ' tặng ' + diemCong + '% điểm ';
                            }
                            else {
                                // nhân theo Soluong Mua (chi tinh Soluong tai thoi diem mua hien tai)
                                diemCong = Math.floor(diemCong * Math.floor(soluongMua_Now / slCanMua));
                                loaiKM_note = ' tặng ' + diemCong + ' điểm ';
                            }
                        }
                        break;
                    case 24:
                        if (!commonStatisJs.CheckNull(diemCong)) {
                            if (congPTramDiem) {
                                loaiKM_note = ' giảm giá ' + diemCong + '% cho mỗi sản phẩm';
                            }
                            else {
                                loaiKM_note = ' giảm giá ' + diemCong + ' cho mỗi sản phẩm';
                            }
                        }
                        else {
                            loaiKM_note = ' giá ' + formatNumber3Digit(giaKhuyenMai) + ' mỗi sản phẩm';
                        }
                        break;
                }
                // remove item in HangHoaChoseTangs with SoLuong = 0 if list Hang Tang > 1
                var itemHHTang = itemKM[0].HangHoaChoseTangs;
                if (itemHHTang.length > 1) {
                    itemHHTang = $.grep(itemHHTang, function (x) {
                        return parseFloat(x.SoLuong) > 0;
                    })
                }
                // caculator SLTang cho phep, SLMua in CTHD
                var sumSL_inCTHD = GetSum_SoLuongHang_SameGroup(null);
                var spMua_note = '';
                var sumTT_Diem = 0;
                var cthd = JSON.parse(localStorage.getItem(lcListCTHD));
                if (isTangNhom === true) {
                    var arrNhomChild = GetAll_IDNhomChild_ofNhomHH(checkTangNhom.ID_NhomHHMua);
                    tree2.uncheckAll();
                    // Kmai theo Nhom
                    for (let i = 0; i < cthd.length; i++) {
                        let itemCTHD = cthd[i];
                        // sum Soluong all HangHoa by ID_NhomHHTang
                        let sluongByIDQuiDoi = 0;
                        var sumThanhTien = 0;
                        if (itemCTHD.IDRandomHD === idRandomHD && $.inArray(itemCTHD.ID_NhomHangHoa, arrNhomChild) > -1) {
                            sluongByIDQuiDoi = parseInt(itemCTHD.SoLuong);
                            // sum Hang in LoHang
                            for (let j = 1; j < itemCTHD.DM_LoHang.length; j++) {
                                sluongByIDQuiDoi += parseInt(itemCTHD.DM_LoHang[j].SoLuong); // sum by IDQuiDoi --> assign SoLuong in Note KhuyenMai
                                sumThanhTien += parseInt(itemCTHD.DM_LoHang[j].ThanhTien);
                            }
                            for (let j = 0; j < itemCTHD.HangCungLoais.length; j++) {
                                sluongByIDQuiDoi += parseInt(itemCTHD.HangCungLoais[j].SoLuong);
                                sumThanhTien += parseInt(itemCTHD.HangCungLoais[j].ThanhTien);
                            }
                            // Neu HH tang theo nhom -> get SoLuong, MaHH all HH in NhomHH -> save loaiKM_note
                            spMua_note += sluongByIDQuiDoi + ' ' + itemCTHD.MaHangHoa + ', ';
                            // get ThanhTien of HangHoa (use CongDiem by Nhom)
                            if (itemKM[0].HinhThuc === 23) {
                                sumThanhTien += parseInt(itemCTHD.ThanhTien);
                                sumTT_Diem = sumThanhTien;
                            }
                        }
                    }
                    // remove comma 
                    spMua_note = Remove_LastComma(spMua_note);
                }
                else {
                    for (let i = 0; i < cthd.length; i++) {
                        let itemCTHD = cthd[i];
                        let sluongByIDQuiDoi = 0;
                        var sumThanhTien2 = 0;
                        if (itemCTHD.IDRandomHD === idRandomHD && itemCTHD.ID_DonViQuiDoi === self.CTHD_ChosingKM().ID_DonViQuiDoi) {
                            sluongByIDQuiDoi = parseInt(itemCTHD.SoLuong);
                            // sum Hang in LoHang
                            for (let j = 1; j < itemCTHD.DM_LoHang.length; j++) {
                                sluongByIDQuiDoi += parseInt(itemCTHD.DM_LoHang[j].SoLuong);
                                sumThanhTien2 += parseInt(itemCTHD.DM_LoHang[j].ThanhTien);
                            }
                            for (let j = 0; j < itemCTHD.HangCungLoais.length; j++) {
                                sluongByIDQuiDoi += parseInt(itemCTHD.HangCungLoais[j].SoLuong);
                                sumThanhTien2 += parseInt(itemCTHD.HangCungLoais[j].ThanhTien);
                            }
                            spMua_note += sluongByIDQuiDoi + ' ' + itemCTHD.MaHangHoa;
                            // get ThanhTien of HangHoa (use CongDiem by Nhom)
                            if (itemKM[0].HinhThuc === 23) {
                                sumThanhTien2 += parseInt(itemCTHD.ThanhTien);
                                sumTT_Diem = sumThanhTien2;
                            }
                            break;
                        }
                    }
                }
                // tinh SLTang phu hop voi HH da mua
                var sluongTang_PhuHop = parseInt(sumSL_inCTHD / slCanMua * slTang);
                // caculator sum Soluong in HHTang
                var sumSL = 0;
                for (let j = 0; j < itemHHTang.length; j++) {
                    sumSL += parseInt(itemHHTang[j].SoLuong);
                }
                // Nếu nhập sumSoLuong > sluongTang cho phep --> gán số lượng max cho Sp đầu tiên (OK)
                if (sumSL > sluongTang_PhuHop) {
                    itemHHTang = $.grep(itemHHTang, function (x, index) {
                        return index === 0;
                    });
                    itemHHTang[0].SoLuong = sluongTang_PhuHop;
                }
                else {
                    // neu chua du sltang --> gan sluong = max - sum (sluong) cho Sp dau tien (OK)
                    if (sumSL < sluongTang_PhuHop) {
                        var slThieu = sluongTang_PhuHop - sumSL;
                        itemHHTang[0].SoLuong = parseInt(itemHHTang[0].SoLuong) + slThieu;
                    }
                }
                // update again ThanhTien for HangTang
                for (let j = 0; j < itemHHTang.length; j++) {
                    let giaAfterSale = itemHHTang[j].GiaBan - itemHHTang[j].TienChietKhau;
                    giaAfterSale = giaAfterSale < 0 ? 0 : giaAfterSale;
                    itemHHTang[j].ThanhTien = itemHHTang[j].SoLuong * giaAfterSale;
                    itemHHTang[j].ThanhToan = itemHHTang[j].ThanhTien;
                }
                // get Ma + SoLuong hang tang
                for (let i = 0; i < itemHHTang.length; i++) {
                    loaiKM_note += itemHHTang[i].SoLuong + ' ' + itemHHTang[i].MaHangHoa + ', ';
                }
                // delete comma last
                loaiKM_note = Remove_LastComma(loaiKM_note);
                var tenKM_Note = itemKM[0].TenKhuyenMai + ': Khi mua ' + spMua_note + ' ' + loaiKM_note;
                var lenCTHD = cthd.length;
                // update GiaBan, GiamGia if HinhThuc = 24 (Mua hang - gia theo SL mua)
                if (itemKM[0].HinhThuc === 24) {
                    if (isTangNhom === true) {
                        for (let i = 0; i < lenCTHD; i++) {
                            if (cthd[i].IDRandomHD === idRandomHD && cthd[i].ID_NhomHangHoa === self.CTHD_ChosingKM().ID_NhomHangHoa) {
                                cthd[i].TenKhuyenMai = tenKM_Note;
                                cthd[i].DVTinhGiam = 'VND';
                                cthd[i].TangKem = true;
                                cthd[i].ID_TangKem = cthd[i].ID_DonViQuiDoi;
                                cthd[i].IsOpeningKMai = true;
                                cthd[i].ID_KhuyenMai = itemKM[0].ID_KhuyenMai;
                                // get giaban bandau
                                let itemHH = $.grep(self.HangHoaAll(), function (x) {
                                    return x.ID_DonViQuiDoi === cthd[i].ID_DonViQuiDoi;
                                })

                                if (itemHH.length > 0) {
                                    // khuyenmai: giaban/ 1sp
                                    let ck = itemHH[0].GiaBan - giaKhuyenMai;
                                    if (ck > 0) {
                                        cthd[i].TienChietKhau = ck;
                                        cthd[i].GiaBan = itemHH[0].GiaBan;
                                        cthd[i].DonGia = itemHH[0].GiaBan;
                                        cthd[i].ThanhTien = cthd[i].SoLuong * giaKhuyenMai;
                                        cthd[i].ThanhToan = cthd[i].ThanhTien;
                                        // update in DM_Lo, hangcungloai
                                        for (let k = 0; k < cthd[i].DM_LoHang.length; k++) {
                                            cthd[i].DM_LoHang[k].TienChietKhau = ck;
                                            cthd[i].DM_LoHang[k].GiaBan = itemHH[0].GiaBan;
                                            cthd[i].DM_LoHang[k].DonGia = itemHH[0].GiaBan;
                                            cthd[i].DM_LoHang[k].ThanhTien = cthd[i].DM_LoHang[k].SoLuong * giaKhuyenMai;
                                        }
                                        for (let k = 0; k < cthd[i].HangCungLoais.length; k++) {
                                            cthd[i].HangCungLoais[k].TienChietKhau = ck;
                                            cthd[i].HangCungLoais[k].GiaBan = itemHH[0].GiaBan;
                                            cthd[i].HangCungLoais[k].DonGia = itemHH[0].GiaBan;
                                            cthd[i].HangCungLoais[k].ThanhTien = cthd[i].HangCungLoais[k].SoLuong * giaKhuyenMai;
                                        }
                                    }
                                }
                            }
                        }
                    }
                    else {
                        for (let i = 0; i < lenCTHD; i++) {
                            if (cthd[i].IDRandomHD === idRandomHD && cthd[i].ID_DonViQuiDoi === self.CTHD_ChosingKM().ID_DonViQuiDoi) {
                                cthd[i].TenKhuyenMai = tenKM_Note;
                                cthd[i].DVTinhGiam = 'VND';
                                cthd[i].TangKem = true;
                                cthd[i].ID_TangKem = cthd[i].ID_DonViQuiDoi;
                                cthd[i].IsOpeningKMai = true;
                                cthd[i].HangHoa_KM = [];
                                cthd[i].ID_KhuyenMai = itemKM[0].ID_KhuyenMai;
                                let itemHH = $.grep(self.HangHoaAll(), function (x) {
                                    return x.ID_DonViQuiDoi === cthd[i].ID_DonViQuiDoi;
                                })
                                if (itemHH.length > 0) {
                                    // khuyenmai: giaban/ 1sp
                                    let ck = itemHH[0].GiaBan - giaKhuyenMai;
                                    if (ck > 0) {
                                        cthd[i].TienChietKhau = ck;
                                        cthd[i].GiaBan = itemHH[0].GiaBan;
                                        cthd[i].DonGia = itemHH[0].GiaBan;
                                        cthd[i].ThanhTien = cthd[i].SoLuong * giaKhuyenMai;
                                        cthd[i].ThanhToan = cthd[i].ThanhTien;
                                        for (let k = 0; k < cthd[i].DM_LoHang.length; k++) {
                                            cthd[i].DM_LoHang[k].TienChietKhau = ck;
                                            cthd[i].DM_LoHang[k].GiaBan = itemHH[0].GiaBan;
                                            cthd[i].DM_LoHang[k].DonGia = itemHH[0].GiaBan;
                                            cthd[i].DM_LoHang[k].ThanhTien = cthd[i].DM_LoHang[k].SoLuong * giaKhuyenMai;
                                        }
                                        for (let k = 0; k < cthd[i].HangCungLoais.length; k++) {
                                            cthd[i].HangCungLoais[k].TienChietKhau = ck;
                                            cthd[i].HangCungLoais[k].GiaBan = itemHH[0].GiaBan;
                                            cthd[i].HangCungLoais[k].DonGia = itemHH[0].GiaBan;
                                            cthd[i].HangCungLoais[k].ThanhTien = cthd[i].HangCungLoais[k].SoLuong * giaKhuyenMai;
                                        }
                                    }
                                }
                                break;
                            }
                        }
                    }
                }
                else {
                    // HinhThuc !=24: update HangChoseTang
                    for (let i = 0; i < lenCTHD; i++) {
                        if (cthd[i].IDRandomHD === idRandomHD && cthd[i].ID_DonViQuiDoi === self.CTHD_ChosingKM().ID_DonViQuiDoi) {
                            cthd[i].TenKhuyenMai = tenKM_Note;
                            cthd[i].HangHoa_KM = itemHHTang;
                            cthd[i].IsOpeningKMai = true;
                            cthd[i].ID_KhuyenMai = itemKM[0].ID_KhuyenMai;
                            break;
                        }
                    }
                    // if TangNhom: update ID_KhuyenMai,ID_TangKem for all HH in Nhom (Todo)
                    if (isTangNhom) {
                        for (let i = 0; i < lenCTHD; i++) {
                            if (cthd[i].IDRandomHD === idRandomHD && cthd[i].ID_NhomHangHoa === self.CTHD_ChosingKM().ID_NhomHangHoa) {
                                cthd[i].ID_KhuyenMai = itemKM[0].ID_KhuyenMai;
                            }
                        }
                    }
                }
                localStorage.setItem(lcListCTHD, JSON.stringify(cthd))
                // bind again CTHD
                var arrCTHD = $.grep(cthd, function (x) {
                    return x.IDRandomHD === idRandomHD;
                });
                self.HangHoaAfterAdds(arrCTHD);
                UpdateCacheHDLe(idRandomHD, false);
                // use Km cong diem hang hoa
                if (itemKM[0].HinhThuc === 23) {
                    var quydoiDiemHH = Math.floor(sumTT_Diem / self.ThietLap_TichDiem()[0].TyLeDoiDiem);
                    if (congPTramDiem) {
                        // tinh diem
                        quydoiDiemHH = Math.floor(diemCong / 100 * quydoiDiemHH);
                    }
                    else {
                        quydoiDiemHH = diemCong;
                    }
                    // update diemcong HD after update diemkhuyenmai HH
                    UpdateDiemKhuyenMai_CTHD(quydoiDiemHH);
                    UpdateDiemCong_KMCongDiem(idRandomHD, quydoiDiemHH, false);
                }
                UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();
                // reset KMai HoaDon (phai reset sau khi chon KM hang hoa ! important)
                ResetKM_HoaDon(idRandomHD);
                // bind again infor HoaDon (bind after update KhuyenMai)
                var lstHDafter = localStorage.getItem(lcListHD);
                if (lstHDafter !== null) {
                    lstHDafter = JSON.parse(lstHDafter);
                    var itemHD = GetHDOpening_byMaHoaDon(_maHoaDon, lstHDafter);
                    if (itemHD.length > 0) {
                        self.HoaDons().SetData(itemHD[0]);
                    }
                }
                localStorage.setItem(lcMaHD, _maHoaDon);
                $('#promotiont').modal('hide');
                Caculator_AmountProduct();
                HideShow_Icon_ChietKhauNV();
            }
        }
    }
    function CheckKM_TichDiem_forHangGiamGia() {
        // if Khong tich diem cho Sp giam gia
        var isTichDiem = true;
        if (self.ThietLap_TichDiem() !== null && self.ThietLap_TichDiem().length > 0) {
            if (self.ThietLap_TichDiem()[0].TichDiemGiamGia) {
                isTichDiem = false; // khong tich cho HH giam Gia
            }
        }
        return isTichDiem;
    }
    self.TangSoluongHHTang = function (item) {
        var thisObj = event.currentTarget;
        var idKhuyenMai = $(thisObj).closest('tr').find('td:eq(0) > span').attr('id');
        var itemKM = $.grep(self.ListKM_ofHangHoa(), function (km) {
            return km.ID_KhuyenMai === idKhuyenMai;
        });
        // code same AddKhuyenMai_forHangHoa
        var slCanMua = 0;
        var slTang = 0;
        var checkKMNhom = Check_KhuyenMaiNhom();
        if (checkKMNhom === false) {
            // get lst HHTang by ID_QuiDoiMua
            for (let i = 0; i < itemKM[0].DM_KhuyenMai_ChiTiet.length; i++) {
                var itemKMCT = itemKM[0].DM_KhuyenMai_ChiTiet[i];
                if (itemKMCT.ID_DonViQuiDoiMua === self.CTHD_ChosingKM().ID_DonViQuiDoi) {
                    slCanMua = itemKMCT.SoLuongMua;// assign SLTang, SLMua to do check Add HHTang
                    slTang = itemKMCT.SoLuong;
                }
            }
        }
        else {
            slCanMua = checkKMNhom.SoLuongMua;// assign SLTang, SLMua to do check Add HHTang
            slTang = checkKMNhom.SoLuongTang;
        }
        var sumSL_inCTHD = GetSum_SoLuongHang_SameGroup(null);
        // tinh SLTang phu hop voi HH da mua
        var sluongTang_PhuHop = (sumSL_inCTHD / slCanMua) * slTang;
        // caculator sum Soluong in HHTang
        var sumSL = 0;
        for (let j = 0; j < itemKM[0].HangHoaChoseTangs.length; j++) {
            sumSL += parseInt(itemKM[0].HangHoaChoseTangs[j].SoLuong);
        }
        var objNumber = $('#numberTang_' + item.ID_DonViQuiDoi);
        var newNumber = parseFloat(objNumber.val());
        if (isNaN(newNumber)) {
            newNumber = 0;
        }
        else {
            newNumber = newNumber + 1;
        }
        if (sumSL < sluongTang_PhuHop) {
            objNumber.val(newNumber);
            // find ListKM_ofHangHoa with ID_KhuyenMai && add objHH --> HangHoaChoseTangs
            for (let i = 0; i < self.ListKM_ofHangHoa().length; i++) {
                if (self.ListKM_ofHangHoa()[i].ID_KhuyenMai === idKhuyenMai) {
                    for (let j = 0; j < self.ListKM_ofHangHoa()[i].HangHoaChoseTangs.length; j++) {
                        var itemHHTang = self.ListKM_ofHangHoa()[i].HangHoaChoseTangs[j];
                        // if ID_DonViQuiDoi in HHTang = item.ID_DonViQuiDoi
                        if (itemHHTang.ID_DonViQuiDoi === item.ID_DonViQuiDoi) {
                            self.ListKM_ofHangHoa()[i].HangHoaChoseTangs[j].SoLuong = newNumber;
                            self.ListKM_ofHangHoa()[i].HangHoaChoseTangs[j].ThanhTien = newNumber * itemHHTang.GiaBan;
                            break;
                        }
                    }
                    break;
                }
            }
            // assign ListKM_ofHangHoa =[] , after push again
            self.HHTang_AfterRender(self.ListKM_ofHangHoa());
            self.ListKM_ofHangHoa([]);
            for (let i = 0; i < self.HHTang_AfterRender().length; i++) {
                self.ListKM_ofHangHoa.push(self.HHTang_AfterRender()[i]);
            }
        }
        else {
            ShowMessage_Danger('Quá số lượng hàng tặng');
            return;
        }
    }
    self.GiamSoluongHHTang = function (item) {
        var thisObj = event.currentTarget;
        var idKhuyenMai = $(thisObj).closest('tr').find('td:eq(0) > span').attr('id');
        var objNumber = $('#numberTang_' + item.ID_DonViQuiDoi);
        var newNumber = parseFloat(objNumber.val());
        if (newNumber > 0) {
            newNumber = newNumber - 1;
            objNumber.val(newNumber);
        }
        for (let i = 0; i < self.ListKM_ofHangHoa().length; i++) {
            if (self.ListKM_ofHangHoa()[i].ID_KhuyenMai === idKhuyenMai) {
                for (let j = 0; j < self.ListKM_ofHangHoa()[i].HangHoaChoseTangs.length; j++) {
                    var itemHHTang = self.ListKM_ofHangHoa()[i].HangHoaChoseTangs[j];
                    if (itemHHTang.ID_DonViQuiDoi === item.ID_DonViQuiDoi) {
                        self.ListKM_ofHangHoa()[i].HangHoaChoseTangs[j].SoLuong = newNumber;
                        self.ListKM_ofHangHoa()[i].HangHoaChoseTangs[j].ThanhTien = newNumber * itemHHTang.GiaBan;
                        break;
                    }
                }
                break;
            }
        }
        // assign ListKM_ofHangHoa =[] , after push again
        self.HHTang_AfterRender(self.ListKM_ofHangHoa());
        self.ListKM_ofHangHoa([]);
        for (let i = 0; i < self.HHTang_AfterRender().length; i++) {
            self.ListKM_ofHangHoa.push(self.HHTang_AfterRender()[i]);
        }
    }
    self.EditSoLuongHHTang = function (item) {
        var thisObj = event.currentTarget;
        var idKhuyenMai = $(thisObj).closest('tr').find('td:eq(0) > span').attr('id');
        var objNumber = $('#numberTang_' + item.ID_DonViQuiDoi);
        var newNumber = parseFloat(objNumber.val());
        if (isNaN(newNumber)) {
            newNumber = 0;
        }
        // find ListKM_ofHangHoa with ID_KhuyenMai && add objHH --> HangHoaChoseTangs
        for (let i = 0; i < self.ListKM_ofHangHoa().length; i++) {
            if (self.ListKM_ofHangHoa()[i].ID_KhuyenMai === idKhuyenMai) {
                for (let j = 0; j < self.ListKM_ofHangHoa()[i].HangHoaChoseTangs.length; j++) {
                    var itemHHTang = self.ListKM_ofHangHoa()[i].HangHoaChoseTangs[j];
                    // if ID_DonViQuiDoi in HHTang = item.ID_DonViQuiDoi
                    if (itemHHTang.ID_DonViQuiDoi === item.ID_DonViQuiDoi) {
                        self.ListKM_ofHangHoa()[i].HangHoaChoseTangs[j].SoLuong = newNumber;
                    }
                }
                break;
            }
        }
        // caculator SLTang cho phep, SLMua in CTHD
        var itemKM = $.grep(self.ListKM_ofHangHoa(), function (km) {
            return km.ID_KhuyenMai === idKhuyenMai;
        });
        var slCanMua = 0;
        var slTang = 0;
        var checkKMNhom = Check_KhuyenMaiNhom();
        if (checkKMNhom === false) {
            // get lst HHTang by ID_QuiDoiMua
            for (let i = 0; i < itemKM[0].DM_KhuyenMai_ChiTiet.length; i++) {
                var itemKMCT = itemKM[0].DM_KhuyenMai_ChiTiet[i];
                if (itemKMCT.ID_DonViQuiDoiMua === self.CTHD_ChosingKM().ID_DonViQuiDoi) {
                    slCanMua = itemKMCT.SoLuongMua;// assign SLTang, SLMua to do check Add HHTang
                    slTang = itemKMCT.SoLuong;
                }
            }
        }
        else {
            slCanMua = checkKMNhom.SoLuongMua;// assign SLTang, SLMua to do check Add HHTang
            slTang = checkKMNhom.SoLuongTang;
        }
        var sumSL_inCTHD = GetSum_SoLuongHang_SameGroup(null);
        // tinh SLTang phu hop voi HH da mua
        var sluongTang_PhuHop = (sumSL_inCTHD / slCanMua) * slTang;
        // caculator sum Soluong in HHTang
        var sumSL = 0;
        for (let j = 0; j < itemKM[0].HangHoaChoseTangs.length; j++) {
            sumSL += parseInt(itemKM[0].HangHoaChoseTangs[j].SoLuong);
        }
        if (sumSL > sluongTang_PhuHop) {
            ShowMessage_Danger('Chỉ được tặng tối đa ' + sluongTang_PhuHop + ' sản phẩm');
            return;
        }
    }
    self.XoaHangTang = function (item) {
        // get idKhuyenMai from tag <span> because HangKm of HangHoa have ID_KhuyenMai = null
        var thisObj = event.currentTarget;
        var idKhuyenMai = $(thisObj).closest('tr').find('td:eq(0) > span').attr('id');
        var idQuiDoi = item.ID_DonViQuiDoi;
        var hhKM = self.ListKM_ofHangHoa();
        for (let i = 0; i < self.ListKM_ofHangHoa().length; i++) {
            if (self.ListKM_ofHangHoa()[i].ID_KhuyenMai === idKhuyenMai) {
                for (let j = 0; j < self.ListKM_ofHangHoa()[i].HangHoaChoseTangs.length; j++) {
                    var itemHHTang = self.ListKM_ofHangHoa()[i].HangHoaChoseTangs[j];
                    if (itemHHTang.ID_DonViQuiDoi === idQuiDoi) {
                        self.ListKM_ofHangHoa()[i].HangHoaChoseTangs.splice(j, 1);
                    }
                }
                break;
            }
        }
        // assign ListKM_ofHangHoa =[] , after push again
        self.HHTang_AfterRender(self.ListKM_ofHangHoa());
        self.ListKM_ofHangHoa([]);
        for (let i = 0; i < self.HHTang_AfterRender().length; i++) {
            self.ListKM_ofHangHoa.push(self.HHTang_AfterRender()[i]);
        }
    }

    function CheckTonKho_SameIDHangHoa_DifferenceDVT(objCTHD) {
        var err = '';
        for (let i = 0; i < objCTHD.length; i++) {
            var itemOut = objCTHD[i];
            var cthd_saneIDHangHoa = $.grep(objCTHD, function (x) {
                return x.ID_HangHoa === itemOut.ID_HangHoa;
            });
            if (cthd_saneIDHangHoa.length > 0) {
                var sumTonThucTe = 0;
                var sumSLMua = 0;
                for (let j = 0; j < cthd_saneIDHangHoa.length; j++) {
                    sumTonThucTe = itemOut.TonKho * itemOut.TyLeChuyenDoi;
                    sumSLMua += formatNumberToFloat(itemOut.SoLuong) * itemOut.TyLeChuyenDoi;
                }
                if (sumTonThucTe < sumSLMua) {
                    err = cthd_saneIDHangHoa[0].TenHangHoa + ',';
                }
            }
        }
        return err;
    }

    self.saveHoaDonKhuyenMai = function (isTamLuu) {
        var lstHDTemp = localStorage.getItem(lcListHD);
        var objAdd = [];
        if (lstHDTemp !== null) {
            lstHDTemp = JSON.parse(lstHDTemp);
            objAdd = GetHDOpening_byMaHoaDon(_maHoaDon, lstHDTemp);
            var loaiHD = objAdd[0].LoaiHoaDon;
            var idRandomHD = objAdd[0].IDRandom;
            var _idDoiTuong = objAdd[0].ID_DoiTuong;
            var isKhachLe = false;
            if (commonStatisJs.CheckNull(objAdd[0].ID_DoiTuong) || _idDoiTuong === const_GuidEmpty) {
                isKhachLe = true;
            }
            if (loaiHD === 19 && isKhachLe) {
                ShowMessage_Danger('Vui lòng chọn khách hàng khi mua gói dịch vụ');
                SaveHD_RemoveDisable();
                return false;
            }
            // Start: assign ID_NhanVien if objAdd[0].ID_NhanVien === null
            if (objAdd[0].ID_NhanVien === null || objAdd[0].ID_NhanVien === undefined) {
                var itemNV = $.grep(self.NhanViens(), function (x) {
                    return x.ID_NguoiDung === id_User;
                });
                var idNhanVien = null;
                if (itemNV.length > 0) {
                    idNhanVien = itemNV[0].ID;
                }
                else {
                    idNhanVien = self.NhanViens()[0].ID;
                }
                objAdd[0].ID_NhanVien = idNhanVien;
            }
            // End ID_NhanVien
            // tim CTHoaDon t/u voi HoaDon
            var objCTAdd = [];
            var listAllCTHD = localStorage.getItem(lcListCTHD);
            if (listAllCTHD !== null) {
                listAllCTHD = JSON.parse(listAllCTHD);
                objCTAdd = GetCTHoaDon_FromArr(listAllCTHD, idRandomHD);
            }
            if (objCTAdd.length === 0) {
                ShowMessage_Danger('Vui lòng nhập chi tiết hóa đơn');
                SaveHD_RemoveDisable();
                return;
            }
            else {
                var msgErr = "";
                // Khong cho phep ban hang khi het ton kho
                var xuatAm = self.ThietLap().XuatAm;
                if (loaiHD === 19) {
                    // loai 19: check dat hang het TonKho
                    xuatAm = self.ThietLap().DatHangXuatAm;
                }
                if ((loaiHD !== 25 || (loaiHD === 25 && objAdd[0].XuatKhoAll)) && xuatAm === false) {
                    for (let i = 0; i < objCTAdd.length; i++) {
                        if (objCTAdd[i].LaHangHoa && objCTAdd[i].SoLuong > formatNumberToFloat(formatNumber3Digit(objCTAdd[i].TonKho))) {
                            msgErr += objCTAdd[i].TenHangHoa + ", ";
                        }
                    }
                    if (msgErr !== "") {
                        msgErr = Remove_LastComma(msgErr);
                        ShowMessage_Danger('Không đủ số lượng tồn kho cho sản phẩm ' + msgErr);
                        SaveHD_RemoveDisable();
                        return false;
                    }
                    if (loaiHD === 1) {
                        let errTPDL = '';
                        let errCT = '';
                        // check TonKho TPDinhLuong
                        for (let i = 0; i < objCTAdd.length; i++) {
                            if (objCTAdd[i].ThanhPhan_DinhLuong.length > 0) {
                                for (let j = 0; j < objCTAdd[i].ThanhPhan_DinhLuong.length; j++) {
                                    let dluong = objCTAdd[i].ThanhPhan_DinhLuong[j];
                                    if (dluong.SoLuong > 0 && dluong.TonKho < dluong.SoLuong) {
                                        errCT += dluong.TenHangHoa + ' ,';
                                    }
                                }
                            }
                            else {
                                if (objCTAdd[i].ThanhPhanComBo.length > 0) {
                                    for (let j = 0; j < objCTAdd[i].ThanhPhanComBo.length; j++) {
                                        let combo = objCTAdd[i].ThanhPhanComBo[j];
                                        if (combo.LoaiHangHoa === 1) {
                                            if (combo.TonKho < combo.SoLuong) {
                                                errCT += combo.TenHangHoa + ' ,';
                                            }
                                        }
                                    }
                                }
                                else {
                                    // find TP dinhluong & check TonKho  
                                    let arrTP = $.grep(vmThanhPhanDinhLuong.All_DinhLuongDichVu, function (x) {
                                        return x.ID_DichVu === objCTAdd[i].ID_DonViQuiDoi;
                                    });
                                    for (let j = 0; j < arrTP.length; j++) {
                                        let sluongDL = objCTAdd[i].SoLuong * arrTP[j].SoLuong;
                                        if (sluongDL > arrTP[j].TonKho) {
                                            errCT += arrTP[j].TenHangHoa + ', ';
                                        }
                                    }
                                }
                            }
                            if (errCT !== '') {
                                errTPDL += objCTAdd[i].TenHangHoa.concat(' không đủ tồn kho cho định lượng: ', Remove_LastComma(errCT), '<br />');
                            }
                        }
                        if (errTPDL !== "") {
                            ShowMessage_Danger(errTPDL);
                            SaveHD_RemoveDisable();
                            return false;
                        }
                    }
                }
                // check if Soluong = 0
                //for (let i = 0; i < objCTAdd.length; i++) {
                //    if (objCTAdd[i].SoLuong === 0) {
                //        msgErr += objCTAdd[i].TenHangHoa + ", ";
                //    }
                //}
                //if (msgErr !== "") {
                //    msgErr = Remove_LastComma(msgErr);
                //    ShowMessage_Danger('Chưa nhập số lượng cho hàng hóa ' + msgErr);
                //    SaveHD_RemoveDisable();
                //    return false;
                //}
                // check if chua nhap so lo
                for (let i = 0; i < objCTAdd.length; i++) {
                    if (objCTAdd[i].QuanLyTheoLoHang) {
                        if (objCTAdd[i].ID_LoHang === null || objCTAdd[i].ID_LoHang === undefined) {
                            ShowMessage_Danger('Vui lòng nhập đầy đủ thông tin lô cho hàng hóa ');
                            SaveHD_RemoveDisable();
                            return;
                        }
                    }
                }

                if (isKhachLe) {
                    let daTT = vmThanhToanGara.PhieuThuKhach.DaThanhToan;
                    if (commonStatisJs.CheckNull(daTT)) {
                        daTT = 0;
                    }
                    if (daTT < objAdd[0].PhaiThanhToan) {
                        msgErr = "Là khách lẻ, nên không cho phép nợ";
                        ShowMessage_Danger(msgErr);
                        SaveHD_RemoveDisable();
                        return false;
                    }
                }
                if (objAdd[0].ID_BaoHiem !== null && objAdd[0].ID_BaoHiem !== undefined) {
                    if (objAdd[0].PhaiThanhToanBaoHiem === 0) {
                        ShowMessage_Danger('Vui lòng nhập số tiền bảo hiểm chi trả');
                        SaveHD_RemoveDisable();
                        return false;
                    }
                }

                if (formatNumberToFloat(objAdd[0].PhaiThanhToanBaoHiem) > 0) {
                    if (objAdd[0].ID_BaoHiem === null || objAdd[0].ID_BaoHiem === undefined) {
                        ShowMessage_Danger('Vui lòng chọn công ty bảo hiểm');
                        SaveHD_RemoveDisable();
                        return false;
                    }
                }
                // update DonGia= GiaBan
                for (let i = 0; i < objCTAdd.length; i++) {
                    objCTAdd[i].DonGia = objCTAdd[i].GiaBan;
                }
                // remove CTHD with QuanLyTheoLo, but ID_Lo== null
                objCTAdd = GetArrCTHD_withIDLoHangOtherNull(objCTAdd);
                // update status NVien before save
                var myData = {};
                let maHoaDon = objAdd[0].MaHoaDon;
                // HD Offline/Copy/Tamluu => giu nguyen ma
                // todo KH tự nhập mã hóa đơn
                if (objAdd[0].StatusOffline === true || maHoaDon.indexOf('Copy') > -1 || objAdd[0].ID !== const_GuidEmpty) {
                    objAdd[0].MaHoaDon = maHoaDon;
                }
                else {
                    objAdd[0].MaHoaDon = null;
                }
                // ID_DonVi
                if (objAdd[0].ID_DonVi === null || objAdd[0].ID_DonVi === undefined) {
                    objAdd[0].ID_DonVi = id_DonVi;
                }
                // if HD is creat from HD DatHang or HD TamLuu --> not delete ID_HoaDon
                // get GhiChu_KhuyenMai = GhiChuKM_ofHH + GhiChuKM_HD
                var ghichuKMHD = '';
                for (let i = 0; i < objCTAdd.length; i++) {
                    if (objCTAdd[i].IsKhuyenMai && objCTAdd[i].TenKhuyenMai !== '') {
                        ghichuKMHD += objCTAdd[i].TenKhuyenMai + '<br /> ';
                    }
                }
                ghichuKMHD += objAdd[0].KhuyenMai_GhiChu;
                if (ghichuKMHD === undefined || ghichuKMHD.indexOf('undefined') > -1) {
                    ghichuKMHD = '';
                }
                objAdd[0].KhuyenMai_GhiChu = ghichuKMHD;
                if (vmThanhToanGara.GridNVienBanGoi_Chosed.length > 0) {
                    objAdd[0].BH_NhanVienThucHiens = vmThanhToanGara.GridNVienBanGoi_Chosed;
                }
                // check NgayLapHD is null, and get
                var ngaylapHD = GetNgayLapHD_whenSave(objAdd[0].NgayLapHoaDon);
                objAdd[0].NgayLapHoaDon = ngaylapHD;
                myData.objHoaDon = objAdd[0];
                myData.objCTHoaDon = objCTAdd;
                myData.IsSetGiaVonTrungBinh = self.ThietLap().GiaVonTrungBinh;
                var lstDoiTuong = localStorage.getItem(lcDM_DoiTuong);
                var itemDoiTuong = [];
                if (lstDoiTuong !== null) {
                    var lstDoiTuong1 = JSON.parse(lstDoiTuong);
                    itemDoiTuong = $.grep(lstDoiTuong1, function (item) {
                        return item.ID === objAdd[0].ID_DoiTuong;
                    });
                }

                // check if phieuthu = kh + baohiem: 1NVien - save 2 row BH_NhanVienThucHien (ID_QuyHoaDon # nhau todo difficult because same ID_HoaDon)
                if (myData.objHoaDon.BH_NhanVienThucHiens.length > 0) {
                    if (vmThanhToanGara.PhieuThuKhach.ThucThu > 0 && vmThanhToanGara.PhieuThuBaoHiem.ThucThu > 0) {
                    }
                }

                if (itemDoiTuong.length > 0) {
                    // 1.add DoiTuong, HoaDon
                    AddKhachHang_HoaDon(itemDoiTuong[0], myData, false, false);
                }
                else {
                    if (isTamLuu) {
                        PostHD_TamLuu(myData);
                    }
                    else {
                        UpdateInforKH_inLstDoiTuongs(myData.objHoaDon, false);
                        switch (loaiHD) {
                            case 1:
                            case 25:
                                PostHD_SoQuy_SaveHD(myData, false);
                                break;
                            case 19:
                                PostHD_HoaDon_DichVu(myData);
                                break;
                        }
                    }
                }
            }
        }
        else {
            ShowMessage_Danger('Vui lòng nhập thông tin hóa đơn');
            SaveHD_RemoveDisable();
            return;
        }
    }
    function RemoveHD_ifNotSaleOffline(lstHD, cthd, idRandomHD) {
        lstHD = $.grep(lstHD, function (x) {
            return x.IDRandom !== idRandomHD
        });
        cthd = $.grep(cthd, function (x) {
            return x.IDRandomHD !== idRandomHD
        });
        localStorage.setItem(lcListHD, JSON.stringify(lstHD));
        localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
    }

    // Khuyen Mai HoaDon
    self.GetListKM_HoaDon = function () {
        if (_maHoaDon === '') {
            _maHoaDon = $('.gara-bill-label  li.active font').text();
        }
        // if HD offline --> don't show modal
        if (_maHoaDon.indexOf('HDO') > -1) {
            return;
        }
        $('#promotiont_Parent').modal('show');
        self.ListKM_ofHoaDon([]);
        var dtNow = new Date();
        var _month = (dtNow.getMonth() + 1).toString(); // 1-12 (+1 because getMoth() return 0-11)
        var _date = (dtNow.getDate()).toString(); // 1- 31
        var _hours = (dtNow.getHours()).toString(); // 1-24
        var _day = (dtNow.getDay() + 1).toString(); // mon:2, tues:3, wed:4, thur:5, fri:6, sat: 7, sun: 8
        var _weekofMonth = Math.ceil(dtNow.getDate() / 7); // get week of Month ( 1- 5);
        if (self.KM_KMApDung().length === 0) {
            GetList_KMApDung();
            // co nen sort at here ??
            for (let i = 0; i < self.KM_KMApDung().length; i++) {
                self.KM_KMApDung()[i].DM_KhuyenMai_ChiTiet.sort(function (a, b) {
                    var x = a.TongTienHang, y = b.TongTienHang;
                    return x < y ? -1 : x > y ? 1 : 0;
                })
            }
        }
        var idNhanVien = self.selectedNVien();
        var idNhomKH = null;
        var ngaysinhFull = 0;
        var ngaysinh = 0;
        var thangsinh = 0;
        var tuansinh = 0;
        var arrNhomKH = [];
        var ctDoiTuong = self.ChiTietDoiTuong();
        // if chose KH --> get idNhomKH + ngaysinh
        if (ctDoiTuong !== null && ctDoiTuong.length > 0) {
            idNhomKH = ctDoiTuong[0].ID_NhomDoiTuong.toLowerCase();
            arrNhomKH = idNhomKH.split(', ');
            ngaysinhFull = ctDoiTuong[0].NgaySinh_NgayTLap;
        }
        if (ngaysinhFull !== 0 && ngaysinhFull !== null) {
            var dtNgaySinh = new Date(moment(ngaysinhFull).format('YYYY-MM-DD')); // must format 'YYYY-MM-DD'
            ngaysinh = dtNgaySinh.getDate();
            thangsinh = (dtNgaySinh.getMonth() + 1).toString();
            tuansinh = Math.ceil(dtNgaySinh.getDate() / 7);
        }
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            var itemHD = GetHDOpening_byMaHoaDon(_maHoaDon, lstHD);
            for (let j = 0; j < self.KM_KMApDung().length; j++) {
                // get KM apply for HoaDon
                var itemKM2 = self.KM_KMApDung()[j];
                if (itemKM2.HinhThuc.toString().startsWith('1')) {
                    for (let k = 0; k < itemKM2.DM_KhuyenMai_ChiTiet.length; k++) {
                        if (itemKM2.DM_KhuyenMai_ChiTiet[k].TongTienHang <= itemHD[0].TongTienHang) {
                            // check ThoiGian + PhamVi Ap dung
                            if (itemKM2.ApDungNgaySinh !== 0) {
                                // if chose KH
                                if (ctDoiTuong !== null && ctDoiTuong.length > 0) {
                                    if ((itemKM2.Months.length === 0 || $.inArray(_month, itemKM2.Months) > -1)
                                        && (itemKM2.Dates.length === 0 || $.inArray(_date, itemKM2.Dates) > -1)
                                        && (itemKM2.Days.length === 0 || $.inArray(_day, itemKM2.Days) > -1)
                                        && (itemKM2.Hours.length === 0 || $.inArray(_hours, itemKM2.Hours) > -1)
                                        && (itemKM2.ID_NhanViens.length === 0 || $.inArray(idNhanVien, itemKM2.ID_NhanViens) > -1)
                                        && (itemKM2.ID_NhomKHs.length === 0 || itemKM2.ID_NhomKHs.some(r => arrNhomKH.indexOf(r) >= 0))) {
                                        switch (itemKM2.ApDungNgaySinh) {
                                            case 1: // ap dung ngay sinh theo ngay
                                                if (ngaysinh.toString() === _date) {
                                                    itemKM2.HangHoaChoseTangs = [];
                                                    self.ListKM_ofHoaDon.push(itemKM2);
                                                    break;
                                                }
                                                break;
                                            case 2: // ap dung ngay sinh theo tuan
                                                if (tuansinh.toString() === _weekofMonth) {
                                                    itemKM2.HangHoaChoseTangs = [];
                                                    self.ListKM_ofHoaDon.push(itemKM2);
                                                    break;
                                                }
                                                break;
                                            case 3: // ap dung ngay sinh theo thang
                                                if (thangsinh.toString() === _month) {
                                                    itemKM2.HangHoaChoseTangs = [];
                                                    self.ListKM_ofHoaDon.push(itemKM2);
                                                    break;
                                                }
                                                break;
                                        }
                                    }
                                }
                            }
                            else {
                                // if ApDungNgaySinh = 0
                                if ((itemKM2.Months.length === 0 || $.inArray(_month, itemKM2.Months) > -1)
                                    && (itemKM2.Dates.length === 0 || $.inArray(_date, itemKM2.Dates) > -1)
                                    && (itemKM2.Days.length === 0 || $.inArray(_day, itemKM2.Days) > -1)
                                    && (itemKM2.Hours.length === 0 || $.inArray(_hours, itemKM2.Hours) > -1)
                                    && (itemKM2.ID_NhanViens.length === 0 || $.inArray(idNhanVien, itemKM2.ID_NhanViens) > -1)
                                    && (itemKM2.ID_NhomKHs.length === 0 || itemKM2.ID_NhomKHs.some(r => arrNhomKH.indexOf(r) >= 0))) {
                                    itemKM2.HangHoaChoseTangs = [];
                                    self.ListKM_ofHoaDon.push(itemKM2);
                                    break;
                                }
                            }
                        }
                    }
                }
            }
        }
        // order by ASC TongTienHang in DM_KhuyenMai_ChiTiet of ListKM_ofHoaDon (OK)
        for (let i = 0; i < self.ListKM_ofHoaDon().length; i++) {
            self.ListKM_ofHoaDon()[i].DM_KhuyenMai_ChiTiet.sort(function (a, b) {
                var x = a.TongTienHang, y = b.TongTienHang;
                return x < y ? -1 : x > y ? 1 : 0;
            })
        }
        var giamGiaHD = 0;
        var isGGPhanTram = false;
        var idKM_haveGG = null;
        // if Giam gia HoaDon --> update Note_HinhThuc for ListKM_ofHoaDon
        for (let i = 0; i < self.ListKM_ofHoaDon().length; i++) {
            var itemKM3 = self.ListKM_ofHoaDon()[i];
            // 11: giam gia HD, 14: tang diem
            if (itemKM3.HinhThuc === 11 || itemKM3.HinhThuc === 14) {
                idKM_haveGG = itemKM3.ID_KhuyenMai;
                for (let j = 0; j < itemKM3.DM_KhuyenMai_ChiTiet.length; j++) {
                    // find giamgia phu hop nhat
                    if (itemKM3.DM_KhuyenMai_ChiTiet[j].TongTienHang <= itemHD[0].TongTienHang) {
                        giamGiaHD = itemKM3.DM_KhuyenMai_ChiTiet[j].GiamGia;
                        isGGPhanTram = itemKM3.DM_KhuyenMai_ChiTiet[j].GiamGiaTheoPhanTram;
                        // update Note_HinhThuc for ListKM_ofHoaDon
                        if (itemKM3.HinhThuc === 11) {
                            self.ListKM_ofHoaDon()[i].Note_HinhThuc = 'Giảm giá ' + giamGiaHD + ' ' + (isGGPhanTram === true ? '%' : 'VND');
                        }
                        else {
                            self.ListKM_ofHoaDon()[i].Note_HinhThuc = 'Tặng ' + giamGiaHD + ' ' + (isGGPhanTram === true ? '% điểm' : ' điểm');
                        }
                    }
                }
            }
        }
        // remove list KM_tang diem if Thiet lap khong tich diem cho HD giam gia
        var isTichDiemHD_GiamGia = Check_ThietLapTichDiem_GiamGiaHD;
        if (!isTichDiemHD_GiamGia) {
            if (itemHD[0].TongGiamGia > 0) {
                var arrListKM = $.grep(self.ListKM_ofHoaDon(), function (x) {
                    return x.HinhThuc !== 14;
                });
                self.ListKM_ofHoaDon(arrListKM);
            }
        }
        // check if opened KhuyenMai of HoaDon
        if (lstHD !== null) {
            var xItemHD = GetHDOpening_byMaHoaDon(_maHoaDon, lstHD);
            if (xItemHD.length > 0) {
                if (xItemHD[0].IsOpeningKMaiHD) {
                    // check radio KhuyenMai
                    self.HD_KhuyenMai(xItemHD[0].ID_KhuyenMai);
                }
                // bind lstproductKM_of HoaDon
                var lstKM_HD = localStorage.getItem(lcProductKM_HoaDon);
                if (lstKM_HD !== null) {
                    lstKM_HD = JSON.parse(lstKM_HD);
                    var itemKM_HD = $.grep(lstKM_HD, function (x) {
                        return x.IDRandomHD === xItemHD[0].IDRandom;
                    });
                    //var arrKM_HD = [];
                    //if (itemKM_HD.length > 0) {
                    //    //self.HD_KhuyenMai(itemKM_HD[0].ID_KhuyenMai);
                    //    for (let i = 0; i < itemKM_HD.length; i++) {
                    //        arrKM_HD.push(itemKM_HD[i]);
                    //    }
                    //}
                    // assign HH Khuyen Mai for self.ListKM_ofHoaDon
                    if (self.HD_KhuyenMai() !== undefined) {
                        for (let i = 0; i < self.ListKM_ofHoaDon().length; i++) {
                            if (self.ListKM_ofHoaDon()[i].ID_KhuyenMai === self.HD_KhuyenMai()) {
                                self.ListKM_ofHoaDon()[i].HangHoaChoseTangs = itemKM_HD;
                                break;
                            }
                        }
                    }
                }
            }
            self.HHTangHoaDon_AfterRender(self.ListKM_ofHoaDon());
            self.ListKM_ofHoaDon([]);
            for (let i = 0; i < self.HHTangHoaDon_AfterRender().length; i++) {
                self.ListKM_ofHoaDon.push(self.HHTangHoaDon_AfterRender()[i]);
            }
        }
    }
    function Check_ThietLapTichDiem_GiamGiaHD() {
        var isTichDiemHD_GiamGia = true;
        if (self.ThietLap_TichDiem() !== null && self.ThietLap_TichDiem().length > 0) {
            if (self.ThietLap_TichDiem()[0].TichDiemHoaDonGiamGia) {
                isTichDiemHD_GiamGia = false;
            }
        }
        return isTichDiemHD_GiamGia;
    }
    self.LoadHangHoaTang_HoaDon = function (item) {
        self.ID_KhuyenMai(item.ID_KhuyenMai); // assign to do add HangHoa Tang of HoaDon
        var itemKM = $.grep(self.ListKM_ofHoaDon(), function (km) {
            return km.ID_KhuyenMai === item.ID_KhuyenMai;
        });
        var lstHD = JSON.parse(localStorage.getItem(lcListHD));
        var itemEx = GetHDOpening_byMaHoaDon(_maHoaDon, lstHD);
        if (itemEx.length > 0) {
            // get IDNhomHHTang by ID_NhomHHMua
            var idQuiDoiTang = null;
            var idNhomHHTang = null;
            for (let i = 0; i < itemKM[0].DM_KhuyenMai_ChiTiet.length; i++) {
                if (itemKM[0].DM_KhuyenMai_ChiTiet[i].TongTienHang <= itemEx[0].TongTienHang) {
                    // chi lay khuyen mai gan nhat (VD: co Km 2trieu + KM 1trieu: ma tong tien hang > 2trieu ==> uu tien lay ID_nhomHH, ID_QuiDoi cua Km 2 trieu)
                    idNhomHHTang = itemKM[0].DM_KhuyenMai_ChiTiet[i].ID_NhomHangHoa;
                    idQuiDoiTang = itemKM[0].DM_KhuyenMai_ChiTiet[i].ID_DonViQuiDoi;
                }
            }
            // get lst HangHoa in NhomHHTang OR ID_QuiDoiTang
            var arrHHTang = $.grep(self.HangHoaAll(), function (x) {
                return (x.ID_NhomHangHoa === idNhomHHTang && x.ID_NhomHangHoa !== null) || x.ID_DonViQuiDoi === idQuiDoiTang;
            });
            arrHHTang = UpdateGiaBanHangHoa_inList(arrHHTang);
            // add ID_Random for HangTang --> get ID_LoHang for HangKM (save DB)
            for (let i = 0; i < arrHHTang.length; i++) {
                var rd = Math.floor(Math.random() * 100000000 + 1);
                arrHHTang[i].KMHD_IDRandom = 'KMHD_IDRandom' + rd;
            }
            self.HangHoaTang_HoaDons(arrHHTang);
        }
    }
    self.ID_HHTangHoaDon.subscribe(function (newVal) {
        if (newVal !== undefined) {
            var idKhuyenMai = self.ID_KhuyenMai();
            var itemHH = $.grep(self.HangHoaTang_HoaDons(), function (item) {
                return item.KMHD_IDRandom === newVal;
            });
            self.ID_HHTangHoaDon(undefined);
            if (itemHH.length > 0) {
                $(function () {
                    // find all input with id start  'txtAuto' and not id ='txtAuto_'+ idKhuyenMai;
                    $('input[id^=txtAuto_]').not('#txtAuto_' + idKhuyenMai).val('');
                });
                var tienChietKhau = 0;
                var ptChietKhau = 0;
                var giaBan = 0;
                // caculator TienChietKhau,GiaBan by HinhThucKM
                switch (self.HinhThucKM()) {
                    case 11: // giam gia HD
                        break;
                    case 12: // mua hang tang hang
                        tienChietKhau = itemHH[0].GiaBan;
                        ptChietKhau = 0;
                        break;
                    case 13: // giam gia hag/nhomhang
                        break;
                }
                giaBan = itemHH[0].GiaBan - tienChietKhau;
                var quanLyTheoLo = itemHH[0].QuanLyTheoLoHang;
                quanLyTheoLo = (quanLyTheoLo === undefined || quanLyTheoLo === null ? false : quanLyTheoLo);
                var giaVon = itemHH[0].GiaVon;
                var laHangHoa = itemHH[0].LaHangHoa;
                if (!laHangHoa) {
                    giaVon = 0;
                }
                var objHH = {
                    SoThuTu: 1,
                    ID_KhuyenMai: idKhuyenMai, // if hang Tang of HoaDon, assign ID_KhuyenMai
                    MaHangHoa: itemHH[0].MaHangHoa,
                    TenHangHoa: itemHH[0].TenHangHoa,
                    ID_HangHoa: itemHH[0].ID,
                    ThuocTinh_GiaTri: itemHH[0].ThuocTinh_GiaTri,
                    ID_NhomHangHoa: itemHH[0].ID_NhomHangHoa,
                    SoLuong: 1,
                    GiaBan: itemHH[0].GiaBan, // not change price, only change tienchietkhau
                    DonGia: itemHH[0].GiaBan,
                    GiaVon: giaVon,
                    TienChietKhau: tienChietKhau, // Tang hang --> GiamGia = GiaBan
                    PTChietKhau: ptChietKhau, // giam gia: %
                    ThanhTien: giaBan,
                    TonKho: itemHH[0].TonKho,
                    ID_DonViQuiDoi: itemHH[0].ID_DonViQuiDoi,
                    TenDonViTinh: itemHH[0].TenDonViTinh,
                    ID_TangKem: null, // Neu la hang tang cua HoaDon thi ID_TangKem = null
                    TangKem: true,
                    QuanLyTheoLoHang: quanLyTheoLo,
                    ID_LoHang: itemHH[0].ID_LoHang,
                    GhiChu: '',
                    ThanhToan: giaBan,
                    PTThue: 0,
                    TienThue: 0,
                    GhiChu_NVThucHien: '',
                    GhiChu_NVTuVan: '',
                    GhiChu_NVThucHienPrint: '',
                    GhiChu_NVTuVanPrint: '',
                    ThanhPhan_DinhLuong: [],
                    BH_NhanVienThucHien: [],
                    ThanhPhanComBo: [],
                    HangCungLoais: [],
                    HoaHongTruocChietKhau: 0,
                }
                // get TongTienHang of HoaDon
                var lstHD = JSON.parse(localStorage.getItem(lcListHD));
                var itemHD = GetHDOpening_byMaHoaDon(_maHoaDon, lstHD);
                objHH.IDRandomHD = itemHD[0].IDRandom; // assign IDRandomHD for Hang KhuyenMai
                var itemKMHD = $.grep(self.ListKM_ofHoaDon(), function (x) {
                    return x.ID_KhuyenMai === idKhuyenMai;
                });
                // find SoLuongTang phu hop
                var sluongTang_PhuHop = 0;
                for (let j = 0; j < itemKMHD[0].DM_KhuyenMai_ChiTiet.length; j++) {
                    if (itemKMHD[0].DM_KhuyenMai_ChiTiet[j].TongTienHang <= itemHD[0].TongTienHang) {
                        sluongTang_PhuHop = itemKMHD[0].DM_KhuyenMai_ChiTiet[j].SoLuong;
                    }
                }
                // caculator sum Soluong in HHTang
                var sumSL = 0;
                for (let i = 0; i < self.ListKM_ofHoaDon().length; i++) {
                    let itemKM = self.ListKM_ofHoaDon()[i];
                    if (itemKM.ID_KhuyenMai === idKhuyenMai) {
                        for (let j = 0; j < itemKM.HangHoaChoseTangs.length; j++) {
                            var itemHHTang = itemKM.HangHoaChoseTangs[j];
                            sumSL += itemHHTang.SoLuong;
                        }
                    }
                }
                if (sumSL < sluongTang_PhuHop) {
                    // find ListKM_ofHoaDon with ID_KhuyenMai && add objHH --> HangHoaChoseTangs
                    for (let i = 0; i < self.ListKM_ofHoaDon().length; i++) {
                        let itemKM = self.ListKM_ofHoaDon()[i];
                        if (itemKM.ID_KhuyenMai === idKhuyenMai) {
                            var sluongOld = 0;
                            for (let j = 0; j < itemKM.HangHoaChoseTangs.length; j++) {
                                if (itemKM.HangHoaChoseTangs[j].ID_DonViQuiDoi === newVal) {
                                    sluongOld = itemKM.HangHoaChoseTangs[j].SoLuong;
                                    // xoa old
                                    self.ListKM_ofHoaDon()[i].HangHoaChoseTangs.splice(j, 1);
                                    break;
                                }
                            }
                            // ad new
                            objHH.SoLuong = parseFloat(sluongOld) + 1;
                            objHH.ThanhTien = objHH.SoLuong * objHH.GiaBan;
                            objHH.ThanhToan = objHH.ThanhTien;
                            self.ListKM_ofHoaDon()[i].HangHoaChoseTangs.unshift(objHH);
                            break;
                        }
                    }
                }
                else {
                    ShowMessage_Danger('Quá số lượng hàng tặng');
                    return;
                }
                // assign ListKM_ofHoaDon =[] , after push again
                self.HHTangHoaDon_AfterRender(self.ListKM_ofHoaDon());
                self.ListKM_ofHoaDon([]);
                for (let i = 0; i < self.HHTangHoaDon_AfterRender().length; i++) {
                    self.ListKM_ofHoaDon.push(self.HHTangHoaDon_AfterRender()[i]);
                }
            }
        }
    });
    self.EditSoLuongHHTang_HoaDon = function (item) {
        var objNumber = $('#numberTangHD_' + item.ID_DonViQuiDoi);
        var newNumber = parseFloat(objNumber.val());
        if (isNaN(newNumber)) {
            newNumber = 0;
        }
        //objNumber.val(newNumber);
        // find ListKM_ofHoaDon with ID_KhuyenMai && add objHH --> HangHoaChoseTangs
        for (let i = 0; i < self.ListKM_ofHoaDon().length; i++) {
            if (self.ListKM_ofHoaDon()[i].ID_KhuyenMai === item.ID_KhuyenMai) {
                for (let j = 0; j < self.ListKM_ofHoaDon()[i].HangHoaChoseTangs.length; j++) {
                    var itemHHTang = self.ListKM_ofHoaDon()[i].HangHoaChoseTangs[j];
                    // if ID_DonViQuiDoi in HHTang = item.ID_DonViQuiDoi
                    if (itemHHTang.ID_DonViQuiDoi === item.ID_DonViQuiDoi) {
                        self.ListKM_ofHoaDon()[i].HangHoaChoseTangs[j].SoLuong = newNumber;
                    }
                }
                break;
            }
        }
        var lstHD = JSON.parse(localStorage.getItem(lcListHD));
        var itemHD = GetHDOpening_byMaHoaDon(_maHoaDon, lstHD);
        var itemKMHD = $.grep(self.ListKM_ofHoaDon(), function (km) {
            return km.ID_KhuyenMai === item.ID_KhuyenMai;
        });
        // tinh SLTang phu hop voi HH da mua
        var sluongTang_PhuHop = 0;
        for (let j = 0; j < itemKMHD[0].DM_KhuyenMai_ChiTiet.length; j++) {
            if (itemKMHD[0].DM_KhuyenMai_ChiTiet[j].TongTienHang <= itemHD[0].TongTienHang) {
                sluongTang_PhuHop = itemKMHD[0].DM_KhuyenMai_ChiTiet[j].SoLuong;
            }
        }
        // caculator sum Soluong in HHTang
        var sumSL = 0;
        for (let j = 0; j < itemKMHD[0].HangHoaChoseTangs.length; j++) {
            sumSL += parseInt(itemKMHD[0].HangHoaChoseTangs[j].SoLuong);
        }
        if (sumSL > sluongTang_PhuHop) {
            ShowMessage_Danger('Chỉ được tặng tối đa ' + sluongTang_PhuHop + ' sản phẩm');
            return;
        }
    }
    self.GiamSoluongHHTang_HoaDon = function (item) {
        var objNumber = $('#numberTangHD_' + item.ID_DonViQuiDoi);
        var newNumber = parseFloat(objNumber.val());
        if (newNumber > 0) {
            newNumber = newNumber - 1;
            objNumber.val(newNumber);
        }
        for (let i = 0; i < self.ListKM_ofHoaDon().length; i++) {
            if (self.ListKM_ofHoaDon()[i].ID_KhuyenMai === item.ID_KhuyenMai) {
                for (let j = 0; j < self.ListKM_ofHoaDon()[i].HangHoaChoseTangs.length; j++) {
                    var itemHHTang = self.ListKM_ofHoaDon()[i].HangHoaChoseTangs[j];
                    if (itemHHTang.ID_DonViQuiDoi === item.ID_DonViQuiDoi) {
                        self.ListKM_ofHoaDon()[i].HangHoaChoseTangs[j].SoLuong = newNumber;
                        break;
                    }
                }
                break;
            }
        }
        // assign ListKM_ofHoaDon =[] , after push again
        self.HHTangHoaDon_AfterRender(self.ListKM_ofHoaDon());
        self.ListKM_ofHoaDon([]);
        for (let i = 0; i < self.HHTangHoaDon_AfterRender().length; i++) {
            self.ListKM_ofHoaDon.push(self.HHTangHoaDon_AfterRender()[i]);
        }
    }
    self.TangSoluongHHTang_HoaDon = function (item) {
        var lstHD = JSON.parse(localStorage.getItem(lcListHD));
        var itemHD = GetHDOpening_byMaHoaDon(_maHoaDon, lstHD);
        var itemKMHD = $.grep(self.ListKM_ofHoaDon(), function (km) {
            return km.ID_KhuyenMai === item.ID_KhuyenMai;
        });
        // tinh SLTang phu hop voi HH da mua
        var sluongTang_PhuHop = 0;
        for (let j = 0; j < itemKMHD[0].DM_KhuyenMai_ChiTiet.length; j++) {
            if (itemKMHD[0].DM_KhuyenMai_ChiTiet[j].TongTienHang <= itemHD[0].TongTienHang) {
                sluongTang_PhuHop = itemKMHD[0].DM_KhuyenMai_ChiTiet[j].SoLuong;
            }
        }
        // caculator sum Soluong in HHTang
        var sumSL = 0;
        for (let j = 0; j < itemKMHD[0].HangHoaChoseTangs.length; j++) {
            sumSL += parseInt(itemKMHD[0].HangHoaChoseTangs[j].SoLuong);
        }
        var objNumber = $('#numberTangHD_' + item.ID_DonViQuiDoi);
        var newNumber = parseFloat(objNumber.val());
        if (isNaN(newNumber)) {
            newNumber = 0;
        }
        else {
            newNumber = newNumber + 1;
        }
        if (sumSL < sluongTang_PhuHop) {
            objNumber.val(newNumber);
            // find ListKM_ofHoaDon with ID_KhuyenMai && add objHH --> HangHoaChoseTangs
            for (let i = 0; i < self.ListKM_ofHoaDon().length; i++) {
                if (self.ListKM_ofHoaDon()[i].ID_KhuyenMai === item.ID_KhuyenMai) {
                    for (let j = 0; j < self.ListKM_ofHoaDon()[i].HangHoaChoseTangs.length; j++) {
                        var itemHHTang = self.ListKM_ofHoaDon()[i].HangHoaChoseTangs[j];
                        // if ID_DonViQuiDoi in HHTang = item.ID_DonViQuiDoi
                        if (itemHHTang.ID_DonViQuiDoi === item.ID_DonViQuiDoi) {
                            self.ListKM_ofHoaDon()[i].HangHoaChoseTangs[j].SoLuong = newNumber;
                            break;
                        }
                    }
                    break;
                }
            }
            // assign ListKM_ofHoaDon =[] , after push again
            self.HHTangHoaDon_AfterRender(self.ListKM_ofHoaDon());
            self.ListKM_ofHoaDon([]);
            for (let i = 0; i < self.HHTangHoaDon_AfterRender().length; i++) {
                self.ListKM_ofHoaDon.push(self.HHTangHoaDon_AfterRender()[i]);
            }
        }
        else {
            ShowMessage_Danger('Quá số lượng hàng tặng');
            return;
        }
    }
    self.XoaHangTang_HoaDon = function (item) {
        var idQuiDoi = item.ID_DonViQuiDoi;
        var idKhuyenMai = item.ID_KhuyenMai;
        for (let i = 0; i < self.ListKM_ofHoaDon().length; i++) {
            if (self.ListKM_ofHoaDon()[i].ID_KhuyenMai === idKhuyenMai) {
                for (let j = 0; j < self.ListKM_ofHoaDon()[i].HangHoaChoseTangs.length; j++) {
                    var itemHHTang = self.ListKM_ofHoaDon()[i].HangHoaChoseTangs[j];
                    if (itemHHTang.ID_DonViQuiDoi === idQuiDoi) {
                        self.ListKM_ofHoaDon()[i].HangHoaChoseTangs.splice(j, 1);
                    }
                }
                break;
            }
        }
        // assign ListKM_ofHoaDon =[] , after push again
        self.HHTangHoaDon_AfterRender(self.ListKM_ofHoaDon());
        self.ListKM_ofHoaDon([]);
        for (let i = 0; i < self.HHTangHoaDon_AfterRender().length; i++) {
            self.ListKM_ofHoaDon.push(self.HHTangHoaDon_AfterRender()[i]);
        }
    }
    self.ChoseKhuyenMai_HD = function (item) {
        self.HD_KhuyenMai(item.ID_KhuyenMai);
    }
    self.AddKhuyenMai_forHoaDon = function () {
        if (self.HD_KhuyenMai() === undefined) {
            ShowMessage_Danger('Vui lòng chọn chương trình khuyến mại');
            return;
        }
        else {
            var itemKM = $.grep(self.ListKM_ofHoaDon(), function (x) {
                return x.ID_KhuyenMai === self.HD_KhuyenMai();
            });
            if (itemKM.length > 0) {
                if ((itemKM[0].HinhThuc === 12 || itemKM[0].HinhThuc === 13) && itemKM[0].HangHoaChoseTangs.length === 0) {
                    ShowMessage_Danger('Vui lòng chọn hàng hóa khuyến mại');
                    return;
                }
                else {
                    // remove item in HangHoaChoseTangs with SoLuong = 0 if list HangTang > 1
                    var itemHHTang = itemKM[0].HangHoaChoseTangs;
                    if (itemHHTang.length > 1) {
                        itemHHTang = $.grep(itemHHTang, function (x) {
                            return parseFloat(x.SoLuong) > 0;
                        });
                    }
                    var lstHD = JSON.parse(localStorage.getItem(lcListHD));
                    var itemHD = GetHDOpening_byMaHoaDon(_maHoaDon, lstHD);
                    var idRandomHD = itemHD[0].IDRandom;
                    // tinh SLTang, GiamGia phu hop voi TongTienHang (lay KM gan nhat)
                    var sluongTang_PhuHop = 0;
                    var giamGiaHD = 0;
                    var tongtienGG = 0;
                    var isGiamGiaPT = false;
                    for (let j = 0; j < itemKM[0].DM_KhuyenMai_ChiTiet.length; j++) {
                        if (itemKM[0].DM_KhuyenMai_ChiTiet[j].TongTienHang <= itemHD[0].TongTienHang) {
                            sluongTang_PhuHop = itemKM[0].DM_KhuyenMai_ChiTiet[j].SoLuong;
                            giamGiaHD = itemKM[0].DM_KhuyenMai_ChiTiet[j].GiamGia;
                            tongtienGG = itemKM[0].DM_KhuyenMai_ChiTiet[j].TongTienHang;
                            isGiamGiaPT = itemKM[0].DM_KhuyenMai_ChiTiet[j].GiamGiaTheoPhanTram;
                        }
                    }
                    var lstKMCTHD = localStorage.getItem(lcProductKM_HoaDon);
                    if (lstKMCTHD !== null) {
                        lstKMCTHD = JSON.parse(lstKMCTHD);
                        // remove item old in KhuyenMai if same MaHoaDon && add new
                        lstKMCTHD = $.grep(lstKMCTHD, function (x) {
                            return x.IDRandomHD !== idRandomHD;
                        });
                    }
                    else {
                        lstKMCTHD = [];
                    }
                    // caculator sum Soluong in HHTang + save KhuyenMai HoaDon into cache
                    var sumSL = 0;
                    var note_KMaiHD = '';
                    var noteDetail = '';
                    switch (itemKM[0].HinhThuc) {
                        case 11: // giam gia HD --> update ChietKhau, PhaiTT
                            note_KMaiHD = itemKM[0].TenKhuyenMai + ': Tổng tiền hàng từ ' + formatNumber3Digit(tongtienGG)
                                + ' giảm giá ' + giamGiaHD + ' ' + (isGiamGiaPT ? '%' : 'Đ') + ' cho hóa đơn';
                            break;
                        case 12: // tang hang: chietkhau = giaban
                            for (let j = 0; j < itemKM[0].HangHoaChoseTangs.length; j++) {
                                let itemFor = itemKM[0].HangHoaChoseTangs[j];
                                let itemHH = $.grep(self.HangHoaAll(), function (xx) {
                                    return xx.ID_DonViQuiDoi === itemFor.ID_DonViQuiDoi;
                                });
                                sumSL += parseInt(itemFor.SoLuong);
                                itemFor.MaHoaDon = _maHoaDon; // add properties MaHoaDon to do save cache KMai
                                itemFor.TienChietKhau = itemHH[0].GiaBan;
                                itemFor.GiaBan = itemHH[0].GiaBan;
                                itemFor.PTChietKhau = 0;
                                itemFor.ThanhTien = 0;
                                itemFor.ThanhToan = 0;
                                lstKMCTHD.push(itemFor);
                            }
                            break;
                        case 13: // giam gia: giaban = giaban - giamgia
                            for (let j = 0; j < itemKM[0].HangHoaChoseTangs.length; j++) {
                                let itemFor = itemKM[0].HangHoaChoseTangs[j];
                                let itemHH = $.grep(self.HangHoaAll(), function (xx) {
                                    return xx.ID_DonViQuiDoi === itemFor.ID_DonViQuiDoi;
                                });
                                sumSL += parseInt(itemFor.SoLuong);
                                itemFor.MaHoaDon = _maHoaDon; // add properties MaHoaDon to do save cache KMai
                                //itemFor.ID_User = id_User;
                                itemFor.GiaBan = itemHH[0].GiaBan;
                                var tienChietKhau = giamGiaHD;
                                var ptChietKhau = 0;
                                if (isGiamGiaPT) {
                                    tienChietKhau = itemHH[0].GiaBan * giamGiaHD / 100;
                                    ptChietKhau = giamGiaHD;
                                }
                                itemFor.TienChietKhau = tienChietKhau;
                                itemFor.PTChietKhau = ptChietKhau;
                                itemFor.ThanhTien = itemFor.SoLuong * (itemFor.GiaBan - tienChietKhau);
                                itemFor.ThanhToan = itemFor.ThanhTien;
                                lstKMCTHD.push(itemFor);
                            }
                            break;
                        case 14:// tang diem
                            note_KMaiHD = itemKM[0].TenKhuyenMai + ': Tổng tiền hàng từ ' + formatNumber3Digit(tongtienGG) + ' tặng ' + giamGiaHD + ' ' + (isGiamGiaPT ? ' % điểm' : ' điểm') + ' cho hóa đơn';
                            break;
                    }
                    // Nếu nhập sumSoLuong > sluongTang cho phep --> gán số lượng max cho Sp đầu tiên & remove item con lai
                    if (itemKM[0].HinhThuc === 12 || (itemKM[0].HinhThuc === 13)) {
                        var indexMin = 0;
                        if (sumSL > sluongTang_PhuHop) {
                            for (let i = 0; i < lstKMCTHD.length; i++) {
                                if (lstKMCTHD[i].IDRandomHD === idRandomHD) {
                                    lstKMCTHD[i].SoLuong = sluongTang_PhuHop;
                                    lstKMCTHD[i].ThanhTien = (lstKMCTHD[i].GiaBan - lstKMCTHD[i].TienChietKhau) * sluongTang_PhuHop;
                                    lstKMCTHD[i].ThanhToan = lstKMCTHD[i].ThanhTien;
                                    indexMin = i;
                                    break;
                                }
                            }
                            // remove item con lai
                            for (let i = 0; i < lstKMCTHD.length; i++) {
                                if (lstKMCTHD[i].IDRandomHD === idRandomHD && i > indexMin) {
                                    lstKMCTHD.splice(i, 1);
                                    break;
                                }
                            }
                        }
                        else {
                            // neu chua du sltang --> gan sluong = max - sum (sluong) cho Sp dau tien (OK)
                            if (sumSL < sluongTang_PhuHop) {
                                var slThieu = sluongTang_PhuHop - sumSL;
                                for (let i = 0; i < lstKMCTHD.length; i++) {
                                    if (lstKMCTHD[i].IDRandomHD === idRandomHD) {
                                        lstKMCTHD[i].SoLuong = parseFloat(lstKMCTHD[i].SoLuong) + slThieu;
                                        lstKMCTHD[i].ThanhTien = (lstKMCTHD[i].GiaBan - lstKMCTHD[i].TienChietKhau) * lstKMCTHD[i].SoLuong;
                                        lstKMCTHD[i].ThanhToan = lstKMCTHD[i].ThanhTien;
                                        break;
                                    }
                                }
                            }
                        }
                        // update SoThuTu in productKM_HoaDon
                        for (let i = 0; i < lstKMCTHD.length; i++) {
                            if (lstKMCTHD[i].IDRandomHD === idRandomHD) {
                                lstKMCTHD[i].SoThuTu = (i + 1);
                            }
                        }
                        localStorage.setItem(lcProductKM_HoaDon, JSON.stringify(lstKMCTHD));
                        // get noteDetail if HinhThuc = 12 Or 13
                        if (itemKM[0].HinhThuc === 12) {
                            for (let i = 0; i < lstKMCTHD.length; i++) {
                                if (lstKMCTHD[i].IDRandomHD === idRandomHD) {
                                    noteDetail += lstKMCTHD[i].SoLuong + ' ' + lstKMCTHD[i].MaHangHoa + ' ,';
                                }
                            }
                            note_KMaiHD = itemKM[0].TenKhuyenMai + ': Tổng tiền hàng từ ' + formatNumber3Digit(tongtienGG) + ' tặng ' + noteDetail;
                        }
                        else {
                            for (let i = 0; i < lstKMCTHD.length; i++) {
                                if (lstKMCTHD[i].IDRandomHD === idRandomHD) {
                                    noteDetail += giamGiaHD + ' ' + (isGiamGiaPT ? '%' : 'Đ')
                                        + ' cho ' + lstKMCTHD[i].SoLuong + ' ' + lstKMCTHD[i].MaHangHoa + ' ,';
                                }
                            }
                            note_KMaiHD = itemKM[0].TenKhuyenMai + ': Tổng tiền hàng từ ' + formatNumber3Digit(tongtienGG) + ' giảm giá ' + noteDetail;
                        }
                    }
                    // bind lst HHTang of HoaDon
                    var arrKM_HoaDon = $.grep(lstKMCTHD, function (x) {
                        return x.IDRandomHD === idRandomHD;
                    });
                    self.HHTang_HoaDon(arrKM_HoaDon);

                    // sum hangtanghoason
                    var sumHangTang = 0;
                    for (let i = 0; i < self.HHTang_HoaDon().length; i++) {
                        sumHangTang += self.HHTang_HoaDon()[i].ThanhTien;
                    }

                    // update again TongTienhang (bao gồm hàng tặng)
                    for (let i = 0; i < lstHD.length; i++) {
                        if (lstHD[i].IDRandom === idRandomHD) {
                            lstHD[i].IsOpeningKMaiHD = true;
                            lstHD[i].ID_KhuyenMai = self.HD_KhuyenMai(); // assign ID_KhuyenMai to do save DB
                            lstHD[i].KhuyenMai_GhiChu = Remove_LastComma(note_KMaiHD);
                            lstHD[i].TongTienHang = lstHD[i].TongTienHang + sumHangTang;
                            if (lstHD[i].TongChietKhau > 0) {
                                lstHD[i].TongGiamGia = lstHD[i].TongChietKhau * lstHD[i].PhaiThanhToan / 100;
                            }
                            // chi update GiamGia neu la KM HoaDon - giamgiaHang
                            if (itemKM[0].HinhThuc === 11) {
                                if (isGiamGiaPT) {
                                    lstHD[i].PTGiam_KM = giamGiaHD;
                                    lstHD[i].KhuyeMai_GiamGia = lstHD[i].TongTienHang * giamGiaHD / 100;
                                }
                                else {
                                    lstHD[i].PTGiam_KM = 0;
                                    lstHD[i].KhuyeMai_GiamGia = giamGiaHD;
                                }
                            }
                            else {
                                lstHD[i].PTGiam_KM = 0;
                                lstHD[i].KhuyeMai_GiamGia = 0;
                            }
                            lstHD[i].TongGiamGiaKM_HD = lstHD[i].TongGiamGia + lstHD[i].KhuyeMai_GiamGia;
                            // truong hop KH DatHang va da thanh toan truoc
                            var phaiTT = lstHD[i].TongTienHang - lstHD[i].TongGiamGiaKM_HD - lstHD[i].KhachDaTra;
                            if (phaiTT < 0) {
                                // neu gg > tong tien hang: hoan tra = 0
                                if (lstHD[i].TongGiamGiaKM_HD > lstHD[i].TongTienHang) {
                                    lstHD[i].HoanTraTamUng = 0;
                                }
                                else {
                                    lstHD[i].HoanTraTamUng = phaiTT * (-1);
                                }
                            }
                            else {
                                lstHD[i].HoanTraTamUng = 0;
                            }
                            lstHD[i].PhaiThanhToan = phaiTT + lstHD[i].KhachDaTra;
                            lstHD[i].TongThanhToan = lstHD[i].PhaiThanhToan;
                            lstHD[i].DaThanhToan = phaiTT > 0 ? phaiTT : 0;
                            lstHD[i].TienMat = lstHD[i].DaThanhToan;
                            itemHD = lstHD[i];
                            break;
                        }
                    }
                    localStorage.setItem(lcListHD, JSON.stringify(lstHD));
                    UpdateChietKhauHD_NhanVien(idRandomHD);
                    self.HoaDons().SetData(itemHD);
                    localStorage.setItem(lcMaHD, _maHoaDon);
                    $('#promotiont_Parent').modal('hide');
                    // this code must before update DiemGiaoDichHoaDon (must set ThietLapTichDiem = true)
                    if (itemKM[0].HinhThuc === 14) {
                        if (self.ThietLap_TichDiem().length > 0) {
                            var quydoiDiemKM = Math.floor(formatNumberToInt(itemHD.PhaiThanhToan) / self.ThietLap_TichDiem()[0].TyLeDoiDiem);
                            if (isGiamGiaPT) {
                                // tinh diem
                                quydoiDiemKM = Math.floor(giamGiaHD / 100 * quydoiDiemKM);
                            }
                            else {
                                quydoiDiemKM = giamGiaHD;
                                // if not cong % diem --> khong tru diem cong
                            }
                            UpdateDiemCong_KMCongDiem(idRandomHD, quydoiDiemKM, true);
                        }
                    }
                    UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();
                    Caculator_AmountProduct();
                }
            }
        }
    }

    self.DH_ListPage = ko.observableArray();
    self.DH_PageView = ko.observable();
    self.DH_IsNext = ko.observable();
    self.DH_IsPrev = ko.observable();

    self.GetBaoGia_byPhieuTiepNhan = function () {
        var matn = $('#jqAutoPhieuTN .gara-search-HH').val().split('_');
        if (matn.length > 0) {
            matn = matn[0];
        }
        else {
            matn = '';
        }
        $('#modalPopuplgDatHang').modal('show');
        self.filterFromDateDH('01/01/2016');
        self.filterToDateDH(moment(new Date()).format('DD/MM/YYYY'));
        self.currentPageDH(0);
        self.filterMaHD(matn);
        SearchHoaDonDatHang();
    }
    // Search and paging DatHang
    self.showpopupDatHang = function () {
        $('#modalPopuplgDatHang').modal('show');
        self.filterFromDateDH(moment(new Date()).add(-2, 'month').format('DD/MM/YYYY'));
        self.filterToDateDH(moment(new Date()).format('DD/MM/YYYY'));
        self.filterMaHD('');
        self.currentPageDH(0);
        SearchHoaDonDatHang();
    }

    self.PageListDH = ko.computed(function () {
        var arrPage = [];
        var allPage = self.PageCountDH();
        var currentPage = self.currentPageDH();
        if (allPage > 4) {
            var i = 0;
            if (currentPage === 0) {
                i = parseInt(self.currentPageDH()) + 1;
            }
            else {
                i = self.currentPageDH();
            }
            if (allPage >= 5 && currentPage > allPage - 5) {
                if (currentPage >= allPage - 2) {
                    // get 5 trang cuoi cung
                    for (let i = allPage - 5; i < allPage; i++) {
                        let obj = {
                            pageNumber: i + 1,
                        };
                        arrPage.push(obj);
                    }
                }
                else {
                    if (currentPage === 1) {
                        for (let j = currentPage - 1; (j <= currentPage + 3) && j < allPage; j++) {
                            let obj = {
                                pageNumber: j + 1,
                            };
                            arrPage.push(obj);
                        }
                    }
                    else {
                        // get currentPage - 2 , currentPage, currentPage + 2
                        for (let j = currentPage - 2; (j <= currentPage + 2) && j < allPage; j++) {
                            let obj = {
                                pageNumber: j + 1,
                            };
                            arrPage.push(obj);
                        }
                    }
                }
            }
            else {
                // get 5 trang dau
                if (i >= 2) {
                    while (arrPage.length < 5) {
                        let obj = {
                            pageNumber: i - 1,
                        };
                        arrPage.push(obj);
                        i = i + 1;
                    }
                }
                else {
                    while (arrPage.length < 5) {
                        let obj = {
                            pageNumber: i,
                        };
                        arrPage.push(obj);
                        i = i + 1;
                    }
                }
            }
        }
        else {
            // neu chi co 1 trang --> khong hien thi DS trang
            if (allPage > 1) {
                for (let i = 0; i < allPage; i++) {
                    let obj = {
                        pageNumber: i + 1,
                    };
                    arrPage.push(obj);
                }
            }
        }
        return arrPage;
    });
    self.PageResultDH = ko.computed(function () {
        if (self.HoaDonDHs() !== null) {
            if (self.HoaDonDHs().length === 0) {
                self.fromitem(0);
            }
            else {
                self.fromitem((self.currentPageDH() * self.pageSizeDH()) + 1);
            }
            if (((self.currentPageDH() + 1) * self.pageSizeDH()) > self.HoaDonDHs().length) {
                var fromItem = (self.currentPageDH() + 1) * self.pageSizeDH();
                if (fromItem < self.TotalRecordDH()) {
                    self.toitem((self.currentPageDH() + 1) * self.pageSizeDH());
                }
                else {
                    self.toitem(self.TotalRecordDH());
                }
            } else {
                self.toitem((self.currentPageDH() * self.pageSizeDH()) + self.pageSizeDH());
            }
        }
    });
    self.VisibleStartPageDH = ko.computed(function () {
        if (self.PageListDH().length > 0) {
            return self.PageListDH()[0].pageNumber !== 1;
        }
    });
    self.VisibleEndPageDH = ko.computed(function () {
        if (self.PageListDH().length > 0) {
            return self.PageListDH()[self.PageListDH().length - 1].pageNumber !== self.PageCountDH();
        }
    });

    self.GetClassDH = function (page) {
        return ((page.pageNumber - 1) === self.currentPageDH()) ? "click" : "";
    };
    self.StartPageDH = function () {
        self.currentPageDH(0);
        SearchHoaDonDatHang(true);
    }
    self.BackPageDH = function () {
        if (self.currentPageDH() > 1) {
            self.currentPageDH(self.currentPageDH() - 1);
            SearchHoaDonDatHang(true);
        }
    }
    self.GoToNextPageDH = function () {
        if (self.currentPageDH() < self.PageCountDH() - 1) {
            self.currentPageDH(self.currentPageDH() + 1);
            SearchHoaDonDatHang(true);
        }
    }
    self.EndPageDH = function () {
        if (self.currentPageDH() < self.PageCountDH() - 1) {
            self.currentPageDH(self.PageCountDH() - 1);
            SearchHoaDonDatHang(true);
        }
    }
    // Search and Paging Dat Hang popup 
    $('#txtMaHoaDonDH').keypress(function (e) {
        if (e.keyCode === 13) {
            self.currentPageDH(0);
            SearchHoaDonDatHang();
        }
    });
    self.filterFromDateDH.subscribe(function () {
        self.currentPageDH(0);
        SearchHoaDonDatHang();
    });
    self.filterToDateDH.subscribe(function () {
        self.currentPageDH(0);
        SearchHoaDonDatHang();
    });
    self.GoToPageDH = function (page) {
        self.currentPageDH(page.pageNumber - 1);
        SearchHoaDonDatHang(true);
    };
    function SearchHoaDonDatHang() {
        var txtSearch = self.filterMaHD();
        var txtFromDate = self.filterFromDateDH();
        var txtToDate = self.filterToDateDH();
        if (txtFromDate === undefined || txtFromDate === '') {
            ShowMessage_Danger('Vui lòng chọn thời gian');
            return;
        }
        if (txtToDate === undefined || txtToDate === '') {
            ShowMessage_Danger('Vui lòng chọn thời gian');
            return;
        }
        txtFromDate = moment(txtFromDate, 'DD/MM/YYYY').format('YYYY-MM-DD');
        txtToDate = moment(txtToDate, 'DD/MM/YYYY').add(1, 'days').format('YYYY-MM-DD');

        var Params_GetListHoaDon = {
            LoaiHoaDon: 3,
            MaHoaDon: txtSearch,
            ID_ChiNhanhs: [id_DonVi],
            ID_NhanViens: [], // NVBan
            NguoiTao: userLogin, // nguoitaoHD
            NgayTaoHD_TuNgay: txtFromDate,
            NgayTaoHD_DenNgay: txtToDate,
            TrangThai: 12,
            CurrentPage: self.currentPageDH(),
            PageSize: self.pageSizeDH(),
        }
        // get list HoaDon
        ajaxHelper(BHHoaDonUri + 'GetHD_CTHDDatHang_afterMuaHang', 'POST', Params_GetListHoaDon).done(function (data) {
            if (data !== null) {
                self.HoaDonDHs(data.lstCH);
                self.TotalRecordDH(data.Rowcount);
                self.PageCountDH(data.pageCount);
            }
            else {
                self.HoaDonDHs([]);
                self.TotalRecordDH(0);
                self.PageCountDH(0);
            }
        });
    }

    function GetPTChietKhauHang_DB(cthd) {
        var ptCKHang = 0;
        var arr = $.grep(cthd, function (x) {
            return x.PTChietKhau === cthd[0].PTChietKhau;
        });
        if (arr.length === cthd.length) {
            ptCKHang = cthd[0].PTChietKhau;
        }
        return {
            PTChietKhauHH: ptCKHang,
        }
    }

    function AssignTPDinhLuong_toCTHD(itemCT) {
        if (itemCT.ThanhPhan_DinhLuong !== null && itemCT.ThanhPhan_DinhLuong !== undefined) {
            for (let k = 0; k < itemCT.ThanhPhan_DinhLuong.length; k++) {
                let tpDL = itemCT.ThanhPhan_DinhLuong[k];
                itemCT.ThanhPhan_DinhLuong[k].STT = k + 1;
                itemCT.ThanhPhan_DinhLuong[k].isDefault = false;
                itemCT.ThanhPhan_DinhLuong[k].SoLuongQuyCach = tpDL.SoLuong * tpDL.QuyCach;
                itemCT.ThanhPhan_DinhLuong[k].SoLuongMacDinh = itemCT.ThanhPhan_DinhLuong[k].SoLuong / itemCT.SoLuong;
                itemCT.ThanhPhan_DinhLuong[k].GiaVonAfter = tpDL.SoLuong * tpDL.GiaVon;
            }

            if (!commonStatisJs.CheckNull(itemCT.HangCungLoais)) {
                for (let i = 0; i < itemCT.HangCungLoais.length; i++) {
                    let cloai = itemCT.HangCungLoais[i];
                    for (let k = 0; k < cloai.ThanhPhan_DinhLuong.length; k++) {
                        let tpDL = cloai.ThanhPhan_DinhLuong[k];
                        cloai.ThanhPhan_DinhLuong[k].STT = k + 1;
                        cloai.ThanhPhan_DinhLuong[k].isDefault = false;
                        cloai.ThanhPhan_DinhLuong[k].SoLuongQuyCach = tpDL.SoLuong * tpDL.QuyCach;
                        cloai.ThanhPhan_DinhLuong[k].SoLuongMacDinh = tpDL.SoLuong / cloai.SoLuong;
                        cloai.ThanhPhan_DinhLuong[k].GiaVonAfter = tpDL.SoLuong * tpDL.GiaVon;
                    }
                }
            }
        }
        else {
            itemCT.ThanhPhan_DinhLuong = [];
        }
        return itemCT;
    }

    function AssignThanhPhanComBo_toCTHD(itemCT) {
        if (itemCT.ThanhPhanComBo !== null && itemCT.ThanhPhanComBo !== undefined) {
            itemCT.ThanhPhanComBo = itemCT.ThanhPhanComBo.filter(x => x.SoLuongConLai > 0);
            for (let k = 0; k < itemCT.ThanhPhanComBo.length; k++) {
                let combo = itemCT.ThanhPhanComBo[k];
                if (itemCT.LoaiHoaDon === 6) {
                    combo.SoLuong = 0;
                    combo.ThanhTien = 0;
                    combo.PTChietKhau = 0;
                    combo.TienChietKhau = 0;
                    combo.ThanhToan = 0;
                    combo.ID_ChiTietGoiDV = combo.ID;
                    combo.SoLuongDaMua = combo.SoLuongConLai;
                    combo.GiaBan = combo.DonGia - combo.GiamGia;
                    combo.DonGia = combo.GiaBan;
                    combo.SoLuongMacDinh = itemCT.SoLuongDaMua == 0 ? combo.SoLuongConLai : combo.SoLuongConLai / itemCT.SoLuongDaMua;
                    combo.ThanhPhan_DinhLuong = [];
                }
                else {
                    combo.SoLuongMacDinh = itemCT.SoLuong === 0 ? combo.SoLuong : combo.SoLuong / itemCT.SoLuong;
                    combo.SoLuongDaMua = 0;
                    combo = AssignTPDinhLuong_toCTHD(combo);
                }

                let dateLot1 = GetNgaySX_NgayHH(combo);
                combo.NgaySanXuat = dateLot1.NgaySanXuat;
                combo.NgayHetHan = dateLot1.NgayHetHan;
                combo.LotParent = false;
                combo.DM_LoHang = [];

                combo.IDRandom = CreateIDRandom('combo_');
                combo.IDRandomHD = itemCT.IDRandomHD;
                combo.LoaiHoaDon = itemCT.LoaiHoaDon;
                combo.MaHoaDon = itemCT.MaHoaDon;
                combo.ID_ViTri = itemCT.ID_ViTri;
                combo.TenViTri = itemCT.TenPhongBan;
                combo.ChatLieu = itemCT.ChatLieu;

                combo.DVTinhGiam = "%";
                combo.GhiChu_NVThucHien = '';
                combo.GhiChu_NVThucHienPrint = '';
                combo.GhiChu_NVTuVan = '';
                combo.GhiChu_NVTuVanPrint = '';
                combo.CssWarning = false;
                combo.IsKhuyenMai = false;
                combo.IsOpeningKMai = false;
                combo.TenKhuyenMai = '';
                combo.HangHoa_KM = [];
                combo.UsingService = false;
                combo.ListDonViTinh = [];
                combo.SoLuongQuyCach = 0;
                combo.BH_NhanVienThucHien = [];// tru hoahong by hoadonmua (at DB)
                combo.DM_LoHang = [];
                combo.HangCungLoais = [];
                combo.LaConCungLoai = false;
                combo.LotParent = false;
                combo.TimeStart = 0;
                combo.QuaThoiGian = 0;
                combo.TimeRemain = 0;
                combo.ThoiGian = moment(new Date()).format('YYYY-MM-DD HH:mm');
            }
        }
        else {
            itemCT.ThanhPhanComBo = [];
        }
        return itemCT;
    }

    self.clickXuLiDonHang = function (item) {
        $('#modalPopuplgDatHang').modal('hide');
        localStorage.setItem('gara_CreateFrom', 'TN_xulyBG');
        self.DateHDDefault(moment(serverTime).format('DD/MM/YYYY'));
        self.TimeHDDefault(moment(serverTime).format('HH:mm'));
        var phaiTT = item.PhaiThanhToan - item.KhachDaTra;
        var dvtGiam = 'VND';
        if (item.TongChietKhau > 0) {
            dvtGiam = '%';
        }
        if (item.ID_BangGia === null) {
            item.ID_BangGia = const_GuidEmpty;
        }
        var idRandomHD = CreateIDRandom('HD_');
        var itemNew = {
            ID: item.ID,
            ID_HoaDon: null,
            IDRandom: idRandomHD,
            MaHoaDon: item.MaHoaDon,
            MaHoaDonDB: null,
            LoaiHoaDon: 3,
            ID_DoiTuong: item.ID_DoiTuong,
            ID_DonVi: id_DonVi,
            NguoiTao: userLogin,
            ID_BangGia: item.ID_BangGia,
            ID_NhanVien: _idNhanVien,
            ID_User: id_User,
            NgayLapHoaDon: moment(item.NgayLapHoaDon).format('YYYY-MM-DD HH:mm'),
            TongTienHang: item.TongTienHang,
            TongGiamGia: item.TongGiamGia,
            KhachDaTra: item.KhachDaTra,// lấy đúng số tiền khách đã thanh toán ở báo giá
            BaoHiemDaTra: 0,// todo
            PTThueHoaDon: item.PTThueHoaDon, // vi DB khong co truong luu % thue, nen phai chia deu thue
            TongTienThue: item.TongTienThue,
            PTThueBaoHiem: item.PTThueBaoHiem,
            TongTienThueBaoHiem: item.TongTienThueBaoHiem,
            ChoThanhToan: false,
            DienGiai: '',
            TienGui: 0,
            TienThua: 0,
            Status: 1,
            StatusOffline: false,
            DVTinhGiam: dvtGiam,
            TongChietKhau: item.TongChietKhau, // PTGiam
            DaThanhToan: 0,
            PhaiThanhToan: item.PhaiThanhToan,
            TienMat: phaiTT,
            // Tra Hang
            PhaiThanhToanDB: 0,
            TongGiaGocHangTra: 0,
            TongChiPhi: item.TongChiPhi,
            TongChiPhiHangTra: 0,
            HoanTraThuKhac: 0,
            TongTienTra: 0,
            PhaiTraKhach: 0,
            DaTraKhach: 0,
            GiaoHang: false,
            TongGiamGiaDB: item.TongGiamGia, // used to caculator agiain TongGiamGia of HD was creat from HdDatHang (if HDDatHang change)
            PTGiamDB: 0,
            TongTienMua: 0,
            TongThueDB: 0,
            PTThueDB: 0,
            TrangThaiHD: 6,

            IsActive: '',
            YeuCau: item.YeuCau,
            IsChose: true, // tức là đang thao tác với hóa đơn này
            HoanTraTamUng: 0,

            IsKhuyenMaiHD: false,
            IsOpeningKMaiHD: false,
            KhuyeMai_GiamGia: 0,
            TongGiamGiaKM_HD: item.TongGiamGia, // to do bind GiamGia
            // TichDiem
            DiemGiaoDich: 0,
            TTBangDiem: 0,
            DiemQuyDoi: 0,
            DiemHienTai: 0,
            DiemGiaoDichDB: 0,
            // use when KM_Cong diem
            DiemCong: 0,
            DiemKhuyenMai: 0,
            // Goi dich vu
            NgayApDungGoiDV: null,
            HanSuDungGoiDV: null,
            // check when change infor HD,CTHD of HDDatHang is XuLY
            IsChangeHDXuLy: false,
            BH_NhanVienThucHiens: [],
            TienTheGiaTri: 0,
            ThoiGianThucHien: 0,
            TenViTriHD: '',
            ID_ViTri: null,
            //TenNhanVien: item.TenNhanVien,

            BienSo: item.BienSo,
            ID_Xe: item.ID_Xe,
            MaPhieuTiepNhan: item.MaPhieuTiepNhan,
            ID_PhieuTiepNhan: item.ID_PhieuTiepNhan,
            ID_BaoHiem: item.ID_BaoHiem,
            LienHeBaoHiem: item.LienHeBaoHiem,
            SoDienThoaiLienHeBaoHiem: item.SoDienThoaiLienHeBaoHiem,
            PhaiThanhToanBaoHiem: 0,
            ChiPhi_GhiChu: '',
            TongThanhToan: item.TongThanhToan,
            TenBaoHiem: item.TenBaoHiem,
            XuatKhoAll: false,
            DuyetBaoGia: !item.ChoThanhToan,

            PTChietKhauHH: 0,
            TongGiamGiaHang: 0,
            TongTienHangChuaCK: 0,
            TongTienKhuyenMai_CT: 0,
            TongGiamGiaKhuyenMai_CT: 0,
            SoDuDatCoc: 0,

            SoVuBaoHiem: '',
            KhauTruTheoVu: 0,
            GiamTruBoiThuong: 0,
            PTGiamTruBoiThuong: 0,
            TongTienThueBaoHiem: 0,
            PTThueBaoHiem: 0,
            BHThanhToanTruocThue: 0,
            TongTienBHDuyet: 0,
            CongThucBaoHiem: 0,
            TongThueKhachHang: item.TongTienThue,
            PTThueKhachHang: 0,
            GiamTruThanhToanBaoHiem: 0,
            HeaderBH_Type: 1,
            HeaderBH_GiaTriPtram: 0,
        }

        var tonggiamgiahang = item.BH_HoaDon_ChiTiet.reduce(function (x, item) {
            return x + (item.TienChietKhau * item.SoLuong);
        }, 0);
        var tongtienhangchuaCK = item.BH_HoaDon_ChiTiet.reduce(function (x, item) {
            return x + item.TienChietKhau;
        }, 0);

        var objCK = GetPTChietKhauHang_DB(item.BH_HoaDon_ChiTiet);
        itemNew.TongGiamGiaHang = tonggiamgiahang;
        itemNew.TongTienHangChuaCK = tongtienhangchuaCK;
        itemNew.PTChietKhauHH = objCK.PTChietKhauHH;

        // save cache lcXuLiDonHang to arrayJson --> xu li nhieu DH cung 1 luc
        var lcXuLiDonHang = localStorage.getItem(lcXuLiDonHang_Const);
        if (lcXuLiDonHang === null) {
            lcXuLiDonHang = [];
        }
        else {
            lcXuLiDonHang = JSON.parse(lcXuLiDonHang);
            // remove & add again
            lcXuLiDonHang = $.grep(lcXuLiDonHang, function (itemXL) {
                return itemXL.MaHoaDon !== item.MaHoaDon;
            });
        }
        lcXuLiDonHang.push(itemNew);
        localStorage.setItem(lcXuLiDonHang_Const, JSON.stringify(lcXuLiDonHang));
        localStorage.setItem(lcMaHD, itemNew.MaHoaDon);// set cache mahoadon --> get at getlisthoadonle (use if have many hd dangxuly)

        var lcCTDatHang = localStorage.getItem(lcCTDatHang_Const);
        if (lcCTDatHang === null) {
            lcCTDatHang = [];
        }
        else {
            // remove lcCTDatHang if exist
            lcCTDatHang = JSON.parse(lcCTDatHang);
            lcCTDatHang = $.grep(lcCTDatHang, function (x) {
                return x.MaHoaDon !== item.MaHoaDon;
            });
        }

        // order by SoThuTu ASC --> group Hang Hoa by LoHang
        var cthd = item.BH_HoaDon_ChiTiet.sort(function (a, b) {
            var x = a.SoThuTu,
                y = b.SoThuTu;
            return x < y ? -1 : x > y ? 1 : 0;
        });

        var arrIDQuiDoi = [];
        var cthdLoHang = [];
        for (let i = 0; i < cthd.length; i++) {
            delete cthd[i]["ID_HoaDon"];  // delete avoid error
            cthd[i].MaHoaDon = item.MaHoaDon;
            cthd[i].LoaiHoaDon = 3;
            cthd[i].SoLuongDaMua = 0;
            cthd[i].TienChietKhau = cthd[i].GiamGia;
            cthd[i].DVTinhGiam = 'VND';
            cthd[i].GiaBan = cthd[i].DonGia;
            if (cthd[i].PTChietKhau > 0) {
                cthd[i].DVTinhGiam = '%';
            }
            // lo hang
            let quanlytheolo = cthd[i].QuanLyTheoLoHang;
            cthd[i].DM_LoHang = [];
            cthd[i].LotParent = quanlytheolo;
            cthd[i].ID_ChiTietGoiDV = null;
            cthd[i].ChatLieu = '3';
            let quycach = cthd[i].QuyCach === null || cthd[i].QuyCach === 0 ? 1 : cthd[i].QuyCach;
            cthd[i].QuyCach = quycach;
            cthd[i].CssWarning = !self.ThietLap().DatHangXuatAm && cthd[i].LoaiHangHoa === 1 && cthd[i].SoLuong > cthd[i].TonKho;
            cthd[i] = SetDefaultPropertierCTHD(cthd[i]);

            let lotNSX = GetNgaySX_NgayHH(cthd[i]);
            cthd[i].NgaySanXuat = lotNSX.NgaySanXuat;
            cthd[i].NgayHetHan = lotNSX.NgayHetHan;

            if (commonStatisJs.CheckNull(cthd[i].DonGiaBaoHiem)) {
                cthd[i].DonGiaBaoHiem = 0;
            }

            cthd[i] = AssignTPDinhLuong_toCTHD(cthd[i]);
            cthd[i] = AssignThanhPhanComBo_toCTHD(cthd[i]);

            // check exist in cthdLoHang
            let objLot = {};
            if ($.inArray(cthd[i].ID_DonViQuiDoi, arrIDQuiDoi) === -1) {
                arrIDQuiDoi.unshift(cthd[i].ID_DonViQuiDoi);
                // push CTHD
                cthd[i].SoThuTu = cthdLoHang.length + 1;
                cthd[i].IDRandom = CreateIDRandom('RandomCT_');
                cthd[i].IDRandomHD = idRandomHD;

                if (quanlytheolo) {
                    objLot = $.extend({}, cthd[i]);
                    objLot.HangCungLoais = [];
                    objLot.DM_LoHang = [];
                    cthd[i].DM_LoHang.push(objLot);
                }
                cthdLoHang.unshift(cthd[i]);
            }
            else {
                // find in cthdLoHang with same ID_QuiDoi
                for (let j = 0; j < cthdLoHang.length; j++) {
                    if (cthdLoHang[j].ID_DonViQuiDoi === cthd[i].ID_DonViQuiDoi) {
                        if (quanlytheolo) {
                            objLot = $.extend({}, cthd[i]);
                            objLot.IDRandom = CreateIDRandom('RandomCT_');
                            objLot.HangCungLoais = [];
                            objLot.DM_LoHang = [];
                            objLot.LotParent = false;
                            cthdLoHang[j].DM_LoHang.push(objLot);
                        }
                        else {
                            cthd[i].IDRandom = CreateIDRandom('RandomCT_');
                            cthd[i].LaConCungLoai = true;
                            cthdLoHang[j].HangCungLoais.push(cthd[i]);
                        }
                        break;
                    }
                }
            }
        }

        for (let i = 0; i < cthdLoHang.length; i++) {
            lcCTDatHang.push(cthdLoHang[i]);
        }

        localStorage.setItem(lcCTDatHang_Const, JSON.stringify(lcCTDatHang));
        localStorage.setItem('gara_CreateFrom', 'TN_xulyBG');

        // add into cache HD, CTHD and bind
        getListHoaDonLe();
        ActiveTab_SoDoPhong(false);

    }
    // hide popup -> alway focus in txtSearchHH
    $('.modal').on('hidden.bs.modal', function () {
        $('#txtSearchHH').focus();
    })
    //trinhpv import hóa đơn, báo giá
    self.ShowmyModalinport = function () {
        var loaiHD = self.HoaDons().LoaiHoaDon();
        if (loaiHD === 6) {
            ShowMessage_Danger('Không import hóa đơn trả từ file excel');
            return false;
        }
        $('#myModalinport').modal('show');
    }
    var DMHangHoaUri = '/api/DanhMuc/DM_HangHoaAPI/';
    self.DownloadFileTeamplateXLS = function () {
        var url = DMHangHoaUri + "Download_TeamplateImport?fileSave=" + "FileImport_HangHoaHoaDon_LoHang.xls";
        window.open(url);
    }
    self.DownloadFileTeamplateXLSX = function () {
        var url = DMHangHoaUri + "Download_TeamplateImport?fileSave=" + "FileImport_HangHoaHoaDon_LoHang.xlsx";
        window.open(url)
    }
    self.fileNameExcel = ko.observable("Lựa chọn file Excel...");
    self.visibleImport = ko.observable(true);
    self.notvisibleImport = ko.computed(function () {
        return !self.visibleImport();
    });
    self.refreshFileSelect = function () {
        self.visibleImport(true);
        self.fileNameExcel("Lựa chọn file Excel...");
        $(".filterFileSelect").hide();
        $(".btnImportExcel").hide();
        document.getElementById('imageUploadForm').value = "";
    }
    $(".filterFileSelect").hide();
    $(".btnImportExcel").hide();
    self.SelectedFileImport = function (vm, evt) {
        if (evt.target.files.length > 0) {
            self.visibleImport(false);
            self.fileNameExcel(evt.target.files[0].name)
            $(".filterFileSelect").show();
            $(".btnImportExcel").show();
            $(".NoteImport").show();
            $(".BangBaoLoi").hide();
        }
    }
    self.loiExcel = ko.observableArray();
    self.DanhSachHangHoaHoaDon = ko.observableArray();
    $(".BangBaoLoi").hide();
    self.insertArticleNews = function () {
        hidewait('printinport');
        var typeExcel = ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'application/vnd.ms-excel'];
        var sError = '';
        var formData = new FormData();
        var totalFiles = document.getElementById("imageUploadForm").files.length;
        for (let i = 0; i < totalFiles; i++) {
            var file = document.getElementById("imageUploadForm").files[i];
            if (file.type !== "" && $.inArray(file.type, typeExcel) === -1) {
                sError += file.name + ', ';
            }
            else {
                formData.append("imageUploadForm", file);
            }
        }
        if (sError !== '') {
            ShowMessage_Danger('File ' + Remove_LastComma(sError) + ' không đúng định dạng');
            $('#wait').remove();
            self.visibleImport(false);
            return false;
        }
        $.ajax({
            type: "POST",
            url: DMHangHoaUri + "ImportHangHoaHoaDon", // get error
            data: formData,
            dataType: 'json',
            contentType: false,
            processData: false,
            success: function (item) {
                self.loiExcel(item);
                if (self.loiExcel() !== null) {
                    self.visibleImport(true);
                    $(".BangBaoLoi").show();
                    $(".NoteImport").hide();
                    $(".filterFileSelect").hide();
                    $(".btnImportExcel").hide();
                    $('#wait').remove();
                }
                else {
                    // thực hiện import
                    $.ajax({
                        type: "POST",
                        url: DMHangHoaUri + "getList_HangHoaHoaDon",
                        data: formData,
                        dataType: 'json',
                        contentType: false,
                        processData: false,
                        success: function (item) {
                            self.DanhSachHangHoaHoaDon(item);
                            AddHoaDon_fromExcel();
                        },
                    });
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                ShowMessage_Danger('Import hóa đơn thất bại');
                $('#wait').remove();
            }
        })
    }
    self.ShowandHide = function () {
        self.insertArticleNews();
    }
    function AddHoaDon_fromExcel() {
        var arrQuiDoi = self.DanhSachHangHoaHoaDon().map(function (x) {
            return x.ID_DonViQuiDoi;
        });
        var param = {
            ID_ChiNhanh: id_DonVi,
            ID_BangGia: const_GuidEmpty,
            LstIDQuiDois: arrQuiDoi,
        };

        // get infor product from DB
        ajaxHelper('/api/DanhMuc/DM_HangHoaAPI/Gara_GetListHangHoa_ByIDQuiDoi', 'POST', param).done(function (x) {
            if (x.res) {
                var arr = [];
                for (let i = 0; i < self.DanhSachHangHoaHoaDon().length; i++) {
                    let forOut = $.extend({}, true, self.DanhSachHangHoaHoaDon()[i]);
                    let ctHH = $.grep(x.dataSoure, function (y) {
                        return y.ID_DonViQuiDoi === forOut.ID_DonViQuiDoi
                            && ((y.ID_LoHang === forOut.ID_LoHang) || (forOut.ID_LoHang === const_GuidEmpty && y.ID_LoHang == null))
                    });
                    if (ctHH.length > 0) {
                        let objCT = $.extend({}, true, ctHH[0]);
                        objCT.ThuTuHoaDon = forOut.ThuTuHoaDon;
                        objCT.SoLuong = forOut.SoLuong;
                        objCT.ID_LoHang = forOut.ID_LoHang;
                        objCT.MaLoHang = forOut.MaLoHang;
                        objCT.GiaBan = forOut.GiaBan != null ? forOut.GiaBan : objCT.GiaBan;
                        objCT.GiamGia = forOut.GiamGia != null ? forOut.GiamGia : 0;
                        arr.push(objCT);
                    }
                }
                self.DanhSachHangHoaHoaDon($.extend([], true, arr));

                var maHoaDonImport = nameHD_InsertBH;
                var loaiHD = self.HoaDons().LoaiHoaDon();
                var max = 0;
                var lstHD = localStorage.getItem(lcListHD);
                var cthd = localStorage.getItem(lcListCTHD);
                if (lstHD !== null) {
                    lstHD = JSON.parse(lstHD);
                    max = GetMax_MaHoaDon(loaiHD, lstHD);
                }
                else {
                    lstHD = [];
                }
                if (cthd !== null) {
                    cthd = JSON.parse(cthd);
                }
                else {
                    cthd = [];
                }
                var arrIDQuiDoi = [];
                var cthdLoHang = [];
                for (let i = 0; i < self.DanhSachHangHoaHoaDon().length; i++) {
                    let itemFor = self.DanhSachHangHoaHoaDon()[i];
                    let maHD = itemFor.ThuTuHoaDon + max;

                    if (parseInt(itemFor.ThuTuHoaDon) !== 1) {
                        loaiHD = 1;// neu hd dautien chon tu PhieuTiepNhan (loaiHD = 25), sau do reset loaiHD = 1
                    }
                    // check HD exist
                    let itemHD = GetHDOpening_byMaHoaDon(maHoaDonImport + maHD, lstHD);
                    let idRandomHD = '';
                    if (itemHD.length === 0) {
                        // reset arrIDQuiDoi if newHDon
                        arrIDQuiDoi = [];
                        let newObj = newHoaDon(loaiHD, maHD);
                        lstHD.push(newObj);
                        idRandomHD = newObj.IDRandom;
                        itemHD = newObj;
                    }
                    else {
                        idRandomHD = itemHD[0].IDRandom;
                        itemHD = itemHD[0];
                    }

                    let quanLiTheoLo = itemFor.QuanLyTheoLoHang;
                    let giaBanAfterSale = itemFor.GiaBan - itemFor.GiamGia;
                    giaBanAfterSale = (giaBanAfterSale < 0 ? itemFor.GiaBan : giaBanAfterSale);
                    let thanhtien = giaBanAfterSale * itemFor.SoLuong;

                    let dateLot = GetNgaySX_NgayHH(itemFor);

                    if ($.inArray(itemFor.ID_DonViQuiDoi, arrIDQuiDoi) === -1) {
                        arrIDQuiDoi.unshift(itemFor.ID_DonViQuiDoi);

                        let ob1 = newHangHoa(itemFor, itemHD, false);
                        ob1.TienChietKhau = itemFor.GiamGia;
                        ob1.ThanhTien = thanhtien;
                        ob1.ThanhToan = thanhtien;
                        ob1.ListDonViTinh = [];
                        ob1.MaLoHang = itemFor.MaLoHang;
                        ob1.NgaySanXuat = dateLot.NgaySanXuat;
                        ob1.NgayHetHan = dateLot.NgayHetHan;

                        if (quanLiTheoLo) {
                            let objLot = $.extend({}, ob1);
                            objLot.DM_LoHang = [];
                            objLot.HangCungLoais = [];
                            ob1.DM_LoHang.push(objLot);
                        }
                        cthdLoHang.push(ob1);
                    }
                    else {
                        // find in cthdLoHang with same ID_QuiDoi
                        for (let j = 0; j < cthdLoHang.length; j++) {
                            if (cthdLoHang[j].IDRandomHD === idRandomHD
                                && cthdLoHang[j].ID_DonViQuiDoi === itemFor.ID_DonViQuiDoi) {
                                if (quanLiTheoLo) {
                                    let objLot = $.extend({}, cthdLoHang[j]);
                                    objLot.LotParent = false;
                                    objLot.IDRandom = CreateIDRandom('RandomCT_');
                                    objLot.DM_LoHang = [];
                                    objLot.HangCungLoais = [];

                                    objLot.ID_LoHang = itemFor.ID_LoHang;
                                    objLot.MaLoHang = itemFor.MaLoHang;
                                    objLot.NgaySanXuat = dateLot.NgaySanXuat;
                                    objLot.NgayHetHan = dateLot.NgayHetHan;
                                    objLot.SoLuong = itemFor.SoLuong;
                                    objLot.DonGia = itemFor.GiaBan;
                                    objLot.GiaBan = itemFor.GiaBan;
                                    objLot.TienChietKhau = itemFor.GiamGia;
                                    objLot.ThanhTien = thanhtien;
                                    objLot.ThanhToan = thanhtien;
                                    cthdLoHang[j].DM_LoHang.push(objLot);
                                }
                                else {
                                    let cungloai = $.extend({}, cthdLoHang[j]);
                                    cungloai.IDRandom = CreateIDRandom('RandomCT_');
                                    cungloai.LaConCungLoai = true;
                                    cungloai.HangCungLoais = [];
                                    cungloai.DM_LoHang = [];
                                    cungloai.SoLuong = itemFor.SoLuong;
                                    cungloai.DonGia = itemFor.GiaBan;
                                    cungloai.GiaBan = itemFor.GiaBan;
                                    cungloai.TienChietKhau = itemFor.GiamGia;
                                    cungloai.ThanhTien = thanhtien;
                                    cungloai.ThanhToan = thanhtien;
                                    cthdLoHang[j].HangCungLoais.push(cungloai);
                                }
                                break;
                            }
                        }
                    }

                }
                // push in CTHD
                for (let i = 0; i < cthdLoHang.length; i++) {
                    cthd.push(cthdLoHang[i]);
                }
                localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
                // save cache hd
                localStorage.setItem(lcListHD, JSON.stringify(lstHD));

                for (let i = 0; i < cthd.length; i++) {
                    UpdateKhuyenMai_CTHD(cthd[i].ID_DonViQuiDoi, cthd[i].IDRandomHD);
                    _maHoaDon = cthd[i].MaHoaDon;
                }

                var arrIDRandomHD = lstHD.map(function (x) {
                    return x.IDRandom;
                });
                for (let i = 0; i < arrIDRandomHD.length; i++) {
                    UpdateSoThuTu_CTHD(false, arrIDRandomHD[i]);
                    self.KM_KMApDung([]);
                    UpdateCacheHDLe(arrIDRandomHD[i], false);
                    UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();
                }

                BindHD_CTHDafterSave();
                Call_6Func();
            }

            $(".BangBaoLoi").hide();
            $(".NoteImport").show();
            $('#myModalinport').modal("hide");
            $('#wait').remove();
            self.refreshFileSelect();
        })
    }
    // Nhap nhanh/ nhap thuong
    self.NhapThuong_Nhanh = function () {
        $('#txtSoLuong, #txtDonGia').val('');
        if (self.IsNhapNhanh()) {
            self.IsNhapNhanh(false);
            bottomrightnotify('Chế độ nhập thường', 'success');
            if ($('#txtSearchHH').val() === '') {
                $('#txtSearchHH').focus();
            }
            else {
                $('#txtSoLuong').focus();
            }
            $("#searchandadd").css("width", "calc(100% - 210px)")
        }
        else {
            self.IsNhapNhanh(true);
            bottomrightnotify('Chế độ nhập nhanh', 'success');
            $("#searchandadd").css("width", "calc(100% - 50px)")
            $('#txtSearchHH').focus();
        }
        NhapThuong_HideShow_txtDonGia();
    }
    self.itemCTHD_clickGiaBan = ko.observableArray(); // get item CTHD when click GiaBan;
    self.IsClickNewPrice_computer = ko.observable(true); // dang click vao newprice computer, default = true
    self.clickGiaBan = function (item) {
        self.itemCTHD_clickGiaBan(item);
    }
    self.editPrice_computer = function () {
        // get infor from CTHD old
        var priceOld = self.itemCTHD_clickGiaBan().DonGia;
        var thisObj = $('#computer_newPrice');
        var objSale = $('#computer-gg');
        formatNumberObj(thisObj);
        var price = formatNumberToInt(thisObj.val());
        var priceNew = price;
        var tienGiam = 0;
        if (priceNew < priceOld) {
            tienGiam = priceOld - priceNew;
        }
        // assign again sale
        if (clickVND) {
            objSale.val(formatNumber3Digit(tienGiam));
        }
        else {
            objSale.val(tienGiam / priceOld * 100);
        }
        thisObj.val(formatNumber3Digit(priceNew));
    }
    self.editSale_computer = function () {
        var thisObj = $('#computer-gg');
        var objPrice = $('#computer_newPrice');
        var keyCode = event.keyCode || e.which;
        // neu dang go phim back
        if (keyCode === 8) {
            var newVal = thisObj.val();
            // if last char ='.' --> remove
            var lastChar = newVal[newVal.length - 1];
            if (lastChar === '.') {
                newVal = newVal.substr(0, newVal.length - 1);
                thisObj.val(newVal);
            }
        }
        // get infor from CTHD old
        var priceOld = self.itemCTHD_clickGiaBan().DonGia;
        var priceNew = 0;
        var tienGiam = 0;
        // neu gia cu = 0 => khong cho phep nhap giam gia
        if (priceOld === 0) {
            thisObj.val(0);
        }
        else {
            // format 000,000,000
            formatNumberObj(thisObj);
            var valThis = thisObj.val();
            if (valThis === '') {
                // neu clear giamgia ='';
                valThis = 0;
            }
            // clickVND: global variable
            if (clickVND) {
                // neu giam gia > gia cu
                if (formatNumberToInt(valThis) > priceOld) {
                    thisObj.val(formatNumber3Digit(priceOld));
                    valThis = priceOld;
                }
                // round VD: 20.45 --> 20; 20.51 --> 21
                tienGiam = formatNumberToInt(valThis);
            }
            else {
                // neu giam gia > 100 %
                if (formatNumberToFloat(valThis) > 100) {
                    thisObj.val(100);
                    valThis = 100;
                }
                tienGiam = priceOld * parseFloat(valThis) / 100;
            }
            priceNew = priceOld - tienGiam;
            objPrice.val(formatNumber3Digit(priceNew));
        }
    }
    // click input NewPrice_computer
    self.clickNewPrice_computer = function () {
        self.IsClickNewPrice_computer(true);
        $('#computer_newPrice').focus();
        $('#computer_newPrice').select();
    }
    // click input sale_computer
    self.clickSale_computer = function () {
        self.IsClickNewPrice_computer(false);
        $('#computer-gg').focus();
        $('#computer-gg').select();
    }
    // set value for input when click number
    self.clickNumber = function (number) {
        var cpt_newPrice = $('#computer_newPrice');
        var cpt_sale = $('#computer-gg');
        // get infor from CTHD old
        var priceOld = self.itemCTHD_clickGiaBan().DonGia;
        var priceNew = 0;
        var tienGiam = 0;
        var newVal = '';
        // if is focus newprice
        if (self.IsClickNewPrice_computer()) {
            // get value at input #computer_newPrice, after concat string (nối chuỗi)
            newVal = cpt_newPrice.val() + number;
            // convert price ti int
            var price = formatNumberToInt(newVal);
            priceNew = price;
            if (priceNew < priceOld) {
                tienGiam = priceOld - priceNew;
            }
            // assign again sale
            if (clickVND) {
                cpt_sale.val(formatNumber3Digit(tienGiam));
            }
            else {
                cpt_sale.val(tienGiam / priceOld * 100);
            }
            cpt_newPrice.val(formatNumber3Digit(priceNew));
        }
        else {
            // neu gia cu = 0 => khong cho phep nhap giam gia
            if (priceOld === 0) {
                cpt_sale.val(0);
            }
            else {
                // tim den vi tri chua dau .
                var indexComma = cpt_sale.val().indexOf('.');
                if (indexComma > -1) {
                    // lay do dai chuoi - 1
                    var len = cpt_sale.val().length - 1;
                    // dem so ki tu sau dau .
                    // neu === 3 --> khong cong chuoi nua
                    if (len - indexComma < 3) {
                        // concat string (nối chuỗi)
                        newVal = cpt_sale.val() + number;
                        // 000,000 --> 000 000
                        newVal = newVal.toString().replace(/,/g, '');
                        // if last char of string ='.' --> not format to float
                        let lastChar = newVal[newVal.length - 1];
                        if (lastChar !== '.') {
                            newVal = formatNumberToFloat(newVal);
                        }
                        // assign again value for input
                        cpt_sale.val(formatNumber3Digit(newVal));
                    }
                }
                else {
                    // concat string (nối chuỗi)
                    newVal = cpt_sale.val() + number;
                    // 000,000 --> 000 000
                    newVal = newVal.toString().replace(/,/g, '');
                    // if last char of string ='.' --> not format to float
                    let lastChar = newVal[newVal.length - 1];
                    if (lastChar !== '.') {
                        newVal = formatNumberToFloat(newVal);
                    }
                    // assign again value for input
                    cpt_sale.val(formatNumber3Digit(newVal));
                }
                // neu clear giamgia ='';
                var valGiamGia = cpt_sale.val();
                if (valGiamGia === '') {
                    valGiamGia = 0;
                }
                // caculator again newPrice (same editSale_computer)
                // clickVND: global variable
                if (clickVND) {
                    // neu giam gia > gia cu
                    if (formatNumberToInt(valGiamGia) > priceOld) {
                        cpt_sale.val(formatNumber3Digit(priceOld));
                    }
                    // round VD: 20.45 --> 20; 20.51 --> 21
                    tienGiam = formatNumberToInt(valGiamGia);
                }
                else {
                    // neu giam gia > 100 %
                    if (formatNumberToFloat(valGiamGia) > 100) {
                        cpt_sale.val(100);
                    }
                    tienGiam = priceOld * parseFloat(valGiamGia) / 100;
                }
                priceNew = priceOld - tienGiam;
                cpt_newPrice.val(formatNumber3Digit(priceNew));
            }
        }
    }
    self.deleteNumber = function () {
        var cpt_newPrice = $('#computer_newPrice');
        var cpt_sale = $('#computer-gg');
        var newVal = '';
        var oldVal = '';
        var priceOld = self.itemCTHD_clickGiaBan().DonGia;
        var priceNew = 0;
        var tienGiam = 0;
        if (self.IsClickNewPrice_computer()) {
            // get old string
            oldVal = cpt_newPrice.val();
            // remove last char of old string
            newVal = oldVal.substr(0, oldVal.length - 1);
            // format again newValue
            newVal = newVal.replace(/,/g, "").replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            // tinh lai giam gia (same edit price)
            var price = formatNumberToInt(newVal);
            priceNew = price;
            if (priceNew < priceOld) {
                tienGiam = priceOld - priceNew;
            }
            // assign again sale
            if (clickVND) {
                cpt_sale.val(formatNumber3Digit(tienGiam));
            }
            else {
                cpt_sale.val(tienGiam / priceOld * 100);
            }
            cpt_newPrice.val(formatNumber3Digit(priceNew));
        }
        else {
            oldVal = cpt_sale.val();
            newVal = oldVal.substr(0, oldVal.length - 1);
            newVal = newVal.replace(/,/g, "").replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            // if last char ='.' --> remove
            var lastChar = newVal[newVal.length - 1];
            if (lastChar === '.') {
                newVal = newVal.substr(0, newVal.length - 1);
            }
            cpt_sale.val(newVal);
            // caculator again newPrice, sale
            // neu clear giamgia ='';
            if (formatNumberToInt(cpt_sale.val()) === 0) {
                cpt_sale.val(0);
            }
            // clickVND: global variable
            if (clickVND) {
                // neu giam gia > gia cu
                if (formatNumberToInt(cpt_sale.val()) > priceOld) {
                    cpt_sale.val(formatNumber3Digit(priceOld));
                }
                // round VD: 20.45 --> 20; 20.51 --> 21
                tienGiam = formatNumberToInt(cpt_sale.val());
            }
            else {
                // neu giam gia > 100 %
                if (formatNumberToFloat(cpt_sale.val()) > 100) {
                    cpt_sale.val(100);
                }
                tienGiam = priceOld * parseFloat(cpt_sale.val()) / 100;
            }
            priceNew = priceOld - tienGiam;
            cpt_newPrice.val(formatNumber3Digit(priceNew));
        }
    }
    self.clickVND_computer = function () {
        $('.toogle-report').addClass('active-re');
        var objSale = $('#computer-gg');
        var giamgia = objSale.val();
        var priceOld = self.itemCTHD_clickGiaBan().DonGia;
        var tienGiam = 0;
        // clickVND global variable
        if (clickVND) {
            tienGiam = formatNumberToFloat(giamgia);
        }
        else {
            tienGiam = formatNumberToFloat(giamgia) * priceOld / 100;
        }
        clickVND = true;
        objSale.val(formatNumber3Digit(tienGiam));
    }
    self.clickNoVND_computer = function () {
        $('.toogle-report').removeClass('active-re');
        var objSale = $('#computer-gg');
        var giamgia = objSale.val();
        var priceOld = self.itemCTHD_clickGiaBan().DonGia;
        // chi xu li neu priceOld > 0
        if (priceOld !== 0) {
            // clickVND: global variable (co nen su dung bien clickVND o day khong nhi ??)
            if (!clickVND) {
                objSale.val(giamgia);
            }
            else {
                var div = formatNumberToInt(giamgia) / priceOld * 100;
                objSale.val(div);
            }
            clickVND = false;
        }
    }
    self.ChangeDVT_computer = function () {
        var objSale = $('#computer-gg');
        var priceOld = self.itemCTHD_clickGiaBan().DonGia;
        var giamgia = objSale.val();
        var tienGiam = 0;
        var isPercent = $('#divOnOffVND').hasClass('active-re');
        if (clickVND) {
            // truoc do la %
            if (isPercent) {
                tienGiam = parseFloat(giamgia) * priceOld / 100;
                objSale.val(formatNumber3Digit(tienGiam));
                clickVND = true;
            }
            else {
                // truoc do la VND
                let div = formatNumberToFloat(giamgia) / priceOld * 100;
                objSale.val(formatNumber3Digit(div));
                clickVND = false;
            }
        }
        else {
            // truoc do la %
            if (isPercent) {
                tienGiam = formatNumberToFloat(giamgia) * priceOld / 100;
                objSale.val(formatNumber3Digit(tienGiam));
                clickVND = true;
            }
            else {
                // truoc do la VND
                let div = formatNumberToInt(giamgia) / priceOld * 100;
                objSale.val(formatNumber3Digit(div));
                clickVND = false;
            }
        }
    }
    self.agreeNewPrice_computer = function () {
        $('#computersquer').modal('hide');
        var cthdIsChose = self.itemCTHD_clickGiaBan();
        var newPrice = formatNumberToInt($('#computer_newPrice').val());
        var newSale = $('#computer-gg').val();
        var tienGiam = 0;
        var ptGiam = 0;
        var dvtGiam = 'VND';
        var priceOld = cthdIsChose.DonGia;
        if (clickVND) {
            tienGiam = formatNumberToInt(newSale);
            ptGiam = 0;
            dvtGiam = 'VND';
        }
        else {
            ptGiam = parseFloat(newSale);
            tienGiam = ptGiam * priceOld / 100;
            dvtGiam = '%';
        }
        var idRandomHD = cthdIsChose.IDRandomHD;
        var cthd = localStorage.getItem(lcListCTHD);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            for (let i = 0; i < cthd.length; i++) {
                if (cthd[i].IDRandomHD === idRandomHD && cthd[i].ID_DonViQuiDoi === cthdIsChose.ID_DonViQuiDoi) {
                    // update giaban, giamgia, thanh tien, dvt
                    cthd[i].GiaBan = newPrice;
                    cthd[i].PTChietKhau = ptGiam;
                    cthd[i].TienChietKhau = tienGiam;
                    cthd[i].DVTinhGiam = dvtGiam;
                    cthd[i].ThanhTien = cthd[i].SoLuong * newPrice;
                    break;
                }
            }
            localStorage.setItem(lcListCTHD, JSON.stringify(cthd))
        }
        if (cthdIsChose.MaHoaDon.indexOf('Trả') > -1) {
            UpdateHD_TraHang(idRandomHD);
            BindHD_CTHDafterSave();
        }
        else {
            // reset KM of HangHoa, but not bind CTHD
            ResetKM_HangHoa_ByIDQuiDoi_orNhomHang(cthdIsChose.ID_DonViQuiDoi, cthdIsChose.ID_NhomHangHoa, idRandomHD);
            ResetKM_HoaDon(idRandomHD);
            UpdateCacheHDLe(idRandomHD, false);
            UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();
            self.KM_KMApDung([]);
            UpdateKhuyenMai_CTHD(cthdIsChose.ID_DonViQuiDoi, idRandomHD);
            BindCTHD_byIDRandomHD(idRandomHD);
            BindHD_byIDRandom(idRandomHD);
        }
        $('#txtDaThanhToan').select();
    }

    self.fileSelect = function (elemet, event) {
        var files = event.target.files;// FileList object
        // Loop through the FileList and render image files as thumbnails.
        var countErrType = 0;
        var countErrSize = 0;
        var errFileSame = '';
        var err = '';
        // Check Type file & Size
        for (let i = 0; i < files.length; i++) {
            if (!files[i].type.match('image.*')) {
                countErrType += 1;
            }
            let size = parseFloat(files[i].size / 1024).toFixed(2);
            if (size > 2048) {
                countErrSize += 1;
            }
            // check trung ten file
            for (let j = 0; j < self.FilesSelect().length; j++) {
                var arrPath = self.FilesSelect()[j].URLAnh.split('/');
                var fileName = arrPath[arrPath.length - 1];
                if (fileName === files[i].name) {
                    errFileSame += files[i].name + ', ';
                }
            }
        }
        // remove comma ,
        if (errFileSame !== '') {
            errFileSame = errFileSame.substr(0, errFileSame.length - 2)
        }
        if (countErrType > 0) {
            err = countErrType + ' file chưa đúng định dạng. ';
        }
        if (countErrSize > 0) {
            if (countErrType > 0) {
                if (errFileSame === '') {
                    // err type + error size
                    err += '<br />' + countErrSize + ' file có dung lượng > 2MB';
                }
                else {
                    // err type + error size + error exist file
                    err += '<br />' + countErrSize + ' file có dung lượng > 2MB' + '<br />' + ' File ' + errFileSame + ' đã tồn tại';
                }
            }
            else {
                // err size
                if (errFileSame === '') {
                    err = countErrSize + ' file có dung lượng > 2MB'
                }
                else {
                    // err size + error exist file
                    err = countErrSize + ' file có dung lượng > 2MB' + '<br />' + 'File ' + errFileSame + ' đã tồn tại';
                }
            }
        }
        else {
            if (countErrType > 0) {
                if (errFileSame !== '') {
                    // err type + error exist file
                    err += '<br />' + 'File ' + errFileSame + ' đã tồn tại';
                }
            }
            else {
                // not err
                if (errFileSame === '') {
                    err = '';
                }
                else {
                    // error exist file
                    err = 'File ' + errFileSame + ' đã tồn tại';
                }
            }
        }
        if (err !== '') {
            ShowMessage_Danger(err);
        }
        for (let i = 0; i < files.length; i++) {
            let f = files[i];
            // Only process image files.
            if (!f.type.match('image.*')) {
                continue;
            }
            let size = parseFloat(f.size / 1024).toFixed(2);
            if (size <= 2048) {
                let reader = new FileReader();
                // Closure to capture the file information.
                reader.onload = (function (theFile) {
                    return function (e) {
                        self.FilesSelect.push(new FileModel(theFile, e.target.result));
                    };
                })(f);
                // Read in the image file as a data URL.
                reader.readAsDataURL(f);
                self.HaveImage_Select(true);
            }
        }
    };

    // use at txt FromDate
    self.formatFromDate = function () {
        $(event.currentTarget).datetimepicker(
            {
                format: "d/m/Y",
                mask: true,
                timepicker: false,
            });
    }
    // use at txt ToDate
    self.formatToDate = function () {
        $('#txtToDate, #txtToDateDH').datetimepicker(
            {
                format: "d/m/Y",
                mask: true,
                timepicker: false,
                maxDate: new Date(),
            });
    }
    // use at txtNgaySinh, NgaySuDung, NgayHetHang (spa)
    self.formatDate = function () {
        var thisObj = event.currentTarget;
        $(thisObj).datetimepicker(
            {
                format: "d/m/Y",
                mask: true,
                timepicker: false,
            });
    }
    self.formatDateTime = function () {
        $('.datepicker_mask').datetimepicker(
            {
                format: "d/m/Y H:i",
                mask: true,
                timepicker: true,
                maxDate: new Date(),
            });
    }

    // Tich Diem
    function GetHT_TichDiem() {
        ajaxHelper('/api/DanhMuc/HT_API/' + 'GetHT_CauHinh_TichDiemChiTiet?idDonVi=' + id_DonVi, 'GET').done(function (obj) {
            if (obj.res === true) {
                let data = obj.data;
                self.ThietLap_TichDiem(data);
                if (data.length > 0) {
                    vmThanhToanGara.ThietLap_TichDiem = {
                        DuocThietLap: true,
                        DiemThanhToan: data[0].DiemThanhToan,
                        TienThanhToan: data[0].TienThanhToan,
                        TyLeDoiDiem: data[0].TyLeDoiDiem,
                        TichDiemGiamGia: data[0].TichDiemGiamGia,
                        TichDiemHoaDonGiamGia: data[0].TichDiemHoaDonGiamGia,
                    }
                }
                WriteData_Dexie(db.HeThongTichDiem, data);
                // truong hop copyHD from GiaoDich.js --> update Diem cho HD
                UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();
            }
        });
    }
    // update DiemGiaoDich, but reset DiemQuyDoi = 0, TTBangDiem = 0 (use edit/tang/giam so luong)
    function UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon() {
        if (self.ThietLap().TinhNangTichDiem) {
            var lstHD = localStorage.getItem(lcListHD);
            if (lstHD !== null) {
                lstHD = JSON.parse(lstHD);
                if (_maHoaDon === '') {
                    _maHoaDon = $('.gara-bill-label li.active font').text();
                }
                var itemHD = GetHDOpening_byMaHoaDon(_maHoaDon, lstHD);
                if (itemHD.length > 0) {
                    var sumCTHD_sale = 0;
                    var sumCTHD_notsale = 0;
                    var sumHH_KM = 0;
                    var sumHH_ofHDKM = 0;
                    var sum_cthd0tichdiem = 0;
                    var idNhomDTs = '';
                    var idRandomHD = itemHD[0].IDRandom;
                    // tinh tien hang khuyen mai cua HD (Khong tich diem cho hang khuyen mai)
                    var lstKM_HD = localStorage.getItem(lcProductKM_HoaDon);
                    if (lstKM_HD !== null) {
                        lstKM_HD = JSON.parse(lstKM_HD);
                        var arrProduct = $.grep(lstKM_HD, function (x) {
                            return x.IDRandomHD === idRandomHD;
                        });
                        for (let i = 0; i < arrProduct.length; i++) {
                            sumHH_ofHDKM += arrProduct[i].ThanhTien;
                        }
                    }
                    // if Khong tich diem cho Sp giam gia
                    if (self.ThietLap_TichDiem() !== null && self.ThietLap_TichDiem().length > 0) {

                        if (itemHD[0].LoaiHoaDon === 1 || itemHD[0].LoaiHoaDon === 19 || itemHD[0].LoaiHoaDon === 25) {
                            var cthd = localStorage.getItem(lcListCTHD);
                            if (cthd !== null) {
                                cthd = JSON.parse(cthd);
                                // sum diem of product ducotichdiem =0
                                let cthd_notTichDiem = $.grep(cthd, function (x) {
                                    return x.DuocTichDiem === 0 && x.IDRandomHD === idRandomHD;
                                });
                                for (let i = 0; i < cthd_notTichDiem.length; i++) {
                                    sum_cthd0tichdiem += cthd_notTichDiem[i].ThanhTien;
                                }
                                // only get product with duoctichdiem = 1 
                                cthd = $.grep(cthd, function (x) {
                                    return x.DuocTichDiem === 1;
                                });
                                // khong tichdiem cthd co ckhau
                                if (self.ThietLap_TichDiem()[0].TichDiemGiamGia) {
                                    // tinh tong tien cac hang hoa co giam gia cua HD Mua
                                    for (let i = 0, il = cthd.length; i < il; i++) {
                                        let itemCTHD = cthd[i];
                                        if (itemCTHD.IDRandomHD === idRandomHD) {
                                            if (itemCTHD.TienChietKhau > 0) {
                                                sumCTHD_sale += itemCTHD.ThanhTien;
                                            }
                                            else {
                                                sumCTHD_notsale += itemCTHD.ThanhTien;
                                            }
                                            // sum DM_Lo (sale/not sale)
                                            for (let k = 1; k < itemCTHD.DM_LoHang.length; k++) {
                                                if (itemCTHD.DM_LoHang[k].TienChietKhau > 0) {
                                                    sumCTHD_sale += itemCTHD.DM_LoHang[k].ThanhTien;
                                                }
                                                else {
                                                    sumCTHD_notsale += itemCTHD.DM_LoHang[k].ThanhTien;
                                                }
                                            }
                                            for (let k = 0; k < itemCTHD.HangCungLoais.length; k++) {
                                                if (itemCTHD.HangCungLoais[k].TienChietKhau > 0) {
                                                    sumCTHD_sale += itemCTHD.HangCungLoais[k].ThanhTien;
                                                }
                                                else {
                                                    sumCTHD_notsale += itemCTHD.HangCungLoais[k].ThanhTien;
                                                }
                                            }
                                            // tinh tien hang khuyen mai cua hang hoa
                                            for (let j = 0; j < itemCTHD.HangHoa_KM.length; j++) {
                                                sumHH_KM += itemCTHD.HangHoa_KM[j].ThanhTien;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        else {
                            var cthd_TH = localStorage.getItem(lcListCTHD_DoiTra);
                            if (cthd_TH !== null) {
                                cthd_TH = JSON.parse(cthd_TH);
                                // sum diem of product ducotichdiem =0
                                let cthd_notTichDiem = $.grep(cthd_TH, function (x) {
                                    return x.DuocTichDiem === 0 && x.IDRandomHD === idRandomHD;
                                });
                                for (let i = 0; i < cthd_notTichDiem.length; i++) {
                                    sum_cthd0tichdiem += cthd_notTichDiem[i].ThanhTien;
                                }
                                // only get product with duoctichdiem = 1
                                cthd_TH = $.grep(cthd_TH, function (x) {
                                    return x.DuocTichDiem === 1;
                                });
                                // khong tichdiem cthd co ckhau
                                if (self.ThietLap_TichDiem()[0].TichDiemGiamGia) {
                                    // tinh tong tien cac hang khong giam gia cua HD Doi Tra
                                    for (let i = 0; i < cthd_TH.length; i++) {
                                        let itemCTHD_TH = cthd_TH[i];
                                        if (itemCTHD_TH.IDRandomHD === idRandomHD) {
                                            if (itemCTHD_TH.TienChietKhau > 0) {
                                                sumCTHD_sale += itemCTHD_TH.ThanhTien;
                                            }
                                            else {
                                                sumCTHD_notsale += itemCTHD_TH.ThanhTien;
                                            }
                                            // sum DM_Lo (sale/not sale)
                                            for (let k = 1; k < itemCTHD_TH.DM_LoHang.length; k++) {
                                                if (itemCTHD_TH.DM_LoHang[k].TienChietKhau > 0) {
                                                    sumCTHD_sale += itemCTHD_TH.DM_LoHang[k].ThanhTien;
                                                }
                                                else {
                                                    sumCTHD_notsale += itemCTHD_TH.DM_LoHang[k].ThanhTien;
                                                }
                                            }
                                            for (let k = 0; k < itemCTHD_TH.HangCungLoais.length; k++) {
                                                if (itemCTHD_TH.HangCungLoais[k].TienChietKhau > 0) {
                                                    sumCTHD_sale += itemCTHD_TH.HangCungLoais[k].ThanhTien;
                                                }
                                                else {
                                                    sumCTHD_notsale += itemCTHD_TH.HangCungLoais[k].ThanhTien;
                                                }
                                            }
                                            // tinh tien hang khuyen mai cua hang hoa
                                            for (let j = 0; j < itemCTHD_TH.HangHoa_KM.length; j++) {
                                                sumHH_KM += itemCTHD_TH.HangHoa_KM[j].ThanhTien;
                                            }
                                        }
                                    }
                                }
                            }
                        }

                        // diem GD cua HH co giam gia
                        var diemGD_ofHHsale = Math.floor(sumCTHD_sale / self.ThietLap_TichDiem()[0].TyLeDoiDiem);
                        // diem GD cua all Hang Khuyen Mai (HH + HD)
                        var diemGD_ofHHKM = Math.floor((sumHH_ofHDKM + sumHH_KM) / self.ThietLap_TichDiem()[0].TyLeDoiDiem);
                        let diemGD_cthd0tichdiem = Math.floor(sum_cthd0tichdiem / self.ThietLap_TichDiem()[0].TyLeDoiDiem);
                        // diem GD cua HoaDon
                        var diemGD_ofHD = Math.floor((itemHD[0].TongTienHang - itemHD[0].TongGiamGiaKM_HD) / self.ThietLap_TichDiem()[0].TyLeDoiDiem);
                        // diem GD sau khi tru diem GD khuyen mai
                        var diemGiaoDich = diemGD_ofHD - diemGD_ofHHKM - diemGD_cthd0tichdiem;
                        diemGiaoDich = diemGiaoDich > 0 ? diemGiaoDich : 0;

                        if (self.ChiTietDoiTuong() !== null && self.ChiTietDoiTuong().length > 0) {
                            // get diem hien tai cua KH
                            if (self.ChiTietDoiTuong()[0].ID_NhomDoiTuong === null || self.ChiTietDoiTuong()[0].ID_NhomDoiTuong === undefined) {
                                idNhomDTs = '';
                            }
                            else {
                                idNhomDTs = self.ChiTietDoiTuong()[0].ID_NhomDoiTuong.toLowerCase();
                            }

                            // Tich Diem for all KH
                            if (self.ThietLap_TichDiem()[0].ToanBoKhachHang) {
                                // if Khong tich diem cho Sp giam gia
                                if (self.ThietLap_TichDiem()[0].TichDiemGiamGia) {
                                    // if Khong tich diem cho HD Giam Gia
                                    if (self.ThietLap_TichDiem()[0].TichDiemHoaDonGiamGia) {
                                        // check xem HD co dang duoc giam gia khong
                                        if (itemHD[0].TongGiamGiaKM_HD > 0) {
                                            // neu co Giam Gia --> khong update gi ca
                                            for (let i = 0; i < lstHD.length; i++) {
                                                if (lstHD[i].IDRandom === idRandomHD && lstHD[i].LoaiHoaDon !== 3) {
                                                    lstHD[i].DiemQuyDoi = 0;
                                                    lstHD[i].TTBangDiem = 0;
                                                    lstHD[i].DiemGiaoDich = 0;
                                                    break;
                                                }
                                            }
                                        }
                                        else {
                                            for (let i = 0; i < lstHD.length; i++) {
                                                if (lstHD[i].IDRandom === idRandomHD && lstHD[i].LoaiHoaDon !== 3) {
                                                    lstHD[i].DiemQuyDoi = 0;
                                                    lstHD[i].TTBangDiem = 0;
                                                    // diemGD = diem cua HH khong co GG (OK)
                                                    lstHD[i].DiemGiaoDich = Math.floor(sumCTHD_notsale / self.ThietLap_TichDiem()[0].TyLeDoiDiem) + lstHD[i].DiemCong;
                                                    break;
                                                }
                                            }
                                        }
                                    }
                                    else {
                                        // tich diem cho ca HD giam gia --> update DiemGD for HH khong giam gia
                                        for (let i = 0; i < lstHD.length; i++) {
                                            if (lstHD[i].IDRandom === idRandomHD && lstHD[i].LoaiHoaDon !== 3) {
                                                lstHD[i].DiemQuyDoi = 0;
                                                lstHD[i].TTBangDiem = 0;
                                                // diemGD = diemGD of HD - diemGD of HH co giam gia (OK)
                                                let diemGD = diemGiaoDich - diemGD_ofHHsale + lstHD[i].DiemCong;
                                                lstHD[i].DiemGiaoDich = diemGD > 0 ? diemGD : 0;
                                                break;
                                            }
                                        }
                                    }
                                }
                                else {
                                    // tich diem cho all SP
                                    // Khong Tich Diem cho HD Giam Gia
                                    if (self.ThietLap_TichDiem()[0].TichDiemHoaDonGiamGia) {
                                        if (itemHD[0].TongGiamGiaKM_HD > 0) {
                                            // neu co Giam Gia --> khong update gi ca
                                            for (let i = 0; i < lstHD.length; i++) {
                                                if (lstHD[i].IDRandom === idRandomHD && lstHD[i].LoaiHoaDon !== 3) {
                                                    lstHD[i].DiemQuyDoi = 0;
                                                    lstHD[i].TTBangDiem = 0;
                                                    lstHD[i].DiemGiaoDich = 0;
                                                    break;
                                                }
                                            }
                                        }
                                        else {
                                            // HD khong giam gia: update DiemGiaoDich for all HangHoa
                                            for (let i = 0; i < lstHD.length; i++) {
                                                if (lstHD[i].IDRandom === idRandomHD && lstHD[i].LoaiHoaDon !== 3) {
                                                    lstHD[i].DiemQuyDoi = 0;
                                                    lstHD[i].TTBangDiem = 0;
                                                    // khong can check loaiHD = 6
                                                    lstHD[i].DiemGiaoDich = diemGiaoDich + lstHD[i].DiemCong;
                                                    break;
                                                }
                                            }
                                        }
                                    }
                                    else {
                                        // Tich Diem HD Giam Gia = false
                                        for (let i = 0; i < lstHD.length; i++) {
                                            if (lstHD[i].IDRandom === idRandomHD && lstHD[i].LoaiHoaDon !== 3) {
                                                lstHD[i].DiemQuyDoi = 0;
                                                lstHD[i].TTBangDiem = 0;
                                                lstHD[i].DiemGiaoDich = diemGiaoDich + lstHD[i].DiemCong;
                                                break;
                                            }
                                        }
                                    }
                                }
                            }
                            else {
                                // Tich Diem Theo Nhom KH
                                for (let j = 0; j < self.ThietLap_TichDiem().length; j++) {
                                    // if KH thuoc nhom duoc tich diem
                                    if (idNhomDTs.indexOf(self.ThietLap_TichDiem()[j].ID_NhomDoiTuong) > -1) {
                                        // if Khong tich diem cho Sp giam gia
                                        if (self.ThietLap_TichDiem()[0].TichDiemGiamGia) {
                                            // if Khong tich diem cho HD Giam Gia
                                            if (self.ThietLap_TichDiem()[0].TichDiemHoaDonGiamGia) {
                                                // check xem HD co dang duoc giam gia khong
                                                if (itemHD[0].TongGiamGiaKM_HD > 0) {
                                                    // neu co Giam Gia --> khong update gi ca
                                                    for (let i = 0; i < lstHD.length; i++) {
                                                        if (lstHD[i].IDRandom === idRandomHD && lstHD[i].LoaiHoaDon !== 3) {
                                                            lstHD[i].DiemQuyDoi = 0;
                                                            lstHD[i].TTBangDiem = 0;
                                                            lstHD[i].DiemGiaoDich = 0;
                                                            break;
                                                        }
                                                    }
                                                }
                                                else {
                                                    for (let i = 0; i < lstHD.length; i++) {
                                                        if (lstHD[i].IDRandom === idRandomHD && lstHD[i].LoaiHoaDon !== 3) {
                                                            lstHD[i].DiemQuyDoi = 0;
                                                            lstHD[i].TTBangDiem = 0;
                                                            lstHD[i].DiemGiaoDich = Math.floor(sumCTHD_notsale / self.ThietLap_TichDiem()[0].TyLeDoiDiem) + lstHD[i].DiemCong;
                                                            break;
                                                        }
                                                    }
                                                }
                                            }
                                            else {
                                                // tich diem cho ca HD giam gia --> update DiemGD for HH khong giam gia
                                                for (let i = 0; i < lstHD.length; i++) {
                                                    if (lstHD[i].IDRandom === idRandomHD && lstHD[i].LoaiHoaDon !== 3) {
                                                        lstHD[i].DiemQuyDoi = 0;
                                                        lstHD[i].TTBangDiem = 0;
                                                        let diemGD = diemGiaoDich - diemGD_ofHHsale + lstHD[i].DiemCong;
                                                        lstHD[i].DiemGiaoDich = diemGD > 0 ? diemGD : 0;
                                                        break;
                                                    }
                                                }
                                            }
                                        }
                                        else {
                                            // tich diem cho all SP
                                            // Khong Tich Diem cho HD Giam Gia
                                            if (self.ThietLap_TichDiem()[0].TichDiemHoaDonGiamGia) {
                                                if (itemHD[0].TongGiamGiaKM_HD > 0) {
                                                    // neu co Giam Gia --> khong update gi ca
                                                    for (let i = 0; i < lstHD.length; i++) {
                                                        if (lstHD[i].IDRandom === idRandomHD && lstHD[i].LoaiHoaDon !== 3) {
                                                            lstHD[i].DiemQuyDoi = 0;
                                                            lstHD[i].TTBangDiem = 0;
                                                            lstHD[i].DiemGiaoDich = 0;
                                                            break;
                                                        }
                                                    }
                                                }
                                                else {
                                                    // HD khong giam gia: update DiemGiaoDich for all HangHoa
                                                    for (let i = 0; i < lstHD.length; i++) {
                                                        if (lstHD[i].IDRandom === idRandomHD && lstHD[i].LoaiHoaDon !== 3) {
                                                            lstHD[i].DiemQuyDoi = 0;
                                                            lstHD[i].TTBangDiem = 0;
                                                            lstHD[i].DiemGiaoDich = diemGiaoDich + lstHD[i].DiemCong;
                                                            break;
                                                        }
                                                    }
                                                }
                                            }
                                            else {
                                                // Tich Diem HD Giam Gia = false
                                                for (let i = 0; i < lstHD.length; i++) {
                                                    if (lstHD[i].IDRandom === idRandomHD && lstHD[i].LoaiHoaDon !== 3) {
                                                        lstHD[i].DiemQuyDoi = 0;
                                                        lstHD[i].TTBangDiem = 0;
                                                        lstHD[i].DiemGiaoDich = diemGiaoDich + lstHD[i].DiemCong;
                                                        break;
                                                    }
                                                }
                                            }
                                        }
                                        break; // esc if Check ThietLap_TichDiem().ID_NhomDoiTuong === idNhomDT
                                    }
                                }
                            }
                        }
                        else {
                            // khach le --> khong tich diem
                            for (let j = 0; j < lstHD.length; j++) {
                                if (lstHD[j].IDRandom === idRandomHD) {
                                    lstHD[j].TTBangDiem = 0;
                                    lstHD[j].DiemQuyDoi = 0;
                                    lstHD[j].DiemGiaoDich = 0;
                                    lstHD[j].DiemKhuyenMai = 0;
                                    break;
                                }
                            }
                        }
                        //console.log('lstHD_reset', JSON.stringify(lstHD));
                        localStorage.setItem(lcListHD, JSON.stringify(lstHD));
                    }
                }
            }
        }
    }
    // use after agreePay
    function UpdateDiemGiaoDich_forHoaDon() {
        var hdOp = [];
        if (self.ThietLap().TinhNangTichDiem) {
            var lstHD = localStorage.getItem(lcListHD);
            if (lstHD !== null) {
                lstHD = JSON.parse(lstHD);
                if (_maHoaDon === '') {
                    _maHoaDon = $('.gara-bill-label li.active font').text();
                }
                var itemHD = GetHDOpening_byMaHoaDon(_maHoaDon, lstHD);
                if (itemHD.length > 0) {
                    var sumCTHD_sale = 0;
                    var sumCTHD_notsale = 0;
                    var sumHH_KM = 0;
                    var sumHH_ofHDKM = 0;
                    let sum_cthd0tichdiem = 0;
                    var idNhomDTs = '';
                    var idRandomHD = itemHD[0].IDRandom;
                    // tinh tien hang khuyen mai cua HD (Khong tich diem cho hang khuyen mai)
                    var lstKM_HD = localStorage.getItem(lcProductKM_HoaDon);
                    if (lstKM_HD !== null) {
                        lstKM_HD = JSON.parse(lstKM_HD);
                        let arrProduct = $.grep(lstKM_HD, function (x) {
                            return x.IDRandomHD === idRandomHD;
                        });
                        for (let i = 0; i < arrProduct.length; i++) {
                            sumHH_ofHDKM += arrProduct[i].ThanhTien;
                        }
                    }
                    // if Khong tich diem cho Sp giam gia
                    if (self.ThietLap_TichDiem() !== null && self.ThietLap_TichDiem().length > 0) {
                        if (self.ThietLap_TichDiem()[0].TichDiemGiamGia) {
                            if (itemHD[0].LoaiHoaDon === 1 || itemHD[0].LoaiHoaDon === 19 || itemHD[0].LoaiHoaDon === 25) {
                                var cthd = localStorage.getItem(lcListCTHD);
                                if (cthd !== null) {
                                    cthd = JSON.parse(cthd);

                                    // sum diem of product ducotichdiem =0
                                    let cthd_notTichDiem = $.grep(cthd, function (x) {
                                        return x.DuocTichDiem === 0;
                                    });
                                    for (let i = 0; i < cthd_notTichDiem.length; i++) {
                                        sum_cthd0tichdiem += cthd_notTichDiem[i].ThanhTien;
                                    }

                                    // only get product with duoctichdiem = 1
                                    cthd = $.grep(cthd, function (x) {
                                        return x.DuocTichDiem === 1;
                                    });
                                    // tinh tong tien cac hang khong giam gia cua HD Mua
                                    for (let i = 0; i < cthd.length; i++) {
                                        var itemCTHD = cthd[i];
                                        if (itemCTHD.IDRandomHD === idRandomHD) {
                                            if (itemCTHD.TienChietKhau === 0) {
                                                sumCTHD_notsale += itemCTHD.ThanhTien;
                                            }
                                            else {
                                                sumCTHD_sale += itemCTHD.ThanhTien;
                                            }
                                            for (let k = 1; k < itemCTHD.DM_LoHang.length; k++) {
                                                if (itemCTHD.DM_LoHang[k].TienChietKhau === 0) {
                                                    sumCTHD_notsale += itemCTHD.DM_LoHang[k].ThanhTien;
                                                }
                                                else {
                                                    sumCTHD_sale += itemCTHD.DM_LoHang[k].ThanhTien;
                                                }
                                            }
                                            for (let k = 0; k < itemCTHD.HangCungLoais.length; k++) {
                                                if (itemCTHD.HangCungLoais[k].TienChietKhau === 0) {
                                                    sumCTHD_notsale += itemCTHD.HangCungLoais[k].ThanhTien;
                                                }
                                                else {
                                                    sumCTHD_sale += itemCTHD.HangCungLoais[k].ThanhTien;
                                                }
                                            }
                                            // tinh tien hang khuyen mai cua hang hoa
                                            for (let j = 0; j < itemCTHD.HangHoa_KM.length; j++) {
                                                sumHH_KM += itemCTHD.HangHoa_KM[j].ThanhTien;
                                            }
                                        }
                                    }
                                }
                            }
                            else {
                                var cthd_TH = localStorage.getItem(lcListCTHD_DoiTra);
                                if (cthd_TH !== null) {
                                    cthd_TH = JSON.parse(cthd_TH);
                                    // sum diem of product ducotichdiem =0
                                    let cthd_notTichDiem = $.grep(cthd_TH, function (x) {
                                        return x.DuocTichDiem === 0;
                                    });
                                    for (let i = 0; i < cthd_notTichDiem.length; i++) {
                                        sum_cthd0tichdiem += cthd_notTichDiem[i].ThanhTien;
                                    }
                                    // only get product with duoctichdiem = 1
                                    cthd_TH = $.grep(cthd_TH, function (x) {
                                        return x.DuocTichDiem === 1;
                                    });
                                    // tinh tong tien cac hang khong giam gia cua HD Doi Tra
                                    for (let i = 0; i < cthd_TH.length; i++) {
                                        var itemCTHD_TH = cthd_TH[i];
                                        if (itemCTHD_TH.IDRandomHD === idRandomHD) {
                                            if (itemCTHD_TH.TienChietKhau === 0) {
                                                sumCTHD_notsale += itemCTHD_TH.ThanhTien;
                                            }
                                            else {
                                                sumCTHD_sale += cthd[i].ThanhTien;
                                            }
                                            // sum DM_Lo, HangCungLoai
                                            for (let k = 1; k < itemCTHD_TH.DM_LoHang.length; k++) {
                                                if (itemCTHD_TH.DM_LoHang[k].TienChietKhau === 0) {
                                                    sumCTHD_notsale += itemCTHD_TH.DM_LoHang[k].ThanhTien;
                                                }
                                                else {
                                                    sumCTHD_sale += itemCTHD_TH.DM_LoHang[k].ThanhTien;
                                                }
                                            }
                                            for (let k = 0; k < itemCTHD_TH.HangCungLoais.length; k++) {
                                                if (itemCTHD_TH.HangCungLoais[k].TienChietKhau === 0) {
                                                    sumCTHD_notsale += itemCTHD_TH.HangCungLoais[k].ThanhTien;
                                                }
                                                else {
                                                    sumCTHD_sale += itemCTHD_TH.HangCungLoais[k].ThanhTien;
                                                }
                                            }
                                            // tinh tien hang khuyen mai cua hang hoa
                                            for (let j = 0; j < itemCTHD_TH.HangHoa_KM.length; j++) {
                                                sumHH_KM += itemCTHD_TH.HangHoa_KM[j].ThanhTien;
                                            }
                                        }
                                    }
                                }
                            }
                        }

                        // diem GD cua HH co giam gia
                        var diemGD_ofHHsale = Math.floor(sumCTHD_sale / self.ThietLap_TichDiem()[0].TyLeDoiDiem);
                        // diem GD cua all Hang Khuyen Mai (HH + HD)
                        var diemGD_ofHHKM = Math.floor((sumHH_ofHDKM + sumHH_KM) / self.ThietLap_TichDiem()[0].TyLeDoiDiem);
                        let diemGD_cthd0tichdiem = Math.floor(sum_cthd0tichdiem / self.ThietLap_TichDiem()[0].TyLeDoiDiem);
                        // diem GD cua HoaDon
                        var diemGD_ofHD = Math.floor((formatNumberToFloat(itemHD[0].TongTienHang) - formatNumberToFloat(itemHD[0].TongGiamGiaKM_HD)) / self.ThietLap_TichDiem()[0].TyLeDoiDiem);
                        // diem GD sau khi tru diem GD khuyen mai
                        var diemGiaoDich = diemGD_ofHD - diemGD_ofHHKM - diemGD_cthd0tichdiem;
                        if (self.ChiTietDoiTuong() !== null && self.ChiTietDoiTuong().length > 0) {
                            if (self.ChiTietDoiTuong()[0].ID_NhomDoiTuong === null || self.ChiTietDoiTuong()[0].ID_NhomDoiTuong === undefined) {
                                idNhomDTs = '';
                            }
                            else {
                                idNhomDTs = self.ChiTietDoiTuong()[0].ID_NhomDoiTuong.toLowerCase();
                            }
                            // Tich Diem for all KH
                            if (self.ThietLap_TichDiem()[0].ToanBoKhachHang) {
                                // if Khong tich diem cho Sp giam gia
                                if (self.ThietLap_TichDiem()[0].TichDiemGiamGia) {
                                    // if Khong tich diem cho HD thanh toan = diem
                                    if (self.ThietLap_TichDiem()[0].TichDiemHoaDonDiemThuong) {
                                        // if Khong tich diem cho HD Giam Gia
                                        if (self.ThietLap_TichDiem()[0].TichDiemHoaDonGiamGia) {
                                            // check xem HD co dang duoc giam gia khong
                                            if (itemHD[0].TongGiamGiaKM_HD > 0) {
                                                // neu co Giam Gia --> khong update gi ca
                                                for (let i = 0; i < lstHD.length; i++) {
                                                    if (lstHD[i].IDRandom === idRandomHD && lstHD[i].LoaiHoaDon !== 3) {
                                                        lstHD[i].DiemGiaoDich = 0;
                                                        break;
                                                    }
                                                }
                                            }
                                            else {
                                                // check xem co TT = diem Khong
                                                // neu HD khong TT = diem --> update DiemGiaoDich for HangHoa khong giam gia
                                                if (itemHD[0].DiemQuyDoi === 0) {
                                                    for (let i = 0; i < lstHD.length; i++) {
                                                        if (lstHD[i].IDRandom === idRandomHD && lstHD[i].LoaiHoaDon !== 3) {
                                                            lstHD[i].DiemGiaoDich = Math.floor(sumCTHD_notsale / self.ThietLap_TichDiem()[0].TyLeDoiDiem);
                                                            break;
                                                        }
                                                    }
                                                }
                                                else {
                                                    // neu HD tt = diem --> update DiemQuyDoi, not update DiemGiaoDich
                                                    for (let i = 0; i < lstHD.length; i++) {
                                                        if (lstHD[i].IDRandom === idRandomHD && lstHD[i].LoaiHoaDon !== 3) {
                                                            lstHD[i].DiemGiaoDich = 0;
                                                            break;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        else {
                                            // check xem co HD TT = diem Khong
                                            // neu HD khong TT = diem --> update DiemGiaoDich for HangHoa khong giam gia
                                            if (itemHD[0].DiemQuyDoi === 0) {
                                                for (let i = 0; i < lstHD.length; i++) {
                                                    if (lstHD[i].IDRandom === idRandomHD && lstHD[i].LoaiHoaDon !== 3) {
                                                        // diemGD = diemGD of HD - diemGD of HH co giam gia (OK)
                                                        let diemGD = diemGiaoDich - diemGD_ofHHsale;
                                                        lstHD[i].DiemGiaoDich = diemGD > 0 ? diemGD : 0;
                                                        break;
                                                    }
                                                }
                                            }
                                            else {
                                                // neu HD tt = diem --> update DiemQuyDoi, not update DiemGiaoDich
                                                for (let i = 0; i < lstHD.length; i++) {
                                                    if (lstHD[i].IDRandom === idRandomHD && lstHD[i].LoaiHoaDon !== 3) {
                                                        lstHD[i].DiemGiaoDich = 0;
                                                        break;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    else {
                                        if (self.ThietLap_TichDiem()[0].TichDiemHoaDonGiamGia) {
                                            // check Giam Gia in HD
                                            if (itemHD[0].TongGiamGiaKM_HD > 0) {
                                                // neu co Giam Gia --> khong update gi ca
                                                for (let i = 0; i < lstHD.length; i++) {
                                                    if (lstHD[i].IDRandom === idRandomHD && lstHD[i].LoaiHoaDon !== 3) {
                                                        lstHD[i].DiemGiaoDich = 0;
                                                        break;
                                                    }
                                                }
                                            }
                                            else {
                                                //  neu khong co GG --> update DiemQuiDoi +  SP khong giam gia
                                                for (let i = 0; i < lstHD.length; i++) {
                                                    if (lstHD[i].IDRandom === idRandomHD && lstHD[i].LoaiHoaDon !== 3) {
                                                        lstHD[i].DiemGiaoDich = Math.floor(sumCTHD_notsale / self.ThietLap_TichDiem()[0].TyLeDoiDiem);
                                                        break;
                                                    }
                                                }
                                            }
                                        }
                                        else {
                                            // Giong truong hop Khong co GG in HD
                                            // TichDiem cho HD TT = diem + SP khong giam gia (Van Tich diem cho HD tt = diem, nhung chi tich diem cho Sp giam gia)
                                            for (let i = 0; i < lstHD.length; i++) {
                                                if (lstHD[i].IDRandom === idRandomHD && lstHD[i].LoaiHoaDon !== 3) {
                                                    // diemGD = diemGD of HD - diemGD of HH co giam gia (OK)
                                                    let diemGD = diemGiaoDich - diemGD_ofHHsale;
                                                    lstHD[i].DiemGiaoDich = diemGD > 0 ? diemGD : 0;
                                                    break;
                                                }
                                            }
                                        }
                                    }
                                }
                                else {
                                    // tich diem cho all SP
                                    if (self.ThietLap_TichDiem()[0].TichDiemHoaDonDiemThuong) {
                                        // Khong Tich Diem cho HD Giam Gia
                                        if (self.ThietLap_TichDiem()[0].TichDiemHoaDonGiamGia) {
                                            if (itemHD[0].TongGiamGiaKM_HD > 0) {
                                                // neu co Giam Gia --> khong update gi ca
                                                for (let i = 0; i < lstHD.length; i++) {
                                                    if (lstHD[i].IDRandom === idRandomHD && lstHD[i].LoaiHoaDon !== 3) {
                                                        lstHD[i].DiemGiaoDich = 0;
                                                        break;
                                                    }
                                                }
                                            }
                                            else {
                                                // check xem co TT = diem Khong
                                                // neu HD khong TT = diem --> update DiemGiaoDich for HangHoa khong giam gia
                                                if (itemHD[0].DiemQuyDoi === 0) {
                                                    for (let i = 0; i < lstHD.length; i++) {
                                                        if (lstHD[i].IDRandom === idRandomHD && lstHD[i].LoaiHoaDon !== 3) {
                                                            lstHD[i].DiemGiaoDich = diemGiaoDich;
                                                            break;
                                                        }
                                                    }
                                                }
                                                else {
                                                    // neu HD tt = diem --> update DiemQuyDoi, not update DiemGiaoDich
                                                    for (let i = 0; i < lstHD.length; i++) {
                                                        if (lstHD[i].IDRandom === idRandomHD && lstHD[i].LoaiHoaDon !== 3) {
                                                            lstHD[i].DiemGiaoDich = 0;
                                                            break;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        else {
                                            // Tich Diem HD Giam Gia = false
                                            if (itemHD[0].DiemQuyDoi === 0) {
                                                for (let i = 0; i < lstHD.length; i++) {
                                                    if (lstHD[i].IDRandom === idRandomHD && lstHD[i].LoaiHoaDon !== 3) {
                                                        lstHD[i].DiemGiaoDich = diemGiaoDich;
                                                        break;
                                                    }
                                                }
                                            }
                                            else {
                                                // neu HD tt = diem --> update DiemQuyDoi, not update DiemGiaoDich
                                                for (let i = 0; i < lstHD.length; i++) {
                                                    if (lstHD[i].IDRandom === idRandomHD && lstHD[i].LoaiHoaDon !== 3) {
                                                        lstHD[i].DiemGiaoDich = 0;
                                                        break;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    else {
                                        // tich diem for all SP + HD tt = diem
                                        for (let i = 0; i < lstHD.length; i++) {
                                            if (lstHD[i].IDRandom === idRandomHD && lstHD[i].LoaiHoaDon !== 3) {
                                                lstHD[i].DiemGiaoDich = diemGiaoDich;
                                                break;
                                            }
                                        }
                                    }
                                }
                            }
                            else {
                                // Tich Diem Theo Nhom KH
                                for (let i = 0; i < self.ThietLap_TichDiem().length; i++) {
                                    // if KH thuoc nhom duoc tich diem
                                    if (idNhomDTs.indexOf(self.ThietLap_TichDiem()[i].ID_NhomDoiTuong) > -1) {
                                        // if Khong tich diem cho Sp giam gia
                                        if (self.ThietLap_TichDiem()[i].TichDiemGiamGia) {
                                            // if Khong tich diem cho HD thanh toan = diem
                                            if (self.ThietLap_TichDiem()[i].TichDiemHoaDonDiemThuong) {
                                                // if Khong tich diem cho HD Giam Gia
                                                if (self.ThietLap_TichDiem()[i].TichDiemHoaDonGiamGia) {
                                                    // check xem HD co dang duoc giam gia khong
                                                    if (itemHD[0].TongGiamGiaKM_HD > 0) {
                                                        // neu co Giam Gia --> khong update gi ca
                                                        for (let j = 0; j < lstHD.length; j++) {
                                                            if (lstHD[j].IDRandom === idRandomHD && lstHD[j].LoaiHoaDon !== 3) {
                                                                lstHD[j].DiemGiaoDich = 0;
                                                                break;
                                                            }
                                                        }
                                                    }
                                                    else {
                                                        // check xem co TT = diem Khong
                                                        // neu HD khong TT = diem --> update DiemGiaoDich for HangHoa khong giam gia
                                                        if (itemHD[0].DiemQuyDoi === 0) {
                                                            for (let j = 0; j < lstHD.length; j++) {
                                                                if (lstHD[j].IDRandom === idRandomHD && lstHD[j].LoaiHoaDon !== 3) {
                                                                    lstHD[j].DiemGiaoDich = Math.round(sumCTHD_notsale / self.ThietLap_TichDiem()[i].TyLeDoiDiem);
                                                                    break;
                                                                }
                                                            }
                                                        }
                                                        else {
                                                            // neu HD tt = diem --> update DiemQuyDoi, not update DiemGiaoDich
                                                            for (let j = 0; j < lstHD.length; j++) {
                                                                if (lstHD[j].IDRandom === idRandomHD && lstHD[j].LoaiHoaDon !== 3) {
                                                                    lstHD[j].DiemGiaoDich = 0;
                                                                    break;
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                else {
                                                    // check xem co HD TT = diem Khong
                                                    // neu HD khong TT = diem --> update DiemGiaoDich for HangHoa khong giam gia
                                                    if (itemHD[0].DiemQuyDoi === 0) {
                                                        for (let j = 0; j < lstHD.length; j++) {
                                                            if (lstHD[j].IDRandom === idRandomHD && lstHD[j].LoaiHoaDon !== 3) {
                                                                let diemGD = diemGiaoDich - diemGD_ofHHsale;
                                                                lstHD[i].DiemGiaoDich = diemGD > 0 ? diemGD : 0;
                                                                break;
                                                            }
                                                        }
                                                    }
                                                    else {
                                                        // neu HD tt = diem --> update DiemQuyDoi, not update DiemGiaoDich
                                                        for (let j = 0; j < lstHD.length; j++) {
                                                            if (lstHD[j].IDRandom === idRandomHD && lstHD[j].LoaiHoaDon !== 3) {
                                                                lstHD[j].DiemGiaoDich = 0;
                                                                break;
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            else {
                                                if (self.ThietLap_TichDiem()[i].TichDiemHoaDonGiamGia) {
                                                    // check Giam Gia in HD
                                                    if (itemHD[0].TongGiamGiaKM_HD > 0) {
                                                        // neu co Giam Gia --> khong update gi ca
                                                        for (let j = 0; j < lstHD.length; j++) {
                                                            if (lstHD[j].IDRandom === idRandomHD && lstHD[j].LoaiHoaDon !== 3) {
                                                                lstHD[j].DiemGiaoDich = 0;
                                                                break;
                                                            }
                                                        }
                                                    }
                                                    else {
                                                        //  neu khong co GG --> update DiemQuiDoi +  SP khong giam gia
                                                        for (let j = 0; j < lstHD.length; j++) {
                                                            if (lstHD[j].IDRandom === idRandomHD && lstHD[j].LoaiHoaDon !== 3) {
                                                                lstHD[j].DiemGiaoDich = Math.round(sumCTHD_notsale / self.ThietLap_TichDiem()[i].TyLeDoiDiem);
                                                                break;
                                                            }
                                                        }
                                                    }
                                                }
                                                else {
                                                    // Giong truong hop Khong co GG in HD
                                                    // TichDiem cho HD TT = diem + SP khong giam gia (Van Tich diem cho HD tt = diem, nhung chi tich diem cho Sp giam gia)
                                                    for (let j = 0; j < lstHD.length; j++) {
                                                        if (lstHD[j].IDRandom === idRandomHD && lstHD[j].LoaiHoaDon !== 3) {
                                                            let diemGD = diemGiaoDich - diemGD_ofHHsale;
                                                            lstHD[j].DiemGiaoDich = diemGD > 0 ? diemGD : 0;
                                                            break;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        else {
                                            // tich diem cho all SP
                                            if (self.ThietLap_TichDiem()[i].TichDiemHoaDonDiemThuong) {
                                                // Khong Tich Diem cho HD Giam Gia
                                                if (self.ThietLap_TichDiem()[i].TichDiemHoaDonGiamGia) {
                                                    if (itemHD[0].TongGiamGiaKM_HD > 0) {
                                                        // neu co Giam Gia --> khong update gi ca
                                                        for (let j = 0; j < lstHD.length; j++) {
                                                            if (lstHD[j].IDRandom === idRandomHD && lstHD[j].LoaiHoaDon !== 3) {
                                                                lstHD[j].DiemGiaoDich = 0;
                                                                break;
                                                            }
                                                        }
                                                    }
                                                    else {
                                                        // check xem co TT = diem Khong
                                                        // neu HD khong TT = diem --> update DiemGiaoDich for HangHoa khong giam gia
                                                        if (itemHD[0].DiemQuyDoi === 0) {
                                                            for (let j = 0; j < lstHD.length; j++) {
                                                                if (lstHD[j].IDRandom === idRandomHD && lstHD[j].LoaiHoaDon !== 3) {
                                                                    lstHD[j].DiemGiaoDich = diemGiaoDich;
                                                                    break;
                                                                }
                                                            }
                                                        }
                                                        else {
                                                            // neu HD tt = diem --> update DiemQuyDoi, not update DiemGiaoDich
                                                            for (let j = 0; j < lstHD.length; j++) {
                                                                if (lstHD[j].IDRandom === idRandomHD && lstHD[j].LoaiHoaDon !== 3) {
                                                                    lstHD[j].DiemGiaoDich = 0;
                                                                    break;
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                else {
                                                    // Tich Diem HD Giam Gia = false
                                                    if (itemHD[0].DiemQuyDoi === 0) {
                                                        for (let j = 0; j < lstHD.length; j++) {
                                                            if (lstHD[j].IDRandom === idRandomHD && lstHD[j].LoaiHoaDon !== 3) {
                                                                lstHD[j].DiemGiaoDich = diemGiaoDich;
                                                                break;
                                                            }
                                                        }
                                                    }
                                                    else {
                                                        // neu HD tt = diem --> update DiemQuyDoi, not update DiemGiaoDich
                                                        for (let j = 0; j < lstHD.length; j++) {
                                                            if (lstHD[j].IDRandom === idRandomHD && lstHD[j].LoaiHoaDon !== 3) {
                                                                lstHD[j].DiemGiaoDich = 0;
                                                                break;
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            else {
                                                // tich diem for all SP + HD tt = diem
                                                for (let j = 0; j < lstHD.length; j++) {
                                                    if (lstHD[j].IDRandom === idRandomHD && lstHD[j].LoaiHoaDon !== 3) {
                                                        lstHD[j].DiemGiaoDich = diemGiaoDich;
                                                        break;
                                                    }
                                                }
                                            }
                                        }
                                        break; // esc if Check ThietLap_TichDiem().ID_NhomDoiTuong === idNhomDTs
                                    }
                                }
                            }
                        }
                        else {
                            // khach le --> khong tich diem
                            for (let j = 0; j < lstHD.length; j++) {
                                if (lstHD[j].IDRandom === idRandomHD && lstHD[j].LoaiHoaDon !== 3) {
                                    lstHD[j].DiemGiaoDich = 0;
                                    break;
                                }
                            }
                        }
                        hdOp = $.grep(lstHD, function (x) { // used to TamLuu sau do ThanhToan --> get DiemGiaoDich
                            return x.IDRandom === idRandomHD;
                        })
                        localStorage.setItem(lcListHD, JSON.stringify(lstHD));
                    }
                }
            }
        }
        return hdOp;
    }
    // use if Khuyen Mai = 23,14 (KM cong diem)
    function UpdateDiemCong_KMCongDiem(idRandomHD, diemCong, isKMHoaDon) {
        // get diemkhuyenmai in cthd
        var diemHangHoa = 0;
        var cthd = localStorage.getItem(lcListCTHD);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            for (let i = 0; i < cthd.length; i++) {
                if (cthd[i].IDRandomHD === idRandomHD) {
                    if (isNaN(cthd[i].DiemKhuyenMai) === false) {
                        diemHangHoa += cthd[i].DiemKhuyenMai;
                    }
                }
            }
        }
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            for (let i = 0; i < lstHD.length; i++) {
                if (lstHD[i].IDRandom === idRandomHD) {
                    if (isKMHoaDon) {
                        lstHD[i].DiemKhuyenMai = diemCong;
                        lstHD[i].DiemCong = diemCong + diemHangHoa;
                    }
                    else {
                        lstHD[i].DiemCong = diemHangHoa;
                    }
                    break;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(lstHD));
        }
    }
    function UpdateDiemKhuyenMai_CTHD(diemCong) {
        var cthd = localStorage.getItem(lcListCTHD);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            for (let i = 0; i < cthd.length; i++) {
                if (cthd[i].IDRandom === self.CTHD_ChosingKM().IDRandom) {
                    cthd[i].DiemKhuyenMai = diemCong;
                    break;
                }
            }
            localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
        }
    }
    function Enable_DisableNgayLapHD() {
        if (_maHoaDon === '') {
            _maHoaDon = $('.gara-bill-label li.active font').text();
        }
        var loaiHoaDon = 1;
        var isHDoffline = false;
        var itemHD = [];
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            itemHD = GetHDOpening_byMaHoaDon(_maHoaDon, lstHD);
        }
        if (itemHD.length > 0) {
            loaiHoaDon = itemHD[0].LoaiHoaDon;
            isHDoffline = itemHD[0].StatusOffline;
        }
        else {
            loaiHoaDon = GetLoaiHoaDon_ofHDopening();
        }
        if (isHDoffline === false) {
            // check role change NVien
            var maQuyen = '';
            switch (loaiHoaDon) {
                case 1:
                case 25:
                    maQuyen = 'HoaDon_ThayDoiThoiGian';
                    break;
                case 3:
                    maQuyen = 'DatHang_ThayDoiThoiGian';
                    break;
                case 6:
                    maQuyen = 'TraHang_ThayDoiThoiGian';
                    break;
                case 19:
                    maQuyen = 'GoiDichVu_ThayDoiThoiGian';
                    break;
            }
            var itemRole = $.grep(self.Quyen_NguoiDung(), function (x) {
                return x.MaQuyen === maQuyen;
            });
            var roleChangeNgayLapHD = itemRole.length > 0;
            if (roleChangeNgayLapHD) {
                $('#datepicker, #timepicker').removeAttr('disabled');
            }
            else {
                $('#datepicker, #timepicker').attr('disabled', 'disabled');
            }
        }
    }

    //load danh sách tỉnh thành.
    self.VungMiens = ko.observableArray();
    self.KhachHang_HangHoa = ko.observableArray();
    function WriteData_Dexie(tbl, data) {
        db.transaction("rw", tbl, () => {
            tbl.bulkPut(data);
        }).catch(function (e) {
            console.log(tbl.name, e);
        });
    }

    function CheckRole() {
        vmThanhToanGara.RoleChange_ChietKhauNV = CheckQuyenExist('HoaHong_ThayDoi');
        self.RoleChange_ChietKhauNV(CheckQuyenExist('HoaHong_ThayDoi'));
        self.RoleView_ChietKhauNV(CheckQuyenExist('BanHang_HoaDongDichVu_XemChietKhau'));

        self.RoleInsert_Invoice(CheckQuyenExist('HoaDon_ThemMoi'));
        self.RoleInsert_Order(CheckQuyenExist('DatHang_ThemMoi'));
        self.RoleInsert_Service(CheckQuyenExist('GoiDichVu_ThemMoi'));
        self.RoleXuly_Order(CheckQuyenExist('DatHang_TaoHoaDon'));
        self.RoleInsert_Return(CheckQuyenExist('TraHang_ThemMoi'));

        self.roleChangePriceProduct_Invoice(CheckQuyenExist('HoaDon_ThayDoiGia'));
        self.roleChangeSale_Invoice(CheckQuyenExist('HoaDon_GiamGia'));
        self.roleChangePriceProduct_Order(CheckQuyenExist('DatHang_ThayDoiGia'));
        self.roleChangeSale_Order(CheckQuyenExist('DatHang_GiamGia'));
        self.roleChangePriceProduct_Return(CheckQuyenExist('TraHang_ThayDoiGia'));
        self.roleChangeSale_Return(CheckQuyenExist('TraHang_GiamGia'));
        self.roleChangePriceProduct_ServicePackage(CheckQuyenExist('GoiDichVu_ThayDoiGia'));
        self.roleChangeSale_ServicePackage(CheckQuyenExist('GoiDichVu_GiamGia'));

        self.roleCustomer_Insert(CheckQuyenExist('KhachHang_ThemMoi'));
        self.roleCustomer_ThanhToanNo(CheckQuyenExist('KhachHang_ThanhToanNo'));

        vmThanhToan.role.PhieuThu.Insert = CheckQuyenExist('SoQuy_ThemMoi');
        vmThanhToan.role.PhieuThu.Update = CheckQuyenExist('SoQuy_CapNhat');
        vmThanhToan.role.PhieuThu.Delete = CheckQuyenExist('SoQuy_Xoa');
        vmThanhToan.role.PhieuThu.ChangeNgayLap = CheckQuyenExist('SoQuy_ThayDoiThoiGian');
    }

    function GetHT_Quyen_ByNguoiDung() {
        ajaxHelper('/api/DanhMuc/HT_NguoiDungAPI/' + "GetListQuyen_OfNguoiDung", 'GET').done(function (data) {
            $('body').gridLoader({ show: false });

            if (data !== "" && data.length > 0) {
                self.Quyen_NguoiDung(data);

                CheckRole();

                vmHoaHongDV.role.XemChietKhau = CheckQuyenExist('BanHang_HoaDongDichVu_XemChietKhau');
                vmHoaHongDV.role.ThayDoiChietKhau = CheckQuyenExist('HoaHong_ThayDoi');
                vmThemMoiKhach.role.KhachHang.CapNhat = CheckQuyenExist('KhachHang_CapNhat');
                vmThemMoiKhach.role.KhachHang.ThemMoi = CheckQuyenExist('KhachHang_ThemMoi');

                DeleteHD_CTHD_ifNotRole();
                roleLoadEnd = true;
                // use when HangHoa load finished, but Quyen_NguoiDung has not finish --> update TonKho,Warning CTHD
                if (IsShop_SpaSalon()) {
                    self.ClickTab_PhongBan(false, true);
                }
                else {
                    getListHoaDonLe();
                    ActiveTab_SoDoPhong(false);
                }
                UpdateTonKhoCTHD_FirstLoad(lcListCTHD);
                UpdateTonKhoCTHD_FirstLoad(lcListCTHD_DoiTra);
            }
            else {
                ShowMessage_Danger('Không có quyền ');
            }
        })
    }

    function DeleteHD_CTHD_ifNotRole() {
        var hd = localStorage.getItem(lcListHD);
        if (hd !== null) {
            hd = JSON.parse(hd);

            // remove hd
            if (!self.RoleInsert_Invoice()) {
                hd = $.grep(hd, function (x) {
                    return x.NguoiTao !== userLogin || (x.NguoiTao === userLogin && x.LoaiHoaDon !== 1);
                });
            }
            // remove dathang
            if (!self.RoleInsert_Order()) {
                hd = $.grep(hd, function (x) {
                    return x.NguoiTao !== userLogin || (x.NguoiTao === userLogin && x.LoaiHoaDon !== 3);
                });
            }

            // remove goidv
            if (!self.RoleInsert_Service()) {
                hd = $.grep(hd, function (x) {
                    return x.NguoiTao !== userLogin || (x.NguoiTao === userLogin && x.LoaiHoaDon !== 19);
                });
            }
            // remove trahang
            if (!self.RoleInsert_Return()) {
                hd = $.grep(hd, function (x) {
                    return x.NguoiTao !== userLogin || (x.NguoiTao === userLogin && x.LoaiHoaDon !== 6);
                });
            }

            // get arrIDRandomHD
            var arrIDRandom = [];
            for (let i = 0; i < hd.length; i++) {
                arrIDRandom.push(hd[i].IDRandom);
            }

            var cthd = localStorage.getItem(lcListCTHD);
            if (cthd !== null) {
                cthd = JSON.parse(cthd);
                cthd = $.grep(cthd, function (x) {
                    return $.inArray(x.IDRandomHD, arrIDRandom) > -1
                });
                localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
            }
            localStorage.setItem(lcListHD, JSON.stringify(hd));
        }
    }
    function Call_6Func(firstLoad) {
        firstLoad = firstLoad || false;
        Caculator_AmountProduct();
        NhapThuong_HideShow_txtDonGia();
        Enable_DisableNgayLapHD();
        SetPageSize_FullProduct(false);
        HideShow_Icon_ChietKhauNV();
        SetText_aReturn();
    }
    function SetText_aReturn() {
        if (_maHoaDon === '') {
            _maHoaDon = $('.gara-bill-label li.active font').text();
        }
        if (_maHoaDon.indexOf('DV') > 0) {
            $('#aReturn').text('Chọn trả gói dịch vụ')
        }
        else {
            $('#aReturn').text('Chọn hóa đơn trả hàng');
        }
    }
    function IsShop_SpaSalon() {
        if (shopCookies === 'AC9DF2ED-FF08-488F-9A64-08433E541020' || shopCookies === '83894499-AEFA-4F58-96B4-5EC1A0B16A76') {
            return true;
        }
        else {
            return false;
        }
    }

    function NhapThuong_HideShow_txtDonGia() {
        if (!self.IsNhapNhanh()) {
            //chống nhảy dòng cho nhập nhanh
            $('#pressNormal').delay(400).fadeIn();
            $("#searchandadd").css("width", "calc(100% - 210px)");
        }
        else {
            $('#pressNormal').hide();
            $("#searchandadd").css("width", "calc(100% - 50px)")
        }

        var roleChangePriceProduct = false;
        var loaiHoaDon = GetLoaiHoaDon_ofHDopening();
        switch (loaiHoaDon) {
            case 1:
            case 25:
                roleChangePriceProduct = self.roleChangePriceProduct_Invoice();
                break;
            case 3:
                roleChangePriceProduct = self.roleChangePriceProduct_Order();
                break;
            case 6:
                roleChangePriceProduct = self.roleChangePriceProduct_Return();
                break;
            case 19:
                roleChangePriceProduct = self.roleChangePriceProduct_ServicePackage();
                break;
        }
        self.roleChangePriceProduct(roleChangePriceProduct);
    }
    function GetListHD_Opening() {
        var lstHD = localStorage.getItem(lcListHD);
        var lstHDisOpening = [];
        if (lstHD !== null && lstHD !== 'null') {
            lstHD = JSON.parse(lstHD);
            var lstHD_byUser = $.grep(lstHD, function (item) {
                return item.Status === 1 &&
                    (item.NguoiTao === userLogin || item.TrangThaiHD === 3); // get HD this user OR client (if hd client is opening)
            });
            lstHDisOpening = lstHD_byUser;
            if (!self.RoleInsert_Invoice()) {
                lstHDisOpening = $.grep(lstHD_byUser, function (x) {
                    return x.LoaiHoaDon !== 1 && x.LoaiHoaDon !== 25;
                });
            }
            if (!self.RoleInsert_Order()) {
                lstHDisOpening = $.grep(lstHD_byUser, function (x) {
                    return x.LoaiHoaDon !== 3;
                });
            }
            if (!self.RoleInsert_Service()) {
                lstHDisOpening = $.grep(lstHD_byUser, function (x) {
                    return x.LoaiHoaDon !== 19;
                });
            }
            if (!self.RoleInsert_Return()) {
                lstHDisOpening = $.grep(lstHD_byUser, function (x) {
                    return x.LoaiHoaDon !== 6;
                });
            }
        }
        return lstHDisOpening;
    }

    function updatePTVND(arr, ctDoing, loai, gtri, dvt) {
        var quanlytheolo = ctDoing.QuanLyTheoLoHang;
        var concungloai = ctDoing.LaConCungLoai;
        var lotParent = ctDoing.LotParent;
        var idRandom = ctDoing.IDRandom;

        if (lotParent || (concungloai === false && quanlytheolo === false)) {
            for (let i = 0; i < arr.length; i++) {
                if (arr[i].IDRandom === idRandom) {
                    switch (loai) {
                        case 1:// ck
                            arr[i].PTChietKhau = gtri;
                            arr[i].DVTinhGiam = dvt;
                            break;
                        case 2://thue
                            arr[i].PTThue = gtri;
                            break;
                    }
                    if (lotParent) {
                        arr[i].DM_LoHang[0].PTChietKhau = arr[i].PTChietKhau;
                        arr[i].DM_LoHang[0].DVTinhGiam = arr[i].DVTinhGiam;
                        arr[i].DM_LoHang[0].PTThue = arr[i].PTThue;
                    }
                    break;
                }
            }
        }
        else {
            if (quanlytheolo) {
                for (let i = 0; i < arr.length; i++) {
                    for (let j = 0; j < arr[i].DM_LoHang.length; j++) {
                        if (arr[i].DM_LoHang[j].IDRandom === idRandom) {
                            switch (loai) {
                                case 1:// ck
                                    arr[i].DM_LoHang[j].PTChietKhau = gtri;
                                    arr[i].DM_LoHang[j].DVTinhGiam = dvt;
                                    break;
                                case 2://thue
                                    arr[i].DM_LoHang[j].PTThue = gtri;
                                    break;
                            }
                            i = arr.length;// used to esc out for loop
                            break;
                        }
                    }
                }
            }
            else {
                for (let i = 0; i < arr.length; i++) {
                    for (let j = 0; j < arr[i].HangCungLoais.length; j++) {
                        if (arr[i].HangCungLoais[j].IDRandom === idRandom) {
                            switch (loai) {
                                case 1:// ck
                                    arr[i].HangCungLoais[j].PTChietKhau = gtri;
                                    arr[i].HangCungLoais[j].DVTinhGiam = dvt;
                                    break;
                                case 2://thue
                                    arr[i].HangCungLoais[j].PTThue = gtri;
                                    break;
                            }
                            i = arr.length;
                            break;
                        }
                    }
                }
            }
        }
        return arr;
    }

    function updateCTHDLe(arr, ctDoing) {
        var quanlytheolo = ctDoing.QuanLyTheoLoHang;
        var concungloai = ctDoing.LaConCungLoai;
        var lotParent = ctDoing.LotParent;
        var idRandom = ctDoing.IDRandom;

        var newSoLuong = ctDoing.SoLuong;
        var newGiaBan = ctDoing.GiaBan;
        var tienGiam = ctDoing.TienChietKhau;
        var ptGiam = ctDoing.PTChietKhau;
        var tienThue = ctDoing.TienThue;
        var ptThue = ctDoing.PTThue;
        var thanhtien = ctDoing.ThanhTien;
        var thanhtoan = ctDoing.ThanhToan;
        var giaBHDuyet = ctDoing.DonGiaBaoHiem;

        if (lotParent || (concungloai === false && quanlytheolo === false)) {
            for (let i = 0; i < arr.length; i++) {
                if (arr[i].IDRandom === idRandom) {
                    if (arr[i].ChatLieu !== '4') {
                        arr[i].ThanhTien = thanhtien;
                        arr[i].ThanhToan = thanhtoan;
                    }
                    else {
                        arr[i].ThanhTien = 0;
                        arr[i].ThanhToan = 0;
                    }
                    // phidichvu: tinh theo thanhtien
                    if (arr[i].LaPTPhiDichVu) {
                        arr[i].TongPhiDichVu = Math.round(arr[i].PhiDichVu * newSoLuong * newGiaBan / 100);
                    }
                    else {
                        arr[i].TongPhiDichVu = arr[i].PhiDichVu * newSoLuong;
                    }
                    arr[i].SoLuong = newSoLuong;
                    arr[i].GiaBan = newGiaBan;
                    arr[i].DonGia = newGiaBan;
                    arr[i].PTChietKhau = ptGiam;
                    arr[i].TienChietKhau = tienGiam;
                    arr[i].PTThue = ptThue;
                    arr[i].TienThue = tienThue;
                    arr[i].DonGiaBaoHiem = giaBHDuyet;

                    if (lotParent) {
                        arr[i].DM_LoHang[0].SoLuong = newSoLuong;
                        arr[i].DM_LoHang[0].GiaBan = newGiaBan;
                        arr[i].DM_LoHang[0].DonGia = newGiaBan;
                        arr[i].DM_LoHang[0].PTChietKhau = ptGiam;
                        arr[i].DM_LoHang[0].TienChietKhau = tienGiam;
                        arr[i].DM_LoHang[0].PTThue = ptThue;
                        arr[i].DM_LoHang[0].TienThue = tienThue;
                        arr[i].DM_LoHang[0].ThanhTien = arr[i].ThanhTien;
                        arr[i].DM_LoHang[0].ThanhToan = arr[i].ThanhToan;
                        arr[i].DM_LoHang[0].TongPhiDichVu = arr[i].TongPhiDichVu;
                    }
                    break;
                }
            }
        }
        else {
            if (quanlytheolo) {
                for (let i = 0; i < arr.length; i++) {
                    for (let j = 0; j < arr[i].DM_LoHang.length; j++) {
                        if (arr[i].DM_LoHang[j].IDRandom === idRandom) {
                            if (arr[i].DM_LoHang[j].ChatLieu !== '4') {// tragoiDV: van update ThanhTien
                                arr[i].DM_LoHang[j].ThanhTien = thanhtien;
                                arr[i].DM_LoHang[j].ThanhToan = thanhtoan;
                            }
                            else {
                                arr[i].DM_LoHang[j].ThanhTien = 0;
                                arr[i].DM_LoHang[j].ThanhToan = 0;
                            }
                            if (arr[i].DM_LoHang[j].LaPTPhiDichVu) {
                                arr[i].DM_LoHang[j].TongPhiDichVu = Math.round(arr[i].DM_LoHang[j].PhiDichVu * newSoLuong * newGiaBan / 100);
                            }
                            else {
                                arr[i].DM_LoHang[j].TongPhiDichVu = arr[i].DM_LoHang[j].PhiDichVu * newSoLuong;
                            }
                            arr[i].DM_LoHang[j].SoLuong = newSoLuong;
                            arr[i].DM_LoHang[j].GiaBan = newGiaBan;
                            arr[i].DM_LoHang[j].DonGia = newGiaBan;
                            arr[i].DM_LoHang[j].PTChietKhau = ptGiam;
                            arr[i].DM_LoHang[j].TienChietKhau = tienGiam;
                            arr[i].DM_LoHang[j].PTThue = ptThue;
                            arr[i].DM_LoHang[j].TienThue = tienThue;
                            arr[i].DM_LoHang[j].DonGiaBaoHiem = giaBHDuyet;
                            i = arr.length;// used to esc out for loop
                            break;
                        }
                    }
                }
            }
            else {
                for (let i = 0; i < arr.length; i++) {
                    for (let j = 0; j < arr[i].HangCungLoais.length; j++) {
                        if (arr[i].HangCungLoais[j].IDRandom === idRandom) {
                            if (arr[i].HangCungLoais[j].ChatLieu !== '4') {
                                arr[i].HangCungLoais[j].ThanhTien = thanhtien;
                                arr[i].HangCungLoais[j].ThanhToan = thanhtoan;
                            }
                            else {
                                arr[i].HangCungLoais[j].ThanhTien = 0;
                                arr[i].HangCungLoais[j].ThanhToan = 0;
                            }
                            if (arr[i].HangCungLoais[j].LaPTPhiDichVu) {
                                arr[i].HangCungLoais[j].TongPhiDichVu = Math.round(arr[i].HangCungLoais[j].PhiDichVu * newSoLuong * newGiaBan / 100);
                            }
                            else {
                                arr[i].HangCungLoais[j].TongPhiDichVu = arr[i].HangCungLoais[j].PhiDichVu * newSoLuong;
                            }
                            arr[i].HangCungLoais[j].SoLuong = newSoLuong;
                            arr[i].HangCungLoais[j].GiaBan = newGiaBan;
                            arr[i].HangCungLoais[j].DonGia = newGiaBan;
                            arr[i].HangCungLoais[j].PTChietKhau = ptGiam;
                            arr[i].HangCungLoais[j].TienChietKhau = tienGiam;
                            arr[i].HangCungLoais[j].PTThue = ptThue;
                            arr[i].HangCungLoais[j].TienThue = tienThue;
                            arr[i].HangCungLoais[j].DonGiaBaoHiem = giaBHDuyet;
                            i = arr.length;
                            break;
                        }
                    }
                }
            }
        }
        return arr;
    }

    // typeEdit: default:0, 1.editCKPr, 2.isEditThuePr, 3.editCK_chitiet, 4.isEditThue_chitiet
    function UpdateCacheHDLe(idRandom, isDoiTra, typeEdit = 0) {
        var cacheName = lcListCTHD;
        if (isDoiTra) {
            cacheName = lcListCTHD_DoiTra;
        }
        var thanhtien = 0, tienthue = 0;
        var thanhtienchuaCK = 0, chietkhauhang = 0;
        var cthd = localStorage.getItem(cacheName);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);

            for (let i = 0; i < cthd.length; i++) {
                if (cthd[i].IDRandomHD === idRandom) {
                    let itFor = cthd[i];
                    thanhtien += itFor.ThanhTien;
                    tienthue += itFor.TienThue * itFor.SoLuong;
                    if (cthd[i].ChatLieu !== '4') {
                        chietkhauhang += itFor.TienChietKhau * itFor.SoLuong;
                        thanhtienchuaCK += formatNumberToFloat(itFor.GiaBan) * itFor.SoLuong;
                    }
                    // sum Hang KhuyenMai
                    for (let k = 0; k < itFor.HangHoa_KM.length; k++) {
                        thanhtien += itFor.HangHoa_KM[k].ThanhTien;
                    }
                    // for from j =1, because DM_LoHang[0] = CTHD parent
                    for (let j = 1; j < itFor.DM_LoHang.length; j++) {
                        let forIn = itFor.DM_LoHang[j];
                        thanhtien += forIn.ThanhTien;
                        tienthue += forIn.TienThue * forIn.SoLuong;
                        if (forIn.ChatLieu !== '4') {
                            chietkhauhang += forIn.TienChietKhau * forIn.SoLuong;
                            thanhtienchuaCK += forIn.GiaBan * forIn.SoLuong;
                        }
                    }
                    // sum hangcungloai
                    for (let j = 0; j < itFor.HangCungLoais.length; j++) {
                        let forIn = itFor.HangCungLoais[j];
                        thanhtien += forIn.ThanhTien;
                        tienthue += forIn.TienThue * forIn.SoLuong;
                        if (forIn.ChatLieu !== '4') {
                            chietkhauhang += forIn.TienChietKhau * forIn.SoLuong;
                            thanhtienchuaCK += forIn.GiaBan * forIn.SoLuong;
                        }
                    }
                }
            }

            if (isDoiTra === false) {
                // sum hang KM HoaDon(HD - giam gia hang)
                var producKM_HD = localStorage.getItem(lcProductKM_HoaDon);
                if (producKM_HD !== null) {
                    producKM_HD = JSON.parse(producKM_HD);
                    for (let i = 0; i < producKM_HD.length; i++) {
                        if (producKM_HD[i].IDRandomHD === idRandom) {
                            thanhtien += parseFloat(producKM_HD[i].ThanhTien);
                        }
                    }
                }
            }
        }
        var changeTaxBH = false, thueBHnew = 0;
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            for (let i = 0; i < lstHD.length; i++) {
                let itFor = lstHD[i];
                if (itFor.IDRandom === idRandom) {
                    switch (typeEdit) {
                        case 1: // edit ckhanghoa at parent
                            lstHD[i].TongTienHang = thanhtienchuaCK - itFor.TongGiamGiaHang;
                            if (itFor.PTThueHoaDon > 0) {
                                lstHD[i].TongTienThue = itFor.PTThueHoaDon * lstHD[i].TongTienHang / 100;
                            }
                            else {
                                if (lstHD[i].TongTienThueBaoHiem > tienthue) {
                                    changeTaxBH = true;
                                    thueBHnew = tienthue;
                                    lstHD[i].TongTienThueBaoHiem = tienthue;
                                    lstHD[i].TongTienThue = tienthue;
                                }
                                else {
                                    lstHD[i].TongTienThue = tienthue;
                                }
                            }
                            break;
                        case 2: // edit thue at parent
                            //if (lstHD[i].ID_BaoHiem !== null && lstHD[i].PTThueHoaDon > 0) {
                            //    lstHD[i].PTThueBaoHiem = lstHD[i].PTThueHoaDon;
                            //}
                            //else {
                            //    lstHD[i].PTThueBaoHiem = 0;
                            //    lstHD[i].TongTienThueBaoHiem = 0;
                            //}
                            break;
                        case 3: // editCK_chitiet
                            lstHD[i].PTChietKhauHH = 0;
                            lstHD[i].TongTienHangChuaCK = thanhtienchuaCK;
                            lstHD[i].TongGiamGiaHang = chietkhauhang;
                            lstHD[i].TongTienHang = thanhtien;
                            if (itFor.PTThueHoaDon > 0) {
                                lstHD[i].TongTienThue = itFor.PTThueHoaDon * thanhtien / 100;
                            }
                            else {
                                if (lstHD[i].TongTienThueBaoHiem > tienthue) {
                                    changeTaxBH = true;
                                    thueBHnew = tienthue;
                                    lstHD[i].TongTienThueBaoHiem = tienthue;
                                    lstHD[i].TongTienThue = tienthue;
                                }
                                else {
                                    lstHD[i].TongTienThue = tienthue;
                                }
                            }
                            break;
                        case 4: // editThue_chitiet
                            lstHD[i].PTThueHoaDon = 0;
                            lstHD[i].TongTienHangChuaCK = thanhtienchuaCK;
                            lstHD[i].TongGiamGiaHang = chietkhauhang;
                            lstHD[i].TongTienHang = thanhtien;
                            lstHD[i].TongTienThue = tienthue;
                            lstHD[i].TongThueKhachHang = tienthue;
                            if (lstHD[i].TongTienThueBaoHiem > 0) {
                                changeTaxBH = true;
                                thueBHnew = 0;
                            }

                            lstHD[i].PTThueBaoHiem = 0;
                            lstHD[i].TongTienThueBaoHiem = 0;
                            break;
                        case 0:
                            lstHD[i].TongTienHangChuaCK = thanhtienchuaCK;
                            lstHD[i].TongGiamGiaHang = chietkhauhang;
                            lstHD[i].TongTienHang = thanhtien;
                            if (itFor.PTThueHoaDon > 0) {
                                lstHD[i].TongTienThue = itFor.PTThueHoaDon * thanhtien / 100;
                            }
                            else {
                                if (lstHD[i].TongTienThueBaoHiem > tienthue) {
                                    changeTaxBH = true;
                                    thueBHnew = tienthue;
                                    lstHD[i].TongTienThueBaoHiem = tienthue;
                                    lstHD[i].TongTienThue = tienthue;
                                }
                                else {
                                    lstHD[i].TongTienThue = tienthue;
                                }
                            }
                            break;
                    }

                    let thueKH = lstHD[i].TongTienThue - lstHD[i].TongTienThueBaoHiem;
                    thueKH = thueKH < 0 ? 0 : thueKH;
                    lstHD[i].TongThueKhachHang = thueKH;

                    let tongtienhang = formatNumberToFloat(lstHD[i].TongTienHang); // - formatNumberToFloat(lstHD[i].TongGiamGiaKM_HD);

                    // trahang
                    if (lstHD[i].PTGiamDB > 0) {
                        lstHD[i].TongGiamGiaDB = lstHD[i].PTGiamDB * lstHD[i].TongGiaGocHangTra / 100;
                    }
                    if (lstHD[i].PTThueDB > 0) {
                        lstHD[i].TongThueDB = lstHD[i].PTThueDB * lstHD[i].TongGiaGocHangTra / 100;
                    }

                    let tongtra = lstHD[i].TongGiaGocHangTra - lstHD[i].TongChiPhiHangTra - lstHD[i].TongGiamGiaDB + lstHD[i].TongThueDB;
                    tongtra = tongtra < 0 ? 0 : tongtra;
                    lstHD[i].TongTienTra = tongtra;

                    let phaiTT = lstHD[i].PhaiThanhToanDB
                        - (tongtra - tongtienhang) - lstHD[i].SoDuDatCoc
                        - lstHD[i].TongTienBHDuyet
                        + lstHD[i].KhauTruTheoVu + lstHD[i].GiamTruBoiThuong + lstHD[i].TongThueKhachHang;

                    // phaithanhtoan thuần (chưa trừ trả hàng, đặt cọc,...)
                    let phaiTTKH = tongtienhang - lstHD[i].TongTienBHDuyet
                        + lstHD[i].KhauTruTheoVu + lstHD[i].GiamTruBoiThuong + lstHD[i].TongThueKhachHang;

                    if (lstHD[i].TongChietKhau > 0) {
                        lstHD[i].TongGiamGia = lstHD[i].TongChietKhau * phaiTTKH / 100;
                    }
                    lstHD[i].TongGiamGiaKM_HD = formatNumberToFloat(lstHD[i].TongGiamGia) + lstHD[i].KhuyeMai_GiamGia;

                    phaiTT = phaiTT - formatNumberToFloat(lstHD[i].TongGiamGiaKM_HD);

                    phaiTTKH = phaiTTKH - formatNumberToFloat(lstHD[i].TongGiamGiaKM_HD);
                    phaiTTKH = phaiTTKH < 0 ? 0 : phaiTTKH;

                    if (phaiTT - lstHD[i].KhachDaTra < 0) {
                        // chi get hoantra cua khachhang
                        lstHD[i].HoanTraTamUng = Math.abs(phaiTT - lstHD[i].KhachDaTra);

                        lstHD[i].DaTraKhach = lstHD[i].HoanTraTamUng;
                        lstHD[i].TienMat = lstHD[i].HoanTraTamUng;
                        lstHD[i].PhaiThanhToan = phaiTTKH;
                        lstHD[i].DaThanhToan = 0;
                    }
                    else {
                        lstHD[i].PhaiThanhToan = phaiTTKH;
                        lstHD[i].DaThanhToan = lstHD[i].LoaiHoaDon === 3 ? 0 : phaiTT;
                        lstHD[i].TienMat = lstHD[i].LoaiHoaDon === 3 ? 0 : phaiTT;
                        lstHD[i].HoanTraTamUng = 0;
                        lstHD[i].DaTraKhach = 0;
                    }
                    // tongthanhtoan hoadon: chi lay thong tin hoadon mua
                    lstHD[i].TongThanhToan = phaiTTKH + lstHD[i].PhaiThanhToanBaoHiem;

                    lstHD[i].TienGui = 0;
                    lstHD[i].TienATM = 0;
                    lstHD[i].TienTheGiaTri = 0;
                    lstHD[i].TienThua = 0;
                    break;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(lstHD));
            UpdateChietKhauHD_NhanVien(idRandom);

            if (changeTaxBH) {
                self.HoaDons().TongTienThueBaoHiem(thueBHnew);
                self.HoaDons().PTThueBaoHiem(0);
                vmThongTinThanhToanBaoHiem.SetInforBaoHiem_fromHoaDon(self.HoaDons());
                vmThongTinThanhToanBaoHiem.Caculator();
                self.AgreeBaoHiem();
            }
        }
    }

    function UpdateInforBaoHiem(idRandom) {
        var cthd = localStorage.getItem(lcListCTHD);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);

            var tongtienBHDuyet = 0;
            for (let i = 0; i < cthd.length; i++) {
                if (cthd[i].IDRandomHD === idRandom) {
                    let itFor = cthd[i];
                    tongtienBHDuyet += itFor.DonGiaBaoHiem * itFor.SoLuong;

                    for (let j = 1; j < itFor.DM_LoHang.length; j++) {
                        tongtienBHDuyet += itFor.DM_LoHang[j].DonGiaBaoHiem * itFor.DM_LoHang[j].SoLuong;
                    }

                    for (let j = 0; j < itFor.HangCungLoais.length; j++) {
                        tongtienBHDuyet += itFor.HangCungLoais[j].DonGiaBaoHiem * itFor.HangCungLoais[j].SoLuong;
                    }
                }
            }
        }

        self.HoaDons().TongTienBHDuyet(tongtienBHDuyet);

        // caculator again
        vmThongTinThanhToanBaoHiem.SetInforBaoHiem_fromHoaDon(self.HoaDons());
        vmThongTinThanhToanBaoHiem.Caculator();
        self.AgreeBaoHiem();
    }

    function UpdateChietKhauHD_NhanVien(idRandom) {
        var lstHDLe = localStorage.getItem(lcListHD);
        if (lstHDLe !== null) {
            lstHDLe = JSON.parse(lstHDLe);
            // update ChietkhauHD_Nhanvien thuc hien
            for (let i = 0; i < lstHDLe.length; i++) {
                if (lstHDLe[i].IDRandom === idRandom) {
                    if (lstHDLe[i].BH_NhanVienThucHiens.length > 0) {
                        let doanhthu = formatNumberToFloat(lstHDLe[i].TongThanhToan)
                            - formatNumberToFloat(lstHDLe[i].TongTienThue);
                        // thucthu: khong tinh gtri ThuTuThe, TT=Diem
                        let thucthu = formatNumberToFloat(lstHDLe[i].TienMat) + formatNumberToFloat(lstHDLe[i].TienATM) + formatNumberToFloat(lstHDLe[i].TienGui);
                        if (lstHDLe[i].LoaiHoaDon !== 6 && lstHDLe[i].HoanTraTamUng > 0) {
                            thucthu = thucthu * (-1);
                        }
                        for (let j = 0; j < lstHDLe[i].BH_NhanVienThucHiens.length; j++) {
                            let itemForCK = lstHDLe[i].BH_NhanVienThucHiens[j];
                            let heso = parseFloat(itemForCK.HeSo);
                            let gtriCK = parseFloat(itemForCK.PT_ChietKhau);
                            let tinhCKTheo = parseInt(itemForCK.TinhChietKhauTheo);
                            let tienCK = itemForCK.TienChietKhau;
                            switch (tinhCKTheo) {
                                case 1:
                                    tienCK = thucthu * gtriCK / 100 * heso;
                                    break;
                                case 2:
                                    tienCK = doanhthu * gtriCK / 100 * heso;
                                    break;
                                // loai 3: khong cap nhat, vi CK theo VND
                            }
                            lstHDLe[i].BH_NhanVienThucHiens[j].TienChietKhau = tienCK;
                        }
                    }
                    break;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(lstHDLe));
        }
    }

    function GetCTHoaDon_FromArr(arr, idRandomHD) {
        var ctHD = [];
        for (let i = arr.length - 1; i >= 0; i--) {
            if (arr[i].IDRandomHD === idRandomHD) {
                if (!arr[i].QuanLyTheoLoHang) {
                    arr[i].ID_LoHang = null;
                }
                // STT của hàng hóa < STT của hàng KM (để order ASC STT khi in, hàng KM nằm dưới)
                // only add if SoLuong > 0 (because parent have SoLuong = 0, but DM_Lo have SoLuong > 0)
                //if (arr[i].SoLuong > 0) {
                arr[i].SoThuTu = ctHD.length + 1;
                ctHD.push(arr[i]);
                //}
                // add Hang Khuyen Mai
                for (let j = 0; j < arr[i].HangHoa_KM.length; j++) {
                    arr[i].HangHoa_KM[j].SoThuTu = ctHD.length + 1;
                    // check HangKM tang kem co quan ly theo lo khong? Neu co luu ID_LoHang
                    if (arr[i].HangHoa_KM[j].TangKem) {
                        var itemHH = $.grep(self.HangHoaAll(), function (x) {
                            return x.ID_DonViQuiDoi === arr[i].HangHoa_KM[j].ID_DonViQuiDoi;
                        });
                        if (itemHH.length > 0 && itemHH[0].QuanLyTheoLoHang) {
                            arr[i].HangHoa_KM[j].ID_LoHang = itemHH[0].ID_LoHang;
                            arr[i].HangHoa_KM[j].QuanLyTheoLoHang = true;
                        }
                    }
                    ctHD.push(arr[i].HangHoa_KM[j]);
                }
                // add Hang Hoa theo Lo
                for (let k = 1; k < arr[i].DM_LoHang.length; k++) {
                    //if (arr[i].DM_LoHang[k].SoLuong > 0) {
                    arr[i].DM_LoHang[k].SoThuTu = ctHD.length + 1;
                    ctHD.push(arr[i].DM_LoHang[k]);
                    //}
                }
                // add HangCungLoai
                for (let k = 0; k < arr[i].HangCungLoais.length; k++) {
                    //if (arr[i].HangCungLoais[k].SoLuong > 0) {
                    arr[i].HangCungLoais[k].SoThuTu = ctHD.length + 1;
                    ctHD.push(arr[i].HangCungLoais[k]);
                    //}
                }
            }
        }
        // add product KhuyenMai of HoaDon into CTHD
        var productKMs = localStorage.getItem(lcProductKM_HoaDon);
        if (productKMs !== null) {
            productKMs = JSON.parse(productKMs);
            for (let i = 0; i < productKMs.length; i++) {
                if (productKMs[i].IDRandomHD === idRandomHD) {
                    ctHD.push(productKMs[i]);
                }
            }
        }
        return ctHD;
    }
    function GetArrCTHD_withIDLoHangOtherNull(arr) {
        for (let i = 0; i < arr.length; i++) {
            delete arr[i]["DM_LoHang"];
            delete arr[i]["HangHoa_KM"];
            if (arr[i].QuanLyTheoLoHang === false) {
                arr[i].ID_LoHang = null;
            }
            var thuocTinh = arr[i].ThuocTinh_GiaTri;
            thuocTinh = (thuocTinh === null || thuocTinh === undefined || thuocTinh === '') ? '' : thuocTinh.substr(1);// loai bo ki tu _
            arr[i].ThuocTinh_GiaTri = thuocTinh;

            for (let k = 0; k < arr[i].ThanhPhanComBo.length; k++) {
                delete arr[i].ThanhPhanComBo[k]["DM_LoHang"];
            }

            var sophut = arr[i].ThoiGianThucHien;
            if (sophut > 0 && formatNumberToInt(arr[i].TimeStart) !== 0) {
                if (arr[i].QuaThoiGian > 0) {
                    sophut += arr[i].QuaThoiGian;
                }
                else {
                    sophut -= arr[i].TimeRemain;
                }
                arr[i].ThoiGianThucHien = sophut;
                var date_ofCT = arr[i].ThoiGian.split(' ')[0];
                var ngaygioVao = date_ofCT.concat(' ', arr[i].TimeStart);
                var dateVao = new Date(ngaygioVao);
                dateVao.setMinutes(dateVao.getMinutes() + sophut);
                var ngaygioRa = moment(dateVao).format('YYYY-MM-DD HH:mm');
                arr[i].ThoiGian = date_ofCT + ' ' + arr[i].TimeStart;
                arr[i].ThoiGianHoanThanh = ngaygioRa;
            }
        }
        arr = $.grep(arr, function (x) {
            // check QuanLyTheoLoHang === undefined (use if HangHoa id KhuyenMai TangKem)
            return x.QuanLyTheoLoHang === false || x.QuanLyTheoLoHang === undefined || x.QuanLyTheoLoHang === null ||
                (x.QuanLyTheoLoHang && x.ID_LoHang !== null && x.ID_LoHang !== const_GuidEmpty)
        });
        return arr;
    }

    function Call_ManyFunction_Onsuccess() {
        ajaxHelper(DMDoiTuongUri + 'Call_ManyFunction_OnsuccessBanHang?idChiNhanh=' + id_DonVi, 'GET').done(function (obj) {
            if (obj.res === true) {
                self.DM_MauIn(obj.TemPrint);
                self.BindSettingPrint(true);
                self.AllQuanHuyens(obj.District);
                self.AllNhomBans(obj.NhomBan);

                for (let i = 0; i < obj.PhongBan.length; i++) {
                    obj.PhongBan[i].CreateTime = 0;
                    obj.PhongBan[i].NhanVien_Phong = '';
                    obj.PhongBan[i].ThoiGianThucHien = ''; //tong thoi gian thuc hien cac dich vu
                    obj.PhongBan[i].TextTGConLai = ''; //thoi gian con lai
                }
                var arrSortPB = obj.PhongBan.sort((a, b) => a.TenViTri.localeCompare(b.TenViTri, undefined, { caseFirst: "upper" }));
                self.AllPhongBans(arrSortPB);
                self.PhongBans_byIDNhom(self.AllPhongBans());
                vm_PhongBan.reset(self.AllPhongBans());

                // write data to indexDB
                WriteData_Dexie(db.DM_QuanHuyen, obj.District);
                WriteData_Dexie(db.DM_MauIn, obj.TemPrint);
                WriteData_Dexie(db.DM_KhuVuc, self.AllNhomBans());
                WriteData_Dexie(db.DM_ViTri, self.AllPhongBans());
            }
        })
    }
    function GetDM_TaiKhoanNganHang() {
        ajaxHelper('/api/DanhMuc/Quy_HoaDonAPI/' + 'GetAllTaiKhoanNganHang_ByDonVi?idDonVi=' + id_DonVi, 'GET').done(function (x) {
            if (x.res === true) {
                let data = x.data;
                WriteData_Dexie(db.DM_TaiKhoanNganHang, data);
                self.AllAccountBank(data);
            }
        })
    }

    function CreatePhieuXuatKho(idHoaDon, mahoadon) {
        ajaxHelper(GaraAPI + 'XuatKhoToanBo_FromHoaDonSC?idHoaDon=' + idHoaDon, 'GET').done(function (x) {
            if (x.res) {
                var diary = {
                    LoaiHoaDon: 8,
                    LoaiNhatKy: 1,
                    ID_DonVi: id_DonVi,
                    ID_NhanVien: _idNhanVien,
                    ID_HoaDon: x.dataSoure.ID_HoaDon,
                    ThoiGianUpdateGV: x.dataSoure.NgayLapHoaDon,
                    ChucNang: 'Hóa đơn sửa chữa - Xuất kho toàn bộ',
                    NoiDung: 'Xuất kho toàn bộ từ hóa đơn sửa chữa ' + mahoadon,
                    NoiDungChiTiet: 'Xuất kho toàn bộ từ hóa đơn sửa chữa '.concat(mahoadon, ' <br /> Người xuất: ', userLogin),
                }
                Post_NhatKySuDung_UpdateGiaVon(diary);
            }
        })
    }

    function AddKhachHang_HoaDon(DM_DoiTuong, myDataHD, isDongBo, updateHDDatHang) {
        delete DM_DoiTuong["ID"]; // delete ID because when Offline: save ID = Ma
        delete DM_DoiTuong["ID_NhomDoiTuong"]; // delete ID_NhomDoiTuong because at DM_DoiTuong have ID_NhomDoiTuong type Guid
        console.log('DM_DoiTuong ', DM_DoiTuong)
        ajaxHelper('DM_DoiTuong' + "PostDM_DoiTuong", 'POST', DM_DoiTuong).done(function (obj) {
            if (obj.res === true) {
                var itemDT = obj.data;
                DM_DoiTuong.ID = itemDT.ID;
                DM_DoiTuong.Name_Phone = itemDT.TenDoiTuong_ChuCaiDau + " " + itemDT.TenDoiTuong_KhongDau + " " +
                    DM_DoiTuong.TenDoiTuong + " " + itemDT.MaDoiTuong + " " + DM_DoiTuong.DienThoai;
                // remove old, add new IndexDB
                AddNewDoiTuong_andRemoveDoiTuongOfflineOld_IndexDB(DM_DoiTuong);
                // save HoaDon
                myDataHD.objHoaDon.ID_DoiTuong = itemDT.ID;
                if (isDongBo) {
                    PostHD_SoQuy_DongBo(myDataHD);
                }
                else {
                    if (myDataHD.objHoaDon.LoaiHoaDon === 19) {
                        PostHD_HoaDon_DichVu(myDataHD);
                    }
                    else {
                        PostHD_SoQuy_SaveHD(myDataHD, updateHDDatHang);
                    }
                }
            }
        }).always(function () {
            SaveHD_RemoveDisable();
            $('.divDongBoHoa').gridLoader({ show: false });
            $('#btnDongBoHoa,#btnSave').removeAttr('disabled');
        })
    }
    function AddNewDoiTuong_andRemoveDoiTuongOfflineOld_IndexDB(DM_DoiTuong) {
        var maKHoffline = DM_DoiTuong.MaDoiTuong;
        // update ID_DoiTuong new for all HD with ID_DoiTuong = MaDoiTuong offline
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            for (let i = 0; i < lstHD.length; i++) {
                if (lstHD[i].ID_DoiTuong === maKHoffline) {
                    lstHD[i].ID_DoiTuong = DM_DoiTuong.ID;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(lstHD));
        }
        // Update new ID for DoiTuong offline (not remove because lost KH if multiple HD offline same KHO)
        var doiTuongOffline = localStorage.getItem("DM_DoiTuongs");
        if (doiTuongOffline !== null) {
            doiTuongOffline = JSON.parse(doiTuongOffline);
            for (let i = 0; i < doiTuongOffline.length; i++) {
                if (doiTuongOffline[i].ID === maKHoffline) {
                    doiTuongOffline[i].ID = DM_DoiTuong.ID;
                }
            }
            localStorage.setItem("DM_DoiTuongs", JSON.stringify(doiTuongOffline));
        }
    }

    function UpdateGiamGiaHD_ByNhomKH(idRandomHD) {
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            var idNhomDTs = '';
            if (self.ChiTietDoiTuong() !== null && self.ChiTietDoiTuong().length > 0) {
                if (self.ChiTietDoiTuong()[0].ID_NhomDoiTuong === null || self.ChiTietDoiTuong()[0].ID_NhomDoiTuong === undefined) {
                    idNhomDTs = '';
                }
                else {
                    idNhomDTs = self.ChiTietDoiTuong()[0].ID_NhomDoiTuong.toLowerCase();
                }
                // get Nhom of this KhachHang have GiamGia 
                var allNhomGG = $.grep(self.NhomDoiTuongDB(), function (x) {
                    return x.GiamGia > 0 && idNhomDTs.indexOf(x.ID) > -1;
                });

                // sort GiamGia desc & get nhom has GiamGia max
                allNhomGG = allNhomGG.sort(function (a, b) {
                    let x = a.GiamGia, y = b.GiamGia;
                    return x > y ? -1 : x < y ? 1 : 0;
                });
                self.ListGroupSale(allNhomGG);

                if (allNhomGG.length > 0) {
                    var ptGiam = allNhomGG[0].GiamGia;
                    for (let i = 0; i < lstHD.length; i++) {
                        if (lstHD[i].IDRandom === idRandomHD) {
                            if (allNhomGG[0].GiamGiaTheoPhanTram) {
                                lstHD[i].TongGiamGia = lstHD[i].PhaiThanhToan * ptGiam / 100;
                                lstHD[i].TongChietKhau = ptGiam;
                                lstHD[i].DVTinhGiam = '%';
                            }
                            else {
                                lstHD[i].TongChietKhau = 0;
                                lstHD[i].TongGiamGia = ptGiam;
                                lstHD[i].DVTinhGiam = 'VND';
                            }
                            lstHD[i].TongGiamGiaKM_HD = lstHD[i].KhuyeMai_GiamGia + lstHD[i].TongGiamGia;
                            lstHD[i].ID_NhomDTApplySale = allNhomGG[0].ID;
                            break;
                        }
                    }
                }
                else {
                    self.ListGroupSale([]);
                    for (let i = 0; i < lstHD.length; i++) {
                        // reset TongGiamGia=0 nếu trước đó HD có nhóm KH được giảm giá (OK)
                        if (lstHD[i].IDRandom === idRandomHD && lstHD[i].ID_NhomDTApplySale !== null) {
                            lstHD[i].TongChietKhau = 0;
                            lstHD[i].TongGiamGia = 0;
                            lstHD[i].TongGiamGiaKM_HD = lstHD[i].KhuyeMai_GiamGia + lstHD[i].TongGiamGia;
                            lstHD[i].ID_NhomDTApplySale = null;
                            break;
                        }
                    }
                }
            }
            else {
                self.ListGroupSale([]);
                for (let i = 0; i < lstHD.length; i++) {
                    if (lstHD[i].IDRandom === idRandomHD
                        && (lstHD[i].ID_NhomDTApplySale !== null)) {
                        lstHD[i].TongChietKhau = 0;
                        lstHD[i].TongGiamGia = 0;
                        lstHD[i].TongGiamGiaKM_HD = lstHD[i].KhuyeMai_GiamGia + lstHD[i].TongGiamGia;
                        lstHD[i].ID_NhomDTApplySale = null;
                        break;
                    }
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(lstHD));
            UpdateCacheHDLe(idRandomHD, self.HoaDons().LoaiHoaDon() === 6);
        }
    }

    self.GetlistGroupSale = function () {
        if (_maHoaDon === '') {
            _maHoaDon = $('.gara-bill-label  li.active font').text();
        }
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            var itemHD = GetHDOpening_byMaHoaDon(_maHoaDon, lstHD);
            if (itemHD.length > 0) {
                var idRandomHD = itemHD[0].IDRandom;
                // get CT DoiTra --> check GiamGia HD by Nhom KH
                var arrCTDoiTra = [];
                var cthd_DoiTra = localStorage.getItem(lcListCTHD_DoiTra);
                if (cthd_DoiTra !== null) {
                    cthd_DoiTra = JSON.parse(cthd_DoiTra);
                    arrCTDoiTra = $.grep(cthd_DoiTra, function (x) {
                        return x.IDRandomHD === idRandomHD;
                    });
                }
                // chi update giam gia if maHD !='BG0000' and HD khong tao tu HD Dat hang, and not HD sao chep
                // neu BG0000--> not update, but MaHoaDon = 'Copy_BG..'-> update 
                // update GiamGia if TraHang co MuaMoi (ID_HoaDon = 'xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'), x!==0
                if (itemHD[0].MaHoaDon.indexOf(nameHD_UpdateDH) !== 0
                    && (itemHD[0].ID_HoaDon === null || itemHD[0].ID_HoaDon === const_GuidEmpty
                        || (itemHD[0].LoaiHoaDon === 6 && arrCTDoiTra.length > 0))) {
                    var idNhomDTs = '';
                    if (self.ChiTietDoiTuong() !== null && self.ChiTietDoiTuong().length > 0) {
                        if (self.ChiTietDoiTuong()[0].ID_NhomDoiTuong === null || self.ChiTietDoiTuong()[0].ID_NhomDoiTuong === undefined) {
                            idNhomDTs = '';
                        }
                        else {
                            idNhomDTs = self.ChiTietDoiTuong()[0].ID_NhomDoiTuong.toLowerCase();
                        }
                        // get Nhom of this KhachHang have GiamGia 
                        var allNhomGG = $.grep(self.NhomDoiTuongDB(), function (x) {
                            return x.GiamGia > 0 && idNhomDTs.indexOf(x.ID) > -1;
                        });

                        // sort GiamGia desc & get nhom has GiamGia max
                        allNhomGG = allNhomGG.sort(function (a, b) {
                            let x = a.GiamGia, y = b.GiamGia;
                            return x > y ? -1 : x < y ? 1 : 0;
                        });
                        self.ListGroupSale(allNhomGG);
                    }
                    else {
                        self.ListGroupSale([]);
                    }
                }
            }
        }
    }

    self.ChangeID_NhomSale = function (item) {
        if (_maHoaDon === '') {
            _maHoaDon = $('.gara-bill-label  li.active font').text();
        }
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            var itemNhomChose = $.grep(self.NhomDoiTuongDB(), function (x) {
                return x.ID === item.ID;
            });
            if (itemNhomChose.length > 0) {
                var idRandom = null;
                var ptGiam = itemNhomChose[0].GiamGia;
                for (let i = 0; i < lstHD.length; i++) {
                    if (lstHD[i].MaHoaDon === _maHoaDon
                        && (lstHD[i].NguoiTao === userLogin || lstHD[i].TrangThaiHD === 3)) {
                        idRandom = lstHD[i].IDRandom;
                        if (itemNhomChose[0].GiamGiaTheoPhanTram) {
                            lstHD[i].TongChietKhau = ptGiam;
                            lstHD[i].TongGiamGia = lstHD[i].PhaiThanhToan * ptGiam / 100;
                            $('#dvtGiamParent').text('%');
                            $('.vnd1').removeClass('gb');
                            $('.senter1').addClass('gb');
                        }
                        else {
                            $('#dvtGiamParent').text('VND');
                            $('.senter1').removeClass('gb');
                            $('.vnd1').addClass('gb');
                            lstHD[i].TongGiamGia = ptGiam;
                            lstHD[i].TongChietKhau = 0;
                        }
                        lstHD[i].TongGiamGiaKM_HD = lstHD[i].KhuyeMai_GiamGia + lstHD[i].TongGiamGia;
                        lstHD[i].ID_NhomDTApplySale = item.ID;
                        $('.price-sa').val(formatNumber3Digit(ptGiam));
                        break;
                    }
                }
                localStorage.setItem(lcListHD, JSON.stringify(lstHD));
                if (idRandom !== null) {
                    UpdateCacheHDLe(idRanDom);
                }
            }
        }
        UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();
        BindHD_byIDRandom(idRandom);
    }
    function GetDiemGiaoDich_HDTraHang(phaiTTTraHang) {
        var diemGiaoDich = 0;
        if (phaiTTTraHang > 0) {
            if (self.ThietLap().TinhNangTichDiem) {
                if (self.ThietLap_TichDiem() !== null && self.ThietLap_TichDiem().length > 0) {
                    diemGiaoDich = Math.floor(phaiTTTraHang / self.ThietLap_TichDiem()[0].TyLeDoiDiem);
                }
            }
        }
        return diemGiaoDich;
    };

    function UpdateInforKH_inLstDoiTuongs(itemHD, isTrahet) {

        if (self.ChiTietDoiTuong().length > 0) {
            var tongdiem = self.ChiTietDoiTuong()[0].TongTichDiem;
            var tongTraHang = itemHD.TongGiaGocHangTra - itemHD.TongGiamGiaDB;
            var tongMua = itemHD.TongTienHang - itemHD.TongGiamGiaKM_HD;
            var updateDiem = false;
            var diemHienTai = 0;
            var diemGDCurrent = formatNumberToFloat(itemHD.DiemGiaoDich);
            switch (itemHD.LoaiHoaDon) {
                case 1:
                case 19:
                case 25:
                    //diemHienTai = itemHD.DiemHienTai - itemHD.DiemGiaoDichDB;
                    // not get diem from hoadon 
                    //(vì trường hợp tạo 2 hóa đơn cho 1 khách hàng, sau đó thanh toán cùng lúc thì chưa update điểm mới cho khách)
                    diemHienTai = tongdiem + diemGDCurrent - itemHD.DiemQuyDoi - itemHD.DiemGiaoDichDB;
                    // Neu HD khong dc tich diem (vi cai dat: khong TichDiem cho HD giam gia/HD thanh toan = diem), nhung van TT = diem --> tru diem KH
                    if ((diemGDCurrent !== 0) || (diemGDCurrent === 0 && itemHD.DiemQuyDoi > 0)) {
                        updateDiem = true;
                    }
                    break;
                case 6:
                    // if TraHang from HD tich diem --> get DiemGD of TraHang--> tru diem for KH
                    var diemGD = 0;
                    if (itemHD.FromHDTichDiem) {
                        diemGD = GetDiemGiaoDich_HDTraHang(tongTraHang);
                        diemHienTai = tongdiem + diemGDCurrent - diemGD; // diem cu of KH + diem GD - diem tra hang
                        updateDiem = true;
                    }
                    else {
                        // khong tra hang tu HD tich diem, nhung co mua moi --> cong diem cho KH
                        if (tongMua > 0) {
                            diemHienTai = tongdiem + diemGDCurrent;
                            updateDiem = true;
                        }
                        else {
                            // khong mua moi
                            diemHienTai = tongdiem; // assign = 0 --> avoid update when UpdateDiemKH_toDB (online)
                        }
                    }
                    break;
            }
            if (updateDiem) {
                self.ChiTietDoiTuong()[0].TongTichDiem = diemHienTai;
            }
        }
    }

    // In Offline
    function GetAllMauIn_byChiNhanh() {
        ajaxHelper('/api/DanhMuc/ThietLapApi/GetAllMauIn_ByChiNhanh?idChiNhanh=' + id_DonVi, 'GET').done(function (data) {
            if (data !== null) {
                self.DM_MauIn(data);
                self.BindSettingPrint(true);
                WriteData_Dexie(db.DM_MauIn, data);
            }
        });
    }
    self.printDraft = function () {
        var rolePrintDraft = $.grep(self.Quyen_NguoiDung(), function (x) {
            return x.MaQuyen === 'HoaDon_InNhap';
        });
        if (rolePrintDraft.length === 0) {
            ShowMessage_Danger('Bạn không có quyền in nháp');
            return false;
        }
        if (_maHoaDon === '') {
            _maHoaDon = $('.gara-bill-label li.active font').text();
        }
        var lstHDTemp = localStorage.getItem(lcListHD);
        var objAdd = [];
        if (lstHDTemp !== null) {
            lstHDTemp = JSON.parse(lstHDTemp);
            objAdd = GetHDOpening_byMaHoaDon(_maHoaDon, lstHDTemp);
            if (objAdd.length > 0) {
                var idRandomHD = objAdd[0].IDRandom;
                // show div by LoaiHoaDon
                var maChungTu = '';
                switch (objAdd[0].LoaiHoaDon) {
                    case 0:
                    case 1:
                        maChungTu = 'HDBL';
                        break;
                    case 3:
                        maChungTu = 'DH';
                        break;
                    case 19:
                        maChungTu = 'GDV';
                        break;
                    case 6:
                        // check co HD Doi Tra khong
                        var lstCTDoiTra = localStorage.getItem(lcListCTHD_DoiTra);
                        if (lstCTDoiTra !== null) {
                            lstCTDoiTra = JSON.parse(lstCTDoiTra);
                            var itemDT = $.grep(lstCTDoiTra, function (x) {
                                return x.IDRandomHD === idRandomHD;
                            });
                            if (itemDT.length > 0) {
                                // HD Doi Tra
                                maChungTu = 'DTH';
                                var arrCTHDMH_format = GetCTHDPrint_Format(itemDT);
                                self.CTHoaDonPrintMH(arrCTHDMH_format); // CTHD mua hang
                            }
                            else {
                                // HD Tra
                                maChungTu = 'TH';
                            }
                        }
                        else {
                            // HD Tra
                            maChungTu = 'TH';
                        }
                        break;
                }
                var objHDPrint = GetInforHDPrint(objAdd[0]);
                // tim CTHoaDon t/u voi HoaDon
                var objCTAdd = [];
                var listAllCTHD = localStorage.getItem(lcListCTHD);
                if (listAllCTHD !== null) {
                    listAllCTHD = JSON.parse(listAllCTHD);
                    objCTAdd = $.grep(listAllCTHD, function (x) {
                        return x.IDRandomHD === idRandomHD;
                    });
                    if (objCTAdd.length > 0) {
                        // add CTHD if has LoHang, has KMai
                        objCTAdd = GetCTHoaDon_FromArr(objCTAdd, idRandomHD);
                        self.InforHDprintf(objHDPrint);
                        var arrCTHD_format = GetCTHDPrint_Format(objCTAdd);
                        self.CTHoaDonPrint(arrCTHD_format);
                    }
                }
            }
            else {
                ShowMessage_Danger('Vui lòng nhập chi tiết hóa đơn');
                return;
            }
        }
        else {
            ShowMessage_Danger('Vui lòng nhập chi tiết hóa đơn');
            return;
        }
        self.InHoaDon(maChungTu, true);
    }
    shortcut.add('F11', function () {
        var rolePrintDraft = $.grep(self.Quyen_NguoiDung(), function (x) {
            return x.MaQuyen === 'HoaDon_InNhap';
        });
        if (rolePrintDraft.length === 0) {
            ShowMessage_Danger('Bạn không có quyền in nháp');
            return false;
        }
        // check set up print draft
        var itemEx = [];
        var lcSetPrint = localStorage.getItem(lcSetPrintConst);
        if (lcSetPrint !== null) {
            lcSetPrint = JSON.parse(lcSetPrint);
            var loaiHD = GetLoaiHoaDon_ofHDopening();
            itemEx = $.grep(lcSetPrint, function (x) {
                return x.LoaiHoaDon === loaiHD && x.PrintDraft === true;
            });
        }
        if (itemEx.length > 0) {
            self.printDraft();
        }
        else {
            ShowMessage_Danger('Bạn chưa thiết lập in nháp hóa đơn');
        }
    })
    self.InHoaDon_TextFile = function (idDivPrint) {
        var contents = $(idDivPrint).html();
        contents = contents.concat('<script src="/Scripts/knockout-3.4.2.js"></script>');
        PrintExtraReport(contents, '', self.numberOfPrint());
    }

    // setting print (new interface)
    self.ChangeSetPrint = function (typeSet) {
        // 1. print draft, 2. print product, 3.print invoice, 4.hide product TonKho <=0, 5.Nhap quy Cach, 6. So do phong
        self.agree_SettingPrint();
        // load again HangHoa, load after save cache
        switch (typeSet) {
            case 1:
                checkIsShowbtnSave();
                break;
            case 4:// tonkho
                break;
            case 5:
                Bind_CTHĐoiTra_afterHideColumn();
                break;
            case 6:
                ActiveTab_SoDoPhong(false);
                break;
        }
    }
    function BindPrint_HideSoDoPhong() {
        $('#setPrint div:eq(0)').hide();
        $('#setPrint div:eq(4)').hide();
    }
    function BindPrint_ShowSoDoPhong() {
        if (IsShop_SpaSalon()) {
            $('#setPrint div:eq(0)').show();
            $('#setPrint div:eq(4)').show();
        }
    }
    self.BindSettingPrint = function (isFirstLoad) {
        // get mahoadon --> get temp by loaiHoaDon
        if (_maHoaDon === '') {
            _maHoaDon = $('.gara-bill-label  li.active font').text();
        }
        var itemHD = [];
        var loaiHoaDon = 1;
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            itemHD = GetHDOpening_byMaHoaDon(_maHoaDon, lstHD);
        }
        if (itemHD.length > 0) {
            loaiHoaDon = itemHD[0].LoaiHoaDon;
        }
        loaiHoaDon = loaiHoaDon === 25 ? 1 : loaiHoaDon;
        // get list temp by loaiHoaDon
        var maloaiChungTu = '';
        switch (loaiHoaDon) {
            case 1:
            case 25:
                maloaiChungTu = 'HDBL';
                BindPrint_ShowSoDoPhong();
                break;
            case 19:
                maloaiChungTu = 'GDV';
                BindPrint_HideSoDoPhong();
                break;
            case 3:
                maloaiChungTu = 'DH';
                BindPrint_HideSoDoPhong();
                break;
            case 6:
                // check xem co mua moi khong
                var itemCTDT = [];
                var lstCTDoiTra = localStorage.getItem(lcListCTHD_DoiTra);
                if (lstCTDoiTra !== null) {
                    lstCTDoiTra = JSON.parse(lstCTDoiTra);
                    if (itemHD.length > 0) {
                        itemCTDT = $.grep(lstCTDoiTra, function (x) {
                            return x.IDRandomHD === itemHD[0].IDRandom;
                        });
                    }
                }
                if (itemCTDT.length > 0) {
                    maloaiChungTu = 'DTH';
                    loaiHoaDon = 4; // assign to do check in set print
                    BindPrint_ShowSoDoPhong();
                }
                else {
                    maloaiChungTu = 'TH';
                    BindPrint_HideSoDoPhong();
                }
                break;
        }
        // get all temp with maChungTu
        var lstTemp = $.grep(self.DM_MauIn(), function (x) {
            return x.MaLoaiChungTu === maloaiChungTu;
        });
        // check xem co mau mac dinh chua
        var itemDefault = $.grep(self.DM_MauIn(), function (x) {
            return x.MaLoaiChungTu === maloaiChungTu && x.LaMacDinh;
        });
        if (itemDefault.length === 0) {
            // neu chua co -->  push MauMacDinh into lst Mau
            var tempDefault = {
                ID: 0,
                TenMauIn: 'Mẫu mặc định',
                LaMacDinh: true,
            }
            lstTemp.unshift(tempDefault);
        }
        // sort by LaMacDinh is top
        lstTemp = lstTemp.sort(function (a, b) {
            var x = a.LaMacDinh, y = b.LaMacDinh;
            return (x === y) ? 0 : x ? -1 : 1;
        });
        // hide product if TonKho <= 0 
        var hideProduct = false;
        var itemSet = [];
        var lcSetPrint = localStorage.getItem(lcSetPrintConst);
        if (lcSetPrint !== null) {
            lcSetPrint = JSON.parse(lcSetPrint);
            var itemEx = $.grep(lcSetPrint, function (x) {
                return x.HideProduct === true;
            });
            hideProduct = itemEx.length > 0;
            itemSet = $.grep(lcSetPrint, function (x) {
                return x.LoaiHoaDon === loaiHoaDon && x.ID_DonVi === id_DonVi;
            });
        }
        if (itemSet.length === 0) {
            Reset_SettingPrint();
            self.ListTempPrint(lstTemp);
        }
        else {
            // find id_temprint in lst
            var miEx = $.grep(lstTemp, function (x) {
                return x.ID === itemSet[0].TempPrint;
            });
            self.setPrintDraft(itemSet[0].PrintDraft);
            self.setPrintPay(itemSet[0].PrintPay);
            self.setPrintTicket(itemSet[0].PrintTicket);
            self.numberOfPrint(itemSet[0].NumberOfPrint);
            self.setNhapQuyCach(itemSet[0].ShowEditQuyCach);
            self.setViewSoDoPhong(itemSet[0].ShowSoDoPhong);
            self.setLuuTam(itemSet[0].ShowLuuTam);
            self.ListTempPrint(lstTemp);
            if (miEx.length > 0) {
                // don't reset SettingPrint
                // set value for ddlTempPrint after bind ListTempPrint
                $('#ddlTempPrint').val(itemSet[0].TempPrint);
            }
        }
        // chi can cai dat HideProduct = true cho 1 loaiHD -- > default cac loai khac cung HideProduct = true 
        self.setHideProduct(hideProduct);
        if (isFirstLoad === false) {
            var divSetPrint = $('.install-notifi');
            if (divSetPrint.is(':hidden')) {
                divSetPrint.show();
            }
            else {
                divSetPrint.hide();
            };
        }
        // check hide/show printDraft, saveDraft by role (check after show div setup print)
        var rolePrintDraft = $.grep(self.Quyen_NguoiDung(), function (x) {
            return x.MaQuyen === 'HoaDon_InNhap';
        });
        if (rolePrintDraft.length > 0) {
            $('#setPrint div:eq(4)').show();
        }
        else {
            $('#setPrint div:eq(4)').hide();
        }
        var roleSaveDraft = $.grep(self.Quyen_NguoiDung(), function (x) {
            return x.MaQuyen === 'HoaDon_LuuNhap';
        });
        if (roleSaveDraft.length > 0) {
            if (loaiHoaDon === 1) {
                $('#setPrint div:eq(5)').show();// only show if loai1
            }
            else {
                $('#setPrint div:eq(5)').hide();
            }
        }
        else {
            $('#setPrint div:eq(5)').hide();
        }
    }
    $('#ddlTempPrint').on('change', function () {
        var idChosed = this.value;
        if (idChosed !== undefined) {
            self.agree_SettingPrint();
        }
    });
    self.Change_MauIn = function () {
        var idChosed = $('#ddlTempPrint').val();
        if (idChosed !== undefined) {
            self.agree_SettingPrint();
        }
    }
    // set height, page size when full product
    function SetPageSize_FullProduct(firstLoad) {
        //if (firstLoad) {
        if (_maHoaDon === '' || _maHoaDon === undefined) {
            _maHoaDon = $('.gara-bill-label  li.active font').text();
        }
        var loaiHoaDon = 3;
        // Trả hàng ... or THO or copy_T
        if (_maHoaDon.indexOf('T') > -1) {
            loaiHoaDon = 6;
        }
        // Hóa đơn ... or HDO or Coypy_H
        if (_maHoaDon.indexOf('H') === 0 || _maHoaDon.indexOf('CopyH') === 0) {
            loaiHoaDon = 1;
        }
        if (_maHoaDon.indexOf('G') === 0 || _maHoaDon.indexOf('CopyG') === 0) {
            loaiHoaDon = 19;
        }

        var hideProduct = false;
        var lsSetPrint = localStorage.getItem(lcSetPrintConst);
        if (lsSetPrint !== null) {
            lsSetPrint = JSON.parse(lsSetPrint);
            var itemEx = $.grep(lsSetPrint, function (x) {
                return x.HideProduct === true && x.ID_DonVi === id_DonVi;
            });
            hideProduct = itemEx.length > 0;

            var exLoai = $.grep(lsSetPrint, function (x) {
                return x.LoaiHoaDon === loaiHoaDon && x.ID_DonVi === id_DonVi;
            });
            if (exLoai.length > 0) {
                self.setPrintDraft(exLoai[0].PrintDraft);
                self.setPrintPay(exLoai[0].PrintPay);
                self.setPrintTicket(exLoai[0].PrintTicket);
                self.numberOfPrint(formatNumberToInt(exLoai[0].NumberOfPrint));
                $('#ddlTempPrint').val(exLoai[0].TempPrint);
            }
            else {
                Reset_SettingPrint()
            }
        }
        self.setHideProduct(hideProduct);
        //}
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            // only assign setPrintTicket = true if not HDupdate or hd was create from DatHang
            var itemHD = $.grep(lstHD, function (x) {
                return x.MaHoaDon === _maHoaDon && (x.ID !== null || x.ID_HoaDon !== null);
            });
            if (itemHD.length > 0) {
                self.setPrintTicket(false);
            }
        }
        if (self.setPrintTicket()) {
            $('.slide-goods').css('height', '94%');
            $('.grocery .bill-listmenu').css('height', '100%');
            // set assign pageSize list HangHoa
            if (self.windowWidth() < 1280) {
                self.windowWidth(1200);
            };
            if (self.windowWidth() >= 1569) {
                self.windowWidth(1569);
            };
            switch (self.windowWidth()) {
                case 768:
                    self.pageSize(12);
                    break;
                case 1024:
                    self.pageSize(6);
                    break;
                case 1200:
                    self.pageSize(12);
                    break;
                case 1280:
                    self.pageSize(12);
                    break;
                case 1358:
                    self.pageSize(24);
                    break;
                case 1440:
                    self.pageSize(28);
                    break;
                case 1569:
                    self.pageSize(24);
                    break;
            }
        }
        else {
            $('.slide-goods').css('height', '340px');
            $('.grocery .bill-listmenu').css('max-height', '370px');
            switch (self.windowWidth()) {
                case 768:
                    self.pageSize(12);
                    break;
                case 1024:
                    self.pageSize(6);
                    break;
                case 1200:
                    self.pageSize(12);
                    break;
                case 1280:
                    self.pageSize(12);
                    break;
                case 1358:
                    self.pageSize(12);
                    break;
                case 1440:
                    self.pageSize(12);
                    break;
                case 1569:
                    self.pageSize(12);
                    break;
            }
        }
        if (self.windowWidth() >= 1440) {
            self.pageSizeHD(4);
        } else {
            if (self.windowWidth() < 1440 && self.windowWidth() >= 1280) {
                self.pageSizeHD(3);
            } else {
                if (self.windowWidth() < 1280 && self.windowWidth() >= 1024) {
                    var lstHDisOpening = GetListHD_Opening();
                    var lenArr = lstHDisOpening.length;
                    self.pageSizeHD(lenArr);
                } else {
                    if (self.windowWidth() < 1024 && self.windowWidth() >= 800) {
                        self.pageSizeHD(1);
                    } else {
                        if (self.windowWidth() <= 768) {
                            self.pageSizeHD(4);
                        }
                    }
                }
            }
        }
        checkIsShowbtnSave();
    }
    self.UpDown_FullProduct = function () {
        if (self.setPrintTicket()) {
            // up: len, down: xuong
            var isUp = true;
            if ($('.up-slide .dow-sli').css('display') === 'none') {
                isUp = false;
            }
            // set assign pageSize list HangHoa
            if (self.windowWidth() >= 1536) {
                self.windowWidth(1600);
            }
            if (isUp) {
                switch (self.windowWidth()) {
                    case 768:
                        self.pageSize(8);
                        break;
                    case 1024:
                        self.pageSize(6);
                        break;
                    case 1358:
                        self.pageSize(24);
                        break;
                    case 1400:
                        self.pageSize(28);
                        break;
                    case 1600:
                        self.pageSize(28);
                        break;
                }
            }
            else {
                switch (self.windowWidth()) {
                    case 768:
                        self.pageSize(4);
                        break;
                    case 1024:
                        self.pageSize(6);
                        break;
                    case 1358:
                        self.pageSize(12);
                        break;
                    case 1400:
                        self.pageSize(21);
                        break;
                }
            }
        }
        if (self.windowWidth() >= 1440) {
            self.pageSizeHD(4);
        } else {
            if (self.windowWidth() < 1440 && self.windowWidth() >= 1280) {
                self.pageSizeHD(3);
            } else {
                if (self.windowWidth() < 1280 && self.windowWidth() >= 1024) {
                    self.pageSizeHD(2);
                } else {
                    if (self.windowWidth() < 1024 && self.windowWidth() >= 800) {
                        self.pageSizeHD(1);
                    } else {
                        if (self.windowWidth() <= 768) {
                            self.pageSizeHD(4);
                        }
                    }
                }
            }
        }
    }
    self.agree_SettingPrint = function () {
        if (_maHoaDon === '') {
            _maHoaDon = $('.gara-bill-label  li.active font').text();
        }
        // check LoaiHoaDon is opening
        var loaiHoaDon = 1;
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            itemHD = GetHDOpening_byMaHoaDon(_maHoaDon, lstHD);
            if (itemHD.length > 0) {
                loaiHoaDon = itemHD[0].LoaiHoaDon;
                if (loaiHoaDon === 6) {
                    var itemCTDT = [];
                    var lstCTDoiTra = localStorage.getItem(lcListCTHD_DoiTra);
                    if (lstCTDoiTra !== null) {
                        lstCTDoiTra = JSON.parse(lstCTDoiTra);
                        itemCTDT = $.grep(lstCTDoiTra, function (x) {
                            return x.IDRandomHD === itemHD[0].IDRandom;
                        });
                    }
                    // if DoiTra, assign Loai = 4
                    if (itemCTDT.length > 0) {
                        loaiHoaDon = 4;
                    }
                }
                else {
                    if (loaiHoaDon === 25) {
                        loaiHoaDon = 1;
                    }
                }
            }
        }
        var exist = false;
        var idTemprint = $('#ddlTempPrint').val();
        var lsSetPrint = localStorage.getItem(lcSetPrintConst);
        if (lsSetPrint !== null) {
            lsSetPrint = JSON.parse(lsSetPrint);
            // if exist --> update new value
            for (let i = 0; i < lsSetPrint.length; i++) {
                if (lsSetPrint[i].LoaiHoaDon === loaiHoaDon && lsSetPrint[i].ID_DonVi === id_DonVi) {
                    lsSetPrint[i].PrintDraft = self.setPrintDraft();
                    lsSetPrint[i].PrintPay = self.setPrintPay();
                    // default: not set print ticker for Dathang/TraHang
                    if (loaiHoaDon !== 1) {
                        self.setPrintTicket(false);
                    }
                    lsSetPrint[i].PrintTicket = self.setPrintTicket();
                    lsSetPrint[i].NumberOfPrint = self.numberOfPrint();
                    lsSetPrint[i].TempPrint = idTemprint;
                    lsSetPrint[i].HideProduct = self.setHideProduct();
                    lsSetPrint[i].ShowEditQuyCach = self.setNhapQuyCach();
                    lsSetPrint[i].ShowSoDoPhong = self.setViewSoDoPhong();
                    lsSetPrint[i].ShowLuuTam = self.setLuuTam();
                    exist = true;
                    break;
                }
            }
            // if HideProduct = false --> update HideProduct = false for all
            if (self.setHideProduct() === false) {
                for (let i = 0; i < lsSetPrint.length; i++) {
                    lsSetPrint[i].HideProduct = false;
                }
            }
        }
        else {
            lsSetPrint = [];
        }
        if (exist === false) {
            if (loaiHoaDon !== 1) {
                self.setPrintTicket(false);
            }
            var objSetPrint = {
                LoaiHoaDon: loaiHoaDon, // 1.HDBL, 3.DH, 6.TH, 4.DTH (use for setting print)
                PrintDraft: self.setPrintDraft(),
                PrintPay: self.setPrintPay(),
                PrintTicket: self.setPrintTicket(),
                NumberOfPrint: self.numberOfPrint(),
                TempPrint: idTemprint,
                HideProduct: self.setHideProduct(),
                ShowEditQuyCach: self.setNhapQuyCach(),
                ShowSoDoPhong: self.setViewSoDoPhong(),
                ShowLuuTam: self.setLuuTam(),
                ID_DonVi: id_DonVi,
            };
            lsSetPrint.push(objSetPrint);
        }
        localStorage.setItem(lcSetPrintConst, JSON.stringify(lsSetPrint));
    }
    self.increaseNumberPrint = function (isIncrease) {
        var numberOld = parseInt(self.numberOfPrint());
        if (isIncrease) {
            numberOld = numberOld + 1;
        }
        else {
            numberOld = numberOld - 1;
            if (numberOld <= 0) {
                numberOld = 1;
            }
        }
        self.numberOfPrint(numberOld);
        self.agree_SettingPrint();
    }
    self.editNumberOfPrint = function () {
        self.numberOfPrint(parseInt($(event.currentTarget).val()));
        self.agree_SettingPrint();
    }

    self.BindSet_HideShowColumCTHD = function () {
        $('#HienThi').modal('show');
        var lcSetCTHD = localStorage.getItem('lcHideShowColumCTHD_BL');
        if (lcSetCTHD !== null) {
            lcSetCTHD = JSON.parse(lcSetCTHD);
            for (let i = 0; i < lcSetCTHD.length; i++) {
                self.show_STT(lcSetCTHD[i].ShowSTT);
                self.show_ProductCode(lcSetCTHD[i].ShowProductCode);
                self.show_ProductName(lcSetCTHD[i].ShowProductName);
                self.show_ProductCount(lcSetCTHD[i].ShowProductCount);
                self.show_ProductSale(lcSetCTHD[i].ShowProductSale);
                self.show_ProductPrice(lcSetCTHD[i].ShowProductPrice);
                self.show_SumPrice(lcSetCTHD[i].ShowSumPrice);
                break;
            }
        }
        else {
            self.show_STT(true);
            self.show_ProductCode(true);
            self.show_ProductName(true);
            self.show_ProductCount(true);
            self.show_ProductPrice(true);
            self.show_SumPrice(true);
            self.show_ProductSale(true);
        }
        if (!self.show_STT()) {
            $('#divSet_showSTT').removeClass('main-hide');
        }
        else {
            $('#divSet_showSTT').addClass('main-hide');
        }
        if (!self.show_ProductCode()) {
            $('#divSet_showProductCode').removeClass('main-hide');
        }
        else {
            $('#divSet_showProductCode').addClass('main-hide');
        }
        if (!self.show_ProductName()) {
            $('#divSet_showProductName').removeClass('main-hide');
        }
        else {
            $('#divSet_showProductName').addClass('main-hide');
        }
        if (!self.show_ProductPrice()) {
            $('#divSet_showProductPrice').removeClass('main-hide');
        }
        else {
            $('#divSet_showProductPrice').addClass('main-hide');
        }
        if (!self.show_SumPrice()) {
            $('#divSet_showSumPrice').removeClass('main-hide');
        }
        else {
            $('#divSet_showSumPrice').addClass('main-hide');
        }
        if (!self.show_ProductCount()) {
            $('#divSet_showProductCount').removeClass('main-hide');
        }
        else {
            $('#divSet_showProductCount').addClass('main-hide');
        }
        if (!self.show_ProductSale()) {
            $('#divSet_showProductSale').removeClass('main-hide');
        }
        else {
            $('#divSet_showProductSale').addClass('main-hide');
        }
    }
    self.Setting_HideShowColumCTHD = function (idDiv) {
        var obj = $('#' + idDiv);
        obj.toggleClass("main-hide");
        switch (idDiv) {
            case 'divSet_showSTT':
                if (!obj.hasClass('main-hide')) {
                    self.show_STT(false);
                }
                else {
                    self.show_STT(true);
                }
                break;
            case 'divSet_showProductCode':
                if (!obj.hasClass('main-hide')) {
                    self.show_ProductCode(false);
                }
                else {
                    self.show_ProductCode(true);
                }
                break;
            case 'divSet_showProductName':
                if (!obj.hasClass('main-hide')) {
                    self.show_ProductName(false);
                }
                else {
                    self.show_ProductName(true);
                }
                break;
            case 'divSet_showProductPrice':
                if (!obj.hasClass('main-hide')) {
                    self.show_ProductPrice(false);
                }
                else {
                    self.show_ProductPrice(true);
                }
                break;
            case 'divSet_showSumPrice':
                if (!obj.hasClass('main-hide')) {
                    self.show_SumPrice(false);
                }
                else {
                    self.show_SumPrice(true);
                }
                break;
            case 'divSet_showProductCount':
                if (!obj.hasClass('main-hide')) {
                    self.show_ProductCount(false);
                }
                else {
                    self.show_ProductCount(true);
                }
                break;
            case 'divSet_showProductSale':
                if (!obj.hasClass('main-hide')) {
                    self.show_ProductSale(false);
                }
                else {
                    self.show_ProductSale(true);
                }
                break;
        }
    }
    var widthTenSanPham;
    self.Agree_SettingHideShowColumCTHD = function () {
        var lcSetCTHD = localStorage.getItem('lcHideShowColumCTHD_BL');
        if (lcSetCTHD !== null) {
            lcSetCTHD = JSON.parse(lcSetCTHD);
            for (let i = 0; i < lcSetCTHD.length; i++) {
                lcSetCTHD[i].ShowSTT = self.show_STT();
                lcSetCTHD[i].ShowProductCode = self.show_ProductCode();
                lcSetCTHD[i].ShowProductName = self.show_ProductName();
                lcSetCTHD[i].ShowProductPrice = self.show_ProductPrice();
                lcSetCTHD[i].ShowProductSale = self.show_ProductSale();
                lcSetCTHD[i].ShowSumPrice = self.show_SumPrice();
                lcSetCTHD[i].ShowProductCount = self.show_ProductCount();
                break;
            }
        }
        else {
            lcSetCTHD = [];
            var objSet = {
                ShowSTT: self.show_STT(),
                ShowProductCode: self.show_ProductCode(),
                ShowProductName: self.show_ProductName(),
                ShowProductPrice: self.show_ProductPrice(),
                ShowProductSale: self.show_ProductSale(),
                ShowSumPrice: self.show_SumPrice(),
                ShowProductCount: self.show_ProductCount(),
                ShowWidthProductName: self.show_WidthProductName()
            };
            lcSetCTHD.push(objSet);
        }
        widthTenSanPham = 30;
        if (lcSetCTHD[0].ShowProductPrice === true) {
            widthTenSanPham = widthTenSanPham + 130;
        }
        if (lcSetCTHD[0].ShowProductSale === true) {
            widthTenSanPham = widthTenSanPham + 130;
        }
        if (lcSetCTHD[0].ShowProductCount === true) {
            widthTenSanPham = widthTenSanPham + 185;
        }
        if (lcSetCTHD[0].ShowSumPrice === true) {
            widthTenSanPham = widthTenSanPham + 130;
        }
        $('#HienThi').modal('hide');
        self.show_WidthProductName("calc(100% - " + widthTenSanPham + "px)");
        self.showHeader_WidthProductName("calc(100% - " + widthTenSanPham + "px)");
        lcSetCTHD[0].ShowWidthProductName = self.show_WidthProductName();
        localStorage.setItem('lcHideShowColumCTHD_BL', JSON.stringify(lcSetCTHD));
        BindHD_CTHDafterSave();
        HideShow_HeaderCTHD();
        Bind_CTHĐoiTra_afterHideColumn();
    }
    function HideShow_HeaderCTHD() {
        self.showHeader_STT(self.show_STT());
        self.showHeader_ProductCode(self.show_ProductCode());
        self.showHeader_ProductName(self.show_ProductName());
        self.showHeader_ProductPrice(self.show_ProductPrice());
        self.showHeader_ProductSale(self.show_ProductSale());
        self.showHeader_SumPrice(self.show_SumPrice());
        self.showHeader_ProductCount(self.show_ProductCount());
        self.showHeader_WidthProductName(self.show_WidthProductName());
    }
    self.FullScreen = function () {
        toggleFullScreen();
        var elm = $('#ESC-full-screen');
        if ($(elm).css('display') === 'none') {
            $('#full-screen').attr('title', '');
            elm.show();
        }
        else {
            $('#full-screen').attr('title', 'Toàn màn hình');
            elm.hide();
        }
    }
    function toggleFullScreen() {
        if (!document.fullscreenElement &&    // alternative standard method
            !document.mozFullScreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement) {  // current working methods
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen();
            } else if (document.documentElement.msRequestFullscreen) {
                document.documentElement.msRequestFullscreen();
            } else if (document.documentElement.mozRequestFullScreen) {
                document.documentElement.mozRequestFullScreen();
            } else if (document.documentElement.webkitRequestFullscreen) {
                document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
            }
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            } else if (document.mozCancelFullScreen) {
                document.mozCancelFullScreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            }
        }
    }
    // short cut
    shortcut.add('Home', function () {
        $('#CTHDView').find('input[id^=munber_]').eq(0).focus().select();
    });
    shortcut.add('F6', function () {
        self.NhapThuong_Nhanh();
        //if( window.screen.width <1280){
        //    $("#divListHD").toggle()    
        //    }
    });
    shortcut.add('F10', function () {
        if ($('.bgwhite').css('display') === "none") {
            $('.bgwhite').show();
            self.saveHoaDonTraHang(false);
        }
    });

    self.editSoLuongDoiTra_NhapThuong = function () {
        var $this = $(event.currentTarget);
        formatNumberObj($this);

        var valThis = formatNumberToFloat($this.val());
        var keyCode = event.keyCode || event.which;
        if (keyCode === 13) {
            if (self.ItemHH_LoChosing_DoiTra().ID_DonViQuiDoi === undefined) {
                ShowMessage_Danger('Vui lòng chọn hàng hóa');
                return;
            }
            if (valThis === 0) {
                ShowMessage_Danger('Vui lòng nhập số lượng cho hàng hóa');
                return;
            }
            self.Click_ChoseHangLo_DoiTra(self.ItemHH_LoChosing_DoiTra(), 2);
        }
    }
    self.editDonGiaDoiTra_NhapThuong = function () {
        var keycode = event.keyCode || event.which;
        if (keycode === 13) {
            var product = self.ItemHH_LoChosing_DoiTra();
            self.Click_ChoseHangLo_DoiTra(product, 3);
        }
    }

    $.datetimepicker.setLocale('vi');
    function Insert_NhatKyThaoTac(objHD, objCTHD, chucNang, loaiNhatKy, isTamLuu) {
        // chuc nang (1. TaoHD/HuyHD, 2.ThemKH, 3.TaoPhieuThu, )
        isTamLuu = isTamLuu || false;
        var tenChucNang = '';
        var noiDung = '';
        var noiDungChiTiet = '';
        var txtFirst = '';
        var style1 = '<a style="cursor: pointer" onclick = "';
        var style2 = "('";
        var style3 = "')\" >";
        var style4 = '</a>';
        var funcNameKH = 'LoadKhachHang_byMaKH';
        var funcNameHD = 'LoadHoaDon_byMaHD';
        var funcNameHH = 'loadHangHoabyMaHH';
        var maHD = objHD.MaHoaDon;
        maHD = maHD === null ? '' : maHD;
        var styleMaHD = ''.concat(style1, funcNameHD, style2, maHD, style3, maHD, style4);
        var maKH = '';
        var sKH = '';
        var styleKH = '';
        var styleHDGoc = '';
        // get MaKhachHang by ID
        var itemKH = self.ChiTietDoiTuong();
        if (itemKH.length > 0) {
            maKH = itemKH[0].MaDoiTuong;
            sKH = ', Khách hàng: ' + maKH + ', ';
            styleKH = ', Khách hàng: '.concat(style1, funcNameKH, style2, maKH, style3, maKH, style4, ', ');
        }
        else {
            sKH = ', Khách hàng: Khách lẻ, ';
        }
        var ngaylapHD = moment(GetNgayLapHD_whenSave(objHD.NgayLapHoaDon), 'YYYY-MM-DD HH:mm').format('DD/MM/YYYY HH:mm');
        var phaiTT = 0;
        var isTraGoiDV = false;
        if (chucNang === 1) {
            var maHDGoc = '';
            var sHDGoc = '';
            var tenBG = ' Bảng giá: Bảng giá chuẩn, ';
            isTraGoiDV = objHD.LoaiHoaDon === 6 && objCTHD[0].ChatLieu === '4'
            // get TenBangGia by ID
            var itemBangGia = $.grep(self.GiaBans(), function (x) {
                return x.ID === objHD.ID_BangGia;
            });
            if (itemBangGia.length > 0) {
                tenBG = ' Bảng giá: ' + itemBangGia[0].TenGiaBan + ', ';
            }
            // get chi tiet hang hoa (chi lay 60 hang hoa - tranh NoiDungChiTiet qua dai)
            var styleHangHoa = '';
            var lenCTHD = objCTHD.length;
            for (let i = 0; i < lenCTHD; i++) {
                var itemCTHD = objCTHD[i];
                // if quanlitheolo: (MaHangHoa): (malo) Soluong, giaban
                // else (MaHangHoa): SoLuong, GiaBan
                var giaban = formatNumberToInt(itemCTHD.DonGia) - formatNumberToInt(itemCTHD.TienChietKhau);
                styleHangHoa += itemCTHD.QuanLyTheoLoHang ?
                    '- '.concat(style1, funcNameHH, style2, itemCTHD.MaHangHoa, style3, itemCTHD.MaHangHoa, style4, ' (Số lô: ', itemCTHD.MaLoHang, ')', ': Số lượng: ', itemCTHD.SoLuong, ', Giá bán: ', formatNumber3Digit(giaban), '<br />') :
                    '- '.concat(style1, funcNameHH, style2, itemCTHD.MaHangHoa, style3, itemCTHD.MaHangHoa, style4, ': Số lượng: ', itemCTHD.SoLuong, ', Giá bán: ', formatNumber3Digit(giaban), '<br />');
            }
            phaiTT = formatNumber3Digit(objHD.PhaiThanhToan);
            var styleKhuyenMai = '';
            switch (objHD.LoaiHoaDon) {
                case 1:
                    tenChucNang = 'Bán hàng';
                    txtFirst = 'Tạo hóa đơn: ';
                    if (isTamLuu) txtFirst = 'Tạo hóa đơn tạm lưu: ';
                    if (objHD.TrangThaiHD === 3) txtFirst = 'Thanh toán hóa đơn tạm lưu: ';
                    if (objHD.ID_HoaDon !== null && objHD.ID_HoaDon !== undefined) {
                        maHDGoc = objHD.MaHoaDonTraHang;
                        // neu HD DoiTra, objHD.ID_HoaDon !== null but maHDGoc = undefined
                        if (maHDGoc !== undefined) {
                            sHDGoc = ' (cho báo giá: ' + maHDGoc + ') ';
                            styleHDGoc = ' (cho báo giá: '.concat(style1, funcNameHD, style2, maHDGoc, style3, maHDGoc, style4, ') ');
                        }
                    }
                    if (objHD.KhuyenMai_GhiChu !== '' && objHD.KhuyenMai_GhiChu !== undefined && objHD.KhuyenMai_GhiChu !== 'undefined'
                        && objHD.KhuyenMai_GhiChu !== null && objHD.KhuyenMai_GhiChu.trim() !== '<br />') {
                        styleKhuyenMai = '<br /> Khuyến mại <i class="fa fa-gift bg-pink"></i><br />' + objHD.KhuyenMai_GhiChu;
                    }
                    break;
                case 3:
                    tenChucNang = 'Báo giá';
                    txtFirst = 'Tạo báo giá: ';
                    break;
                case 6:
                    tenChucNang = 'Trả hàng';
                    txtFirst = 'Tạo phiếu trả hàng: ';
                    if (objHD.ID_HoaDon !== null && objHD.ID_HoaDon !== undefined) {
                        maHDGoc = objHD.MaHoaDonTraHang;
                        sHDGoc = ' (cho hóa đơn: ' + maHDGoc + ') ';
                        styleHDGoc = ' (cho hóa đơn: '.concat(style1, funcNameHD, style2, maHDGoc, style3, maHDGoc, style4, ') ');
                    }
                    break;
                case 19:
                    tenChucNang = 'Gói dịch vu';
                    txtFirst = 'Mua gói dịch vụ: ';
                    break;
            }
            noiDung = txtFirst.concat(maHD, sHDGoc, sKH, tenBG, ' Giá trị: ', phaiTT, ', Thời gian: ', ngaylapHD);
            noiDungChiTiet = txtFirst.concat(styleMaHD, styleHDGoc, styleKH,
                tenBG, ' Giá trị: ', phaiTT, ', Thời gian: ', ngaylapHD,
                ' bao gồm: <br />', styleHangHoa, styleKhuyenMai);
        }
        if (chucNang === 2) {
            tenChucNang = 'Khách hàng';
            txtFirst = 'Thêm mới khách hàng: ';
            if (loaiNhatKy === 2) {
                txtFirst = 'Cập nhật khách hàng: ';
            }
            noiDung = txtFirst.concat(objHD.MaDoiTuong, ', tên: ', objHD.TenDoiTuong, ', Điện thoại:', objHD.DienThoai);
            noiDungChiTiet = txtFirst.concat(style1, funcNameKH, style2, objHD.MaDoiTuong, style3, objHD.MaDoiTuong, style4, ', tên: ', objHD.TenDoiTuong, ', Điện thoại:', objHD.DienThoai);
        }
        if (chucNang === 3 || chucNang === 4) {
            phaiTT = formatNumber3Digit(objHD.TongTienThu);
            maHDGoc = objHD.MaHoaDonTraHang;
            if (maHDGoc !== null) {
                styleHDGoc = ' cho hóa đơn: '.concat(style1, funcNameHD, style2, objHD.MaHoaDonTraHang, style3, objHD.MaHoaDonTraHang, style4, ' ');
            }
            // 11.Thu, 12.Chi
            if (objHD.LoaiHoaDon === 11) {
                tenChucNang = 'Phiếu thu';
                txtFirst = 'Tạo phiếu thu ';
            }
            else {
                tenChucNang = 'Phiếu chi';
                txtFirst = 'Tạo phiếu chi: ';
            }
            if (maHDGoc !== null) {
                noiDung = txtFirst.concat(maHD, ' cho hóa đơn ', objHD.MaHoaDonTraHang, sKH, ' với giá trị: ', phaiTT, ', Phương thức thanh toán: ', objHD.PhuongThucTT, ', Thời gian: ', ngaylapHD);
            }
            else {
                noiDung = txtFirst.concat(maHD, sKH, ' với giá trị: ', phaiTT, ', Phương thức thanh toán: ', objHD.PhuongThucTT, ', Thời gian: ', ngaylapHD);
            }
            noiDungChiTiet = txtFirst.concat(styleMaHD, styleHDGoc, styleKH,
                '<br/ > Giá trị: ', phaiTT, '<br/ > Phương thức thanh toán: ', objHD.PhuongThucTT, '<br/ > Thời gian: ', ngaylapHD);
        }
        // insert HT_NhatKySuDung
        var objNhatKy = {
            ID_NhanVien: _idNhanVien,
            ID_DonVi: id_DonVi,
            ChucNang: tenChucNang,
            LoaiNhatKy: loaiNhatKy,
            NoiDung: noiDung,
            NoiDungChiTiet: noiDungChiTiet,
        };
        if (chucNang === 1) {
            if (objHD.LoaiHoaDon !== 3) {
                // tamluu or trahang tu GoiDV --> don't update TonKho
                if (isTamLuu || isTraGoiDV) {
                    // update HD TamLuu: don't update GiaVon
                    Insert_NhatKyThaoTac_1Param(objNhatKy);
                }
                else {
                    objNhatKy.ID_HoaDon = objHD.ID;
                    objNhatKy.LoaiHoaDon = objHD.LoaiHoaDon;
                    var timeUpdate = GetNgayLapHD_whenSave(objHD.NgayLapHoaDon);
                    objNhatKy.ThoiGianUpdateGV = timeUpdate;
                    Post_NhatKySuDung_UpdateGiaVon(objNhatKy);
                }
            }
            else {
                // DatHang: khong update GiaVon
                Insert_NhatKyThaoTac_1Param(objNhatKy);
            }
        }
        else {
            Insert_NhatKyThaoTac_1Param(objNhatKy);
        }
    }
    //timer();
    function OnOff_Timer(ngaylapHD) {
        if (ngaylapHD === null) {
            stopTimer();
            timer();
        }
        else {
            stopTimer();
        }
    }
    function GetNgayLapHD_fromHD(ngaylapHD) {
        if (ngaylapHD === null) {
            return moment(now).format('YYYY-MM-DD HH:mm');
        }
        else {
            return ngaylapHD;
        }
    }
    console.log(1);
    self.showChiNhanh_byUser = function () {
        // hide list BangGia, list user if is openning
        var $this = $(event.currentTarget);
        var thisNext = $this.next();
        // get all ChiNhanh of user
        var arrChiNhanh = [];
        for (let i = 0; i < self.NhanViens_ChiNhanh().length; i++) {
            var itemFor = self.NhanViens_ChiNhanh()[i];
            if (itemFor.ID_NguoiDung === id_User) {
                // find ChiNhanh in list ChiNhanh
                var itemCN = $.grep(self.ChiNhanhs(), function (x) {
                    return x.ID === itemFor.ID_DonVi;
                });
                if (itemCN.length > 0) {
                    arrChiNhanh.push(itemCN[0]);
                }
            }
        }

        var arrSortbyName = [];
        if (arrChiNhanh.length > 0) {
            arrSortbyName = arrChiNhanh.sort((a, b) => a.TenDonVi.localeCompare(b.TenDonVi, undefined, { caseFirst: "upper" }));
        }
        self.ChiNhanhs_byUser(arrSortbyName);

        // show/hide dropdown list ChiNhanh if not HD offline && not TraHang from HD
        var check = CheckHDOffline_orTraHangfromHD();
        if (arrChiNhanh.length > 1 && check === 0) {
            if (thisNext.css('display') === 'none') {
                thisNext.show();
            }
            else {
                thisNext.hide();
            }
            $this.find(" font i").toggle();
        }
    }
    self.filterChiNhanh = ko.observable();
    self.arrChiNhanhs_byUser = ko.computed(function (x) {
        var filter = self.filterChiNhanh();
        return ko.utils.arrayFilter(self.ChiNhanhs_byUser(), function (prop) {
            var chon = true;
            var arr = locdau(prop.TenDonVi).split(/\s+/);
            var sSearch = '';
            for (let i = 0; i < arr.length; i++) {
                sSearch += arr[i].toString().split('')[0];
            }
            if (filter) {
                chon = (locdau(prop.TenDonVi).indexOf(locdau(filter)) >= 0 ||
                    sSearch.indexOf(locdau(filter)) >= 0
                )
            }
            return chon;
        })
    })
    self.CheckRole_ChangeNVien = function () {
        // show list NhanVien if not HD offline
        var check = CheckHDOffline_orTraHangfromHD();
        if (check !== 1) {
            // check role change NVien
            var loaiHoaDon = GetLoaiHoaDon_ofHDopening();
            var maQuyen = '';
            switch (loaiHoaDon) {
                case 1:
                case 25:
                    maQuyen = 'HoaDon_ThayDoiNhanVien';
                    break;
                case 3:
                    maQuyen = 'DatHang_ThayDoiNhanVien';
                    break;
                case 6:
                    maQuyen = 'TraHang_ThayDoiNhanVien';
                    break;
                case 19:
                    maQuyen = 'GoiDichVu_ThayDoiNhanVien';
                    break;
            }
            var itemRole = $.grep(self.Quyen_NguoiDung(), function (x) {
                return x.MaQuyen === maQuyen;
            });
            if (itemRole.length === 0) {
                return;
            }
            showpopup(3);
        }
    }
    // lo hang
    self.AllLot = ko.observableArray();
    self.ListLot_ofProduct = ko.observableArray();// danh sach lo theo id_quidoi
    self.AllLot_ofProduct = ko.observableArray();
    self.LotChosed = ko.observableArray(); // lo da chon khi add hang hoa (always = 1)
    self.filterLot_ofProduct = ko.observable(); // search lo hang

    self.LoadListLot_ofProduct = function (item) {
        var $this = $(event.currentTarget);
        ajaxHelper(DMHangHoaUri + 'GetInforProduct_ByIDQuidoi?idQuiDoi=' + item.ID_DonViQuiDoi
            + '&idChiNhanh=' + id_DonVi).done(function (x) {
                if (x.res === true) {
                    var lst = x.data;
                    let dtNow = moment(new Date()).format('YYYY-MM-DD');
                    lst = $.grep(lst, function (x1) {
                        return x1.ID_LoHang !== null;
                    });
                    if (self.HoaDons().LoaiHoaDon() === 6) {
                        lst = $.grep(lst, function (x1) {
                            return x1.NgayHetHan === null || moment(x1.NgayHetHan).format('YYYY-MM-DD') >= dtNow;
                        });
                    }
                    self.ListLot_ofProduct(lst);
                    self.AllLot_ofProduct(lst);
                    if (lst.length > 0) {
                        $this.next().show();
                    }
                    else {
                        $this.next().hide();
                    }
                }
            });
    }

    self.ClickChoseLot = function (item) {
        var $this = $(event.currentTarget);
        let lotNSX = GetNgaySX_NgayHH(item);
        var idRandom = $this.closest('.ctLo').attr('id');
        var idLoHang = item.ID_LoHang;
        var maLoHang = item.MaLoHang;
        var soluongConLai = null; // use get soluongconlai in DM_Lo of CTTraHang
        // add cache CTHD
        var cthd = localStorage.getItem(lcListCTHD);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            if (_maHoaDon === '') {
                _maHoaDon = $('.gara-bill-label li.active font').text();
            }
            var idRandomHD = GetIDRandomHD_byMaHoaDon(_maHoaDon);
            // check exist Lot if same ID_QuiDoi
            var itemCTHD = $.grep(cthd, function (x) {
                return x.IDRandomHD === idRandomHD && x.ID_DonViQuiDoi === item.ID_DonViQuiDoi;
            });
            var xuatAm = false;
            if (itemCTHD.length > 0) {
                if (itemCTHD[0].LoaiHoaDon === 1) {
                    xuatAm = self.ThietLap().XuatAm;
                }
                else {
                    if (itemCTHD[0].LoaiHoaDon === 3) {
                        xuatAm = self.ThietLap().DatHangXuatAm;
                    }
                }

                // neu chon lo khong co trong ctTraHang --> warning
                if (itemCTHD[0].LoaiHoaDon === 6) {
                    if (itemCTHD[0].QuanLyTheoLoHang) {
                        var arrID_LoHang = [];
                        var cacheTraHang = localStorage.getItem(lcCTHDTraHang_fromHD);
                        if (cacheTraHang !== null) {
                            cacheTraHang = JSON.parse(cacheTraHang);
                            // get CTTraHang with ID_QuiDoi is chosing
                            var cacheTH_ofHD = $.grep(cacheTraHang, function (x) {
                                return x.IDRandomHD === idRandomHD && x.ID_DonViQuiDoi === item.ID_DonViQuiDoi;
                            });
                            if (cacheTH_ofHD.length > 0) {
                                // get arrID_LoHang in cache TraHang
                                for (let i = 0; i < cacheTH_ofHD[0].DM_LoHang.length; i++) {
                                    arrID_LoHang.push(cacheTH_ofHD[0].DM_LoHang[i].ID_LoHang);
                                    if (cacheTH_ofHD[0].DM_LoHang[i].ID_LoHang === idLoHang) {
                                        soluongConLai = cacheTH_ofHD[0].DM_LoHang[i].SoLuongDaMua;
                                    }
                                }
                            }
                            if (arrID_LoHang.length > 0 && $.inArray(idLoHang, arrID_LoHang) === -1) {
                                ShowMessage_Danger('Lô ' + item.MaLoHang + ' không tồn tại trong chi tiết trả hàng');
                                return;
                            }
                        }
                    }
                }
            }
            for (let i = 0; i < cthd.length; i++) {
                let ctFor = cthd[i];
                if (ctFor.IDRandomHD === idRandomHD && ctFor.ID_DonViQuiDoi === item.ID_DonViQuiDoi) {
                    // if change ID_LoHang --> update, not push
                    for (let j = 0; j < ctFor.DM_LoHang.length; j++) {
                        if (ctFor.DM_LoHang[j].IDRandom === idRandom) {
                            // if first DM_LoHang--> update ID_LoHang for CTHD if LotParent
                            if (j === 0) {
                                cthd[i].ID_LoHang = idLoHang;
                                cthd[i].MaLoHang = maLoHang; // add properties MaLoHang --> used to save LichSuThaoTac
                                cthd[i].TonKho = item.TonKho; // update TonKho forCTHD parent
                                cthd[i].NgaySanXuat = item.NgaySanXuat;// --> used to InHoaDon
                                cthd[i].NgayHetHan = item.NgayHetHan;
                                cthd[i].CssWarning = (xuatAm === false && cthd[i].TonKho < cthd[i].SoLuong);
                            }
                            cthd[i].DM_LoHang[j].ID_LoHang = idLoHang;
                            cthd[i].DM_LoHang[j].MaLoHang = maLoHang;
                            cthd[i].DM_LoHang[j].NgaySanXuat = lotNSX.NgaySanXuat;
                            cthd[i].DM_LoHang[j].NgayHetHan = lotNSX.NgayHetHan;
                            cthd[i].DM_LoHang[j].TonKho = item.TonKho;
                            // find SoLuongConLai at ct TraHang
                            if (soluongConLai !== null) {
                                cthd[i].DM_LoHang[j].SoLuongDaMua = soluongConLai;
                            }
                            cthd[i].DM_LoHang[j].CssWarning = (xuatAm === false && cthd[i].DM_LoHang[j].TonKho < cthd[i].DM_LoHang[j].SoLuong);
                            break;
                        }
                    }
                    break;
                }
            }
            localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
            BindCTHD_byIDRandomHD(idRandomHD);
            HideShow_Icon_ChietKhauNV();
        }
        HideShow_Icon_ChietKhauNV();
    }
    self.addLot = function (item) {
        var idQuiDoi = item.ID_DonViQuiDoi;
        var idRandomHD = item.IDRandomHD;
        var cthd = localStorage.getItem(lcListCTHD);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            if (_maHoaDon === '') {
                _maHoaDon = $('.gara-bill-label li.active font').text();
            }
            var idRandomCungLoai = '';
            if (item.QuanLyTheoLoHang === false) {
                // add hangcungloai
                for (let i = 0; i < cthd.length; i++) {
                    if (cthd[i].IDRandomHD === idRandomHD && cthd[i].ID_DonViQuiDoi === idQuiDoi
                        && cthd[i].ID_ChiTietGoiDV === item.ID_ChiTietGoiDV) {
                        let cungloai = $.extend({}, cthd[i]);
                        cungloai.SoLuong = 1;
                        let obj = newHangHoa(cungloai, null, true);
                        idRandomCungLoai = obj.IDRandom;
                        obj.ID_ChiTietGoiDV = null;// su dung gdv: neu add cungloai --> coi như mua mới
                        cthd[i].HangCungLoais.push(obj);
                        break;
                    }
                }
            }
            else {
                // add lot
                for (let i = 0; i < cthd.length; i++) {
                    let itFor = cthd[i];
                    if (itFor.IDRandomHD === idRandomHD && itFor.ID_DonViQuiDoi === idQuiDoi) {
                        let lohang = $.extend({}, itFor);
                        lohang.SoLuong = 1;
                        let countLot = itFor.DM_LoHang.length;
                        let idRandom = CreateIDRandom('RandomCT_');
                        let objLot = newHangHoa(lohang, null, true);
                        objLot.NgaySanXuat = itFor.NgaySanXuat;
                        objLot.NgayHetHan = itFor.NgayHetHan;
                        objLot.LotParent = false;
                        objLot.IDRandom = idRandom;
                        objLot.SoThuTu = countLot + 1;
                        objLot.DM_LoHang = [];
                        objLot.HangCungLoais = [];
                        objLot.ThanhPhan_DinhLuong = [];
                        objLot.BH_NhanVienThucHien = [];
                        cthd[i].DM_LoHang.push(objLot);
                        break;
                    }
                }
            }
            localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
            var arrCTHD = $.grep(cthd, function (x) {
                return x.IDRandomHD === idRandomHD;
            });
            self.HangHoaAfterAdds(arrCTHD);
            // update TongTienHang if HD mua
            if (_maHoaDon.indexOf('Trả') === -1) {
                UpdateCacheHDLe(idRandomHD, false);
                UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();
            }
            else {
                UpdateHD_TraHang(idRandomHD);
            }
            // bind CTHoaDOn
            self.KM_KMApDung([]);
            UpdateKhuyenMai_CTHD(idQuiDoi, idRandomHD);
            ResetKM_HangHoa(this.ID_DonViQuiDoi, this.ID_NhomHangHoa, idRandomHD);
            ResetKM_HoaDon(idRandomHD);
            if (item.LoaiHoaDon === 3) {
                Update_StatusXuLy_ofHDDatHang(idRandomHD);
            }
            if (!commonStatisJs.CheckNull(idRandomCungLoai)) {
                UpdateSoLuong_TPDinhLuong_ofCTHD(idRandomHD, idRandomCungLoai, 1, false);
            }
            BindHD_byIDRandom(idRandomHD);
            BindCTHD_byIDRandomHD(idRandomHD);
            Focus_InputPhaiThanhToan();
            Caculator_AmountProduct();
        }
        HideShow_Icon_ChietKhauNV();
    }

    self.LoHang_indexFocus = ko.observable(0);
    self.SearchLot_ofProduct = function (item) {
        var thisObj = event.currentTarget;
        var txtSearch = $(thisObj).val().toLowerCase();
        var arrLot = [];
        if (txtSearch !== '') {
            for (let i = 0; i < self.AllLot_ofProduct().length; i++) {
                if (self.AllLot_ofProduct()[i].MaLoHang.toLowerCase().indexOf(txtSearch) > -1) {
                    arrLot.push(self.AllLot_ofProduct()[i]);
                }
            }
            self.ListLot_ofProduct(arrLot);
        }
        else {
            self.ListLot_ofProduct(self.AllLot_ofProduct());
        }
        if (self.ListLot_ofProduct().length > 0) {
            $(thisObj).next().show();
        }
        else {
            $(thisObj).next().hide();
        }
        // compare text search with MaLoHang
        var itemEx = $.grep(self.ListLot_ofProduct(), function (x) {
            return x.MaLoHang === txtSearch;
        });
        var idRandomHD = GetIDRandomHD_byMaHoaDon(item.MaHoaDon);
        var isCTHD_Ban = false; // check search CTHD Ban/DoiTra
        if (itemEx.length === 0) {
            // reset lot for CTHD
            var cthd = localStorage.getItem(lcListCTHD);
            if (cthd !== null) {
                cthd = JSON.parse(cthd);
                // remove lot is chosing of CTHD/DM_LoHang
                for (let i = 0; i < cthd.length; i++) {
                    let xCTHD = cthd[i];
                    if (xCTHD.IDRandomHD === idRandomHD && xCTHD.ID_DonViQuiDoi === item.ID_DonViQuiDoi) {
                        for (let j = 0; j < xCTHD.DM_LoHang.length; j++) {
                            if (xCTHD.DM_LoHang[j].IDRandom === item.IDRandom) {
                                isCTHD_Ban = true;
                                if (xCTHD.DM_LoHang[j].LotParent) {
                                    cthd[i].ID_LoHang = null;
                                }
                                cthd[i].DM_LoHang[j].ID_LoHang = null;
                                break;
                            }
                        }
                    }
                }
                localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
            }
            if (isCTHD_Ban === false) {
                // find and reset CTHD DoiTra
                // nếu đã chọn lô, và chọn lại lô này trên cùng 1 dòng --> reset
                var cthd_DoiTra = localStorage.getItem(lcListCTHD_DoiTra);
                if (cthd_DoiTra !== null) {
                    cthd_DoiTra = JSON.parse(cthd_DoiTra);
                    for (let i = 0; i < cthd_DoiTra.length; i++) {
                        let xCTHD = cthd_DoiTra[i];
                        if (xCTHD.IDRandomHD === idRandomHD && xCTHD.ID_DonViQuiDoi === item.ID_DonViQuiDoi) {
                            for (let j = 0; j < xCTHD.DM_LoHang.length; j++) {
                                if (xCTHD.DM_LoHang[j].IDRandom === item.IDRandom) {
                                    if (xCTHD.DM_LoHang[j].LotParent) {
                                        cthd_DoiTra[i].ID_LoHang = null;
                                    }
                                    cthd_DoiTra[i].DM_LoHang[j].ID_LoHang = null;
                                    break;
                                }
                            }
                        }
                    }
                    localStorage.setItem(lcListCTHD_DoiTra, JSON.stringify(cthd_DoiTra));
                }
            }
        }

        var keyCode = event.keyCode || event.which;
        if (keyCode !== 13) {
            switch (keyCode) {
                case 38:
                    if (self.LoHang_indexFocus() < 0) {
                        self.LoHang_indexFocus(0);
                    }
                    else {
                        self.LoHang_indexFocus(self.LoHang_indexFocus() - 1);
                    }
                    break;
                case 40:
                    if (self.LoHang_indexFocus() > self.searchList.length) {
                        self.LoHang_indexFocus(0);
                    }
                    else {
                        self.LoHang_indexFocus(self.LoHang_indexFocus() + 1);
                    }
                    break;
            }

        }
        else {
            if (keyCode === 13) {
                var itemFocus = $.grep(self.AllLot_ofProduct(), function (x, index) {
                    return index === self.LoHang_indexFocus();
                });
                if (itemFocus.length > 0) {
                    var loaiHD = GetLoaiHoaDon_ofHDopening();
                    if (loaiHD === 6) {
                        self.ClickChoseLot_DoiTra(itemFocus[0]);
                    }
                    else {
                        self.ClickChoseLot(itemFocus[0]);
                    }
                }
            }
        }
    }
    function GetLoaiHoaDon_ofHDopening() {
        if (_maHoaDon === '') {
            _maHoaDon = $('.gara-bill-label li.active font').text();
        }
        var loaiHoaDon = 1;
        if (_maHoaDon.indexOf('H') === 0 || _maHoaDon.indexOf('CopyH') === 0) {
            loaiHoaDon = 1;
        }
        if (_maHoaDon.indexOf('B') > -1 || _maHoaDon.indexOf(nameHD_UpdateDH) > -1) {
            loaiHoaDon = 3;
        }
        if (_maHoaDon.indexOf('T') > -1) {
            loaiHoaDon = 6;
        }
        // neu trả gói dịch vụ, return loai = 19 --> show icon chiết khấu NV + ngày áp dụng (nếu đổi trả) (mặc dù thực tế loại = 6)
        if (_maHoaDon.indexOf('DV') > -1) {
            loaiHoaDon = 19;
        }
        return loaiHoaDon;
    }

    function ChangeDonGia_CaculatorAgainCTHD(ctDoing, soluongNew, dongiaNew) {

        let price = formatNumberToFloat(dongiaNew);
        let tienCK = ctDoing.TienChietKhau;
        var tienthue = ctDoing.TienThue;

        if (ctDoing.PTChietKhau > 0) {
            tienCK = ctDoing.PTChietKhau * price / 100;
        }
        if (ctDoing.PTThue > 0) {
            tienthue = ctDoing.PTThue * (price - tienCK) / 100;
        }

        var tongphiDV = 0;
        if (ctDoing.LoaiHoaDon === 1 || ctDoing.LoaiHoaDon === 25) {
            tongphiDV = ctDoing.PhiDichVu;
            if (ctDoing.LaPTPhiDichVu) {
                tongphiDV = ctDoing.PhiDichVu * soluongNew * price / 100;
            }
        }
        ctDoing.SoLuong = soluongNew;
        ctDoing.DonGia = dongiaNew;
        ctDoing.GiaBan = dongiaNew;
        ctDoing.TienChietKhau = tienCK;
        ctDoing.TienThue = tienthue;
        ctDoing.TongPhiDichVu = tongphiDV;
        ctDoing.ThanhTien = soluongNew * (dongiaNew - tienCK);
        ctDoing.ThanhToan = soluongNew * (dongiaNew - tienCK + tienthue);
        return ctDoing;
    }

    self.ItemHH_LoChosing = ko.observable();
    self.Click_ChoseHangLo = async function (itemChose, type = 1) {
        if (_maHoaDon === '') {
            _maHoaDon = $('.gara-bill-label li.active font').text();
        }

        var isOffline = CheckHoaDonOffline_byMaHoaDon(_maHoaDon);
        if (isOffline === false) {
            return false;
        }

        var addHang = true;
        if (!self.IsNhapNhanh() && type === 1) {
            addHang = false;
            $('#txtSoLuong_DT').focus().select();
        }

        if (!addHang) {
            return;
        }

        self.ItemHH_LoChosing(itemChose);

        var idQuiDoi = itemChose.ID_DonViQuiDoi;
        var idCT_goiDV = null;
        if (!commonStatisJs.CheckNull(itemChose.ID_ChiTietGoiDV)) {
            idCT_goiDV = itemChose.ID_ChiTietGoiDV
        }
        var quanLiTheoLo = itemChose.QuanLyTheoLoHang;
        quanLiTheoLo = (quanLiTheoLo === null ? false : quanLiTheoLo);

        var soluong = 1, dongia = itemChose.GiaBan;
        switch (type) {
            case 1:
                $('#txtSearchHH').focus();
                if (quanLiTheoLo) {
                    $('#txtSearchHH').val(itemChose.MaHangHoa + ' LSX: ' + itemChose.MaLoHang);
                }
                else {
                    $('#txtSearchHH').val(itemChose.MaHangHoa);
                }
                $('#txtSearchHH').select();
                break;
            case 2:
                soluong = formatNumberToFloat(self.txtSoLuong());

                if (formatNumberToFloat(self.txtDonGia()) > 0) {
                    dongia = formatNumberToFloat(self.txtDonGia());
                }
                break;
            case 3:
                soluong = formatNumberToFloat(self.txtSoLuong());
                dongia = formatNumberToFloat(self.txtDonGia());
                $('#txtDonGia').focus().select();
                break;
        }

        var itemEx = [];
        var lstHoaDon = localStorage.getItem(lcListHD);
        if (lstHoaDon === null) {
            lstHoaDon = [];
        }
        else {
            lstHoaDon = JSON.parse(lstHoaDon);
            itemEx = GetHDOpening_byMaHoaDon(_maHoaDon, lstHoaDon);
        }
        if (itemEx.length === 0) {
            var newObj = newHoaDon(1, 1);
            lstHoaDon.push(newObj);
            localStorage.setItem(lcListHD, JSON.stringify(lstHoaDon));
        }
        // find itemHD with _maHoaDon
        var itemHD = GetHDOpening_byMaHoaDon(_maHoaDon, lstHoaDon);
        var idRandomHD = itemHD[0].IDRandom;
        var loaiHD = itemHD[0].LoaiHoaDon;
        var arrIDQuyDoi_TH = [];
        var arrID_LoHang_TH = [];
        var itemCTTrahang = [];

        if (itemChose.LoaiHangHoa === 3) {
            itemChose.ThanhPhanComBo = await GetThanhPhanComBo(itemChose.ID_DonViQuiDoi, itemHD[0]);
        }
        else {
            itemChose.ThanhPhanComBo = [];
        }

        // use when HD was create from DatHang
        var typeAdd = 0; // 0. HD, 1. Trahang, 2. XulyDatHang
        if (loaiHD === 6) {
            var cacheTraHang = localStorage.getItem(lcCTHDTraHang_fromHD);
            if (cacheTraHang !== null) {
                cacheTraHang = JSON.parse(cacheTraHang);
                // get cache CTTH of Hoa don Tra (trường hợp mở nhiều HDTraHang cùng lúc)
                var cacheTH_ofHD = $.grep(cacheTraHang, function (item) {
                    return item.IDRandomHD === idRandomHD;
                });
                if (cacheTH_ofHD.length > 0) {
                    typeAdd = 1;
                    // get arrID_QuyDoi in cache TraHang
                    for (let i = 0; i < cacheTH_ofHD.length; i++) {
                        arrIDQuyDoi_TH.push(cacheTH_ofHD[i].ID_DonViQuiDoi);
                    }
                    // get item with ID_QuyDoi --> get SoLuongDaMua
                    itemCTTrahang = $.grep(cacheTH_ofHD, function (item) {
                        return item.ID_DonViQuiDoi === idQuiDoi;
                    });
                    if (itemCTTrahang.length > 0) {
                        for (let i = 0; i < itemCTTrahang[0].DM_LoHang.length; i++) {
                            arrID_LoHang_TH.push(itemCTTrahang[0].DM_LoHang[i].ID_LoHang);
                        }
                    }
                    // check exist in HDTra
                    if ($.inArray(idQuiDoi, arrIDQuyDoi_TH) === -1) {
                        ShowMessage_Danger('Hàng hóa ' + itemChose.TenHangHoa + ' không có trong đơn hàng');
                        return false;
                    }
                    if (itemChose.QuanLyTheoLoHang && $.inArray(itemChose.ID_LoHang, arrID_LoHang_TH) === -1) {
                        ShowMessage_Danger('Hàng  hóa ' + itemChose.TenHangHoa
                            + ' có số lô: ' + itemChose.MaLoHang + ' không có trong đơn hàng');
                        return;
                    }
                }
            }
        }
        else {
            // check HD was create from DatHang --> assign SoLuongDaMua
            if (itemHD[0].MaHoaDonTraHang !== null && itemHD[0].MaHoaDonTraHang !== undefined && itemHD[0].MaHoaDonTraHang !== '') {
                var ctDatHang = localStorage.getItem(lcCTDatHang_Const);
                if (ctDatHang !== null) {
                    ctDatHang = JSON.parse(ctDatHang);
                    itemCTTrahang = $.grep(ctDatHang, function (x) {
                        return x.ID_DonViQuiDoi === itemChose.ID_DonViQuiDoi && x.MaHoaDon === itemHD[0].MaHoaDonTraHang;
                    });
                    if (itemCTTrahang.length > 0) {
                        typeAdd = 2;
                        // cache DatHang: assign SoLuongDaMua = SoLuongConLai --> assign to CTHD
                        itemCTTrahang[0].SoLuongDaMua = itemCTTrahang[0].SoLuongConLai;
                        itemCTTrahang[0].ID_ChiTietGoiDV = itemCTTrahang[0].ID;
                        for (let j = 0; j < itemCTTrahang[0].DM_LoHang.length; j++) {
                            if (j !== 0) {
                                itemCTTrahang[0].DM_LoHang[j].ID_ChiTietGoiDV = itemCTTrahang[0].DM_LoHang[j].ID;
                            }
                            itemCTTrahang[0].DM_LoHang[j].SoLuongDaMua = itemCTTrahang[0].DM_LoHang[j].SoLuongConLai;
                        }
                        for (let j = 0; j < itemCTTrahang[0].HangCungLoais.length; j++) {
                            itemCTTrahang[0].HangCungLoais[j].ID_ChiTietGoiDV = itemCTTrahang[0].HangCungLoais[j].ID;
                            itemCTTrahang[0].HangCungLoais[j].SoLuongDaMua = itemCTTrahang[0].HangCungLoais[j].SoLuongConLai;
                        }
                    }
                }
            }
        }

        var found = -1;
        var soluongNew = 1;
        itemChose.GiaBan = dongia;
        itemChose.SoLuong = soluong;
        itemChose.ID_HangHoa = itemChose.ID;
        var ob1 = {};

        var cthd = localStorage.getItem(lcListCTHD);
        if (cthd === null) {
            cthd = [];
        }
        else {
            cthd = JSON.parse(cthd);
        }
        for (let i = 0; i < cthd.length; i++) {
            let itemFor = cthd[i];
            if (itemFor.IDRandomHD === idRandomHD && itemFor.ID_DonViQuiDoi === idQuiDoi
                && itemFor.ID_ChiTietGoiDV === idCT_goiDV) {
                found = i;
                ob1 = itemFor;
                if (itemFor.QuanLyTheoLoHang) {
                    let ctEx = $.grep(itemFor.DM_LoHang, function (x) {
                        return x.ID_LoHang === itemChose.ID_LoHang;
                    });
                    if (ctEx.length > 0) {
                        if (ctEx[0].LotParent) {
                            soluongNew = formatNumberToFloat(itemFor.SoLuong) + soluong;

                            ob1 = ChangeDonGia_CaculatorAgainCTHD(ob1, soluongNew, type == 3 ? dongia : ob1.GiaBan);

                            // assign again lotparent
                            ob1.DM_LoHang[0].SoLuong = ob1.SoLuong;
                            ob1.DM_LoHang[0].ThanhTien = ob1.ThanhTien;
                            ob1.DM_LoHang[0].ThanhToan = ob1.ThanhToan;
                            ob1.DM_LoHang[0].TongPhiDichVu = ob1.TongPhiDichVu;

                            if (typeAdd === 1 && soluongNew > itemFor.SoLuongDaMua) {
                                ShowMessage_Danger(itemChose.TenHangHoa +
                                    ' có mã lô ' + itemChose.MaLoHang + ' chỉ được phép trả tối đa số lượng là ' + itemFor.SoLuongDaMua);
                                return;
                            }
                        }
                        else {
                            // update soluong in dm_lo
                            for (let k = 0; k < ob1.DM_LoHang.length; k++) {
                                let forLot = ob1.DM_LoHang[k];
                                if (forLot.ID_LoHang === itemChose.ID_LoHang) {
                                    ob1.DM_LoHang[k].SoLuong = forLot.SoLuong + soluong;

                                    if (typeAdd === 1 && ob1.DM_LoHang[k].SoLuong > forLot.SoLuongDaMua) {
                                        ShowMessage_Danger(itemChose.TenHangHoa +
                                            ' có mã lô ' + itemChose.MaLoHang + ' chỉ được phép trả tối đa số lượng là ' + itemFor.SoLuongDaMua);
                                        return;
                                    }
                                    ob1.DM_LoHang[k] = ChangeDonGia_CaculatorAgainCTHD(ob1.DM_LoHang[k],
                                        ob1.DM_LoHang[k].SoLuong, type == 3 ? dongia : forLot.GiaBan);
                                    break;
                                }
                            }
                        }
                    }
                    else {
                        let objLot = {};
                        if (typeAdd !== 0) {
                            let loChild = $.grep(itemCTTrahang[0].DM_LoHang, function (x) {
                                return x.ID_LoHang === itemChose.ID_LoHang;
                            });
                            if (loChild.length > 0) {
                                loChild[0].SoLuong = 1;
                                objLot = newHangHoa(loChild[0], itemHD[0]);
                                objLot.NgaySanXuat = loChild[0].NgaySanXuat;
                                objLot.NgayHetHan = loChild[0].NgayHetHan;
                                objLot.SoLuongDaMua = loChild[0].SoLuongDaMua;
                                objLot.SoLuongConLai = loChild[0].SoLuongConLai;
                            }
                        }
                        else {
                            objLot = newHangHoa(itemChose, itemHD[0]);
                        }
                        objLot.LotParent = false;
                        ob1.DM_LoHang.push(objLot);
                    }
                }
                else {
                    soluongNew = formatNumberToFloat(itemFor.SoLuong) + soluong;
                    if (typeAdd === 1 && soluongNew > itemFor.SoLuongDaMua) {
                        ShowMessage_Danger(itemChose.TenHangHoa +
                            ' chỉ được phép trả tối đa số lượng là ' + itemFor.SoLuongDaMua);
                        return;
                    }
                    ob1 = ChangeDonGia_CaculatorAgainCTHD(ob1, soluongNew, type == 3 ? dongia : ob1.GiaBan);
                }
                break;
            }
        }
        if (found === -1) {
            if (typeAdd !== 0) {
                itemCTTrahang[0].SoLuong = 1;
                ob1 = newHangHoa(itemCTTrahang[0], itemHD[0]);
                ob1.SoLuongDaMua = itemCTTrahang[0].SoLuongDaMua;
                ob1.SoLuongConLai = itemCTTrahang[0].SoLuongConLai;
            }
            else {
                ob1 = newHangHoa(itemChose, itemHD[0]);
            }
            if (ob1.QuanLyTheoLoHang) {
                let objLot = $.extend({}, ob1);
                objLot.ListDonViTinh = [];
                objLot.HangCungLoais = [];
                objLot.DM_LoHang = [];
                objLot.ThanhPhan_DinhLuong = [];
                objLot.BH_NhanVienThucHien = [];
                ob1.DM_LoHang.push(objLot);
            }
            cthd.unshift(ob1);
        }
        else {
            switch (typeAdd) {
                case 0:
                    for (let i = 0; i < cthd.length; i++) {
                        if (cthd[i].IDRandomHD === idRandomHD && cthd[i].ID_DonViQuiDoi === idQuiDoi) {
                            cthd.splice(i, 1);
                            break;
                        }
                    }
                    break;
                case 1:
                case 2:
                    for (let i = 0; i < cthd.length; i++) {
                        if (cthd[i].IDRandomHD === idRandomHD && cthd[i].ID_DonViQuiDoi === idQuiDoi) {
                            ob1.ID_ChiTietGoiDV = cthd[i].ID_ChiTietGoiDV;
                            ob1.SoLuongDaMua = cthd[i].SoLuongDaMua;
                            ob1.SoLuongConLai = cthd[i].SoLuongConLai;
                            cthd.splice(i, 1);
                            break;
                        }
                    }
                    break;
            }
            cthd.unshift(ob1);
        }
        localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
        UpdateAgain_DonViTinhCTHD(ob1.ID_HangHoa, false);
        UpdateSoThuTu_CTHD(false, idRandomHD);
        UpdateWarning_forCTHD_byIDQuiDoi(idQuiDoi, idRandomHD);
        Reset_ListDVT_forCTHD_TraHang();
        self.KM_KMApDung([]);
        UpdateKhuyenMai_CTHD(ob1.ID_DonViQuiDoi, idRandomHD);
        if (ob1.ThanhPhanComBo.length > 0) {
            ChangeSoLuongParent_UpdateCombo(ob1.IDRandom, soluongNew, false);
        }
        ResetKM_HangHoa(ob1.ID_DonViQuiDoi, ob1.ID_NhomHangHoa, idRandomHD);
        UpdateChietKhauNV_inCTHD(ob1.IDRandom, itemHD[0].LoaiHoaDon === 6, ob1);
        BindCTHD_byIDRandomHD(idRandomHD);
        ResetKM_HoaDon(idRandomHD);
        if (itemHD[0].LoaiHoaDon === 3) {
            Update_StatusXuLy_ofHDDatHang(idRandomHD);
        }
        if (itemHD[0].LoaiHoaDon !== 6) {
            if (found !== -1) {
                UpdateSoLuong_TPDinhLuong_ofCTHD(idRandomHD, ob1.IDRandom, soluongNew, false);
            }
            if (ob1.DonGiaBaoHiem > 0) {
                UpdateInforBaoHiem(idRandomHD);
            }
            UpdateCacheHDLe(idRandomHD, false);
            UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();
            var arrHD = [];
            let lcHD = localStorage.getItem(lcListHD);
            lcHD = JSON.parse(lcHD);
            for (let i = 0; i < lcHD.length; i++) {
                if (lcHD[i].IDRandom === idRandomHD) {
                    arrHD = lcHD[i];
                    break;
                }
            }
            var printTicket = Check_PrintTicket(itemHD[0]);
            if (printTicket === true) {
                self.saveHoaDonTraHang(false);
            }
            else {
                // bind again HoaDon if have KhuyenMai
                self.HoaDons().SetData(arrHD);
            }
        }
        else {
            if (found !== -1) {
                UpdateSoLuong_TPDinhLuong_ofCTHD(idRandomHD, ob1.IDRandom, soluongNew, true);
            }
            UpdateHD_TraHang(idRandomHD);
        }
        BindHD_byIDRandom(idRandomHD);
        HideShow_Icon_ChietKhauNV();
        Caculator_AmountProduct();
    }

    async function GetThanhPhanComBo(idQuiDoi, hd) {
        var xx = await ajaxHelper(DMHangHoaUri + 'GetDinhLuongDV_FromIDQuyDoi?idQuiDoi=' + idQuiDoi + '&idDonVi=' + id_DonVi
            , 'GET').done(function () {
            })
            .then(function (x) {
                if (x.res) {
                    let combo = [];
                    for (let i = 0; i < x.dataSoure.length; i++) {
                        let tp = x.dataSoure[i];
                        tp.DonViTinh = [];
                        tp.ID_ChiTietGoiDV = null;
                        tp.GiaVon = 0;
                        tp.GhiChuHH = tp.GhiChu;
                        let objTP = newHangHoa(tp, hd, false);
                        objTP.PTThue = 0;
                        objTP.TienThue = 0;
                        objTP.PTChietKhau = 0;
                        objTP.TienChietKhau = 0;
                        objTP.DonGia = tp.GiaBan;
                        objTP.ThanhTien = tp.GiaBan * tp.SoLuong;
                        objTP.ThanhToan = objTP.ThanhTien;
                        objTP.SoLuongMacDinh = tp.SoLuong;

                        let tongphiDV = 0;
                        if (objTP.LoaiHoaDon === 1 || objTP.LoaiHoaDon === 25) {
                            tongphiDV = tp.PhiDichVu;
                            if (tp.LaPTPhiDichVu) {
                                tongphiDV = Math.round(tp.PhiDichVu * tp.SoLuong * tp.GiaBan / 100);
                            }
                        }
                        objTP.TongPhiDichVu = tongphiDV;
                        combo.push(objTP);
                    }
                    return combo;
                }
                return []
            })
        return xx;
    }

    function UpdateSoThuTu_CTHD(isCTDoiTra, idRandomHD) {
        var locaStoreName = lcListCTHD;
        if (isCTDoiTra) {
            locaStoreName = lcListCTHD_DoiTra;
        }
        var listAllCTHD = localStorage.getItem(locaStoreName);
        if (listAllCTHD !== null) {
            listAllCTHD = JSON.parse(listAllCTHD);
            // get arrHD with MaHoaDon
            var arrHD = $.grep(listAllCTHD, function (item) {
                return item.IDRandomHD === idRandomHD;
            });
            // update again SoThuTu for CTHD with MaHoaDon
            var stt = 1;
            for (let i = arrHD.length - 1; i >= 0; i--) {
                arrHD[i].SoThuTu = stt;
                stt = stt + 1;
            }
            for (let i = listAllCTHD.length - 1; i >= 0; i--) {
                if (listAllCTHD[i].IDRandomHD === idRandomHD) {
                    for (let j = 0; j < arrHD.length; j++) {
                        if (listAllCTHD[i].ID_DonViQuiDoi === arrHD[j].ID_DonViQuiDoi && listAllCTHD[i].ID_ChiTietGoiDV === arrHD[j].ID_ChiTietGoiDV) {
                            listAllCTHD[i].SoThuTu = arrHD[j].SoThuTu;
                        }
                    }
                }
            }
            localStorage.setItem(locaStoreName, JSON.stringify(listAllCTHD));
        }
    }
    function FindCTHD_isDoing(item, isCTDoiTra) {
        var quanLiTheoLo = item.QuanLyTheoLoHang;
        quanLiTheoLo = (quanLiTheoLo === null ? false : quanLiTheoLo);
        var idCT_goiDV = item.ID_ChiTietGoiDV;
        idCT_goiDV = (idCT_goiDV === undefined ? null : idCT_goiDV);
        var concungloai = item.LaConCungLoai;
        var idRandom = item.IDRandom;
        var locaStoreName = lcListCTHD;
        if (isCTDoiTra) {
            locaStoreName = lcListCTHD_DoiTra;
        }
        var cthd = localStorage.getItem(locaStoreName);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            if (quanLiTheoLo) {
                if (item.LotParent) {
                    for (let i = 0; i < cthd.length; i++) {
                        if (cthd[i].IDRandom === idRandom) {
                            return cthd[i];
                        }
                    }
                }
                else {
                    for (let i = 0; i < cthd.length; i++) {
                        for (let j = 0; j < cthd[i].DM_LoHang.length; j++) {
                            if (cthd[i].DM_LoHang[j].IDRandom === idRandom) {
                                return cthd[i].DM_LoHang[j];
                            }
                        }
                    }
                }
            }
            else {
                if (concungloai) {
                    for (let i = 0; i < cthd.length; i++) {
                        for (let j = 0; j < cthd[i].HangCungLoais.length; j++) {
                            if (cthd[i].HangCungLoais[j].IDRandom === idRandom) {
                                return cthd[i].HangCungLoais[j];
                            }
                        }
                    }
                }
                else {
                    for (let i = 0; i < cthd.length; i++) {
                        if (cthd[i].IDRandom === idRandom) {
                            return cthd[i];
                        }
                    }
                }
            }
        }
        return null;
    }

    self.ItemHH_LoChosing_DoiTra = ko.observable();
    self.Click_ChoseHangLo_DoiTra = async function (itemChose, type = 1) {
        if (_maHoaDon === '') {
            _maHoaDon = $('.gara-bill-label li.active font').text();
        }
        var isOffline = CheckHoaDonOffline_byMaHoaDon(_maHoaDon);
        if (isOffline === false) {
            return false;
        }
        self.ItemHH_LoChosing_DoiTra(itemChose);
        var addHang = true;
        if (!self.IsNhapNhanh_DoiTra() && type === 1) {
            addHang = false;
            $('#txtSoLuong_DT').focus().select();
        }

        var idQuiDoi = itemChose.ID_DonViQuiDoi;
        var quanLiTheoLo = itemChose.QuanLyTheoLoHang;
        quanLiTheoLo === null ? false : quanLiTheoLo;

        var soluong = 1, dongia = itemChose.GiaBan;
        switch (type) {
            case 1:
                $('#txtSearchDoiTra').focus();
                if (quanLiTheoLo) {
                    $('#txtSearchDoiTra').val(itemChose.MaHangHoa + ' LSX: ' + itemChose.MaLoHang);
                }
                else {
                    $('#txtSearchDoiTra').val(itemChose.MaHangHoa);
                }
                $('#txtSearchDoiTra').select();
                break;
            case 2:
                soluong = formatNumberToFloat(self.txtSoLuongDT());
                $('#txtSoLuong_DT').focus().select();
                if (formatNumberToFloat(self.txtDonGiaDT()) > 0) {
                    dongia = formatNumberToFloat(self.txtDonGiaDT());
                }
                break;
            case 3:
                soluong = formatNumberToFloat(self.txtSoLuongDT());
                dongia = formatNumberToFloat(self.txtDonGiaDT());
                $('#txtDonGia_DT').focus().select();
                break;
        }

        if (!addHang) {
            return;
        }

        if (addHang) {
            var itemEx = [];
            var lstHoaDon = localStorage.getItem(lcListHD);
            if (lstHoaDon === null) {
                lstHoaDon = [];
            }
            else {
                lstHoaDon = JSON.parse(lstHoaDon);
                itemEx = GetHDOpening_byMaHoaDon(_maHoaDon, lstHoaDon);
            }
            if (itemEx.length === 0) {
                var newObj = newHoaDon(1, 1);
                lstHoaDon.push(newObj);
                localStorage.setItem(lcListHD, JSON.stringify(lstHoaDon));
            }
            // find itemHD with _maHoaDon
            var itemHD = GetHDOpening_byMaHoaDon(_maHoaDon, lstHoaDon);
            var idRandomHD = itemHD[0].IDRandom;
            var idCT_goiDV = itemChose.ID_ChiTietGoiDV;
            idCT_goiDV = (idCT_goiDV === undefined ? null : idCT_goiDV);

            itemChose.SoLuong = soluong;
            itemChose.GiaBan = dongia;
            itemChose.ID_HangHoa = itemChose.ID;

            if (itemChose.LoaiHangHoa === 3) {
                itemChose.ThanhPhanComBo = await GetThanhPhanComBo(itemChose.ID_DonViQuiDoi, itemHD[0]);
            }
            else {
                itemChose.ThanhPhanComBo = [];
            }

            var ob1 = {};
            var found = -1;
            var soluongNew = 1;

            var cthd = localStorage.getItem(lcListCTHD_DoiTra);
            if (cthd === null) {
                cthd = [];
            }
            else {
                cthd = JSON.parse(cthd);
            }
            for (let i = 0; i < cthd.length; i++) {
                let itemFor = cthd[i];
                if (itemFor.IDRandomHD === idRandomHD && itemFor.ID_DonViQuiDoi === idQuiDoi) {
                    found = i;
                    ob1 = itemFor;
                    if (itemFor.QuanLyTheoLoHang) {
                        let ctEx = $.grep(itemFor.DM_LoHang, function (x) {
                            return x.ID_LoHang === itemChose.ID_LoHang;
                        });
                        if (ctEx.length > 0) {
                            if (ctEx[0].LotParent) {
                                soluongNew = formatNumberToFloat(itemFor.SoLuong) + soluong;

                                ob1 = ChangeDonGia_CaculatorAgainCTHD(ob1, soluongNew, type === 3 ? dongia : ob1.GiaBan);
                                // assign again lotparent
                                ob1.DM_LoHang[0].SoLuong = ob1.SoLuong;
                                ob1.DM_LoHang[0].ThanhTien = ob1.ThanhTien;
                                ob1.DM_LoHang[0].ThanhToan = ob1.ThanhToan;
                                ob1.DM_LoHang[0].TongPhiDichVu = ob1.TongPhiDichVu;
                            }
                            else {
                                // update soluong in dm_lo
                                for (let k = 0; k < ob1.DM_LoHang.length; k++) {
                                    let forLot = ob1.DM_LoHang[k];
                                    if (forLot.ID_LoHang === itemChose.ID_LoHang) {
                                        ob1.DM_LoHang[k].SoLuong = forLot.SoLuong + soluong;
                                        ob1.DM_LoHang[k] = ChangeDonGia_CaculatorAgainCTHD(ob1.DM_LoHang[k],
                                            ob1.DM_LoHang[k].SoLuong, type === 3 ? dongia : forLot.GiaBan);
                                        break;
                                    }
                                }
                            }
                        }
                        else {
                            let objLot = newHangHoa(itemChose, itemHD[0]);
                            objLot.LotParent = false;
                            ob1.DM_LoHang.push(objLot);
                        }
                    }
                    else {
                        soluongNew = formatNumberToFloat(itemFor.SoLuong) + soluong;
                        ob1 = ChangeDonGia_CaculatorAgainCTHD(ob1, soluongNew, type === 3 ? dongia : ob1.GiaBan);
                    }
                    break;
                }
            }
            if (found === -1) {
                ob1 = newHangHoa(itemChose, itemHD[0]);
                if (ob1.QuanLyTheoLoHang) {
                    let objLot = $.extend({}, ob1);
                    objLot.ListDonViTinh = [];
                    objLot.HangCungLoais = [];
                    objLot.DM_LoHang = [];
                    objLot.ThanhPhan_DinhLuong = [];
                    objLot.BH_NhanVienThucHien = [];
                    ob1.DM_LoHang.push(objLot);
                }
                cthd.unshift(ob1);
            }
            else {
                for (let i = 0; i < cthd.length; i++) {
                    if (cthd[i].IDRandomHD === idRandomHD && cthd[i].ID_DonViQuiDoi === idQuiDoi
                        && cthd[i].ID_ChiTietGoiDV === idCT_goiDV) {
                        cthd.splice(i, 1);
                        break;
                    }
                }
                cthd.unshift(ob1);
            }
            localStorage.setItem(lcListCTHD_DoiTra, JSON.stringify(cthd));

            UpdateSoThuTu_CTHD(true, idRandomHD);
            UpdateAgain_DonViTinhCTHD(ob1.ID_HangHoa, true);
            UpdateWarning_forCTHD_byIDQuiDoi(idQuiDoi, idRandomHD);
            if (found !== -1) {
                UpdateSoLuong_TPDinhLuong_ofCTHD(idRandomHD, ob1.IDRandom, soluongNew, true);
            }
            if (ob1.ThanhPhanComBo.length > 0) {
                ChangeSoLuongParent_UpdateCombo(ob1.IDRandom, soluongNew, true);
            }
            UpdateCacheHDLe(idRandomHD, true);
            UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();
            Bind_CTHĐoiTra_afterHideColumn();
            BindHD_byIDRandom(idRandomHD);
            HideShow_Icon_ChietKhauNV();
        }
    }
    self.KeyUp_GiamGiaNhomKH = function () {
        var $this = $('#txtGiamGiaNhomKH');
        formatNumberObj($this);
        var valThis = formatNumberToFloat($this.val());
        if ($('#LaPhanTram').hasClass('active-re')) {
            if (valThis > 100) {
                $this.val(100);
            }
        }
    }

    self.GridNV_TVTH = ko.observableArray();
    self.DichVu_isDoing = ko.observable();

    // status: busy=1 (bận) , free=0 (rảnh)
    // check and assign status for NhanVien
    function Check_Status_NhanVien() {
        var arrIDNhanVien = [];
        // find NhanVien is busy in CTHD
        var cthd = localStorage.getItem(lcListCTHD);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            for (let i = 0; i < cthd.length; i++) {
                for (let j = 0; j < cthd[i].BH_NhanVienThucHien.length; j++) {
                    if ($.inArray(cthd[i].BH_NhanVienThucHien[j].ID_NhanVien, arrIDNhanVien) === -1) {
                        arrIDNhanVien.push(cthd[i].BH_NhanVienThucHien[j].ID_NhanVien);
                    }
                }
                // find nv in hangcungloai
                if (cthd[i].HangCungLoais.length > 0) {
                    for (let k = 0, m = cthd[i].HangCungLoais.length; k < m; k++) {
                        for (let n = 0; n < cthd[i].HangCungLoais[k].BH_NhanVienThucHien.length; n++) {
                            if ($.inArray(cthd[i].HangCungLoais[k].BH_NhanVienThucHien[n].ID_NhanVien, arrIDNhanVien) === -1) {
                                arrIDNhanVien.push(cthd[i].HangCungLoais[k].BH_NhanVienThucHien[n].ID_NhanVien);
                            }
                        }
                    }
                }
                // find nv in lohang
                if (cthd[i].DM_LoHang.length > 0) {
                    for (let k = 0, m = cthd[i].DM_LoHang.length; k < m; k++) {
                        if (cthd[i].DM_LoHang[k].BH_NhanVienThucHien !== undefined) {
                            for (let n = 0; n < cthd[i].DM_LoHang[k].BH_NhanVienThucHien.length; n++) {
                                if ($.inArray(cthd[i].DM_LoHang[k].BH_NhanVienThucHien[n].ID_NhanVien, arrIDNhanVien) === -1) {
                                    arrIDNhanVien.push(cthd[i].DM_LoHang[k].BH_NhanVienThucHien[n].ID_NhanVien);
                                }
                            }
                        }
                    }
                }

                if (cthd[i].ThanhPhanComBo.length > 0) {
                    for (let k = 0, m = cthd[i].ThanhPhanComBo.length; k < m; k++) {
                        if (cthd[i].ThanhPhanComBo[k].BH_NhanVienThucHien !== undefined) {
                            for (let n = 0; n < cthd[i].ThanhPhanComBo[k].BH_NhanVienThucHien.length; n++) {
                                if ($.inArray(cthd[i].ThanhPhanComBo[k].BH_NhanVienThucHien[n].ID_NhanVien, arrIDNhanVien) === -1) {
                                    arrIDNhanVien.push(cthd[i].ThanhPhanComBo[k].BH_NhanVienThucHien[n].ID_NhanVien);
                                }
                            }
                        }
                    }
                }
            }
        }
        // find NhanVien is busy in CTHD_DoiTra
        var ctdt = localStorage.getItem(lcListCTHD_DoiTra);
        if (ctdt !== null) {
            ctdt = JSON.parse(ctdt);
            for (let i = 0; i < ctdt.length; i++) {
                for (let j = 0; j < ctdt[i].BH_NhanVienThucHien.length; j++) {
                    if ($.inArray(ctdt[i].BH_NhanVienThucHien[j].ID_NhanVien, arrIDNhanVien) === -1) {
                        arrIDNhanVien.push(ctdt[i].BH_NhanVienThucHien[j].ID_NhanVien);
                    }
                }
                // find nv in hangcungloai
                if (ctdt[i].HangCungLoais.length > 0) {
                    for (let k = 0, m = ctdt[i].HangCungLoais.length; k < m; k++) {
                        for (let n = 0; n < ctdt[i].HangCungLoais[k].BH_NhanVienThucHien.length; n++) {
                            if ($.inArray(ctdt[i].HangCungLoais[k].BH_NhanVienThucHien[n].ID_NhanVien, arrIDNhanVien) === -1) {
                                arrIDNhanVien.push(ctdt[i].HangCungLoais[k].BH_NhanVienThucHien[n].ID_NhanVien);
                            }
                        }
                    }
                }
                // find nv in lohang
                if (ctdt[i].DM_LoHang.length > 0) {
                    for (let k = 0, m = ctdt[i].DM_LoHang.length; k < m; k++) {
                        for (let n = 0; n < ctdt[i].DM_LoHang[k].BH_NhanVienThucHien.length; n++) {
                            if ($.inArray(ctdt[i].DM_LoHang[k].BH_NhanVienThucHien[n].ID_NhanVien, arrIDNhanVien) === -1) {
                                arrIDNhanVien.push(ctdt[i].DM_LoHang[k].BH_NhanVienThucHien[n].ID_NhanVien);
                            }
                        }
                    }
                }
            }
        }
        // add Status for List NhanVien
        for (let i = 0; i < self.NhanViens().length; i++) {
            if ($.inArray(self.NhanViens()[i].ID, arrIDNhanVien) === -1) {
                self.NhanViens()[i].StatusCV = 0;
            }
            else {
                self.NhanViens()[i].StatusCV = 1;
            }
        }
    }

    self.showPopupUserDiscount = function (item, isDoiTra) {
        Check_Status_NhanVien();
        vmHoaHongDV.listData.NhanViens = self.NhanViens();

        var cthdDoing = FindCTHD_isDoing(item, isDoiTra);
        if (cthdDoing !== null) {
            let phiDV = 0;
            // chi tinh phiDV khi su dung
            if (item.LaHangHoa === false && (item.LoaiHoaDon === 1 || item.LoaiHoaDon === 25 || isDoiTra)) {
                phiDV = cthdDoing.TongPhiDichVu;
                phiDV = phiDV === undefined ? 0 : phiDV;
            }
            cthdDoing.TongPhiDichVu = phiDV;
            let thanhtien = (cthdDoing.GiaBan - cthdDoing.TienChietKhau) * cthdDoing.SoLuong;
            thanhtien = thanhtien < 0 ? 0 : thanhtien;
            cthdDoing.ThanhTien = thanhtien;

            self.DichVu_isDoing(cthdDoing);
            vmHoaHongDV.GridNV_TVTH = cthdDoing.BH_NhanVienThucHien;
            vmHoaHongDV.DichVu_isDoing = cthdDoing;

            let loaiHD = self.HoaDons().LoaiHoaDon();
            if (loaiHD === 6) {
                if (self.HoaDons().MaHoaDon().indexOf('DV') > -1) {
                    loaiHD = 19;
                }
                else {
                    loaiHD = 1;
                }
            }
            vmHoaHongDV.inforHoaDon.LoaiHoaDon = loaiHD;
            vmHoaHongDV.showModal(cthdDoing, isDoiTra, false);
        }
    }

    self.AgreeNhanVien_TVTH = function () {

        // update listNhanVien TV, TH in cache CTHD
        var nvTH = '';
        var nvTV = '';
        var nvTH_Print = '';
        var nvTV_Print = '';
        for (let i = 0; i < vmHoaHongDV.GridNV_TVTH.length; i++) {
            let itemFor = vmHoaHongDV.GridNV_TVTH[i];
            let dvtCK = ' đ';
            let valCK = formatNumber3Digit(itemFor.TienChietKhau);
            if (itemFor.PT_ChietKhau > 0) {
                dvtCK = ' %';
                valCK = itemFor.PT_ChietKhau;
            }
            switch (itemFor.TacVu) {
                case 1: // thuchien
                case 3: // thuchien theoyc
                    nvTH += itemFor.TenNhanVien + ' (' + valCK + dvtCK + '), ';
                    nvTH_Print += itemFor.TenNhanVien + ', ';
                    break;
                case 2: // tuvan
                case 4: // bangoi
                    nvTV += itemFor.TenNhanVien + ' (' + valCK + dvtCK + '), ';
                    nvTV_Print += itemFor.TenNhanVien + ', ';
                    break;
            }
        }

        var loaiHD = GetLoaiHoaDon_ofHDopening();
        var nameCacheCTHD = lcListCTHD;
        var txtFirst_GhiChu = "Tư vấn: ";
        switch (loaiHD) {
            case 6:
                nameCacheCTHD = lcListCTHD_DoiTra;
                break;
            case 19:
                var allHD = localStorage.getItem(lcListHD);
                if (allHD !== null) {
                    allHD = JSON.parse(allHD);
                    let hdOp = GetHDOpening_byIDRandom(self.DichVu_isDoing().IDRandomHD, allHD);
                    if (hdOp.length > 0) {
                        if (hdOp[0].LoaiHoaDon === 6) {
                            nameCacheCTHD = lcListCTHD_DoiTra;
                        }
                    }
                }
                txtFirst_GhiChu = 'Bán gói DV: '
                break
        }
        nvTH = nvTH !== '' ? 'Thực hiện: ' + Remove_LastComma(nvTH) : '';
        nvTH_Print = nvTH_Print !== '' ? Remove_LastComma(nvTH_Print) : '';
        nvTV = nvTV !== '' ? txtFirst_GhiChu + Remove_LastComma(nvTV) : '';
        nvTV_Print = nvTV_Print !== '' ? Remove_LastComma(nvTV_Print) : '';

        // update NVTH-TV in CTHD
        var idRandom = self.DichVu_isDoing().IDRandom;
        var quanlytheolo = self.DichVu_isDoing().QuanLyTheoLoHang;
        var cthd = localStorage.getItem(nameCacheCTHD);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            let tinhHoaHongtruocCK = vmHoaHongDV.TinhHoaHongTruocCK ? 1 : 0;
            if (self.DichVu_isDoing().LotParent || (quanlytheolo === false && self.DichVu_isDoing().LaConCungLoai === false)) {
                for (let i = 0; i < cthd.length; i++) {
                    if (cthd[i].IDRandom === idRandom) {
                        cthd[i].GhiChu_NVThucHien = nvTH;
                        cthd[i].GhiChu_NVThucHienPrint = nvTH_Print;
                        cthd[i].GhiChu_NVTuVan = nvTV;
                        cthd[i].GhiChu_NVTuVanPrint = nvTV_Print;
                        cthd[i].HoaHongTruocChietKhau = tinhHoaHongtruocCK;
                        cthd[i].BH_NhanVienThucHien = vmHoaHongDV.GridNV_TVTH;
                        break;
                    }
                }
            }
            else {
                if (quanlytheolo) {
                    for (let i = 0; i < cthd.length; i++) {
                        for (let j = 0; j < cthd[i].DM_LoHang.length; j++) {
                            if (cthd[i].DM_LoHang[j].IDRandom === idRandom) {
                                cthd[i].DM_LoHang[j].GhiChu_NVThucHien = nvTH;
                                cthd[i].DM_LoHang[j].GhiChu_NVThucHienPrint = nvTH_Print;
                                cthd[i].DM_LoHang[j].GhiChu_NVTuVan = nvTV;
                                cthd[i].DM_LoHang[j].GhiChu_NVTuVanPrint = nvTV_Print;
                                cthd[i].DM_LoHang[j].HoaHongTruocChietKhau = tinhHoaHongtruocCK;
                                cthd[i].DM_LoHang[j].BH_NhanVienThucHien = vmHoaHongDV.GridNV_TVTH;
                                i = cthd.length;  // esc for loop
                                break;
                            }
                        }
                    }
                }
                else {
                    for (let i = 0; i < cthd.length; i++) {
                        for (let j = 0; j < cthd[i].HangCungLoais.length; j++) {
                            if (cthd[i].HangCungLoais[j].IDRandom === idRandom) {
                                cthd[i].HangCungLoais[j].GhiChu_NVThucHien = nvTH;
                                cthd[i].HangCungLoais[j].GhiChu_NVThucHienPrint = nvTH_Print;
                                cthd[i].HangCungLoais[j].GhiChu_NVTuVan = nvTV;
                                cthd[i].HangCungLoais[j].GhiChu_NVTuVanPrint = nvTV_Print;
                                cthd[i].HangCungLoais[j].HoaHongTruocChietKhau = tinhHoaHongtruocCK;
                                cthd[i].HangCungLoais[j].BH_NhanVienThucHien = vmHoaHongDV.GridNV_TVTH;
                                i = cthd.length;
                                break;
                            }
                        }
                    }
                }
            }
            localStorage.setItem(nameCacheCTHD, JSON.stringify(cthd));
        }
        // update ID_ViTri in cache HD
        var lstHD = localStorage.getItem(lcListHD);
        lstHD = JSON.parse(lstHD);
        if (self.IDPhongBan_Chosing() !== undefined) {
            for (let i = 0; i < lstHD.length; i++) {
                if (lstHD[i].IDRandom === self.DichVu_isDoing().IDRandomHD) {
                    lstHD[i].ID_ViTri = self.IDPhongBan_Chosing();
                    lstHD[i].CreateTime = FormatDatetime_AMPM(new Date());
                    break;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(lstHD));
        }
        if (loaiHD === 6) {
            Bind_CTHĐoiTra_afterHideColumn();
        }
        else {
            BindCTHD_byIDRandomHD(self.DichVu_isDoing().IDRandomHD);
        }
        HideShow_Icon_ChietKhauNV();
    }

    // update ChietKhauNV, TongPhiDV (addLot: khong can update vi khong co icon nhap chiet khau)
    function UpdateChietKhauNV_inCTHD(idRandom, isDoiTra = false, ctDoing = null) {
        if (ctDoing !== null) {
            let quanlytheolo = ctDoing.QuanLyTheoLoHang;
            let concungloai = ctDoing.LaConCungLoai;
            let lotParent = ctDoing.LotParent;

            let nameCache = lcListCTHD;
            if (isDoiTra) {
                nameCache = lcListCTHD_DoiTra;
            }
            var cthd = localStorage.getItem(nameCache);
            if (cthd !== null) {
                cthd = JSON.parse(cthd);
                if (lotParent || (concungloai === false && quanlytheolo === false)) {
                    for (let i = 0; i < cthd.length; i++) {
                        let forOut = cthd[i];
                        if (forOut.IDRandom === idRandom) {
                            if (forOut.BH_NhanVienThucHien.length > 0) {

                                let tongPhiDV = forOut.TongPhiDichVu;
                                if (forOut.LoaiHoaDon === 19) {
                                    tongPhiDV = 0;
                                }

                                let gtriTinh = 0;
                                if (forOut.HoaHongTruocChietKhau === 1) {
                                    gtriTinh = forOut.GiaBan * forOut.SoLuong;
                                }
                                else {
                                    gtriTinh = (forOut.GiaBan - forOut.TienChietKhau) * forOut.SoLuong;
                                }
                                gtriTinh = gtriTinh - tongPhiDV;
                                gtriTinh = gtriTinh < 0 ? 0 : gtriTinh;

                                for (let j = 0; j < forOut.BH_NhanVienThucHien.length; j++) {
                                    let forIn = forOut.BH_NhanVienThucHien[j];
                                    let tienCKNew = forIn.ChietKhauMacDinh * forOut.SoLuong * forIn.HeSo;
                                    if (forIn.PT_ChietKhau > 0) {
                                        tienCKNew = gtriTinh * forIn.PT_ChietKhau / 100 * forIn.HeSo;
                                    }
                                    cthd[i].BH_NhanVienThucHien[j].TienChietKhau = tienCKNew;
                                }

                                cthd[i] = CTHD_GetGhiChu_NVTuVanTH(cthd[i]);
                                if (lotParent) {
                                    cthd[i].DM_LoHang[0].BH_NhanVienThucHien = cthd[i].BH_NhanVienThucHien;
                                }
                            }
                            break;
                        }
                    }
                }
                else {
                    if (quanlytheolo) {
                        for (let i = 0; i < cthd.length; i++) {
                            let forOut = cthd[i];
                            for (let j = 0; j < forOut.DM_LoHang.length; j++) {
                                let forIn = forOut.DM_LoHang[j];
                                if (forIn.IDRandom === idRandom) {
                                    if (forIn.BH_NhanVienThucHien.length > 0) {
                                        let gtriTinh = 0;
                                        if (forIn.HoaHongTruocChietKhau === 1) {
                                            gtriTinh = forIn.GiaBan * forIn.SoLuong;
                                        }
                                        else {
                                            gtriTinh = (forIn.GiaBan - forIn.TienChietKhau) * forIn.SoLuong;
                                        }
                                        gtriTinh = gtriTinh - forIn.TongPhiDichVu;
                                        gtriTinh = gtriTinh < 0 ? 0 : gtriTinh;

                                        for (let k = 0; k < forIn.BH_NhanVienThucHien.length; k++) {
                                            let for3 = forIn.BH_NhanVienThucHien[k];
                                            let tienCKNew = for3.ChietKhauMacDinh * forIn.SoLuong * for3.HeSo;
                                            if (for3.PT_ChietKhau > 0) {
                                                tienCKNew = gtriTinh * for3.PT_ChietKhau / 100 * for3.HeSo;
                                            }
                                            cthd[i].DM_LoHang[j].BH_NhanVienThucHien[k].TienChietKhau = tienCKNew;
                                        }
                                        cthd[i].DM_LoHang[j] = CTHD_GetGhiChu_NVTuVanTH(cthd[i].DM_LoHang[j]);
                                    }
                                    forIn = CTHD_GetGhiChu_NVTuVanTH(forIn);
                                    break;
                                }
                            }
                        }
                    }
                    else {
                        for (let i = 0; i < cthd.length; i++) {
                            let forOut = cthd[i];
                            for (let j = 0; j < forOut.HangCungLoais.length; j++) {
                                let forIn = forOut.HangCungLoais[j];
                                if (forIn.IDRandom === idRandom) {
                                    if (forIn.BH_NhanVienThucHien.length > 0) {
                                        let gtriTinh = 0;
                                        if (forIn.HoaHongTruocChietKhau === 1) {
                                            gtriTinh = forIn.GiaBan * forIn.SoLuong;
                                        }
                                        else {
                                            gtriTinh = (forIn.GiaBan - forIn.TienChietKhau) * forIn.SoLuong;
                                        }
                                        gtriTinh = gtriTinh - forIn.TongPhiDichVu;
                                        gtriTinh = gtriTinh < 0 ? 0 : gtriTinh;

                                        for (let k = 0; k < forIn.BH_NhanVienThucHien.length; k++) {
                                            let for3 = forIn.BH_NhanVienThucHien[k];
                                            let tienCKNew = for3.ChietKhauMacDinh * forIn.SoLuong * for3.HeSo;
                                            if (for3.PT_ChietKhau > 0) {
                                                tienCKNew = gtriTinh * for3.PT_ChietKhau / 100 * for3.HeSo;
                                            }
                                            cthd[i].HangCungLoais[j].BH_NhanVienThucHien[k].TienChietKhau = tienCKNew;
                                        }
                                        forIn = CTHD_GetGhiChu_NVTuVanTH(forIn);
                                    }
                                    break;
                                }
                            }
                        }
                    }
                }
                localStorage.setItem(nameCache, JSON.stringify(cthd));
            }
        }
    }

    function CTHD_GetGhiChu_NVTuVanTH(ctDoing) {
        let nvTH = '';
        let nvTH_Print = '';
        let nvTV = '';
        let nvTV_Print = '';
        for (let j = 0; j < ctDoing.BH_NhanVienThucHien.length; j++) {
            let itemNV = ctDoing.BH_NhanVienThucHien[j];
            let dvtCK = ' đ';
            let valCK = formatNumber3Digit(itemNV.TienChietKhau);
            if (itemNV.PT_ChietKhau > 0) {
                dvtCK = ' %';
                valCK = itemNV.PT_ChietKhau;
            }
            switch (itemNV.TacVu) {
                case 1:
                case 3:
                    nvTH += itemNV.TenNhanVien + ' (' + valCK + dvtCK + '), ';
                    nvTH_Print += itemNV.TenNhanVien + ', ';
                    break;
                case 2:
                case 4:
                    nvTV += itemNV.TenNhanVien + ' (' + valCK + dvtCK + '), ';
                    nvTV_Print += itemNV.TenNhanVien + ', ';
                    break;
            }
        }
        if (nvTH !== '') {
            ctDoing.GhiChu_NVThucHien = 'Thực hiện: ' + Remove_LastComma(nvTH);
            ctDoing.GhiChu_NVThucHienPrint = Remove_LastComma(nvTH_Print);
        }
        if (nvTV !== '') {
            ctDoing.GhiChu_NVTuVan = 'Tư vấn: ' + Remove_LastComma(nvTV);
            ctDoing.GhiChu_NVTuVanPrint = Remove_LastComma(nvTV_Print);
        }
        return ctDoing;
    }
    // hide/show icon ChietKhau and icon change TPDinhLuong
    function HideShow_Icon_ChietKhauNV() {
        // show icon chietkhau nhan vien all nganh nghe kinh doanh
        var loaiHD = GetLoaiHoaDon_ofHDopening();
        switch (loaiHD) {
            case 1:
                $('.icon-user-blue').show();
                $('.icon-user-blue1').css('display', 'none');
                // show icon change TPDinhLuomg
                //$('.i-con-ban-hang .fa-list-alt').show();
                break;
            case 3:
                $('.icon-user-blue ,.icon-user-blue1').css('display', 'none');
                // hide icon change TPDinhLuomg
                //$('.i-con-ban-hang .fa-list-alt').hide();
                break;
            case 6:
                $('#CTHDView .icon-user-blue,.icon-user-blue1').css('display', 'none');
                $('#TraHangView .icon-user-blue1').css('display', 'none');
                $('#TraHangView .icon-user-blue').show();// doi tra show icon
                //$('#CTHDView .i-con-ban-hang .fa-list-alt').hide();
                //$('#TraHangView .i-con-ban-hang .fa-list-alt').show();
                break;
            case 19:
                // tra goi, mua goi (return loai 19)
                $('.icon-user-blue1').show();
                $('.icon-user-blue').css('display', 'none');
                //$('.i-con-ban-hang .fa-list-alt').hide();
                if (_maHoaDon === '') {
                    _maHoaDon = $('.gara-bill-label  li.active font').text();
                }
                break;
            default:
                break;
        }
    }

    self.GotoHome = function () {
        window.open('/#/DashBoard', '_blank');
    }
    self.clickGoiDichVu = function () {
        ChangeLoaiHD_CheckHasKhuyenMai_orUsingService(19);
        UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();
    }
    self.ChangeNgayApDung_GoiDV = function () {
        if (_maHoaDon === '') {
            _maHoaDon = $('.gara-bill-label  li.active font').text();
        }
        var dtchange = $('#dtNgayApDungGoiDV').val();
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            for (let i = 0; i < lstHD.length; i++) {
                if (lstHD[i].MaHoaDon === _maHoaDon && lstHD[i].NguoiTao === userLogin) {
                    lstHD[i].NgayApDungGoiDV = dtchange;
                    break;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(lstHD));
        }
    }
    self.ChangeNgayHetHan_GoiDV = function () {
        if (_maHoaDon === '') {
            _maHoaDon = $('.gara-bill-label  li.active font').text();
        }
        var dtchange = $('#dtNgayHetHanGoiDV').val();
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            for (let i = 0; i < lstHD.length; i++) {
                if (lstHD[i].MaHoaDon === _maHoaDon && lstHD[i].NguoiTao === userLogin) {
                    lstHD[i].HanSuDungGoiDV = dtchange;
                    break;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(lstHD));
        }
    }
    self.Chose_Service = function (itemChose, soluong = 1) {
        if (_maHoaDon.indexOf('O') === -1) {
            self.ItemHH_LoChosing(itemChose);
            if (_maHoaDon === '') {
                _maHoaDon = $('.gara-bill-label li.active font').text();
            }
            var idQuiDoi = itemChose.ID_DonViQuiDoi;
            var addHang = false;
            if (self.IsNhapNhanh() === true) {
                addHang = true;
                $('#txtSearchHH').focus();
                $('#txtSearchHH').select();
            }
            else {
                if (isNhapSoLuong) {
                    addHang = true;
                }
                // nhap thuong -> focus txtSoLuong
                $('#txtSoLuong').focus();
                $('#txtSoLuong').val(1);
                $('#txtSoLuong').select();
            }
            if (addHang) {
                var lstHoaDon = localStorage.getItem(lcListHD);
                if (lstHoaDon === null) {
                    lstHoaDon = [];
                }
                else {
                    lstHoaDon = JSON.parse(lstHoaDon);
                }
                var loaiHD = GetLoaiHoaDon_ofHDopening();
                if (loaiHD !== 1) {
                    var max = GetMax_MaHoaDon(1, lstHoaDon);
                    _maHoaDon = nameHD_InsertBH + (max + 1);
                }
                var itemEx = GetHDOpening_byMaHoaDon(_maHoaDon, lstHoaDon);
                if (itemEx.length === 0) {
                    let newObj = newHoaDon(25, (max + 1));
                    newObj.ID_Xe = itemChose.ID_Xe;
                    newObj.BienSo = itemChose.BienSo;
                    newObj.ID_DoiTuong = self.HoaDons().ID_DoiTuong();
                    newObj.MaPhieuTiepNhan = self.HoaDons().MaPhieuTiepNhan();
                    newObj.ID_PhieuTiepNhan = self.HoaDons().ID_PhieuTiepNhan();
                    lstHoaDon.push(newObj);
                    localStorage.setItem(lcListHD, JSON.stringify(lstHoaDon));

                    let param = {
                        LstIDChiNhanh: [id_DonVi],
                        TextSearch: itemChose.BienSo,
                        ID_HangXe: self.HoaDons().ID_DoiTuong()
                    }

                    ajaxHelper(GaraAPI + "JqAuto_PhieuTiepNhan", 'POST', param).done(function (x) {
                        if (x.res && x.dataSoure.length > 0) {
                            let ptn0 = x.dataSoure[0];
                            for (let i = 0; i < lstHoaDon.length; i++) {
                                if (lstHoaDon[i].IDRandom === newObj.IDRandom) {
                                    lstHoaDon[i].ID_PhieuTiepNhan = ptn0.ID;
                                    lstHoaDon[i].ID_BaoHiem = ptn0.ID_BaoHiem;
                                    lstHoaDon[i].TenBaoHiem = ptn0.TenBaoHiem;
                                    lstHoaDon[i].LienHeBaoHiem = ptn0.NguoiLienHeBH;
                                    lstHoaDon[i].SoDienThoaiLienHeBaoHiem = ptn0.SoDienThoaiLienHeBH;
                                    lstHoaDon[i].MaPhieuTiepNhan = ptn0.MaPhieuTiepNhan.concat('_', ptn0.BienSo);
                                    break;
                                }
                            }
                            localStorage.setItem(lcListHD, JSON.stringify(lstHoaDon));
                        }
                        DoAction();
                    })
                }
                else {
                    // update idxe, bienso
                    if (commonStatisJs.CheckNull(itemEx[0].ID_Xe)) {
                        for (let i = 0; i < lstHoaDon.length; i++) {
                            if (lstHoaDon[i].IDRandom === itemEx[0].IDRandom) {
                                lstHoaDon[i].ID_Xe = itemChose.ID_Xe;
                                lstHoaDon[i].BienSo = itemChose.BienSo;
                                break;
                            }
                        }
                        localStorage.setItem(lcListHD, JSON.stringify(lstHoaDon));
                    }
                    DoAction();
                }

                function DoAction() {

                    // find itemHD with _maHoaDon
                    var itemHD = GetHDOpening_byMaHoaDon(_maHoaDon, lstHoaDon);
                    var idRandomHD = itemHD[0].IDRandom;
                    var idChiTietGoiDV = itemChose.ID_ChiTietGoiDV;
                    var tpComBo = itemChose.ThanhPhanComBo;
                    if (commonStatisJs.CheckNull(tpComBo)) {
                        tpComBo = [];
                    }

                    itemChose.SoLuong = soluong;
                    itemChose.LaDonViChuan = true;
                    itemChose.TyLeChuyenDoi = 1;
                    itemChose.ThuocTinh_GiaTri = '';
                    var ob1 = newHangHoa(itemChose, itemHD[0], false);
                    ob1.ChatLieu = '4';
                    ob1.TienChietKhau = itemChose.TienChietKhau;
                    ob1.PTChietKhau = itemChose.PTChietKhau;
                    ob1.PTThue = 0;
                    ob1.TienThue = 0;
                    ob1.DonGiaBaoHiem = 0;
                    ob1.ThanhTien = 0;
                    ob1.ThanhToan = 0;
                    ob1.ThanhPhanComBo = tpComBo;
                    if (!commonStatisJs.CheckNull(itemChose.ThanhPhan_DinhLuong)) {
                        ob1.ThanhPhan_DinhLuong = itemChose.ThanhPhan_DinhLuong;
                    }

                    var idRandom = ob1.IDRandom;
                    var soluongnew = soluong;

                    var typeFind = 0;// 0. not exists, 1. exist in lstCT, 2. exist in HangCungLoai, 3.same ID_QuiDoi, but not exist in HangCungLoai, 4. exist in DM_Lo

                    var cthd = localStorage.getItem(lcListCTHD);
                    if (cthd === null) {
                        cthd = [];
                        cthd.push(ob1);
                    }
                    else {
                        cthd = JSON.parse(cthd);
                        for (let i = 0; i < cthd.length; i++) {
                            if (cthd[i].IDRandomHD === idRandomHD && cthd[i].ID_DonViQuiDoi === idQuiDoi
                            ) {
                                idRandom = cthd[i].IDRandom;
                                if (cthd[i].ID_ChiTietGoiDV === idChiTietGoiDV) {
                                    typeFind = 1;
                                    soluongnew = parseFloat(cthd[i].SoLuong) + 1;
                                    cthd[i].SoLuong = soluongnew;
                                    if (ob1.LaPTPhiDichVu) {
                                        cthd[i].TongPhiDichVu =ob1.PhiDichVu * soluongnew * cthd[i].DonGia / 100;
                                    }
                                    else {
                                        cthd[i].TongPhiDichVu = ob1.PhiDichVu * soluongnew;
                                    }
                                }
                                else {
                                    typeFind = 3;
                                    if (cthd[i].QuanLyTheoLoHang) {
                                        for (let j = 0; j < cthd[i].DM_LoHang.length; j++) {
                                            let forIn = cthd[i].DM_LoHang[j];
                                            if (forIn.ID_ChiTietGoiDV === idChiTietGoiDV) {
                                                idRandom = forIn.IDRandom;
                                                typeFind = 2;
                                                soluongnew = parseFloat(forIn.SoLuong) + 1;
                                                cthd[i].DM_LoHang[j].SoLuong = soluongnew;
                                                if (ob1.LaPTPhiDichVu) {
                                                    cthd[i].DM_LoHang[j].TongPhiDichVu = Math.round(ob1.PhiDichVu * soluongnew * forIn.DonGia / 100);
                                                }
                                                else {
                                                    cthd[i].DM_LoHang[j].TongPhiDichVu = ob1.PhiDichVu * soluongnew;
                                                }
                                                break;
                                            }
                                        }
                                    }
                                    else {
                                        for (let j = 0; j < cthd[i].HangCungLoais.length; j++) {
                                            let cungloai = cthd[i].HangCungLoais[j];
                                            if (cungloai.ID_ChiTietGoiDV === idChiTietGoiDV) {
                                                idRandom = cungloai.IDRandom;
                                                typeFind = 2;
                                                soluongnew = parseFloat(cungloai.SoLuong) + 1;
                                                cthd[i].HangCungLoais[j].SoLuong = soluongnew;
                                                if (ob1.LaPTPhiDichVu) {
                                                    cthd[i].HangCungLoais[j].TongPhiDichVu = Math.round(ob1.PhiDichVu * soluongnew * cungloai.DonGia / 100);
                                                }
                                                else {
                                                    cthd[i].HangCungLoais[j].TongPhiDichVu = ob1.PhiDichVu * soluongnew;
                                                }
                                                break;
                                            }
                                        }
                                    }

                                    if (typeFind === 3) {
                                        if (cthd[i].QuanLyTheoLoHang) {
                                            ob1.LotParent = false;
                                            cthd[i].DM_LoHang.push(ob1);
                                        }
                                        else {
                                            ob1.LaConCungLoai = true;
                                            cthd[i].HangCungLoais.push(ob1);
                                        }
                                    }
                                }
                                break;
                            }
                        }
                        if (typeFind === 0) {
                            if (ob1.QuanLyTheoLoHang) {
                                let objLot = $.extend({}, ob1);
                                objLot.ListDonViTinh = [];
                                objLot.HangCungLoais = [];
                                objLot.DM_LoHang = [];
                                objLot.ThanhPhan_DinhLuong = [];
                                objLot.BH_NhanVienThucHien = [];
                                ob1.DM_LoHang.push(objLot);
                            }
                            cthd.unshift(ob1);
                        }
                    }
                    localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
                    UpdateSoThuTu_CTHD_DichVu(false, idRandomHD);
                    UpdateChietKhauNV_inCTHD(idRandom, false, ob1);
                    if (ob1.ThanhPhanComBo.length > 0) {
                        ChangeSoLuongParent_UpdateCombo(idRandom, soluongnew, false);
                    }
                    Caculator_AmountProduct();
                    if (itemHD[0].LoaiHoaDon !== 6) {
                        UpdateCacheHDLe(idRandomHD, false);
                        UpdateDiemGiaoDich_andResetDiemQuyDoi_forHoaDon();
                        UpdateSoLuong_TPDinhLuong_ofCTHD(idRandomHD, idRandom, soluongnew, false);
                    }
                    BindHD_byIDRandom(idRandomHD);
                    HideShow_Icon_ChietKhauNV();

                    GetCurrentPage_byMaHoaDon(_maHoaDon);
                    BindCTHD_byIDRandomHD(self.HoaDons().IDRandom());
                }
            }
        }
    }
    function UpdateSoThuTu_CTHD_DichVu(isCTDoiTra, idRandomHD) {
        var locaStoreName = lcListCTHD;
        if (isCTDoiTra) {
            locaStoreName = lcListCTHD_DoiTra;
        }
        var cthd = localStorage.getItem(locaStoreName);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            // get arrHD with MaHoaDon
            var arrHD = $.grep(cthd, function (item) {
                return item.IDRandomHD === idRandomHD;
            });
            // update again SoThuTu for CTHD with MaHoaDon
            var stt = 1;
            for (let i = arrHD.length - 1; i >= 0; i--) {
                arrHD[i].SoThuTu = stt;
                stt = stt + 1;
            }
            for (let i = cthd.length - 1; i >= 0; i--) {
                if (cthd[i].IDRandomHD === idRandomHD) {
                    for (let j = 0; j < arrHD.length; j++) {
                        if (cthd[i].ID_DonViQuiDoi === arrHD[j].ID_DonViQuiDoi && cthd[i].ID_ChiTietGoiDV === arrHD[j].ID_ChiTietGoiDV) {
                            cthd[i].SoThuTu = arrHD[j].SoThuTu;
                            break;
                        }
                    }
                }
            }
            localStorage.setItem(locaStoreName, JSON.stringify(cthd));
        }
    }

    // goibaoduong
    self.TongGoiDV = ko.observable(0);
    self.ShowPopListDiary_ofCustomer = function () {
        var hd = localStorage.getItem(lcListHD);
        if (hd !== null) {
            hd = JSON.parse(hd);
            var hdOpen = GetHDOpening_byIDRandom(self.HoaDons().IDRandom(), hd);
            if (hdOpen.length > 0) {
                let idCus = hdOpen[0].ID_DoiTuong;
                let idCar = hdOpen[0].ID_Xe;
                vmNKGoiBaoDuong.ID_DonVi = id_DonVi;
                vmNKGoiBaoDuong.showModal(idCus, idCar, 1);
            }
        }
    }

    $('#vmNKGoiBaoDuong').on('hidden.bs.modal', function () {
        if (vmNKGoiBaoDuong.saveOK) {

            var arrID = vmNKGoiBaoDuong.ListDichVuChosed.map(function (x) {
                return x.ID_ChiTietGoiDV
            })
            // check SoLuongConLai
            var sError = '';
            for (let i = 0; i < vmNKGoiBaoDuong.ListDichVuChosed.length; i++) {
                let itFor = vmNKGoiBaoDuong.ListDichVuChosed[i];
                if ($.inArray(itFor.ID_ChiTietGoiDV, arrID) > -1) {
                    if (itFor.SoLuongConLai <= 0) {
                        sError += ' "' + itFor.TenHangHoa + '" thuộc gói ' + itFor.MaHoaDon;
                    }
                }
            }
            if (sError !== '') {
                ShowMessage_Danger(sError + ' đã dùng hết số buổi');
                return false;
            }

            var cthd = localStorage.getItem(lcListCTHD);
            if (cthd !== null) {
                cthd = JSON.parse(cthd);
            }
            else {
                cthd = [];
            }

            // only check hoadon of current userlogin
            let hd = localStorage.getItem(lcListHD);
            if (hd !== null) {
                hd = JSON.parse(hd);
            }
            else {
                hd = [];
            }

            let hdbyUser = $.grep(hd, function (x) {
                return x.NguoiTao === userLogin;
            }).map(function (x) {
                return x.IDRandom;
            });

            cthd = $.grep(cthd, function (x) {
                return $.inArray(x.IDRandomHD, hdbyUser) > -1;
            })

            // check enough soluong in cthd
            for (let i = 0; i < vmNKGoiBaoDuong.ListDichVuChosed.length; i++) {
                let itFor = vmNKGoiBaoDuong.ListDichVuChosed[i];
                if ($.inArray(itFor.ID_ChiTietGoiDV, arrID) > -1) {
                    let itemCT = $.grep(cthd, function (x) {
                        return x.ID_ChiTietGoiDV === itFor.ID_ChiTietGoiDV;
                    });
                    if (itemCT.length > 0) {
                        let soluong = 0;
                        for (let k = 0; k < itemCT.length; k++) {
                            soluong += formatNumberToFloat(itemCT[k].SoLuong);
                        }
                        if (soluong + 1 > itFor.SoLuongConLai) {
                            ShowMessage_Danger('Dịch vụ "' + itFor.TenHangHoa + '" đã chọn đủ số buổi dùng');
                            return false;
                        }
                    }
                    itFor.DonViTinh = [];
                    self.Chose_Service(itFor, itFor.SoLuongConLai < 1 ? itFor.SoLuongConLai : 1, true);
                }
            }
        }
    })

    function Check_Enought_SoLuongConLai_ServicePackage(ctDoing, soluongNew) {
        if (!commonStatisJs.CheckNull(ctDoing.ID_ChiTietGoiDV)) {
            for (let i = 0; i < vmNKGoiBaoDuong.listData.GoiDichVu.length; i++) {
                let for1 = vmNKGoiBaoDuong.listData.GoiDichVu[i];
                for (let j = 0; j < for1.lstDetail.length; j++) {
                    let for2 = for1.lstDetail[j];
                    for (let k = 0; k < for2.ComBo.length; k++) {
                        let for3 = for2.ComBo[k];
                        if (ctDoing.ID_ChiTietGoiDV === for3.ID_ChiTietGoiDV) {
                            if (for3.SoLuongConLai < soluongNew) {
                                return 'Dịch vụ "' + ctDoing.TenHangHoa + '" nhập quá số lượng cho phép là ' + for3.SoLuongConLai;
                            }
                        }
                    }
                }
            }
        }
        return '';
    }

    PageLoad();

    // quy cach
    function Check_IsShowQuyCach(loaiHD) {
        var isShowQuyCach = false;
        var lcSetPrint = localStorage.getItem(lcSetPrintConst);
        if (lcSetPrint !== null) {
            lcSetPrint = JSON.parse(lcSetPrint);
            for (let i = 0; i < lcSetPrint.length; i++) {
                if (lcSetPrint[i].LoaiHoaDon === loaiHD) {
                    isShowQuyCach = lcSetPrint[i].ShowEditQuyCach;
                    break;
                }
            }
        }
        return isShowQuyCach;
    }
    self.ShowDivNhapQuyCach = function (item, isDoiTra) {
        var thisObj = event.currentTarget;
        var objDiv = $(thisObj).parent().next('.call-quy-cach');
        var nameCache = lcListCTHD;
        if (isDoiTra) {
            nameCache = lcListCTHD_DoiTra;
        }
        var ctDoing = FindCTHD_isDoing(item, isDoiTra);
        var soluongQuyCach = ctDoing.SoLuongQuyCach;
        objDiv.toggle();
        objDiv.find('input').val(formatNumber3Digit(soluongQuyCach));
        objDiv.find('input').focus().select();
    }
    function EditQuyCach_UpdateSoLuong(itemCT, isDoiTra, soluongQuyCach, soluong, thanhtien) {
        var cacheName = lcListCTHD;
        if (isDoiTra) {
            cacheName = lcListCTHD_DoiTra;
        }
        var idRandom = itemCT.IDRandom;
        var quanlytheolo = itemCT.QuanLyTheoLoHang;
        var cthd = localStorage.getItem(cacheName);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            if (itemCT.LotParent || (itemCT.LaConCungLoai === false && quanlytheolo === false)) {
                for (let i = 0; i < cthd.length; i++) {
                    if (cthd[i].IDRandom === idRandom) {
                        cthd[i].SoLuongQuyCach = soluongQuyCach;
                        cthd[i].SoLuong = soluong;
                        // use goidv --> not update ThanhTien
                        if (cthd[i].ChatLieu !== '4') {
                            cthd[i].ThanhTien = thanhtien;
                        }
                        break;
                    }
                }
            }
            else {
                if (quanlytheolo) {
                    for (let i = 0; i < cthd.length; i++) {
                        for (let j = 0; j < cthd[i].DM_LoHang.length; j++) {
                            if (cthd[i].DM_LoHang[j].IDRandom === idRandom) {
                                cthd[i].DM_LoHang[j].SoLuongQuyCach = soluongQuyCach;
                                cthd[i].DM_LoHang[j].SoLuong = soluong;
                                if (cthd[i].DM_LoHang[j].ChatLieu !== '4') {
                                    cthd[i].DM_LoHang[j].ThanhTien = thanhtien;
                                }
                                i = cthd.length;  // esc for loop
                                break;
                            }
                        }
                    }
                }
                else {
                    for (let i = 0; i < cthd.length; i++) {
                        for (let j = 0; j < cthd[i].HangCungLoais.length; j++) {
                            if (cthd[i].HangCungLoais[j].IDRandom === idRandom) {
                                cthd[i].HangCungLoais[j].SoLuongQuyCach = soluongQuyCach;
                                cthd[i].HangCungLoais[j].SoLuong = soluong;
                                if (cthd[i].HangCungLoais[j].ChatLieu !== '4') {
                                    cthd[i].HangCungLoais[j].ThanhTien = thanhtien;
                                }
                                i = cthd.length;
                                break;
                            }
                        }
                    }
                }
            }
            localStorage.setItem(cacheName, JSON.stringify(cthd));
        }
    }
    function ChangeSoLuong_UpdateSLQuyCach(itemCT, isDoiTra, quycach, soluong) {
        var cacheName = lcListCTHD;
        if (isDoiTra) {
            cacheName = lcListCTHD_DoiTra;
        }
        var idRandom = itemCT.IDRandom;
        var quanlytheolo = itemCT.QuanLyTheoLoHang;
        var slQuyCach = soluong * quycach;

        var cthd = localStorage.getItem(cacheName);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            if (itemCT.LotParent || (itemCT.LaConCungLoai === false && quanlytheolo === false)) {
                for (let i = 0; i < cthd.length; i++) {
                    if (cthd[i].IDRandom === idRandom) {
                        if (parseFloat(cthd[i].SoLuongQuyCach) !== 0) {
                            // chi update SoLuongQuycach neu truoc do da nhap SoLuongQuyCach (tuc SoLuongQuyCach!=0)
                            cthd[i].SoLuongQuyCach = slQuyCach;
                        }
                        break;
                    }
                }
            }
            else {
                if (quanlytheolo) {
                    for (let i = 0; i < cthd.length; i++) {
                        for (let j = 0; j < cthd[i].DM_LoHang.length; j++) {
                            if (cthd[i].DM_LoHang[j].IDRandom === idRandom) {
                                if (parseFloat(cthd[i].DM_LoHang[j].SoLuongQuyCach) !== 0) {
                                    cthd[i].DM_LoHang[j].SoLuongQuyCach = slQuyCach;
                                }
                                i = cthd.length;  // esc for loop
                                break;
                            }
                        }
                    }
                }
                else {
                    for (let i = 0; i < cthd.length; i++) {
                        for (let j = 0; j < cthd[i].HangCungLoais.length; j++) {
                            if (cthd[i].HangCungLoais[j].IDRandom === idRandom) {
                                if (parseFloat(cthd[i].HangCungLoais[j].SoLuongQuyCach) !== 0) {
                                    cthd[i].HangCungLoais[j].SoLuongQuyCach = slQuyCach;
                                }
                                i = cthd.length;
                                break;
                            }
                        }
                    }
                }
            }
            localStorage.setItem(cacheName, JSON.stringify(cthd));
        }
    }
    function UpdateSoLuong_TPDinhLuong_ofCTHD(idRandomHD, idRandom, soluong, isDoiTra) {
        var cacheName = lcListCTHD;
        if (isDoiTra) {
            cacheName = lcListCTHD_DoiTra;
        }
        var cthd = localStorage.getItem(cacheName);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            for (let i = 0; i < cthd.length; i++) {
                let forOut = cthd[i];
                if (cthd[i].IDRandomHD === idRandomHD) {
                    if (forOut.IDRandom === idRandom) {
                        for (let j = 0; j < forOut.ThanhPhan_DinhLuong.length; j++) {
                            let itemTP = forOut.ThanhPhan_DinhLuong[j];
                            let soluongAfter = itemTP.SoLuongMacDinh * soluong;
                            cthd[i].ThanhPhan_DinhLuong[j].SoLuong = soluongAfter;
                            cthd[i].ThanhPhan_DinhLuong[j].SoLuongQuyCach = soluongAfter * itemTP.QuyCach;
                            cthd[i].ThanhPhan_DinhLuong[j].GiaVonAfter = soluongAfter * itemTP.GiaVon;
                        }
                        break;
                    }
                    else {
                        // update TPDinhLuong for hangcungloai
                        if (forOut.HangCungLoais.length > 0) {
                            for (let j = 0; j < forOut.HangCungLoais.length; j++) {
                                if (forOut.HangCungLoais[j].IDRandom === idRandom) {
                                    for (let k = 0; k < forOut.HangCungLoais[j].ThanhPhan_DinhLuong.length; k++) {
                                        let itemTP = forOut.HangCungLoais[j].ThanhPhan_DinhLuong[k];
                                        let soluongAfter = itemTP.SoLuongMacDinh * soluong;
                                        cthd[i].HangCungLoais[j].ThanhPhan_DinhLuong[k].SoLuong = soluongAfter;
                                        cthd[i].HangCungLoais[j].ThanhPhan_DinhLuong[k].SoLuongQuyCach = soluongAfter * itemTP.QuyCach;
                                        cthd[i].HangCungLoais[j].ThanhPhan_DinhLuong[k].GiaVonAfter = soluongAfter * itemTP.GiaVon;
                                    }
                                    break;
                                }
                            }
                        }
                    }
                }
            }
            localStorage.setItem(cacheName, JSON.stringify(cthd));
        }
    }

    self.MouseOutQuyCach = function (item, isDoiTra) {
        var idRandom = item.IDRandom;
        var soluong = 1;
        // find CTHD 
        var cthd = localStorage.getItem(lcListCTHD);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            var ctDoing = FindCTHD_isDoing(item, isDoiTra);
            soluong = ctDoing.SoLuong;
        }
        if (soluong < 0.001) {
            //ShowMessage_Danger('Số lượng sản phẩm quá nhỏ');
            $('#WrQuycach_' + idRandom).show();
            $('#contentWrQuycach_' + idRandom).show().delay(3000).hide('slow');
            // reset SoLuongQuyCach, SoLuong, ThanhTien = 0 for CTHD
            EditQuyCach_UpdateSoLuong(item, isDoiTra, 0, 0, 0)
        }
        else {
            $('#WrQuycach_' + idRandom).hide();
        }
    }
    self.ShowContentWr_QuyCach = function (item) {
        var idRandom = item.IDRandom;
        $('#contentWrQuycach_' + idRandom).show().delay(2000).hide('slow');
    }
    function GetListPrinterInstalled() {
        ajaxHelper(BHHoaDonUri + 'GetListPrinterInstalled', 'GET').done(function (data) {
            if (data !== null) {
                console.log(data);
            }
        })
    }
    //GetListPrinterInstalled();
    function GetListIDNhanVien_byUserLogin(funcName) {
        ajaxHelper('/api/DanhMuc/ChamSocKhachHangAPI/' + 'GetListNhanVienLienQuanByIDLoGin_inDepartment?idnvlogin=' + const_GuidEmpty
            + '&idChiNhanh=' + id_DonVi + '&funcName=' + funcName, 'GET').done(function (data) {
                self.ListIDNhanVienQuyen(data);
                switch (funcName) {
                    case 'DatHang':
                        SearchHoaDonDatHang();
                        break;
                };
            })
    }
    function UpdateAppCache() {
        ajaxHelper(BHHoaDonUri + 'UpdateAppcache', 'POST').done(function () {
            console.log('UpdateAppcache susscess');
        })
    }
    function getMin_ArryJson(arr, prop) {
        var min;
        for (let i = 0; i < arr.length; i++) {
            if (!min || parseInt(arr[i][prop]) < parseInt(min[prop]))
                min = arr[i];
        }
        return min;
    };
    function getMax_ArryJson(arr, prop) {
        var max;
        for (let i = 0; i < arr.length; i++) {
            if (!max || parseInt(arr[i][prop]) < parseInt(max[prop]))
                max = arr[i];
        }
        return max;
    };
    function BindTime_inSoDoPhong(isChangeVT) {
        self.Doing_ChangeVTCTHD(isChangeVT);
        // assign infor CreateTime, NhanVien at tab location
        var arrID_ViTri = [];
        var cthd = localStorage.getItem(lcListCTHD);
        var lenTable = self.PhongBans_byIDNhom().length;
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            // get cthd have ID_ViTri
            var arrHaveVT = [];
            for (let i = 0, k = cthd.length; i < k; i++) {
                if (cthd[i].ID_ViTri !== null) {
                    arrHaveVT.push(cthd[i]);
                }
                // find in HangCungLoai
                for (let j = 0; j < cthd[i].HangCungLoais.length; j++) {
                    if (cthd[i].HangCungLoais[j].ID_ViTri !== null) {
                        arrHaveVT.push(cthd[i].HangCungLoais[j]);
                    }
                }
                // find in DMLoHang
                for (let j = 0; j < cthd[i].DM_LoHang.length; j++) {
                    if (cthd[i].DM_LoHang[j].ID_ViTri !== null) {
                        arrHaveVT.push(cthd[i].DM_LoHang[j]);
                    }
                }
            }
            // get cthd TimeStart !== 0;
            var cthd_Start = $.grep(arrHaveVT, function (x) {
                return x.TimeStart !== 0;
            });
            if (cthd_Start.length > 0) {
                for (let j = 0; j < lenTable; j++) {
                    var sameVT = $.grep(cthd_Start, function (x) {
                        return x.ID_ViTri === self.PhongBans_byIDNhom()[j].ID;
                    });
                    if (sameVT.length > 0) {
                        var totalTime = 0;
                        var timeRemain = 0;
                        for (let i = 0; i < sameVT.length; i++) {
                            totalTime += sameVT[i].ThoiGianThucHien;
                            timeRemain += sameVT[i].TimeRemain;
                        }
                        var timeMin = getMin_ArryJson(sameVT, 'TimeStart').TimeStart;
                        self.PhongBans_byIDNhom()[j].CreateTime = ConvertTimeFrom24To12(timeMin);
                        self.PhongBans_byIDNhom()[j].ThoiGianThucHien = totalTime;
                        self.PhongBans_byIDNhom()[j].TextTGConLai = timeRemain;
                        arrID_ViTri.push(self.PhongBans_byIDNhom()[j].ID);
                    }
                }
            }
            // only get table chua dc gan ViTri
            var cthd_noStart = $.grep(arrHaveVT, function (x) {
                return x.TimeStart === 0 && $.inArray(x.ID_ViTri, arrID_ViTri) === -1;
            });
            if (cthd_noStart.length > 0) {
                // if LaHangHoa = true --> get {ThoiGian} of CTHD
                for (let j = 0; j < lenTable; j++) {
                    var tblID = self.PhongBans_byIDNhom()[j].ID;
                    if ($.inArray(self.PhongBans_byIDNhom()[j].ID, arrID_ViTri) === -1) {
                        var lst = $.grep(cthd_noStart, function (x) {
                            return x.ID_ViTri === tblID;
                        });
                        if (lst.length > 0) {
                            self.PhongBans_byIDNhom()[j].CreateTime = ConvertTimeFrom24To12(lst[0].ThoiGian.split(' ')[1]);
                            arrID_ViTri.push(self.PhongBans_byIDNhom()[j].ID);
                        }
                    }
                }
            }
            // reset Phong not exist in arrID
            for (let i = 0; i < lenTable; i++) {
                if ($.inArray(self.PhongBans_byIDNhom()[i].ID, arrID_ViTri) === -1) {
                    self.PhongBans_byIDNhom()[i].CreateTime = 0;
                    self.PhongBans_byIDNhom()[i].NhanVien_Phong = '';
                    self.PhongBans_byIDNhom()[i].ThoiGianThucHien = '';
                }
            }
        }
        else {
            // reset again Time    
            for (let j = 0; j < self.PhongBans_byIDNhom().length; j++) {
                self.PhongBans_byIDNhom()[j].CreateTime = 0;
                self.PhongBans_byIDNhom()[j].NhanVien_Phong = '';
                self.PhongBans_byIDNhom()[j].ThoiGianThucHien = '';
            }
        }
        var lstPBAfter = self.PhongBans_byIDNhom();
        self.PhongBans_byIDNhom($.extend(true, [], lstPBAfter));
        // set img for location
        SetImg_Active(arrID_ViTri);
        CountTableUsed();
    }
    self.ClickTab_PhongBan = function (isChangeVT, firstLoad) {
        firstLoad = firstLoad || false;

        if (firstLoad === false && IsShop_SpaSalon() && self.setViewSoDoPhong()) {
            $('#banhangsodo').show();
            $('body').gridLoader({ show: true, iconloading: boxloading });
        }
        var arrIDRandom = [];
        var arrMaHD = []; // mahd is opnening update again from page lst HD
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD === null) {
            lstHD = [];
        }
        else {
            lstHD = JSON.parse(lstHD);
            // delete all HoaDon with ID !== Guid.Empty, don't delete HD DatHang BG00
            // không xóa hóa đơn được mở ra để cập nhật lại từ phần Danh sách
            lstHD = $.grep(lstHD, function (x) {
                return x.ID === const_GuidEmpty || (x.ID !== const_GuidEmpty && (x.LoaiHoaDon === 3 || x.Status === 1));
            });
            // get all IDRandom of HD don't delete
            for (let i = 0; i < lstHD.length; i++) {
                arrIDRandom.push(lstHD[i].IDRandom);
                if (lstHD[i].ID !== const_GuidEmpty) {
                    arrMaHD.push(lstHD[i].MaHoaDon);
                }
            }
        }
        var cthd = localStorage.getItem(lcListCTHD);
        if (cthd === null) {
            cthd = [];
        }
        else {
            cthd = JSON.parse(cthd);
            // delete all CTHD with ID_HoaDon !== Guid.Empty
            cthd = $.grep(cthd, function (x) {
                return $.inArray(x.IDRandomHD, arrIDRandom) > -1;
            });
        }
        var ctdt = localStorage.getItem(lcListCTHD_DoiTra);
        if (ctdt === null) {
            ctdt = [];
        }
        else {
            ctdt = JSON.parse(ctdt);
            ctdt = $.grep(ctdt, function (x) {
                return $.inArray(x.IDRandomHD, arrIDRandom) > -1;
            })
        }
        localStorage.setItem(lcListCTHD_DoiTra, JSON.stringify(ctdt));
        // only load HD_ChoThanhToan from DB if set view SoDoPhong
        let isView = false;
        let lcSetPrint = localStorage.getItem(lcSetPrintConst);
        if (lcSetPrint !== null) {
            lcSetPrint = JSON.parse(lcSetPrint);
            let itemEx = $.grep(lcSetPrint, function (x) {
                return x.ShowSoDoPhong === true && x.LoaiHoaDon === 1 && x.ID_DonVi === id_DonVi;
            });
            isView = itemEx.length > 0 && IsShop_SpaSalon();
        }
        if (isView === false) {
            if (firstLoad) {
                getListHoaDonLe();
            }
            BindTime_inSoDoPhong(isChangeVT);
            ActiveTab_SoDoPhong(true);
        }
        else {
            ajaxHelper(BHHoaDonUri + 'GetListHoaDons_ChoThanhToan?loaiHoaDon=1&idDonVi=' + id_DonVi, 'GET').done(function (obj) {
                if (obj.res === true) {
                    var maHDDB = [];
                    data = obj.data;
                    for (let i = 0; i < data.length; i++) {
                        maHDDB.push(data[i].MaHoaDon);
                        if ($.inArray(data[i].MaHoaDon, arrMaHD) === -1) {
                            // add again after delete
                            data[i].IDRandom = CreateIDRandom('HD_');
                            cthd = AssignCTHD_ChoThanhToan(data[i].BH_HoaDon_ChiTiet, cthd, data[i].IDRandom, data[i].MaHoaDon);
                            // delete key BH_HoaDon_ChiTiet in data
                            delete data[i]['BH_HoaDon_ChiTiet'];
                            data[i].TenViTriHD = data[i].TenViTri;
                            data[i].CreateTime = moment(data[i].NgayLapHoaDon).format('HH:mm');
                            data[i].NgayLapHoaDon = moment(data[i].NgayLapHoaDon).format('YYYY-MM-DD HH:mm');
                            data[i].StatusOffline = false;
                            data[i].HoanTraTamUng = 0;
                            data[i].DiemGiaoDich = 0;
                            data[i].DiemGiaoDichDB = 0;
                            data[i].TTBangDiem = 0;
                            data[i].DiemHienTai = 0;
                            data[i].DiemQuyDoi = 0;
                            data[i].MaHoaDonTraHang = data[i].MaHoaDonGoc;// used to check delete HDDatHang (if DatHang, after LuuTam)
                            data[i].DaThanhToan = data[i].PhaiThanhToan;
                            data[i].TienMat = data[i].PhaiThanhToan;
                            data[i].TienGui = 0;
                            data[i].TienATM = 0;
                            data[i].TienTheGiaTri = 0;
                            data[i].ID_TaiKhoanPos = null; // set = null, vi co the TT nhieu lan, nhieu ID_TaiKhoan khac nhau
                            data[i].ID_TaiKhoanChuyenKhoan = null;
                            let ptThue = data[i].PTThueHoaDon;
                            if (data[i].TongTienThue > 0 && ptThue === 0) {
                                ptThue = data[i].TongTienThue / data[i].TongTienHang * 100;
                            }
                            ptThue = isNaN(ptThue) ? 0 : ptThue;
                            data[i].PTThueHoaDon = ptThue;
                            data[i].TrangThaiHD = 3; // bind HD TamLuu if # userLogin (3.TamLuu, 4.DaThanhToan)
                            data[i].IsKhuyenMaiHD = false;
                            data[i].PTGiam_KM = 0;
                            data[i].KhuyeMai_GiamGia = 0;
                            data[i].TongGiaGocHangTra = 0;
                            data[i].TongGiamGiaDB = 0;
                            data[i].TongTienTra = 0;
                            data[i].TongThueDB = 0;
                            data[i].TongGiamGiaKM_HD = data[i].TongGiamGia;//= TongGG vi DatHang khong co KMai
                            data[i].KhuyenMai_GhiChu = '';
                            data[i].IsOpeningKMaiHD = false;
                            data[i].ThoiGianThucHien = 0;
                            data[i].TienTheGiaTri = 0;
                            data[i].ID_NhomDTApplySale = null;
                            // get from DB
                            for (let k = 0; k < data[i].BH_NhanVienThucHiens.length; k++) {
                                data[i].BH_NhanVienThucHiens[k].IDRandom = CreateIDRandom('CKHD_');
                                data[i].BH_NhanVienThucHiens[k].ChietKhauMacDinh = data[i].BH_NhanVienThucHiens[k].PT_ChietKhau;
                                if (data[i].BH_NhanVienThucHiens[k].TinhChietKhauTheo === 3)
                                    data[i].BH_NhanVienThucHiens[k].ChietKhauMacDinh = data[i].BH_NhanVienThucHiens[k].TienChietKhau / data[i].BH_NhanVienThucHiens[k].HeSo;
                            }
                            data[i].Status = 0;  // not bind hdTamLuu, only bind when click MoPhieu
                            // tinh ThoiGianThucHien DichVu
                            var totalTime = 0;
                            for (let j = 0; j < cthd.length; j++) {
                                totalTime += cthd[j].ThoiGianThucHien;
                            }
                            data[i].ThoiGianThucHien = totalTime;
                            lstHD.push(data[i]);
                        }
                    }
                }
                $('body').gridLoader({ show: false });
                // find HD with Status= 1 but was delete
                var arrHDDelete = $.grep(arrMaHD, function (x) {
                    return $.inArray(x, maHDDB) === -1;
                });
                lstHD = $.grep(lstHD, function (x) {
                    return $.inArray(x.MaHoaDon, arrHDDelete) === -1;
                });
                cthd = $.grep(cthd, function (x) {
                    return $.inArray(x.MaHoaDon, arrHDDelete) === -1;
                });
                localStorage.setItem(lcListHD, JSON.stringify(lstHD));
                localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
                if (firstLoad) {
                    getListHoaDonLe();
                }
                BindTime_inSoDoPhong(isChangeVT);
                ActiveTab_SoDoPhong(true);
            });
        }
    }
    // if Vitri had chose: return false, else return arrID_Vitri
    function CheckViTri_Chosed() {
        var phongbanID = self.IDPhongBan_Chosing();
        var idPhongBan_ofHDCurrent = null;
        var arrID_ViTri = [];
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            for (let i = 0; i < lstHD.length; i++) {
                // get all ID_ViTri of all HoaDon (all User)
                if (lstHD[i].ID_ViTri !== null && $.inArray(lstHD[i].ID_ViTri, arrID_ViTri) === -1) {
                    arrID_ViTri.push(lstHD[i].ID_ViTri);
                }
            }
            // find ID_ViTri old
            var itemX = GetHDOpening_byMaHoaDon(self.DichVu_isDoing().MaHoaDon, lstHD);
            if (itemX.length > 0) {
                idPhongBan_ofHDCurrent = itemX[0].ID_ViTri;
            }
            // if this vitri had chosed
            if ($.inArray(phongbanID, arrID_ViTri) > -1 && phongbanID !== idPhongBan_ofHDCurrent) {
                ShowMessage_Danger('Phòng bàn (vị trí) này đã được chọn');
                return false;
            }
            else {
                arrID_ViTri = arrID_ViTri.filter(x => x !== idPhongBan_ofHDCurrent);
                arrID_ViTri.push(phongbanID);
                return arrID_ViTri;
            }
        }
        return false;
    }
    // chon phong o chi tiet DV
    self.ChosePhongBan = function (item) {
        var phongbanID = item.ID;
        self.IDPhongBan_Chosing(phongbanID);
        var arrID_ViTri = CheckViTri_Chosed();
        if (arrID_ViTri !== false) {
            SetImg_Active(arrID_ViTri);
        }
    }
    function ChosePhong_ActiveTabHangHoa() {
        // active tab HangHoa
        $('#tabSoDo li').removeClass('active');
        $('#tabSoDo li:eq(1)').addClass('active');
        $('#banhangsodo, #banhanghanghoa').removeClass('active');
        $('#banhanghanghoa').addClass('active');
        $('#divListHD').show();
        $('.filter-so-do').hide();
        $('.filter-ban-le').show();
        $('#banhangsodo').hide();
    }
    // chon phong o tab So do phong
    self.ChosePhong_HD = function (item) {
        var phongbanID = item.ID;
        self.IDPhongBan_Chosing(phongbanID);
        var timeCreate = FormatDatetime_AMPM(new Date());
        var arrReturn = [];
        var arrCTHD = [];
        var arrOT = [];
        var itemHD = [];
        var doFunc = 0;
        var max = 1;
        var cthd = localStorage.getItem(lcListCTHD);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
        }
        else {
            cthd = [];
        }
        // add new HoaDon if not exist, else open (using LoaiHD = 1)
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            var itemEx = $.grep(lstHD, function (x) {
                return x.ID_ViTri === phongbanID;
            });
            if (itemEx.length > 0) {
                var idRandom = itemEx[0].IDRandom;
                // open HD
                itemHD = $.grep(lstHD, function (x) {
                    return x.IDRandom === idRandom;
                });
                if (itemHD.length > 0) {
                    arrCTHD = $.grep(cthd, function (x) {
                        return x.IDRandomHD === idRandom;
                    });
                    // check same User
                    if (itemHD[0].NguoiTao === userLogin) {
                        doFunc = 1;
                    }
                    else {// popup
                        doFunc = 2;
                    }
                }
                else {
                    // error not exist HD with IDRandom
                }
            }
            else {
                // check is changing VT CTHD
                if (self.Doing_ChangeVTCTHD()) {
                    // check exist thisPhong at other user
                    let idRandomEx = '';
                    for (let i = 0, k = cthd.length; i < k; i++) {
                        if (cthd[i].ID_ViTri === phongbanID) {
                            idRandomEx = cthd[i].IDRandomHD;
                            break;
                        }
                        for (let j = 0; j < cthd[i].HangCungLoais.length; j++) {
                            if (cthd[i].HangCungLoais[j].ID_ViTri === phongbanID) {
                                idRandomEx = cthd[i].IDRandomHD;
                                i = k;
                                break;
                            }
                        }
                        // continue check if i < k
                        if (i < k) {
                            for (let j = 0; j < cthd[i].DM_LoHang.length; j++) {
                                if (cthd[i].DM_LoHang[j].ID_ViTri === phongbanID) {
                                    idRandomEx = cthd[i].IDRandomHD;
                                    i = k;
                                    break;
                                }
                            }
                        }
                    }
                    if (idRandomEx !== '') {
                        itemHD = $.grep(lstHD, function (x) {
                            return x.IDRandom === idRandomEx;
                        });
                        if (itemHD.length > 0) {
                            if (itemHD[0].NguoiTao === userLogin) {
                                // update & bind & send data
                                doFunc = 3;
                            }
                            else {
                                // popup
                                arrCTHD = $.grep(cthd, function (x) {
                                    return x.IDRandomHD === itemHD[0].IDRandom;
                                });
                                doFunc = 2;
                            }
                        }
                        else {
                            // error exist CT but not exist HD
                        }
                    }
                    else {
                        // update & bind & send data
                        doFunc = 3;
                    }
                }
                else {
                    // check vtri in CTHD
                    var existViTri = false;
                    let idRandomEx = '';
                    for (let i = 0, k = cthd.length; i < k; i++) {
                        if (cthd[i].ID_ViTri === phongbanID) {
                            idRandomEx = cthd[i].IDRandomHD;
                            break;
                        }
                        for (let j = 0; j < cthd[i].HangCungLoais.length; j++) {
                            if (cthd[i].HangCungLoais[j].ID_ViTri === phongbanID) {
                                idRandomEx = cthd[i].IDRandomHD;
                                i = k;
                                break;
                            }
                        }
                        if (i < k) {
                            for (let j = 0; j < cthd[i].DM_LoHang.length; j++) {
                                if (cthd[i].DM_LoHang[j].ID_ViTri === phongbanID) {
                                    idRandomEx = cthd[i].IDRandomHD;
                                    i = k;
                                    break;
                                }
                            }
                        }
                    }
                    if (idRandomEx !== '') {
                        existViTri = true;
                        // check HD have this CTHD 
                        itemHD = $.grep(lstHD, function (x) {
                            return x.IDRandom === idRandomEx;
                        });
                        if (itemHD.length > 0) {
                            arrCTHD = $.grep(cthd, function (x) {
                                return x.IDRandomHD === idRandomEx;
                            });
                            // this user
                            if (itemHD[0].NguoiTao === userLogin) {
                                doFunc = 1;  // bind with data co san
                            }
                            else {
                                // other user (popup)
                                doFunc = 2;
                            }
                        }
                    }
                    if (existViTri === false) {
                        // get listHD with User 
                        var arrHD_byUser = $.grep(lstHD, function (x) {
                            return x.StatusOffline === false && x.NguoiTao === userLogin && x.TrangThaiHD === 1;
                        });
                        var arrHD = $.grep(arrHD_byUser, function (item) {
                            return item.LoaiHoaDon === 1;
                        });
                        if (arrHD.length > 0) {
                            max = Math.max.apply(Math, arrHD.map(function (item) {
                                return item.MaHoaDon.match(/\d+/);
                            }));
                        }
                        else {
                            // khong add HoaDon 1, vi neu add sẽ bị add cùng lúc Hóa đơn 1, Hóa đơn 2
                            max = 0;
                        }
                        // check HD with MaHD max exist CTHD
                        var idRandomHD = '';
                        if (max !== 0) {
                            // find HD with MaHoaDon = max
                            var itemHDMax = $.grep(arrHD, function (x) {
                                return x.MaHoaDon === nameHD_InsertBH + max;
                            });
                            if (itemHDMax.length > 0) {
                                idRandomHD = itemHDMax[0].IDRandom;
                            }
                            arrCTHD = $.grep(cthd, function (x) {
                                return x.IDRandomHD === idRandomHD;
                            });
                            if (arrCTHD.length === 0) {
                                doFunc = 4;// update HD
                                // update ID_ViTri for HoaDon
                                for (let i = 0; i < lstHD.length; i++) {
                                    if (lstHD[i].IDRandom === idRandomHD) {
                                        lstHD[i].CreateTime = timeCreate;
                                        lstHD[i].ID_ViTri = phongbanID;
                                        lstHD[i].TenViTriHD = item.TenViTri;
                                        break;
                                    }
                                }
                                localStorage.setItem(lcListHD, JSON.stringify(lstHD));
                                _maHoaDon = nameHD_InsertBH + max;
                            }
                            else {
                                // create newHoaDon 
                                doFunc = 5;
                            }
                        }
                        else {
                            doFunc = 5;
                        }
                    }
                }
            }
        }
        else {
            lstHD = [];
            doFunc = 5;
        }
        switch (doFunc) {
            case 1: // bind infor HD, CTHD with data
                _maHoaDon = itemHD[0].MaHoaDon;
                UpdateStatus_HDTamLuu(lstHD, itemHD[0].IDRandom);
                self.HoaDons().SetData(itemHD[0]);
                self.HangHoaAfterAdds($.extend(true, [], arrCTHD));
                GetInForCustomer_byID(itemHD[0].ID_DoiTuong);
                self.SetNhanVien(itemHD[0].ID_NhanVien);
                self.SetBangGia(itemHD[0].ID_BangGia);
                self.SetChiNhanh(itemHD[0].ID_DonVi);
                OnOff_Timer(itemHD[0].NgayLapHoaDon);
                ChosePhong_ActiveTabHangHoa();
                break;
            case 2: // show popup hd other user (don't active tab HangHoa)
                var cusName = 'Khách lẻ';
                // get tendoituong from DB (todo)
                var banggia = 'Bảng giá chuẩn';
                var itemBG = $.grep(self.AllBangGia(), function (x) {
                    return x.ID === itemHD[0].ID_BangGia;
                });
                if (itemBG.length > 0) {
                    banggia = itemBG[0].TenGiaBan;
                }
                var nvien = '';
                var itemNV = $.grep(self.NhanViens(), function (x) {
                    return x.ID === itemHD[0].ID_NhanVien;
                });
                if (itemNV.length > 0) {
                    nvien = itemNV[0].TenNhanVien;
                }
                itemHD[0].TenDoiTuong = cusName;
                itemHD[0].TenBangGia = banggia;
                itemHD[0].TenNhanVien = nvien;
                itemHD[0].NguoiTaoHD = itemHD[0].NguoiTao;
                itemHD[0].NgayLapHoaDon = GetNgayLapHD_whenSave(itemHD[0].NgayLapHoaDon);
                itemHD[0].BH_HoaDon_ChiTiet = arrCTHD;
                self.Modal_HoaDons(itemHD[0]);
                self.Modal_HoaDons().BH_HoaDon_ChiTiet = arrCTHD;
                $('#hdOtherClient').modal('show');
                // check role hide/show button MoPhieu
                var updateHdTam = $.grep(self.Quyen_NguoiDung(), function (x) {
                    return x.MaQuyen === 'HoaDon_CapNhatHDTamLuu';
                })
                if (updateHdTam.length > 0) {
                    $('#divMoPhieu').css('display', '');
                }
                else {
                    $('#divMoPhieu').css('display', 'none');
                }
                break;
            case 3: // update Vtri in CTHD & bind & send data
                // check HDTamLuu
                itemHD = $.grep(lstHD, function (x) {
                    return x.MaHoaDon === self.CTHD_ChangingVT().MaHoaDon;
                });
                if (itemHD[0].TrangThaiHD === 3) {
                    // update ID_ViTri for this CTHD into DB
                    UpdateViTri_inCTHD_toDB(self.CTHD_ChangingVT().ID, phongbanID);
                    UpdateStatus_HDTamLuu(lstHD, itemHD[0].IDRandom);
                    // if HD TamLuu, IDRandom has change --> check by MaHoaDon
                    for (let i = 0; i < cthd.length; i++) {
                        if (cthd[i].MaHoaDon === self.CTHD_ChangingVT().MaHoaDon && cthd[i].ID_DonViQuiDoi === self.CTHD_ChangingVT().ID_DonViQuiDoi) {
                            var qlTheoLo = cthd[i].QuanLyTheoLoHang;
                            if (qlTheoLo === false) {
                                cthd[i].ID_ViTri = phongbanID;
                                cthd[i].TenViTri = item.TenViTri;
                            }
                            else {
                                for (let j = 0; j < cthd[i].DM_LoHang.length; j++) {
                                    if (cthd[i].DM_LoHang[j].ID_LoHang === self.CTHD_ChangingVT().ID_LoHang) {
                                        // update ViTri in LoHang
                                        if (cthd[i].DM_LoHang[j].LotParent) {
                                            // udate parent
                                            cthd[i].ID_ViTri = phongbanID;
                                            cthd[i].TenViTri = item.TenViTri;
                                        }
                                        // update into DM_LoHang in CTHD
                                        cthd[i].DM_LoHang[j].ID_ViTri = phongbanID;
                                        cthd[i].DM_LoHang[j].TenViTri = item.TenViTri;
                                    }
                                }
                            }
                            break;
                        }
                    }
                }
                else {
                    cthd = UpdateViTri_inCacheCTHD(cthd, phongbanID, item.TenViTri);
                }
                localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
                localStorage.setItem(lcMaHD, self.CTHD_ChangingVT().MaHoaDon);// assign used to BindHD_CTHDafterSave
                BindHD_CTHDafterSave();
                ChosePhong_ActiveTabHangHoa();
                // send to display customer
                break;
            case 4:// update IDVitri in HD
                ChosePhong_ActiveTabHangHoa();
                self.HangHoaAfterAdds([]);
                Caculator_AmountProduct();
                break;
            case 5:  // create newHD
                if (lstHD === null) {
                    lstHD = [];
                }
                var objNew = newHoaDon(1, max + 1);
                objNew.CreateTime = timeCreate;
                objNew.ID_ViTri = phongbanID;
                objNew.TenViTriHD = item.TenViTri;
                lstHD.push(objNew);
                self.resetInforHD_CTHD(objNew.MaHoaDon);
                _maHoaDon = objNew.MaHoaDon;
                Caculator_AmountProduct();
                ChosePhong_ActiveTabHangHoa();
                break;
        }
        localStorage.setItem(lcListHD, JSON.stringify(lstHD));
        // bind list HoaDon
        localStorage.setItem(lcMaHD, _maHoaDon);
        GetCurrentPage_byMaHoaDon(_maHoaDon);
        // after chose, reset changing VT = false 
        //self.Doing_ChangeVTCTHD(false);
    }
    // thu gon code
    function UpdateViTri_inCacheCTHD(cthd, idViTri, tenViTri) {
        let quanlytheolo = self.CTHD_ChangingVT().QuanLyTheoLoHang;
        let concungloai = self.CTHD_ChangingVT().LaConCungLoai;
        let idRandom = self.CTHD_ChangingVT().IDRandom;
        let lenCT = cthd.length;
        if (self.CTHD_ChangingVT().LotParent || (concungloai === false && quanlytheolo === false)) {
            for (let i = 0; i < lenCT; i++) {
                if (cthd[i].IDRandom === idRandom) {
                    cthd[i].ID_ViTri = idViTri;
                    cthd[i].TenViTri = tenViTri;
                    break;
                }
            }
        }
        else {
            if (quanlytheolo) {
                for (let i = 0; i < lenCT; i++) {
                    for (let j = 0; j < cthd[i].DM_LoHang.length; j++) {
                        if (cthd[i].DM_LoHang[j].IDRandom === idRandom) {
                            cthd[i].DM_LoHang[j].ID_ViTri = idViTri;
                            cthd[i].DM_LoHang[j].TenViTri = tenViTri;
                            i = lenCT;  // esc for loop
                            break;
                        }
                    }
                }
            }
            else {
                for (let i = 0; i < lenCT; i++) {
                    for (let j = 0; j < cthd[i].HangCungLoais.length; j++) {
                        if (cthd[i].HangCungLoais[j].IDRandom === idRandom) {
                            cthd[i].HangCungLoais[j].ID_ViTri = idViTri;
                            cthd[i].HangCungLoais[j].TenViTri = tenViTri;
                            i = lenCT;
                            break;
                        }
                    }
                }
            }
        }
        return cthd;
    }
    function UpdateStatus_HDTamLuu(lstHD, idRandom) {
        for (let i = 0; i < lstHD.length; i++) {
            if (lstHD[i].IDRandom === idRandom) {
                lstHD[i].Status = 1;// open
                break;
            }
        }
        localStorage.setItem(lcListHD, JSON.stringify(lstHD));
    }
    // use first load, xulidonhang, chonTraHnag, clickTabDH, GoiDV
    function ActiveTab_SoDoPhong(isFistLoad) {
        var isView = false;
        var loaiHoaDon = GetLoaiHoaDon_ofHDopening();
        $('#banhangsodo, #banhanghanghoa').removeClass('active');
        $('#tabSoDo li').removeClass('active');
        if (loaiHoaDon === 1) {
            // cai dat view SoDoPhong o bat ky loai nao cung dc apdung cho loai 1
            var lcSetPrint = localStorage.getItem(lcSetPrintConst);
            if (lcSetPrint !== null) {
                lcSetPrint = JSON.parse(lcSetPrint);
                var itemEx = $.grep(lcSetPrint, function (x) {
                    return x.ShowSoDoPhong === true && x.LoaiHoaDon === 1 && x.ID_DonVi === id_DonVi;
                });
                isView = itemEx.length > 0 && IsShop_SpaSalon();
            }
        }
        if (isFistLoad) {
            if (isView) {
                $('#imgLogoOpen').hide();
                $('#tabSoDo').show();
                $('#banhangsodo').addClass('active');
                $('#divListHD').hide();
                $('#tabSoDo li:eq(0)').addClass('active');
                $('.filter-so-do').show();
                $('.filter-ban-le').hide();
                $('#banhangsodo').show();
            }
            else {
                $('#imgLogoOpen').show();
                $('#tabSoDo').hide();
                $('#banhanghanghoa').addClass('active');
                $('#divListHD').show();
                $('.filter-so-do').hide();
                $('.filter-ban-le').show();
                $('#banhangsodo').hide();
            }
        }
        else {
            // awlay active tab HangHoa
            $('#banhanghanghoa').addClass('active');
            $('#divListHD').show();
            $('.filter-so-do').hide();
            $('.filter-ban-le').show();
            if (isView) {
                $('#imgLogoOpen').hide();
                $('#tabSoDo').show();
                $('#tabSoDo li:eq(1)').addClass('active');
            }
            else {
                $('#imgLogoOpen').show();
                $('#tabSoDo').hide();
                $('#banhangsodo').hide();
            }
        }
    }
    function SetImg_Active(arrID_ViTri) {
        // reset img default
        $('img[id^=imgLocation_]').attr('src', '/Content/images/nhahang/vi-tri.png');
        $('#VTTatCa img').each(function () {
            var id = $(this).attr('id').split('_')[1];
            if ($.inArray(id, arrID_ViTri) > -1) {
                $('#imgLocation_' + id).attr('src', '/Content/images/nhahang/vi-tri-active.png');
            }
        })
    }
    self.GetPhongBan_ByIDNhom = function (item) {
        $('.logoOpen24 ul li').removeClass('active');
        $('.logoOpen24 ul li:eq(0)').addClass('active');
        var idNhom = item.ID;
        if (item.ID === undefined) {
            self.PhongBans_byIDNhom(self.AllPhongBans());
        }
        else {
            var lst = $.grep(self.AllPhongBans(), function (x) {
                return x.ID_KhuVuc === idNhom;
            });
            self.PhongBans_byIDNhom(lst);
        }
        // bind NhanVien, ViTri and set active img
        self.ClickTab_PhongBan(self.Doing_ChangeVTCTHD());
    }
    function ArrowRight_findNextLi(i, cthd_opening, idRandomHD, idRandomFocus, charStart, isDoiTra) {
        if (i < cthd_opening.length - 1) {
            // focus in next Lot
            idRandomFocus = cthd_opening[i + 1].IDRandom;
        }
        else {
            if (isDoiTra === false) {
                let ctDoiTra = localStorage.getItem(lcListCTHD_DoiTra);
                if (ctDoiTra !== null) {
                    ctDoiTra = JSON.parse(ctDoiTra);
                }
                else {
                    ctDoiTra = [];
                }
                ctDoiTra = $.grep(ctDoiTra, function (x) {
                    return x.IDRandomHD === idRandomHD;
                });
                // find doitra  
                if (ctDoiTra.length > 0) {
                    // find li fisrt (= elm last)
                    idRandomFocus = ctDoiTra[0].IDRandom;
                    charStart = 'numberTH_';
                }
                else {
                    idRandomFocus = null;
                    // focus txtThanhToan
                    if (cthd_opening[0].LoaiHoaDon === 6) {
                        $('#txtDaTraKhach_KM').focus().select();
                    }
                    else {
                        $('#txtDaThanhToan').focus().select();
                    }
                }
            }
            else {
                FocusTienThanhToan_WhenEnterCTHDDoiTra(idRandomHD);
                idRandomFocus = null;
            }
        }
        return {
            IDRandom: idRandomFocus,
            CharStart: charStart,
        }
    }
    function ArrowRight_Focus(cthd_opening, idRandom, idQuiDoi, idRandomHD, charStart, isDoiTra) {
        for (let i = 0; i < cthd_opening.length; i++) {
            if (cthd_opening[i].ID_DonViQuiDoi === idQuiDoi) {
                let lenLo = cthd_opening[i].DM_LoHang.length;
                if (lenLo > 0) {
                    if (cthd_opening[i].IDRandom === idRandom) {
                        if (lenLo > 1) {
                            idRandom = cthd_opening[i].DM_LoHang[1].IDRandom;
                        }
                        else {
                            let obj = ArrowRight_findNextLi(i, cthd_opening, idRandomHD, idRandom, charStart, isDoiTra);
                            idRandom = obj.IDRandom;
                            charStart = obj.CharStart;
                        }
                    }
                    else {
                        // find LoHang
                        for (let j = 1; j < lenLo; j++) {
                            if (cthd_opening[i].DM_LoHang[j].IDRandom === idRandom) {
                                if (j < cthd_opening[i].DM_LoHang.length - 1) {
                                    // focus in next Lot
                                    idRandom = cthd_opening[i].DM_LoHang[j + 1].IDRandom;
                                }
                                else {
                                    let obj = ArrowRight_findNextLi(i, cthd_opening, idRandomHD, idRandom, charStart, isDoiTra);
                                    idRandom = obj.IDRandom;
                                    charStart = obj.CharStart;
                                }
                                break;
                            }
                        }
                    }// else Lo
                }
                else {
                    // find cungloai
                    lenLo = cthd_opening[i].HangCungLoais.length;
                    if (lenLo > 0) {
                        if (cthd_opening[i].IDRandom === idRandom) {
                            idRandom = cthd_opening[i].HangCungLoais[0].IDRandom;
                        }// end  = idransom
                        else {
                            for (let j = 0; j < lenLo; j++) {
                                if (cthd_opening[i].HangCungLoais[j].IDRandom === idRandom) {
                                    if (j < cthd_opening[i].HangCungLoais.length - 1) {
                                        // focus in next Lot
                                        idRandom = cthd_opening[i].HangCungLoais[j + 1].IDRandom;
                                    }
                                    else {
                                        let obj = ArrowRight_findNextLi(i, cthd_opening, idRandomHD, idRandom, charStart, isDoiTra);
                                        idRandom = obj.IDRandom;
                                        charStart = obj.CharStart;
                                    }
                                    break;
                                }
                            }
                        }
                    }
                    else {
                        let obj = ArrowRight_findNextLi(i, cthd_opening, idRandomHD, idRandom, charStart, isDoiTra);
                        idRandom = obj.IDRandom;
                        charStart = obj.CharStart;
                    }
                }
                break;
            }
        }
        // focus input soluong 
        $('input[id=' + charStart + idRandom + ']').focus().select();
    }
    function ArrowRight_CTHD(itemCT, event) {
        var keyCode = event.keyCode || event.which;
        if (keyCode === 39) {
            var thisObj = event.currentTarget;
            var id = $(thisObj).attr('id');
            var arrSplit = id.split('_');
            var idRandom = itemCT.IDRandom;
            var loaiHD = itemCT.LoaiHoaDon;
            var roleChangeSale = true;
            switch (loaiHD) {
                case 1:
                    roleChangeSale = self.roleChangePriceProduct_Invoice();
                    break;
                case 3:
                    roleChangeSale = self.roleChangePriceProduct_Order();
                    break;
                case 6:
                    roleChangeSale = self.roleChangePriceProduct_Return();
                    break;
                case 19:
                    roleChangeSale = self.roleChangePriceProduct_ServicePackage();
                    break;
            }
            // if have role change price
            if (roleChangeSale === true) {
                var charStartInput = arrSplit[0];
                switch (charStartInput) {
                    case 'munber':
                        $('input[id=' + idRandom + ']').focus().select();
                        break;
                    case 'numberTH':
                        $('#priceTH_' + idRandom).focus().select();
                        break;
                    case 'sum-f':
                        var cthd = localStorage.getItem(lcListCTHD);
                        cthd = JSON.parse(cthd);
                        var cthd_opening = $.grep(cthd, function (x) {
                            return x.IDRandomHD === itemCT.IDRandomHD;
                        });
                        ArrowRight_Focus(cthd_opening, idRandom, itemCT.ID_DonViQuiDoi, itemCT.IDRandomHD, 'munber_', false);
                        break;
                    case 'sumTH':
                        // get ct doitra
                        var ctDoiTra = localStorage.getItem(lcListCTHD_DoiTra);
                        ctDoiTra = JSON.parse(ctDoiTra);
                        var ctDoiTra_opening = $.grep(ctDoiTra, function (x) {
                            return x.IDRandomHD === itemCT.IDRandomHD;
                        });
                        ArrowRight_Focus(ctDoiTra_opening, idRandom, itemCT.ID_DonViQuiDoi, itemCT.IDRandomHD, 'numberTH_', true);
                        break;
                    case 'pri-g': // chietkhau
                        $('#sum-f_' + idRandom).focus().select();
                        $(thisObj).closest('.callprice').hide();
                        break;
                    case 'pri-gTH':
                        $('#sumTH_' + idRandom).focus().select();
                        $(thisObj).closest('.callprice').hide();
                        break;
                    case 'priceTH':
                        self.showDivSale_CTHD_DoiTra(itemCT);
                        break;
                    default: // price cthd
                        self.showDivSale_CTHD(itemCT);
                        break;
                }
            }
        }
    }
    function ArrowLeft_CTHD(itemCT, event) {
        var keyCode = event.keyCode || event.which;
        if (keyCode === 37) {
            var thisObj = event.currentTarget;
            var id = $(thisObj).attr('id');
            var arrSplit = id.split('_');
            var idRandom = itemCT.IDRandom;
            var loaiHD = itemCT.LoaiHoaDon;
            var roleChangeSale = true;
            switch (loaiHD) {
                case 1:
                    roleChangeSale = self.roleChangePriceProduct_Invoice();
                    break;
                case 3:
                    roleChangeSale = self.roleChangePriceProduct_Order();
                    break;
                case 6:
                    roleChangeSale = self.roleChangePriceProduct_Return();
                    break;
                case 19:
                    roleChangeSale = self.roleChangePriceProduct_ServicePackage();
                    break;
            }
            // if have role change price
            if (roleChangeSale === true) {
                var charStartInput = arrSplit[0];
                switch (charStartInput) {
                    case 'numberTH':
                        Shift_DoiTra(itemCT, event, 'sumTH_', 3, 37);
                        break;
                    case 'munber':
                        Shift_SoLuongPriceCTHD(itemCT, event, 'sum-f_', 3, 37);
                        break;
                    case 'pri-g':
                        $('input[id=' + idRandom + ']').focus().select();
                        $(thisObj).closest('.callprice').hide();
                        break;
                    case 'pri-gTH':
                        $('#priceTH_' + idRandom).focus().select();
                        $(thisObj).closest('.callprice').hide();
                        break;
                    case 'sumTH':
                        self.showDivSale_CTHD_DoiTra(itemCT);
                        break;
                    case 'sum-f':
                        self.showDivSale_CTHD(itemCT);
                        break;
                    case 'priceTH':
                        $('#numberTH_' + idRandom).focus().select();
                        break;
                    default:
                        $('#munber_' + idRandom).focus().select();
                        break;
                }
            }
        }
    }

    self.ShowPop_ChangeTPDinhLuong = function (item, isDoiTra) {
        var cthdDoing = FindCTHD_isDoing(item, isDoiTra);
        if (cthdDoing !== null) {
            if (item.LoaiHangHoa === 2) {
                var arrTPDinhLuong = [];
                let thanhtien = (cthdDoing.GiaBan - cthdDoing.TienChietKhau) * cthdDoing.SoLuong;
                item.ThanhTien = thanhtien;
                item.SoLuong = cthdDoing.SoLuong;
                vmThanhPhanDinhLuong.DichVu_isDoing = item;
                self.DichVu_isDoing(item);
                arrTPDinhLuong = cthdDoing.ThanhPhan_DinhLuong;

                if (arrTPDinhLuong.length === 0) {
                    // get TP dinh luong by ID_QuiDoi
                    let lstTPDinhLuong = $.grep(vmThanhPhanDinhLuong.All_DinhLuongDichVu, function (x) {
                        return x.ID_DichVu === item.ID_DonViQuiDoi;
                    });
                    if (lstTPDinhLuong.length > 0) {
                        for (let i = 0; i < lstTPDinhLuong.length; i++) {
                            lstTPDinhLuong[i].STT = i + 1;
                            lstTPDinhLuong[i].GhiChu = '';
                            lstTPDinhLuong[i].isDefault = false;
                            lstTPDinhLuong[i].IDRandom = 'TPDL_' + Math.floor(Math.random() * 10000000 + 1);
                            lstTPDinhLuong[i].SoLuong = cthdDoing.SoLuong * lstTPDinhLuong[i].SoLuongMacDinh;
                            lstTPDinhLuong[i].SoLuongQuyCach = lstTPDinhLuong[i].SoLuong * lstTPDinhLuong[i].QuyCach;
                            lstTPDinhLuong[i].GiaVonAfter = lstTPDinhLuong[i].SoLuong * lstTPDinhLuong[i].GiaVon;// = GiaVon(co ban) * SoLuong
                            arrTPDinhLuong.push(lstTPDinhLuong[i]);
                        }
                    }
                }
                vmThanhPhanDinhLuong.ID_DonVi = id_DonVi;
                vmThanhPhanDinhLuong.Grid_TPDinhLuongChosed = arrTPDinhLuong;
                vmThanhPhanDinhLuong.typeSearchProduct = '11';// chi search hanghoa
                vmThanhPhanDinhLuong.showModal(isDoiTra, false);
            }
            else {
                if (item.LoaiHoaDon === 6 && isDoiTra === false) {
                    vmThanhPhanCombo.showModal(cthdDoing, 3, isDoiTra);// 3.trahang: khong dc thaydoi tpcombo
                }
                else {
                    vmThanhPhanCombo.showModal(cthdDoing, 1, isDoiTra);
                }
            }
        }
    }

    $('#vmThanhPhanDinhLuong').on('hidden.bs.modal', function () {
        if (vmThanhPhanDinhLuong.saveOK) {
            if (!vmThanhPhanDinhLuong.isCombo) {// khong phai combo
                self.Agree_TPDinhLuong();
            }
            else {
                self.Combo_AgreeTPDinhLuong();
            }
        }
    })

    function Update_SoLuongBanDau_forListTPDinhLuong() {
        var soluongHang = parseFloat(self.DichVu_isDoing().SoLuong);
        // find all TPDinhLuong_BanDau and update TPDinhLuong_New
        var lstTPDinhLuong = $.grep(vmThanhPhanDinhLuong.All_DinhLuongDichVu, function (x) {
            return x.ID_DichVu === self.DichVu_isDoing().ID_DonViQuiDoi;
        });
        if (lstTPDinhLuong.length > 0) {
            var arrIDQuiDoi_afterChange = [];
            for (let i = 0; i < lstTPDinhLuong.length; i++) {
                let itemOut = lstTPDinhLuong[i];
                for (let j = 0; j < vmThanhPhanDinhLuong.Grid_TPDinhLuongChosed.length; j++) {
                    let itemIn = vmThanhPhanDinhLuong.Grid_TPDinhLuongChosed[j];
                    if (itemIn.ID_DonViQuiDoi === itemOut.ID_DonViQuiDoi) {
                        arrIDQuiDoi_afterChange.push(itemOut.ID_DonViQuiDoi);
                        vmThanhPhanDinhLuong.Grid_TPDinhLuongChosed[j].SoLuongMacDinh = itemIn.SoLuong / soluongHang;
                        break;
                    }
                }
            }
            // Nếu add 1 TP định lượng--> update again SoLuongMacDinh
            for (let j = 0; j < vmThanhPhanDinhLuong.Grid_TPDinhLuongChosed.length; j++) {
                let itemIn = vmThanhPhanDinhLuong.Grid_TPDinhLuongChosed[j];
                if ($.inArray(itemIn.ID_DonViQuiDoi, arrIDQuiDoi_afterChange) === -1) {
                    vmThanhPhanDinhLuong.Grid_TPDinhLuongChosed[j].SoLuongMacDinh = itemIn.SoLuong / soluongHang;
                }
            }
            // assign again lstTPDinhLuong for variable other ---> 
            var lstTPDinhLuong2 = $.extend(true, [], lstTPDinhLuong);
            //push list DinhLuongBanDau into list chosed if deleted
            for (let i = 0; i < lstTPDinhLuong2.length; i++) {
                if ($.inArray(lstTPDinhLuong2[i].ID_DonViQuiDoi, arrIDQuiDoi_afterChange) === -1) {
                    lstTPDinhLuong2[i].SoLuong = 0;// soluong thuc te su dung
                    lstTPDinhLuong2[i].SoLuongMacDinh = 0;
                    lstTPDinhLuong2[i].GiaVon = 0; // neu khong su dung dinh luong nay nua --> gia von =0
                    self.Grid_TPDinhLuongChosed.push(lstTPDinhLuong2[i]);
                }
            }
        }
        else {
            // truong hop HangHoa khong co TPDinhLuong: if change SoLuong/SLQuyCach TPDinhLuong --> update again SoLongMacDinh
            for (let i = 0; i < vmThanhPhanDinhLuong.Grid_TPDinhLuongChosed.length; i++) {
                let itemIn = vmThanhPhanDinhLuong.Grid_TPDinhLuongChosed[i];
                vmThanhPhanDinhLuong.Grid_TPDinhLuongChosed[i].SoLuongMacDinh = itemIn.SoLuong / soluongHang;
            }
        }
    }
    self.Agree_TPDinhLuong = function () {
        var loaiHD = GetLoaiHoaDon_ofHDopening();
        var cacheName = lcListCTHD;
        if (loaiHD === 6) {
            cacheName = lcListCTHD_DoiTra;
        }
        Update_SoLuongBanDau_forListTPDinhLuong();

        var idRandom = self.DichVu_isDoing().IDRandom;
        var quanlytheolo = self.DichVu_isDoing().QuanLyTheoLoHang;
        var cthd = localStorage.getItem(cacheName);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            if (self.DichVu_isDoing().LotParent || (quanlytheolo === false && self.DichVu_isDoing().LaConCungLoai === false)) {
                for (let i = 0; i < cthd.length; i++) {
                    if (cthd[i].IDRandom === idRandom) {
                        cthd[i].ThanhPhan_DinhLuong = vmThanhPhanDinhLuong.Grid_TPDinhLuongChosed;
                        break;
                    }
                }
            }
            else {
                if (quanlytheolo) {
                    for (let i = 0; i < cthd.length; i++) {
                        for (let j = 0; j < cthd[i].DM_LoHang.length; j++) {
                            if (cthd[i].DM_LoHang[j].IDRandom === idRandom) {
                                cthd[i].DM_LoHang[j].ThanhPhan_DinhLuong = vmThanhPhanDinhLuong.Grid_TPDinhLuongChosed;
                                i = cthd.length;  // esc for loop
                                break;
                            }
                        }
                    }
                }
                else {
                    for (let i = 0; i < cthd.length; i++) {
                        for (let j = 0; j < cthd[i].HangCungLoais.length; j++) {
                            if (cthd[i].HangCungLoais[j].IDRandom === idRandom) {
                                cthd[i].HangCungLoais[j].ThanhPhan_DinhLuong = vmThanhPhanDinhLuong.Grid_TPDinhLuongChosed;
                                i = cthd.length;
                                break;
                            }
                        }
                    }
                }
            }
            localStorage.setItem(cacheName, JSON.stringify(cthd));
        }

        // update tpdinhluong in cacheDH 
        if (self.HoaDons().LoaiHoaDon() === 3 && self.HoaDons().ID() !== const_GuidEmpty) {
            let ctDH = localStorage.getItem(lcCTDatHang_Const);
            if (ctDH !== null) {
                ctDH = JSON.parse(ctDH);
                for (let i = 0; i < ctDH.length; i++) {
                    for (let j = 0; j < cthd.length; j++) {
                        if (ctDH[i].IDRandom === cthd[j].IDRandom) {
                            ctDH[i].ThanhPhan_DinhLuong = cthd[j].ThanhPhan_DinhLuong;

                            for (let m = 0; m < ctDH[i].HangCungLoais.length; m++) {
                                for (let n = 0; n < cthd[j].HangCungLoais.length; n++) {
                                    if (ctDH[i].HangCungLoais[m].IDRandom === cthd[j].HangCungLoais[n].IDRandom) {
                                        ctDH[i].HangCungLoais[m].ThanhPhan_DinhLuong = cthd[j].HangCungLoais[n].ThanhPhan_DinhLuong;
                                        break;
                                    }
                                }
                            }

                            for (let m = 0; m < ctDH[i].ThanhPhanComBo.length; m++) {
                                for (let n = 0; n < cthd[j].ThanhPhanComBo.length; n++) {
                                    if (ctDH[i].ThanhPhanComBo[m].IDRandom === cthd[j].ThanhPhanComBo[n].IDRandom) {
                                        ctDH[i].ThanhPhanComBo[m].ThanhPhan_DinhLuong = cthd[j].ThanhPhanComBo[n].ThanhPhan_DinhLuong;
                                        break;
                                    }
                                }
                            }
                            break;
                        }
                    }
                }
                localStorage.setItem(lcCTDatHang_Const, JSON.stringify(ctDH));
            }
            Update_StatusXuLy_ofHDDatHang(self.HoaDons().IDRandom());
        }
    }

    self.KhoanThuChis = ko.observableArray();
    function GetAllQuy_KhoanThuChi() {
        ajaxHelper('/api/DanhMuc/Quy_HoaDonAPI/' + 'GetQuy_KhoanThuChi', 'GET').done(function (x) {
            if (x.res === true) {
                let data = x.data;
                var khoanthu = $.grep(data, function (x) {
                    return x.LaKhoanThu === true;
                });
                self.KhoanThuChis(khoanthu);
            }
        })
    }

    self.SoDuDatCoc = ko.observable(0);
    function GetTienDatCoc(idDoiTuong) {
        self.SoDuDatCoc(0);
        ajaxHelper(DMDoiTuongUri + "GetTienDatCoc_ofDoiTuong?idDoiTuong=" + idDoiTuong
            + '&idDonVi=' + id_DonVi, 'GET').done(function (x) {
                if (x.res && x.dataSoure.length > 0) {
                    var isChangeSoDu = false;
                    var sodu = x.dataSoure[0].SoDuTheGiaTri;
                    sodu = sodu < 0 ? 0 : sodu;
                    self.SoDuDatCoc(sodu);
                    var hd = localStorage.getItem(lcListHD);
                    var loaiHD = 0;
                    if (hd !== null) {
                        hd = JSON.parse(hd);
                        for (let i = 0; i < hd.length; i++) {
                            if (hd[i].IDRandom === self.HoaDons().IDRandom()) {
                                isChangeSoDu = hd[i].SoDuDatCoc !== sodu;
                                hd[i].SoDuDatCoc = self.SoDuDatCoc();
                                self.HoaDons().SoDuDatCoc(self.SoDuDatCoc());
                                loaiHD = hd[i].LoaiHoaDon;
                                break;
                            }
                        }
                        localStorage.setItem(lcListHD, JSON.stringify(hd));
                    }
                    if (isChangeSoDu) {
                        UpdateCacheHDLe(self.HoaDons().IDRandom(), loaiHD === 6, 5);// typeEdit = 5: khong capnhat lai thue
                    }
                    BindHD_byIDRandom(self.HoaDons().IDRandom())
                }
            });
    }

    //Caculator_TimeRemain();
    function Caculator_TimeRemainHD() {
        $('#allLocation ul li').each(function () {
            var start = $(this).find('.sp-room-time').text();
            var timeUse = $(this).find('.timeUse').text();
            var sVal = getMinutesBetweenDates_ToDay(start, timeUse);
            $(this).find('.timeRemain').text(sVal + ' phút');
            setTimeout(Caculator_TimeRemainHD, 5000);// 5s
        });
    }
    Caculator_TimeRemainCTHD();
    function Caculator_TimeRemainCTHD() {
        $('.time-room').each(function () {
            // only update if StartTime !=0
            var start = $(this).val();
            if (start !== '0' && start !== '') {
                var thisID = $(this).attr('id').split('_')[2];
                var closestVT = $(this).closest('.room-view-vi-tri');
                // check CTHD/CTGD_DoiTra
                var divDoiTra = $(this).closest('.bill-listchoose');
                var cacheName = lcListCTHD_DoiTra;
                if ($(divDoiTra).attr('id') === 'divCTDoiTra') {
                    cacheName = lcListCTHD;
                }
                var timeUse = $(closestVT).find('.timeUse').text();
                var sVal = getMinutesBetweenDates_ToDay(start, timeUse);
                if (sVal > 0) {
                    $(closestVT).find('.timeRemain').text(sVal + ' phút');
                    $(closestVT).find('.timeRemain').closest('.room-position').css('display', '');
                }
                else {
                    $(closestVT).find('.timeOver').text(sVal * (-1) + ' phút');
                    $(closestVT).find('.timeRemain').closest('.room-position').css('display', 'none');
                    $(closestVT).find('.overtime').css('display', '');
                }
                // update time over for CTHD
                var cthd = localStorage.getItem(lcListCTHD);
                if (cthd !== null) {
                    cthd = JSON.parse(cthd);
                    for (let i = 0; i < cthd.length; i++) {
                        if (cthd[i].IDRandom === 'RandomCT_' + thisID) {
                            cthd[i].TimeRemain = sVal > 0 ? sVal : 0;
                            cthd[i].QuaThoiGian = sVal > 0 ? 0 : sVal * (-1);
                            break;
                        }
                    }
                    localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
                }
            }
        });
        setTimeout(Caculator_TimeRemainCTHD, 5000);// 5s
    }
    function getMinutesBetweenDates_ToDay(timeIn, timeUse) {
        timeUse = parseInt(timeUse.toString().replace(/\D/g, ''));// get number from string
        if (isNaN(timeUse) === false) {
            var today = moment(new Date()).format('YYYY-MM-DD');
            var ngaygioVao = today.concat(' ', timeIn);
            var diff = (new Date() - new Date(ngaygioVao)) / 1000;
            var hours = Math.floor(diff / 3600);
            var minutes = Math.floor(diff % 3600) / 60; // = sophut da su dung
            var timeRemain = timeUse;
            if (hours >= 1) {
                timeRemain = Math.ceil(timeUse - (minutes + hours * 60));
            }
            else {
                if (minutes > 0) {
                    timeRemain = Math.ceil(timeUse - minutes);
                }
            }
            return timeRemain;
        }
        return 0;
    }
    function getMinutesBetweenDates(dateFrom, dateTo) {
        var start = moment(dateFrom).format('YYYY-MM-DD HH:mm:ss');
        var end = moment(dateTo).format('YYYY-MM-DD HH:mm:ss');
        var diff = (new Date(end) - new Date(start)) / 1000;
        var hours = Math.floor(diff / 3600);
        var minutes = Math.floor(diff % 3600) / 60;
        var sophut = 0;
        if (hours > 24) {
            sophut = hours * 60;
        }
        else {
            if (hours >= 1) {
                sophut = Math.ceil(minutes + hours * 60);
            }
            else {
                if (minutes > 0) {
                    sophut = Math.ceil(minutes);
                }
                else {
                    sophut = 0;
                }
            }
        }
        return sophut;
    }
    // CTHD have ID_ViTri
    self.ListTable_Empty = ko.observableArray();
    self.ListFoor_Empty = ko.observableArray();
    self.TableEmpty_ByIDNhom = ko.observableArray();
    self.Doing_ChangeVTCTHD = ko.observable(false);// used to change VT CTHD
    self.CTHD_ChangingVT = ko.observableArray();
    self.ClickTimeStart = function (item, isDoiTra) {
        var idRandom = item.IDRandom;
        var idRandomHD = item.IDRandomHD;
        var cacheName = lcListCTHD;
        if (isDoiTra) {
            cacheName = lcListCTHD_DoiTra;
        }
        var cthd = localStorage.getItem(cacheName);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            for (let i = 0; i < cthd.length; i++) {
                // DichVu hasn't Lohang --> dont' need for DM_LoHang
                if (cthd[i].IDRandom === idRandom) {
                    cthd[i].TimeStart = FormatDatetime_24Hours(new Date());
                    break;
                }
            }
            localStorage.setItem(cacheName, JSON.stringify(cthd));
            // caculator again timeDoing of HoaDon todo
            // bind again CTHD
            var arrCT = $.grep(cthd, function (x) {
                return x.IDRandomHD === idRandomHD;
            });
            if (isDoiTra) {
                self.NewProducts(arrCT);
            }
            else {
                self.HangHoaAfterAdds(arrCT);
            }
        }
    }
    self.ChangeViTri_CTHD = function (item, isDoiTra) {
        var idRandomHD = item.IDRandomHD;
        var cacheName = lcListCTHD;
        if (isDoiTra) {
            cacheName = lcListCTHD_DoiTra;
        }
        // doivitri
        if (item.ID_ViTri !== null) {
            // count table empty (if same HD, same KH --> allow same ID_ViTri)
            var cthd = localStorage.getItem(cacheName);
            if (cthd !== null) {
                cthd = JSON.parse(cthd);
                var cthdOtherHD = $.grep(cthd, function (x) {
                    return x.ID_ViTri !== null && x.IDRandomHD !== idRandomHD;
                });
                var vtriUsed = [];
                for (let i = 0; i < cthdOtherHD.length; i++) {
                    vtriUsed.push(cthdOtherHD[i].ID_ViTri);
                }
                var vtriEmpty = $.grep(self.AllPhongBans(), function (x) {
                    return $.inArray(x.ID, vtriUsed) === -1;
                });
                self.ListTable_Empty(vtriEmpty);
                self.TableEmpty_ByIDNhom(vtriEmpty);
            }
            $('#modalPopupdoivitri').modal('show');
        }
        else {
            // chose Vitri
            $('.filter-ban-le').hide();
            $('.filter-so-do').show();
            $('#divListHD').hide();
            $('#banhangsodo, #banhanghanghoa').removeClass('active');
            $('#tabSoDo li').removeClass('active');
            $('#tabSoDo li:eq(0)').addClass('active');
            $('#banhangsodo').addClass('active');
            self.ClickTab_PhongBan(true);
        }
        self.CTHD_ChangingVT(item);
    }
    self.GetTableEmpty_ByIDNhom = function (item) {
        var idNhom = item.ID;
        if (item.ID === undefined) {
            self.TableEmpty_ByIDNhom(self.ListTable_Empty());
        }
        else {
            var lst = $.grep(self.ListTable_Empty(), function (x) {
                return x.ID_KhuVuc === idNhom;
            });
            self.TableEmpty_ByIDNhom(lst);
        }
    }
    self.ChangeTime_CTHD = function (item, isDoiTra) {
        var $this = event.currentTarget;
        $($this).datetimepicker({
            datepicker: false,
            step: 5,
            format: 'H:m',
            onSelectTime: function (e, evt) {
                var hour = e.getHours() > 9 ? e.getHours() : "0" + e.getHours();
                var min = e.getMinutes() > 9 ? e.getMinutes() : "0" + e.getMinutes();
                $(evt).val(hour + ":" + min);
                // update again timeStart, timeRemain, timeOver for CTHD
                // DichVu hasn't Lohang --> dont' need for DM_LoHang
                var cacheName = lcListCTHD;
                if (isDoiTra) {
                    cacheName = lcListCTHD_DoiTra;
                }
                var timeAfter = hour + ":" + min;
                console.log('timeAfter ', timeAfter)
                var cthd = localStorage.getItem(cacheName);
                if (cthd !== null) {
                    cthd = JSON.parse(cthd);
                    for (let i = 0; i < cthd.length; i++) {
                        if (cthd[i].IDRandom === item.IDRandom) {
                            cthd[i].TimeStart = timeAfter;
                            var sophut = getMinutesBetweenDates_ToDay(timeAfter, cthd[i].ThoiGianThucHien);
                            var divVtri = $($this).closest('.room-position');
                            if (sophut > 0) {
                                cthd[i].TimeRemain = sophut;
                                cthd[i].QuaThoiGian = 0;
                                // hide/show div of time remain/time over
                                $(divVtri).next().next().find('.timeRemain').text(sophut + ' phút');
                                $(divVtri).next().css('display', 'none');
                                $(divVtri).next().next().find('.timeRemain').closest('.room-position').css('display', '');
                            }
                            else {
                                sophut = sophut * (-1);
                                cthd[i].TimeRemain = 0;
                                cthd[i].QuaThoiGian = sophut;
                                $(divVtri).next().find('.timeOver').text(sophut + ' phút');
                                $(divVtri).next().css('display', '');
                                $(divVtri).next().next().find('.timeRemain').closest('.room-position').css('display', 'none');
                            }
                            break;
                        }
                    }
                    localStorage.setItem(cacheName, JSON.stringify(cthd));
                }
                $($this).datetimepicker('destroy');
            }
        })
    }
    self.EditTime_CTHD = function (item, isDoiTra) {
        var $this = event.currentTarget;
        var keyCode = event.keyCode || event.which;
        var gtri = $($this).val();
        if (gtri.indexOf(':') === -1) gtri = gtri.substr(0, 2) + ':' + gtri.substr(2, 2);
        if (keyCode === 13) {
            console.log('gtri ', gtri)
            var cacheName = lcListCTHD;
            if (isDoiTra) {
                cacheName = lcListCTHD_DoiTra;
            }
            var cthd = localStorage.getItem(cacheName);
            if (cthd !== null) {
                cthd = JSON.parse(cthd);
                for (let i = 0; i < cthd.length; i++) {
                    if (cthd[i].IDRandom === item.IDRandom) {
                        cthd[i].TimeStart = gtri;
                        var sophut = getMinutesBetweenDates_ToDay(gtri, cthd[i].ThoiGianThucHien);
                        var divVtri = $($this).closest('.room-position');
                        if (sophut > 0) {
                            cthd[i].TimeRemain = sophut;
                            cthd[i].QuaThoiGian = 0;
                            // hide/show div of time remain/time over
                            $(divVtri).next().next().find('.timeRemain').text(sophut + ' phút');
                            $(divVtri).next().css('display', 'none');
                            $(divVtri).next().next().find('.timeRemain').closest('.room-position').css('display', '');
                        }
                        else {
                            sophut = sophut * (-1);
                            cthd[i].TimeRemain = 0;
                            cthd[i].QuaThoiGian = sophut;
                            $(divVtri).next().find('.timeOver').text(sophut + ' phút');
                            $(divVtri).next().css('display', '');
                            $(divVtri).next().next().find('.timeRemain').closest('.room-position').css('display', 'none');
                        }
                        break;
                    }
                }
                localStorage.setItem(cacheName, JSON.stringify(cthd));
            }
        }
    }
    function UpdateViTri_inCTHD_toDB(idCTHD, idViTri) {
        // idCTHD === undefined if not exist in DB
        if (idCTHD !== undefined) {
            ajaxHelper(BHHoaDonUri + 'UpdateViTri_CTHD?idCTHD=' + idCTHD + '&idViTri=' + idViTri, 'GET').done(function (x) {
                console.log('UpdateViTri_CTHD ', x);
            })
        }
    }
    self.Popup_ChoseTable = function (item) {
        self.IDPhongBan_Chosing(item.ID);
        self.SaveVitri_Chosed();
        // update ID_ViTri for CTHD into DB
        if (self.CTHD_ChangingVT().ID !== undefined) {
            UpdateViTri_inCTHD_toDB(self.CTHD_ChangingVT().ID, item.ID);
        }
    }
    self.SaveVitri_Chosed = function () {
        // get tableName by ID
        var itemPB = $.grep(self.AllPhongBans(), function (x) {
            return x.ID === self.IDPhongBan_Chosing();
        });
        if (itemPB.length > 0) {
            var loaiHD = GetLoaiHoaDon_ofHDopening();
            var cacheName = lcListCTHD;
            if (loaiHD === 6) {
                cacheName = lcListCTHD_DoiTra;
            }
            var cthd = localStorage.getItem(cacheName);
            if (cthd !== null) {
                cthd = JSON.parse(cthd);
                cthd = UpdateViTri_inCacheCTHD(cthd, self.IDPhongBan_Chosing(), itemPB[0].TenViTri);
                localStorage.setItem(cacheName, JSON.stringify(cthd));
            }
            // bind again lst HangHoa
            var arr = $.grep(cthd, function (x) {
                return x.IDRandomHD === self.CTHD_ChangingVT().IDRandomHD;
            });
            self.HangHoaAfterAdds(arr);
            $('#modalPopupdoivitri').modal('hide');
        }
    }
    self.saveHD_OtherUser = function () {
        var itemHD = self.Modal_HoaDons();
        if (itemHD !== undefined) {
            var idRandomHD = itemHD.IDRandom;
            var _idDoiTuong = itemHD.ID_DoiTuong;
            // tim CTHoaDon t/u voi HoaDon
            var objCTAdd = [];
            var listAllCTHD = localStorage.getItem(lcListCTHD);
            if (listAllCTHD !== null) {
                listAllCTHD = JSON.parse(listAllCTHD);
                objCTAdd = GetCTHoaDon_FromArr(listAllCTHD, idRandomHD);
            }
            if (objCTAdd.length === 0) {
                ShowMessage_Danger('Vui lòng nhập chi tiết hóa đơn');
                SaveHD_RemoveDisable();
                return;
            }
            else {
                var msgErr = "";
                // Khong cho phep ban hang khi het ton kho
                var xuatAm = self.ThietLap().XuatAm;
                if (xuatAm === false) {
                    for (let i = 0; i < objCTAdd.length; i++) {
                        if (objCTAdd[i].LaHangHoa && objCTAdd[i].SoLuong > objCTAdd[i].TonKho) {
                            msgErr += objCTAdd[i].TenHangHoa + ", ";
                        }
                    }
                    if (msgErr !== "") {
                        msgErr = Remove_LastComma(msgErr);
                        ShowMessage_Danger('Không đủ số lượng tồn kho cho sản phẩm ' + msgErr);
                        SaveHD_RemoveDisable();
                        return false;
                    }
                }
                // check if Soluong = 0
                //for (let i = 0; i < objCTAdd.length; i++) {
                //    if (objCTAdd[i].SoLuong === 0) {
                //        msgErr += objCTAdd[i].TenHangHoa + ", ";
                //    }
                //}
                //if (msgErr !== "") {
                //    msgErr = Remove_LastComma(msgErr);
                //    ShowMessage_Danger('Chưa nhập số lượng cho hàng hóa ' + msgErr);
                //    SaveHD_RemoveDisable();
                //    return false;
                //}
                //msgErr = CheckTonKho_SameIDHangHoa_DifferenceDVT(objCTAdd);
                //if (msgErr !== '') {
                //    ShowMessage_Danger('Không đủ số lượng tồn kho cho sản phẩm ' + msgErr);
                //    SaveHD_RemoveDisable();
                //    return;
                //}
                // check if chua nhap so lo
                for (let i = 0; i < objCTAdd.length; i++) {
                    if (objCTAdd[i].QuanLyTheoLoHang) {
                        if (objCTAdd[i].ID_LoHang === null || objCTAdd[i].ID_LoHang === undefined) {
                            ShowMessage_Danger('Vui lòng nhập đầy đủ thông tin lô cho hàng hóa ');
                            SaveHD_RemoveDisable();
                            return;
                        }
                    }
                }

                if (_idDoiTuong === null || _idDoiTuong === undefined || _idDoiTuong === '' || _idDoiTuong === const_GuidEmpty) {
                    if (itemHD.PhaiThanhToan > itemHD.DaThanhToan + itemHD.KhachDaTra) {
                        msgErr = "Là khách lẻ, nên không cho phép nợ";
                        ShowMessage_Danger(msgErr);
                        SaveHD_RemoveDisable();
                        return false;
                    }
                }
                // update DonGia in CTHD if GiaBan > DonGia ban dau (update 21.12.2017)
                for (let i = 0; i < objCTAdd.length; i++) {
                    if (objCTAdd[i].GiaBan > objCTAdd[i].DonGia) {
                        objCTAdd[i].DonGia = objCTAdd[i].GiaBan;
                    }
                }
                // remove CTHD with QuanLyTheoLo, but ID_Lo== null
                objCTAdd = GetArrCTHD_withIDLoHangOtherNull(objCTAdd);
                // update status NVien before save
                var myData = {};
                var maHD = itemHD.MaHoaDon;
                // Neu la HoaDonoffline => giu nguyen ma
                if (maHD.indexOf('Copy') === -1 && maHD.indexOf('O') >= 0) {
                    itemHD.MaHoaDon = maHD;
                }
                else {
                    itemHD.MaHoaDon = null; // gan ma hoa don = null de khi save sinh MaHoaDon tu dong
                }
                // if HD is creat from HD DatHang --> not delete ID_HoaDon
                // get GhiChu_KhuyenMai = GhiChuKM_ofHH + GhiChuKM_HD
                var ghichuKMHD = '';
                for (let i = 0; i < objCTAdd.length; i++) {
                    if (objCTAdd[i].IsKhuyenMai && objCTAdd[i].TenKhuyenMai !== '') {
                        ghichuKMHD += objCTAdd[i].TenKhuyenMai + '<br /> ';
                    }
                }
                ghichuKMHD += itemHD.KhuyenMai_GhiChu;
                if (ghichuKMHD === undefined || ghichuKMHD.indexOf('undefined') > -1) {
                    ghichuKMHD = '';
                }
                itemHD.KhuyenMai_GhiChu = ghichuKMHD;
                // check NgayLapHD is null, and get
                var ngaylapHD = GetNgayLapHD_whenSave(itemHD.NgayLapHoaDon);
                itemHD.NgayLapHoaDon = ngaylapHD;
                itemHD.NguoiTao = userLogin;// assign again NguoiTao
                myData.objHoaDon = itemHD;
                myData.objCTHoaDon = objCTAdd;
                myData.IsSetGiaVonTrungBinh = self.ThietLap().GiaVonTrungBinh;
                var lstHD2 = localStorage.getItem(lcListHD);
                if (lstHD2 !== null) {
                    lstHD2 = JSON.parse(lstHD2);
                    // delete HD with MaHoaDon BG0000 (HD tao tu HD DatHang)
                    lstHD2 = $.grep(lstHD2, function (item) {
                        return item.MaHoaDon !== itemHD.MaHoaDonTraHang;
                    });
                    localStorage.setItem(lcListHD, JSON.stringify(lstHD2));
                }
                PostHD_SoQuy_SaveHD(myData, false);
                $('#hdOtherClient').modal('hide');
            }
        }
        else {
            ShowMessage_Danger('Vui lòng nhập thông tin hóa đơn');
            SaveHD_RemoveDisable();
            return;
        }
    }
    self.ClickTab_HangHoa = function () {
        $('#banhangsodo').hide();
        // when this HD was ThanhToan by other user --> read again infor HD
        BindHD_CTHDafterSave();
        Call_6Func(false);
    }
    self.HDOther_MoPhieu = function () {
        $('#hdOtherClient').modal('hide');
        $('#banhangsodo').hide();
        var hdOpening = self.Modal_HoaDons();
        var idRandom = hdOpening.IDRandom;
        _maHoaDon = hdOpening.MaHoaDon;// must assign _maHoaDon (used to bind infor HD)
        self.IDPhongBan_Chosing(hdOpening.ID_ViTri);

        // update Status HD = 1 --> opening hd other user
        var lstHD = localStorage.getItem(lcListHD);
        if (lstHD !== null) {
            lstHD = JSON.parse(lstHD);
            for (let i = 0; i < lstHD.length; i++) {
                if (lstHD[i].IDRandom === idRandom) {
                    lstHD[i].Status = 1;
                    break;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(lstHD));
        }
        var arrHangHoa = [];
        var cthd = localStorage.getItem(lcListCTHD);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            arrHangHoa = $.grep(cthd, function (x) {
                return x.IDRandomHD === idRandom;
            })
        }
        self.HangHoaAfterAdds(arrHangHoa);
        GetInForCustomer_byID(hdOpening.ID_DoiTuong);
        self.SetNhanVien(hdOpening.ID_NhanVien);
        self.SetBangGia(hdOpening.ID_BangGia);
        self.SetChiNhanh(hdOpening.ID_DonVi);

        //$('#tr-congnoDH').css('display', 'none');
        self.HoaDons().SetData(hdOpening);
        OnOff_Timer(hdOpening.NgayLapHoaDon);
        GetCurrentPage_byMaHoaDon(_maHoaDon);
        $('#ddlDMChungTus').removeAttr('disabled');
        $('#txtSearchHH').focus();
        ClearTextSearch();
        Call_6Func();
    }
    $("#banhangsodo").on('LoadSoDoPhong', function () {
        self.ClickTab_PhongBan(false);
    });

    // form add new product
    self.ShowForm_NewProduct = function () {
        $('#partialAddProduct').modal('show');
        partialProduct.AddProductSuccess(false);
        partialProduct.ID_NhanVien(_idNhanVien);
        partialProduct.ID_DonVi(id_DonVi);
        partialProduct.UserLogin(userLogin);
        partialProduct.newProduct(new NewProduct());
        $('.tenNhomHH').text('---Chọn nhóm---');
        $('#divgiavon').css('display', '');
        $('#divtonkho').css('display', '');
        $('#title-partialproduct').text('Thêm mới hàng hóa');
        var arr = $.grep(self.NhomHangHoas(), function (x) {
            return x.LaNhomHangHoa === true;
        });
        partialProduct.NhomHangHoas_ByKind(arr);
    }
    $('#partialAddProduct').on('hidden.bs.modal', function () {
        if (partialProduct.AddProductSuccess()) {
            self.Click_ChoseHangLo(partialProduct.ProductAfterAdd());
            db.DM_HangHoa.put(partialProduct.ProductAfterAdd());
        }
    })
    // calendar
    self.ShowCalendar = function () {
        partialCalendar.ID_DonVi(id_DonVi);
        partialCalendar.ID_NhanVien(_idNhanVien);
        partialCalendar.UserLogin(userLogin);
        partialCalendar.Calendar_ResetNew();

        //check if using service
        if (self.ChiTietDoiTuong() !== null && self.ChiTietDoiTuong().length > 0) {
            partialCalendar.newCalendar().ID_KhachHang(self.ChiTietDoiTuong()[0].ID);
            $('#calendar_txtKH').val(self.ChiTietDoiTuong()[0].TenDoiTuong);
            if (self.HangHoaAfterAdds().length > 0) {
                for (let i = 0; i < self.HangHoaAfterAdds().length; i++) {
                    let itemFor = self.HangHoaAfterAdds()[i];
                    if (itemFor.LaHangHoa === false && itemFor.ID_ChiTietGoiDV !== null && itemFor.ID_ChiTietGoiDV !== const_GuidEmpty) {
                        partialCalendar.ListServiceChosed.push(itemFor);
                    }
                }
                $('#partialCalendar').modal('show');
            }
            else {
                // tim hoadon su dung gan nhat
                ajaxHelper(BHHoaDonUri + 'GetInvoiceUseServive_Newest?idKhachHang=' + self.ChiTietDoiTuong()[0].ID, 'POST').done(function (x) {
                    if (x.res === true) {
                        for (let i = 0; i < x.data.length; i++) {
                            let itemFor = x.data[i];
                            partialCalendar.ListServiceChosed.push(itemFor);
                        }
                        $('#partialCalendar').modal('show');
                    }
                });
            }
        }
        else {
            $('#partialCalendar').modal('show');
        }
    }

    function AssignValueHoaDon_ToPhieuThu(hd) {
        var cusDoing = self.ChiTietDoiTuong();
        var maKH = cusDoing.length > 0 ? cusDoing[0].MaDoiTuong : 'KL';
        var tenKH = cusDoing.length > 0 ? cusDoing[0].TenDoiTuong : 'Khách lẻ';
        var diemKH = cusDoing.length > 0 ? cusDoing[0].TongTichDiem : 0;
        var idCus = cusDoing.length > 0 ? cusDoing[0].ID : null;
        var chenhlehTraMua = hd.ChenhLechTraMua;
        chenhlehTraMua = chenhlehTraMua ? chenhlehTraMua : 0;

        var obj = {
            ID: hd.ID,// 1.kh, 2.ncc, 3.bh
            LoaiDoiTuong: 1,// 1.kh, 2.ncc, 3.bh
            LoaiHoaDon: hd.LoaiHoaDon,
            MaHoaDon: hd.MaHoaDon,
            HoanTraTamUng: hd.HoanTraTamUng,
            PhaiThanhToan: hd.PhaiThanhToan,
            PhaiThanhToanBaoHiem: hd.PhaiThanhToanBaoHiem,
            TongThanhToan: hd.TongThanhToan,
            TongTichDiem: diemKH,
            ThucThu: hd.DaThanhToan,
            ConNo: 0,
            DienGiai: hd.DienGiai,
            ID_DoiTuong: idCus,
            ID_BaoHiem: hd.ID_BaoHiem,
            MaDoiTuong: maKH,
            TenDoiTuong: tenKH,
            ID_KhoanThuChi: null,
            TenBaoHiem: hd.TenBaoHiem,
            NgayLapHoaDon: hd.NgayLapHoaDon,
            ID_NhanVien: hd.ID_NhanVien,
            ID_DonVi: hd.ID_DonVi,
            NguoiTao: userLogin,
            ID_PhieuTiepNhan: hd.ID_PhieuTiepNhan,
            DaThanhToan: hd.DaThanhToan, // used to don't click btnThanhToan
            SoDuDatCoc: hd.SoDuDatCoc,
            ChenhLechTraMua: chenhlehTraMua
        }
        vmThanhToanGara.inforHoaDon = obj;
    }

    self.ShowModalThanhToan = function () {
        var hd = self.HoaDons();
        var cusDoing = self.ChiTietDoiTuong();
        var maKH = cusDoing.length > 0 ? cusDoing[0].MaDoiTuong : 'KL';
        var tenKH = cusDoing.length > 0 ? cusDoing[0].TenDoiTuong : 'Khách lẻ';
        var diemKH = cusDoing.length > 0 ? cusDoing[0].TongTichDiem : 0;
        var idCus = cusDoing.length > 0 ? cusDoing[0].ID : null;
        var phaiTTBaoHiem = formatNumberToFloat(hd.PhaiThanhToanBaoHiem());
        if (hd.ID_BaoHiem() !== null && hd.LoaiHoaDon() !== 6) {
            if (phaiTTBaoHiem === 0) {
                ShowMessage_Danger('Vui lòng nhập số tiền bảo hiểm chi trả');
                return;
            }
        }

        var phaiTT =
            formatNumberToFloat(hd.TongTienHang())
            - formatNumberToFloat(hd.TongGiamGiaKM_HD())
            - formatNumberToFloat(hd.TongTienBHDuyet())
            + hd.KhauTruTheoVu()
            + hd.GiamTruBoiThuong()
            + hd.TongThueKhachHang();
        phaiTT = hd.LoaiHoaDon() === 6 ? hd.PhaiThanhToan() - hd.TongTienTra() : phaiTT;
        phaiTT = Math.abs(phaiTT);// chỉ trả hàng - không mua
        var conno = phaiTTBaoHiem > 0 ? phaiTTBaoHiem : 0;

        var obj = {
            MaHoaDon: '',
            IDRandom: hd.IDRandom(),
            LoaiDoiTuong: 1,// 1.kh, 2.ncc, 3.bh
            LoaiHoaDon: hd.LoaiHoaDon(),
            SoDuDatCoc: hd.SoDuDatCoc(),
            HoanTraTamUng: hd.HoanTraTamUng(),
            PhaiThanhToan: phaiTT,
            PhaiThanhToanBaoHiem: hd.PhaiThanhToanBaoHiem(),
            TongThanhToan: hd.TongThanhToan(),
            TongTienThue: hd.TongTienThue(),
            TongTichDiem: diemKH,
            ThucThu: phaiTT - hd.KhachDaTra(),// neu dathang va thanhtoan truoc
            ConNo: conno,
            DienGiai: hd.DienGiai(),
            ID_DoiTuong: idCus,
            MaDoiTuong: maKH,
            TenDoiTuong: tenKH,
            TenBaoHiem: hd.TenBaoHiem(),
            NgayLapHoaDon: hd.NgayLapHoaDon(),
            ID_NhanVien: _idNhanVien,
            ID_DonVi: id_DonVi,
            NguoiTao: userLogin,
            ID_PhieuTiepNhan: hd.ID_PhieuTiepNhan(),
            DaThanhToan: hd.DaThanhToan(), // used to don't click btnThanhToan
            KhachDaTra: hd.KhachDaTra(), // used when update hd
            BaoHiemDaTra: hd.BaoHiemDaTra(), // used when update hd
        }
        vmThanhToanGara.listData.AccountBanks = self.AllAccountBank();
        vmThanhToanGara.listData.ChietKhauHoaDons = vmHoaHongHoaDon.listData.ChietKhauHoaDons;
        vmThanhToanGara.showModalThanhToan(obj);
    }

    $('#ThemMoiKhachHang').on('hidden.bs.modal', function () {
        if (vmThemMoiKhach.saveOK) {
            if (vmThemMoiKhach.isNew) {
                newModelBanLe.Change_KhachHang(vmThemMoiKhach.customerDoing.ID);
            }
            else {
                GetInforKhachHangFromDB_ByID(vmThemMoiKhach.customerDoing.ID);
            }
        }
    })

    function checkIsShowbtnSave() {
        var number = 0;
        $('#ListBtnGroupSave button').each(function () {
            if ($(this).css('display') !== 'none') {
                number += 1;
            }
        });
        var width = 100;
        switch (number) {
            case 1:
                $('#btnSave').attr('style', 'width: 100% !important');
                break;
            case 2:
                width = 75;
                switch (self.HoaDons().LoaiHoaDon()) {
                    case 1:
                    case 25:
                        $('#btnSave').attr('style', 'width: auto !important');
                        break;
                    case 3:
                        if (self.HoaDons().ID() === const_GuidEmpty) {
                            $('#btnSave').attr('style', 'width: 75% !important');
                            $('#btnPrintDraft').attr('style', 'width: 25% !important');
                        }
                        else {
                            $('#btnSave').attr('style', 'width: 25% !important');
                            $('#btnTaoHD').attr('style', 'width: 75% !important');
                        }
                        break;
                    case 6:
                        $('#btnSave').attr('style', 'width: 65% !important');
                        $('#btnThanhToan').attr('style', 'width: 35% !important');
                        break;
                }
                break;
            case 3:
                width = 50;
                $('#btnSave').attr('style', 'width: auto !important');
                break;
        }
        $('#btnTaoHD').attr('style', 'width: ' + width + '% !important');
        if (self.HoaDons().LoaiHoaDon() !== 6) {
            $('#btnThanhToan').attr('style', 'width: ' + width + '% !important');
        }
    }

    self.showPopupDuyetGia = function () {
        $('.applyDonGiaBH').show();
    }

    $('#ThongTinThanhToanKHNCC').on('hidden.bs.modal', function () {
        if (!vmThanhToanGara.saveOK) {
            // if show modal sau do click btn Huy: reset tien dathanhtoan
            vmThanhToanGara.PhieuThuKhach.DaThanhToan = 0;
        }
    })


    $('#vmEditHoaHongDV').on('hidden.bs.modal', function () {
        if (vmHoaHongDV.saveOK) {
            if (vmHoaHongDV.isNew) {
                if (!vmHoaHongDV.isCombo) {
                    self.AgreeNhanVien_TVTH();
                }
                else {
                    self.Combo_AgreeNhanVienTVTH();
                }
            }
        }
    })

    self.AgreeBaoHiem = function () {
        var obj = vmThongTinThanhToanBaoHiem;
        var thueBH = formatNumberToFloat(obj.TongTienThueBaoHiem);
        var tongBHDuyet = formatNumberToFloat(obj.TongTienBHDuyet);
        var khautru = formatNumberToFloat(obj.KhauTruTheoVu);
        var chetai = formatNumberToFloat(obj.GiamTruBoiThuong);
        var notTaxKH = false;

        var cthd = localStorage.getItem(lcListCTHD);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
        }
        else {
            cthd = [];
        }

        var hd = localStorage.getItem(lcListHD);
        if (hd !== null) {
            hd = JSON.parse(hd);
            for (let i = 0; i < hd.length; i++) {
                if (hd[i].IDRandom === obj.IDRandomHD) {
                    hd[i].TongTienBHDuyet = tongBHDuyet;
                    hd[i].PTThueBaoHiem = obj.PTThueBaoHiem;
                    hd[i].TongTienThueBaoHiem = thueBH;
                    hd[i].SoVuBaoHiem = obj.SoVuBaoHiem;
                    hd[i].KhauTruTheoVu = khautru;
                    hd[i].PTGiamTruBoiThuong = obj.PTGiamTruBoiThuong;
                    hd[i].GiamTruBoiThuong = chetai;
                    hd[i].BHThanhToanTruocThue = obj.BHThanhToanTruocThue;
                    hd[i].PhaiThanhToanBaoHiem = obj.PhaiThanhToanBaoHiem;
                    hd[i].CongThucBaoHiem = obj.CongThucChosed;

                    let tongThueCT = 0;
                    for (let i = 0; i < cthd.length; i++) {
                        if (cthd[i].IDRandomHD === obj.IDRandomHD) {
                            tongThueCT += cthd[i].SoLuong * cthd[i].TienThue;
                        }
                    }
                    // lan1. BH thue 100% --> thue CT = 0
                    // lan2. sua lai PTThueHD --> don't reset TongTienThu
                    if (tongThueCT === 0 && hd[i].PTThueHoaDon != 0) {
                        hd[i].TongTienThue = thueBH;
                        hd[i].TongThueKhachHang = 0;
                    }
                    else {
                        let thueKH = hd[i].TongTienThue - thueBH;
                        if (thueKH <= 0) {
                            notTaxKH = true;
                            thueKH = 0;
                            hd[i].PTThueHoaDon = 0;
                        }
                        hd[i].TongThueKhachHang = thueKH;
                        hd[i].TongTienThue = thueKH + thueBH;
                    }

                    hd[i].PhaiThanhToan = formatNumberToFloat(hd[i].TongTienHang)
                        - formatNumberToFloat(hd[i].TongGiamGiaKM_HD)
                        - tongBHDuyet + chetai + khautru + hd[i].TongThueKhachHang;
                    hd[i].TongThanhToan = hd[i].PhaiThanhToan + hd[i].PhaiThanhToanBaoHiem;
                    break;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(hd));

            // if change tongbh duyet: reset dongiabh in ctiet
            if (formatNumberToFloat(obj.TongTienBHDuyetOld) !== tongBHDuyet) {
                for (let i = 0; i < cthd.length; i++) {
                    if (cthd[i].IDRandomHD === obj.IDRandomHD) {
                        cthd[i].DonGiaBaoHiem = 0;
                    }
                }
            }
            // reset tax in cthd
            if (notTaxKH) {
                for (let i = 0; i < cthd.length; i++) {
                    if (cthd[i].IDRandomHD === obj.IDRandomHD) {
                        cthd[i].TienThue = 0;
                        cthd[i].PTThue = 0;
                        cthd[i].ThanhToan = cthd[i].ThanhTien;

                        for (let j = 0; j < cthd[i].DM_LoHang.length; j++) {
                            cthd[i].DM_LoHang[j].TienThue = 0;
                            cthd[i].DM_LoHang[j].PTThue = 0;
                            cthd[i].DM_LoHang[j].ThanhToan = cthd[i].DM_LoHang[j].ThanhTien;
                        }

                        for (let j = 0; j < cthd[i].HangCungLoais.length; j++) {
                            cthd[i].HangCungLoais[j].TienThue = 0;
                            cthd[i].HangCungLoais[j].PTThue = 0;
                            cthd[i].HangCungLoais[j].ThanhToan = cthd[i].HangCungLoais[j].ThanhTien;
                        }
                    }
                }
            }
            localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
        }
    }

    $('#ThongTinThanhToanBaoHiem').on('hidden.bs.modal', function () {
        var obj = vmThongTinThanhToanBaoHiem;
        if (obj.saveOK) {
            self.AgreeBaoHiem();
            UpdateCacheHDLe(obj.IDRandomHD, false, 5);
            BindHD_byIDRandom(obj.IDRandomHD);
            BindCTHD_byIDRandomHD(obj.IDRandomHD);
        }
    })

    self.HeaderBH_ChangeType = function (type) {
        var $this = $(event.currentTarget);
        $this.closest('ul').prev().text($this.find('a').text());
        self.HoaDons().HeaderBH_Type(parseInt(type));
    }

    self.EditHeaderBH = function () {
        let obj = $(event.currentTarget);
        if (formatNumberToFloat(obj.val()) > 100) {
            obj.val(100);
            self.HoaDons().HeaderBH_GiaTriPtram(100);
        }
    }

    function UpdateDonGiaBaoHiem_byHeaderBH(idRandom = null, itemCT) {
        var idRandomHD = self.HoaDons().IDRandom();
        var tongDuyet = 0, tongtien = 0;
        var gtri = self.HoaDons().HeaderBH_GiaTriPtram();

        var cthd = localStorage.getItem(lcListCTHD);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
        }
        else {
            cthd = [];
        }

        if (idRandom !== null) {
            let type = parseInt(self.HoaDons().HeaderBH_Type());
            if (itemCT.QuanLyTheoLoHang) {
                if (itemCT.LotParent) {
                    for (let i = 0; i < cthd.length; i++) {
                        if (cthd[i].IDRandom === idRandom && cthd[i].ChatLieu !== '4') {
                            switch (type) {
                                case 1:
                                    cthd[i].DonGiaBaoHiem = (cthd[i].GiaBan - cthd[i].TienChietKhau) * gtri / 100;
                                    break;
                                case 2:
                                    cthd[i].DonGiaBaoHiem = cthd[i].GiaBan * gtri / 100;
                                    break;
                            }
                            $('#giabh_' + idRandom).val(formatNumber3Digit(cthd[i].DonGiaBaoHiem));
                            break;
                        }
                    }
                }
                else {
                    for (let i = 0; i < cthd.length; i++) {
                        for (let j = 0; j < cthd[i].DM_LoHang.length; j++) {
                            if (cthd[i].DM_LoHang[j].IDRandom === idRandom && cthd[i].DM_LoHang[j].ChatLieu !== '4') {
                                switch (type) {
                                    case 1:
                                        cthd[i].DM_LoHang[j].DonGiaBaoHiem = (cthd[i].DM_LoHang[j].GiaBan - cthd[i].DM_LoHang[j].TienChietKhau) * gtri / 100;
                                        break;
                                    case 2:
                                        cthd[i].DM_LoHang[j].DonGiaBaoHiem = cthd[i].DM_LoHang[j].GiaBan * gtri / 100;
                                        break;
                                }
                                $('#giabh_' + idRandom).val(formatNumber3Digit(cthd[i].DM_LoHang[j].DonGiaBaoHiem));
                                break;
                            }
                        }
                    }
                }
            }
            else {
                if (itemCT.LaConCungLoai) {
                    for (let i = 0; i < cthd.length; i++) {
                        for (let j = 0; j < cthd[i].HangCungLoais.length; j++) {
                            if (cthd[i].HangCungLoais[j].IDRandom === idRandom && cthd[i].HangCungLoais[j].ChatLieu !== '4') {
                                switch (type) {
                                    case 1:
                                        cthd[i].HangCungLoais[j].DonGiaBaoHiem = (cthd[i].HangCungLoais[j].GiaBan - cthd[i].HangCungLoais[j].TienChietKhau) * gtri / 100;
                                        break;
                                    case 2:
                                        cthd[i].HangCungLoais[j].DonGiaBaoHiem = cthd[i].HangCungLoais[j].GiaBan * gtri / 100;
                                        break;
                                }
                                $('#giabh_' + idRandom).val(formatNumber3Digit(cthd[i].HangCungLoais[j].DonGiaBaoHiem));
                            }
                        }
                    }
                }
                else {
                    for (let i = 0; i < cthd.length; i++) {
                        if (cthd[i].IDRandom === idRandom && cthd[i].ChatLieu !== '4') {
                            switch (type) {
                                case 1:
                                    cthd[i].DonGiaBaoHiem = (cthd[i].GiaBan - cthd[i].TienChietKhau) * gtri / 100;
                                    break;
                                case 2:
                                    cthd[i].DonGiaBaoHiem = cthd[i].GiaBan * gtri / 100;
                                    break;
                            }
                            $('#giabh_' + idRandom).val(formatNumber3Digit(cthd[i].DonGiaBaoHiem));
                            break;
                        }
                    }
                }
            }
        }
        else {
            switch (self.HoaDons().HeaderBH_Type()) {
                case 1:
                    tongtien = formatNumberToFloat(self.HoaDons().TongTienHang());
                    for (let i = 0; i < cthd.length; i++) {
                        if (cthd[i].IDRandomHD === idRandomHD) {
                            let itFor = cthd[i];
                            if (itFor.ChatLieu !== '4') {
                                cthd[i].DonGiaBaoHiem = (itFor.GiaBan - itFor.TienChietKhau) * gtri / 100;
                            }
                            for (let j = 0; j < itFor.DM_LoHang.length; j++) {
                                let forIn = itFor.DM_LoHang[j];
                                if (forIn.ChatLieu !== '4') {
                                    forIn.DonGiaBaoHiem = (forIn.GiaBan - forIn.TienChietKhau) * gtri / 100;
                                }
                            }
                            for (let j = 0; j < itFor.HangCungLoais.length; j++) {
                                let forIn = itFor.HangCungLoais[j];
                                if (forIn.ChatLieu !== '4') {
                                    forIn.DonGiaBaoHiem = (forIn.GiaBan - forIn.TienChietKhau) * gtri / 100;
                                }
                            }
                        }
                    }
                    break;
                case 2:
                    tongtien = formatNumberToFloat(self.HoaDons().TongTienHangChuaCK());
                    for (let i = 0; i < cthd.length; i++) {
                        if (cthd[i].IDRandomHD === idRandomHD) {
                            let itFor = cthd[i];
                            if (itFor.ChatLieu !== '4') {
                                cthd[i].DonGiaBaoHiem = itFor.GiaBan * gtri / 100;
                            }

                            for (let j = 0; j < itFor.DM_LoHang.length; j++) {
                                let forIn = itFor.DM_LoHang[j];
                                if (forIn.ChatLieu !== '4') {
                                    forIn.DonGiaBaoHiem = forIn.GiaBan * gtri / 100;
                                }
                            }
                            for (let j = 0; j < itFor.HangCungLoais.length; j++) {
                                let forIn = itFor.HangCungLoais[j];
                                if (forIn.ChatLieu !== '4') {
                                    forIn.DonGiaBaoHiem = forIn.GiaBan * gtri / 100;
                                }
                            }
                        }
                    }
                    break;
            }
            tongDuyet = tongtien * gtri / 100;
            self.HoaDons().TongTienBHDuyet(tongDuyet);
        }
        localStorage.setItem(lcListCTHD, JSON.stringify(cthd));
    }

    self.HeaderBH_Apply = function () {
        if (self.HoaDons().LoaiHoaDon() === 6) {
            return;
        }
        $('#popupbaohiem').hide();

        UpdateDonGiaBaoHiem_byHeaderBH();

        var idRandomHD = self.HoaDons().IDRandom();
        var hd = localStorage.getItem(lcListHD);
        if (hd !== null) {
            hd = JSON.parse(hd);
            for (let i = 0; i < hd.length; i++) {
                if (hd[i].IDRandom === idRandomHD) {
                    hd[i].HeaderBH_GiaTriPtram = self.HoaDons().HeaderBH_GiaTriPtram();
                    hd[i].HeaderBH_Type = self.HoaDons().HeaderBH_Type();
                    break;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(hd));
        }

        vmThongTinThanhToanBaoHiem.SetInforBaoHiem_fromHoaDon(self.HoaDons());
        vmThongTinThanhToanBaoHiem.Caculator();
        self.AgreeBaoHiem();
        UpdateCacheHDLe(idRandomHD, false, 5);
        BindHD_byIDRandom(idRandomHD);
        BindCTHD_byIDRandomHD(idRandomHD);
    }

    self.showLichBaoDuong = function () {
        var idCar = self.ThongTinPhieuTiepNhan().ID_Xe;
        if (!commonStatisJs.CheckNull(idCar)) {
            vmNhatKyBaoDuong.showModal();
            vmNhatKyBaoDuong.GetNhatKyBaoDuong_byCar(idCar);
        }
    }

    self.BaoDuong_Agree = async function () {
        var baoduong = vmNhatKyBaoDuong;
        if (baoduong.saveOK) {
            var idRandomHD = self.HoaDons().IDRandom();
            var cthd = localStorage.getItem(lcListCTHD);
            if (cthd !== null) {
                cthd = JSON.parse(cthd);

                var cthdOpening = $.grep(cthd, function (x) {
                    return x.IDRandomHD === idRandomHD;
                })
                var hdOpening = {
                    IDRandom: idRandomHD,
                    MaHoaDon: self.HoaDons().MaHoaDon(),
                    LoaiHoaDon: self.HoaDons().LoaiHoaDon(),
                    TenViTriHD: self.HoaDons().TenViTriHD(),
                    ID_ViTri: self.HoaDons().ID_ViTri(),
                }

                for (var k = 0; k < baoduong.listApply.length; k++) {
                    let forOut = baoduong.listApply[k];
                    let ex = $.grep(cthdOpening, function (x) {
                        return x.ID_HangHoa === forOut.ID_HangHoa;
                    })
                    if (ex.length > 0) {
                        for (let i = 0; i < cthd.length; i++) {
                            let itFor = cthd[i];
                            if (cthd[i].IDRandomHD === self.HoaDons().IDRandom()) {
                                // neu hd cung 1 hang - nhieudvt, or hang cungloai
                                /// uu tien cho hang dautien
                                if (itFor.ID_HangHoa === forOut.ID_HangHoa) {
                                    cthd[i].ID_LichBaoDuong = forOut.ID;
                                    break;
                                }
                            }
                        }
                    }
                    else {
                        let param = {
                            ID_ChiNhanh: id_DonVi,
                            ID_BangGia: self.selectedGiaBan() === null ? const_GuidEmpty : self.selectedGiaBan(),
                            TextSearch: forOut.MaHangHoa,
                            LaHangHoa: '%%',
                            QuanLyTheoLo: '%%',
                            ConTonKho: false,
                        };
                        await ajaxHelper("/api/DanhMuc/DM_HangHoaAPI/" + "Gara_JqAutoHangHoa", 'POST', param).done(function (x) {
                            if (x.res && x.dataSoure.length > 0) {
                                x.dataSoure[0].SoLuong = 1;
                                x.dataSoure[0].ID_HangHoa = x.dataSoure[0].ID;
                                x.dataSoure[0].ThanhPhanComBo = [];
                                let obj = newHangHoa(x.dataSoure[0], hdOpening, false);
                                obj.ID_LichBaoDuong = forOut.ID;
                                cthd.push(obj);
                            }
                        });
                    }
                }
                localStorage.setItem(lcListCTHD, JSON.stringify(cthd));

                UpdateCacheHDLe(idRandomHD, false);
                BindCTHD_byIDRandomHD(idRandomHD);
                BindHD_byIDRandom(idRandomHD);
            }
        }
    }

    $('#vmNhatKyBaoDuong').on('hidden.bs.modal', function () {
        if (vmNhatKyBaoDuong.saveOK) {
            self.BaoDuong_Agree();
        }
    })

    // combo
    function UpdateThanhPhanCombo(idRandomPr, comboDoing, isDoiTra = false) {
        //var idRandomPr = ctParent.IDRandom;
        var idRandom = comboDoing.IDRandom;
        var cacheName = lcListCTHD;
        if (isDoiTra) {
            cacheName = lcListCTHD_DoiTra;
        }
        var cthd = localStorage.getItem(cacheName);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            for (let i = 0; i < cthd.length; i++) {
                if (cthd[i].IDRandom === idRandomPr) {
                    for (let j = 0; j < cthd[i].ThanhPhanComBo.length; j++) {
                        let forIn = cthd[i].ThanhPhanComBo[j];
                        if (forIn.IDRandom === idRandom) {
                            if (forIn.LoaiHoaDon === 1 || forIn.LoaiHoaDon === 25) {
                                if (forIn.LaPTPhiDichVu) {
                                    comboDoing.TongPhiDichVu = Math.round(forIn.PhiDichVu * comboDoing.DonGia * comboDoing.SoLuong / 100);
                                }
                                else {
                                    comboDoing.TongPhiDichVu = forIn.PhiDichVu * comboDoing.SoLuong;
                                }
                            }
                            cthd[i].ThanhPhanComBo[j] = comboDoing;
                            break;
                        }
                    }
                    break;
                }
            }
            localStorage.setItem(cacheName, JSON.stringify(cthd));
        }
    }

    self.Combo_editSale = function (item, itemPr, isDoiTra) {
        var idRandom = item.IDRandom;
        var $this = $(event.currentTarget);

        var ctDoing = FindCTHD_isDoing(itemPr, isDoiTra);
        if (ctDoing !== null) {
            var combo = ctDoing.ThanhPhanComBo;
            var comboDoing = null;
            for (let i = 0; i < combo.length; i++) {
                let itFor = combo[i];
                if (itFor.IDRandom === idRandom) {
                    if (formatNumberToFloat(itFor.GiaBan) === 0) {
                        return;
                    }
                    formatNumberObj($this);

                    let ck = 0, ptCK = 0;
                    let ckNew = formatNumberToFloat($this.val())
                    if ($('#vnd_' + idRandom).hasClass('active-re')) {
                        if (ckNew > 100) {
                            $this.val(100);
                            ckNew = 100;
                        }
                        ck = itFor.GiaBan * ckNew / 100;
                        ptCK = ckNew;
                    }
                    else {
                        // neu giam gia > gia cu
                        if (ckNew > itFor.GiaBan) {
                            $this.val(formatNumber3Digit(itFor.GiaBan));
                            ckNew = itFor.GiaBan;
                        }
                        ck = ckNew;
                    }

                    if (itFor.PTThue > 0) {
                        itFor.TienThue = itFor.PTThue * (itFor.GiaBan - ck) / 100;
                        $('#tax_' + idRandom).val(formatNumber3Digit(itFor.TienThue));
                    }
                    itFor.TienChietKhau = ck;
                    itFor.PTChietKhau = ptCK;
                    itFor.ThanhTien = itFor.SoLuong * (itFor.DonGia - itFor.TienChietKhau);
                    itFor.ThanhToan = RitFor.SoLuong * (itFor.DonGia - itFor.TienChietKhau + itFor.TienThue);
                    comboDoing = itFor;

                    $('#sum-f_' + idRandom).val(formatNumber3Digit(itFor.ThanhToan));
                    $('#ck_' + idRandom).text(formatNumber3Digit(itFor.TienChietKhau));
                    $('#ck_' + idRandom).parent().css('display', ck > 0 ? '' : 'none');
                    $('#tax_' + idRandom).parent().css('display', itFor.TienThue > 0 ? '' : 'none');
                    break;
                }
            }
            if (comboDoing !== null) {
                UpdateThanhPhanCombo(itemPr.IDRandom, comboDoing, isDoiTra);
            }
            Combo_UpdateChietKhauNV(itemPr.IDRandom, idRandom, isDoiTra);
        }
    }
    self.Combo_clickVND = function (item, itemPr, isDoiTra) {
        var idRandom = item.IDRandom;
        var $this = $('#vnd_' + idRandom);
        if ($this.hasClass('active-re')) {
            $this.removeClass('active-re');
        }
        else {
            $this.addClass('active-re');
        }

        var ctDoing = FindCTHD_isDoing(itemPr, isDoiTra);
        if (ctDoing !== null) {
            var combo = ctDoing.ThanhPhanComBo;
            var comboDoing = null;
            for (let i = 0; i < combo.length; i++) {
                let itFor = combo[i];
                if (itFor.IDRandom === idRandom) {
                    if (itFor.GiaBan !== 0) {
                        let ptCK = itFor.PTChietKhau;
                        let tienCK = itFor.TienChietKhau;
                        if ($this.hasClass('active-re')) {
                            ptCK = tienCK / itFor.GiaBan * 100;
                            $('#pri-g_' + idRandom).val(ptCK);
                        }
                        else {
                            $('#pri-g_' + idRandom).val(formatNumber3Digit(tienCK));
                            ptCK = 0;
                        }
                        itFor.PTChietKhau = ptCK;
                        itFor.TienChietKhau = tienCK;
                        comboDoing = itFor;
                    }
                    break;
                }
            }
            if (comboDoing !== null) {
                UpdateThanhPhanCombo(itemPr.IDRandom, comboDoing, isDoiTra);
            }
        }
    }

    self.Combo_editPrice = function (item, itemPr, isDoiTra) {
        var idRandom = item.IDRandom;
        var idRandomHD = itemPr.IDRandomHD;
        var loaiHD = self.HoaDons().LoaiHoaDon();
        var $this = $(event.currentTarget);
        formatNumberObj($this);
        var priceNew = formatNumberToFloat($this.val());

        var ctDoing = FindCTHD_isDoing(itemPr, isDoiTra);
        if (ctDoing !== null) {

            var combo = ctDoing.ThanhPhanComBo;
            var comboDoing = null;
            for (let i = 0; i < combo.length; i++) {
                let itFor = combo[i];
                if (itFor.IDRandom === idRandom) {
                    let ck = itFor.TienChietKhau;
                    let thue = itFor.TienThue;

                    if (parseInt(itFor.ChatLieu) === 4) {
                        ShowMessage_Danger('Dịch vụ thuộc gói đã mua. Không thay đổi đơn giá');
                        $this.val(formatNumber3Digit(itFor.GiaBan));
                        return false;
                    }

                    if (priceNew === 0) {
                        ck = 0;
                        thue = 0;
                    }
                    // caculator again tienGiam, newPrice
                    if (itFor.PTChietKhau > 0) {
                        ck = itFor.PTChietKhau * priceNew / 100;
                    }
                    if (itFor.PTThue > 0) {
                        thue = itFor.PTThue * (priceNew - ck) / 100;
                    }

                    itFor.DonGia = priceNew;
                    itFor.GiaBan = priceNew;
                    itFor.TienChietKhau = ck;
                    itFor.TienThue = thue;
                    itFor.ThanhTien = itFor.SoLuong * (priceNew - ck);
                    itFor.ThanhToan = itFor.SoLuong * (priceNew - ck + thue);
                    comboDoing = itFor;

                    $('#sum-f_' + idRandom).val(formatNumber3Digit(itFor.ThanhToan));
                    $('#ck_' + idRandom).text(formatNumber3Digit(itFor.TienChietKhau));
                    $('#tax_' + idRandom).text(formatNumber3Digit(itFor.TienThue));
                    $('#ck_' + idRandom).parent().css('display', ck > 0 ? '' : 'none');
                    $('#tax_' + idRandom).parent().css('display', thue > 0 ? '' : 'none');
                    break;
                }
            }
            if (comboDoing !== null) {
                UpdateThanhPhanCombo(itemPr.IDRandom, comboDoing, isDoiTra);
            }
            if (loaiHD === 3) {
                Update_StatusXuLy_ofHDDatHang(idRandomHD);
            }
            Combo_UpdateChietKhauNV(itemPr.IDRandom, idRandom, isDoiTra);
            var keyCode = event.keyCode || event.which;
            if (keyCode === 13) {
                let char = '';
                if (isDoiTra) {
                    char = 'priceTH_';
                }
                Combo_FocusLiNext(ctDoing, idRandom, char, isDoiTra);
            }
        }
    }
    self.Combo_editSumPrice = function (item, itemPr, isDoiTra) {
        var idRandom = item.IDRandom;
        var idRandomHD = itemPr.IDRandomHD;
        var loaiHD = self.HoaDons().LoaiHoaDon();
        var $this = $(event.currentTarget);
        formatNumberObj($this);
        var sumPrice = formatNumberToInt($this.val());

        var ctDoing = FindCTHD_isDoing(itemPr, isDoiTra);
        if (ctDoing !== null) {

            var combo = ctDoing.ThanhPhanComBo;
            var comboDoing = null;
            for (let i = 0; i < combo.length; i++) {
                let itFor = combo[i];
                if (itFor.IDRandom === idRandom) {
                    let soluong = itFor.SoLuong;
                    let priceOld = itFor.GiaBan;

                    if (parseInt(itFor.ChatLieu) === 4) {
                        ShowMessage_Danger('Dịch vụ thuộc gói đã mua. Không thay đổi giá trị thanh toán');
                        $this.val(formatNumber3Digit(itFor.ThanhToan));
                        return false;
                    }

                    if (soluong === 0) {
                        // keep GiaBan, caculator again SoLuong
                        soluong = sumPrice / (priceOld);
                        priceNew = priceOld;
                    }
                    else {
                        priceNew = Caculator_Price_byTienGiam(0, soluong, sumPrice);
                    }
                    // reset chietkhau, thue
                    itFor.PTChietKhau = 0;
                    itFor.TienChietKhau = 0;
                    itFor.TienThue = 0;
                    itFor.PTThue = 0;
                    itFor.SoLuong = soluong;
                    itFor.DonGia = priceNew;
                    itFor.GiaBan = priceNew;
                    itFor.ThanhToan = sumPrice;
                    itFor.ThanhTien = sumPrice;
                    comboDoing = itFor;

                    $('#ck_' + idRandom).text(formatNumber3Digit(itFor.TienChietKhau));
                    $('#tax_' + idRandom).text(formatNumber3Digit(itFor.TienThue));
                    $('#ck_' + idRandom).parent().css('display', 'none');
                    $('#tax_' + idRandom).parent().css('display', 'none');
                    if (isDoiTra) {
                        $('#numberTH_' + idRandom).val(formatNumber3Digit(soluong));
                        $('#priceTH_' + idRandom).val(formatNumber3Digit(priceNew));
                    }
                    else {
                        $('#munber_' + idRandom).val(formatNumber3Digit(soluong));
                        $('input[id =' + idRandom + ']').val(formatNumber3Digit(priceNew));
                    }
                    break;
                }
            }
            if (comboDoing !== null) {
                UpdateThanhPhanCombo(itemPr.IDRandom, comboDoing, isDoiTra);
            }
            if (loaiHD === 3) {
                Update_StatusXuLy_ofHDDatHang(idRandomHD);
            }
            Combo_UpdateChietKhauNV(itemPr.IDRandom, idRandom, isDoiTra);
            var keyCode = event.keyCode || event.which;
            if (keyCode === 13) {
                Combo_FocusLiNext(ctDoing, idRandom, 'sum-f_', isDoiTra);
            }
        }
    }

    self.Combo_editTenThayThe = function (item, itemPr, isDoiTra = false) {
        var $this = $(event.currentTarget);
        var txt = Remove_LastComma($this.val());
        if (txt === '') {
            txt = item.TenHangHoa;
        }

        var idRandomPr = itemPr.IDRandom;
        var idRandom = item.IDRandom;

        var cacheName = lcListCTHD;
        if (isDoiTra) {
            cacheName = lcListCTHD_DoiTra;
        }
        var cthd = localStorage.getItem(cacheName);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            for (let i = 0; i < cthd.length; i++) {
                if (cthd[i].IDRandom === idRandomPr) {
                    for (let j = 0; j < cthd[i].ThanhPhanComBo.length; j++) {
                        let forIn = cthd[i].ThanhPhanComBo[j];
                        if (forIn.IDRandom === idRandom) {
                            cthd[i].ThanhPhanComBo[j].TenHangHoaThayThe = txt;
                            break;
                        }
                    }
                    break;
                }
            }
            localStorage.setItem(cacheName, JSON.stringify(cthd));

            let keyCode = event.keyCode || event.which;
            if (keyCode === 13) {
                Combo_FocusLiNext(itemPr, idRandom, 'ten_', isDoiTra);
            }
        }
    }

    self.Combo_editSoluong = function (item, itemPr, isDoiTra) {
        var idRandom = item.IDRandom;
        var idRandomHD = itemPr.IDRandomHD;
        var loaiHD = self.HoaDons().LoaiHoaDon();
        var $this = $(event.currentTarget);
        var ctDoing = FindCTHD_isDoing(itemPr, isDoiTra);
        if (ctDoing !== null) {

            let newNumber = formatNumberToFloat($this.val());
            if (isDoiTra == false && loaiHD === 6 && self.HoaDons().ID_HoaDon() !== null) {
                // trahang tu HDMua --> chi nhap toida = soluongmua
                if (newNumber > item.SoLuongDaMua) {
                    $this.val(item.SoLuongDaMua);
                    newNumber = item.SoLuongDaMua;
                }
            }

            let keyCode = event.keyCode || event.which;
            if (keyCode === 38) {
                newNumber = newNumber + 1;
            }

            var isChangeSL = false;
            var combo = ctDoing.ThanhPhanComBo;
            var comboDoing = null;
            for (let i = 0; i < combo.length; i++) {
                let itFor = combo[i];
                if (itFor.IDRandom === idRandom) {
                    if (parseInt(itFor.ChatLieu) === 4 && newNumber > itFor.SoLuongConLai) {
                        ShowMessage_Danger('Dịch vụ chỉ được sử dụng tối đa ' + itFor.SoLuongConLai);
                        $this.val(formatNumber3Digit(itFor.SoLuong));
                        return false;
                    }
                    if (keyCode === 40) {
                        if (itFor.SoLuong > 1) {
                            newNumber = newNumber - 1;
                        }
                    }
                    isChangeSL = formatNumberToFloat(itFor.SoLuong) !== formatNumberToFloat(newNumber);
                    itFor.SoLuong = newNumber;
                    itFor.SoLuongMacDinh = newNumber / ctDoing.SoLuong;

                    if (parseInt(itFor.ChatLieu) !== 4) {
                        itFor.ThanhTien = newNumber * (itFor.DonGia - itFor.TienChietKhau);
                        itFor.ThanhToan = newNumber * (itFor.DonGia - itFor.TienChietKhau + itFor.TienThue);
                        $('#sum-f_' + idRandom).val(formatNumber3Digit(itFor.ThanhToan));
                    }

                    comboDoing = itFor;
                    break;
                }
            }
            if (isChangeSL) {
                if (comboDoing !== null) {
                    UpdateThanhPhanCombo(itemPr.IDRandom, comboDoing, isDoiTra);
                }
                if (loaiHD === 3) {
                    Update_StatusXuLy_ofHDDatHang(idRandomHD);
                }
                Combo_UpdateSoLuong_TPDinhLuong(itemPr.IDRandom, idRandom, newNumber, isDoiTra);
                TangGiamSoLuong_updatePhiDichVu(comboDoing, comboDoing.SoLuong, isDoiTra);
                Combo_UpdateChietKhauNV(itemPr.IDRandom, idRandom, isDoiTra);
            }

            if (keyCode === 13) {
                let char = 'munber_';
                if (isDoiTra) {
                    char = 'numberTH_';
                }
                Combo_FocusLiNext(ctDoing, idRandom, char, isDoiTra);
            }
        }
    }
    self.Combo_giamSoLuong = function (item, itemPr, isDoiTra) {
        var idRandom = item.IDRandom;
        var idRandomHD = itemPr.IDRandomHD;
        var loaiHD = self.HoaDons().LoaiHoaDon();
        var ctDoing = FindCTHD_isDoing(itemPr, isDoiTra);
        if (ctDoing !== null) {
            var combo = ctDoing.ThanhPhanComBo;
            var comboDoing = null;
            var soluong = 1;
            for (let i = 0; i < combo.length; i++) {
                let itFor = combo[i];
                if (itFor.IDRandom === idRandom) {
                    if (itFor.SoLuong >= 1) {
                        itFor.SoLuong = itFor.SoLuong - 1;
                    }
                    soluong = itFor.SoLuong;
                    itFor.SoLuongMacDinh = itFor.SoLuong / ctDoing.SoLuong;
                    if (parseInt(itFor.ChatLieu) !== 4) {
                        itFor.ThanhToan = itFor.SoLuong * (itFor.GiaBan - itFor.TienChietKhau + itFor.TienThue);
                        itFor.ThanhTien = itFor.SoLuong * (itFor.GiaBan - itFor.TienChietKhau);
                        $('#sum-f_' + idRandom).text(formatNumber3Digit(itFor.ThanhToan));
                    }
                    comboDoing = itFor;

                    break;
                }
            }
            if (comboDoing !== null) {
                UpdateThanhPhanCombo(itemPr.IDRandom, comboDoing, isDoiTra);
            }
            if (loaiHD === 3) {
                Update_StatusXuLy_ofHDDatHang(idRandomHD);
            }
            Combo_UpdateSoLuong_TPDinhLuong(itemPr.IDRandom, idRandom, soluong, isDoiTra);
            TangGiamSoLuong_updatePhiDichVu(comboDoing, comboDoing.SoLuong, isDoiTra);
            Combo_UpdateChietKhauNV(itemPr.IDRandom, idRandom, isDoiTra);
            BindCTHD_byIDRandomHD(itemPr.IDRandomHD);
        }
    }
    self.Combo_tangSoLuong = function (item, itemPr, isDoiTra) {
        var idRandom = item.IDRandom;
        var idRandomHD = itemPr.IDRandomHD;
        var loaiHD = self.HoaDons().LoaiHoaDon();
        var ctDoing = FindCTHD_isDoing(itemPr, isDoiTra);
        if (ctDoing !== null) {
            var combo = ctDoing.ThanhPhanComBo;
            var comboDoing = null;
            var soluong = 1;
            for (let i = 0; i < combo.length; i++) {
                let itFor = combo[i];
                if (itFor.IDRandom === idRandom) {
                    if (isDoiTra == false && loaiHD === 6 && self.HoaDons().ID_HoaDon() !== null) {
                        if (itFor.SoLuong + 1 > itFor.SoLuongDaMua) {
                            ShowMessage_Danger(itFor.TenHangHoa + ' chỉ được trả tối đa số lượng = ' + itFor.SoLuongDaMua);
                            return false;
                        }
                    }
                    if (parseInt(itFor.ChatLieu) === 4 && itFor.SoLuong + 1 > itFor.SoLuongConLai) {
                        ShowMessage_Danger('Dịch vụ chỉ được sử dụng tối đa ' + itFor.SoLuongConLai);
                        $(event.currentTarget).val(formatNumber3Digit(itFor.SoLuong));
                        return false;
                    }
                    itFor.SoLuong += 1;
                    itFor.SoLuongMacDinh = itFor.SoLuong / ctDoing.SoLuong;
                    if (parseInt(itFor.ChatLieu) !== 4) {
                        itFor.ThanhToan = itFor.SoLuong * (itFor.GiaBan - itFor.TienChietKhau + itFor.TienThue);
                        itFor.ThanhTien = itFor.SoLuong * (itFor.GiaBan - itFor.TienChietKhau);
                        $('#sum-f_' + idRandom).text(formatNumber3Digit(itFor.ThanhToan));
                    }
                    soluong = itFor.SoLuong;
                    comboDoing = itFor;
                    break;
                }
            }
            if (comboDoing !== null) {
                UpdateThanhPhanCombo(itemPr.IDRandom, comboDoing, isDoiTra);
            }
            if (loaiHD === 3) {
                Update_StatusXuLy_ofHDDatHang(idRandomHD);
            }
            Combo_UpdateSoLuong_TPDinhLuong(itemPr.IDRandom, idRandom, soluong, isDoiTra);
            TangGiamSoLuong_updatePhiDichVu(comboDoing, comboDoing.SoLuong, isDoiTra);
            Combo_UpdateChietKhauNV(itemPr.IDRandom, idRandom, isDoiTra);
            BindCTHD_byIDRandomHD(itemPr.IDRandomHD);
        }
    }
    self.Combo_xoaHangHoa = function (item, itemPr, isDoiTra) {
        var idRandom = item.IDRandom;
        var idRandomHD = itemPr.IDRandomHD;
        var loaiHD = self.HoaDons().LoaiHoaDon();
        var cacheName = lcListCTHD;
        if (isDoiTra) {
            cacheName = lcListCTHD_DoiTra;
        }
        var cthd = localStorage.getItem(cacheName);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            for (let i = 0; i < cthd.length; i++) {
                if (cthd[i].IDRandom === itemPr.IDRandom) {
                    for (let j = 0; j < cthd[i].ThanhPhanComBo.length; j++) {
                        let forIn = cthd[i].ThanhPhanComBo[j];
                        if (forIn.IDRandom === idRandom) {
                            TangGiamSoLuong_updatePhiDichVu(forIn, 0, isDoiTra, 1);
                            cthd[i].ThanhPhanComBo.splice(j, 1);
                            break;
                        }
                    }
                    break;
                }
            }
            localStorage.setItem(cacheName, JSON.stringify(cthd));
            if (loaiHD === 3) {
                Update_StatusXuLy_ofHDDatHang(idRandomHD);
            }
        }
        BindCTHD_byIDRandomHD(itemPr.IDRandomHD);
    }

    self.Combo_editThue = function (item, itemPr, isDoiTra) {
        var idRandom = item.IDRandom;
        var $this = $(event.currentTarget);

        var ctDoing = FindCTHD_isDoing(itemPr, isDoiTra);
        if (ctDoing !== null) {
            var combo = ctDoing.ThanhPhanComBo;
            var comboDoing = null;
            for (let i = 0; i < combo.length; i++) {
                let itFor = combo[i];
                if (itFor.IDRandom === idRandom) {
                    if (formatNumberToFloat(itFor.GiaBan) === 0) {
                        return;
                    }
                    formatNumberObj($this);

                    let tienThue = 0, ptThue = 0;
                    let giasauCK = itFor.GiaBan - itFor.TienChietKhau;

                    let taxNew = formatNumberToFloat($this.val());
                    if ($('#taxCT_' + idRandom).hasClass('active-re')) {
                        if (taxNew > 100) {
                            taxNew = 100;
                            $this.val(100);
                        }
                        ptThue = taxNew;
                        tienThue =giasauCK * ptThue / 100;
                    }
                    else {
                        if (taxNew > giasauCK) {
                            taxNew = giasauCK;
                        }
                        tienThue = taxNew;
                    }

                    itFor.PTThue = ptThue;
                    itFor.TienThue = tienThue;
                    itFor.ThanhTien = giasauCK * itFor.SoLuong;
                    itFor.ThanhToan = (giasauCK + tienThue) * itFor.SoLuong;
                    comboDoing = itFor;

                    $('#sum-f_' + idRandom).val(formatNumber3Digit(itFor.ThanhToan));
                    $('#tax_' + idRandom).text(formatNumber3Digit(itFor.TienThue));
                    $('#tax_' + idRandom).parent().css('display', itFor.TienThue > 0 ? '' : 'none');
                    break;
                }
            }
            if (comboDoing !== null) {
                UpdateThanhPhanCombo(itemPr.IDRandom, comboDoing, isDoiTra);
            }
        }
    }
    self.Combo_clickThue = function (item, itemPr, isDoiTra) {
        var idRandom = item.IDRandom;

        var $this = $('#taxCT_' + idRandom);
        if ($this.hasClass('active-re')) {
            $this.removeClass('active-re');
        }
        else {
            $this.addClass('active-re');
        }

        var ctDoing = FindCTHD_isDoing(itemPr, isDoiTra);
        if (ctDoing !== null) {
            var combo = ctDoing.ThanhPhanComBo;
            var comboDoing = null;
            for (let i = 0; i < combo.length; i++) {
                let itFor = combo[i];
                if (itFor.IDRandom === idRandom) {
                    if (itFor.GiaBan !== 0) {
                        let ptThue = itFor.PTThue;
                        let tienThue = itFor.TienThue;
                        if ($this.hasClass('active-re')) {
                            ptThue = tienThue / (itFor.GiaBan - itFor.TienChietKhau) * 100;
                            $('##ipTaxCT_' + idRandom).val(ptThue);
                        }
                        else {
                            ('##ipTaxCT_' + idRandom).val(formatNumber3Digit(tienThue));
                            ptThue = 0;
                        }
                        itFor.PTThue = ptThue;
                        itFor.TienThue = tienThue;
                        comboDoing = itFor;
                    }
                    break;
                }
            }
            if (comboDoing !== null) {
                UpdateThanhPhanCombo(itemPr.IDRandom, comboDoing, isDoiTra);
            }
        }
    }

    self.Combo_ShowDivSale = function (item, itemPr, isDoiTra) {
        var role = GetRoleChangePrice(item.LoaiHoaDon);
        if (role === false) {
            return false;
        }
        var idRandom = item.IDRandom;
        var $this = $(event.currentTarget);
        var ipGiam = $('#pri-g_' + idRandom);
        var iconGiam = $('#vnd_' + idRandom);

        var ctDoing = FindCTHD_isDoing(itemPr, isDoiTra);
        if (ctDoing !== null) {
            var combo = ctDoing.ThanhPhanComBo;
            for (let i = 0; i < combo.length; i++) {
                let itFor = combo[i];
                if (itFor.IDRandom === idRandom) {
                    let ptGiam = itFor.PTChietKhau;
                    let tienGiam = itFor.TienChietKhau;
                    if (ptGiam > 0 || tienGiam === 0) {
                        ipGiam.val(ptGiam);
                        iconGiam.addClass('active-re');
                    }
                    else {
                        ipGiam.val(formatNumber3Digit(tienGiam));
                        iconGiam.removeClass('active-re');
                    }

                    if (itFor.PTThue > 0 || (itFor.TienThue === 0 && itFor.PTThue === 0)) {
                        $('#ipTaxCT_' + idRandom).val(itFor.PTThue);
                        $('#taxCT_' + idRandom).addClass('active-re');
                    }
                    else {
                        $('#ipTaxCT_' + idRandom).val(formatNumber3Digit(itFor.TienThue));
                        $('#taxCT_' + idRandom).removeClass('active-re');
                    }
                    break;
                }
            }
            $($this).siblings(".gara-popup-chietkhau").toggle();
            ipGiam.focus().select().focus();
        }
    }

    self.Combo_UpdateGhiChu = function (item, itemPr, isDoiTra) {
        var idRandom = item.IDRandom;
        var ghichu = $(event.currentTarget).val();

        var cacheName = lcListCTHD;
        if (isDoiTra) {
            cacheName = lcListCTHD_DoiTra;
        }
        var cthd = localStorage.getItem(cacheName);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            for (let i = 0; i < cthd.length; i++) {
                if (cthd[i].IDRandom === itemPr.IDRandom) {
                    for (let j = 0; j < cthd[i].ThanhPhanComBo.length; j++) {
                        let forIn = cthd[i].ThanhPhanComBo[j];
                        if (forIn.IDRandom === idRandom) {
                            cthd[i].ThanhPhanComBo[j].GhiChu = ghichu;
                            break;
                        }
                    }
                    break;
                }
            }
            localStorage.setItem(cacheName, JSON.stringify(cthd));
        }
    }

    self.Combo_ShowPopChangeTPDinhLuong = function (item, itemPr, isDoiTra) {
        var idRandom = item.IDRandom;
        var arrTPDinhLuong = [];
        var ctDoing = FindCTHD_isDoing(itemPr, isDoiTra);
        if (ctDoing !== null) {
            var combo = ctDoing.ThanhPhanComBo;
            for (let i = 0; i < combo.length; i++) {
                let itFor = combo[i];
                if (itFor.IDRandom === idRandom) {
                    itFor.IDRandomPr = itemPr.IDRandom;
                    self.DichVu_isDoing(itFor);
                    vmThanhPhanDinhLuong.DichVu_isDoing = itFor;
                    arrTPDinhLuong = itFor.ThanhPhan_DinhLuong;
                    vmThanhPhanDinhLuong.typeSearchProduct = itFor.LoaiHangHoa == 3 ? '%1%' : '11';
                    break;
                }
            }
        }
        if (arrTPDinhLuong.length === 0) {
            // get TP dinh luong by ID_QuiDoi
            let lstTPDinhLuong = $.grep(vmThanhPhanDinhLuong.All_DinhLuongDichVu, function (x) {
                return x.ID_DichVu === item.ID_DonViQuiDoi;
            });
            if (lstTPDinhLuong.length > 0) {
                for (let i = 0; i < lstTPDinhLuong.length; i++) {
                    lstTPDinhLuong[i].STT = i + 1;
                    lstTPDinhLuong[i].GhiChu = '';
                    lstTPDinhLuong[i].isDefault = false;
                    lstTPDinhLuong[i].IDRandom = 'TPDL_' + Math.floor(Math.random() * 10000000 + 1);
                    lstTPDinhLuong[i].SoLuong = self.DichVu_isDoing().SoLuong * lstTPDinhLuong[i].SoLuongMacDinh;
                    lstTPDinhLuong[i].SoLuongQuyCach = lstTPDinhLuong[i].SoLuong * lstTPDinhLuong[i].QuyCach;
                    lstTPDinhLuong[i].GiaVonAfter = lstTPDinhLuong[i].SoLuong * lstTPDinhLuong[i].GiaVon;// = GiaVon(co ban) * SoLuong
                    arrTPDinhLuong.push(lstTPDinhLuong[i]);
                }
            }
        }
        vmThanhPhanDinhLuong.ID_DonVi = id_DonVi;
        vmThanhPhanDinhLuong.Grid_TPDinhLuongChosed = arrTPDinhLuong;
        vmThanhPhanDinhLuong.showModal(isDoiTra, true);
    }

    self.Combo_AgreeTPDinhLuong = function () {
        Update_SoLuongBanDau_forListTPDinhLuong();

        var cacheName = lcListCTHD;
        if (vmThanhPhanDinhLuong.isDoiTra) {
            cacheName = lcListCTHD_DoiTra;
        }
        var cthd = localStorage.getItem(cacheName);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            var idRandomPr = vmThanhPhanDinhLuong.DichVu_isDoing.IDRandomPr;
            if (!commonStatisJs.CheckNull(idRandomPr)) {
                for (let i = 0; i < cthd.length; i++) {
                    if (cthd[i].IDRandom === idRandomPr) {
                        for (let j = 0; j < cthd[i].ThanhPhanComBo.length; j++) {
                            let forIn = cthd[i].ThanhPhanComBo[j];
                            if (forIn.IDRandom === vmThanhPhanDinhLuong.DichVu_isDoing.IDRandom) {
                                forIn.ThanhPhan_DinhLuong = vmThanhPhanDinhLuong.Grid_TPDinhLuongChosed;
                                break;
                            }
                        }
                        break;
                    }
                }
            }
            localStorage.setItem(cacheName, JSON.stringify(cthd));

            // update tpdinhluong in cacheDH 
            if (self.HoaDons().LoaiHoaDon() === 3 && self.HoaDons().ID() !== const_GuidEmpty) {
                let ctDH = localStorage.getItem(lcCTDatHang_Const);
                if (ctDH !== null) {
                    ctDH = JSON.parse(ctDH);
                    for (let i = 0; i < ctDH.length; i++) {
                        for (let j = 0; j < cthd.length; j++) {
                            if (ctDH[i].IDRandom === idRandomPr) {
                                for (let m = 0; m < ctDH[i].ThanhPhanComBo.length; m++) {
                                    if (ctDH[i].ThanhPhanComBo[m].IDRandom === vmThanhPhanDinhLuong.DichVu_isDoing.IDRandom) {
                                        ctDH[i].ThanhPhanComBo[m].ThanhPhan_DinhLuong = vmThanhPhanDinhLuong.Grid_TPDinhLuongChosed;
                                        break;
                                    }
                                }
                                break;
                            }
                        }
                    }
                    localStorage.setItem(lcCTDatHang_Const, JSON.stringify(ctDH));
                }
                Update_StatusXuLy_ofHDDatHang(self.HoaDons().IDRandom());
            }
        }
    }

    self.Combo_showPopupUserDiscount = function (item, itemPr, isDoiTra) {
        vmHoaHongDV.listData.NhanViens = self.NhanViens();
        var idRandom = item.IDRandom;
        var ctDoing = FindCTHD_isDoing(itemPr, isDoiTra);
        if (ctDoing !== null) {
            var combo = ctDoing.ThanhPhanComBo;
            for (let i = 0; i < combo.length; i++) {
                let itFor = combo[i];
                if (itFor.IDRandom === idRandom) {
                    let phiDV = 0;
                    // chi tinh phiDV khi su dung
                    if (item.LaHangHoa === false && (item.LoaiHoaDon === 1 || item.LoaiHoaDon === 25 || isDoiTra)) {
                        phiDV = itFor.TongPhiDichVu;
                        phiDV = phiDV === undefined ? 0 : phiDV;
                    }
                    itFor.TongPhiDichVu = phiDV;
                    itFor.IDRandomPr = itemPr.IDRandom;

                    let thanhtien = (itFor.GiaBan - itFor.TienChietKhau) * itFor.SoLuong;
                    thanhtien = thanhtien < 0 ? 0 : thanhtien;
                    itFor.ThanhTien = thanhtien;

                    self.DichVu_isDoing(itFor);
                    vmHoaHongDV.GridNV_TVTH = itFor.BH_NhanVienThucHien;
                    vmHoaHongDV.DichVu_isDoing = itFor;
                    let loaiHD = self.HoaDons().LoaiHoaDon();
                    if (loaiHD === 6) {
                        if (self.HoaDons().MaHoaDon().indexOf('DV') > -1) {
                            loaiHD = 19;
                        }
                        else {
                            loaiHD = 1;
                        }
                    }
                    vmHoaHongDV.inforHoaDon.LoaiHoaDon = loaiHD;
                    vmHoaHongDV.showModal(itFor, isDoiTra, true);
                    break;
                }
            }
        }
    }

    self.Combo_AgreeNhanVienTVTH = function () {
        var lstNV_TH = '';
        var lstNV_TV = '';
        var lstNV_TH_Print = '';
        var lstNV_TV_Print = '';
        for (let i = 0; i < vmHoaHongDV.GridNV_TVTH.length; i++) {
            let itemFor = vmHoaHongDV.GridNV_TVTH[i];
            let dvtCK = ' đ';
            let valCK = formatNumber3Digit(itemFor.TienChietKhau);
            if (itemFor.PT_ChietKhau > 0) {
                dvtCK = ' %';
                valCK = itemFor.PT_ChietKhau;
            }
            switch (itemFor.TacVu) {
                case 1: // thuchien
                case 3: // thuchien theoyc
                    lstNV_TH += itemFor.TenNhanVien + ' (' + valCK + dvtCK + '), ';
                    lstNV_TH_Print += itemFor.TenNhanVien + ', ';
                    break;
                case 2: // tuvan
                case 4: // bangoi
                    lstNV_TV += itemFor.TenNhanVien + ' (' + valCK + dvtCK + '), ';
                    lstNV_TV_Print += itemFor.TenNhanVien + ', ';
                    break;
            }
        }

        var cacheName = lcListCTHD;
        if (vmHoaHongDV.isDoiTra) {
            cacheName = lcListCTHD_DoiTra;
        }

        lstNV_TH = lstNV_TH !== '' ? 'Thực hiện: ' + Remove_LastComma(lstNV_TH) : '';
        lstNV_TH_Print = lstNV_TH_Print !== '' ? Remove_LastComma(lstNV_TH_Print) : '';
        lstNV_TV = lstNV_TV !== '' ? 'Tư vấn: ' + Remove_LastComma(lstNV_TV) : '';
        lstNV_TV_Print = lstNV_TV_Print !== '' ? Remove_LastComma(lstNV_TV_Print) : '';

        var cthd = localStorage.getItem(cacheName);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            var idRandomPr = vmHoaHongDV.DichVu_isDoing.IDRandomPr;
            let tinhHoaHongtruocCK = vmHoaHongDV.TinhHoaHongTruocCK ? 1 : 0;
            if (!commonStatisJs.CheckNull(idRandomPr)) {
                for (let i = 0; i < cthd.length; i++) {
                    if (cthd[i].IDRandom === idRandomPr) {
                        for (let j = 0; j < cthd[i].ThanhPhanComBo.length; j++) {
                            let forIn = cthd[i].ThanhPhanComBo[j];
                            if (forIn.IDRandom === vmHoaHongDV.DichVu_isDoing.IDRandom) {
                                forIn.GhiChu_NVThucHien = lstNV_TH;
                                forIn.GhiChu_NVThucHienPrint = lstNV_TH_Print;
                                forIn.GhiChu_NVTuVan = lstNV_TV;
                                forIn.GhiChu_NVTuVanPrint = lstNV_TV_Print;
                                forIn.HoaHongTruocChietKhau = tinhHoaHongtruocCK;
                                forIn.BH_NhanVienThucHien = vmHoaHongDV.GridNV_TVTH;
                                break;
                            }
                        }
                        break;
                    }
                }
            }
            localStorage.setItem(cacheName, JSON.stringify(cthd));
        }
        if (vmHoaHongDV.isDoiTra) {
            Bind_CTHĐoiTra_afterHideColumn();
        }
        else {
            BindCTHD_byIDRandomHD(self.HoaDons().IDRandom());
        }
        HideShow_Icon_ChietKhauNV();
    }

    function ChangeSoLuongParent_UpdateCombo(idRandom, soluong, isDoiTra, typeEdit = 0) {// typeEdit= 1: editsoluong
        var cacheName = lcListCTHD;
        if (isDoiTra) {
            cacheName = lcListCTHD_DoiTra;
        }
        var cthd = localStorage.getItem(cacheName);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            for (let i = 0; i < cthd.length; i++) {
                if (cthd[i].IDRandom === idRandom) {
                    for (let j = 0; j < cthd[i].ThanhPhanComBo.length; j++) {
                        let forIn = cthd[i].ThanhPhanComBo[j];
                        let slCombo = forIn.SoLuongMacDinh * soluong;
                        forIn.SoLuong = slCombo;
                        forIn.SoLuongQuyCach = slCombo * forIn.QuyCach;

                        if (parseInt(forIn.ChatLieu) !== 4) {
                            forIn.ThanhTien = slCombo * (forIn.DonGia - forIn.TienChietKhau);
                            forIn.ThanhToan = slCombo * (forIn.DonGia - forIn.TienChietKhau + forIn.TienThue);
                            if (forIn.LaPTPhiDichVu) {
                                forIn.TongPhiDichVu = Math.round(forIn.PhiDichVu * forIn.DonGia * forIn.SoLuong / 100);
                            }
                            else {
                                forIn.TongPhiDichVu = forIn.PhiDichVu * forIn.SoLuong;
                            }
                        }

                        if (typeEdit === 1) {
                            if (isDoiTra) {
                                $('#numberTH_' + forIn.IDRandom).val(formatNumber3Digit(forIn.SoLuong));
                            }
                            else {
                                $('#munber_' + forIn.IDRandom).val(formatNumber3Digit(forIn.SoLuong));
                            }
                            $('#sum-f_' + forIn.IDRandom).val(formatNumber3Digit(forIn.ThanhToan));
                        }

                        for (let k = 0; k < forIn.ThanhPhan_DinhLuong.length; k++) {
                            let itemTP = forIn.ThanhPhan_DinhLuong[k];
                            let slTPhan =itemTP.SoLuongMacDinh * forIn.SoLuong;
                            forIn.ThanhPhan_DinhLuong[k].SoLuong = slTPhan;
                            forIn.ThanhPhan_DinhLuong[k].SoLuongQuyCach = slTPhan * itemTP.QuyCach;
                            forIn.ThanhPhan_DinhLuong[k].GiaVonAfter = slTPhan * itemTP.GiaVon;
                        }

                        if (forIn.BH_NhanVienThucHien.length > 0) {
                            let tongPhiDV = forIn.TongPhiDichVu;
                            if (forIn.LoaiHoaDon === 19) {
                                tongPhiDV = 0;
                            }
                            let gtriTinh = 0;
                            if (forIn.HoaHongTruocChietKhau === 1) {
                                gtriTinh = forIn.DonGia * forIn.SoLuong;
                            }
                            else {
                                gtriTinh = (forIn.DonGia - forIn.TienChietKhau) * forIn.SoLuong;
                            }
                            gtriTinh = gtriTinh - tongPhiDV;
                            gtriTinh = gtriTinh < 0 ? 0 : gtriTinh;

                            for (let k = 0; k < forIn.BH_NhanVienThucHien.length; k++) {
                                let nvien = forIn.BH_NhanVienThucHien[k];
                                let tienCKNew = nvien.ChietKhauMacDinh * forIn.SoLuong * nvien.HeSo;
                                if (nvien.PT_ChietKhau > 0) {
                                    tienCKNew = Math.round(gtriTinh * nvien.PT_ChietKhau / 100) * nvien.HeSo;
                                }
                                cthd[i].ThanhPhanComBo[j].BH_NhanVienThucHien[k].TienChietKhau = tienCKNew;
                            }
                            forIn = CTHD_GetGhiChu_NVTuVanTH(forIn);
                        }
                    }
                    break;
                }
            }
            localStorage.setItem(cacheName, JSON.stringify(cthd));
        }
    }

    function Combo_UpdateSoLuong_TPDinhLuong(idRandomPr, idRandom, soluong, isDoiTra) {
        var cacheName = lcListCTHD;
        if (isDoiTra) {
            cacheName = lcListCTHD_DoiTra;
        }
        var cthd = localStorage.getItem(cacheName);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            for (let i = 0; i < cthd.length; i++) {
                if (cthd[i].IDRandom === idRandomPr) {
                    for (let j = 0; j < cthd[i].ThanhPhanComBo.length; j++) {
                        let forIn = cthd[i].ThanhPhanComBo[j];
                        if (forIn.IDRandom === idRandom) {
                            for (let k = 0; k < forIn.ThanhPhan_DinhLuong.length; k++) {
                                let itemTP = forIn.ThanhPhan_DinhLuong[k];
                                let soluongAfter = itemTP.SoLuongMacDinh * soluong;
                                forIn.ThanhPhan_DinhLuong[k].SoLuong = soluongAfter;
                                forIn.ThanhPhan_DinhLuong[k].SoLuongQuyCach = soluongAfter * itemTP.QuyCach;
                                forIn.ThanhPhan_DinhLuong[k].GiaVonAfter = soluongAfter * itemTP.GiaVon;
                            }
                            break;
                        }
                    }
                    break;
                }
            }
            localStorage.setItem(cacheName, JSON.stringify(cthd));
        }
    }

    function Combo_UpdateChietKhauNV(idRandomPr, idRandom, isDoiTra) {
        var cacheName = lcListCTHD;
        if (isDoiTra) {
            cacheName = lcListCTHD_DoiTra;
        }
        var cthd = localStorage.getItem(cacheName);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);
            for (let i = 0; i < cthd.length; i++) {
                if (cthd[i].IDRandom === idRandomPr) {
                    for (let j = 0; j < cthd[i].ThanhPhanComBo.length; j++) {
                        let forIn = cthd[i].ThanhPhanComBo[j];
                        if (forIn.IDRandom === idRandom) {
                            if (forIn.BH_NhanVienThucHien.length > 0) {
                                let tongPhiDV = forIn.TongPhiDichVu;
                                if (forIn.LoaiHoaDon === 19) {
                                    tongPhiDV = 0;
                                }

                                let gtriTinh = 0;
                                if (forIn.HoaHongTruocChietKhau === 1) {
                                    gtriTinh = forIn.DonGia * forIn.SoLuong;
                                }
                                else {
                                    gtriTinh = (forIn.DonGia - forIn.TienChietKhau) * forIn.SoLuong;
                                }
                                gtriTinh = gtriTinh - tongPhiDV;
                                gtriTinh = gtriTinh < 0 ? 0 : gtriTinh;

                                for (let k = 0; k < forIn.BH_NhanVienThucHien.length; k++) {
                                    let nvien = forIn.BH_NhanVienThucHien[k];
                                    let tienCKNew = nvien.ChietKhauMacDinh * forIn.SoLuong * nvien.HeSo;
                                    if (nvien.PT_ChietKhau > 0) {
                                        tienCKNew = Math.round(gtriTinh * nvien.PT_ChietKhau / 100) * nvien.HeSo;
                                    }
                                    cthd[i].ThanhPhanComBo[j].BH_NhanVienThucHien[k].TienChietKhau = tienCKNew;
                                }
                                forIn = CTHD_GetGhiChu_NVTuVanTH(forIn);
                            }
                            break;
                        }
                    }
                    break;
                }
            }
        }
        localStorage.setItem(cacheName, JSON.stringify(cthd));
    }

    $('#vmThanhPhanCombo').on('hidden.bs.modal', function () {
        if (vmThanhPhanCombo.saveOK) {
            var ctDoing = vmThanhPhanCombo.DichVu_isDoing;
            var lst = vmThanhPhanCombo.ListCombo;
            // format again
            for (let i = 0; i < lst.length; i++) {
                lst[i].SoLuong = formatNumberToFloat(lst[i].SoLuong);
                lst[i].DonGia = formatNumberToFloat(lst[i].DonGia);
                lst[i].GiaBan = formatNumberToFloat(lst[i].GiaBan);
                lst[i].ThanhTien = formatNumberToFloat(lst[i].ThanhTien);
                lst[i].ThanhToan = formatNumberToFloat(lst[i].ThanhToan);
            }

            var cacheName = lcListCTHD;
            if (vmThanhPhanCombo.isDoiTra) {
                cacheName = lcListCTHD_DoiTra;
            }
            var cthd = localStorage.getItem(cacheName);
            if (cthd !== null) {
                cthd = JSON.parse(cthd);
                for (let i = 0; i < cthd.length; i++) {
                    if (cthd[i].IDRandom === ctDoing.IDRandom) {
                        cthd[i].ThanhPhanComBo = lst;
                        break;
                    }
                }
                localStorage.setItem(cacheName, JSON.stringify(cthd));
            }
            if (self.HoaDons().LoaiHoaDon() === 3 && self.HoaDons().ID() !== const_GuidEmpty) {
                Update_StatusXuLy_ofHDDatHang(ctDoing.IDRandomHD);
            }
            // update tpdluong, ck nvien
            ChangeSoLuongParent_UpdateCombo(ctDoing.IDRandom, ctDoing.SoLuong, vmThanhPhanCombo.isDoiTra);
            BindCTHD_byIDRandomHD(ctDoing.IDRandomHD);
        }
    })

    // chiphi giacong
    self.showModalChiPhi = function () {
        if (self.HangHoaAfterAdds().length === 0) {
            ShowMessage_Danger('Vui lòng nhập chi tiết hóa đơn');
            return;
        }
        let cthd = localStorage.getItem(lcListCTHD);
        if (cthd !== null) {
            cthd = JSON.parse(cthd);

            let cthdOpening = $.grep(cthd, function (x) {
                return x.IDRandomHD === self.HoaDons().IDRandom();
            });
            let arr = [];
            for (let i = 0; i < cthdOpening.length; i++) {
                let forOut = cthdOpening[i];
                if (forOut.LoaiHangHoa !== 3) {

                    CheckNull_IDChiTiet(forOut);

                    if (forOut.HangCungLoais.length > 0) {
                        for (let k = 0; k < forOut.HangCungLoais.length; k++) {
                            let forIn = forOut.HangCungLoais[k];
                            CheckNull_IDChiTiet(forIn);
                        }
                    }
                }
                else {
                    for (let j = 0; j < forOut.ThanhPhanComBo.length; j++) {
                        let forIn = forOut.ThanhPhanComBo[j];
                        CheckNull_IDChiTiet(forIn);
                    }
                }

                function CheckNull_IDChiTiet(itCheck) {
                    if (!commonStatisJs.CheckNull(itCheck.ID) && itCheck.ID !== const_GuidEmpty) {
                        itCheck.ID_HoaDon_ChiTiet = itCheck.ID;
                    }
                    else {
                        itCheck.ID_HoaDon_ChiTiet = itCheck.IDRandom;
                    }
                    arr.push(itCheck);
                }
            }
            arr = arr.sort(function (a, b) {
                let x = a.MaHangHoa,
                    y = b.MaHangHoa;
                return x < y ? -1 : x > y ? 1 : 0;
            });
            VueChiPhi.ListProduct = arr;
        }

        VueChiPhi.InvoiceChosing.BienSo = self.HoaDons().BienSo();
        VueChiPhi.InvoiceChosing.IDRandomHD = self.HoaDons().IDRandom();
        VueChiPhi.ShowModal(0);
    }

    function UpdateChiPhiDichVu_forHoaDon(idRandomHD) {
        let hd = localStorage.getItem(lcListHD);
        if (hd !== null) {
            hd = JSON.parse(hd);

            let sum = 0;
            let cacheCP = localStorage.getItem('lcChiPhi');
            if (cacheCP !== null) {
                cacheCP = JSON.parse(cacheCP);

                for (let i = 0; i < cacheCP.length; i++) {
                    let forOut = cacheCP[i];
                    if (forOut.IDRandomHD === idRandomHD) {
                        for (let j = 0; j < forOut.ChiTiets.length; j++) {
                            let forIn = forOut.ChiTiets[j];
                            sum += formatNumberToFloat(forIn.ThanhTien);
                        }
                    }
                }
            }
            for (let i = 0; i < hd.length; i++) {
                if (hd[i].IDRandom === idRandomHD) {
                    hd[i].TongChiPhi = sum;
                    self.HoaDons().TongChiPhi(sum);
                    break;
                }
            }
            localStorage.setItem(lcListHD, JSON.stringify(hd));
        }
    }

    $('#vmChiPhiHoaDon').on('hidden.bs.modal', function () {
        if (VueChiPhi.saveOK) {
            UpdateChiPhiDichVu_forHoaDon(VueChiPhi.InvoiceChosing.IDRandomHD);
        }
    })

    // type: 0.edit, 1.delete
    function TangGiamSoLuong_updatePhiDichVu(itemCT, slNew = 0, isDoiTra = false, type = 0) {
        let idRandomHD = self.HoaDons().IDRandom();
        let idRandom = itemCT.IDRandom;
        let idChiTiet = itemCT.ID;

        let cacheCP = localStorage.getItem('lcChiPhi');
        if (cacheCP !== null) {
            cacheCP = JSON.parse(cacheCP);

            for (let i = 0; i < cacheCP.length; i++) {
                let forOut = cacheCP[i];
                if (forOut.IDRandomHD == idRandomHD) {
                    for (let j = 0; j < forOut.ChiTiets.length; j++) {
                        let forIn = forOut.ChiTiets[j];
                        if (forIn.ID_HoaDon_ChiTiet === idRandom
                            || forIn.ID_HoaDon_ChiTiet === idChiTiet) {
                            if (type === 0) {
                                forOut.ChiTiets[j].SoLuongHoaDon = slNew;
                                forOut.ChiTiets[j].SoLuong = slNew;
                                forOut.ChiTiets[j].ThanhTien = formatNumber3Digit(formatNumberToFloat(forIn.SoLuong)
                                    * formatNumberToFloat(forIn.DonGia));
                            }
                            else {
                                forOut.ChiTiets.splice(j, 1);
                            }

                            break;
                        }
                    }
                    break;
                }
            }

            for (let i = 0; i < cacheCP.length; i++) {
                let forOut = cacheCP[i];
                if (forOut.IDRandomHD == idRandomHD) {
                    if (forOut.ChiTiets.length === 0) {
                        cacheCP.splice(i, 1);
                    }
                    break;
                }
            }
            localStorage.setItem('lcChiPhi', JSON.stringify(cacheCP));

            UpdateChiPhiDichVu_forHoaDon(idRandomHD);
        }
    }

    function PostChiPhi(cthdDB, hdDB, isInsert = false) {
        var idHoaDon = hdDB.ID;
        var mahoadon = hdDB.MaHoaDon;
        var idRandomHD = hdDB.IDRandom;

        // uu tien sap xep theo ID_ParentCombo DESC
        cthdDB = cthdDB.sort(function (a, b) {
            var x = a.ID_ParentCombo == null ? '00000000-0000-0000-0000-000000000000' : a.ID_ParentCombo,
                y = b.ID_ParentCombo == null ? '00000000-0000-0000-0000-000000000000' : b.ID_ParentCombo;
            return x < y ? 1 : x > y ? -1 : 0;
        });

        let cacheCP = localStorage.getItem('lcChiPhi');
        if (cacheCP !== null) {
            cacheCP = JSON.parse(cacheCP);

            if (cacheCP.length > 0) {
                let arr = [], details = '';
                for (let i = 0; i < cacheCP.length; i++) {
                    let forOut = cacheCP[i];
                    if (forOut.IDRandomHD === idRandomHD) {
                        for (let k = 0; k < forOut.ChiTiets.length; k++) {
                            let ct = forOut.ChiTiets[k];
                            if (!commonStatisJs.CheckNull(ct.ID_NhaCungCap)) {
                                let itemDB = $.grep(cthdDB, function (x) {
                                    return x.ID_DonViQuiDoi === ct.ID_DonViQuiDoi;// todo (same dichvu - khong biet lay cai nao)
                                })

                                if (itemDB.length > 0) {
                                    ct.ID_HoaDon_ChiTiet = itemDB[0].ID;
                                    ct.ID_HoaDon = idHoaDon;

                                    details += " - ".concat(ct.TenHangHoaThayThe, ': Số lượng ', ct.SoLuong,
                                        ' Chi phí ', ct.DonGia, ' Thành tiền ', ct.ThanhTien, ' <br />')
                                    arr.push(ct);
                                }
                            }
                        }
                        break;
                    }
                }
                let myData = {
                    lstChiPhi: arr,
                    arrIDHoaDon: [],
                }
                if (!isInsert) {
                    myData.arrIDHoaDon = [idHoaDon];
                }

                if (myData.lstChiPhi.length > 0 || myData.arrIDHoaDon.length > 0) {

                    ajaxHelper(BHHoaDonUri + 'CTHD_PostPutChiPhi', 'POST', myData).done(function (x) {
                        console.log('CTHD_PostPutChiPhi ', myData, x)
                        if (x.res) {

                            let diary = {
                                ID_DonVi: id_DonVi,
                                ID_NhanVien: _idNhanVien,
                                LoaiNhatKy: 1,
                                ChucNang: 'Hóa đơn - Chi phí hóa đơn',
                                NoiDung: ''.concat(isInsert ? 'Thêm mới' : 'Cập nhật', ' chi phí cho hóa đơn <b>', mahoadon, ' </b> . Người tạo: ', userLogin),
                                NoiDungChiTiet: '',
                            }
                            if (arr.length === 0) {
                                if (myData.arrIDHoaDon.length > 0) {
                                    diary.NoiDungChiTiet = 'Xóa chi phí của hóa đơn '.concat(mahoadon);
                                    Insert_NhatKyThaoTac_1Param(diary);
                                }
                            }
                            else {
                                diary.NoiDungChiTiet = ''.concat(isInsert ? 'Thêm mới' : 'Cập nhật', ' chi phí cho hóa đơn <b>', mahoadon, ' </b> gồm: <br />', details)
                                Insert_NhatKyThaoTac_1Param(diary);
                            }


                            // remove cache CP
                            cacheCP = $.grep(cacheCP, function (x) {
                                return x.IDRandomHD !== idRandomHD;
                            });
                            localStorage.setItem('lcChiPhi', JSON.stringify(cacheCP));
                        }
                    })
                }
            }
        }
    }

    window.addEventListener("storage", function () {
        if (localStorage.getItem('IdDonVi') === null) {
            localStorage.setItem('IdDonVi', id_DonVi);
        }
        else {
            if (localStorage.getItem('IdDonVi') !== id_DonVi) {
                window.location.reload(true);
            }
        }
    }, false);
}

// use upload file
var FileModel = function (filef, srcf) {
    this.file = filef;
    this.URLAnh = srcf;
};

var newModelBanLe = new NewModel_BanHangLe();
ko.applyBindings(newModelBanLe, document.getElementById('Gara'));
var partialProduct = new PartialAddProduct();
ko.applyBindings(partialProduct, document.getElementById('partial_product_group'));
var partialCalendar = new PartialCalendar();
ko.applyBindings(partialCalendar, document.getElementById('partialCalendar'));

ko.observableArray.fn.refresh = function () {
    var data = this().slice(0);
    this([]);
    this(data);
};

var _maHoaDon = '';
function SetCheckAll(obj) {
    var isChecked = $(obj).is(":checked");
    $('input[type=checkbox]').each(function () {
        $(this).prop('checked', isChecked);
    })
    $('#ckAllNhom').removeClass('squarevt');
}
function RemoveCheck() {
    $('input[type=checkbox]').each(function () {
        $(this).prop('checked', false);
    })
}
$('input[type=text]').click(function () {
    $(this).select();
});

function CheckAll_inPackage(obj) {
    var isCheck = $(obj).is(":checked");
    var table = $(obj).closest('.table-dich-vu');
    $(table).find('input').prop('checked', isCheck);
}
function Change_ChoseService(obj) {
    var thisTable = $(obj).closest('tbody')
    var inputAll = thisTable.prev().find('input[type="checkbox"]');
    // count checked input
    var countChecked = 0;
    thisTable.find('tr input').each(function () {
        if ($(this).is(':checked')) {
            countChecked += 1;
        }
    })
    // count row in table
    var countRow = thisTable.find('tr').length;
    if (countRow === countChecked) {
        inputAll.prop('checked', true);
    }
    else {
        inputAll.prop('checked', false);
    }
}

